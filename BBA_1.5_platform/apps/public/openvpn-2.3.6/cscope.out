cscope 15 $HOME/Documents/iplatform/platform/iplatform/develop/opensource/openvpn/src -q 0000008311 0001656787
	@config-msvc.h

1 
	~<c⁄fig-msvc-vîsi⁄.h
>

3 
	#CONFIGURE_DEFINES
 "N/A"

	)

5 
	#ENABLE_DEF_AUTH
 1

	)

6 
	#ENABLE_PF
 1

	)

7 
	#ENABLE_CLIENT_SERVER
 1

	)

8 
	#ENABLE_CRYPTO
 1

	)

9 
	#ENABLE_CRYPTO_OPENSSL
 1

	)

10 
	#ENABLE_DEBUG
 1

	)

11 
	#ENABLE_EUREPHIA
 1

	)

12 
	#ENABLE_FRAGMENT
 1

	)

13 
	#ENABLE_HTTP_PROXY
 1

	)

14 
	#ENABLE_LZO
 1

	)

15 
	#ENABLE_MANAGEMENT
 1

	)

16 
	#ENABLE_MULTIHOME
 1

	)

17 
	#ENABLE_PKCS11
 1

	)

18 
	#ENABLE_PLUGIN
 1

	)

19 
	#ENABLE_PORT_SHARE
 1

	)

20 
	#ENABLE_SOCKS
 1

	)

21 
	#ENABLE_SSL
 1

	)

23 
	#HAVE_ERRNO_H
 1

	)

24 
	#HAVE_FCNTL_H
 1

	)

25 
	#HAVE_CTYPE_H
 1

	)

26 
	#HAVE_STDARG_H
 1

	)

27 
	#HAVE_STDIO_H
 1

	)

28 
	#HAVE_STDLIB_H
 1

	)

29 
	#HAVE_STRDUP
 1

	)

30 
	#HAVE_STRERROR
 1

	)

31 
	#HAVE_STRINGS_H
 1

	)

32 
	#HAVE_STRING_H
 1

	)

33 
	#HAVE_LIMITS_H
 1

	)

34 
	#HAVE_SYSTEM
 1

	)

35 
	#HAVE_TIME
 1

	)

36 
	#HAVE_TIME_H
 1

	)

37 
	#HAVE_UNLINK
 1

	)

38 
	#HAVE_VSNPRINTF
 1

	)

39 
	#HAVE_WINDOWS_H
 1

	)

40 
	#HAVE_WINSOCK2_H
 1

	)

41 
	#HAVE_WS2TCPIP_H
 1

	)

42 
	#HAVE_IO_H
 1

	)

43 
	#HAVE_DIRECT_H
 1

	)

44 
	#HAVE_SYS_TYPES_H
 1

	)

45 
	#HAVE_SYS_STAT_H
 1

	)

46 
	#HAVE_LZO_LZO1X_H
 1

	)

47 
	#HAVE_LZO_LZOUTIL_H
 1

	)

49 
	#HAVE_ACCESS
 1

	)

50 
	#HAVE_CHDIR
 1

	)

51 
	#HAVE_CHSIZE
 1

	)

52 
	#HAVE_CPP_VARARG_MACRO_ISO
 1

	)

53 
	#HAVE_CTIME
 1

	)

54 
	#HAVE_EVP_CIPHER_CTX_SET_KEY_LENGTH
 1

	)

55 
	#HAVE_IN_PKTINFO
 1

	)

56 
	#HAVE_MEMSET
 1

	)

57 
	#HAVE_PUTENV
 1

	)

58 
	#HAVE_STAT
 1

	)

60 
	#HAVE_SOCKET
 1

	)

61 
	#HAVE_RECV
 1

	)

62 
	#HAVE_RECVFROM
 1

	)

63 
	#HAVE_SEND
 1

	)

64 
	#HAVE_SENDTO
 1

	)

65 
	#HAVE_LISTEN
 1

	)

66 
	#HAVE_ACCEPT
 1

	)

67 
	#HAVE_CONNECT
 1

	)

68 
	#HAVE_BIND
 1

	)

69 
	#HAVE_SELECT
 1

	)

70 
	#HAVE_GETHOSTBYNAME
 1

	)

71 
	#HAVE_INET_NTOA
 1

	)

72 
	#HAVE_SETSOCKOPT
 1

	)

73 
	#HAVE_GETSOCKOPT
 1

	)

74 
	#HAVE_GETSOCKNAME
 1

	)

75 
	#HAVE_POLL
 1

	)

77 
	#HAVE_OPENSSL_ENGINE
 1

	)

79 
	#PATH_SEPARATOR
 '\\'

	)

80 
	#PATH_SEPARATOR_STR
 "\\"

	)

82 #i‚de‡
__˝lu•lus


83 
	#ölöe
 
__ölöe


	)

86 
	#EMPTY_ARRAY_SIZE
 0

	)

87 
	#TARGET_WIN32
 1

	)

88 
	#TARGET_ALIAS
 "Wödows-MSVC"

	)

90 
	#HAVE_DECL_SO_MARK
 0

	)

92 
	#°∫ˇ£cmp
 
°∫icmp


	)

93 
	#°rˇ£cmp
 
_°ricmp


	)

94 
	#¢¥ötf
 
_¢¥ötf


	)

96 #i‡
_MSC_VER
 < 1800

97 
	#°πouŒ
 
°πoul


	)

100 
	#ö_addr_t
 
uöt32_t


	)

101 
	#ssize_t
 
SSIZE_T


	)

103 
	#S_IRUSR
 0

	)

104 
	#S_IWUSR
 0

	)

105 
	#R_OK
 4

	)

106 
	#W_OK
 2

	)

107 
	#X_OK
 1

	)

108 
	#F_OK
 0

	)

110 
	#SIGHUP
 1

	)

111 
	#SIGINT
 2

	)

112 
	#SIGUSR1
 10

	)

113 
	#SIGUSR2
 12

	)

114 
	#SIGTERM
 15

	)

116 
	t__öt64
 
	tuöt64_t
;

117 
	t__öt32
 
	tuöt32_t
;

118 
	t__öt16
 
	tuöt16_t
;

119 
	t__öt8
 
	tuöt8_t
;

120 
__öt64
 
	töt64_t
;

121 
__öt32
 
	töt32_t
;

122 
__öt16
 
	töt16_t
;

123 
__öt8
 
	töt8_t
;

125 #ifde‡
HAVE_CONFIG_MSVC_LOCAL_H


126 
	~<c⁄fig-msvc-loˇl.h
>

	@include/openvpn-plugin.h

25 #i‚de‡
OPENVPN_PLUGIN_H_


26 
	#OPENVPN_PLUGIN_H_


	)

28 
	#OPENVPN_PLUGIN_VERSION
 3

	)

30 #ifde‡
ENABLE_SSL


31 #ifde‡
ENABLE_CRYPTO_POLARSSL


32 
	~<pﬁ¨s¶/x509.h
>

33 #i‚de‡
__OPENVPN_X509_CERT_T_DECLARED


34 
	#__OPENVPN_X509_CERT_T_DECLARED


	)

35 
x509_˚π
 
	t›ív≤_x509_˚π_t
;

38 
	~<›ís¶/x509.h
>

39 #i‚de‡
__OPENVPN_X509_CERT_T_DECLARED


40 
	#__OPENVPN_X509_CERT_T_DECLARED


	)

41 
X509
 
	t›ív≤_x509_˚π_t
;

46 
	~<°d¨g.h
>

48 #ifde‡
__˝lu•lus


114 
	#OPENVPN_PLUGIN_UP
 0

	)

115 
	#OPENVPN_PLUGIN_DOWN
 1

	)

116 
	#OPENVPN_PLUGIN_ROUTE_UP
 2

	)

117 
	#OPENVPN_PLUGIN_IPCHANGE
 3

	)

118 
	#OPENVPN_PLUGIN_TLS_VERIFY
 4

	)

119 
	#OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
 5

	)

120 
	#OPENVPN_PLUGIN_CLIENT_CONNECT
 6

	)

121 
	#OPENVPN_PLUGIN_CLIENT_DISCONNECT
 7

	)

122 
	#OPENVPN_PLUGIN_LEARN_ADDRESS
 8

	)

123 
	#OPENVPN_PLUGIN_CLIENT_CONNECT_V2
 9

	)

124 
	#OPENVPN_PLUGIN_TLS_FINAL
 10

	)

125 
	#OPENVPN_PLUGIN_ENABLE_PF
 11

	)

126 
	#OPENVPN_PLUGIN_ROUTE_PREDOWN
 12

	)

127 
	#OPENVPN_PLUGIN_N
 13

	)

132 
	#OPENVPN_PLUGIN_MASK
(
x
Ë(1<<(x))

	)

138 *
	t›ív≤_∂ugö_h™dÀ_t
;

143 
	#OPENVPN_PLUGIN_FUNC_SUCCESS
 0

	)

144 
	#OPENVPN_PLUGIN_FUNC_ERROR
 1

	)

145 
	#OPENVPN_PLUGIN_FUNC_DEFERRED
 2

	)

150 #i‡
deföed
(
WIN32
Ë&& !deföed(
OPENVPN_PLUGIN_H
)

151 
	#OPENVPN_EXPORT
 
	`__de˛•ec
(
dŒexp‹t
)

	)

153 
	#OPENVPN_EXPORT


	)

160 #ifde‡
OPENVPN_PLUGIN_H


165 
	#OPENVPN_PLUGIN_DEF
 

	)

166 
	#OPENVPN_PLUGIN_FUNC
(
	t«me
Ë(*«me)

	)

173 
	tOPENVPN_PLUGIN_DEF
 
	tOPENVPN_EXPORT


	)

174 
	tOPENVPN_PLUGIN_FUNC
(
	t«me
Ë
	)
name

185 
	s›ív≤_∂ugö_°rög_li°


187 
›ív≤_∂ugö_°rög_li°
 *
√xt
;

188 *
«me
;

189 *
vÆue
;

212 
	#OPENVPN_PLUGINv3_STRUCTVER
 2

	)

219 
PLOG_ERR
 = (1 << 0),

220 
PLOG_WARN
 = (1 << 1),

221 
PLOG_NOTE
 = (1 << 2),

222 
PLOG_DEBUG
 = (1 << 3),

224 
PLOG_ERRNO
 = (1 << 8),

225 
PLOG_NOMUTE
 = (1 << 9),

227 } 
	t›ív≤_∂ugö_log_Êags_t
;

230 #ifde‡
__GNUC__


231 #i‡
__USE_MINGW_ANSI_STDIO


232 
	#_ov≤_chk_fmt
(
a
, 
b
Ë
	`__©åibuã__
 ((
	`f‹m©
(
gnu_¥ötf
, (a), (b))))

	)

234 
	#_ov≤_chk_fmt
(
a
, 
b
Ë
	`__©åibuã__
 ((
	`f‹m©
(
__¥ötf__
, (a), (b))))

	)

237 
	#_ov≤_chk_fmt
(
a
, 
b
)

	)

240 (*
∂ugö_log_t
Ë(
	t›ív≤_∂ugö_log_Êags_t
 
	tÊags
,

241 c⁄° *
	t∂ugö_«me
,

242 c⁄° *
	tf‹m©
, ...Ë
	t_ov≤_chk_fmt
(3, 4);

244 (*
∂ugö_vlog_t
Ë(
	t›ív≤_∂ugö_log_Êags_t
 
	tÊags
,

245 c⁄° *
	t∂ugö_«me
,

246 c⁄° *
	tf‹m©
,

247 
	tva_li°
 
	t¨gli°
Ë
	t_ov≤_chk_fmt
(3, 0);

249 #unde‡
_ov≤_chk_fmt


261 
	s›ív≤_∂ugö_ˇŒbacks


263 
∂ugö_log_t
 
∂ugö_log
;

264 
∂ugö_vlog_t
 
∂ugö_vlog
;

274 
SSLAPI_NONE
,

275 
SSLAPI_OPENSSL
,

276 
SSLAPI_POLARSSL


277 } 
	tov≤SSLAPI
;

300 
	s›ív≤_∂ugö_¨gs_›í_ö


302 c⁄° 
ty≥_mask
;

303 c⁄° ** c⁄° 
¨gv
;

304 c⁄° ** c⁄° 
ívp
;

305 
›ív≤_∂ugö_ˇŒbacks
 *
ˇŒbacks
;

306 c⁄° 
ov≤SSLAPI
 
s¶_≠i
;

331 
	s›ív≤_∂ugö_¨gs_›í_ªtu∫


333 
ty≥_mask
;

334 
›ív≤_∂ugö_h™dÀ_t
 *
h™dÀ
;

335 
›ív≤_∂ugö_°rög_li°
 **
ªtu∫_li°
;

366 
	s›ív≤_∂ugö_¨gs_func_ö


368 c⁄° 
ty≥
;

369 c⁄° ** c⁄° 
¨gv
;

370 c⁄° ** c⁄° 
ívp
;

371 
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
;

372 *
≥r_˛õ¡_c⁄ãxt
;

373 #ifde‡
ENABLE_SSL


374 
cuºít_˚π_dïth
;

375 
›ív≤_x509_˚π_t
 *
cuºít_˚π
;

377 
__cuºít_˚π_dïth_dißbÀd
;

378 *
__cuºít_˚π_dißbÀd
;

394 
	s›ív≤_∂ugö_¨gs_func_ªtu∫


396 
›ív≤_∂ugö_°rög_li°
 **
ªtu∫_li°
;

461 
OPENVPN_PLUGIN_DEF
 
›ív≤_∂ugö_h™dÀ_t
 
OPENVPN_PLUGIN_FUNC
(
›ív≤_∂ugö_›í_v2
)

462 (*
ty≥_mask
,

463 c⁄° *
¨gv
[],

464 c⁄° *
ívp
[],

465 
›ív≤_∂ugö_°rög_li°
 **
ªtu∫_li°
);

557 
OPENVPN_PLUGIN_DEF
 
OPENVPN_PLUGIN_FUNC
(
›ív≤_∂ugö_func_v2
)

558 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
,

559 c⁄° 
ty≥
,

560 c⁄° *
¨gv
[],

561 c⁄° *
ívp
[],

562 *
≥r_˛õ¡_c⁄ãxt
,

563 
›ív≤_∂ugö_°rög_li°
 **
ªtu∫_li°
);

589 
OPENVPN_PLUGIN_DEF
 
OPENVPN_PLUGIN_FUNC
(
›ív≤_∂ugö_›í_v3
)

590 (c⁄° 
vîsi⁄
,

591 
›ív≤_∂ugö_¨gs_›í_ö
 c⁄° *
¨gumíts
,

592 
›ív≤_∂ugö_¨gs_›í_ªtu∫
 *
ªçå
);

673 
OPENVPN_PLUGIN_DEF
 
OPENVPN_PLUGIN_FUNC
(
›ív≤_∂ugö_func_v3
)

674 (c⁄° 
vîsi⁄
,

675 
›ív≤_∂ugö_¨gs_func_ö
 c⁄° *
¨gumíts
,

676 
›ív≤_∂ugö_¨gs_func_ªtu∫
 *
ªçå
);

690 
OPENVPN_PLUGIN_DEF
 
OPENVPN_PLUGIN_FUNC
(
›ív≤_∂ugö_˛o£_v1
)

691 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
);

707 
OPENVPN_PLUGIN_DEF
 
OPENVPN_PLUGIN_FUNC
(
›ív≤_∂ugö_ab‹t_v1
)

708 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
);

736 
OPENVPN_PLUGIN_DEF
 * 
OPENVPN_PLUGIN_FUNC
(
›ív≤_∂ugö_˛õ¡_c⁄°ru˘‹_v1
)

737 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
);

754 
OPENVPN_PLUGIN_DEF
 
OPENVPN_PLUGIN_FUNC
(
›ív≤_∂ugö_˛õ¡_de°ru˘‹_v1
)

755 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
, *
≥r_˛õ¡_c⁄ãxt
);

773 
	#OPENVPN_PLUGIN_INIT_PRE_CONFIG_PARSE
 1

	)

774 
	#OPENVPN_PLUGIN_INIT_PRE_DAEMON
 2

	)

775 
	#OPENVPN_PLUGIN_INIT_POST_DAEMON
 3

	)

776 
	#OPENVPN_PLUGIN_INIT_POST_UID_CHANGE
 4

	)

778 
OPENVPN_PLUGIN_DEF
 
OPENVPN_PLUGIN_FUNC
(
›ív≤_∂ugö_£À˘_öôüliz©i⁄_poöt_v1
)

794 
OPENVPN_PLUGIN_DEF
 
OPENVPN_PLUGIN_FUNC
(
›ív≤_∂ugö_mö_vîsi⁄_ªquúed_v1
)

801 
OPENVPN_PLUGIN_DEF
 
›ív≤_∂ugö_h™dÀ_t
 
OPENVPN_PLUGIN_FUNC
(
›ív≤_∂ugö_›í_v1
)

802 (*
ty≥_mask
,

803 c⁄° *
¨gv
[],

804 c⁄° *
ívp
[]);

806 
OPENVPN_PLUGIN_DEF
 
OPENVPN_PLUGIN_FUNC
(
›ív≤_∂ugö_func_v1
)

807 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
, c⁄° 
ty≥
, c⁄° *
¨gv
[], c⁄° *
ívp
[]);

809 #ifde‡
__˝lu•lus


	@sample/sample-plugins/defer/simple.c

55 
	~<°dio.h
>

56 
	~<°rög.h
>

57 
	~<°dlib.h
>

59 
	~"›ív≤-∂ugö.h
"

62 
	#boﬁ
 

	)

63 
	#åue
 1

	)

64 
	#Ál£
 0

	)

70 
	s∂ugö_c⁄ãxt
 {

71 
	mã°_de„ºed_auth
;

72 
	mã°_∑ckë_fûãr
;

75 
	s∂ugö_≥r_˛õ¡_c⁄ãxt
 {

76 
	mn_ˇŒs
;

77 
boﬁ
 
	mgíî©ed_pf_fûe
;

86 
	$gë_ív
 (c⁄° *
«me
, c⁄° *
ívp
[])

88 i‡(
ívp
)

90 
i
;

91 c⁄° 
«mñí
 = 
	`°æí
 (
«me
);

92 
i
 = 0; 
ívp
[i]; ++i)

94 i‡(!
	`°∫cmp
 (
ívp
[
i
], 
«me
, 
«mñí
))

96 c⁄° *
˝
 = 
ívp
[
i
] + 
«mñí
;

97 i‡(*
˝
 == '=')

98  
˝
 + 1;

102  
NULL
;

103 
	}
}

107 
	$≈
 (c⁄° *
°r
)

109 i‡(
°r
)

110  
°r
;

113 
	}
}

116 
	$©oi_nuŒ0
 (c⁄° *
°r
)

118 i‡(
°r
)

119  
	`©oi
 (
°r
);

122 
	}
}

124 
OPENVPN_EXPORT
 
›ív≤_∂ugö_h™dÀ_t


125 
	$›ív≤_∂ugö_›í_v1
 (*
ty≥_mask
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

127 
∂ugö_c⁄ãxt
 *
c⁄ãxt
;

129 
	`¥ötf
 ("FUNC: openvpn_plugin_open_v1\n");

134 
c⁄ãxt
 = (
∂ugö_c⁄ãxt
 *Ë
	`ˇŒoc
 (1,  (plugin_context));

136 
c⁄ãxt
->
ã°_de„ºed_auth
 = 
	`©oi_nuŒ0
 (
	`gë_ív
 ("ã°_de„ºed_auth", 
ívp
));

137 
	`¥ötf
 ("TEST_DEFERRED_AUTH %d\n", 
c⁄ãxt
->
ã°_de„ºed_auth
);

139 
c⁄ãxt
->
ã°_∑ckë_fûãr
 = 
	`©oi_nuŒ0
 (
	`gë_ív
 ("ã°_∑ckë_fûãr", 
ívp
));

140 
	`¥ötf
 ("TEST_PACKET_FILTER %d\n", 
c⁄ãxt
->
ã°_∑ckë_fûãr
);

145 *
ty≥_mask
 =

146 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_UP
) |

147 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_DOWN
) |

148 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_ROUTE_UP
) |

149 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_IPCHANGE
) |

150 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_TLS_VERIFY
) |

151 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
) |

152 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_CLIENT_CONNECT_V2
) |

153 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_CLIENT_DISCONNECT
) |

154 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_LEARN_ADDRESS
) |

155 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_TLS_FINAL
) |

156 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_ENABLE_PF
);

158  (
›ív≤_∂ugö_h™dÀ_t
Ë
c⁄ãxt
;

159 
	}
}

162 
	$auth_u£r_∑ss_vîify
 (
∂ugö_c⁄ãxt
 *
c⁄ãxt
, 
∂ugö_≥r_˛õ¡_c⁄ãxt
 *
pcc
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

164 i‡(
c⁄ãxt
->
ã°_de„ºed_auth
)

167 c⁄° *
u£∫ame
 = 
	`gë_ív
 ("u£∫ame", 
ívp
);

168 c⁄° *
∑ssw‹d
 = 
	`gë_ív
 ("∑ssw‹d", 
ívp
);

171 c⁄° *
auth_c⁄åﬁ_fûe
 = 
	`gë_ív
 ("auth_c⁄åﬁ_fûe", 
ívp
);

173 
	`¥ötf
 ("DEFER u='%s'Ö='%s'ácf='%s'\n",

174 
	`≈
(
u£∫ame
),

175 
	`≈
(
∑ssw‹d
),

176 
	`≈
(
auth_c⁄åﬁ_fûe
));

179 i‡(
auth_c⁄åﬁ_fûe
)

181 
buf
[256];

182 
auth
 = 2;

183 
	`ssˇnf
 (
u£∫ame
, "%d", &
auth
);

184 
	`¢¥ötf
 (
buf
, (buf), "( sleep %d ;Écho AUTH %s %d ;Écho %d >%s ) &",

185 
c⁄ãxt
->
ã°_de„ºed_auth
,

186 
auth_c⁄åﬁ_fûe
,

187 
auth
,

188 
pcc
->
n_ˇŒs
 < 
auth
,

189 
auth_c⁄åﬁ_fûe
);

190 
	`¥ötf
 ("%s\n", 
buf
);

191 
	`sy°em
 (
buf
);

192 
pcc
->
n_ˇŒs
++;

193  
OPENVPN_PLUGIN_FUNC_DEFERRED
;

196  
OPENVPN_PLUGIN_FUNC_ERROR
;

199  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

200 
	}
}

203 
	$és_föÆ
 (
∂ugö_c⁄ãxt
 *
c⁄ãxt
, 
∂ugö_≥r_˛õ¡_c⁄ãxt
 *
pcc
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

205 i‡(
c⁄ãxt
->
ã°_∑ckë_fûãr
)

207 i‡(!
pcc
->
gíî©ed_pf_fûe
)

209 c⁄° *
pff
 = 
	`gë_ív
 ("pf_fûe", 
ívp
);

210 c⁄° *
˙
 = 
	`gë_ív
 ("u£∫ame", 
ívp
);

211 i‡(
pff
 && 
˙
)

213 
buf
[256];

214 
	`¢¥ötf
 (
buf
, (buf), "( sleep %d ;Écho PF %s/%s ; cp \"%s.pf\" \"%s\" ) &",

215 
c⁄ãxt
->
ã°_∑ckë_fûãr
, 
˙
, 
pff
, cn,Öff);

216 
	`¥ötf
 ("%s\n", 
buf
);

217 
	`sy°em
 (
buf
);

218 
pcc
->
gíî©ed_pf_fûe
 = 
åue
;

219  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

222  
OPENVPN_PLUGIN_FUNC_ERROR
;

225  
OPENVPN_PLUGIN_FUNC_ERROR
;

228  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

229 
	}
}

231 
OPENVPN_EXPORT
 

232 
	$›ív≤_∂ugö_func_v2
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
,

233 c⁄° 
ty≥
,

234 c⁄° *
¨gv
[],

235 c⁄° *
ívp
[],

236 *
≥r_˛õ¡_c⁄ãxt
,

237 
›ív≤_∂ugö_°rög_li°
 **
ªtu∫_li°
)

239 
∂ugö_c⁄ãxt
 *
c⁄ãxt
 = (∂ugö_c⁄ãxà*Ë
h™dÀ
;

240 
∂ugö_≥r_˛õ¡_c⁄ãxt
 *
pcc
 = (∂ugö_≥r_˛õ¡_c⁄ãxà*Ë
≥r_˛õ¡_c⁄ãxt
;

241 
ty≥
)

243 
OPENVPN_PLUGIN_UP
:

244 
	`¥ötf
 ("OPENVPN_PLUGIN_UP\n");

245  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

246 
OPENVPN_PLUGIN_DOWN
:

247 
	`¥ötf
 ("OPENVPN_PLUGIN_DOWN\n");

248  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

249 
OPENVPN_PLUGIN_ROUTE_UP
:

250 
	`¥ötf
 ("OPENVPN_PLUGIN_ROUTE_UP\n");

251  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

252 
OPENVPN_PLUGIN_IPCHANGE
:

253 
	`¥ötf
 ("OPENVPN_PLUGIN_IPCHANGE\n");

254  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

255 
OPENVPN_PLUGIN_TLS_VERIFY
:

256 
	`¥ötf
 ("OPENVPN_PLUGIN_TLS_VERIFY\n");

257  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

258 
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
:

259 
	`¥ötf
 ("OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY\n");

260  
	`auth_u£r_∑ss_vîify
 (
c⁄ãxt
, 
pcc
, 
¨gv
, 
ívp
);

261 
OPENVPN_PLUGIN_CLIENT_CONNECT_V2
:

262 
	`¥ötf
 ("OPENVPN_PLUGIN_CLIENT_CONNECT_V2\n");

263  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

264 
OPENVPN_PLUGIN_CLIENT_DISCONNECT
:

265 
	`¥ötf
 ("OPENVPN_PLUGIN_CLIENT_DISCONNECT\n");

266  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

267 
OPENVPN_PLUGIN_LEARN_ADDRESS
:

268 
	`¥ötf
 ("OPENVPN_PLUGIN_LEARN_ADDRESS\n");

269  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

270 
OPENVPN_PLUGIN_TLS_FINAL
:

271 
	`¥ötf
 ("OPENVPN_PLUGIN_TLS_FINAL\n");

272  
	`és_föÆ
 (
c⁄ãxt
, 
pcc
, 
¨gv
, 
ívp
);

273 
OPENVPN_PLUGIN_ENABLE_PF
:

274 
	`¥ötf
 ("OPENVPN_PLUGIN_ENABLE_PF\n");

275 i‡(
c⁄ãxt
->
ã°_∑ckë_fûãr
)

276  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

278  
OPENVPN_PLUGIN_FUNC_ERROR
;

280 
	`¥ötf
 ("OPENVPN_PLUGIN_?\n");

281  
OPENVPN_PLUGIN_FUNC_ERROR
;

283 
	}
}

285 
OPENVPN_EXPORT
 *

286 
	$›ív≤_∂ugö_˛õ¡_c⁄°ru˘‹_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
)

288 
	`¥ötf
 ("FUNC: openvpn_plugin_client_constructor_v1\n");

289  
	`ˇŒoc
 (1,  (
∂ugö_≥r_˛õ¡_c⁄ãxt
));

290 
	}
}

292 
OPENVPN_EXPORT
 

293 
	$›ív≤_∂ugö_˛õ¡_de°ru˘‹_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
, *
≥r_˛õ¡_c⁄ãxt
)

295 
	`¥ötf
 ("FUNC: openvpn_plugin_client_destructor_v1\n");

296 
	`‰ì
 (
≥r_˛õ¡_c⁄ãxt
);

297 
	}
}

299 
OPENVPN_EXPORT
 

300 
	$›ív≤_∂ugö_˛o£_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
)

302 
∂ugö_c⁄ãxt
 *
c⁄ãxt
 = (∂ugö_c⁄ãxà*Ë
h™dÀ
;

303 
	`¥ötf
 ("FUNC: openvpn_plugin_close_v1\n");

304 
	`‰ì
 (
c⁄ãxt
);

305 
	}
}

	@sample/sample-plugins/log/log.c

32 
	~<°dio.h
>

33 
	~<°rög.h
>

34 
	~<°dlib.h
>

36 
	~"›ív≤-∂ugö.h
"

41 
	s∂ugö_c⁄ãxt
 {

42 c⁄° *
	mu£∫ame
;

43 c⁄° *
	m∑ssw‹d
;

52 
	$gë_ív
 (c⁄° *
«me
, c⁄° *
ívp
[])

54 i‡(
ívp
)

56 
i
;

57 c⁄° 
«mñí
 = 
	`°æí
 (
«me
);

58 
i
 = 0; 
ívp
[i]; ++i)

60 i‡(!
	`°∫cmp
 (
ívp
[
i
], 
«me
, 
«mñí
))

62 c⁄° *
˝
 = 
ívp
[
i
] + 
«mñí
;

63 i‡(*
˝
 == '=')

64  
˝
 + 1;

68  
NULL
;

69 
	}
}

71 
OPENVPN_EXPORT
 
›ív≤_∂ugö_h™dÀ_t


72 
	$›ív≤_∂ugö_›í_v1
 (*
ty≥_mask
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

74 
∂ugö_c⁄ãxt
 *
c⁄ãxt
;

79 
c⁄ãxt
 = (
∂ugö_c⁄ãxt
 *Ë
	`ˇŒoc
 (1,  (plugin_context));

84 
c⁄ãxt
->
u£∫ame
 = "foo";

85 
c⁄ãxt
->
∑ssw‹d
 = "bar";

90 *
ty≥_mask
 =

91 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_UP
) |

92 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_DOWN
) |

93 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_ROUTE_UP
) |

94 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_IPCHANGE
) |

95 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_TLS_VERIFY
) |

96 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
) |

97 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_CLIENT_CONNECT_V2
) |

98 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_CLIENT_DISCONNECT
) |

99 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_LEARN_ADDRESS
) |

100 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_TLS_FINAL
);

102  (
›ív≤_∂ugö_h™dÀ_t
Ë
c⁄ãxt
;

103 
	}
}

106 
	$show
 (c⁄° 
ty≥
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

108 
size_t
 
i
;

109 
ty≥
)

111 
OPENVPN_PLUGIN_UP
:

112 
	`¥ötf
 ("OPENVPN_PLUGIN_UP\n");

114 
OPENVPN_PLUGIN_DOWN
:

115 
	`¥ötf
 ("OPENVPN_PLUGIN_DOWN\n");

117 
OPENVPN_PLUGIN_ROUTE_UP
:

118 
	`¥ötf
 ("OPENVPN_PLUGIN_ROUTE_UP\n");

120 
OPENVPN_PLUGIN_IPCHANGE
:

121 
	`¥ötf
 ("OPENVPN_PLUGIN_IPCHANGE\n");

123 
OPENVPN_PLUGIN_TLS_VERIFY
:

124 
	`¥ötf
 ("OPENVPN_PLUGIN_TLS_VERIFY\n");

126 
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
:

127 
	`¥ötf
 ("OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY\n");

129 
OPENVPN_PLUGIN_CLIENT_CONNECT_V2
:

130 
	`¥ötf
 ("OPENVPN_PLUGIN_CLIENT_CONNECT_V2\n");

132 
OPENVPN_PLUGIN_CLIENT_DISCONNECT
:

133 
	`¥ötf
 ("OPENVPN_PLUGIN_CLIENT_DISCONNECT\n");

135 
OPENVPN_PLUGIN_LEARN_ADDRESS
:

136 
	`¥ötf
 ("OPENVPN_PLUGIN_LEARN_ADDRESS\n");

138 
OPENVPN_PLUGIN_TLS_FINAL
:

139 
	`¥ötf
 ("OPENVPN_PLUGIN_TLS_FINAL\n");

142 
	`¥ötf
 ("OPENVPN_PLUGIN_?\n");

146 
	`¥ötf
 ("ARGV\n");

147 
i
 = 0; 
¨gv
[i] !
NULL
; ++i)

148 
	`¥ötf
 ("%d '%s'\n", ()
i
, 
¨gv
[i]);

150 
	`¥ötf
 ("ENVP\n");

151 
i
 = 0; 
ívp
[i] !
NULL
; ++i)

152 
	`¥ötf
 ("%d '%s'\n", ()
i
, 
ívp
[i]);

153 
	}
}

155 
OPENVPN_EXPORT
 

156 
	$›ív≤_∂ugö_func_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
, c⁄° 
ty≥
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

158 
∂ugö_c⁄ãxt
 *
c⁄ãxt
 = (∂ugö_c⁄ãxà*Ë
h™dÀ
;

160 
	`show
 (
ty≥
, 
¨gv
, 
ívp
);

163 i‡(
ty≥
 =
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
)

166 c⁄° *
u£∫ame
 = 
	`gë_ív
 ("u£∫ame", 
ívp
);

167 c⁄° *
∑ssw‹d
 = 
	`gë_ív
 ("∑ssw‹d", 
ívp
);

169 i‡(
u£∫ame
 && !
	`°rcmp
 (u£∫ame, 
c⁄ãxt
->username)

170 && 
∑ssw‹d
 && !
	`°rcmp
 (∑ssw‹d, 
c⁄ãxt
->password))

171  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

173  
OPENVPN_PLUGIN_FUNC_ERROR
;

176  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

177 
	}
}

179 
OPENVPN_EXPORT
 

180 
	$›ív≤_∂ugö_˛o£_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
)

182 
∂ugö_c⁄ãxt
 *
c⁄ãxt
 = (∂ugö_c⁄ãxà*Ë
h™dÀ
;

183 
	`‰ì
 (
c⁄ãxt
);

184 
	}
}

	@sample/sample-plugins/log/log_v3.c

35 
	~<°dio.h
>

36 
	~<°rög.h
>

37 
	~<°dlib.h
>

39 
	#ENABLE_SSL


	)

41 
	~"›ív≤-∂ugö.h
"

46 
	s∂ugö_c⁄ãxt
 {

47 c⁄° *
	mu£∫ame
;

48 c⁄° *
	m∑ssw‹d
;

57 
	$gë_ív
 (c⁄° *
«me
, c⁄° *
ívp
[])

59 i‡(
ívp
)

61 
i
;

62 c⁄° 
«mñí
 = 
	`°æí
 (
«me
);

63 
i
 = 0; 
ívp
[i]; ++i)

65 i‡(!
	`°∫cmp
 (
ívp
[
i
], 
«me
, 
«mñí
))

67 c⁄° *
˝
 = 
ívp
[
i
] + 
«mñí
;

68 i‡(*
˝
 == '=')

69  
˝
 + 1;

73  
NULL
;

74 
	}
}

76 
OPENVPN_EXPORT
 

77 
	$›ív≤_∂ugö_›í_v3
 (c⁄° 
v3°ru˘vî
,

78 
›ív≤_∂ugö_¨gs_›í_ö
 c⁄° *
¨gs
,

79 
›ív≤_∂ugö_¨gs_›í_ªtu∫
 *
ªt
)

81 
∂ugö_c⁄ãxt
 *
c⁄ãxt
 = 
NULL
;

84 if–
v3°ru˘vî
 !
OPENVPN_PLUGINv3_STRUCTVER
 ) {

85  
OPENVPN_PLUGIN_FUNC_ERROR
;

88 if–
¨gs
->
s¶_≠i
 !
SSLAPI_OPENSSL
 ) {

89 
	`¥ötf
("ThisÖlug-in can only be usedágainst OpenVPN with OpenSSL\n");

90  
OPENVPN_PLUGIN_FUNC_ERROR
;

94 
ªt
->
ty≥_mask
 =

95 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_UP
) |

96 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_DOWN
) |

97 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_ROUTE_UP
) |

98 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_IPCHANGE
) |

99 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_TLS_VERIFY
) |

100 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
) |

101 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_CLIENT_CONNECT_V2
) |

102 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_CLIENT_DISCONNECT
) |

103 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_LEARN_ADDRESS
) |

104 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_TLS_FINAL
);

108 
c⁄ãxt
 = (
∂ugö_c⁄ãxt
 *Ë
	`ˇŒoc
 (1,  (plugin_context));

111 
c⁄ãxt
->
u£∫ame
 = "foo";

112 
c⁄ãxt
->
∑ssw‹d
 = "bar";

115 
ªt
->
h™dÀ
 = (*Ë
c⁄ãxt
;

117  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

118 
	}
}

121 
	$show
 (c⁄° 
ty≥
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

123 
size_t
 
i
;

124 
ty≥
)

126 
OPENVPN_PLUGIN_UP
:

127 
	`¥ötf
 ("OPENVPN_PLUGIN_UP\n");

129 
OPENVPN_PLUGIN_DOWN
:

130 
	`¥ötf
 ("OPENVPN_PLUGIN_DOWN\n");

132 
OPENVPN_PLUGIN_ROUTE_UP
:

133 
	`¥ötf
 ("OPENVPN_PLUGIN_ROUTE_UP\n");

135 
OPENVPN_PLUGIN_IPCHANGE
:

136 
	`¥ötf
 ("OPENVPN_PLUGIN_IPCHANGE\n");

138 
OPENVPN_PLUGIN_TLS_VERIFY
:

139 
	`¥ötf
 ("OPENVPN_PLUGIN_TLS_VERIFY\n");

141 
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
:

142 
	`¥ötf
 ("OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY\n");

144 
OPENVPN_PLUGIN_CLIENT_CONNECT_V2
:

145 
	`¥ötf
 ("OPENVPN_PLUGIN_CLIENT_CONNECT_V2\n");

147 
OPENVPN_PLUGIN_CLIENT_DISCONNECT
:

148 
	`¥ötf
 ("OPENVPN_PLUGIN_CLIENT_DISCONNECT\n");

150 
OPENVPN_PLUGIN_LEARN_ADDRESS
:

151 
	`¥ötf
 ("OPENVPN_PLUGIN_LEARN_ADDRESS\n");

153 
OPENVPN_PLUGIN_TLS_FINAL
:

154 
	`¥ötf
 ("OPENVPN_PLUGIN_TLS_FINAL\n");

157 
	`¥ötf
 ("OPENVPN_PLUGIN_?\n");

161 
	`¥ötf
 ("ARGV\n");

162 
i
 = 0; 
¨gv
[i] !
NULL
; ++i)

163 
	`¥ötf
 ("%d '%s'\n", ()
i
, 
¨gv
[i]);

165 
	`¥ötf
 ("ENVP\n");

166 
i
 = 0; 
ívp
[i] !
NULL
; ++i)

167 
	`¥ötf
 ("%d '%s'\n", ()
i
, 
ívp
[i]);

168 
	}
}

171 
	$x509_¥öt_öfo
 (
X509
 *
x509¸t
)

173 
i
, 
n
;

174 
‚_nid
;

175 
ASN1_OBJECT
 *
‚
;

176 
ASN1_STRING
 *
vÆ
;

177 
X509_NAME
 *
x509_«me
;

178 
X509_NAME_ENTRY
 *
ít
;

179 c⁄° *
objbuf
;

180 *
buf
;

182 
x509_«me
 = 
	`X509_gë_subje˘_«me
 (
x509¸t
);

183 
n
 = 
	`X509_NAME_íåy_cou¡
 (
x509_«me
);

184 
i
 = 0; i < 
n
; ++i)

186 
ít
 = 
	`X509_NAME_gë_íåy
 (
x509_«me
, 
i
);

187 i‡(!
ít
)

189 
‚
 = 
	`X509_NAME_ENTRY_gë_obje˘
 (
ít
);

190 i‡(!
‚
)

192 
vÆ
 = 
	`X509_NAME_ENTRY_gë_d©a
 (
ít
);

193 i‡(!
vÆ
)

195 
‚_nid
 = 
	`OBJ_obj2nid
 (
‚
);

196 i‡(
‚_nid
 =
NID_undef
)

198 
objbuf
 = 
	`OBJ_nid2¢
 (
‚_nid
);

199 i‡(!
objbuf
)

201 
buf
 = (*)1;

202 i‡(
	`ASN1_STRING_to_UTF8
 (&
buf
, 
vÆ
) <= 0)

205 
	`¥ötf
("X509 %s: %s\n", 
objbuf
, (*)
buf
);

206 
	`OPENSSL_‰ì
 (
buf
);

208 
	}
}

212 
OPENVPN_EXPORT
 

213 
	$›ív≤_∂ugö_func_v3
 (c⁄° 
vîsi⁄
,

214 
›ív≤_∂ugö_¨gs_func_ö
 c⁄° *
¨gs
,

215 
›ív≤_∂ugö_¨gs_func_ªtu∫
 *
ªçå
)

217 
∂ugö_c⁄ãxt
 *
c⁄ãxt
 = (∂ugö_c⁄ãxà*Ë
¨gs
->
h™dÀ
;

219 
	`¥ötf
("\nopenvpn_plugin_func_v3() :::::>> ");

220 
	`show
 (
¨gs
->
ty≥
,árgs->
¨gv
,árgs->
ívp
);

223 i‡((
¨gs
->
ty≥
 =
OPENVPN_PLUGIN_TLS_VERIFY
Ë&&árgs->
cuºít_˚π
 ) {

224 
	`¥ötf
("---- X509 Subject information ----\n");

225 
	`¥ötf
("Cîtifiˇã dïth: %i\n", 
¨gs
->
cuºít_˚π_dïth
);

226 
	`x509_¥öt_öfo
(
¨gs
->
cuºít_˚π
);

227 
	`¥ötf
("----------------------------------\n");

231 i‡(
¨gs
->
ty≥
 =
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
)

234 c⁄° *
u£∫ame
 = 
	`gë_ív
 ("u£∫ame", 
¨gs
->
ívp
);

235 c⁄° *
∑ssw‹d
 = 
	`gë_ív
 ("∑ssw‹d", 
¨gs
->
ívp
);

237 i‡(
u£∫ame
 && !
	`°rcmp
 (u£∫ame, 
c⁄ãxt
->username)

238 && 
∑ssw‹d
 && !
	`°rcmp
 (∑ssw‹d, 
c⁄ãxt
->password))

239  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

241  
OPENVPN_PLUGIN_FUNC_ERROR
;

244  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

245 
	}
}

247 
OPENVPN_EXPORT
 

248 
	$›ív≤_∂ugö_˛o£_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
)

250 
∂ugö_c⁄ãxt
 *
c⁄ãxt
 = (∂ugö_c⁄ãxà*Ë
h™dÀ
;

251 
	`‰ì
 (
c⁄ãxt
);

252 
	}
}

	@sample/sample-plugins/simple/simple.c

34 
	~<°dio.h
>

35 
	~<°rög.h
>

36 
	~<°dlib.h
>

38 
	~"›ív≤-∂ugö.h
"

43 
	s∂ugö_c⁄ãxt
 {

44 c⁄° *
	mu£∫ame
;

45 c⁄° *
	m∑ssw‹d
;

54 
	$gë_ív
 (c⁄° *
«me
, c⁄° *
ívp
[])

56 i‡(
ívp
)

58 
i
;

59 c⁄° 
«mñí
 = 
	`°æí
 (
«me
);

60 
i
 = 0; 
ívp
[i]; ++i)

62 i‡(!
	`°∫cmp
 (
ívp
[
i
], 
«me
, 
«mñí
))

64 c⁄° *
˝
 = 
ívp
[
i
] + 
«mñí
;

65 i‡(*
˝
 == '=')

66  
˝
 + 1;

70  
NULL
;

71 
	}
}

73 
OPENVPN_EXPORT
 
›ív≤_∂ugö_h™dÀ_t


74 
	$›ív≤_∂ugö_›í_v1
 (*
ty≥_mask
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

76 
∂ugö_c⁄ãxt
 *
c⁄ãxt
;

81 
c⁄ãxt
 = (
∂ugö_c⁄ãxt
 *Ë
	`ˇŒoc
 (1,  (plugin_context));

86 
c⁄ãxt
->
u£∫ame
 = "foo";

87 
c⁄ãxt
->
∑ssw‹d
 = "bar";

93 *
ty≥_mask
 = 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
);

95  (
›ív≤_∂ugö_h™dÀ_t
Ë
c⁄ãxt
;

96 
	}
}

98 
OPENVPN_EXPORT
 

99 
	$›ív≤_∂ugö_func_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
, c⁄° 
ty≥
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

101 
∂ugö_c⁄ãxt
 *
c⁄ãxt
 = (∂ugö_c⁄ãxà*Ë
h™dÀ
;

104 c⁄° *
u£∫ame
 = 
	`gë_ív
 ("u£∫ame", 
ívp
);

105 c⁄° *
∑ssw‹d
 = 
	`gë_ív
 ("∑ssw‹d", 
ívp
);

108 i‡(
u£∫ame
 && !
	`°rcmp
 (u£∫ame, 
c⁄ãxt
->username)

109 && 
∑ssw‹d
 && !
	`°rcmp
 (∑ssw‹d, 
c⁄ãxt
->password))

110  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

112  
OPENVPN_PLUGIN_FUNC_ERROR
;

113 
	}
}

115 
OPENVPN_EXPORT
 

116 
	$›ív≤_∂ugö_˛o£_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
)

118 
∂ugö_c⁄ãxt
 *
c⁄ãxt
 = (∂ugö_c⁄ãxà*Ë
h™dÀ
;

119 
	`‰ì
 (
c⁄ãxt
);

120 
	}
}

	@src/compat/compat-basename.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 #i‚de‡
HAVE_BASENAME


33 
	~"com∑t.h
"

34 
	~<°rög.h
>

40 
	$ba£«me
 (*
fûíame
)

42 *
p
 = 
	`°ºchr
 (
fûíame
, '/');

43 i‡(!
p
) {

45 
p
 = 
	`°ºchr
 (
fûíame
, '\\');

47  
p
 ?Ö + 1 : (*Ë
fûíame
;

48 
	}
}

	@src/compat/compat-daemon.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 #i‚de‡
HAVE_DAEMON


33 #ifde‡
HAVE_UNISTD_H


34 
	~<uni°d.h
>

37 #ifde‡
HAVE_STDLIB_H


38 
	~<°dlib.h
>

41 #ifde‡
HAVE_SYS_TYPES_H


42 
	~<sys/ty≥s.h
>

45 #ifde‡
HAVE_SYS_STAT_H


46 
	~<sys/°©.h
>

49 #ifde‡
HAVE_FCNTL_H


50 
	~<f˙é.h
>

53 #ifde‡
HAVE_ERRNO_H


54 
	~<î∫o.h
>

58 
	$d´m⁄
(
nochdú
, 
no˛o£
)

60 #i‡
	`deföed
(
HAVE_FORK
Ë&& deföed(
HAVE_SETSID
)

61 
	`f‹k
()) {

67 
	`exô
(0);

70 i‡(
	`£tsid
() == -1)

73 i‡(!
nochdú
)

74 
	`chdú
("/");

76 i‡(!
no˛o£
) {

77 #i‡
	`deföed
(
HAVE_DUP
Ë&& deföed(
HAVE_DUP2
)

78 
fd
;

79 i‡((
fd
 = 
	`›í
 ("/dev/nuŒ", 
O_RDWR
, 0)) != -1) {

80 
	`dup2
 (
fd
, 0);

81 
	`dup2
 (
fd
, 1);

82 
	`dup2
 (
fd
, 2);

83 i‡(
fd
 > 2) {

84 
	`˛o£
 (
fd
);

92 ()
nochdú
;

93 ()
no˛o£
;

94 
î∫o
 = 
EFAULT
;

97 
	}
}

	@src/compat/compat-dirname.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

32 #i‚de‡
HAVE_DIRNAME


34 
	~"com∑t.h
"

35 
	~<°rög.h
>

42 
	$__memrchr
(c⁄° *
°r
, 
c
, 
size_t
 
n
)

44 c⁄° *
íd
 = 
°r
;

46 
íd
 +
n
 - 1;

47 
íd
 >
°r
) {

48 if(
c
 =*
íd
)

49  
íd
;

51 
íd
--;

53  
NULL
;

54 
	}
}

60 
	$dú«me
 (*
∑th
)

62 c⁄° 
dŸ
[] = ".";

63 *
œ°_¶ash
;

64 
£∑øt‹
 = '/';

67 
œ°_¶ash
 = 
∑th
 !
NULL
 ? 
	`°ºchr
 (path, '/') : NULL;

69 i‡(!
œ°_¶ash
) {

70 
œ°_¶ash
 = 
∑th
 !
NULL
 ? 
	`°ºchr
 (path, '\\') : NULL;

71 
£∑øt‹
 = 
œ°_¶ash
 ? '\\' : '/';

74 i‡(
œ°_¶ash
 !
NULL
 &&Üa°_¶ash !
∑th
 &&Üast_slash[1] == '\0') {

76 *
ru≈
;

78 
ru≈
 = 
œ°_¶ash
;Ñu≈ !
∑th
; --runp)

79 i‡(
ru≈
[-1] !
£∑øt‹
)

83 i‡(
ru≈
 !
∑th
)

84 
œ°_¶ash
 = (*Ë
	`__memrchr
 (
∑th
, 
£∑øt‹
, 
ru≈
 -Öath);

87 i‡(
œ°_¶ash
 !
NULL
) {

89 *
ru≈
;

91 
ru≈
 = 
œ°_¶ash
;Ñu≈ !
∑th
; --runp)

92 i‡(
ru≈
[-1] !
£∑øt‹
)

96 i‡(
ru≈
 =
∑th
) {

101 i‡(
œ°_¶ash
 =
∑th
 + 1)

102 ++
œ°_¶ash
;

104 
œ°_¶ash
 = 
∑th
 + 1;

107 
œ°_¶ash
 = 
ru≈
;

109 
œ°_¶ash
[0] = '\0';

114 
∑th
 = (*Ë
dŸ
;

116  
∑th
;

117 
	}
}

	@src/compat/compat-gettimeofday.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 #i‚de‡
HAVE_GETTIMEOFDAY


33 
	~"com∑t.h
"

35 #ifde‡
WIN32


41 
	~<wödows.h
>

42 
	~<time.h
>

44 
time_t
 
	ggtc_ba£
 = 0;

45 
DWORD
 
	ggtc_œ°
 = 0;

46 
time_t
 
	gœ°_£c
 = 0;

47 
	gœ°_m£c
 = 0;

48 
	gbt_œ°
 = 0;

51 
	$gëtimeofday_ˇlibøã
 ()

53 c⁄° 
time_t
 
t
 = 
	`time
(
NULL
);

54 c⁄° 
DWORD
 
gtc
 = 
	`GëTickCou¡
();

55 
gtc_ba£
 = 
t
 - 
gtc
/1000;

56 
gtc_œ°
 = 
gtc
;

57 
	}
}

65 
	$gëtimeofday
 (
timevÆ
 *
tv
, *
tz
)

67 c⁄° 
DWORD
 
gtc
 = 
	`GëTickCou¡
();

68 
bt
 = 0;

69 
time_t
 
£c
;

70 
m£c
;

71 c⁄° 
backåack_hﬁd_£c⁄ds
 = 10;

73 ()
tz
;

76 i‡(!
gtc_ba£
 || 
gtc
 < 
gtc_œ°
)

77 
	`gëtimeofday_ˇlibøã
 ();

78 
gtc_œ°
 = 
gtc
;

80 
£c
 = 
gtc_ba£
 + 
gtc
 / 1000;

81 
m£c
 = 
gtc
 % 1000;

83 i‡(
£c
 =
œ°_£c
)

85 i‡(
m£c
 < 
œ°_m£c
)

87 
m£c
 = 
œ°_m£c
;

88 
bt
 = 1;

91 i‡(
£c
 < 
œ°_£c
)

96 i‡(
£c
 > 
œ°_£c
 - 
backåack_hﬁd_£c⁄ds
)

98 
£c
 = 
œ°_£c
;

99 
m£c
 = 
œ°_m£c
;

101 
bt
 = 1;

104 
tv
->
tv_£c
 = ()
œ°_£c
 = ()
£c
;

105 
tv
->
tv_u£c
 = (
œ°_m£c
 = 
m£c
) * 1000;

107 i‡(
bt
 && !
bt_œ°
)

108 
	`gëtimeofday_ˇlibøã
 ();

109 
bt_œ°
 = 
bt
;

112 
	}
}

116 #ifde‡
HAVE_TIME_H


117 
	~<time.h
>

121 
	$gëtimeofday
 (
timevÆ
 *
tv
, *
tz
)

123 ()
tz
;

124 
tv
->
tv_£c
 = 
	`time
(
NULL
);

125 
tv
->
tv_u£c
 = 0;

127 
	}
}

	@src/compat/compat-inet_ntop.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 #i‚de‡
HAVE_INET_NTOP


33 
	~"com∑t.h
"

35 #ifde‡
WIN32


37 
	~<wödows.h
>

47 
	$öë_¡›
(
af
, c⁄° *
§c
, *
d°
, 
sockÀn_t
 
size
)

49 
sockaddr_°‹age
 
ss
;

50 
s
 = 
size
;

52 
	`ZîoMem‹y
(&
ss
, (ss));

53 
ss
.
ss_Ámûy
 = 
af
;

55 
af
) {

56 
AF_INET
:

57 ((
sockaddr_ö
 *)&
ss
)->
sö_addr
 = *(
ö_addr
 *)
§c
;

59 
AF_INET6
:

60 ((
sockaddr_ö6
 *)&
ss
)->
sö6_addr
 = *(
ö6_addr
 *)
§c
;

63  
NULL
;

66  (
	`WSAAddªssToSåög
((
sockaddr
 *)&
ss
, (ss), 
NULL
, 
d°
, &
s
) == 0)?

67 
d°
 : 
NULL
;

68 
	}
}

72 #îr‹ 
no
 
emuœti⁄
 
öë_¡›


	@src/compat/compat-inet_pton.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 #i‚de‡
HAVE_INET_PTON


33 
	~"com∑t.h
"

35 #ifde‡
WIN32


37 
	~<wödows.h
>

38 
	~<°rög.h
>

49 
	$öë_±⁄
(
af
, c⁄° *
§c
, *
d°
)

51 
sockaddr_°‹age
 
ss
;

52 
size
 = (
ss
);

53 
§c_c›y
[
INET6_ADDRSTRLEN
+1];

55 
	`ZîoMem‹y
(&
ss
, (ss));

57 
	`°∫˝y
 (
§c_c›y
, 
§c
, 
INET6_ADDRSTRLEN
+1);

58 
§c_c›y
[
INET6_ADDRSTRLEN
] = 0;

60 i‡(
	`WSASåögToAddªss
(
§c_c›y
, 
af
, 
NULL
, (
sockaddr
 *)&
ss
, &
size
) == 0) {

61 
af
) {

62 
AF_INET
:

63 *(
ö_addr
 *)
d°
 = ((
sockaddr_ö
 *)&
ss
)->
sö_addr
;

65 
AF_INET6
:

66 *(
ö6_addr
 *)
d°
 = ((
sockaddr_ö6
 *)&
ss
)->
sö6_addr
;

71 
	}
}

75 #îr‹ 
no
 
emuœti⁄
 
öë_¡›


	@src/compat/compat-stdbool.h

1 #i‚de‡
__COMPAT_STDBOOL_H


2 
	#__COMPAT_STDBOOL_H


	)

4 #ifde‡
HAVE_STDBOOL_H


5 
	~<°dboﬁ.h
>

7 
	tboﬁ
;

8 
	#Ál£
 0

	)

9 
	#åue
 1

	)

	@src/compat/compat.h

25 #i‚de‡
COMPAT_H


26 
	#COMPAT_H


	)

28 #ifde‡
HAVE_WINSOCK2_H


29 
	~<wösock2.h
>

32 #ifde‡
HAVE_WS2TCPIP_H


33 
	~<ws2t˝ù.h
>

36 #ifde‡
HAVE_SYS_TIME_H


37 
	~<sys/time.h
>

40 #ifde‡
HAVE_SYS_SOCKET_H


41 
	~<sys/sockë.h
>

44 #i‚de‡
HAVE_DIRNAME


45 * 
dú«me
(*
°r
);

48 #i‚de‡
HAVE_BASENAME


49 * 
ba£«me
(*
°r
);

52 #i‚de‡
HAVE_GETTIMEOFDAY


53 
gëtimeofday
 (
timevÆ
 *
tv
, *
tz
);

56 #i‚de‡
HAVE_DAEMON


57 
d´m⁄
(
nochdú
, 
no˛o£
);

60 #i‚de‡
HAVE_INET_NTOP


61 c⁄° * 
öë_¡›
(
af
, c⁄° *
§c
, *
d°
, 
sockÀn_t
 
size
);

64 #i‚de‡
HAVE_INET_PTON


65 
öë_±⁄
(
af
, c⁄° *
§c
, *
d°
);

	@src/openvpn/base64.c

34 #ifde‡
HAVE_CONFIG_H


35 
	~"c⁄fig.h
"

36 #ñi‡
deföed
(
_MSC_VER
)

37 
	~"c⁄fig-msvc.h
"

40 
	~"syshód.h
"

42 #i‡
deföed
(
ENABLE_HTTP_PROXY
Ë|| deföed(
ENABLE_PKCS11
Ë|| deföed(
ENABLE_CLIENT_CR
Ë|| deföed(
MANAGMENT_EXTERNAL_KEY
)

44 
	~"ba£64.h
"

46 
	~"memdbg.h
"

48 
	gba£64_ch¨s
[] =

56 
	$›ív≤_ba£64_ícode
(c⁄° *
d©a
, 
size
, **
°r
)

58 *
s
, *
p
;

59 
i
;

60 
c
;

61 c⁄° *
q
;

63 i‡(
size
 < 0)

65 
p
 = 
s
 = (*Ë
	`mÆloc
(
size
 * 4 / 3 + 4);

66 i‡(
p
 =
NULL
)

68 
q
 = (c⁄° *Ë
d©a
;

69 
i
 = 0;

70 
i
 = 0; i < 
size
;) {

71 
c
 = 
q
[
i
++];

72 
c
 *= 256;

73 i‡(
i
 < 
size
)

74 
c
 +
q
[
i
];

75 
i
++;

76 
c
 *= 256;

77 i‡(
i
 < 
size
)

78 
c
 +
q
[
i
];

79 
i
++;

80 
p
[0] = 
ba£64_ch¨s
[(
c
 & 0x00fc0000) >> 18];

81 
p
[1] = 
ba£64_ch¨s
[(
c
 & 0x0003f000) >> 12];

82 
p
[2] = 
ba£64_ch¨s
[(
c
 & 0x00000fc0) >> 6];

83 
p
[3] = 
ba£64_ch¨s
[(
c
 & 0x0000003f) >> 0];

84 i‡(
i
 > 
size
)

85 
p
[3] = '=';

86 i‡(
i
 > 
size
 + 1)

87 
p
[2] = '=';

88 
p
 += 4;

90 *
p
 = 0;

91 *
°r
 = 
s
;

92  
	`°æí
(
s
);

93 
	}
}

96 
	$pos
(
c
)

98 *
p
;

99 
p
 = 
ba£64_ch¨s
; *p;Ö++)

100 i‡(*
p
 =
c
)

101  
p
 - 
ba£64_ch¨s
;

103 
	}
}

105 
	#DECODE_ERROR
 0xffffffff

	)

108 
	$tokí_decode
(c⁄° *
tokí
)

110 
i
;

111 
vÆ
 = 0;

112 
m¨kî
 = 0;

113 i‡(!
tokí
[0] || !token[1] || !token[2] || !token[3])

114  
DECODE_ERROR
;

115 
i
 = 0; i < 4; i++) {

116 
vÆ
 *= 64;

117 i‡(
tokí
[
i
] == '=')

118 
m¨kî
++;

119 i‡(
m¨kî
 > 0)

120  
DECODE_ERROR
;

122 
vÆ
 +
	`pos
(
tokí
[
i
]);

124 i‡(
m¨kî
 > 2)

125  
DECODE_ERROR
;

126  (
m¨kî
 << 24Ë| 
vÆ
;

127 
	}
}

134 
	$›ív≤_ba£64_decode
(c⁄° *
°r
, *
d©a
, 
size
)

136 c⁄° *
p
;

137 *
q
;

138 *
e
 = 
NULL
;

140 
q
 = 
d©a
;

141 i‡(
size
 >= 0)

142 
e
 = 
q
 + 
size
;

143 
p
 = 
°r
; *∞&& (*∞='=' || 
	`°rchr
(
ba£64_ch¨s
, *p));Ö += 4) {

144 
vÆ
 = 
	`tokí_decode
(
p
);

145 
m¨kî
 = (
vÆ
 >> 24) & 0xff;

146 i‡(
vÆ
 =
DECODE_ERROR
)

148 i‡(
e
 && 
q
 >=É)

150 *
q
++ = (
vÆ
 >> 16) & 0xff;

151 i‡(
m¨kî
 < 2)

153 i‡(
e
 && 
q
 >=É)

155 *
q
++ = (
vÆ
 >> 8) & 0xff;

157 i‡(
m¨kî
 < 1)

159 i‡(
e
 && 
q
 >=É)

161 *
q
++ = 
vÆ
 & 0xff;

164  
q
 - (*Ë
d©a
;

165 
	}
}

168 
	$dummy
(Ë{
	}
}

	@src/openvpn/base64.h

34 #i‚de‡
_BASE64_H_


35 
	#_BASE64_H_


	)

37 #i‡
deföed
(
ENABLE_HTTP_PROXY
Ë|| deföed(
ENABLE_PKCS11
Ë|| deföed(
ENABLE_CLIENT_CR
Ë|| deföed(
MANAGMENT_EXTERNAL_KEY
)

39 
›ív≤_ba£64_ícode
(c⁄° *
d©a
, 
size
, **
°r
);

40 
›ív≤_ba£64_decode
(c⁄° *
°r
, *
d©a
, 
size
);

	@src/openvpn/basic.h

25 #i‚de‡
BASIC_H


26 
	#BASIC_H


	)

28 
	#BOOL_CAST
(
x
Ë((xË? (
åue
Ë: (
Ál£
))

	)

31 
	#SIZE
(
x
Ë((x)/(x[0]))

	)

34 
	#CLEAR
(
x
Ë
	`mem£t
(&(x), 0, (x))

	)

36 
	#IPV4_NETMASK_HOST
 0xffffffffU

	)

	@src/openvpn/buffer.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"comm⁄.h
"

34 
	~"buf„r.h
"

35 
	~"îr‹.h
"

36 
	~"mtu.h
"

37 
	~"misc.h
"

39 
	~"memdbg.h
"

41 
size_t


42 
	$¨øy_mu…_ß„
 (c⁄° 
size_t
 
m1
, c⁄° size_à
m2
, c⁄° size_à
exåa
)

44 c⁄° 
size_t
 
limô
 = 0xFFFFFFFF;

45 
ªs
 = ()
m1
 * ()
m2
 + ()
exåa
;

46 i‡(
	`u∆ikñy
(
m1
 > 
limô
Ë|| u∆ikñy(
m2
 >ÜimôË|| u∆ikñy(
exåa
 >ÜimôË|| u∆ikñy(
ªs
 > ()limit))

47 
	`msg
 (
M_FATAL
, "attempedállocation ofÉxcessivelyÜargeárray");

48  (
size_t
Ë
ªs
;

49 
	}
}

52 
	$buf_size_îr‹
 (c⁄° 
size_t
 
size
)

54 
	`msg
 (
M_FATAL
, "Áè»buf„∏sizêîr‹, size=%lu", ()
size
);

55 
	}
}

57 
	gbuf„r


58 #ifde‡
DMALLOC


59 
	$Æloc_buf_debug
 (
size_t
 
size
, c⁄° *
fûe
, 
löe
)

61 
	$Æloc_buf
 (
size_t
 
size
)

64 
buf„r
 
buf
;

66 i‡(!
	`buf_size_vÆid
 (
size
))

67 
	`buf_size_îr‹
 (
size
);

68 
buf
.
ˇ∑côy
 = ()
size
;

69 
buf
.
off£t
 = 0;

70 
buf
.
Àn
 = 0;

71 #ifde‡
DMALLOC


72 
buf
.
d©a
 = 
	`›ív≤_dmÆloc
 (
fûe
, 
löe
, 
size
);

74 
buf
.
d©a
 = 
	`ˇŒoc
 (1, 
size
);

76 
	`check_mÆloc_ªtu∫
(
buf
.
d©a
);

78  
buf
;

79 
	}
}

81 
	gbuf„r


82 #ifde‡
DMALLOC


83 
	$Æloc_buf_gc_debug
 (
size_t
 
size
, 
gc_¨ía
 *
gc
, c⁄° *
fûe
, 
löe
)

85 
	$Æloc_buf_gc
 (
size_t
 
size
, 
gc_¨ía
 *
gc
)

88 
buf„r
 
buf
;

89 i‡(!
	`buf_size_vÆid
 (
size
))

90 
	`buf_size_îr‹
 (
size
);

91 
buf
.
ˇ∑côy
 = ()
size
;

92 
buf
.
off£t
 = 0;

93 
buf
.
Àn
 = 0;

94 #ifde‡
DMALLOC


95 
buf
.
d©a
 = (
uöt8_t
 *Ë
	`gc_mÆloc_debug
 (
size
, 
Ál£
, 
gc
, 
fûe
, 
löe
);

97 
buf
.
d©a
 = (
uöt8_t
 *Ë
	`gc_mÆloc
 (
size
, 
Ál£
, 
gc
);

99 i‡(
size
)

100 *
buf
.
d©a
 = 0;

101  
buf
;

102 
	}
}

104 
	gbuf„r


105 #ifde‡
DMALLOC


106 
	$˛⁄e_buf_debug
 (c⁄° 
buf„r
* 
buf
, c⁄° *
fûe
, 
löe
)

108 
	$˛⁄e_buf
 (c⁄° 
buf„r
* 
buf
)

111 
buf„r
 
ªt
;

112 
ªt
.
ˇ∑côy
 = 
buf
->capacity;

113 
ªt
.
off£t
 = 
buf
->offset;

114 
ªt
.
Àn
 = 
buf
->len;

115 #ifde‡
DMALLOC


116 
ªt
.
d©a
 = (
uöt8_t
 *Ë
	`›ív≤_dmÆloc
 (
fûe
, 
löe
, 
buf
->
ˇ∑côy
);

118 
ªt
.
d©a
 = (
uöt8_t
 *Ë
	`mÆloc
 (
buf
->
ˇ∑côy
);

120 
	`check_mÆloc_ªtu∫
 (
ªt
.
d©a
);

121 
	`mem˝y
 (
	`BPTR
 (&
ªt
), BPTR (
buf
), 
	`BLEN
 (buf));

122  
ªt
;

123 
	}
}

125 #ifde‡
BUF_INIT_TRACKING


127 
boﬁ


128 
	$buf_öô_debug
 (
buf„r
 *
buf
, 
off£t
, c⁄° *
fûe
, 
löe
)

130 
buf
->
debug_fûe
 = 
fûe
;

131 
buf
->
debug_löe
 = 
löe
;

132  
	`buf_öô_dow‹k
 (
buf
, 
off£t
);

133 
	}
}

135 
ölöe
 

136 
	$buf_debug_löe
 (c⁄° 
buf„r
 *
buf
)

138  
buf
->
debug_löe
;

139 
	}
}

142 
	$buf_debug_fûe
 (c⁄° 
buf„r
 *
buf
)

144  
buf
->
debug_fûe
;

145 
	}
}

149 
	#buf_debug_löe
(
buf
Ë0

	)

150 
	#buf_debug_fûe
(
buf
Ë"[UNDEF]"

	)

155 
	$buf_˛ór
 (
buf„r
 *
buf
)

157 i‡(
buf
->
ˇ∑côy
 > 0)

158 
	`mem£t
 (
buf
->
d©a
, 0, buf->
ˇ∑côy
);

159 
buf
->
Àn
 = 0;

160 
buf
->
off£t
 = 0;

161 
	}
}

163 
boﬁ


164 
	$buf_assign
 (
buf„r
 *
de°
, c⁄° buf„∏*
§c
)

166 i‡(!
	`buf_öô
 (
de°
, 
§c
->
off£t
))

167  
Ál£
;

168  
	`buf_wrôe
 (
de°
, 
	`BPTR
 (
§c
), 
	`BLEN
 (src));

169 
	}
}

171 
buf„r


172 
	$˛ór_buf
 ()

174 
buf„r
 
buf
;

175 
	`CLEAR
 (
buf
);

176  
buf
;

177 
	}
}

180 
	$‰ì_buf
 (
buf„r
 *
buf
)

182 i‡(
buf
->
d©a
)

183 
	`‰ì
 (
buf
->
d©a
);

184 
	`CLEAR
 (*
buf
);

185 
	}
}

190 
buf„r


191 
	$buf_sub
 (
buf„r
 *
buf
, 
size
, 
boﬁ
 
¥ïíd
)

193 
buf„r
 
ªt
;

194 
uöt8_t
 *
d©a
;

196 
	`CLEAR
 (
ªt
);

197 
d©a
 = 
¥ïíd
 ? 
	`buf_¥ïíd
 (
buf
, 
size
Ë: 
	`buf_wrôe_Æloc
 (buf, size);

198 i‡(
d©a
)

200 
ªt
.
ˇ∑côy
 = 
size
;

201 
ªt
.
d©a
 = data;

203  
ªt
;

204 
	}
}

209 
boﬁ


210 
	$buf_¥ötf
 (
buf„r
 *
buf
, c⁄° *
f‹m©
, ...)

212 
ªt
 = 
Ál£
;

213 i‡(
	`buf_deföed
 (
buf
))

215 
va_li°
 
¨gli°
;

216 
uöt8_t
 *
±r
 = 
	`BEND
 (
buf
);

217 
ˇp
 = 
	`buf_f‹w¨d_ˇ∑côy
 (
buf
);

219 i‡(
ˇp
 > 0)

221 
°©
;

222 
	`va_°¨t
 (
¨gli°
, 
f‹m©
);

223 
°©
 = 
	`v¢¥ötf
 ((*)
±r
, 
ˇp
, 
f‹m©
, 
¨gli°
);

224 
	`va_íd
 (
¨gli°
);

225 *(
buf
->
d©a
 + buf->
ˇ∑côy
 - 1) = 0;

226 
buf
->
Àn
 +(Ë
	`°æí
 ((*)
±r
);

227 i‡(
°©
 >0 && sèà< 
ˇp
)

228 
ªt
 = 
åue
;

231  
ªt
;

232 
	}
}

234 
boﬁ


235 
	$buf_puts
(
buf„r
 *
buf
, c⁄° *
°r
)

237 
ªt
 = 
Ál£
;

238 
uöt8_t
 *
±r
 = 
	`BEND
 (
buf
);

239 
ˇp
 = 
	`buf_f‹w¨d_ˇ∑côy
 (
buf
);

240 i‡(
ˇp
 > 0)

242 
	`°∫˝y¡
 ((*)
±r
,
°r
, 
ˇp
);

243 *(
buf
->
d©a
 + buf->
ˇ∑côy
 - 1) = 0;

244 
buf
->
Àn
 +(Ë
	`°æí
 ((*)
±r
);

245 
ªt
 = 
åue
;

247  
ªt
;

248 
	}
}

261 
boﬁ
 
	$›ív≤_¢¥ötf
(*
°r
, 
size_t
 
size
, c⁄° *
f‹m©
, ...)

263 
va_li°
 
¨gli°
;

264 
Àn
 = -1;

265 i‡(
size
 > 0)

267 
	`va_°¨t
 (
¨gli°
, 
f‹m©
);

268 
Àn
 = 
	`v¢¥ötf
 (
°r
, 
size
, 
f‹m©
, 
¨gli°
);

269 
	`va_íd
 (
¨gli°
);

270 
°r
[
size
 - 1] = 0;

272  (
Àn
 >0 &&Üí < 
size
);

273 
	}
}

280 
	$buf_ˇåunc
 (
buf„r
 *
buf
, c⁄° *
°r
)

282 i‡(
	`buf_f‹w¨d_ˇ∑côy
 (
buf
) <= 1)

284 
Àn
 = (Ë
	`°æí
 (
°r
) + 1;

285 i‡(
Àn
 < 
	`buf_f‹w¨d_ˇ∑côy_tŸÆ
 (
buf
))

287 
	`°∫˝y¡
 ((*)(
buf
->
d©a
 + buf->
ˇ∑côy
 - 
Àn
), 
°r
,Üen);

290 
	}
}

296 
	$c⁄vît_to_⁄e_löe
 (
buf„r
 *
buf
)

298 
uöt8_t
 *
˝
 = 
	`BPTR
(
buf
);

299 
Àn
 = 
	`BLEN
(
buf
);

300 
Àn
--)

302 i‡(*
˝
 == '\n')

303 *
˝
 = '|';

304 ++
˝
;

306 
	}
}

310 
	$buf_wrôe_°rög_fûe
 (c⁄° 
buf„r
 *
buf
, c⁄° *
fûíame
, 
fd
)

312 c⁄° 
Àn
 = 
	`°æí
 ((*Ë
	`BPTR
 (
buf
));

313 c⁄° 
size
 = 
	`wrôe
 (
fd
, 
	`BPTR
 (
buf
), 
Àn
);

314 i‡(
size
 !
Àn
)

315 
	`msg
 (
M_ERR
, "Wrôêîr‹ o¿fûê'%s'", 
fûíame
);

316 
	}
}

323 #ifde‡
DMALLOC


324 
	$gc_mÆloc_debug
 (
size_t
 
size
, 
boﬁ
 
˛ór
, 
gc_¨ía
 *
a
, c⁄° *
fûe
, 
löe
)

326 
	$gc_mÆloc
 (
size_t
 
size
, 
boﬁ
 
˛ór
, 
gc_¨ía
 *
a
)

329 *
ªt
;

330 i‡(
a
)

332 
gc_íåy
 *
e
;

333 #ifde‡
DMALLOC


334 
e
 = (
gc_íåy
 *Ë
	`›ív≤_dmÆloc
 (
fûe
, 
löe
, 
size
 +  (gc_entry));

336 
e
 = (
gc_íåy
 *Ë
	`mÆloc
 (
size
 +  (gc_entry));

338 
	`check_mÆloc_ªtu∫
 (
e
);

339 
ªt
 = (*Ë
e
 +  (
gc_íåy
);

340 
e
->
√xt
 = 
a
->
li°
;

341 
a
->
li°
 = 
e
;

345 #ifde‡
DMALLOC


346 
ªt
 = 
	`›ív≤_dmÆloc
 (
fûe
, 
löe
, 
size
);

348 
ªt
 = 
	`mÆloc
 (
size
);

350 
	`check_mÆloc_ªtu∫
 (
ªt
);

352 #i‚de‡
ZERO_BUFFER_ON_ALLOC


353 i‡(
˛ór
)

355 
	`mem£t
 (
ªt
, 0, 
size
);

356  
ªt
;

357 
	}
}

360 
	$x_gc_‰ì
 (
gc_¨ía
 *
a
)

362 
gc_íåy
 *
e
;

363 
e
 = 
a
->
li°
;

364 
a
->
li°
 = 
NULL
;

366 
e
 !
NULL
)

368 
gc_íåy
 *
√xt
 = 
e
->next;

369 
	`‰ì
 (
e
);

370 
e
 = 
√xt
;

372 
	}
}

378 
	$gc_å™s„r
 (
gc_¨ía
 *
de°
, gc_¨í®*
§c
)

380 i‡(
de°
 && 
§c
)

382 
gc_íåy
 *
e
 = 
§c
->
li°
;

383 i‡(
e
)

385 
e
->
√xt
 !
NULL
)

386 
e
 =É->
√xt
;

387 
e
->
√xt
 = 
de°
->
li°
;

388 
de°
->
li°
 = 
§c
->list;

389 
§c
->
li°
 = 
NULL
;

392 
	}
}

399 
	$f‹m©_hex_ex
 (c⁄° 
uöt8_t
 *
d©a
, 
size
, 
maxouçut
,

400 
•a˚_bªak
, c⁄° * 
£∑øt‹
,

401 
gc_¨ía
 *
gc
)

403 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (
maxouçut
 ? maxoutput :

404 ((
size
 * 2Ë+ (sizê/ 
•a˚_bªak
Ë* (Ë
	`°æí
 (
£∑øt‹
) + 2),

405 
gc
);

406 
i
;

407 
i
 = 0; i < 
size
; ++i)

409 i‡(
£∑øt‹
 && 
i
 && !(ò% 
•a˚_bªak
))

410 
	`buf_¥ötf
 (&
out
, "%s", 
£∑øt‹
);

411 
	`buf_¥ötf
 (&
out
, "%02x", 
d©a
[
i
]);

413 
	`buf_ˇåunc
 (&
out
, "[more...]");

414  (*)
out
.
d©a
;

415 
	}
}

422 
	$buf_rmèû
 (
buf„r
 *
buf
, 
uöt8_t
 
ªmove
)

424 
uöt8_t
 *
˝
 = 
	`BLAST
(
buf
);

425 i‡(
˝
 && *˝ =
ªmove
)

427 *
˝
 = '\0';

428 --
buf
->
Àn
;

430 
	}
}

437 
	$buf_nuŒ_ãrmö©e
 (
buf„r
 *
buf
)

439 *
œ°
 = (*Ë
	`BLAST
 (
buf
);

440 i‡(
œ°
 && *last == '\0')

443 i‡(!
	`buf_ß„
 (
buf
, 1))

444 
	`buf_öc_Àn
 (
buf
, -1);

446 
	`buf_wrôe_u8
 (
buf
, 0);

447 
	}
}

454 
	$buf_chomp
 (
buf„r
 *
buf
)

456 
åue
)

458 *
œ°
 = (*Ë
	`BLAST
 (
buf
);

459 i‡(!
œ°
)

461 i‡(
	`ch¨_˛ass
 (*
œ°
, 
CC_CRLF
|
CC_NULL
))

463 i‡(!
	`buf_öc_Àn
 (
buf
, -1))

469 
	`buf_nuŒ_ãrmö©e
 (
buf
);

470 
	}
}

473 
	$skù_Àadög_whôe•a˚
 (c⁄° *
°r
)

475 *
°r
)

477 c⁄° 
c
 = *
°r
;

478 i‡(!(
c
 == ' ' || c == '\t'))

480 ++
°r
;

482  
°r
;

483 
	}
}

489 
	$°rög_nuŒ_ãrmö©e
 (*
°r
, 
Àn
, 
ˇ∑côy
)

491 
	`ASSERT
 (
Àn
 >0 &&Üí <
ˇ∑côy
 && capacity > 0);

492 i‡(
Àn
 < 
ˇ∑côy
)

493 *(
°r
 + 
Àn
) = '\0';

494 i‡(
Àn
 =
ˇ∑côy
)

495 *(
°r
 + 
Àn
 - 1) = '\0';

496 
	}
}

502 
	$chomp
 (*
°r
)

504 
	`rm_åaûög_ch¨s
 (
°r
, "\r\n");

505 
	}
}

511 
	$rm_åaûög_ch¨s
 (*
°r
, c⁄° *
wh©_to_dñëe
)

513 
boﬁ
 
modifõd
;

515 c⁄° 
Àn
 = 
	`°æí
 (
°r
);

516 
modifõd
 = 
Ál£
;

517 i‡(
Àn
 > 0)

519 *
˝
 = 
°r
 + (
Àn
 - 1);

520 i‡(
	`°rchr
 (
wh©_to_dñëe
, *
˝
Ë!
NULL
)

522 *
˝
 = '\0';

523 
modifõd
 = 
åue
;

526 } 
modifõd
);

527 
	}
}

533 #ifde‡
DMALLOC


534 
	$°rög_Æloc_debug
 (c⁄° *
°r
, 
gc_¨ía
 *
gc
, c⁄° *
fûe
, 
löe
)

536 
	$°rög_Æloc
 (c⁄° *
°r
, 
gc_¨ía
 *
gc
)

539 i‡(
°r
)

541 c⁄° 
n
 = 
	`°æí
 (
°r
) + 1;

542 *
ªt
;

544 i‡(
gc
) {

545 #ifde‡
DMALLOC


546 
ªt
 = (*Ë
	`gc_mÆloc_debug
 (
n
, 
Ál£
, 
gc
, 
fûe
, 
löe
);

548 
ªt
 = (*Ë
	`gc_mÆloc
 (
n
, 
Ál£
, 
gc
);

555 #ifde‡
DMALLOC


556 
ªt
 = 
	`›ív≤_dmÆloc
 (
fûe
, 
löe
, 
n
);

557 
	`mem£t
(
ªt
, 0, 
n
);

559 
ªt
 = 
	`ˇŒoc
(1, 
n
);

561 
	`check_mÆloc_ªtu∫
(
ªt
);

563 
	`mem˝y
 (
ªt
, 
°r
, 
n
);

564  
ªt
;

567  
NULL
;

568 
	}
}

574 
	$°rög_˛ór
 (*
°r
)

576 i‡(
°r
)

578 c⁄° 
Àn
 = 
	`°æí
 (
°r
);

579 i‡(
Àn
 > 0)

580 
	`mem£t
 (
°r
, 0, 
Àn
);

582 
	}
}

588 
	$°rög_¨øy_Àn
 (c⁄° **
¨øy
)

590 
i
 = 0;

591 i‡(
¨øy
)

593 
¨øy
[
i
])

594 ++
i
;

596  
i
;

597 
	}
}

600 
	$¥öt_¨gv
 (c⁄° **
p
, 
gc_¨ía
 *
gc
, c⁄° 
Êags
)

602 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

603 
i
 = 0;

606 c⁄° *
˝
 = *
p
++;

607 i‡(!
˝
)

609 i‡(
i
)

610 
	`buf_¥ötf
 (&
out
, " ");

611 i‡(
Êags
 & 
PA_BRACKET
)

612 
	`buf_¥ötf
 (&
out
, "[%s]", 
˝
);

614 
	`buf_¥ötf
 (&
out
, "%s", 
˝
);

615 ++
i
;

617  
	`BSTR
 (&
out
);

618 
	}
}

623 
	gbuf„r


624 #ifde‡
DMALLOC


625 
	$°rög_Æloc_buf_debug
 (c⁄° *
°r
, 
gc_¨ía
 *
gc
, c⁄° *
fûe
, 
löe
)

627 
	$°rög_Æloc_buf
 (c⁄° *
°r
, 
gc_¨ía
 *
gc
)

630 
buf„r
 
buf
;

632 
	`ASSERT
 (
°r
);

634 #ifde‡
DMALLOC


635 
	`buf_£t_ªad
 (&
buf
, (
uöt8_t
*Ë
	`°rög_Æloc_debug
 (
°r
, 
gc
, 
fûe
, 
löe
), 
	`°æí
 (str) + 1);

637 
	`buf_£t_ªad
 (&
buf
, (
uöt8_t
*Ë
	`°rög_Æloc
 (
°r
, 
gc
), 
	`°æí
 (str) + 1);

640 i‡(
buf
.
Àn
 > 0)

641 --
buf
.
Àn
;

643  
buf
;

644 
	}
}

650 
boﬁ


651 
	$buf_°rög_m©ch_hód_°r
 (c⁄° 
buf„r
 *
§c
, c⁄° *
m©ch
)

653 c⁄° 
size
 = 
	`°æí
 (
m©ch
);

654 i‡(
size
 < 0 || sizê> 
§c
->
Àn
)

655  
Ál£
;

656  
	`memcmp
 (
	`BPTR
 (
§c
), 
m©ch
, 
size
) == 0;

657 
	}
}

659 
boﬁ


660 
	$buf_°rög_com∑ª_adv™˚
 (
buf„r
 *
§c
, c⁄° *
m©ch
)

662 i‡(
	`buf_°rög_m©ch_hód_°r
 (
§c
, 
m©ch
))

664 
	`buf_adv™˚
 (
§c
, 
	`°æí
 (
m©ch
));

665  
åue
;

668  
Ál£
;

669 
	}
}

672 
	$buf_sub°rög_Àn
 (c⁄° 
buf„r
 *
buf
, 
dñim
)

674 
i
 = 0;

675 
buf„r
 
tmp
 = *
buf
;

676 
c
;

678 (
c
 = 
	`buf_ªad_u8
 (&
tmp
)) >= 0)

680 ++
i
;

681 i‡(
c
 =
dñim
)

682  
i
;

685 
	}
}

691 
boﬁ


692 
	$buf_∑r£
 (
buf„r
 *
buf
, c⁄° 
dñim
, *
löe
, c⁄° 
size
)

694 
boﬁ
 
eﬁ
 = 
Ál£
;

695 
n
 = 0;

696 
c
;

698 
	`ASSERT
 (
size
 > 0);

702 
c
 = 
	`buf_ªad_u8
 (
buf
);

703 i‡(
c
 < 0)

704 
eﬁ
 = 
åue
;

705 i‡(
c
 <0 || c =
dñim
)

706 
c
 = 0;

707 i‡(
n
 >
size
)

709 
löe
[
n
++] = 
c
;

711 
c
);

713 
löe
[
size
-1] = '\0';

714  !(
eﬁ
 && !
	`°æí
 (
löe
));

715 
	}
}

721 
	$≈
 (c⁄° *
°r
)

723 i‡(
°r
)

724  
°r
;

727 
	}
}

733 
boﬁ


734 
	$ch¨_˛ass
 (c⁄° 
c
, c⁄° 
Êags
)

736 i‡(!
Êags
)

737  
Ál£
;

738 i‡(
Êags
 & 
CC_ANY
)

739  
åue
;

741 i‡((
Êags
 & 
CC_NULL
Ë&& 
c
 == '\0')

742  
åue
;

744 i‡((
Êags
 & 
CC_ALNUM
Ë&& 
	`iß um
 (
c
))

745  
åue
;

746 i‡((
Êags
 & 
CC_ALPHA
Ë&& 
	`ißÕha
 (
c
))

747  
åue
;

748 i‡((
Êags
 & 
CC_ASCII
Ë&& 
	`ißscii
 (
c
))

749  
åue
;

750 i‡((
Êags
 & 
CC_CNTRL
Ë&& 
	`is˙ål
 (
c
))

751  
åue
;

752 i‡((
Êags
 & 
CC_DIGIT
Ë&& 
	`isdigô
 (
c
))

753  
åue
;

754 i‡((
Êags
 & 
CC_PRINT
Ë&& (
c
 >= 32 && c != 127))

755  
åue
;

756 i‡((
Êags
 & 
CC_PUNCT
Ë&& 
	`i•un˘
 (
c
))

757  
åue
;

758 i‡((
Êags
 & 
CC_SPACE
Ë&& 
	`is•a˚
 (
c
))

759  
åue
;

760 i‡((
Êags
 & 
CC_XDIGIT
Ë&& 
	`isxdigô
 (
c
))

761  
åue
;

763 i‡((
Êags
 & 
CC_BLANK
Ë&& (
c
 == ' ' || c == '\t'))

764  
åue
;

765 i‡((
Êags
 & 
CC_NEWLINE
Ë&& 
c
 == '\n')

766  
åue
;

767 i‡((
Êags
 & 
CC_CR
Ë&& 
c
 == '\r')

768  
åue
;

770 i‡((
Êags
 & 
CC_BACKSLASH
Ë&& 
c
 == '\\')

771  
åue
;

772 i‡((
Êags
 & 
CC_UNDERBAR
Ë&& 
c
 == '_')

773  
åue
;

774 i‡((
Êags
 & 
CC_DASH
Ë&& 
c
 == '-')

775  
åue
;

776 i‡((
Êags
 & 
CC_DOT
Ë&& 
c
 == '.')

777  
åue
;

778 i‡((
Êags
 & 
CC_COMMA
Ë&& 
c
 == ',')

779  
åue
;

780 i‡((
Êags
 & 
CC_COLON
Ë&& 
c
 == ':')

781  
åue
;

782 i‡((
Êags
 & 
CC_SLASH
Ë&& 
c
 == '/')

783  
åue
;

784 i‡((
Êags
 & 
CC_SINGLE_QUOTE
Ë&& 
c
 == '\'')

785  
åue
;

786 i‡((
Êags
 & 
CC_DOUBLE_QUOTE
Ë&& 
c
 == '\"')

787  
åue
;

788 i‡((
Êags
 & 
CC_REVERSE_QUOTE
Ë&& 
c
 == '`')

789  
åue
;

790 i‡((
Êags
 & 
CC_AT
Ë&& 
c
 == '@')

791  
åue
;

792 i‡((
Êags
 & 
CC_EQUAL
Ë&& 
c
 == '=')

793  
åue
;

794 i‡((
Êags
 & 
CC_LESS_THAN
Ë&& 
c
 == '<')

795  
åue
;

796 i‡((
Êags
 & 
CC_GREATER_THAN
Ë&& 
c
 == '>')

797  
åue
;

798 i‡((
Êags
 & 
CC_PIPE
Ë&& 
c
 == '|')

799  
åue
;

800 i‡((
Êags
 & 
CC_QUESTION_MARK
Ë&& 
c
 == '?')

801  
åue
;

802 i‡((
Êags
 & 
CC_ASTERISK
Ë&& 
c
 == '*')

803  
åue
;

805  
Ál£
;

806 
	}
}

808 
ölöe
 
boﬁ


809 
	$ch¨_öc_exc
 (c⁄° 
c
, c⁄° 
ö˛usive
, c⁄° 
ex˛usive
)

811  
	`ch¨_˛ass
 (
c
, 
ö˛usive
Ë&& !ch¨_˛as†(c, 
ex˛usive
);

812 
	}
}

814 
boﬁ


815 
	$°rög_˛ass
 (c⁄° *
°r
, c⁄° 
ö˛usive
, c⁄° 
ex˛usive
)

817 
c
;

818 
	`ASSERT
 (
°r
);

819 (
c
 = *
°r
++))

821 i‡(!
	`ch¨_öc_exc
 (
c
, 
ö˛usive
, 
ex˛usive
))

822  
Ál£
;

824  
åue
;

825 
	}
}

831 
boﬁ


832 
	$°rög_mod
 (*
°r
, c⁄° 
ö˛usive
, c⁄° 
ex˛usive
, c⁄° 
ª∂a˚
)

834 c⁄° *
ö
 = 
°r
;

835 
boﬁ
 
ªt
 = 
åue
;

837 
	`ASSERT
 (
°r
);

839 
åue
)

841 
c
 = *
ö
++;

842 i‡(
c
)

844 i‡(!
	`ch¨_öc_exc
 (
c
, 
ö˛usive
, 
ex˛usive
))

846 
c
 = 
ª∂a˚
;

847 
ªt
 = 
Ál£
;

849 i‡(
c
)

850 *
°r
++ = 
c
;

854 *
°r
 = '\0';

858  
ªt
;

859 
	}
}

862 
	$°rög_mod_c⁄°
 (c⁄° *
°r
,

863 c⁄° 
ö˛usive
,

864 c⁄° 
ex˛usive
,

865 c⁄° 
ª∂a˚
,

866 
gc_¨ía
 *
gc
)

868 i‡(
°r
)

870 *
buf
 = 
	`°rög_Æloc
 (
°r
, 
gc
);

871 
	`°rög_mod
 (
buf
, 
ö˛usive
, 
ex˛usive
, 
ª∂a˚
);

872  
buf
;

875  
NULL
;

876 
	}
}

879 
	$°rög_ª∂a˚_Àadög
 (*
°r
, c⁄° 
m©ch
, c⁄° 
ª∂a˚
)

881 
	`ASSERT
 (
m©ch
 != '\0');

882 *
°r
)

884 i‡(*
°r
 =
m©ch
)

885 *
°r
 = 
ª∂a˚
;

888 ++
°r
;

890 
	}
}

892 #ifde‡
CHARACTER_CLASS_DEBUG


894 
	#CC_INCLUDE
 (
CC_PRINT
)

	)

895 
	#CC_EXCLUDE
 (0)

	)

896 
	#CC_REPLACE
 ('.')

	)

899 
	$ch¨a˘î_˛ass_debug
 ()

901 
buf
[256];

903 
	`fgës
 (
buf
,  (buf), 
°dö
Ë!
NULL
)

905 
	`°rög_mod
 (
buf
, 
CC_INCLUDE
, 
CC_EXCLUDE
, 
CC_REPLACE
);

906 
	`¥ötf
 ("%s", 
buf
);

908 
	}
}

912 #ifde‡
VERIFY_ALIGNMENT


914 
	$vÆign4
 (c⁄° 
buf„r
 *
buf
, c⁄° *
fûe
, c⁄° 
löe
)

916 i‡(
buf
 && buf->
Àn
)

918 
msgÀvñ
 = 
D_ALIGN_DEBUG
;

919 c⁄° 
u
 = (Ë
	`BPTR
 (
buf
);

921 i‡(
u
 & (
PAYLOAD_ALIGN
-1))

922 
msgÀvñ
 = 
D_ALIGN_ERRORS
;

924 
	`msg
 (
msgÀvñ
, "%sAlignmíà© %s/%dÖå=" 
±r_f‹m©
 " OLC=%d/%d/%d I=%s/%d",

925 (
msgÀvñ
 =
D_ALIGN_ERRORS
) ? "ERROR: " : "",

926 
fûe
,

927 
löe
,

928 (
±r_ty≥
)
buf
->
d©a
,

929 
buf
->
off£t
,

930 
buf
->
Àn
,

931 
buf
->
ˇ∑côy
,

932 
	`buf_debug_fûe
 (
buf
),

933 
	`buf_debug_löe
 (
buf
));

935 
	}
}

942 #ifde‡
ENABLE_BUFFER_LIST


944 
buf„r_li°
 *

945 
	$buf„r_li°_√w
 (c⁄° 
max_size
)

947 
buf„r_li°
 *
ªt
;

948 
	`ALLOC_OBJ_CLEAR
 (
ªt
, 
buf„r_li°
);

949 
ªt
->
max_size
 = max_size;

950 
ªt
->
size
 = 0;

951  
ªt
;

952 
	}
}

955 
	$buf„r_li°_‰ì
 (
buf„r_li°
 *
ﬁ
)

957 i‡(
ﬁ
)

959 
	`buf„r_li°_ª£t
 (
ﬁ
);

960 
	`‰ì
 (
ﬁ
);

962 
	}
}

964 
boﬁ


965 
	$buf„r_li°_deföed
 (c⁄° 
buf„r_li°
 *
ﬁ
)

967  
ﬁ
 && ol->
hód
 !
NULL
;

968 
	}
}

971 
	$buf„r_li°_ª£t
 (
buf„r_li°
 *
ﬁ
)

973 
buf„r_íåy
 *
e
 = 
ﬁ
->
hód
;

974 
e
)

976 
buf„r_íåy
 *
√xt
 = 
e
->next;

977 
	`‰ì_buf
 (&
e
->
buf
);

978 
	`‰ì
 (
e
);

979 
e
 = 
√xt
;

981 
ﬁ
->
hód
 = ol->
èû
 = 
NULL
;

982 
ﬁ
->
size
 = 0;

983 
	}
}

986 
	$buf„r_li°_push
 (
buf„r_li°
 *
ﬁ
, c⁄° *
°r
)

988 i‡(
°r
)

990 c⁄° 
size_t
 
Àn
 = 
	`°æí
 ((c⁄° *)
°r
);

991 
buf„r_íåy
 *
e
 = 
	`buf„r_li°_push_d©a
 (
ﬁ
, 
°r
, 
Àn
+1);

992 i‡(
e
)

993 
e
->
buf
.
Àn
 =Üen;

995 
	}
}

997 
buf„r_íåy
 *

998 
	$buf„r_li°_push_d©a
 (
buf„r_li°
 *
ﬁ
, c⁄° 
uöt8_t
 *
d©a
, 
size_t
 
size
)

1000 
buf„r_íåy
 *
e
 = 
NULL
;

1001 i‡(
d©a
 && (!
ﬁ
->
max_size
 || ol->
size
 < ol->max_size))

1003 
	`ALLOC_OBJ_CLEAR
 (
e
, 
buf„r_íåy
);

1005 ++
ﬁ
->
size
;

1006 i‡(
ﬁ
->
èû
)

1008 
	`ASSERT
 (
ﬁ
->
hód
);

1009 
ﬁ
->
èû
->
√xt
 = 
e
;

1013 
	`ASSERT
 (!
ﬁ
->
hód
);

1014 
ﬁ
->
hód
 = 
e
;

1016 
e
->
buf
 = 
	`Æloc_buf
 (
size
);

1017 
	`mem˝y
 (
e
->
buf
.
d©a
, d©a, 
size
);

1018 
e
->
buf
.
Àn
 = ()
size
;

1019 
ﬁ
->
èû
 = 
e
;

1021  
e
;

1022 
	}
}

1024 
buf„r
 *

1025 
	$buf„r_li°_≥ek
 (
buf„r_li°
 *
ﬁ
)

1027 i‡(
ﬁ
 && ol->
hód
)

1028  &
ﬁ
->
hód
->
buf
;

1030  
NULL
;

1031 
	}
}

1034 
	$buf„r_li°_aggªg©e
 (
buf„r_li°
 *
bl
, c⁄° 
size_t
 
max
)

1036 i‡(
bl
->
hód
)

1038 
buf„r_íåy
 *
m‹e
 = 
bl
->
hód
;

1039 
size_t
 
size
 = 0;

1040 
cou¡
 = 0;

1041 
cou¡
 = 0; 
m‹e
 && 
size
 <
max
; ++count)

1043 
size
 +
	`BLEN
(&
m‹e
->
buf
);

1044 
m‹e
 = m‹e->
√xt
;

1047 i‡(
cou¡
 >= 2)

1049 
i
;

1050 
buf„r_íåy
 *
e
 = 
bl
->
hód
, *
f
;

1052 
	`ALLOC_OBJ_CLEAR
 (
f
, 
buf„r_íåy
);

1053 
f
->
buf
.
d©a
 = 
	`mÆloc
 (
size
);

1054 
	`check_mÆloc_ªtu∫
 (
f
->
buf
.
d©a
);

1055 
f
->
buf
.
ˇ∑côy
 = 
size
;

1056 
i
 = 0; 
e
 && i < 
cou¡
; ++i)

1058 
buf„r_íåy
 *
√xt
 = 
e
->next;

1059 
	`buf_c›y
 (&
f
->
buf
, &
e
->buf);

1060 
	`‰ì_buf
 (&
e
->
buf
);

1061 
	`‰ì
 (
e
);

1062 
e
 = 
√xt
;

1064 
bl
->
hód
 = 
f
;

1065 
f
->
√xt
 = 
m‹e
;

1066 i‡(!
m‹e
)

1067 
bl
->
èû
 = 
f
;

1070 
	}
}

1073 
	$buf„r_li°_p›
 (
buf„r_li°
 *
ﬁ
)

1075 i‡(
ﬁ
 && ol->
hód
)

1077 
buf„r_íåy
 *
e
 = 
ﬁ
->
hód
->
√xt
;

1078 
	`‰ì_buf
 (&
ﬁ
->
hód
->
buf
);

1079 
	`‰ì
 (
ﬁ
->
hód
);

1080 
ﬁ
->
hód
 = 
e
;

1081 --
ﬁ
->
size
;

1082 i‡(!
e
)

1083 
ﬁ
->
èû
 = 
NULL
;

1085 
	}
}

1088 
	$buf„r_li°_adv™˚
 (
buf„r_li°
 *
ﬁ
, 
n
)

1090 i‡(
ﬁ
->
hód
)

1092 
buf„r
 *
buf
 = &
ﬁ
->
hód
->buf;

1093 
	`ASSERT
 (
	`buf_adv™˚
 (
buf
, 
n
));

1094 i‡(!
	`BLEN
 (
buf
))

1095 
	`buf„r_li°_p›
 (
ﬁ
);

1097 
	}
}

1099 
buf„r_li°
 *

1100 
	$buf„r_li°_fûe
 (c⁄° *
‚
, 
max_löe_Àn
)

1102 
FILE
 *
Â
 = 
	`∂©f‹m_f›í
 (
‚
, "r");

1103 
buf„r_li°
 *
bl
 = 
NULL
;

1105 i‡(
Â
)

1107 *
löe
 = (*Ë
	`mÆloc
 (
max_löe_Àn
);

1108 i‡(
löe
)

1110 
bl
 = 
	`buf„r_li°_√w
 (0);

1111 
	`fgës
 (
löe
, 
max_löe_Àn
, 
Â
Ë!
NULL
)

1112 
	`buf„r_li°_push
 (
bl
, (*)
löe
);

1113 
	`‰ì
 (
löe
);

1115 
	`f˛o£
 (
Â
);

1117  
bl
;

1118 
	}
}

	@src/openvpn/buffer.h

25 #i‚de‡
BUFFER_H


26 
	#BUFFER_H


	)

28 
	~"basic.h
"

29 
	~"îr‹.h
"

31 
	#BUF_SIZE_MAX
 1000000

	)

42 #ifde‡
VERIFY_ALIGNMENT


43 
	#BUF_INIT_TRACKING


	)

61 
	sbuf„r


63 
	mˇ∑côy
;

65 
	moff£t
;

67 
	mÀn
;

69 
uöt8_t
 *
	md©a
;

71 #ifde‡
BUF_INIT_TRACKING


72 c⁄° *
	mdebug_fûe
;

73 
	mdebug_löe
;

88 
	sgc_íåy


90 
gc_íåy
 *
	m√xt
;

105 
	sgc_¨ía


107 
gc_íåy
 *
	mli°
;

112 
	#BPTR
(
buf
Ë(
	`buf_b±r
(buf))

	)

113 
	#BEND
(
buf
Ë(
	`buf_bíd
(buf))

	)

114 
	#BLAST
(
buf
Ë(
	`buf_bœ°
(buf))

	)

115 
	#BLEN
(
buf
Ë(
	`buf_Àn
(buf))

	)

116 
	#BDEF
(
buf
Ë(
	`buf_deföed
(buf))

	)

117 
	#BSTR
(
buf
Ë(
	`buf_°r
(buf))

	)

118 
	#BCAP
(
buf
Ë(
	`buf_f‹w¨d_ˇ∑côy
 (buf))

	)

120 
buf_˛ór
 (
buf„r
 *
buf
);

122 
buf„r
 
˛ór_buf
 ();

123 
‰ì_buf
 (
buf„r
 *
buf
);

125 
boﬁ
 
buf_assign
 (
buf„r
 *
de°
, c⁄° buf„∏*
§c
);

127 
°rög_˛ór
 (*
°r
);

128 
°rög_¨øy_Àn
 (c⁄° **
¨øy
);

130 
size_t
 
¨øy_mu…_ß„
 (c⁄° size_à
m1
, c⁄° size_à
m2
, c⁄° size_à
exåa
);

132 
	#PA_BRACKET
 (1<<0)

	)

133 *
¥öt_¨gv
 (c⁄° **
p
, 
gc_¨ía
 *
gc
, c⁄° 
Êags
);

135 
buf_size_îr‹
 (c⁄° 
size_t
 
size
);

139 #ifde‡
DMALLOC


141 
	#Æloc_buf
(
size
Ë
	`Æloc_buf_debug
 (size, 
__FILE__
, 
__LINE__
)

	)

142 
	#Æloc_buf_gc
(
size
, 
gc
Ë
	`Æloc_buf_gc_debug
 (size, gc, 
__FILE__
, 
__LINE__
);

	)

143 
	#˛⁄e_buf
(
buf
Ë
	`˛⁄e_buf_debug
 (buf, 
__FILE__
, 
__LINE__
);

	)

144 
	#gc_mÆloc
(
size
, 
˛ór
, 
¨ía
Ë
	`gc_mÆloc_debug
 (size, cÀ¨,áª«, 
__FILE__
, 
__LINE__
)

	)

145 
	#°rög_Æloc
(
°r
, 
gc
Ë
	`°rög_Æloc_debug
 (°r, gc, 
__FILE__
, 
__LINE__
)

	)

146 
	#°rög_Æloc_buf
(
°r
, 
gc
Ë
	`°rög_Æloc_buf_debug
 (°r, gc, 
__FILE__
, 
__LINE__
)

	)

148 
buf„r
 
Æloc_buf_debug
 (
size_t
 
size
, c⁄° *
fûe
, 
löe
);

149 
buf„r
 
Æloc_buf_gc_debug
 (
size_t
 
size
, 
gc_¨ía
 *
gc
, c⁄° *
fûe
, 
löe
);

150 
buf„r
 
˛⁄e_buf_debug
 (c⁄° buf„r* 
buf
, c⁄° *
fûe
, 
löe
);

151 *
gc_mÆloc_debug
 (
size_t
 
size
, 
boﬁ
 
˛ór
, 
gc_¨ía
 *
a
, c⁄° *
fûe
, 
löe
);

152 *
°rög_Æloc_debug
 (c⁄° *
°r
, 
gc_¨ía
 *
gc
, c⁄° *
fûe
, 
löe
);

153 
buf„r
 
°rög_Æloc_buf_debug
 (c⁄° *
°r
, 
gc_¨ía
 *
gc
, c⁄° *
fûe
, 
löe
);

157 
buf„r
 
Æloc_buf
 (
size_t
 
size
);

158 
buf„r
 
Æloc_buf_gc
 (
size_t
 
size
, 
gc_¨ía
 *
gc
);

159 
buf„r
 
˛⁄e_buf
 (c⁄° buf„r* 
buf
);

160 *
gc_mÆloc
 (
size_t
 
size
, 
boﬁ
 
˛ór
, 
gc_¨ía
 *
a
);

161 *
°rög_Æloc
 (c⁄° *
°r
, 
gc_¨ía
 *
gc
);

162 
buf„r
 
°rög_Æloc_buf
 (c⁄° *
°r
, 
gc_¨ía
 *
gc
);

166 #ifde‡
BUF_INIT_TRACKING


167 
	#buf_öô
(
buf
, 
off£t
Ë
	`buf_öô_debug
 (buf, off£t, 
__FILE__
, 
__LINE__
)

	)

168 
boﬁ
 
buf_öô_debug
 (
buf„r
 *
buf
, 
off£t
, c⁄° *
fûe
, 
löe
);

170 
	#buf_öô
(
buf
, 
off£t
Ë
	`buf_öô_dow‹k
 (buf, off£t)

	)

176 
ölöe
 
boﬁ


177 
	$buf_deföed
 (c⁄° 
buf„r
 *
buf
)

179  
buf
->
d©a
 !
NULL
;

180 
	}
}

182 
ölöe
 
boﬁ


183 
	$buf_vÆid
 (c⁄° 
buf„r
 *
buf
)

185  
	`likñy
 (
buf
->
d©a
 !
NULL
Ë&&Üikñy (buf->
Àn
 >= 0);

186 
	}
}

188 
ölöe
 
uöt8_t
 *

189 
	$buf_b±r
 (c⁄° 
buf„r
 *
buf
)

191 i‡(
	`buf_vÆid
 (
buf
))

192  
buf
->
d©a
 + buf->
off£t
;

194  
NULL
;

195 
	}
}

198 
	$buf_Àn
 (c⁄° 
buf„r
 *
buf
)

200 i‡(
	`buf_vÆid
 (
buf
))

201  
buf
->
Àn
;

204 
	}
}

206 
ölöe
 
uöt8_t
 *

207 
	$buf_bíd
 (c⁄° 
buf„r
 *
buf
)

209  
	`buf_b±r
 (
buf
Ë+ 
	`buf_Àn
 (buf);

210 
	}
}

212 
ölöe
 
uöt8_t
 *

213 
	$buf_bœ°
 (c⁄° 
buf„r
 *
buf
)

215 i‡(
	`buf_Àn
 (
buf
) > 0)

216  
	`buf_b±r
 (
buf
Ë+ 
	`buf_Àn
 (buf) - 1;

218  
NULL
;

219 
	}
}

221 
ölöe
 
boﬁ


222 
	$buf_size_vÆid
 (c⁄° 
size_t
 
size
)

224  
	`likñy
 (
size
 < 
BUF_SIZE_MAX
);

225 
	}
}

227 
ölöe
 
boﬁ


228 
	$buf_size_vÆid_sig√d
 (c⁄° 
size
)

230  
	`likñy
 (
size
 >-
BUF_SIZE_MAX
) &&Üikely (size < BUF_SIZE_MAX);

231 
	}
}

233 
ölöe
 *

234 
	$buf_°r
 (c⁄° 
buf„r
 *
buf
)

236  (*)
	`buf_b±r
(
buf
);

237 
	}
}

239 
ölöe
 

240 
	$buf_ª£t
 (
buf„r
 *
buf
)

242 
buf
->
ˇ∑côy
 = 0;

243 
buf
->
off£t
 = 0;

244 
buf
->
Àn
 = 0;

245 
buf
->
d©a
 = 
NULL
;

246 
	}
}

248 
ölöe
 

249 
	$buf_ª£t_Àn
 (
buf„r
 *
buf
)

251 
buf
->
Àn
 = 0;

252 
buf
->
off£t
 = 0;

253 
	}
}

255 
ölöe
 
boﬁ


256 
	$buf_öô_dow‹k
 (
buf„r
 *
buf
, 
off£t
)

258 i‡(
off£t
 < 0 || off£à> 
buf
->
ˇ∑côy
 || buf->
d©a
 =
NULL
)

259  
Ál£
;

260 
buf
->
Àn
 = 0;

261 
buf
->
off£t
 = offset;

262  
åue
;

263 
	}
}

265 
ölöe
 

266 
	$buf_£t_wrôe
 (
buf„r
 *
buf
, 
uöt8_t
 *
d©a
, 
size
)

268 i‡(!
	`buf_size_vÆid
 (
size
))

269 
	`buf_size_îr‹
 (
size
);

270 
buf
->
Àn
 = 0;

271 
buf
->
off£t
 = 0;

272 
buf
->
ˇ∑côy
 = 
size
;

273 
buf
->
d©a
 = data;

274 i‡(
size
 > 0 && 
d©a
)

275 *
d©a
 = 0;

276 
	}
}

278 
ölöe
 

279 
	$buf_£t_ªad
 (
buf„r
 *
buf
, c⁄° 
uöt8_t
 *
d©a
, 
size
)

281 i‡(!
	`buf_size_vÆid
 (
size
))

282 
	`buf_size_îr‹
 (
size
);

283 
buf
->
Àn
 = buf->
ˇ∑côy
 = 
size
;

284 
buf
->
off£t
 = 0;

285 
buf
->
d©a
 = (
uöt8_t
 *)data;

286 
	}
}

289 
ölöe
 

290 
	$°∫˝y¡
 (*
de°
, c⁄° *
§c
, 
size_t
 
maxÀn
)

292 
	`°∫˝y
 (
de°
, 
§c
, 
maxÀn
);

293 i‡(
maxÀn
 > 0)

294 
de°
[
maxÀn
 - 1] = 0;

295 
	}
}

298 
ölöe
 
boﬁ


299 
	$has_digô
 (c⁄° * 
§c
)

301 
c
;

302 (
c
 = *
§c
++))

304 i‡(
	`isdigô
(
c
))

305  
åue
;

307  
Ál£
;

308 
	}
}

313 
boﬁ
 
	$buf_¥ötf
 (
buf„r
 *
buf
, c⁄° *
f‹m©
, ...)

314 #ifde‡
__GNUC__


315 #i‡
__USE_MINGW_ANSI_STDIO


316 
	`__©åibuã__
 ((
	$f‹m©
 (
gnu_¥ötf
, 2, 3)))

318 
	`__©åibuã__
 ((
	$f‹m©
 (
__¥ötf__
, 2, 3)))

326 
boﬁ
 
	`buf_puts
 (
buf„r
 *
buf
, c⁄° *
°r
);

331 
boﬁ
 
	$›ív≤_¢¥ötf
(*
°r
, 
size_t
 
size
, c⁄° *
f‹m©
, ...)

332 #ifde‡
__GNUC__


333 #i‡
__USE_MINGW_ANSI_STDIO


334 
	`__©åibuã__
 ((
	$f‹m©
 (
gnu_¥ötf
, 3, 4)))

336 
	`__©åibuã__
 ((
	$f‹m©
 (
__¥ötf__
, 3, 4)))

345 
	`buf_nuŒ_ãrmö©e
 (
buf„r
 *
buf
);

346 
	`buf_chomp
 (
buf„r
 *
buf
);

347 
	`buf_rmèû
 (
buf„r
 *
buf
, 
uöt8_t
 
ªmove
);

352 
	`chomp
 (*
°r
);

353 
	`rm_åaûög_ch¨s
 (*
°r
, c⁄° *
wh©_to_dñëe
);

354 c⁄° *
	`skù_Àadög_whôe•a˚
 (c⁄° *
°r
);

355 
	`°rög_nuŒ_ãrmö©e
 (*
°r
, 
Àn
, 
ˇ∑côy
);

361 
	`buf_wrôe_°rög_fûe
 (c⁄° 
buf„r
 *
buf
, c⁄° *
fûíame
, 
fd
);

367 
	`buf_ˇåunc
 (
buf„r
 *
buf
, c⁄° *
°r
);

372 
	`c⁄vît_to_⁄e_löe
 (
buf„r
 *
buf
);

377 
boﬁ
 
	`buf_∑r£
 (
buf„r
 *
buf
, c⁄° 
dñim
, *
löe
, c⁄° 
size
);

383 
	`f‹m©_hex_ex
 (c⁄° 
uöt8_t
 *
d©a
, 
size
, 
maxouçut
,

384 
•a˚_bªak
, c⁄° * 
£∑øt‹
,

385 
gc_¨ía
 *
gc
);

387 
ölöe
 *

388 
	$f‹m©_hex
 (c⁄° 
uöt8_t
 *
d©a
, 
size
, 
maxouçut
, 
gc_¨ía
 *
gc
)

390  
	`f‹m©_hex_ex
 (
d©a
, 
size
, 
maxouçut
, 4, " ", 
gc
);

391 
	}
}

396 
buf„r
 
buf_sub
 (buf„∏*
buf
, 
size
, 
boﬁ
 
¥ïíd
);

402 
ölöe
 
boﬁ


403 
	$buf_ß„
 (c⁄° 
buf„r
 *
buf
, 
Àn
)

405  
	`buf_vÆid
 (
buf
Ë&& 
	`buf_size_vÆid
 (
Àn
)

406 && 
buf
->
off£t
 + buf->
Àn
 +Üí <buf->
ˇ∑côy
;

407 
	}
}

409 
ölöe
 
boﬁ


410 
	$buf_ß„_bidú
 (c⁄° 
buf„r
 *
buf
, 
Àn
)

412 i‡(
	`buf_vÆid
 (
buf
Ë&& 
	`buf_size_vÆid_sig√d
 (
Àn
))

414 c⁄° 
√wÀn
 = 
buf
->
Àn
 +Üen;

415  
√wÀn
 >0 && 
buf
->
off£t
 +ÇewÀ¿<buf->
ˇ∑côy
;

418  
Ál£
;

419 
	}
}

421 
ölöe
 

422 
	$buf_f‹w¨d_ˇ∑côy
 (c⁄° 
buf„r
 *
buf
)

424 i‡(
	`buf_vÆid
 (
buf
))

426 
ªt
 = 
buf
->
ˇ∑côy
 - (buf->
off£t
 + buf->
Àn
);

427 i‡(
ªt
 < 0)

428 
ªt
 = 0;

429  
ªt
;

433 
	}
}

435 
ölöe
 

436 
	$buf_f‹w¨d_ˇ∑côy_tŸÆ
 (c⁄° 
buf„r
 *
buf
)

438 i‡(
	`buf_vÆid
 (
buf
))

440 
ªt
 = 
buf
->
ˇ∑côy
 - buf->
off£t
;

441 i‡(
ªt
 < 0)

442 
ªt
 = 0;

443  
ªt
;

447 
	}
}

449 
ölöe
 

450 
	$buf_ªvî£_ˇ∑côy
 (c⁄° 
buf„r
 *
buf
)

452 i‡(
	`buf_vÆid
 (
buf
))

453  
buf
->
off£t
;

456 
	}
}

458 
ölöe
 
boﬁ


459 
	$buf_öc_Àn
 (
buf„r
 *
buf
, 
öc
)

461 i‡(!
	`buf_ß„_bidú
 (
buf
, 
öc
))

462  
Ál£
;

463 
buf
->
Àn
 +
öc
;

464  
åue
;

465 
	}
}

472 
ölöe
 
uöt8_t
 *

473 
	$buf_¥ïíd
 (
buf„r
 *
buf
, 
size
)

475 i‡(!
	`buf_vÆid
 (
buf
Ë|| 
size
 < 0 || sizê> buf->
off£t
)

476  
NULL
;

477 
buf
->
off£t
 -
size
;

478 
buf
->
Àn
 +
size
;

479  
	`BPTR
 (
buf
);

480 
	}
}

482 
ölöe
 
boﬁ


483 
	$buf_adv™˚
 (
buf„r
 *
buf
, 
size
)

485 i‡(!
	`buf_vÆid
 (
buf
Ë|| 
size
 < 0 || buf->
Àn
 < size)

486  
Ál£
;

487 
buf
->
off£t
 +
size
;

488 
buf
->
Àn
 -
size
;

489  
åue
;

490 
	}
}

497 
ölöe
 
uöt8_t
 *

498 
	$buf_wrôe_Æloc
 (
buf„r
 *
buf
, 
size
)

500 
uöt8_t
 *
ªt
;

501 i‡(!
	`buf_ß„
 (
buf
, 
size
))

502  
NULL
;

503 
ªt
 = 
	`BPTR
 (
buf
Ë+ buf->
Àn
;

504 
buf
->
Àn
 +
size
;

505  
ªt
;

506 
	}
}

508 
ölöe
 
uöt8_t
 *

509 
	$buf_wrôe_Æloc_¥ïíd
 (
buf„r
 *
buf
, 
size
, 
boﬁ
 
¥ïíd
)

511  
¥ïíd
 ? 
	`buf_¥ïíd
 (
buf
, 
size
Ë: 
	`buf_wrôe_Æloc
 (buf, size);

512 
	}
}

514 
ölöe
 
uöt8_t
 *

515 
	$buf_ªad_Æloc
 (
buf„r
 *
buf
, 
size
)

517 
uöt8_t
 *
ªt
;

518 i‡(
size
 < 0 || 
buf
->
Àn
 < size)

519  
NULL
;

520 
ªt
 = 
	`BPTR
 (
buf
);

521 
buf
->
off£t
 +
size
;

522 
buf
->
Àn
 -
size
;

523  
ªt
;

524 
	}
}

526 
ölöe
 
boﬁ


527 
	$buf_wrôe
 (
buf„r
 *
de°
, c⁄° *
§c
, 
size
)

529 
uöt8_t
 *
˝
 = 
	`buf_wrôe_Æloc
 (
de°
, 
size
);

530 i‡(!
˝
)

531  
Ál£
;

532 
	`mem˝y
 (
˝
, 
§c
, 
size
);

533  
åue
;

534 
	}
}

536 
ölöe
 
boﬁ


537 
	$buf_wrôe_¥ïíd
 (
buf„r
 *
de°
, c⁄° *
§c
, 
size
)

539 
uöt8_t
 *
˝
 = 
	`buf_¥ïíd
 (
de°
, 
size
);

540 i‡(!
˝
)

541  
Ál£
;

542 
	`mem˝y
 (
˝
, 
§c
, 
size
);

543  
åue
;

544 
	}
}

546 
ölöe
 
boﬁ


547 
	$buf_wrôe_u8
 (
buf„r
 *
de°
, 
d©a
)

549 
uöt8_t
 
u8
 = (uöt8_tË
d©a
;

550  
	`buf_wrôe
 (
de°
, &
u8
,  (
uöt8_t
));

551 
	}
}

553 
ölöe
 
boﬁ


554 
	$buf_wrôe_u16
 (
buf„r
 *
de°
, 
d©a
)

556 
uöt16_t
 
u16
 = 
	`ht⁄s
 ((uöt16_tË
d©a
);

557  
	`buf_wrôe
 (
de°
, &
u16
,  (
uöt16_t
));

558 
	}
}

560 
ölöe
 
boﬁ


561 
	$buf_wrôe_u32
 (
buf„r
 *
de°
, 
d©a
)

563 
uöt32_t
 
u32
 = 
	`ht⁄l
 ((uöt32_tË
d©a
);

564  
	`buf_wrôe
 (
de°
, &
u32
,  (
uöt32_t
));

565 
	}
}

567 
ölöe
 
boﬁ


568 
	$buf_c›y
 (
buf„r
 *
de°
, c⁄° buf„∏*
§c
)

570  
	`buf_wrôe
 (
de°
, 
	`BPTR
 (
§c
), 
	`BLEN
 (src));

571 
	}
}

573 
ölöe
 
boﬁ


574 
	$buf_c›y_n
 (
buf„r
 *
de°
, buf„∏*
§c
, 
n
)

576 
uöt8_t
 *
˝
 = 
	`buf_ªad_Æloc
 (
§c
, 
n
);

577 i‡(!
˝
)

578  
Ál£
;

579  
	`buf_wrôe
 (
de°
, 
˝
, 
n
);

580 
	}
}

582 
ölöe
 
boﬁ


583 
	$buf_c›y_ønge
 (
buf„r
 *
de°
,

584 
de°_ödex
,

585 c⁄° 
buf„r
 *
§c
,

586 
§c_ödex
,

587 
§c_Àn
)

589 i‡(
§c_ödex
 < 0

590 || 
§c_Àn
 < 0

591 || 
§c_ödex
 + 
§c_Àn
 > 
§c
->
Àn


592 || 
de°_ödex
 < 0

593 || 
de°
->
off£t
 + 
de°_ödex
 + 
§c_Àn
 > de°->
ˇ∑côy
)

594  
Ál£
;

595 
	`mem˝y
 (
de°
->
d©a
 + de°->
off£t
 + 
de°_ödex
, 
§c
->d©®+ src->off£à+ 
§c_ödex
, 
§c_Àn
);

596 i‡(
de°_ödex
 + 
§c_Àn
 > 
de°
->
Àn
)

597 
de°
->
Àn
 = 
de°_ödex
 + 
§c_Àn
;

598  
åue
;

599 
	}
}

602 
ölöe
 
boﬁ


603 
	$buf_c›y_ex˚ss
 (
buf„r
 *
de°
,

604 
buf„r
 *
§c
,

605 
Àn
)

607 i‡(
Àn
 < 0)

608  
Ál£
;

609 i‡(
§c
->
Àn
 >Üen)

611 
buf„r
 
b
 = *
§c
;

612 
§c
->
Àn
 =Üen;

613 i‡(!
	`buf_adv™˚
 (&
b
, 
Àn
))

614  
Ál£
;

615  
	`buf_c›y
 (
de°
, &
b
);

619  
åue
;

621 
	}
}

623 
ölöe
 
boﬁ


624 
	$buf_ªad
 (
buf„r
 *
§c
, *
de°
, 
size
)

626 
uöt8_t
 *
˝
 = 
	`buf_ªad_Æloc
 (
§c
, 
size
);

627 i‡(!
˝
)

628  
Ál£
;

629 
	`mem˝y
 (
de°
, 
˝
, 
size
);

630  
åue
;

631 
	}
}

633 
ölöe
 

634 
	$buf_ªad_u8
 (
buf„r
 *
buf
)

636 
ªt
;

637 i‡(
	`BLEN
 (
buf
) < 1)

639 
ªt
 = *
	`BPTR
(
buf
);

640 
	`buf_adv™˚
 (
buf
, 1);

641  
ªt
;

642 
	}
}

644 
ölöe
 

645 
	$buf_ªad_u16
 (
buf„r
 *
buf
)

647 
uöt16_t
 
ªt
;

648 i‡(!
	`buf_ªad
 (
buf
, &
ªt
,  (
uöt16_t
)))

650  
	`¡ohs
 (
ªt
);

651 
	}
}

653 
ölöe
 
uöt32_t


654 
	$buf_ªad_u32
 (
buf„r
 *
buf
, 
boﬁ
 *
good
)

656 
uöt32_t
 
ªt
;

657 i‡(!
	`buf_ªad
 (
buf
, &
ªt
,  (
uöt32_t
)))

659 i‡(
good
)

660 *
good
 = 
Ál£
;

665 i‡(
good
)

666 *
good
 = 
åue
;

667  
	`¡ohl
 (
ªt
);

669 
	}
}

675 
ölöe
 
boﬁ


676 
	$buf_°rög_m©ch
 (c⁄° 
buf„r
 *
§c
, c⁄° *
m©ch
, 
size
)

678 i‡(
size
 !
§c
->
Àn
)

679  
Ál£
;

680  
	`memcmp
 (
	`BPTR
 (
§c
), 
m©ch
, 
size
) == 0;

681 
	}
}

687 
ölöe
 
boﬁ


688 
	$buf_°rög_m©ch_hód
 (c⁄° 
buf„r
 *
§c
, c⁄° *
m©ch
, 
size
)

690 i‡(
size
 < 0 || sizê> 
§c
->
Àn
)

691  
Ál£
;

692  
	`memcmp
 (
	`BPTR
 (
§c
), 
m©ch
, 
size
) == 0;

693 
	}
}

695 
boﬁ
 
buf_°rög_m©ch_hód_°r
 (c⁄° 
buf„r
 *
§c
, c⁄° *
m©ch
);

696 
boﬁ
 
buf_°rög_com∑ª_adv™˚
 (
buf„r
 *
§c
, c⁄° *
m©ch
);

697 
buf_sub°rög_Àn
 (c⁄° 
buf„r
 *
buf
, 
dñim
);

702 c⁄° *
≈
 (c⁄° *
°r
);

708 
	#CC_ANY
 (1<<0)

	)

709 
	#CC_NULL
 (1<<1)

	)

711 
	#CC_ALNUM
 (1<<2)

	)

712 
	#CC_ALPHA
 (1<<3)

	)

713 
	#CC_ASCII
 (1<<4)

	)

714 
	#CC_CNTRL
 (1<<5)

	)

715 
	#CC_DIGIT
 (1<<6)

	)

716 
	#CC_PRINT
 (1<<7)

	)

717 
	#CC_PUNCT
 (1<<8)

	)

718 
	#CC_SPACE
 (1<<9)

	)

719 
	#CC_XDIGIT
 (1<<10)

	)

721 
	#CC_BLANK
 (1<<11)

	)

722 
	#CC_NEWLINE
 (1<<12)

	)

723 
	#CC_CR
 (1<<13)

	)

725 
	#CC_BACKSLASH
 (1<<14)

	)

726 
	#CC_UNDERBAR
 (1<<15)

	)

727 
	#CC_DASH
 (1<<16)

	)

728 
	#CC_DOT
 (1<<17)

	)

729 
	#CC_COMMA
 (1<<18)

	)

730 
	#CC_COLON
 (1<<19)

	)

731 
	#CC_SLASH
 (1<<20)

	)

732 
	#CC_SINGLE_QUOTE
 (1<<21)

	)

733 
	#CC_DOUBLE_QUOTE
 (1<<22)

	)

734 
	#CC_REVERSE_QUOTE
 (1<<23)

	)

735 
	#CC_AT
 (1<<24)

	)

736 
	#CC_EQUAL
 (1<<25)

	)

737 
	#CC_LESS_THAN
 (1<<26)

	)

738 
	#CC_GREATER_THAN
 (1<<27)

	)

739 
	#CC_PIPE
 (1<<28)

	)

740 
	#CC_QUESTION_MARK
 (1<<29)

	)

741 
	#CC_ASTERISK
 (1<<30)

	)

744 
	#CC_NAME
 (
CC_ALNUM
|
CC_UNDERBAR
)

	)

745 
	#CC_CRLF
 (
CC_CR
|
CC_NEWLINE
)

	)

747 
boﬁ
 
ch¨_˛ass
 (c⁄° 
c
, c⁄° 
Êags
);

748 
boﬁ
 
°rög_˛ass
 (c⁄° *
°r
, c⁄° 
ö˛usive
, c⁄° 
ex˛usive
);

749 
boﬁ
 
°rög_mod
 (*
°r
, c⁄° 
ö˛usive
, c⁄° 
ex˛usive
, c⁄° 
ª∂a˚
);

751 c⁄° *
°rög_mod_c⁄°
 (c⁄° *
°r
,

752 c⁄° 
ö˛usive
,

753 c⁄° 
ex˛usive
,

754 c⁄° 
ª∂a˚
,

755 
gc_¨ía
 *
gc
);

757 
°rög_ª∂a˚_Àadög
 (*
°r
, c⁄° 
m©ch
, c⁄° 
ª∂a˚
);

759 #ifde‡
CHARACTER_CLASS_DEBUG


760 
ch¨a˘î_˛ass_debug
 ();

766 #ifde‡
VERIFY_ALIGNMENT


767 
vÆign4
 (c⁄° 
buf„r
 *
buf
, c⁄° *
fûe
, c⁄° 
löe
);

768 
	#vîify_Æign_4
(
±r
Ë
	`vÆign4
(
buf
, 
__FILE__
, 
__LINE__
)

	)

770 
	#vîify_Æign_4
(
±r
)

	)

778 
gc_å™s„r
 (
gc_¨ía
 *
de°
, gc_¨í®*
§c
);

780 
x_gc_‰ì
 (
gc_¨ía
 *
a
);

782 
ölöe
 
boﬁ


783 
	$gc_deföed
 (
gc_¨ía
 *
a
)

785  
a
->
li°
 !
NULL
;

786 
	}
}

788 
ölöe
 

789 
	$gc_öô
 (
gc_¨ía
 *
a
)

791 
a
->
li°
 = 
NULL
;

792 
	}
}

794 
ölöe
 

795 
	$gc_dëach
 (
gc_¨ía
 *
a
)

797 
	`gc_öô
 (
a
);

798 
	}
}

800 
ölöe
 
gc_¨ía


801 
	$gc_√w
 ()

803 
gc_¨ía
 
ªt
;

804 
ªt
.
li°
 = 
NULL
;

805  
ªt
;

806 
	}
}

808 
ölöe
 

809 
	$gc_‰ì
 (
gc_¨ía
 *
a
)

811 i‡(
a
->
li°
)

812 
	`x_gc_‰ì
 (
a
);

813 
	}
}

815 
ölöe
 

816 
	$gc_ª£t
 (
gc_¨ía
 *
a
)

818 
	`gc_‰ì
 (
a
);

819 
	}
}

825 
	#ALLOC_OBJ
(
d±r
, 
ty≥
) \

827 
	`check_mÆloc_ªtu∫
 ((
d±r
Ë(
ty≥
 *Ë
	`mÆloc
 ( (type))); \

828 }

	)

830 
	#ALLOC_OBJ_CLEAR
(
d±r
, 
ty≥
) \

832 
	`ALLOC_OBJ
 (
d±r
, 
ty≥
); \

833 
	`mem£t
 ((
d±r
), 0, (
ty≥
)); \

834 }

	)

836 
	#ALLOC_ARRAY
(
d±r
, 
ty≥
, 
n
) \

838 
	`check_mÆloc_ªtu∫
 ((
d±r
Ë(
ty≥
 *Ë
	`mÆloc
 (
	`¨øy_mu…_ß„
 ( (ty≥), (
n
), 0))); \

839 }

	)

841 
	#ALLOC_ARRAY_GC
(
d±r
, 
ty≥
, 
n
, 
gc
) \

843 (
d±r
Ë(
ty≥
 *Ë
	`gc_mÆloc
 (
	`¨øy_mu…_ß„
 ( (ty≥), (
n
), 0), 
Ál£
, (
gc
)); \

844 }

	)

846 
	#ALLOC_ARRAY_CLEAR
(
d±r
, 
ty≥
, 
n
) \

848 
	`ALLOC_ARRAY
 (
d±r
, 
ty≥
, 
n
); \

849 
	`mem£t
 ((
d±r
), 0, (
	`¨øy_mu…_ß„
 ((
ty≥
), (
n
), 0))); \

850 }

	)

852 
	#ALLOC_ARRAY_CLEAR_GC
(
d±r
, 
ty≥
, 
n
, 
gc
) \

854 (
d±r
Ë(
ty≥
 *Ë
	`gc_mÆloc
 (
	`¨øy_mu…_ß„
 ( (ty≥), (
n
), 0), 
åue
, (
gc
)); \

855 }

	)

857 
	#ALLOC_VAR_ARRAY_CLEAR_GC
(
d±r
, 
ty≥
, 
©y≥
, 
n
, 
gc
) \

859 (
d±r
Ë(
ty≥
 *Ë
	`gc_mÆloc
 (
	`¨øy_mu…_ß„
 ( (
©y≥
), (
n
),  (ty≥)), 
åue
, (
gc
)); \

860 }

	)

862 
	#ALLOC_OBJ_GC
(
d±r
, 
ty≥
, 
gc
) \

864 (
d±r
Ë(
ty≥
 *Ë
	`gc_mÆloc
 ( (ty≥), 
Ál£
, (
gc
)); \

865 }

	)

867 
	#ALLOC_OBJ_CLEAR_GC
(
d±r
, 
ty≥
, 
gc
) \

869 (
d±r
Ë(
ty≥
 *Ë
	`gc_mÆloc
 ( (ty≥), 
åue
, (
gc
)); \

870 }

	)

872 
ölöe
 

873 
	$check_mÆloc_ªtu∫
 (*
p
)

875 i‡(!
p
)

876 
	`out_of_mem‹y
 ();

877 
	}
}

883 #ifde‡
ENABLE_BUFFER_LIST


885 
	sbuf„r_íåy


887 
buf„r
 
	mbuf
;

888 
buf„r_íåy
 *
	m√xt
;

891 
	sbuf„r_li°


893 
buf„r_íåy
 *
	mhód
;

894 
buf„r_íåy
 *
	mèû
;

895 
	msize
;

896 
	mmax_size
;

899 
buf„r_li°
 *
buf„r_li°_√w
 (c⁄° 
max_size
);

900 
buf„r_li°_‰ì
 (
buf„r_li°
 *
ﬁ
);

902 
boﬁ
 
buf„r_li°_deföed
 (c⁄° 
buf„r_li°
 *
ﬁ
);

903 
buf„r_li°_ª£t
 (
buf„r_li°
 *
ﬁ
);

905 
buf„r_li°_push
 (
buf„r_li°
 *
ﬁ
, c⁄° *
°r
);

906 
buf„r_íåy
 *
buf„r_li°_push_d©a
 (
buf„r_li°
 *
ﬁ
, c⁄° 
uöt8_t
 *
d©a
, 
size_t
 
size
);

907 
buf„r
 *
buf„r_li°_≥ek
 (
buf„r_li°
 *
ﬁ
);

908 
buf„r_li°_adv™˚
 (
buf„r_li°
 *
ﬁ
, 
n
);

909 
buf„r_li°_p›
 (
buf„r_li°
 *
ﬁ
);

911 
buf„r_li°_aggªg©e
 (
buf„r_li°
 *
bl
, c⁄° 
size_t
 
max
);

913 
buf„r_li°
 *
buf„r_li°_fûe
 (c⁄° *
‚
, 
max_löe_Àn
);

	@src/openvpn/circ_list.h

25 #i‚de‡
CIRC_LIST_H


26 
	#CIRC_LIST_H


	)

28 
	~"basic.h
"

29 
	~"öãgî.h
"

30 
	~"îr‹.h
"

32 
	#CIRC_LIST
(
«me
, 
ty≥
) \

33 
	s«me
 { \

34 
x_hód
; \

35 
x_size
; \

36 
x_ˇp
; \

37 
x_sizeof
; \

38 
ty≥
 
x_li°
[
EMPTY_ARRAY_SIZE
]; \

39 }

	)

41 
	#CIRC_LIST_PUSH
(
obj
, 
ôem
) \

43 (
obj
)->
x_hód
 = 
	`modulo_add
 ((obj)->x_hód, -1, (obj)->
x_ˇp
); \

44 (
obj
)->
x_li°
[(obj)->
x_hód
] = (
ôem
); \

45 (
obj
)->
x_size
 = 
	`mö_öt
 ((obj)->x_sizê+ 1, (obj)->
x_ˇp
); \

46 }

	)

48 
	#CIRC_LIST_SIZE
(
obj
) \

49 ((
obj
)->
x_size
)

	)

51 
	#CIRC_LIST_INDEX
(
obj
, 
ödex
) \

52 
	`modulo_add
 ((
obj
)->
x_hód
, \

53 
	`ödex_vîify
 ((
ödex
), (
obj
)->
x_size
, 
__FILE__
, 
__LINE__
), \

54 (
obj
)->
x_ˇp
)

	)

56 
	#CIRC_LIST_ITEM
(
obj
, 
ödex
) \

57 ((
obj
)->
x_li°
[
	`CIRC_LIST_INDEX
((obj), (
ödex
))])

	)

59 
	#CIRC_LIST_RESET
(
obj
) \

61 (
obj
)->
x_hód
 = 0; \

62 (
obj
)->
x_size
 = 0; \

63 }

	)

65 
	#CIRC_LIST_ALLOC
(
de°
, 
li°_ty≥
, 
size
) \

67 c⁄° 
so
 =  (
li°_ty≥
Ë+  ((
de°
)->
x_li°
[0]Ë* (
size
); \

68 (
de°
Ë(
li°_ty≥
 *Ë
	`mÆloc
 (
so
); \

69 
	`check_mÆloc_ªtu∫
 (
de°
); \

70 
	`mem£t
 ((
de°
), 0, 
so
); \

71 (
de°
)->
x_ˇp
 = 
size
; \

72 (
de°
)->
x_sizeof
 = 
so
; \

73 }

	)

75 
	#CIRC_LIST_FREE
(
de°
) \

76 
	`‰ì
 (
de°
)

	)

	@src/openvpn/clinat.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #i‡
deföed
(
ENABLE_CLIENT_NAT
)

35 
	~"˛ö©.h
"

36 
	~"¥Ÿo.h
"

37 
	~"sockë.h
"

38 
	~"memdbg.h
"

40 
boﬁ


41 
	$add_íåy
(
˛õ¡_«t_›ti⁄_li°
 *
de°
,

42 c⁄° 
˛õ¡_«t_íåy
 *
e
)

44 i‡(
de°
->
n
 >
MAX_CLIENT_NAT
)

46 
	`msg
 (
M_WARN
, "WARNING: clõ¡-«àèbÀ ovîÊow (max %dÉ¡rõs)", 
MAX_CLIENT_NAT
);

47  
Ál£
;

51 
de°
->
íåõs
[de°->
n
++] = *
e
;

52  
åue
;

54 
	}
}

57 
	$¥öt_˛õ¡_«t_li°
(c⁄° 
˛õ¡_«t_›ti⁄_li°
 *
li°
, 
msgÀvñ
)

59 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

60 
i
;

62 
	`msg
 (
msgÀvñ
, "*** CNATÜist");

63 i‡(
li°
)

65 
i
 = 0; i < 
li°
->
n
; ++i)

67 c⁄° 
˛õ¡_«t_íåy
 *
e
 = &
li°
->
íåõs
[
i
];

68 
	`msg
 (
msgÀvñ
, " CNAT[%d]Å=%d %s/%s/%s",

69 
i
,

70 
e
->
ty≥
,

71 
	`¥öt_ö_addr_t
 (
e
->
√tw‹k
, 
IA_NET_ORDER
, &
gc
),

72 
	`¥öt_ö_addr_t
 (
e
->
√tmask
, 
IA_NET_ORDER
, &
gc
),

73 
	`¥öt_ö_addr_t
 (
e
->
f‹eign_√tw‹k
, 
IA_NET_ORDER
, &
gc
));

76 
	`gc_‰ì
 (&
gc
);

77 
	}
}

79 
˛õ¡_«t_›ti⁄_li°
 *

80 
	$√w_˛õ¡_«t_li°
 (
gc_¨ía
 *
gc
)

82 
˛õ¡_«t_›ti⁄_li°
 *
ªt
;

83 
	`ALLOC_OBJ_CLEAR_GC
 (
ªt
, 
˛õ¡_«t_›ti⁄_li°
, 
gc
);

84  
ªt
;

85 
	}
}

87 
˛õ¡_«t_›ti⁄_li°
 *

88 
	$˛⁄e_˛õ¡_«t_›ti⁄_li°
 (c⁄° 
˛õ¡_«t_›ti⁄_li°
 *
§c
, 
gc_¨ía
 *
gc
)

90 
˛õ¡_«t_›ti⁄_li°
 *
ªt
;

91 
	`ALLOC_OBJ_GC
 (
ªt
, 
˛õ¡_«t_›ti⁄_li°
, 
gc
);

92 *
ªt
 = *
§c
;

93  
ªt
;

94 
	}
}

97 
	$c›y_˛õ¡_«t_›ti⁄_li°
 (
˛õ¡_«t_›ti⁄_li°
 *
de°
,

98 c⁄° 
˛õ¡_«t_›ti⁄_li°
 *
§c
)

100 
i
;

101 
i
 = 0; i < 
§c
->
n
; ++i)

103 i‡(!
	`add_íåy
(
de°
, &
§c
->
íåõs
[
i
]))

106 
	}
}

109 
	$add_˛õ¡_«t_to_›ti⁄_li°
 (
˛õ¡_«t_›ti⁄_li°
 *
de°
,

110 c⁄° *
ty≥
,

111 c⁄° *
√tw‹k
,

112 c⁄° *
√tmask
,

113 c⁄° *
f‹eign_√tw‹k
,

114 
msgÀvñ
)

116 
˛õ¡_«t_íåy
 
e
;

117 
boﬁ
 
ok
;

119 i‡(!
	`°rcmp
(
ty≥
, "snat"))

120 
e
.
ty≥
 = 
CN_SNAT
;

121 i‡(!
	`°rcmp
(
ty≥
, "dnat"))

122 
e
.
ty≥
 = 
CN_DNAT
;

125 
	`msg
(
msgÀvñ
, "client-nat:Åype must be 'snat' or 'dnat'");

129 
e
.
√tw‹k
 = 
	`gëaddr
(0,Çëw‹k, 0, &
ok
, 
NULL
);

130 i‡(!
ok
)

132 
	`msg
(
msgÀvñ
, "˛õ¡-«t: badÇëw‹k: %s", 
√tw‹k
);

135 
e
.
√tmask
 = 
	`gëaddr
(0,Çëmask, 0, &
ok
, 
NULL
);

136 i‡(!
ok
)

138 
	`msg
(
msgÀvñ
, "˛õ¡-«t: badÇëmask: %s", 
√tmask
);

141 
e
.
f‹eign_√tw‹k
 = 
	`gëaddr
(0, f‹eign_√tw‹k, 0, &
ok
, 
NULL
);

142 i‡(!
ok
)

144 
	`msg
(
msgÀvñ
, "˛õ¡-«t: bad f‹eig¿√tw‹k: %s", 
f‹eign_√tw‹k
);

148 
	`add_íåy
(
de°
, &
e
);

149 
	}
}

153 
	$¥öt_checksum
 (
›ív≤_ùhdr
 *
ùh
, c⁄° *
¥efix
)

155 
uöt16_t
 *
•å
;

156 
sum
 = 0;

157 
i
 = 0;

158 
•å
 = (
uöt16_t
 *)
ùh
; (
uöt8_t
 *)•å < (uöt8_à*)ùh + (
›ív≤_ùhdr
); sptr++)

160 
i
 += 1;

161 
sum
 +*
•å
;

163 
	`msg
 (
M_INFO
, "** CKSUM[%d] %†%08x", 
i
, 
¥efix
, 
sum
);

164 
	}
}

168 
	$¥öt_pkt
 (
›ív≤_ùhdr
 *
ùh
, c⁄° *
¥efix
, c⁄° 
dúe˘i⁄
, c⁄° 
msgÀvñ
)

170 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

172 *
dú°r
 = "???";

173 i‡(
dúe˘i⁄
 =
CN_OUTGOING
)

174 
dú°r
 = "OUT";

175 i‡(
dúe˘i⁄
 =
CN_INCOMING
)

176 
dú°r
 = "IN";

178 
	`msg
(
msgÀvñ
, "** CNAT %s %s %s -> %s",

179 
dú°r
,

180 
¥efix
,

181 
	`¥öt_ö_addr_t
 (
ùh
->
ßddr
, 
IA_NET_ORDER
, &
gc
),

182 
	`¥öt_ö_addr_t
 (
ùh
->
daddr
, 
IA_NET_ORDER
, &
gc
));

184 
	`gc_‰ì
 (&
gc
);

185 
	}
}

188 
	$˛õ¡_«t_å™sf‹m
 (c⁄° 
˛õ¡_«t_›ti⁄_li°
 *
li°
,

189 
buf„r
 *
ùbuf
,

190 c⁄° 
dúe˘i⁄
)

192 
ù_t˝_udp_hdr
 *
h
 = (ù_t˝_udp_hd∏*Ë
	`BPTR
 (
ùbuf
);

193 
i
;

194 
uöt32_t
 
addr
, *
addr_±r
;

195 c⁄° 
uöt32_t
 *
‰om
, *
to
;

196 
accumuœã
 = 0;

197 
amask
;

198 
Æog
 = 0;

200 i‡(
	`check_debug_Àvñ
 (
D_CLIENT_NAT
))

201 
	`¥öt_pkt
 (&
h
->
ù
, "BEFORE", 
dúe˘i⁄
, 
D_CLIENT_NAT
);

203 
i
 = 0; i < 
li°
->
n
; ++i)

205 c⁄° 
˛õ¡_«t_íåy
 *
e
 = &
li°
->
íåõs
[
i
];

206 i‡(
e
->
ty≥
 ^ 
dúe˘i⁄
)

208 
addr
 = *(
addr_±r
 = &
h
->
ù
.
daddr
);

209 
amask
 = 2;

213 
addr
 = *(
addr_±r
 = &
h
->
ù
.
ßddr
);

214 
amask
 = 1;

216 i‡(
dúe˘i⁄
)

218 
‰om
 = &
e
->
f‹eign_√tw‹k
;

219 
to
 = &
e
->
√tw‹k
;

223 
‰om
 = &
e
->
√tw‹k
;

224 
to
 = &
e
->
f‹eign_√tw‹k
;

227 i‡(((
addr
 & 
e
->
√tmask
Ë=*
‰om
Ë&& !(
amask
 & 
Æog
))

230 
	`ADD_CHECKSUM_32
(
accumuœã
, 
addr
);

233 
addr
 = (add∏& ~
e
->
√tmask
Ë| *
to
;

236 
	`SUB_CHECKSUM_32
(
accumuœã
, 
addr
);

239 *
addr_±r
 = 
addr
;

242 
Æog
 |
amask
;

245 i‡(
Æog
)

247 i‡(
	`check_debug_Àvñ
 (
D_CLIENT_NAT
))

248 
	`¥öt_pkt
 (&
h
->
ù
, "AFTER", 
dúe˘i⁄
, 
D_CLIENT_NAT
);

250 
	`ADJUST_CHECKSUM
(
accumuœã
, 
h
->
ù
.
check
);

252 i‡(
h
->
ù
.
¥Ÿocﬁ
 =
OPENVPN_IPPROTO_TCP
)

254 i‡(
	`BLEN
(
ùbuf
Ë>(
›ív≤_ùhdr
Ë+ (
›ív≤_t˝hdr
))

256 
	`ADJUST_CHECKSUM
(
accumuœã
, 
h
->
u
.
t˝
.
check
);

259 i‡(
h
->
ù
.
¥Ÿocﬁ
 =
OPENVPN_IPPROTO_UDP
)

261 i‡(
	`BLEN
(
ùbuf
Ë>(
›ív≤_ùhdr
Ë+ (
›ív≤_udphdr
))

263 
	`ADJUST_CHECKSUM
(
accumuœã
, 
h
->
u
.
udp
.
check
);

267 
	}
}

	@src/openvpn/clinat.h

25 #i‡!
deföed
(
CLINAT_H
Ë&& deföed(
ENABLE_CLIENT_NAT
)

26 
	#CLINAT_H


	)

28 
	~"buf„r.h
"

30 
	#MAX_CLIENT_NAT
 64

	)

32 
	#CN_OUTGOING
 0

	)

33 
	#CN_INCOMING
 1

	)

35 
	s˛õ¡_«t_íåy
 {

36 
	#CN_SNAT
 0

	)

37 
	#CN_DNAT
 1

	)

38 
	mty≥
;

39 
ö_addr_t
 
	m√tw‹k
;

40 
ö_addr_t
 
	m√tmask
;

41 
ö_addr_t
 
	mf‹eign_√tw‹k
;

44 
	s˛õ¡_«t_›ti⁄_li°
 {

45 
	mn
;

46 
˛õ¡_«t_íåy
 
	míåõs
[
MAX_CLIENT_NAT
];

49 
˛õ¡_«t_›ti⁄_li°
 *
√w_˛õ¡_«t_li°
 (
gc_¨ía
 *
gc
);

50 
˛õ¡_«t_›ti⁄_li°
 *
˛⁄e_˛õ¡_«t_›ti⁄_li°
 (c⁄° ˛õ¡_«t_›ti⁄_li° *
§c
, 
gc_¨ía
 *
gc
);

51 
c›y_˛õ¡_«t_›ti⁄_li°
 (
˛õ¡_«t_›ti⁄_li°
 *
de°
, c⁄° ˛õ¡_«t_›ti⁄_li° *
§c
);

52 
¥öt_˛õ¡_«t_li°
(c⁄° 
˛õ¡_«t_›ti⁄_li°
 *
li°
, 
msgÀvñ
);

54 
add_˛õ¡_«t_to_›ti⁄_li°
 (
˛õ¡_«t_›ti⁄_li°
 *
de°
,

55 c⁄° *
ty≥
,

56 c⁄° *
√tw‹k
,

57 c⁄° *
√tmask
,

58 c⁄° *
f‹eign_√tw‹k
,

59 
msgÀvñ
);

61 
˛õ¡_«t_å™sf‹m
 (c⁄° 
˛õ¡_«t_›ti⁄_li°
 *
li°
,

62 
buf„r
 *
ùbuf
,

63 c⁄° 
dúe˘i⁄
);

	@src/openvpn/common.h

25 #i‚de‡
COMMON_H


26 
	#COMMON_H


	)

31 #ifde‡
USE_64_BIT_COUNTERS


32 
	tcou¡î_ty≥
;

33 #ifde‡
WIN32


34 
	#cou¡î_f‹m©
 "%I64u"

	)

36 
	#cou¡î_f‹m©
 "%Œu"

	)

39 
	tcou¡î_ty≥
;

40 
	#cou¡î_f‹m©
 "%u"

	)

46 
	töãrvÆ_t
;

51 
	#BIG_TIMEOUT
 (60*60*24*7Ë

	)

56 #ifde‡
_WIN64


57 
	#±r_f‹m©
 "0x%I64x"

	)

59 
	#±r_f‹m©
 "0x%08lx"

	)

61 
	#time_f‹m©
 "%lu"

	)

62 
	#‰agmít_hódî_f‹m©
 "0x%08x"

	)

66 
	ttime_ty≥
;

67 #ifde‡
_WIN64


68 
	t±r_ty≥
;

70 
	t±r_ty≥
;

74 
	#CCD_DEFAULT
 "DEFAULT"

	)

81 
	#TLS_CHANNEL_BUF_SIZE
 2048

	)

87 
	#PUSH_BUNDLE_SIZE
 1024

	)

92 
	#PUSH_REQUEST_INTERVAL
 5

	)

98 
	#INLINE_FILE_TAG
 "[[INLINE]]"

	)

103 
	#SCRIPT_SECURITY_WARNING
 "WARNING: Exã∫ÆÖrogøm mayÇŸ bêˇŒed u∆es†'--s¸ùt-£curôy 2' o∏highî i†íabÀd. Sì --hñ∞ãxà‹ m™Öagêf‹ dëaûed info."

	)

	@src/openvpn/console.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

32 
	~"c⁄sﬁe.h
"

33 
	~"îr‹.h
"

34 
	~"buf„r.h
"

35 
	~"misc.h
"

37 #ifde‡
ENABLE_SYSTEMD


38 
	~<sy°emd/sd-d´m⁄.h
>

41 #ifde‡
WIN32


43 
	~"wö32.h
"

52 
boﬁ


53 
	$gë_c⁄sﬁe_öput_wö32
 (c⁄° *
¥om±
, c⁄° 
boﬁ
 
echo
, *
öput
, c⁄° 
ˇ∑côy
)

55 
HANDLE
 
ö
 = 
INVALID_HANDLE_VALUE
;

56 
HANDLE
 
îr
 = 
INVALID_HANDLE_VALUE
;

57 
DWORD
 
Àn
 = 0;

59 
	`ASSERT
 (
¥om±
);

60 
	`ASSERT
 (
öput
);

61 
	`ASSERT
 (
ˇ∑côy
 > 0);

63 
öput
[0] = '\0';

65 
ö
 = 
	`GëStdH™dÀ
 (
STD_INPUT_HANDLE
);

66 
îr
 = 
	`gë_‹ig_°dîr
 ();

68 i‡(
ö
 !
INVALID_HANDLE_VALUE


69 && 
îr
 !
INVALID_HANDLE_VALUE


70 && !
	`wö32_£rvi˚_öãºu±
 (&
wö32_sig«l
)

71 && 
	`WrôeFûe
 (
îr
, 
¥om±
, 
	`°æí
 (¥om±), &
Àn
, 
NULL
))

73 
boﬁ
 
is_c⁄sﬁe
 = (
	`GëFûeTy≥
 (
ö
Ë=
FILE_TYPE_CHAR
);

74 
DWORD
 
Êags_ßve
 = 0;

75 
°©us
 = 0;

76 
WCHAR
 *
wöput
;

78 i‡(
is_c⁄sﬁe
)

80 i‡(
	`GëC⁄sﬁeMode
 (
ö
, &
Êags_ßve
))

82 
DWORD
 
Êags
 = 
ENABLE_LINE_INPUT
 | 
ENABLE_PROCESSED_INPUT
;

83 i‡(
echo
)

84 
Êags
 |
ENABLE_ECHO_INPUT
;

85 
	`SëC⁄sﬁeMode
 (
ö
, 
Êags
);

88 
is_c⁄sﬁe
 = 0;

91 i‡(
is_c⁄sﬁe
)

93 
wöput
 = 
	`mÆloc
 (
ˇ∑côy
 *  (
WCHAR
));

94 i‡(
wöput
 =
NULL
)

95  
Ál£
;

97 
°©us
 = 
	`RódC⁄sﬁeW
 (
ö
, 
wöput
, 
ˇ∑côy
, &
Àn
, 
NULL
);

98 
	`WideCh¨ToMu…iByã
 (
CP_UTF8
, 0, 
wöput
, 
Àn
, 
öput
, 
ˇ∑côy
, 
NULL
, NULL);

99 
	`‰ì
 (
wöput
);

102 
°©us
 = 
	`RódFûe
 (
ö
, 
öput
, 
ˇ∑côy
, &
Àn
, 
NULL
);

104 
	`°rög_nuŒ_ãrmö©e
 (
öput
, ()
Àn
, 
ˇ∑côy
);

105 
	`chomp
 (
öput
);

107 i‡(!
echo
)

108 
	`WrôeFûe
 (
îr
, "\r\n", 2, &
Àn
, 
NULL
);

109 i‡(
is_c⁄sﬁe
)

110 
	`SëC⁄sﬁeMode
 (
ö
, 
Êags_ßve
);

111 i‡(
°©us
 && !
	`wö32_£rvi˚_öãºu±
 (&
wö32_sig«l
))

112  
åue
;

115  
Ál£
;

116 
	}
}

120 #ifde‡
HAVE_GETPASS


122 
FILE
 *

123 
	$›í_ây
 (c⁄° 
boﬁ
 
wrôe
)

125 
FILE
 *
ªt
;

126 
ªt
 = 
	`f›í
 ("/dev/ây", 
wrôe
 ? "w" : "r");

127 i‡(!
ªt
)

128 
ªt
 = 
wrôe
 ? 
°dîr
 : 
°dö
;

129  
ªt
;

130 
	}
}

133 
	$˛o£_ây
 (
FILE
 *
Â
)

135 i‡(
Â
 !
°dîr
 && f∞!
°dö
)

136 
	`f˛o£
 (
Â
);

137 
	}
}

141 #ifde‡
ENABLE_SYSTEMD


147 
boﬁ


148 
	$check_sy°emd_ru¬ög
 ()

150 
°©
 
c
;

156  (
	`sd_boŸed
() > 0)

157 && (
	`°©
(
SYSTEMD_ASK_PASSWORD_PATH
, &
c
) == 0);

159 
	}
}

161 
boﬁ


162 
	$gë_c⁄sﬁe_öput_sy°emd
 (c⁄° *
¥om±
, c⁄° 
boﬁ
 
echo
, *
öput
, c⁄° 
ˇ∑côy
)

164 
°d_out
;

165 
boﬁ
 
ªt
 = 
Ál£
;

166 
¨gv
árgv;

168 
	`¨gv_öô
 (&
¨gv
);

169 
	`¨gv_¥ötf
 (&
¨gv
, 
SYSTEMD_ASK_PASSWORD_PATH
);

170 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "%s", 
¥om±
);

172 i‡((
°d_out
 = 
	`›ív≤_p›í
 (&
¨gv
, 
NULL
)) < 0) {

173  
Ál£
;

175 
	`CLEAR
 (*
öput
);

176 i‡(
	`ªad
 (
°d_out
, 
öput
, 
ˇ∑côy
) != 0)

178 
	`chomp
 (
öput
);

179 
ªt
 = 
åue
;

181 
	`˛o£
 (
°d_out
);

183 
	`¨gv_ª£t
 (&
¨gv
);

185  
ªt
;

186 
	}
}

194 
boﬁ


195 
	$gë_c⁄sﬁe_öput
 (c⁄° *
¥om±
, c⁄° 
boﬁ
 
echo
, *
öput
, c⁄° 
ˇ∑côy
)

197 
boﬁ
 
ªt
 = 
Ál£
;

198 
	`ASSERT
 (
¥om±
);

199 
	`ASSERT
 (
öput
);

200 
	`ASSERT
 (
ˇ∑côy
 > 0);

201 
öput
[0] = '\0';

203 #ifde‡
ENABLE_SYSTEMD


204 i‡(
	`check_sy°emd_ru¬ög
 ())

205  
	`gë_c⁄sﬁe_öput_sy°emd
 (
¥om±
, 
echo
, 
öput
, 
ˇ∑côy
);

208 #i‡
	`deföed
(
WIN32
)

209  
	`gë_c⁄sﬁe_öput_wö32
 (
¥om±
, 
echo
, 
öput
, 
ˇ∑côy
);

210 #ñi‡
	`deföed
(
HAVE_GETPASS
)

211 i‡(
echo
)

213 
FILE
 *
Â
;

215 
Â
 = 
	`›í_ây
 (
åue
);

216 
	`Ârötf
 (
Â
, "%s", 
¥om±
);

217 
	`fÊush
 (
Â
);

218 
	`˛o£_ây
 (
Â
);

220 
Â
 = 
	`›í_ây
 (
Ál£
);

221 i‡(
	`fgës
 (
öput
, 
ˇ∑côy
, 
Â
Ë!
NULL
)

223 
	`chomp
 (
öput
);

224 
ªt
 = 
åue
;

226 
	`˛o£_ây
 (
Â
);

230 *
gp
 = 
	`gë∑ss
 (
¥om±
);

231 i‡(
gp
)

233 
	`°∫˝y¡
 (
öput
, 
gp
, 
ˇ∑côy
);

234 
	`mem£t
 (
gp
, 0, 
	`°æí
 (gp));

235 
ªt
 = 
åue
;

239 
	`msg
 (
M_FATAL
, "S‹ry, buàI c™'àgë c⁄sﬁêöpuà⁄Åhi†OS (%s)", 
¥om±
);

241  
ªt
;

242 
	}
}

	@src/openvpn/console.h

25 #i‚de‡
CONSOLE_H


26 
	#CONSOLE_H


	)

28 
	~"basic.h
"

30 
boﬁ


31 
gë_c⁄sﬁe_öput
 (c⁄° *
¥om±
, c⁄° 
boﬁ
 
echo
, *
öput
, c⁄° 
ˇ∑côy
);

	@src/openvpn/crypto.c

26 #ifde‡
HAVE_CONFIG_H


27 
	~"c⁄fig.h
"

28 #ñi‡
deföed
(
_MSC_VER
)

29 
	~"c⁄fig-msvc.h
"

32 
	~"syshód.h
"

34 #ifde‡
ENABLE_CRYPTO


36 
	~"¸y±o.h
"

37 
	~"îr‹.h
"

38 
	~"misc.h
"

40 
	~"memdbg.h
"

65 
	#CRYPT_ERROR
(
f‹m©
) \

66 dÿ{ 
	`msg
 (
D_CRYPT_ERRORS
, "%s: " 
f‹m©
, 
îr‹_¥efix
); 
îr‹_exô
; } 
Ál£
)

	)

73 
	$memcmp_c⁄°™t_time
 (c⁄° *
a
, c⁄° *
b
, 
size_t
 
size
) {

74 c⁄° 
uöt8_t
 * 
a1
 = 
a
;

75 c⁄° 
uöt8_t
 * 
b1
 = 
b
;

76 
ªt
 = 0;

77 
size_t
 
i
;

79 
i
 = 0; i < 
size
; i++) {

80 
ªt
 |*
a1
++ ^ *
b1
++;

83  
ªt
;

84 
	}
}

87 
	$›ív≤_í¸y±
 (
buf„r
 *
buf
, buf„∏
w‹k
,

88 c⁄° 
¸y±o_›ti⁄s
 *
›t
,

89 c⁄° 
‰ame
* frame)

91 
gc_¨ía
 
gc
;

92 
	`gc_öô
 (&
gc
);

94 i‡(
buf
->
Àn
 > 0 && 
›t
->
key_˘x_bi
)

96 
key_˘x
 *
˘x
 = &
›t
->
key_˘x_bi
->
í¸y±
;

99 i‡(
˘x
->
cùhî
)

101 
uöt8_t
 
iv_buf
[
OPENVPN_MAX_IV_LENGTH
];

102 c⁄° 
iv_size
 = 
	`cùhî_˘x_iv_Àngth
 (
˘x
->
cùhî
);

103 c⁄° 
cùhî_kt_t
 *
cùhî_kt
 = 
	`cùhî_˘x_gë_cùhî_kt
 (
˘x
->
cùhî
);

104 
ouéí
;

106 i‡(
	`cùhî_kt_mode_cbc
(
cùhî_kt
))

108 
	`CLEAR
 (
iv_buf
);

111 i‡(
›t
->
Êags
 & 
CO_USE_IV
)

112 
	`¥ng_byãs
 (
iv_buf
, 
iv_size
);

115 i‡(
›t
->
∑ckë_id
)

117 
∑ckë_id_√t
 
pö
;

118 
	`∑ckë_id_Æloc_outgoög
 (&
›t
->
∑ckë_id
->
£nd
, &
pö
, 
	`BOOL_CAST
 (›t->
Êags
 & 
CO_PACKET_ID_LONG_FORM
));

119 
	`ASSERT
 (
	`∑ckë_id_wrôe
 (&
pö
, 
buf
, 
	`BOOL_CAST
 (
›t
->
Êags
 & 
CO_PACKET_ID_LONG_FORM
), 
åue
));

122 i‡(
	`cùhî_kt_mode_ofb_cfb
(
cùhî_kt
))

124 
∑ckë_id_√t
 
pö
;

125 
buf„r
 
b
;

127 
	`ASSERT
 (
›t
->
Êags
 & 
CO_USE_IV
);

128 
	`ASSERT
 (
›t
->
∑ckë_id
);

130 
	`∑ckë_id_Æloc_outgoög
 (&
›t
->
∑ckë_id
->
£nd
, &
pö
, 
åue
);

131 
	`mem£t
 (
iv_buf
, 0, 
iv_size
);

132 
	`buf_£t_wrôe
 (&
b
, 
iv_buf
, 
iv_size
);

133 
	`ASSERT
 (
	`∑ckë_id_wrôe
 (&
pö
, &
b
, 
åue
, 
Ál£
));

137 
	`ASSERT
 (0);

141 
	`ASSERT
 (
	`buf_öô
 (&
w‹k
, 
	`FRAME_HEADROOM
 (
‰ame
)));

144 i‡(
›t
->
Êags
 & 
CO_USE_IV
)

145 
	`dmsg
 (
D_PACKET_CONTENT
, "ENCRYPT IV: %s", 
	`f‹m©_hex
 (
iv_buf
, 
iv_size
, 0, &
gc
));

147 
	`dmsg
 (
D_PACKET_CONTENT
, "ENCRYPT FROM: %s",

148 
	`f‹m©_hex
 (
	`BPTR
 (
buf
), 
	`BLEN
 (buf), 80, &
gc
));

151 
	`ASSERT
 (
	`cùhî_˘x_ª£t
(
˘x
->
cùhî
, 
iv_buf
));

154 i‡(!
	`buf_ß„
 (&
w‹k
, 
buf
->
Àn
 + 
	`cùhî_˘x_block_size
(
˘x
->
cùhî
)))

156 
	`msg
 (
D_CRYPT_ERRORS
, "ENCRYPT: buffer sizeÉrror, bc=%d bo=%d bl=%d wc=%d wo=%d wl=%d cbs=%d",

157 
buf
->
ˇ∑côy
,

158 
buf
->
off£t
,

159 
buf
->
Àn
,

160 
w‹k
.
ˇ∑côy
,

161 
w‹k
.
off£t
,

162 
w‹k
.
Àn
,

163 
	`cùhî_˘x_block_size
 (
˘x
->
cùhî
));

164 
îr
;

168 
	`ASSERT
 (
	`cùhî_˘x_upd©e
 (
˘x
->
cùhî
, 
	`BPTR
 (&
w‹k
), &
ouéí
, BPTR (
buf
), 
	`BLEN
 (buf)));

169 
w‹k
.
Àn
 +
ouéí
;

172 
	`ASSERT
(
	`cùhî_˘x_föÆ
(
˘x
->
cùhî
, 
	`BPTR
 (&
w‹k
Ë+ 
ouéí
, &outlen));

173 
w‹k
.
Àn
 +
ouéí
;

176 
	`ASSERT
 (
	`cùhî_kt_mode
 (
cùhî_kt
Ë!
OPENVPN_MODE_CBC
 ||

177 
ouéí
 =
iv_size
);

180 i‡(
›t
->
Êags
 & 
CO_USE_IV
)

182 
uöt8_t
 *
ouçut
 = 
	`buf_¥ïíd
 (&
w‹k
, 
iv_size
);

183 
	`ASSERT
 (
ouçut
);

184 
	`mem˝y
 (
ouçut
, 
iv_buf
, 
iv_size
);

187 
	`dmsg
 (
D_PACKET_CONTENT
, "ENCRYPT TO: %s",

188 
	`f‹m©_hex
 (
	`BPTR
 (&
w‹k
), 
	`BLEN
 (&w‹k), 80, &
gc
));

192 i‡(
›t
->
∑ckë_id
)

194 
∑ckë_id_√t
 
pö
;

195 
	`∑ckë_id_Æloc_outgoög
 (&
›t
->
∑ckë_id
->
£nd
, &
pö
, 
	`BOOL_CAST
 (›t->
Êags
 & 
CO_PACKET_ID_LONG_FORM
));

196 
	`ASSERT
 (
	`∑ckë_id_wrôe
 (&
pö
, 
buf
, 
	`BOOL_CAST
 (
›t
->
Êags
 & 
CO_PACKET_ID_LONG_FORM
), 
åue
));

198 
w‹k
 = *
buf
;

202 i‡(
˘x
->
hmac
)

204 
uöt8_t
 *
ouçut
 = 
NULL
;

206 
	`hmac_˘x_ª£t
 (
˘x
->
hmac
);

207 
	`hmac_˘x_upd©e
 (
˘x
->
hmac
, 
	`BPTR
(&
w‹k
), 
	`BLEN
(&work));

208 
ouçut
 = 
	`buf_¥ïíd
 (&
w‹k
, 
	`hmac_˘x_size
(
˘x
->
hmac
));

209 
	`ASSERT
 (
ouçut
);

210 
	`hmac_˘x_föÆ
 (
˘x
->
hmac
, 
ouçut
);

213 *
buf
 = 
w‹k
;

216 
	`gc_‰ì
 (&
gc
);

219 
îr
:

220 
	`¸y±o_˛ór_îr‹
();

221 
buf
->
Àn
 = 0;

222 
	`gc_‰ì
 (&
gc
);

224 
	}
}

234 
boﬁ


235 
	$›ív≤_de¸y±
 (
buf„r
 *
buf
, buf„∏
w‹k
,

236 c⁄° 
¸y±o_›ti⁄s
 *
›t
,

237 c⁄° 
‰ame
* frame)

239 c⁄° 
îr‹_¥efix
[] = "Authenticate/DecryptÖacketÉrror";

240 
gc_¨ía
 
gc
;

241 
	`gc_öô
 (&
gc
);

243 i‡(
buf
->
Àn
 > 0 && 
›t
->
key_˘x_bi
)

245 
key_˘x
 *
˘x
 = &
›t
->
key_˘x_bi
->
de¸y±
;

246 
∑ckë_id_√t
 
pö
;

247 
boﬁ
 
have_pö
 = 
Ál£
;

250 i‡(
˘x
->
hmac
)

252 
hmac_Àn
;

253 
uöt8_t
 
loˇl_hmac
[
MAX_HMAC_KEY_LENGTH
];

255 
	`hmac_˘x_ª£t
(
˘x
->
hmac
);

258 
hmac_Àn
 = 
	`hmac_˘x_size
 (
˘x
->
hmac
);

261 i‡(
buf
->
Àn
 < 
hmac_Àn
)

262 
	`CRYPT_ERROR
 ("missingáuthentication info");

264 
	`hmac_˘x_upd©e
 (
˘x
->
hmac
, 
	`BPTR
 (
buf
Ë+ 
hmac_Àn
, 
	`BLEN
 (buf) - hmac_len);

265 
	`hmac_˘x_föÆ
 (
˘x
->
hmac
, 
loˇl_hmac
);

268 i‡(
	`memcmp_c⁄°™t_time
 (
loˇl_hmac
, 
	`BPTR
 (
buf
), 
hmac_Àn
))

269 
	`CRYPT_ERROR
 ("packet HMACáuthentication failed");

271 
	`ASSERT
 (
	`buf_adv™˚
 (
buf
, 
hmac_Àn
));

276 i‡(
˘x
->
cùhî
)

278 c⁄° 
iv_size
 = 
	`cùhî_˘x_iv_Àngth
 (
˘x
->
cùhî
);

279 c⁄° 
cùhî_kt_t
 *
cùhî_kt
 = 
	`cùhî_˘x_gë_cùhî_kt
 (
˘x
->
cùhî
);

280 
uöt8_t
 
iv_buf
[
OPENVPN_MAX_IV_LENGTH
];

281 
ouéí
;

284 
	`ASSERT
 (
	`buf_öô
 (&
w‹k
, 
	`FRAME_HEADROOM_ADJ
 (
‰ame
, 
FRAME_HEADROOM_MARKER_DECRYPT
)));

287 
	`CLEAR
 (
iv_buf
);

288 i‡(
›t
->
Êags
 & 
CO_USE_IV
)

290 i‡(
buf
->
Àn
 < 
iv_size
)

291 
	`CRYPT_ERROR
 ("missing IV info");

292 
	`mem˝y
 (
iv_buf
, 
	`BPTR
 (
buf
), 
iv_size
);

293 
	`ASSERT
 (
	`buf_adv™˚
 (
buf
, 
iv_size
));

297 i‡(
›t
->
Êags
 & 
CO_USE_IV
)

298 
	`dmsg
 (
D_PACKET_CONTENT
, "DECRYPT IV: %s", 
	`f‹m©_hex
 (
iv_buf
, 
iv_size
, 0, &
gc
));

300 i‡(
buf
->
Àn
 < 1)

301 
	`CRYPT_ERROR
 ("missingÖayload");

304 i‡(!
	`cùhî_˘x_ª£t
 (
˘x
->
cùhî
, 
iv_buf
))

305 
	`CRYPT_ERROR
 ("cipher init failed");

308 i‡(!
	`buf_ß„
 (&
w‹k
, 
buf
->
Àn
))

309 
	`CRYPT_ERROR
 ("buffer overflow");

312 i‡(!
	`cùhî_˘x_upd©e
 (
˘x
->
cùhî
, 
	`BPTR
 (&
w‹k
), &
ouéí
, BPTR (
buf
), 
	`BLEN
 (buf)))

313 
	`CRYPT_ERROR
 ("cipher update failed");

314 
w‹k
.
Àn
 +
ouéí
;

317 i‡(!
	`cùhî_˘x_föÆ
 (
˘x
->
cùhî
, 
	`BPTR
 (&
w‹k
Ë+ 
ouéí
, &outlen))

318 
	`CRYPT_ERROR
 ("cipher final failed");

319 
w‹k
.
Àn
 +
ouéí
;

321 
	`dmsg
 (
D_PACKET_CONTENT
, "DECRYPT TO: %s",

322 
	`f‹m©_hex
 (
	`BPTR
 (&
w‹k
), 
	`BLEN
 (&w‹k), 80, &
gc
));

326 i‡(
	`cùhî_kt_mode_cbc
(
cùhî_kt
))

328 i‡(
›t
->
∑ckë_id
)

330 i‡(!
	`∑ckë_id_ªad
 (&
pö
, &
w‹k
, 
	`BOOL_CAST
 (
›t
->
Êags
 & 
CO_PACKET_ID_LONG_FORM
)))

331 
	`CRYPT_ERROR
 ("errorÑeading CBCÖacket-id");

332 
have_pö
 = 
åue
;

335 i‡(
	`cùhî_kt_mode_ofb_cfb
(
cùhî_kt
))

337 
buf„r
 
b
;

339 
	`ASSERT
 (
›t
->
Êags
 & 
CO_USE_IV
);

340 
	`ASSERT
 (
›t
->
∑ckë_id
);

342 
	`buf_£t_ªad
 (&
b
, 
iv_buf
, 
iv_size
);

343 i‡(!
	`∑ckë_id_ªad
 (&
pö
, &
b
, 
åue
))

344 
	`CRYPT_ERROR
 ("errorÑeading CFB/OFBÖacket-id");

345 
have_pö
 = 
åue
;

349 
	`ASSERT
 (0);

355 
w‹k
 = *
buf
;

356 i‡(
›t
->
∑ckë_id
)

358 i‡(!
	`∑ckë_id_ªad
 (&
pö
, &
w‹k
, 
	`BOOL_CAST
 (
›t
->
Êags
 & 
CO_PACKET_ID_LONG_FORM
)))

359 
	`CRYPT_ERROR
 ("errorÑeadingÖacket-id");

360 
have_pö
 = !
	`BOOL_CAST
 (
›t
->
Êags
 & 
CO_IGNORE_PACKET_ID
);

364 i‡(
have_pö
)

366 
	`∑ckë_id_ª≠_ã°
 (&
›t
->
∑ckë_id
->
ªc
);

367 i‡(
	`∑ckë_id_ã°
 (&
›t
->
∑ckë_id
->
ªc
, &
pö
))

369 
	`∑ckë_id_add
 (&
›t
->
∑ckë_id
->
ªc
, &
pö
);

370 i‡(
›t
->
pid_≥rsi°
 && (›t->
Êags
 & 
CO_PACKET_ID_LONG_FORM
))

371 
	`∑ckë_id_≥rsi°_ßve_obj
 (
›t
->
pid_≥rsi°
, o±->
∑ckë_id
);

375 i‡(!(
›t
->
Êags
 & 
CO_MUTE_REPLAY_WARNINGS
))

376 
	`msg
 (
D_REPLAY_ERRORS
, "%s: badÖacket ID (may beáÑeplay): %s -- seeÅhe manÖageÉntry for --no-replayánd --replay-window for more info or silenceÅhis warning with --mute-replay-warnings",

377 
îr‹_¥efix
, 
	`∑ckë_id_√t_¥öt
 (&
pö
, 
åue
, &
gc
));

378 
îr‹_exô
;

381 *
buf
 = 
w‹k
;

384 
	`gc_‰ì
 (&
gc
);

385  
åue
;

387 
îr‹_exô
:

388 
	`¸y±o_˛ór_îr‹
();

389 
buf
->
Àn
 = 0;

390 
	`gc_‰ì
 (&
gc
);

391  
Ál£
;

392 
	}
}

399 
	$¸y±o_adju°_‰ame_∑ømëîs
(
‰ame
 *frame,

400 c⁄° 
key_ty≥
* 
kt
,

401 
boﬁ
 
cùhî_deföed
,

402 
boﬁ
 
u£_iv
,

403 
boﬁ
 
∑ckë_id
,

404 
boﬁ
 
∑ckë_id_l⁄g_f‹m
)

406 
	`‰ame_add_to_exåa_‰ame
 (
‰ame
,

407 (
∑ckë_id
 ? 
	`∑ckë_id_size
 (
∑ckë_id_l⁄g_f‹m
) : 0) +

408 ((
cùhî_deföed
 && 
u£_iv
Ë? 
	`cùhî_kt_iv_size
 (
kt
->
cùhî
) : 0) +

409 (
cùhî_deföed
 ? 
	`cùhî_kt_block_size
 (
kt
->
cùhî
) : 0) +

410 
kt
->
hmac_Àngth
);

411 
	}
}

417 
	$öô_key_ty≥
 (
key_ty≥
 *
kt
, c⁄° *
cùhî«me
,

418 
boﬁ
 
cùhî«me_deföed
, c⁄° *
auth«me
,

419 
boﬁ
 
auth«me_deföed
, 
keysize
,

420 
boﬁ
 
cfb_ofb_Ælowed
, boﬁ 
w¨n
)

422 
	`CLEAR
 (*
kt
);

423 i‡(
cùhî«me
 && 
cùhî«me_deföed
)

425 
kt
->
cùhî
 = 
	`cùhî_kt_gë
 (
	`å™¶©e_cùhî_«me_‰om_›ív≤
(
cùhî«me
));

426 
kt
->
cùhî_Àngth
 = 
	`cùhî_kt_key_size
 (kt->
cùhî
);

427 i‡(
keysize
 > 0 && keysizê<
MAX_CIPHER_KEY_LENGTH
)

428 
kt
->
cùhî_Àngth
 = 
keysize
;

432 i‡(!(
	`cùhî_kt_mode_cbc
(
kt
->
cùhî
)

433 #ifde‡
ENABLE_OFB_CFB_MODE


434 || (
cfb_ofb_Ælowed
 && 
	`cùhî_kt_mode_ofb_cfb
(
kt
->
cùhî
))

437 
	`msg
 (
M_FATAL
, "Cùhî '%s' modênŸ suµ‹ãd", 
cùhî«me
);

442 i‡(
w¨n
)

443 
	`msg
 (
M_WARN
, "******* WARNING *******:Çull cipher specified,ÇoÉncryption will be used");

445 i‡(
auth«me
 && 
auth«me_deföed
)

447 
kt
->
dige°
 = 
	`md_kt_gë
 (
auth«me
);

448 
kt
->
hmac_Àngth
 = 
	`md_kt_size
 (kt->
dige°
);

452 i‡(
w¨n
)

453 
	`msg
 (
M_WARN
, "******* WARNING *******:Çull MAC specified,Çoáuthentication will be used");

455 
	}
}

459 
	$öô_key_˘x
 (
key_˘x
 *
˘x
, 
key
 *key,

460 c⁄° 
key_ty≥
 *
kt
, 
íc
,

461 c⁄° *
¥efix
)

463 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

464 
	`CLEAR
 (*
˘x
);

465 i‡(
kt
->
cùhî
 && kt->
cùhî_Àngth
 > 0)

468 
	`ALLOC_OBJ
(
˘x
->
cùhî
, 
cùhî_˘x_t
);

469 
	`cùhî_˘x_öô
 (
˘x
->
cùhî
, 
key
->cùhî, 
kt
->
cùhî_Àngth
,

470 
kt
->
cùhî
, 
íc
);

472 
	`msg
 (
D_HANDSHAKE
, "%s: Cipher '%s' initialized with %d bit key",

473 
¥efix
,

474 
	`cùhî_kt_«me
(
kt
->
cùhî
),

475 
kt
->
cùhî_Àngth
 *8);

477 
	`dmsg
 (
D_SHOW_KEYS
, "%s: CIPHER KEY: %s", 
¥efix
,

478 
	`f‹m©_hex
 (
key
->
cùhî
, 
kt
->
cùhî_Àngth
, 0, &
gc
));

479 
	`dmsg
 (
D_CRYPTO_DEBUG
, "%s: CIPHER block_size=%d iv_size=%d",

480 
¥efix
,

481 
	`cùhî_kt_block_size
(
kt
->
cùhî
),

482 
	`cùhî_kt_iv_size
(
kt
->
cùhî
));

484 i‡(
kt
->
dige°
 && kt->
hmac_Àngth
 > 0)

486 
	`ALLOC_OBJ
(
˘x
->
hmac
, 
hmac_˘x_t
);

487 
	`hmac_˘x_öô
 (
˘x
->
hmac
, 
key
->hmac, 
kt
->
hmac_Àngth
, kt->
dige°
);

489 
	`msg
 (
D_HANDSHAKE
,

491 
¥efix
, 
	`md_kt_size
(
kt
->
dige°
Ë* 8, 
	`md_kt_«me
(kt->digest));

493 
	`dmsg
 (
D_SHOW_KEYS
, "%s: HMAC KEY: %s", 
¥efix
,

494 
	`f‹m©_hex
 (
key
->
hmac
, 
kt
->
hmac_Àngth
, 0, &
gc
));

496 
	`dmsg
 (
D_CRYPTO_DEBUG
, "%s: HMAC size=%d block_size=%d",

497 
¥efix
,

498 
	`md_kt_size
(
kt
->
dige°
),

499 
	`hmac_˘x_size
(
˘x
->
hmac
));

502 
	`gc_‰ì
 (&
gc
);

503 
	}
}

506 
	$‰ì_key_˘x
 (
key_˘x
 *
˘x
)

508 i‡(
˘x
->
cùhî
)

510 
	`cùhî_˘x_˛ónup
(
˘x
->
cùhî
);

511 
	`‰ì
(
˘x
->
cùhî
);

512 
˘x
->
cùhî
 = 
NULL
;

514 i‡(
˘x
->
hmac
)

516 
	`hmac_˘x_˛ónup
(
˘x
->
hmac
);

517 
	`‰ì
(
˘x
->
hmac
);

518 
˘x
->
hmac
 = 
NULL
;

520 
	}
}

523 
	$‰ì_key_˘x_bi
 (
key_˘x_bi
 *
˘x
)

525 
	`‰ì_key_˘x
(&
˘x
->
í¸y±
);

526 
	`‰ì_key_˘x
(&
˘x
->
de¸y±
);

527 
	}
}

530 
boﬁ


531 
	$key_is_zîo
 (
key
 *key, c⁄° 
key_ty≥
 *
kt
)

533 
i
;

534 
i
 = 0; i < 
kt
->
cùhî_Àngth
; ++i)

535 i‡(
key
->
cùhî
[
i
])

536  
Ál£
;

537 
	`msg
 (
D_CRYPT_ERRORS
, "CRYPTO INFO: WARNING: zero key detected");

538  
åue
;

539 
	}
}

544 
boﬁ


545 
	$check_key
 (
key
 *key, c⁄° 
key_ty≥
 *
kt
)

547 i‡(
kt
->
cùhî
)

552 i‡(
	`key_is_zîo
(
key
, 
kt
))

553  
Ál£
;

559 c⁄° 
ndc
 = 
	`key_des_num_cblocks
 (
kt
->
cùhî
);

560 i‡(
ndc
)

561  
	`key_des_check
 (
key
->
cùhî
, 
kt
->
cùhî_Àngth
, 
ndc
);

563  
åue
;

566  
åue
;

567 
	}
}

578 
	$fixup_key
 (
key
 *key, c⁄° 
key_ty≥
 *
kt
)

580 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

581 i‡(
kt
->
cùhî
)

583 #ifde‡
ENABLE_DEBUG


584 c⁄° 
key
 
‹ig
 = *key;

586 c⁄° 
ndc
 = 
	`key_des_num_cblocks
 (
kt
->
cùhî
);

588 i‡(
ndc
)

589 
	`key_des_fixup
 (
key
->
cùhî
, 
kt
->
cùhî_Àngth
, 
ndc
);

591 #ifde‡
ENABLE_DEBUG


592 i‡(
	`check_debug_Àvñ
 (
D_CRYPTO_DEBUG
))

594 i‡(
	`memcmp
 (
‹ig
.
cùhî
, 
key
->cùhî, 
kt
->
cùhî_Àngth
))

595 
	`dmsg
 (
D_CRYPTO_DEBUG
, "CRYPTO INFO: fixup_key: before=%sáfter=%s",

596 
	`f‹m©_hex
 (
‹ig
.
cùhî
, 
kt
->
cùhî_Àngth
, 0, &
gc
),

597 
	`f‹m©_hex
 (
key
->
cùhî
, 
kt
->
cùhî_Àngth
, 0, &
gc
));

601 
	`gc_‰ì
 (&
gc
);

602 
	}
}

605 
	$check_ª∂ay_iv_c⁄si°ícy
 (c⁄° 
key_ty≥
 *
kt
, 
boﬁ
 
∑ckë_id
, boﬁ 
u£_iv
)

607 
	`ASSERT
(
kt
);

609 i‡(
	`cùhî_kt_mode_ofb_cfb
(
kt
->
cùhî
Ë&& !(
∑ckë_id
 && 
u£_iv
))

610 
	`msg
 (
M_FATAL
, "--no-replay or --no-iv cannot be used withá CFB or OFB mode cipher");

611 
	}
}

618 
	$gíî©e_key_øndom
 (
key
 *key, c⁄° 
key_ty≥
 *
kt
)

620 
cùhî_Àn
 = 
MAX_CIPHER_KEY_LENGTH
;

621 
hmac_Àn
 = 
MAX_HMAC_KEY_LENGTH
;

623 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

626 
	`CLEAR
 (*
key
);

627 i‡(
kt
)

629 i‡(
kt
->
cùhî
 && kt->
cùhî_Àngth
 > 0 && kt->cùhî_Àngth <
cùhî_Àn
)

630 
cùhî_Àn
 = 
kt
->
cùhî_Àngth
;

632 i‡(
kt
->
dige°
 && kt->
hmac_Àngth
 > 0 && kt->hmac_Àngth <
hmac_Àn
)

633 
hmac_Àn
 = 
kt
->
hmac_Àngth
;

635 i‡(!
	`ønd_byãs
 (
key
->
cùhî
, 
cùhî_Àn
)

636 || !
	`ønd_byãs
 (
key
->
hmac
, 
hmac_Àn
))

637 
	`msg
 (
M_FATAL
, "ERROR: RandomÇumber generator cannot obtainÉntropy for key generation");

639 
	`dmsg
 (
D_SHOW_KEY_SOURCE
, "Cùhî sour˚É¡r›y: %s", 
	`f‹m©_hex
 (
key
->
cùhî
, 
cùhî_Àn
, 0, &
gc
));

640 
	`dmsg
 (
D_SHOW_KEY_SOURCE
, "HMAC sour˚É¡r›y: %s", 
	`f‹m©_hex
 (
key
->
hmac
, 
hmac_Àn
, 0, &
gc
));

642 i‡(
kt
)

643 
	`fixup_key
 (
key
, 
kt
);

644 } 
kt
 && !
	`check_key
 (
key
, kt));

646 
	`gc_‰ì
 (&
gc
);

647 
	}
}

653 
	$key2_¥öt
 (c⁄° 
key2
* 
k
,

654 c⁄° 
key_ty≥
 *
kt
,

655 c⁄° * 
¥efix0
,

656 c⁄° * 
¥efix1
)

658 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

659 
	`ASSERT
 (
k
->
n
 == 2);

660 
	`dmsg
 (
D_SHOW_KEY_SOURCE
, "%s (cipher): %s",

661 
¥efix0
,

662 
	`f‹m©_hex
 (
k
->
keys
[0].
cùhî
, 
kt
->
cùhî_Àngth
, 0, &
gc
));

663 
	`dmsg
 (
D_SHOW_KEY_SOURCE
, "%s (hmac): %s",

664 
¥efix0
,

665 
	`f‹m©_hex
 (
k
->
keys
[0].
hmac
, 
kt
->
hmac_Àngth
, 0, &
gc
));

666 
	`dmsg
 (
D_SHOW_KEY_SOURCE
, "%s (cipher): %s",

667 
¥efix1
,

668 
	`f‹m©_hex
 (
k
->
keys
[1].
cùhî
, 
kt
->
cùhî_Àngth
, 0, &
gc
));

669 
	`dmsg
 (
D_SHOW_KEY_SOURCE
, "%s (hmac): %s",

670 
¥efix1
,

671 
	`f‹m©_hex
 (
k
->
keys
[1].
hmac
, 
kt
->
hmac_Àngth
, 0, &
gc
));

672 
	`gc_‰ì
 (&
gc
);

673 
	}
}

676 
	$ã°_¸y±o
 (c⁄° 
¸y±o_›ti⁄s
 *
co
, 
‰ame
* frame)

678 
i
, 
j
;

679 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

680 
buf„r
 
§c
 = 
	`Æloc_buf_gc
 (
	`TUN_MTU_SIZE
 (
‰ame
), &
gc
);

681 
buf„r
 
w‹k
 = 
	`Æloc_buf_gc
 (
	`BUF_SIZE
 (
‰ame
), &
gc
);

682 
buf„r
 
í¸y±_w‹k•a˚
 = 
	`Æloc_buf_gc
 (
	`BUF_SIZE
 (
‰ame
), &
gc
);

683 
buf„r
 
de¸y±_w‹k•a˚
 = 
	`Æloc_buf_gc
 (
	`BUF_SIZE
 (
‰ame
), &
gc
);

684 
buf„r
 
buf
 = 
	`˛ór_buf
();

687 
	`ASSERT
 (
	`buf_öô
 (&
w‹k
, 
	`FRAME_HEADROOM
 (
‰ame
)));

689 
	`msg
 (
M_INFO
, "E¡îög " 
PACKAGE_NAME
 " crypto self-test mode.");

690 
i
 = 1; i <
	`TUN_MTU_SIZE
 (
‰ame
); ++i)

692 
	`upd©e_time
 ();

694 
	`msg
 (
M_INFO
, "TESTING ENCRYPT/DECRYPT o‡∑ckëÜígth=%d", 
i
);

699 
	`ASSERT
 (
	`buf_öô
 (&
§c
, 0));

700 
	`ASSERT
 (
i
 <
§c
.
ˇ∑côy
);

701 
§c
.
Àn
 = 
i
;

702 
	`ASSERT
 (
	`ønd_byãs
 (
	`BPTR
 (&
§c
), 
	`BLEN
 (&src)));

705 
buf
 = 
w‹k
;

706 
	`mem˝y
 (
	`buf_wrôe_Æloc
 (&
buf
, 
	`BLEN
 (&
§c
)), 
	`BPTR
 (&src), BLEN (&src));

709 
	`›ív≤_í¸y±
 (&
buf
, 
í¸y±_w‹k•a˚
, 
co
, 
‰ame
);

712 
	`›ív≤_de¸y±
 (&
buf
, 
de¸y±_w‹k•a˚
, 
co
, 
‰ame
);

715 i‡(
buf
.
Àn
 !
§c
.len)

716 
	`msg
 (
M_FATAL
, "SELF TEST FAILED, src.Àn=%d buf.Àn=%d", 
§c
.
Àn
, 
buf
.len);

717 
j
 = 0; j < 
i
; ++j)

719 c⁄° 
uöt8_t
 
ö
 = *(
	`BPTR
 (&
§c
Ë+ 
j
);

720 c⁄° 
uöt8_t
 
out
 = *(
	`BPTR
 (&
buf
Ë+ 
j
);

721 i‡(
ö
 !
out
)

722 
	`msg
 (
M_FATAL
, "SELF TEST FAILED,Öos=%d in=%d out=%d", 
j
, 
ö
, 
out
);

725 
	`msg
 (
M_INFO
, 
PACKAGE_NAME
 " crypto self-test mode SUCCEEDED.");

726 
	`gc_‰ì
 (&
gc
);

727 
	}
}

729 #ifde‡
ENABLE_SSL


732 
	$gë_és_h™dshake_key
 (c⁄° 
key_ty≥
 *key_type,

733 
key_˘x_bi
 *
˘x
,

734 c⁄° *
∑s•hø£_fûe
,

735 c⁄° 
key_dúe˘i⁄
,

736 c⁄° 
Êags
)

738 i‡(
∑s•hø£_fûe
 && 
key_ty≥
->
hmac_Àngth
)

740 
key2
 key2;

741 
key_ty≥
 
kt
 = *key_type;

742 
key_dúe˘i⁄_°©e
 
kds
;

745 
kt
.
cùhî_Àngth
 = 0;

746 
kt
.
cùhî
 = 
NULL
;

748 i‡(
Êags
 & 
GHK_INLINE
)

751 
	`ªad_key_fûe
 (&
key2
, 
∑s•hø£_fûe
, 
RKF_INLINE
|
RKF_MUST_SUCCEED
);

754 i‡(
key2
.
n
 == 2)

755 
	`msg
 (
M_INFO
, "Control Channel Authentication:Åls-auth using INLINE static key file");

757 
	`msg
 (
M_FATAL
, "INLINEÅls-auth fileÜacksÅheÑequisite 2 keys");

762 
	`ªad_key_fûe
 (&
key2
, 
∑s•hø£_fûe
, 0);

765 i‡(
key2
.
n
 == 2)

767 
	`msg
 (
M_INFO
,

768 "C⁄åﬁ Ch™√»Authítiˇti⁄: usög '%s'á†®" 
PACKAGE_NAME
 " static key file",

769 
∑s•hø£_fûe
);

773 
hash_size
;

775 
	`CLEAR
 (
key2
);

778 
hash_size
 = 
	`ªad_∑s•hø£_hash
 (
∑s•hø£_fûe
,

779 
kt
.
dige°
,

780 
key2
.
keys
[0].
hmac
,

781 
MAX_HMAC_KEY_LENGTH
);

782 
	`ASSERT
 (
hash_size
 =
kt
.
hmac_Àngth
);

785 
key2
.
n
 = 1;

787 
	`msg
 (
M_INFO
,

789 
∑s•hø£_fûe
);

794 
	`key_dúe˘i⁄_°©e_öô
 (&
kds
, 
key_dúe˘i⁄
);

795 
	`mu°_have_n_keys
 (
∑s•hø£_fûe
, "és-auth", &
key2
, 
kds
.
√ed_keys
);

799 
	`öô_key_˘x
 (&
˘x
->
í¸y±
, &
key2
.
keys
[
kds
.
out_key
], &
kt
, 
OPENVPN_OP_ENCRYPT
,

801 
	`öô_key_˘x
 (&
˘x
->
de¸y±
, &
key2
.
keys
[
kds
.
ö_key
], &
kt
, 
OPENVPN_OP_DECRYPT
,

804 
	`CLEAR
 (
key2
);

808 
	`CLEAR
 (*
˘x
);

810 
	}
}

814 c⁄° 
	g°©ic_key_hód
[] = "-----BEGIN OpenVPN Static key V1-----";

815 c⁄° 
	g°©ic_key_foŸ
[] = "-----END OpenVPN Static key V1-----";

817 c⁄° 
	g¥öèbÀ_ch¨_fmt
[] =

820 c⁄° 
	gu≈röèbÀ_ch¨_fmt
[] =

826 
	$ªad_key_fûe
 (
key2
 *key2, c⁄° *
fûe
, c⁄° 
Êags
)

828 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

829 
buf„r
 
ö
;

830 
fd
, 
size
;

831 
uöt8_t
 
hex_byã
[3] = {0, 0, 0};

832 c⁄° *
îr‹_fûíame
 = 
fûe
;

835 c⁄° *
˝
;

836 
hb_ödex
 = 0;

837 
löe_num
 = 1;

838 
löe_ödex
 = 0;

839 
m©ch
 = 0;

842 
uöt8_t
* 
out
 = (uöt8_t*Ë&
key2
->
keys
;

843 c⁄° 
keyÀn
 =  (
key2
->
keys
);

844 
cou¡
 = 0;

847 
	#PARSE_INITIAL
 0

	)

848 
	#PARSE_HEAD
 1

	)

849 
	#PARSE_DATA
 2

	)

850 
	#PARSE_DATA_COMPLETE
 3

	)

851 
	#PARSE_FOOT
 4

	)

852 
	#PARSE_FINISHED
 5

	)

853 
°©e
 = 
PARSE_INITIAL
;

856 c⁄° 
hÀn
 = 
	`°æí
 (
°©ic_key_hód
);

857 c⁄° 
Êí
 = 
	`°æí
 (
°©ic_key_foŸ
);

858 c⁄° 
⁄ekeyÀn
 =  (
key2
->
keys
[0]);

860 
	`CLEAR
 (*
key2
);

866 i‡(
Êags
 & 
RKF_INLINE
)

868 
size
 = 
	`°æí
 (
fûe
) + 1;

869 
	`buf_£t_ªad
 (&
ö
, (c⁄° 
uöt8_t
 *)
fûe
, 
size
);

870 
îr‹_fûíame
 = 
INLINE_FILE_TAG
;

874 
ö
 = 
	`Æloc_buf_gc
 (2048, &
gc
);

875 
fd
 = 
	`∂©f‹m_›í
 (
fûe
, 
O_RDONLY
, 0);

876 i‡(
fd
 == -1)

877 
	`msg
 (
M_ERR
, "C™nŸ o≥¿fûêkey fûê'%s'", 
fûe
);

878 
size
 = 
	`ªad
 (
fd
, 
ö
.
d©a
, in.
ˇ∑côy
);

879 i‡(
size
 < 0)

880 
	`msg
 (
M_FATAL
, "RódÉº‹ o¿key fûê('%s')", 
fûe
);

881 i‡(
size
 =
ö
.
ˇ∑côy
)

882 
	`msg
 (
M_FATAL
, "Key fûê('%s'Ëˇ¿bê®maximum o‡%d byãs", 
fûe
, ()
ö
.
ˇ∑côy
);

883 
	`˛o£
 (
fd
);

886 
˝
 = (*)
ö
.
d©a
;

887 
size
 > 0)

889 c⁄° 
c
 = *
˝
;

892 
	`msg
 (
M_INFO
, "char='%c'[%d] s=%dÜn=%dÜi=%d m=%d c=%d",

893 
c
, ()c, 
°©e
, 
löe_num
, 
löe_ödex
, 
m©ch
, 
cou¡
);

896 i‡(
c
 == '\n')

898 
löe_ödex
 = 
m©ch
 = 0;

899 ++
löe_num
;

904 i‡(!
löe_ödex
)

907 i‡(
°©e
 =
PARSE_HEAD
)

908 
°©e
 = 
PARSE_DATA
;

911 i‡((
°©e
 =
PARSE_DATA
 || sèã =
PARSE_DATA_COMPLETE
Ë&& 
c
 == '-')

912 
°©e
 = 
PARSE_FOOT
;

916 i‡(
°©e
 =
PARSE_INITIAL
)

918 i‡(
löe_ödex
 < 
hÀn
 && 
c
 =
°©ic_key_hód
[line_index])

920 i‡(++
m©ch
 =
hÀn
)

921 
°©e
 = 
PARSE_HEAD
;

926 i‡(
°©e
 =
PARSE_FOOT
)

928 i‡(
löe_ödex
 < 
Êí
 && 
c
 =
°©ic_key_foŸ
[line_index])

930 i‡(++
m©ch
 =
Êí
)

931 
°©e
 = 
PARSE_FINISHED
;

936 i‡(
°©e
 =
PARSE_DATA
)

938 i‡(
	`isxdigô
(
c
))

940 
	`ASSERT
 (
hb_ödex
 >= 0 && hb_index < 2);

941 
hex_byã
[
hb_ödex
++] = 
c
;

942 i‡(
hb_ödex
 == 2)

944 
u
;

945 
	`ASSERT
(
	`ssˇnf
((c⁄° *)
hex_byã
, "%x", &
u
) == 1);

946 *
out
++ = 
u
;

947 
hb_ödex
 = 0;

948 i‡(++
cou¡
 =
keyÀn
)

949 
°©e
 = 
PARSE_DATA_COMPLETE
;

952 i‡(
	`is•a˚
(
c
))

956 
	`msg
 (
M_FATAL
,

957 (
	`i•röt
 (
c
Ë? 
¥öèbÀ_ch¨_fmt
 : 
u≈röèbÀ_ch¨_fmt
),

958 
c
, 
löe_num
, 
îr‹_fûíame
, 
cou¡
, 
⁄ekeyÀn
, 
keyÀn
);

961 ++
löe_ödex
;

963 ++
˝
;

964 --
size
;

970 
key2
->
n
 = 
cou¡
 / 
⁄ekeyÀn
;

972 
	`ASSERT
 (
key2
->
n
 >0 && key2->¿<(Ë
	`SIZE
 (key2->
keys
));

974 i‡(
Êags
 & 
RKF_MUST_SUCCEED
)

976 i‡(!
key2
->
n
)

977 
	`msg
 (
M_FATAL
, "Insufficient key material or headerÅextÇot found in file '%s' (%d/%d/%d bytes found/min/max)",

978 
îr‹_fûíame
, 
cou¡
, 
⁄ekeyÀn
, 
keyÀn
);

980 i‡(
°©e
 !
PARSE_FINISHED
)

981 
	`msg
 (
M_FATAL
, "FooterÅextÇot found in file '%s' (%d/%d/%d bytes found/min/max)",

982 
îr‹_fûíame
, 
cou¡
, 
⁄ekeyÀn
, 
keyÀn
);

986 i‡(!(
Êags
 & 
RKF_INLINE
))

987 
	`buf_˛ór
 (&
ö
);

989 i‡(
key2
->
n
)

990 
	`w¨n_if_group_Ÿhîs_ac˚ssibÀ
 (
îr‹_fûíame
);

995 
i
;

996 
	`¥ötf
 ("KEY READ,Ç=%d\n", 
key2
->
n
);

997 
i
 = 0; i < (Ë
	`SIZE
 (
key2
->
keys
); ++i)

1000 c⁄° *
fmt
 = 
	`f‹m©_hex_ex
 ((c⁄° 
uöt8_t
*)&
key2
->
keys
[
i
],

1001  (
key2
->
keys
[
i
]),

1005 &
gc
);

1006 
	`¥ötf
 ("[%d]\n%s\n\n", 
i
, 
fmt
);

1012 
	`gc_‰ì
 (&
gc
);

1013 
	}
}

1016 
	$ªad_∑s•hø£_hash
 (c⁄° *
∑s•hø£_fûe
,

1017 c⁄° 
md_kt_t
 *
dige°
,

1018 
uöt8_t
 *
ouçut
,

1019 
Àn
)

1021 
ouéí
 = 0;

1022 
md_˘x_t
 
md
;

1024 
	`ASSERT
 (
Àn
 >
	`md_kt_size
(
dige°
));

1025 
	`mem£t
 (
ouçut
, 0, 
Àn
);

1027 
	`md_˘x_öô
(&
md
, 
dige°
);

1031 c⁄° 
mö_∑s•hø£_size
 = 8;

1032 
uöt8_t
 
buf
[64];

1033 
tŸÆ_size
 = 0;

1034 
fd
 = 
	`∂©f‹m_›í
 (
∑s•hø£_fûe
, 
O_RDONLY
, 0);

1036 i‡(
fd
 == -1)

1037 
	`msg
 (
M_ERR
, "C™nŸ o≥¿∑s•hø£ fûe: '%s'", 
∑s•hø£_fûe
);

1041 
size
 = 
	`ªad
 (
fd
, 
buf
,  (buf));

1042 i‡(
size
 == 0)

1044 i‡(
size
 == -1)

1045 
	`msg
 (
M_ERR
, "ReadÉrror onÖassphrase file: '%s'",

1046 
∑s•hø£_fûe
);

1047 
	`md_˘x_upd©e
(&
md
, 
buf
, 
size
);

1048 
tŸÆ_size
 +
size
;

1050 
	`˛o£
 (
fd
);

1052 
	`w¨n_if_group_Ÿhîs_ac˚ssibÀ
 (
∑s•hø£_fûe
);

1054 i‡(
tŸÆ_size
 < 
mö_∑s•hø£_size
)

1055 
	`msg
 (
M_FATAL
,

1057 
∑s•hø£_fûe
, 
mö_∑s•hø£_size
);

1059 
	`md_˘x_föÆ
(&
md
, 
ouçut
);

1060 
	`md_˘x_˛ónup
(&
md
);

1061  
	`md_kt_size
(
dige°
);

1062 
	}
}

1069 
	$wrôe_key_fûe
 (c⁄° 
nkeys
, c⁄° *
fûíame
)

1071 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1073 
fd
, 
i
;

1074 
nbôs
 = 0;

1077 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (2048, &
gc
);

1078 
buf„r
 
nbôs_hód_ãxt
 = 
	`Æloc_buf_gc
 (128, &
gc
);

1081 c⁄° 
byãs_≥r_löe
 = 16;

1084 
fd
 = 
	`∂©f‹m_›í
 (
fûíame
, 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
, 
S_IRUSR
 | 
S_IWUSR
);

1086 i‡(
fd
 == -1)

1087 
	`msg
 (
M_ERR
, "C™nŸ o≥¿sh¨ed se¸ë fûê'%s' f‹ wrôe", 
fûíame
);

1089 
	`buf_¥ötf
 (&
out
, "%s\n", 
°©ic_key_hód
);

1091 
i
 = 0; i < 
nkeys
; ++i)

1093 
key
 key;

1094 * 
fmt
;

1097 
	`gíî©e_key_øndom
 (&
key
, 
NULL
);

1100 
fmt
 = 
	`f‹m©_hex_ex
 ((c⁄° 
uöt8_t
*)&
key
,

1101  (
key
),

1103 
byãs_≥r_löe
,

1105 &
gc
);

1108 
nbôs
 + (
key
) * 8;

1111 
	`buf_¥ötf
 (&
out
, "%s\n", 
fmt
);

1114 
	`mem£t
 (
fmt
, 0, 
	`°æí
(fmt));

1115 
	`CLEAR
 (
key
);

1118 
	`buf_¥ötf
 (&
out
, "%s\n", 
°©ic_key_foŸ
);

1121 
	`buf_¥ötf
 (&
nbôs_hód_ãxt
, "#\n# %d bô O≥nVPN sèti¯key\n#\n", 
nbôs
);

1122 
	`buf_wrôe_°rög_fûe
 (&
nbôs_hód_ãxt
, 
fûíame
, 
fd
);

1125 
	`buf_wrôe_°rög_fûe
 (&
out
, 
fûíame
, 
fd
);

1127 i‡(
	`˛o£
 (
fd
))

1128 
	`msg
 (
M_ERR
, "Clo£Éº‹ o¿sh¨ed se¸ë fûê%s", 
fûíame
);

1131 
	`buf_˛ór
 (&
out
);

1134 
	`gc_‰ì
 (&
gc
);

1136  
nbôs
;

1137 
	}
}

1140 
	$mu°_have_n_keys
 (c⁄° *
fûíame
, c⁄° *
›ti⁄
, c⁄° 
key2
 *key2, 
n
)

1142 i‡(
key2
->
n
 <Ç)

1144 #ifde‡
ENABLE_SMALL


1145 
	`msg
 (
M_FATAL
, "Key fûê'%s' u£d i¿--%†c⁄èö†ösufficõ¡ key m©îü»[key†found=%dÑequúed=%d]", 
fûíame
, 
›ti⁄
, 
key2
->
n
,Ç);

1147 
	`msg
 (
M_FATAL
, "Key fûê'%s' u£d i¿--%†c⁄èö†ösufficõ¡ key m©îü»[key†found=%dÑequúed=%d] --Åry gíî©ögáÇew key fûêwôh '" 
PACKAGE
 " --gíkey --£¸ë [fûe]', o∏u£Åhêexi°ög key fûêö bidúe˘i⁄Æ modêby s≥cifyög --%†wôhouà®key dúe˘i⁄Ö¨amëî", 
fûíame
, 
›ti⁄
, 
key2
->
n
,Ç, option);

1150 
	}
}

1153 
	$ascii2keydúe˘i⁄
 (
msgÀvñ
, c⁄° *
°r
)

1155 i‡(!
°r
)

1156  
KEY_DIRECTION_BIDIRECTIONAL
;

1157 i‡(!
	`°rcmp
 (
°r
, "0"))

1158  
KEY_DIRECTION_NORMAL
;

1159 i‡(!
	`°rcmp
 (
°r
, "1"))

1160  
KEY_DIRECTION_INVERSE
;

1163 
	`msg
 (
msgÀvñ
, "Unknow¿key dúe˘i⁄ '%s' -- mu° bê'0' o∏'1'", 
°r
);

1166  
KEY_DIRECTION_BIDIRECTIONAL
;

1167 
	}
}

1170 
	$keydúe˘i⁄2ascii
 (
kd
, 
boﬁ
 
ªmŸe
)

1172 i‡(
kd
 =
KEY_DIRECTION_BIDIRECTIONAL
)

1173  
NULL
;

1174 i‡(
kd
 =
KEY_DIRECTION_NORMAL
)

1175  
ªmŸe
 ? "1" : "0";

1176 i‡(
kd
 =
KEY_DIRECTION_INVERSE
)

1177  
ªmŸe
 ? "0" : "1";

1180 
	`ASSERT
 (0);

1182  
NULL
;

1183 
	}
}

1186 
	$key_dúe˘i⁄_°©e_öô
 (
key_dúe˘i⁄_°©e
 *
kds
, 
key_dúe˘i⁄
)

1188 
	`CLEAR
 (*
kds
);

1189 
key_dúe˘i⁄
)

1191 
KEY_DIRECTION_NORMAL
:

1192 
kds
->
out_key
 = 0;

1193 
kds
->
ö_key
 = 1;

1194 
kds
->
√ed_keys
 = 2;

1196 
KEY_DIRECTION_INVERSE
:

1197 
kds
->
out_key
 = 1;

1198 
kds
->
ö_key
 = 0;

1199 
kds
->
√ed_keys
 = 2;

1201 
KEY_DIRECTION_BIDIRECTIONAL
:

1202 
kds
->
out_key
 = 0;

1203 
kds
->
ö_key
 = 0;

1204 
kds
->
√ed_keys
 = 1;

1207 
	`ASSERT
 (0);

1209 
	}
}

1212 
	$vîify_fix_key2
 (
key2
 *key2, c⁄° 
key_ty≥
 *
kt
, c⁄° *
sh¨ed_£¸ë_fûe
)

1214 
i
;

1216 
i
 = 0; i < 
key2
->
n
; ++i)

1219 
	`fixup_key
 (&
key2
->
keys
[
i
], 
kt
);

1222 i‡(!
	`check_key
 (&
key2
->
keys
[
i
], 
kt
))

1223 
	`msg
 (
M_FATAL
, "Key #%d in '%s' is bad. Try makingáÇew key with --genkey.",

1224 
i
+1, 
sh¨ed_£¸ë_fûe
);

1226 
	}
}

1229 
boﬁ


1230 
	$wrôe_key
 (c⁄° 
key
 *key, c⁄° 
key_ty≥
 *
kt
,

1231 
buf„r
 *
buf
)

1233 
	`ASSERT
 (
kt
->
cùhî_Àngth
 <
MAX_CIPHER_KEY_LENGTH


1234 && 
kt
->
hmac_Àngth
 <
MAX_HMAC_KEY_LENGTH
);

1236 i‡(!
	`buf_wrôe
 (
buf
, &
kt
->
cùhî_Àngth
, 1))

1237  
Ál£
;

1238 i‡(!
	`buf_wrôe
 (
buf
, &
kt
->
hmac_Àngth
, 1))

1239  
Ál£
;

1240 i‡(!
	`buf_wrôe
 (
buf
, 
key
->
cùhî
, 
kt
->
cùhî_Àngth
))

1241  
Ál£
;

1242 i‡(!
	`buf_wrôe
 (
buf
, 
key
->
hmac
, 
kt
->
hmac_Àngth
))

1243  
Ál£
;

1245  
åue
;

1246 
	}
}

1255 
	$ªad_key
 (
key
 *key, c⁄° 
key_ty≥
 *
kt
, 
buf„r
 *
buf
)

1257 
uöt8_t
 
cùhî_Àngth
;

1258 
uöt8_t
 
hmac_Àngth
;

1260 
	`CLEAR
 (*
key
);

1261 i‡(!
	`buf_ªad
 (
buf
, &
cùhî_Àngth
, 1))

1262 
ªad_îr
;

1263 i‡(!
	`buf_ªad
 (
buf
, &
hmac_Àngth
, 1))

1264 
ªad_îr
;

1266 i‡(!
	`buf_ªad
 (
buf
, 
key
->
cùhî
, 
cùhî_Àngth
))

1267 
ªad_îr
;

1268 i‡(!
	`buf_ªad
 (
buf
, 
key
->
hmac
, 
hmac_Àngth
))

1269 
ªad_îr
;

1271 i‡(
cùhî_Àngth
 !
kt
->cùhî_Àngth || 
hmac_Àngth
 != kt->hmac_length)

1272 
key_Àn_îr
;

1276 
ªad_îr
:

1277 
	`msg
 (
D_TLS_ERRORS
, "TLS Error:ÉrrorÑeading key fromÑemote");

1280 
key_Àn_îr
:

1281 
	`msg
 (
D_TLS_ERRORS
,

1283 
kt
->
cùhî_Àngth
, kt->
hmac_Àngth
, cipher_length, hmac_length);

1285 
	}
}

1294 
uöt8_t
 *
	gn⁄˚_d©a
 = 
NULL
;

1295 c⁄° 
md_kt_t
 *
	gn⁄˚_md
 = 
NULL
;

1296 
	gn⁄˚_£¸ë_Àn
 = 0;

1300 
	$¥ng_ª£t_n⁄˚
 ()

1302 c⁄° 
size
 = 
	`md_kt_size
 (
n⁄˚_md
Ë+ 
n⁄˚_£¸ë_Àn
;

1304 i‡(!
	`ønd_byãs
 (
n⁄˚_d©a
, 
size
))

1305 
	`msg
 (
M_FATAL
, "ERROR: RandomÇumber generator cannot obtainÉntropy for PRNG");

1309 
i
;

1310 
i
 = 0; i < 
size
; ++i)

1311 
n⁄˚_d©a
[
i
] = (
uöt8_t
) i;

1314 
	}
}

1317 
	$¥ng_öô
 (c⁄° *
md_«me
, c⁄° 
n⁄˚_£¸ë_Àn_∑rm
)

1319 
	`¥ng_unöô
 ();

1320 
n⁄˚_md
 = 
md_«me
 ? 
	`md_kt_gë
 (md_«meË: 
NULL
;

1321 i‡(
n⁄˚_md
)

1323 
	`ASSERT
 (
n⁄˚_£¸ë_Àn_∑rm
 >
NONCE_SECRET_LEN_MIN
 &&Ç⁄˚_£¸ë_Àn_∑rm <
NONCE_SECRET_LEN_MAX
);

1324 
n⁄˚_£¸ë_Àn
 = 
n⁄˚_£¸ë_Àn_∑rm
;

1326 c⁄° 
size
 = 
	`md_kt_size
(
n⁄˚_md
Ë+ 
n⁄˚_£¸ë_Àn
;

1327 
	`dmsg
 (
D_CRYPTO_DEBUG
, "PRNG inô md=%†size=%d", 
	`md_kt_«me
(
n⁄˚_md
), 
size
);

1328 
n⁄˚_d©a
 = (
uöt8_t
*Ë
	`mÆloc
 (
size
);

1329 
	`check_mÆloc_ªtu∫
 (
n⁄˚_d©a
);

1330 
	`¥ng_ª£t_n⁄˚
();

1333 
	}
}

1336 
	$¥ng_unöô
 ()

1338 
	`‰ì
 (
n⁄˚_d©a
);

1339 
n⁄˚_d©a
 = 
NULL
;

1340 
n⁄˚_md
 = 
NULL
;

1341 
n⁄˚_£¸ë_Àn
 = 0;

1342 
	}
}

1345 
	$¥ng_byãs
 (
uöt8_t
 *
ouçut
, 
Àn
)

1347 
size_t
 
¥o˚s£d
 = 0;

1349 i‡(
n⁄˚_md
)

1351 c⁄° 
md_size
 = 
	`md_kt_size
 (
n⁄˚_md
);

1352 
Àn
 > 0)

1354 
ouéí
 = 0;

1355 c⁄° 
bÀn
 = 
	`mö_öt
 (
Àn
, 
md_size
);

1356 
	`md_fuŒ
(
n⁄˚_md
, 
n⁄˚_d©a
, 
md_size
 + 
n⁄˚_£¸ë_Àn
,Çonce_data);

1357 
	`mem˝y
 (
ouçut
, 
n⁄˚_d©a
, 
bÀn
);

1358 
ouçut
 +
bÀn
;

1359 
Àn
 -
bÀn
;

1362 
¥o˚s£d
 +
bÀn
;

1363 if(
¥o˚s£d
 > 
PRNG_NONCE_RESET_BYTES
) {

1364 
	`¥ng_ª£t_n⁄˚
();

1365 
¥o˚s£d
 = 0;

1370 
	`ønd_byãs
 (
ouçut
, 
Àn
);

1371 
	}
}

1375 
	$gë_øndom
()

1377 
l
;

1378 
	`¥ng_byãs
 ((*)&
l
, (l));

1379 i‡(
l
 < 0)

1380 
l
 = -l;

1381  
l
;

1382 
	}
}

1384 #i‚de‡
ENABLE_SSL


1387 
	$öô_s¶_lib
 ()

1389 
	`¸y±o_öô_lib
 ();

1390 
	}
}

1393 
	$‰ì_s¶_lib
 ()

1395 
	`¸y±o_unöô_lib
 ();

1396 
	`¥ng_unöô
();

1397 
	}
}

1406 
	$md5sum
 (
uöt8_t
 *
buf
, 
Àn
, 
n_¥öt_ch¨s
, 
gc_¨ía
 *
gc
)

1408 
uöt8_t
 
dige°
[
MD5_DIGEST_LENGTH
];

1409 c⁄° 
md_kt_t
 *
md5_kt
 = 
	`md_kt_gë
("MD5");

1411 
	`md_fuŒ
(
md5_kt
, 
buf
, 
Àn
, 
dige°
);

1413  
	`f‹m©_hex
 (
dige°
, 
MD5_DIGEST_LENGTH
, 
n_¥öt_ch¨s
, 
gc
);

1414 
	}
}

1417 
	$md5_°©e_öô
 (
md5_°©e
 *
s
)

1419 c⁄° 
md_kt_t
 *
md5_kt
 = 
	`md_kt_gë
("MD5");

1421 
	`md_˘x_öô
(&
s
->
˘x
, 
md5_kt
);

1422 
	}
}

1425 
	$md5_°©e_upd©e
 (
md5_°©e
 *
s
, *
d©a
, 
size_t
 
Àn
)

1427 
	`md_˘x_upd©e
(&
s
->
˘x
, 
d©a
, 
Àn
);

1428 
	}
}

1431 
	$md5_°©e_föÆ
 (
md5_°©e
 *
s
, 
md5_dige°
 *
out
)

1433 
	`md_˘x_föÆ
(&
s
->
˘x
, 
out
->
dige°
);

1434 
	`md_˘x_˛ónup
(&
s
->
˘x
);

1435 
	}
}

1438 
	$md5_dige°_˛ór
 (
md5_dige°
 *
dige°
)

1440 
	`CLEAR
 (*
dige°
);

1441 
	}
}

1443 
boﬁ


1444 
	$md5_dige°_deföed
 (c⁄° 
md5_dige°
 *
dige°
)

1446 
i
;

1447 
i
 = 0; i < 
MD5_DIGEST_LENGTH
; ++i)

1448 i‡(
dige°
->dige°[
i
])

1449  
åue
;

1450  
Ál£
;

1451 
	}
}

1453 
boﬁ


1454 
	$md5_dige°_equÆ
 (c⁄° 
md5_dige°
 *
d1
, c⁄° md5_dige° *
d2
)

1456  
	`memcmp
(
d1
->
dige°
, 
d2
->dige°, 
MD5_DIGEST_LENGTH
) == 0;

1457 
	}
}

	@src/openvpn/crypto.h

30 #i‚de‡
CRYPTO_H


31 
	#CRYPTO_H


	)

33 #ifde‡
ENABLE_CRYPTO


35 
	~"¸y±o_backíd.h
"

36 
	~"basic.h
"

37 
	~"buf„r.h
"

38 
	~"∑ckë_id.h
"

39 
	~"mtu.h
"

44 
	skey_ty≥


46 
uöt8_t
 
	mcùhî_Àngth
;

47 
uöt8_t
 
	mhmac_Àngth
;

48 c⁄° 
cùhî_kt_t
 *
	mcùhî
;

49 c⁄° 
md_kt_t
 *
	mdige°
;

56 
	skey


58 
uöt8_t
 
	mcùhî
[
MAX_CIPHER_KEY_LENGTH
];

60 
uöt8_t
 
	mhmac
[
MAX_HMAC_KEY_LENGTH
];

69 
	skey_˘x


71 
cùhî_˘x_t
 *
	mcùhî
;

72 
hmac_˘x_t
 *
	mhmac
;

75 
	#KEY_DIRECTION_BIDIRECTIONAL
 0

	)

76 
	#KEY_DIRECTION_NORMAL
 1

	)

77 
	#KEY_DIRECTION_INVERSE
 2

	)

83 
	skey2


85 
	mn
;

87 
key
 
	mkeys
[2];

100 
	skey_dúe˘i⁄_°©e


102 
	mout_key
;

104 
	mö_key
;

106 
	m√ed_keys
;

121 
	skey_˘x_bi


123 
key_˘x
 
	mí¸y±
;

125 
key_˘x
 
	mde¸y±
;

133 
	s¸y±o_›ti⁄s


135 
key_˘x_bi
 *
	mkey_˘x_bi
;

139 
∑ckë_id
 *
	m∑ckë_id
;

141 
∑ckë_id_≥rsi°
 *
	mpid_≥rsi°
;

146 
	#CO_PACKET_ID_LONG_FORM
 (1<<0)

	)

149 
	#CO_USE_IV
 (1<<1)

	)

153 
	#CO_IGNORE_PACKET_ID
 (1<<2)

	)

159 
	#CO_MUTE_REPLAY_WARNINGS
 (1<<3)

	)

162 
	mÊags
;

166 
	#RKF_MUST_SUCCEED
 (1<<0)

	)

167 
	#RKF_INLINE
 (1<<1)

	)

168 
ªad_key_fûe
 (
key2
 *key2, c⁄° *
fûe
, c⁄° 
Êags
);

170 
wrôe_key_fûe
 (c⁄° 
nkeys
, c⁄° *
fûíame
);

172 
ªad_∑s•hø£_hash
 (c⁄° *
∑s•hø£_fûe
,

173 c⁄° 
md_kt_t
 *
dige°
,

174 
uöt8_t
 *
ouçut
,

175 
Àn
);

177 
gíî©e_key_øndom
 (
key
 *key, c⁄° 
key_ty≥
 *
kt
);

179 
check_ª∂ay_iv_c⁄si°ícy
(c⁄° 
key_ty≥
 *
kt
, 
boﬁ
 
∑ckë_id
, boﬁ 
u£_iv
);

181 
boﬁ
 
check_key
 (
key
 *key, c⁄° 
key_ty≥
 *
kt
);

183 
fixup_key
 (
key
 *key, c⁄° 
key_ty≥
 *
kt
);

185 
boﬁ
 
wrôe_key
 (c⁄° 
key
 *key, c⁄° 
key_ty≥
 *
kt
,

186 
buf„r
 *
buf
);

188 
ªad_key
 (
key
 *key, c⁄° 
key_ty≥
 *
kt
, 
buf„r
 *
buf
);

190 
öô_key_ty≥
 (
key_ty≥
 *
kt
, c⁄° *
cùhî«me
,

191 
boﬁ
 
cùhî«me_deföed
, c⁄° *
auth«me
, boﬁ 
auth«me_deföed
,

192 
keysize
, 
boﬁ
 
cfb_ofb_Ælowed
, boﬁ 
w¨n
);

198 
öô_key_˘x
 (
key_˘x
 *
˘x
, 
key
 *key,

199 c⁄° 
key_ty≥
 *
kt
, 
íc
,

200 c⁄° *
¥efix
);

202 
‰ì_key_˘x
 (
key_˘x
 *
˘x
);

204 
‰ì_key_˘x_bi
 (
key_˘x_bi
 *
˘x
);

238 
›ív≤_í¸y±
 (
buf„r
 *
buf
, buf„∏
w‹k
,

239 c⁄° 
¸y±o_›ti⁄s
 *
›t
,

240 c⁄° 
‰ame
* frame);

274 
boﬁ
 
›ív≤_de¸y±
 (
buf„r
 *
buf
, buf„∏
w‹k
,

275 c⁄° 
¸y±o_›ti⁄s
 *
›t
,

276 c⁄° 
‰ame
* frame);

280 
¸y±o_adju°_‰ame_∑ømëîs
(
‰ame
 *frame,

281 c⁄° 
key_ty≥
* 
kt
,

282 
boﬁ
 
cùhî_deföed
,

283 
boﬁ
 
u£_iv
,

284 
boﬁ
 
∑ckë_id
,

285 
boﬁ
 
∑ckë_id_l⁄g_f‹m
);

289 
	#NONCE_SECRET_LEN_MIN
 16

	)

292 
	#NONCE_SECRET_LEN_MAX
 64

	)

295 
	#PRNG_NONCE_RESET_BYTES
 1024

	)

304 
¥ng_öô
 (c⁄° *
md_«me
, c⁄° 
n⁄˚_£¸ë_Àn_∑rm
);

321 
¥ng_byãs
 (
uöt8_t
 *
ouçut
, 
Àn
);

323 
¥ng_unöô
 ();

325 
ã°_¸y±o
 (c⁄° 
¸y±o_›ti⁄s
 *
co
, 
‰ame
* 
f
);

330 
key_dúe˘i⁄_°©e_öô
 (
key_dúe˘i⁄_°©e
 *
kds
, 
key_dúe˘i⁄
);

332 
vîify_fix_key2
 (
key2
 *key2, c⁄° 
key_ty≥
 *
kt
, c⁄° *
sh¨ed_£¸ë_fûe
);

334 
mu°_have_n_keys
 (c⁄° *
fûíame
, c⁄° *
›ti⁄
, c⁄° 
key2
 *key2, 
n
);

336 
ascii2keydúe˘i⁄
 (
msgÀvñ
, c⁄° *
°r
);

338 c⁄° *
keydúe˘i⁄2ascii
 (
kd
, 
boﬁ
 
ªmŸe
);

341 
key2_¥öt
 (c⁄° 
key2
* 
k
,

342 c⁄° 
key_ty≥
 *
kt
,

343 c⁄° * 
¥efix0
,

344 c⁄° * 
¥efix1
);

346 #ifde‡
ENABLE_SSL


348 
	#GHK_INLINE
 (1<<0)

	)

349 
gë_és_h™dshake_key
 (c⁄° 
key_ty≥
 *key_type,

350 
key_˘x_bi
 *
˘x
,

351 c⁄° *
∑s•hø£_fûe
,

352 c⁄° 
key_dúe˘i⁄
,

353 c⁄° 
Êags
);

357 
öô_s¶_lib
 ();

358 
‰ì_s¶_lib
 ();

366 
	smd5_°©e
 {

367 
md_˘x_t
 
	m˘x
;

370 
	smd5_dige°
 {

371 
uöt8_t
 
	mdige°
 [
MD5_DIGEST_LENGTH
];

374 c⁄° *
md5sum
(
uöt8_t
 *
buf
, 
Àn
, 
n_¥öt_ch¨s
, 
gc_¨ía
 *
gc
);

375 
md5_°©e_öô
 (
md5_°©e
 *
s
);

376 
md5_°©e_upd©e
 (
md5_°©e
 *
s
, *
d©a
, 
size_t
 
Àn
);

377 
md5_°©e_föÆ
 (
md5_°©e
 *
s
, 
md5_dige°
 *
out
);

378 
md5_dige°_˛ór
 (
md5_dige°
 *
dige°
);

379 
boﬁ
 
md5_dige°_deföed
 (c⁄° 
md5_dige°
 *
dige°
);

380 
boﬁ
 
md5_dige°_equÆ
 (c⁄° 
md5_dige°
 *
d1
, c⁄° md5_dige° *
d2
);

386 
ölöe
 
boﬁ


387 
	$key_˘x_bi_deföed
(c⁄° 
key_˘x_bi
* 
key
)

389  
key
->
í¸y±
.
cùhî
 || key->í¸y±.
hmac
 || key->
de¸y±
.cipher || key->decrypt.hmac;

390 
	}
}

	@src/openvpn/crypto_backend.h

30 #i‚de‡
CRYPTO_BACKEND_H_


31 
	#CRYPTO_BACKEND_H_


	)

33 #ifde‡
ENABLE_CRYPTO_OPENSSL


34 
	~"¸y±o_›ís¶.h
"

36 #ifde‡
ENABLE_CRYPTO_POLARSSL


37 
	~"¸y±o_pﬁ¨s¶.h
"

39 
	~"basic.h
"

46 
¸y±o_öô_lib
 ();

48 
¸y±o_unöô_lib
 ();

50 
¸y±o_˛ór_îr‹
 ();

55 
¸y±o_öô_lib_ígöe
 (c⁄° *
ígöe_«me
);

57 #ifde‡
DMALLOC


63 
¸y±o_öô_dmÆloc
 ();

70 c⁄° * 
å™¶©e_cùhî_«me_‰om_›ív≤
 (c⁄° *
cùhî_«me
);

76 c⁄° * 
å™¶©e_cùhî_«me_‰om_›ív≤
 (c⁄° *
cùhî_«me
);

78 
show_avaûabÀ_cùhîs
 ();

80 
show_avaûabÀ_dige°s
 ();

82 
show_avaûabÀ_ígöes
 ();

102 
ønd_byãs
 (
uöt8_t
 *
ouçut
, 
Àn
);

119 
key_des_num_cblocks
 (c⁄° 
cùhî_kt_t
 *
kt
);

130 
boﬁ
 
key_des_check
 (
uöt8_t
 *
key
, 
key_Àn
, 
ndc
);

139 
key_des_fixup
 (
uöt8_t
 *
key
, 
key_Àn
, 
ndc
);

148 
cùhî_des_í¸y±_ecb
 (c⁄° 
key
[
DES_KEY_LENGTH
],

149 
§c
[
DES_KEY_LENGTH
],

150 
d°
[
DES_KEY_LENGTH
]);

169 
	#MAX_CIPHER_KEY_LENGTH
 64

	)

182 c⁄° 
cùhî_kt_t
 * 
cùhî_kt_gë
 (c⁄° *
cùhî«me
);

191 c⁄° * 
cùhî_kt_«me
 (c⁄° 
cùhî_kt_t
 *
cùhî_kt
);

201 
cùhî_kt_key_size
 (c⁄° 
cùhî_kt_t
 *
cùhî_kt
);

212 
cùhî_kt_iv_size
 (c⁄° 
cùhî_kt_t
 *
cùhî_kt
);

221 
cùhî_kt_block_size
 (c⁄° 
cùhî_kt_t
 *
cùhî_kt
);

231 
cùhî_kt_mode
 (c⁄° 
cùhî_kt_t
 *
cùhî_kt
);

240 
boﬁ
 
	$cùhî_kt_mode_cbc
(c⁄° 
cùhî_kt_t
 *
cùhî
)

241 
	`__©åibuã__
((
n⁄nuŒ
));

250 
boﬁ
 
	$cùhî_kt_mode_ofb_cfb
(c⁄° 
cùhî_kt_t
 *
cùhî
)

251 
	`__©åibuã__
((
n⁄nuŒ
));

270 
	`cùhî_˘x_öô
 (
cùhî_˘x_t
 *
˘x
, 
uöt8_t
 *
key
, 
key_Àn
,

271 c⁄° 
cùhî_kt_t
 *
kt
, 
íc
);

278 
	`cùhî_˘x_˛ónup
 (
cùhî_˘x_t
 *
˘x
);

289 
	`cùhî_˘x_iv_Àngth
 (c⁄° 
cùhî_˘x_t
 *
˘x
);

298 
	`cùhî_˘x_block_size
 (c⁄° 
cùhî_˘x_t
 *
˘x
);

308 
	`cùhî_˘x_mode
 (c⁄° 
cùhî_˘x_t
 *
˘x
);

317 c⁄° 
cùhî_kt_t
 *
	$cùhî_˘x_gë_cùhî_kt
 (c⁄° 
cùhî_˘x_t
 *
˘x
)

318 
	`__©åibuã__
((
n⁄nuŒ
));

329 
	`cùhî_˘x_ª£t
 (
cùhî_˘x_t
 *
˘x
, 
uöt8_t
 *
iv_buf
);

348 
	`cùhî_˘x_upd©e
 (
cùhî_˘x_t
 *
˘x
, 
uöt8_t
 *
d°
, *
d°_Àn
,

349 
uöt8_t
 *
§c
, 
§c_Àn
);

361 
	`cùhî_˘x_föÆ
 (
cùhî_˘x_t
 *
˘x
, 
uöt8_t
 *
d°
, *
d°_Àn
);

376 
	#MAX_HMAC_KEY_LENGTH
 64

	)

389 c⁄° 
md_kt_t
 * 
	`md_kt_gë
 (c⁄° *
dige°
);

399 c⁄° * 
	`md_kt_«me
 (c⁄° 
md_kt_t
 *
kt
);

408 
	`md_kt_size
 (c⁄° 
md_kt_t
 *
kt
);

427 
	`md_fuŒ
 (c⁄° 
md_kt_t
 *
kt
, c⁄° 
uöt8_t
 *
§c
, 
§c_Àn
, uöt8_à*
d°
);

435 
	`md_˘x_öô
 (
md_˘x_t
 *
˘x
, c⁄° 
md_kt_t
 *
kt
);

442 
	`md_˘x_˛ónup
(
md_˘x_t
 *
˘x
);

451 
	`md_˘x_size
 (c⁄° 
md_˘x_t
 *
˘x
);

460 
	`md_˘x_upd©e
 (
md_˘x_t
 *
˘x
, c⁄° 
uöt8_t
 *
§c
, 
§c_Àn
);

468 
	`md_˘x_föÆ
 (
md_˘x_t
 *
˘x
, 
uöt8_t
 *
d°
);

487 
	`hmac_˘x_öô
 (
hmac_˘x_t
 *
˘x
, c⁄° 
uöt8_t
 *
key
, 
key_Àngth
,

488 c⁄° 
md_kt_t
 *
kt
);

495 
	`hmac_˘x_˛ónup
(
hmac_˘x_t
 *
˘x
);

504 
	`hmac_˘x_size
 (c⁄° 
hmac_˘x_t
 *
˘x
);

511 
	`hmac_˘x_ª£t
 (
hmac_˘x_t
 *
˘x
);

520 
	`hmac_˘x_upd©e
 (
hmac_˘x_t
 *
˘x
, c⁄° 
uöt8_t
 *
§c
, 
§c_Àn
);

528 
	`hmac_˘x_föÆ
 (
hmac_˘x_t
 *
˘x
, 
uöt8_t
 *
d°
);

	@src/openvpn/crypto_openssl.c

30 #ifde‡
HAVE_CONFIG_H


31 
	~"c⁄fig.h
"

32 #ñi‡
deföed
(
_MSC_VER
)

33 
	~"c⁄fig-msvc.h
"

36 
	~"syshód.h
"

38 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_CRYPTO_OPENSSL
)

40 
	~"basic.h
"

41 
	~"buf„r.h
"

42 
	~"öãgî.h
"

43 
	~"¸y±o.h
"

44 
	~"¸y±o_backíd.h
"

45 
	~<›ís¶/obje˘s.h
>

46 
	~<›ís¶/evp.h
>

47 
	~<›ís¶/des.h
>

53 #i‡
MAX_CIPHER_KEY_LENGTH
 < 
EVP_MAX_KEY_LENGTH


54 #w¨nög 
Some
 
O≥nSSL
 
EVP
 
cùhîs
 
now
 
suµ‹t
 
key
 
Àngths
 
gª©î
 
th™
 
MAX_CIPHER_KEY_LENGTH
 -- 
c⁄sidî
 
ö¸ósög
 MAX_CIPHER_KEY_LENGTH

57 #i‡
MAX_HMAC_KEY_LENGTH
 < 
EVP_MAX_MD_SIZE


58 #w¨nög 
Some
 
O≥nSSL
 
HMAC
 
mesßge
 
dige°s
 
now
 
suµ‹t
 
key
 
Àngths
 
gª©î
 
th™
 
MAX_HMAC_KEY_LENGTH
 -- 
c⁄sidî
 
ö¸ósög
 MAX_HMAC_KEY_LENGTH

68 #i‡
SSLEAY_VERSION_NUMBER
 < 0x00907000L

71 #unde‡
EVP_CIPHER_mode


72 
	#EVP_CIPHER_mode
(
e
Ë((”)->
Êags
Ë& 
EVP_CIPH_MODE
)

	)

74 
	#DES_cblock
 
des_cblock


	)

75 
	#DES_is_wók_key
 
des_is_wók_key


	)

76 
	#DES_check_key_∑rôy
 
des_check_key_∑rôy


	)

77 
	#DES_£t_odd_∑rôy
 
des_£t_odd_∑rôy


	)

79 
	#HMAC_CTX_öô
(
˘x
Ë
	`CLEAR
 (*˘x)

	)

80 
	#HMAC_Inô_ex
(
˘x
,
£c
,
Àn
,
md
,
im∂
Ë
	`HMAC_Inô
(˘x, sec,Üí, md)

	)

81 
	#HMAC_CTX_˛ónup
(
˘x
Ë
	`HMAC_˛ónup
(˘x)

	)

82 
	#EVP_MD_CTX_˛ónup
(
md
Ë
	`CLEAR
 (*md)

	)

84 
	#INFO_CALLBACK_SSL_CONST


	)

88 #i‚de‡
EVP_CIPHER_«me


89 
	#EVP_CIPHER_«me
(
e
Ë
	`OBJ_nid2¢
(
	`EVP_CIPHER_nid
”))

	)

92 #i‚de‡
EVP_MD_«me


93 
	#EVP_MD_«me
(
e
Ë
	`OBJ_nid2¢
(
	`EVP_MD_ty≥
”))

	)

96 #i‡
HAVE_OPENSSL_ENGINE


97 
	~<›ís¶/ígöe.h
>

99 
boﬁ
 
	gígöe_öôülized
 = 
Ál£
;

101 
ENGINE
 *
	gígöe_≥rsi°
 = 
NULL
;

104 
ENGINE
 *

105 
	$åy_lﬂd_ígöe
 (c⁄° *
ígöe
)

107 
ENGINE
 *
e
 = 
	`ENGINE_by_id
 ("dynamic");

108 i‡(
e
)

110 i‡(!
	`ENGINE_˘æ_cmd_°rög
 (
e
, "SO_PATH", 
ígöe
, 0)

111 || !
	`ENGINE_˘æ_cmd_°rög
 (
e
, "LOAD", 
NULL
, 0))

113 
	`ENGINE_‰ì
 (
e
);

114 
e
 = 
NULL
;

117  
e
;

118 
	}
}

120 
ENGINE
 *

121 
	$£tup_ígöe
 (c⁄° *
ígöe
)

123 
ENGINE
 *
e
 = 
NULL
;

125 
	`ENGINE_lﬂd_buûtö_ígöes
 ();

127 i‡(
ígöe
)

129 i‡(
	`°rcmp
 (
ígöe
, "auto") == 0)

131 
	`msg
 (
M_INFO
, "Initializing OpenSSLáutoÉngine support");

132 
	`ENGINE_ªgi°î_Æl_com∂ëe
 ();

133  
NULL
;

135 i‡((
e
 = 
	`ENGINE_by_id
 (
ígöe
)Ë=
NULL


136 && (
e
 = 
	`åy_lﬂd_ígöe
 (
ígöe
)Ë=
NULL
)

138 
	`msg
 (
M_FATAL
, "O≥nSSLÉº‹: c™nŸÜﬂdÉngöê'%s'", 
ígöe
);

141 i‡(!
	`ENGINE_£t_deÁu…
 (
e
, 
ENGINE_METHOD_ALL
))

143 
	`msg
 (
M_FATAL
, "OpenSSLÉrror: ENGINE_set_default failed onÉngine '%s'",

144 
ígöe
);

147 
	`msg
 (
M_INFO
, "Initializing OpenSSL support forÉngine '%s'",

148 
	`ENGINE_gë_id
 (
e
));

150  
e
;

151 
	}
}

156 
	$¸y±o_öô_lib_ígöe
 (c⁄° *
ígöe_«me
)

158 #i‡
HAVE_OPENSSL_ENGINE


159 i‡(!
ígöe_öôülized
)

161 
	`ASSERT
 (
ígöe_«me
);

162 
	`ASSERT
 (!
ígöe_≥rsi°
);

163 
ígöe_≥rsi°
 = 
	`£tup_ígöe
 (
ígöe_«me
);

164 
ígöe_öôülized
 = 
åue
;

167 
	`msg
 (
M_WARN
, "Note: OpenSSL hardware cryptoÉngine functionality isÇotávailable");

169 
	}
}

178 
	$¸y±o_öô_lib
 ()

180 #i‚de‡
ENABLE_SSL


182 #i‚de‡
ENABLE_SMALL


183 
	`ERR_lﬂd_¸y±o_°rögs
 ();

185 
	`O≥nSSL_add_Æl_Æg‹ôhms
 ();

194 #ifde‡
CRYPTO_MDEBUG


195 
	`CRYPTO_mem_˘æ
(
CRYPTO_MEM_CHECK_ON
);

197 
	}
}

200 
	$¸y±o_unöô_lib
 ()

202 #i‚de‡
ENABLE_SSL


204 
	`EVP_˛ónup
 ();

205 #i‚de‡
ENABLE_SMALL


206 
	`ERR_‰ì_°rögs
 ();

210 #ifde‡
CRYPTO_MDEBUG


211 
FILE
* 
Â
 = 
	`f›í
 ("sdlog", "w");

212 
	`ASSERT
 (
Â
);

213 
	`CRYPTO_mem_Àaks_Â
 (
Â
);

214 
	`f˛o£
 (
Â
);

217 #i‡
HAVE_OPENSSL_ENGINE


218 i‡(
ígöe_öôülized
)

220 
	`ENGINE_˛ónup
 ();

221 
ígöe_≥rsi°
 = 
NULL
;

222 
ígöe_öôülized
 = 
Ál£
;

225 
	}
}

228 
	$¸y±o_˛ór_îr‹
 ()

230 
	`ERR_˛ór_îr‹
 ();

231 
	}
}

241 #ifde‡
DMALLOC


243 
	$¸y±o_mÆloc
 (
size_t
 
size
, c⁄° *
fûe
, 
löe
)

245  
	`dmÆloc_mÆloc
(
fûe
, 
löe
, 
size
, 
DMALLOC_FUNC_MALLOC
, 0, 0);

246 
	}
}

249 
	$¸y±o_ªÆloc
 (*
±r
, 
size_t
 
size
, c⁄° *
fûe
, 
löe
)

251  
	`dmÆloc_ªÆloc
(
fûe
, 
löe
, 
±r
, 
size
, 
DMALLOC_FUNC_REALLOC
, 0);

252 
	}
}

255 
	$¸y±o_‰ì
 (*
±r
)

257 
	`dmÆloc_‰ì
 (
__FILE__
, 
__LINE__
, 
±r
, 
DMALLOC_FUNC_FREE
);

258 
	}
}

261 
	$¸y±o_öô_dmÆloc
 ()

263 
	`CRYPTO_£t_mem_ex_fun˘i⁄s
 (
¸y±o_mÆloc
,

264 
¸y±o_ªÆloc
,

265 
¸y±o_‰ì
);

266 
	}
}

270 
	$å™¶©e_cùhî_«me_‰om_›ív≤
 (c⁄° *
cùhî_«me
) {

272  
cùhî_«me
;

273 
	}
}

276 
	$å™¶©e_cùhî_«me_to_›ív≤
 (c⁄° *
cùhî_«me
) {

278  
cùhî_«me
;

279 
	}
}

282 
	$show_avaûabÀ_cùhîs
 ()

284 
nid
;

286 #i‚de‡
ENABLE_SMALL


287 
	`¥ötf
 ("The following ciphersánd cipher modesáreávailable\n"

288 "f‹ u£ wôh " 
PACKAGE_NAME
 ". Each cipher shown below may be\n"

295 
nid
 = 0;Çid < 10000; ++nid)

297 c⁄° 
EVP_CIPHER
 *
cùhî
 = 
	`EVP_gë_cùhîbynid
 (
nid
);

298 i‡(
cùhî
)

300 i‡(
	`cùhî_kt_mode_cbc
(
cùhî
)

301 #ifde‡
ENABLE_OFB_CFB_MODE


302 || 
	`cùhî_kt_mode_ofb_cfb
(
cùhî
)

306 c⁄° *
v¨_key_size
 =

307 (
	`EVP_CIPHER_Êags
 (
cùhî
Ë& 
EVP_CIPH_VARIABLE_LENGTH
) ?

309 c⁄° *
s¶_⁄ly
 = 
	`cùhî_kt_mode_ofb_cfb
(
cùhî
) ?

312 
	`¥ötf
 ("%†%d bô deÁu… key (%s)%s\n", 
	`OBJ_nid2¢
 (
nid
),

313 
	`EVP_CIPHER_key_Àngth
 (
cùhî
Ë* 8, 
v¨_key_size
,

314 
s¶_⁄ly
);

318 
	`¥ötf
 ("\n");

319 
	}
}

322 
	$show_avaûabÀ_dige°s
 ()

324 
nid
;

326 #i‚de‡
ENABLE_SMALL


327 
	`¥ötf
 ("The following message digestsáreávailable for use with\n"

328 
PACKAGE_NAME
 ". A message digest is used in conjunction with\n"

334 
nid
 = 0;Çid < 10000; ++nid)

336 c⁄° 
EVP_MD
 *
dige°
 = 
	`EVP_gë_dige°bynid
 (
nid
);

337 i‡(
dige°
)

339 
	`¥ötf
 ("%s %d bit digest size\n",

340 
	`OBJ_nid2¢
 (
nid
), 
	`EVP_MD_size
 (
dige°
) * 8);

343 
	`¥ötf
 ("\n");

344 
	}
}

347 
	$show_avaûabÀ_ígöes
 ()

349 #i‡
HAVE_OPENSSL_ENGINE


350 
ENGINE
 *
e
;

352 
	`¥ötf
 ("OpenSSL Crypto Engines\n\n");

354 
	`ENGINE_lﬂd_buûtö_ígöes
 ();

356 
e
 = 
	`ENGINE_gë_fú°
 ();

357 
e
)

359 
	`¥ötf
 ("%s [%s]\n",

360 
	`ENGINE_gë_«me
 (
e
),

361 
	`ENGINE_gë_id
 (
e
));

362 
e
 = 
	`ENGINE_gë_√xt
 (e);

364 
	`ENGINE_˛ónup
 ();

366 
	`¥ötf
 ("Sorry, OpenSSL hardware cryptoÉngine functionality isÇotávailable.\n");

368 
	}
}

379 
	$ønd_byãs
(
uöt8_t
 *
ouçut
, 
Àn
)

381  
	`RAND_byãs
 (
ouçut
, 
Àn
);

382 
	}
}

392 
	$key_des_num_cblocks
 (c⁄° 
EVP_CIPHER
 *
kt
)

394 
ªt
 = 0;

395 c⁄° *
«me
 = 
	`OBJ_nid2¢
 (
	`EVP_CIPHER_nid
 (
kt
));

396 i‡(
«me
)

398 i‡(!
	`°∫cmp
 (
«me
, "DES-", 4))

400 
ªt
 = 
	`EVP_CIPHER_key_Àngth
 (
kt
Ë/  (
DES_cblock
);

402 i‡(!
	`°∫cmp
 (
«me
, "DESX-", 5))

404 
ªt
 = 1;

407 
	`dmsg
 (
D_CRYPTO_DEBUG
, "CRYPTO INFO:Ç_DES_cblocks=%d", 
ªt
);

408  
ªt
;

409 
	}
}

411 
boﬁ


412 
	$key_des_check
 (
uöt8_t
 *
key
, 
key_Àn
, 
ndc
)

414 
i
;

415 
buf„r
 
b
;

417 
	`buf_£t_ªad
 (&
b
, 
key
, 
key_Àn
);

419 
i
 = 0; i < 
ndc
; ++i)

421 
DES_cblock
 *
dc
 = (DES_cblock*Ë
	`buf_ªad_Æloc
 (&
b
,  (DES_cblock));

422 i‡(!
dc
)

424 
	`msg
 (
D_CRYPT_ERRORS
, "CRYPTO INFO: check_key_DES: insufficient key material");

425 
îr
;

427 i‡(
	`DES_is_wók_key
(
dc
))

429 
	`msg
 (
D_CRYPT_ERRORS
, "CRYPTO INFO: check_key_DES: weak key detected");

430 
îr
;

432 i‡(!
	`DES_check_key_∑rôy
 (
dc
))

434 
	`msg
 (
D_CRYPT_ERRORS
, "CRYPTO INFO: check_key_DES: badÖarity detected");

435 
îr
;

438  
åue
;

440 
îr
:

441 
	`ERR_˛ór_îr‹
 ();

442  
Ál£
;

443 
	}
}

446 
	$key_des_fixup
 (
uöt8_t
 *
key
, 
key_Àn
, 
ndc
)

448 
i
;

449 
buf„r
 
b
;

451 
	`buf_£t_ªad
 (&
b
, 
key
, 
key_Àn
);

452 
i
 = 0; i < 
ndc
; ++i)

454 
DES_cblock
 *
dc
 = (DES_cblock*Ë
	`buf_ªad_Æloc
(&
b
, (DES_cblock));

455 i‡(!
dc
)

457 
	`msg
 (
D_CRYPT_ERRORS
, "CRYPTO INFO: fixup_key_DES: insufficient key material");

458 
	`ERR_˛ór_îr‹
 ();

461 
	`DES_£t_odd_∑rôy
 (
dc
);

463 
	}
}

473 c⁄° 
EVP_CIPHER
 *

474 
	$cùhî_kt_gë
 (c⁄° *
cùhî«me
)

476 c⁄° 
EVP_CIPHER
 *
cùhî
 = 
NULL
;

478 
	`ASSERT
 (
cùhî«me
);

480 
cùhî
 = 
	`EVP_gë_cùhîby«me
 (
cùhî«me
);

482 i‡(
NULL
 =
cùhî
)

483 
	`msg
 (
M_SSLERR
, "Cùhîálg‹ôhm '%s'ÇŸ found", 
cùhî«me
);

485 i‡(
	`EVP_CIPHER_key_Àngth
 (
cùhî
Ë> 
MAX_CIPHER_KEY_LENGTH
)

486 
	`msg
 (
M_FATAL
, "Cùhîálg‹ôhm '%s' u£†®deÁu… key sizê(%d byãsËwhich i†œrgîÅh™ " 
PACKAGE_NAME
 "'s current maximum key size (%d bytes)",

487 
cùhî«me
,

488 
	`EVP_CIPHER_key_Àngth
 (
cùhî
),

489 
MAX_CIPHER_KEY_LENGTH
);

491  
cùhî
;

492 
	}
}

495 
	$cùhî_kt_«me
 (c⁄° 
EVP_CIPHER
 *
cùhî_kt
)

497 i‡(
NULL
 =
cùhî_kt
)

499  
	`EVP_CIPHER_«me
 (
cùhî_kt
);

500 
	}
}

503 
	$cùhî_kt_key_size
 (c⁄° 
EVP_CIPHER
 *
cùhî_kt
)

505  
	`EVP_CIPHER_key_Àngth
 (
cùhî_kt
);

506 
	}
}

509 
	$cùhî_kt_iv_size
 (c⁄° 
EVP_CIPHER
 *
cùhî_kt
)

511  
	`EVP_CIPHER_iv_Àngth
 (
cùhî_kt
);

512 
	}
}

515 
	$cùhî_kt_block_size
 (c⁄° 
EVP_CIPHER
 *
cùhî_kt
)

517  
	`EVP_CIPHER_block_size
 (
cùhî_kt
);

518 
	}
}

521 
	$cùhî_kt_mode
 (c⁄° 
EVP_CIPHER
 *
cùhî_kt
)

523 
	`ASSERT
(
NULL
 !
cùhî_kt
);

524  
	`EVP_CIPHER_mode
 (
cùhî_kt
);

525 
	}
}

527 
boﬁ


528 
	$cùhî_kt_mode_cbc
(c⁄° 
cùhî_kt_t
 *
cùhî
)

530  
cùhî
 && 
	`cùhî_kt_mode
(cùhîË=
OPENVPN_MODE_CBC


531 #ifde‡
EVP_CIPH_FLAG_AEAD_CIPHER


533 && !(
	`EVP_CIPHER_Êags
(
cùhî
Ë& 
EVP_CIPH_FLAG_AEAD_CIPHER
)

536 
	}
}

538 
boﬁ


539 
	$cùhî_kt_mode_ofb_cfb
(c⁄° 
cùhî_kt_t
 *
cùhî
)

541  
cùhî
 && (
	`cùhî_kt_mode
(cùhîË=
OPENVPN_MODE_OFB
 ||

542 
	`cùhî_kt_mode
(
cùhî
Ë=
OPENVPN_MODE_CFB
)

543 #ifde‡
EVP_CIPH_FLAG_AEAD_CIPHER


545 && !(
	`EVP_CIPHER_Êags
(
cùhî
Ë& 
EVP_CIPH_FLAG_AEAD_CIPHER
)

548 
	}
}

558 
	$cùhî_˘x_öô
 (
EVP_CIPHER_CTX
 *
˘x
, 
uöt8_t
 *
key
, 
key_Àn
,

559 c⁄° 
EVP_CIPHER
 *
kt
, 
íc
)

561 
	`ASSERT
(
NULL
 !
kt
 && NULL !
˘x
);

563 
	`CLEAR
 (*
˘x
);

565 
	`EVP_CIPHER_CTX_öô
 (
˘x
);

566 i‡(!
	`EVP_CùhîInô
 (
˘x
, 
kt
, 
NULL
, NULL, 
íc
))

567 
	`msg
 (
M_SSLERR
, "EVP cipher init #1");

568 #ifde‡
HAVE_EVP_CIPHER_CTX_SET_KEY_LENGTH


569 i‡(!
	`EVP_CIPHER_CTX_£t_key_Àngth
 (
˘x
, 
key_Àn
))

570 
	`msg
 (
M_SSLERR
, "EVP set key size");

572 i‡(!
	`EVP_CùhîInô
 (
˘x
, 
NULL
, 
key
, NULL, 
íc
))

573 
	`msg
 (
M_SSLERR
, "EVP cipher init #2");

576 
	`ASSERT
 (
	`EVP_CIPHER_CTX_key_Àngth
 (
˘x
Ë<
key_Àn
);

577 
	}
}

580 
	$cùhî_˘x_˛ónup
 (
EVP_CIPHER_CTX
 *
˘x
)

582 
	`EVP_CIPHER_CTX_˛ónup
 (
˘x
);

583 
	}
}

586 
	$cùhî_˘x_iv_Àngth
 (c⁄° 
EVP_CIPHER_CTX
 *
˘x
)

588  
	`EVP_CIPHER_CTX_iv_Àngth
 (
˘x
);

589 
	}
}

592 
	$cùhî_˘x_block_size
(c⁄° 
EVP_CIPHER_CTX
 *
˘x
)

594  
	`EVP_CIPHER_CTX_block_size
 (
˘x
);

595 
	}
}

598 
	$cùhî_˘x_mode
 (c⁄° 
EVP_CIPHER_CTX
 *
˘x
)

600  
	`EVP_CIPHER_CTX_mode
 (
˘x
);

601 
	}
}

603 c⁄° 
cùhî_kt_t
 *

604 
	$cùhî_˘x_gë_cùhî_kt
 (c⁄° 
cùhî_˘x_t
 *
˘x
)

606  
	`EVP_CIPHER_CTX_cùhî
(
˘x
);

607 
	}
}

611 
	$cùhî_˘x_ª£t
 (
EVP_CIPHER_CTX
 *
˘x
, 
uöt8_t
 *
iv_buf
)

613  
	`EVP_CùhîInô
 (
˘x
, 
NULL
, NULL, 
iv_buf
, -1);

614 
	}
}

617 
	$cùhî_˘x_upd©e
 (
EVP_CIPHER_CTX
 *
˘x
, 
uöt8_t
 *
d°
, *
d°_Àn
,

618 
uöt8_t
 *
§c
, 
§c_Àn
)

620  
	`EVP_CùhîUpd©e
 (
˘x
, 
d°
, 
d°_Àn
, 
§c
, 
§c_Àn
);

621 
	}
}

624 
	$cùhî_˘x_föÆ
 (
EVP_CIPHER_CTX
 *
˘x
, 
uöt8_t
 *
d°
, *
d°_Àn
)

626  
	`EVP_CùhîFöÆ
 (
˘x
, 
d°
, 
d°_Àn
);

627 
	}
}

631 
	$cùhî_des_í¸y±_ecb
 (c⁄° 
key
[
DES_KEY_LENGTH
],

632 *
§c
,

633 *
d°
)

635 
DES_key_scheduÀ
 
sched
;

637 
	`DES_£t_key_unchecked
((
DES_cblock
*)
key
, &
sched
);

638 
	`DES_ecb_í¸y±
((
DES_cblock
 *)
§c
, (DES_cblock *)
d°
, &
sched
, 
DES_ENCRYPT
);

639 
	}
}

648 c⁄° 
EVP_MD
 *

649 
	$md_kt_gë
 (c⁄° *
dige°
)

651 c⁄° 
EVP_MD
 *
md
 = 
NULL
;

652 
	`ASSERT
 (
dige°
);

653 
md
 = 
	`EVP_gë_dige°by«me
 (
dige°
);

654 i‡(!
md
)

655 
	`msg
 (
M_SSLERR
, "Mesßgêhashálg‹ôhm '%s'ÇŸ found", 
dige°
);

656 i‡(
	`EVP_MD_size
 (
md
Ë> 
MAX_HMAC_KEY_LENGTH
)

657 
	`msg
 (
M_FATAL
, "Mesßgêhashálg‹ôhm '%s' u£†®deÁu… hash sizê(%d byãsËwhich i†œrgîÅh™ " 
PACKAGE_NAME
 "'s current maximum hash size (%d bytes)",

658 
dige°
,

659 
	`EVP_MD_size
 (
md
),

660 
MAX_HMAC_KEY_LENGTH
);

661  
md
;

662 
	}
}

665 
	$md_kt_«me
 (c⁄° 
EVP_MD
 *
kt
)

667 i‡(
NULL
 =
kt
)

669  
	`EVP_MD_«me
 (
kt
);

670 
	}
}

673 
	$md_kt_size
 (c⁄° 
EVP_MD
 *
kt
)

675  
	`EVP_MD_size
(
kt
);

676 
	}
}

686 
	$md_fuŒ
 (c⁄° 
EVP_MD
 *
kt
, c⁄° 
uöt8_t
 *
§c
, 
§c_Àn
, uöt8_à*
d°
)

688 
ö_md_Àn
 = 0;

690  
	`EVP_Dige°
(
§c
, 
§c_Àn
, 
d°
, &
ö_md_Àn
, 
kt
, 
NULL
);

691 
	}
}

694 
	$md_˘x_öô
 (
EVP_MD_CTX
 *
˘x
, c⁄° 
EVP_MD
 *
kt
)

696 
	`ASSERT
(
NULL
 !
˘x
 && NULL !
kt
);

698 
	`CLEAR
 (*
˘x
);

700 
	`EVP_MD_CTX_öô
 (
˘x
);

701 
	`EVP_Dige°Inô
(
˘x
, 
kt
);

702 
	}
}

705 
	$md_˘x_˛ónup
(
EVP_MD_CTX
 *
˘x
)

707 
	`EVP_MD_CTX_˛ónup
(
˘x
);

708 
	}
}

711 
	$md_˘x_size
 (c⁄° 
EVP_MD_CTX
 *
˘x
)

713  
	`EVP_MD_CTX_size
(
˘x
);

714 
	}
}

717 
	$md_˘x_upd©e
 (
EVP_MD_CTX
 *
˘x
, c⁄° 
uöt8_t
 *
§c
, 
§c_Àn
)

719 
	`EVP_Dige°Upd©e
(
˘x
, 
§c
, 
§c_Àn
);

720 
	}
}

723 
	$md_˘x_föÆ
 (
EVP_MD_CTX
 *
˘x
, 
uöt8_t
 *
d°
)

725 
ö_md_Àn
 = 0;

727 
	`EVP_Dige°FöÆ
(
˘x
, 
d°
, &
ö_md_Àn
);

728 
	}
}

739 
	$hmac_˘x_öô
 (
HMAC_CTX
 *
˘x
, c⁄° 
uöt8_t
 *
key
, 
key_Àn
,

740 c⁄° 
EVP_MD
 *
kt
)

742 
	`ASSERT
(
NULL
 !
kt
 && NULL !
˘x
);

744 
	`CLEAR
(*
˘x
);

746 
	`HMAC_CTX_öô
 (
˘x
);

747 
	`HMAC_Inô_ex
 (
˘x
, 
key
, 
key_Àn
, 
kt
, 
NULL
);

750 
	`ASSERT
 (
	`HMAC_size
 (
˘x
Ë<
key_Àn
);

751 
	}
}

754 
	$hmac_˘x_˛ónup
(
HMAC_CTX
 *
˘x
)

756 
	`HMAC_CTX_˛ónup
 (
˘x
);

757 
	}
}

760 
	$hmac_˘x_size
 (c⁄° 
HMAC_CTX
 *
˘x
)

762  
	`HMAC_size
 (
˘x
);

763 
	}
}

766 
	$hmac_˘x_ª£t
 (
HMAC_CTX
 *
˘x
)

768 
	`HMAC_Inô_ex
 (
˘x
, 
NULL
, 0, NULL, NULL);

769 
	}
}

772 
	$hmac_˘x_upd©e
 (
HMAC_CTX
 *
˘x
, c⁄° 
uöt8_t
 *
§c
, 
§c_Àn
)

774 
	`HMAC_Upd©e
 (
˘x
, 
§c
, 
§c_Àn
);

775 
	}
}

778 
	$hmac_˘x_föÆ
 (
HMAC_CTX
 *
˘x
, 
uöt8_t
 *
d°
)

780 
ö_hmac_Àn
 = 0;

782 
	`HMAC_FöÆ
 (
˘x
, 
d°
, &
ö_hmac_Àn
);

783 
	}
}

	@src/openvpn/crypto_openssl.h

30 #i‚de‡
CRYPTO_OPENSSL_H_


31 
	#CRYPTO_OPENSSL_H_


	)

33 
	~<›ís¶/evp.h
>

34 
	~<›ís¶/hmac.h
>

35 
	~<›ís¶/md5.h
>

38 
EVP_CIPHER
 
	tcùhî_kt_t
;

41 
EVP_MD
 
	tmd_kt_t
;

44 
EVP_CIPHER_CTX
 
	tcùhî_˘x_t
;

47 
EVP_MD_CTX
 
	tmd_˘x_t
;

50 
HMAC_CTX
 
	thmac_˘x_t
;

53 
	#OPENVPN_MAX_IV_LENGTH
 
EVP_MAX_IV_LENGTH


	)

56 
	#OPENVPN_MODE_CBC
 
EVP_CIPH_CBC_MODE


	)

59 
	#OPENVPN_MODE_OFB
 
EVP_CIPH_OFB_MODE


	)

62 
	#OPENVPN_MODE_CFB
 
EVP_CIPH_CFB_MODE


	)

65 
	#OPENVPN_OP_ENCRYPT
 1

	)

68 
	#OPENVPN_OP_DECRYPT
 0

	)

70 
	#DES_KEY_LENGTH
 8

	)

71 
	#MD4_DIGEST_LENGTH
 16

	)

	@src/openvpn/crypto_polarssl.c

30 #ifde‡
HAVE_CONFIG_H


31 
	~"c⁄fig.h
"

32 #ñi‡
deföed
(
_MSC_VER
)

33 
	~"c⁄fig-msvc.h
"

36 
	~"syshód.h
"

38 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_CRYPTO_POLARSSL
)

40 
	~"îæevñ.h
"

41 
	~"basic.h
"

42 
	~"buf„r.h
"

43 
	~"öãgî.h
"

44 
	~"¸y±o_backíd.h
"

45 
	~"Ÿime.h
"

46 
	~"misc.h
"

48 
	~<pﬁ¨s¶/des.h
>

49 
	~<pﬁ¨s¶/md5.h
>

50 
	~<pﬁ¨s¶/cùhî.h
>

51 
	~<pﬁ¨s¶/havege.h
>

53 
	~<pﬁ¨s¶/íå›y.h
>

62 
	$¸y±o_öô_lib_ígöe
 (c⁄° *
ígöe_«me
)

64 
	`msg
 (
M_WARN
, "Note: PolarSSL hardware cryptoÉngine functionality isÇot "

66 
	}
}

75 
	$¸y±o_öô_lib
 ()

77 
	}
}

80 
	$¸y±o_unöô_lib
 ()

82 
	}
}

85 
	$¸y±o_˛ór_îr‹
 ()

87 
	}
}

89 #ifde‡
DMALLOC


91 
	$¸y±o_öô_dmÆloc
 ()

93 
	`msg
 (
M_ERR
, "Error: dmalloc support isÇotávailable for PolarSSL.");

94 
	}
}

97 °ru˘ { c⁄° * 
	m›ív≤_«me
; c⁄° * 
	mpﬁ¨s¶_«me
; } 
	tcùhî_«me_∑ú
;

98 
cùhî_«me_∑ú
 
	gcùhî_«me_å™¶©i⁄_èbÀ
[] = {

106 c⁄° 
cùhî_«me_∑ú
 *

107 
	$gë_cùhî_«me_∑ú
(c⁄° *
cùhî_«me
) {

108 
cùhî_«me_∑ú
 *
∑ú
;

109 
size_t
 
i
 = 0;

112 ; 
i
 <  (
cùhî_«me_å™¶©i⁄_èbÀ
) /  (*cipher_name_translation_table); i++)

114 
∑ú
 = &
cùhî_«me_å™¶©i⁄_èbÀ
[
i
];

115 i‡(0 =
	`°rcmp
 (
cùhî_«me
, 
∑ú
->
›ív≤_«me
) ||

116 0 =
	`°rcmp
 (
cùhî_«me
, 
∑ú
->
pﬁ¨s¶_«me
))

117  
∑ú
;

121  
NULL
;

122 
	}
}

125 
	$å™¶©e_cùhî_«me_‰om_›ív≤
 (c⁄° *
cùhî_«me
) {

126 c⁄° 
cùhî_«me_∑ú
 *
∑ú
 = 
	`gë_cùhî_«me_∑ú
(
cùhî_«me
);

128 i‡(
NULL
 =
∑ú
)

129  
cùhî_«me
;

131  
∑ú
->
pﬁ¨s¶_«me
;

132 
	}
}

135 
	$å™¶©e_cùhî_«me_to_›ív≤
 (c⁄° *
cùhî_«me
) {

136 c⁄° 
cùhî_«me_∑ú
 *
∑ú
 = 
	`gë_cùhî_«me_∑ú
(
cùhî_«me
);

138 i‡(
NULL
 =
∑ú
)

139  
cùhî_«me
;

141  
∑ú
->
›ív≤_«me
;

142 
	}
}

145 
	$show_avaûabÀ_cùhîs
 ()

147 c⁄° *
cùhîs
 = 
	`cùhî_li°
();

149 #i‚de‡
ENABLE_SMALL


150 
	`¥ötf
 ("The following ciphersánd cipher modesáreávailable\n"

151 "f‹ u£ wôh " 
PACKAGE_NAME
 ". Each cipher shown below may be\n"

158 *
cùhîs
 != 0)

160 c⁄° 
cùhî_öfo_t
 *
öfo
 = 
	`cùhî_öfo_‰om_ty≥
(*
cùhîs
);

162 i‡(
öfo
 && info->
mode
 =
POLARSSL_MODE_CBC
)

163 
	`¥ötf
 ("%s %d bit default key\n",

164 
	`cùhî_kt_«me
(
öfo
), 
	`cùhî_kt_key_size
(info) * 8);

166 
cùhîs
++;

168 
	`¥ötf
 ("\n");

169 
	}
}

172 
	$show_avaûabÀ_dige°s
 ()

174 c⁄° *
dige°s
 = 
	`md_li°
();

176 #i‚de‡
ENABLE_SMALL


177 
	`¥ötf
 ("The following message digestsáreávailable for use with\n"

178 
PACKAGE_NAME
 ". A message digest is used in conjunction with\n"

184 *
dige°s
 != 0)

186 c⁄° 
md_öfo_t
 *
öfo
 = 
	`md_öfo_‰om_ty≥
(*
dige°s
);

188 i‡(
öfo
)

189 
	`¥ötf
 ("%s %d bit default key\n",

190 
öfo
->
«me
, info->
size
 * 8);

191 
dige°s
++;

193 
	`¥ötf
 ("\n");

194 
	}
}

197 
	$show_avaûabÀ_ígöes
 ()

199 
	`¥ötf
 ("Sorry, PolarSSL hardware cryptoÉngine functionality isÇot "

201 
	}
}

216 
˘r_drbg_c⁄ãxt
 * 
	$ønd_˘x_gë
()

218 
íå›y_c⁄ãxt
 
ec
 = {0};

219 
˘r_drbg_c⁄ãxt
 
cd_˘x
 = {0};

220 
boﬁ
 
ønd_öôüli£d
 = 
Ál£
;

222 i‡(!
ønd_öôüli£d
)

224 
gc_¨ía
 
gc
 = 
	`gc_√w
();

225 
buf„r
 
≥rs_°rög
 = 
	`Æloc_buf_gc
(100, &
gc
);

232 
	`buf_¥ötf
(&
≥rs_°rög
, "O≥nVPN %0u %∞%s", 
	`∂©f‹m_gëpid
(), &
cd_˘x
, 
	`time_°rög
(0, 0, 0, &
gc
));

235 
	`íå›y_öô
(&
ec
);

237 i‡(0 !
	`˘r_drbg_öô
(&
cd_˘x
, 
íå›y_func
, &
ec
, 
	`BPTR
(&
≥rs_°rög
), 
	`BLEN
(&pers_string)))

238 
	`msg
 (
M_FATAL
, "FailedÅo initializeÑandom generator");

240 
	`gc_‰ì
(&
gc
);

241 
ønd_öôüli£d
 = 
åue
;

244  &
cd_˘x
;

245 
	}
}

247 #ifde‡
ENABLE_PREDICTION_RESISTANCE


248 
	$ønd_˘x_íabÀ_¥edi˘i⁄_ªsi°™˚
()

250 
˘r_drbg_c⁄ãxt
 *
cd_˘x
 = 
	`ønd_˘x_gë
();

252 
	`˘r_drbg_£t_¥edi˘i⁄_ªsi°™˚
(
cd_˘x
, 1);

253 
	}
}

257 
	$ønd_byãs
 (
uöt8_t
 *
ouçut
, 
Àn
)

259 
˘r_drbg_c⁄ãxt
 *
∫g_˘x
 = 
	`ønd_˘x_gë
();

261 
Àn
 > 0)

263 c⁄° 
size_t
 
bÀn
 = 
	`mö_öt
 (
Àn
, 
CTR_DRBG_MAX_REQUEST
);

264 i‡(0 !
	`˘r_drbg_øndom
(
∫g_˘x
, 
ouçut
, 
bÀn
))

267 
ouçut
 +
bÀn
;

268 
Àn
 -
bÀn
;

272 
	}
}

282 
	$key_des_num_cblocks
 (c⁄° 
cùhî_öfo_t
 *
kt
)

284 
ªt
 = 0;

285 i‡(
kt
->
ty≥
 =
POLARSSL_CIPHER_DES_CBC
)

286 
ªt
 = 1;

287 i‡(
kt
->
ty≥
 =
POLARSSL_CIPHER_DES_EDE_CBC
)

288 
ªt
 = 2;

289 i‡(
kt
->
ty≥
 =
POLARSSL_CIPHER_DES_EDE3_CBC
)

290 
ªt
 = 3;

292 
	`dmsg
 (
D_CRYPTO_DEBUG
, "CRYPTO INFO:Ç_DES_cblocks=%d", 
ªt
);

293  
ªt
;

294 
	}
}

296 
boﬁ


297 
	$key_des_check
 (
uöt8_t
 *
key
, 
key_Àn
, 
ndc
)

299 
i
;

300 
buf„r
 
b
;

302 
	`buf_£t_ªad
 (&
b
, 
key
, 
key_Àn
);

304 
i
 = 0; i < 
ndc
; ++i)

306 *
key
 = 
	`buf_ªad_Æloc
(&
b
, 
DES_KEY_SIZE
);

307 i‡(!
key
)

309 
	`msg
 (
D_CRYPT_ERRORS
, "CRYPTO INFO: check_key_DES: insufficient key material");

310 
îr
;

312 i‡(0 !
	`des_key_check_wók
(
key
))

314 
	`msg
 (
D_CRYPT_ERRORS
, "CRYPTO INFO: check_key_DES: weak key detected");

315 
îr
;

317 i‡(0 !
	`des_key_check_key_∑rôy
(
key
))

319 
	`msg
 (
D_CRYPT_ERRORS
, "CRYPTO INFO: check_key_DES: badÖarity detected");

320 
îr
;

323  
åue
;

325 
îr
:

326  
Ál£
;

327 
	}
}

330 
	$key_des_fixup
 (
uöt8_t
 *
key
, 
key_Àn
, 
ndc
)

332 
i
;

333 
buf„r
 
b
;

335 
	`buf_£t_ªad
 (&
b
, 
key
, 
key_Àn
);

336 
i
 = 0; i < 
ndc
; ++i)

338 *
key
 = 
	`buf_ªad_Æloc
(&
b
, 
DES_KEY_SIZE
);

339 i‡(!
key
)

341 
	`msg
 (
D_CRYPT_ERRORS
, "CRYPTO INFO: fixup_key_DES: insufficient key material");

344 
	`des_key_£t_∑rôy
(
key
);

346 
	}
}

355 c⁄° 
cùhî_öfo_t
 *

356 
	$cùhî_kt_gë
 (c⁄° *
cùhî«me
)

358 c⁄° 
cùhî_öfo_t
 *
cùhî
 = 
NULL
;

360 
	`ASSERT
 (
cùhî«me
);

362 
cùhî
 = 
	`cùhî_öfo_‰om_°rög
(
cùhî«me
);

364 i‡(
NULL
 =
cùhî
)

365 
	`msg
 (
M_FATAL
, "Cùhîálg‹ôhm '%s'ÇŸ found", 
cùhî«me
);

367 i‡(
cùhî
->
key_Àngth
/8 > 
MAX_CIPHER_KEY_LENGTH
)

368 
	`msg
 (
M_FATAL
, "Cùhîálg‹ôhm '%s' u£†®deÁu… key sizê(%d byãsËwhich i†œrgîÅh™ " 
PACKAGE_NAME
 "'s current maximum key size (%d bytes)",

369 
cùhî«me
,

370 
cùhî
->
key_Àngth
/8,

371 
MAX_CIPHER_KEY_LENGTH
);

373  
cùhî
;

374 
	}
}

377 
	$cùhî_kt_«me
 (c⁄° 
cùhî_öfo_t
 *
cùhî_kt
)

379 i‡(
NULL
 =
cùhî_kt
)

382  
	`å™¶©e_cùhî_«me_to_›ív≤
(
cùhî_kt
->
«me
);

383 
	}
}

386 
	$cùhî_kt_key_size
 (c⁄° 
cùhî_öfo_t
 *
cùhî_kt
)

388 i‡(
NULL
 =
cùhî_kt
)

390 i‡(
POLARSSL_CIPHER_ID_BLOWFISH
 =
cùhî_kt
->
ba£
->
cùhî
)

393  
cùhî_kt
->
key_Àngth
/8;

394 
	}
}

397 
	$cùhî_kt_iv_size
 (c⁄° 
cùhî_öfo_t
 *
cùhî_kt
)

399 i‡(
NULL
 =
cùhî_kt
)

401  
cùhî_kt
->
iv_size
;

402 
	}
}

405 
	$cùhî_kt_block_size
 (c⁄° 
cùhî_öfo_t
 *
cùhî_kt
)

407 i‡(
NULL
 =
cùhî_kt
)

409  
cùhî_kt
->
block_size
;

410 
	}
}

413 
	$cùhî_kt_mode
 (c⁄° 
cùhî_öfo_t
 *
cùhî_kt
)

415 
	`ASSERT
(
NULL
 !
cùhî_kt
);

416  
cùhî_kt
->
mode
;

417 
	}
}

419 
boﬁ


420 
	$cùhî_kt_mode_cbc
(c⁄° 
cùhî_kt_t
 *
cùhî
)

422  
cùhî
 && 
	`cùhî_kt_mode
(cùhîË=
OPENVPN_MODE_CBC
;

423 
	}
}

425 
boﬁ


426 
	$cùhî_kt_mode_ofb_cfb
(c⁄° 
cùhî_kt_t
 *
cùhî
)

428  
cùhî
 && (
	`cùhî_kt_mode
(cùhîË=
OPENVPN_MODE_OFB
 ||

429 
	`cùhî_kt_mode
(
cùhî
Ë=
OPENVPN_MODE_CFB
);

430 
	}
}

441 
	$cùhî_˘x_öô
 (
cùhî_c⁄ãxt_t
 *
˘x
, 
uöt8_t
 *
key
, 
key_Àn
,

442 c⁄° 
cùhî_öfo_t
 *
kt
, 
íc
)

444 
	`ASSERT
(
NULL
 !
kt
 && NULL !
˘x
);

446 
	`CLEAR
 (*
˘x
);

448 i‡(0 !
	`cùhî_öô_˘x
(
˘x
, 
kt
))

449 
	`msg
 (
M_FATAL
, "PolarSSL cipher context init #1");

451 i‡(0 !
	`cùhî_£tkey
(
˘x
, 
key
, 
key_Àn
*8, 
íc
))

452 
	`msg
 (
M_FATAL
, "PolarSSL cipher set key");

455 
	`ASSERT
 (
˘x
->
key_Àngth
 <
key_Àn
*8);

456 
	}
}

458 
	$cùhî_˘x_˛ónup
 (
cùhî_c⁄ãxt_t
 *
˘x
)

460 
	`cùhî_‰ì_˘x
(
˘x
);

461 
	}
}

463 
	$cùhî_˘x_iv_Àngth
 (c⁄° 
cùhî_c⁄ãxt_t
 *
˘x
)

465  
	`cùhî_gë_iv_size
(
˘x
);

466 
	}
}

468 
	$cùhî_˘x_block_size
(c⁄° 
cùhî_c⁄ãxt_t
 *
˘x
)

470  
	`cùhî_gë_block_size
(
˘x
);

471 
	}
}

473 
	$cùhî_˘x_mode
 (c⁄° 
cùhî_c⁄ãxt_t
 *
˘x
)

475 
	`ASSERT
(
NULL
 !
˘x
);

477  
	`cùhî_kt_mode
(
˘x
->
cùhî_öfo
);

478 
	}
}

480 c⁄° 
cùhî_kt_t
 *

481 
	$cùhî_˘x_gë_cùhî_kt
 (c⁄° 
cùhî_˘x_t
 *
˘x
)

483 
	`ASSERT
(
NULL
 !
˘x
);

485  
˘x
->
cùhî_öfo
;

486 
	}
}

488 
	$cùhî_˘x_ª£t
 (
cùhî_c⁄ãxt_t
 *
˘x
, 
uöt8_t
 *
iv_buf
)

490  0 =
	`cùhî_ª£t
(
˘x
, 
iv_buf
);

491 
	}
}

493 
	$cùhî_˘x_upd©e
 (
cùhî_c⁄ãxt_t
 *
˘x
, 
uöt8_t
 *
d°
, *
d°_Àn
,

494 
uöt8_t
 *
§c
, 
§c_Àn
)

496 
ªtvÆ
 = 0;

497 
size_t
 
s_d°_Àn
 = *
d°_Àn
;

499 
ªtvÆ
 = 
	`cùhî_upd©e
(
˘x
, 
§c
, (
size_t
)
§c_Àn
, 
d°
, &
s_d°_Àn
);

501 *
d°_Àn
 = 
s_d°_Àn
;

503  0 =
ªtvÆ
;

504 
	}
}

506 
	$cùhî_˘x_föÆ
 (
cùhî_c⁄ãxt_t
 *
˘x
, 
uöt8_t
 *
d°
, *
d°_Àn
)

508 
ªtvÆ
 = 0;

509 
size_t
 
s_d°_Àn
 = *
d°_Àn
;

511 
ªtvÆ
 = 
	`cùhî_föish
(
˘x
, 
d°
, &
s_d°_Àn
);

512 *
d°_Àn
 = 
s_d°_Àn
;

514  0 =
ªtvÆ
;

515 
	}
}

518 
	$cùhî_des_í¸y±_ecb
 (c⁄° 
key
[
DES_KEY_LENGTH
],

519 *
§c
,

520 *
d°
)

522 
des_c⁄ãxt
 
˘x
;

524 
	`des_£tkey_íc
(&
˘x
, 
key
);

525 
	`des_¸y±_ecb
(&
˘x
, 
§c
, 
d°
);

526 
	}
}

537 c⁄° 
md_öfo_t
 *

538 
	$md_kt_gë
 (c⁄° *
dige°
)

540 c⁄° 
md_öfo_t
 *
md
 = 
NULL
;

541 
	`ASSERT
 (
dige°
);

543 
md
 = 
	`md_öfo_‰om_°rög
(
dige°
);

544 i‡(!
md
)

545 
	`msg
 (
M_FATAL
, "Mesßgêhashálg‹ôhm '%s'ÇŸ found", 
dige°
);

546 i‡(
md
->
size
 > 
MAX_HMAC_KEY_LENGTH
)

547 
	`msg
 (
M_FATAL
, "Mesßgêhashálg‹ôhm '%s' u£†®deÁu… hash sizê(%d byãsËwhich i†œrgîÅh™ " 
PACKAGE_NAME
 "'s current maximum hash size (%d bytes)",

548 
dige°
,

549 
md
->
size
,

550 
MAX_HMAC_KEY_LENGTH
);

551  
md
;

552 
	}
}

555 
	$md_kt_«me
 (c⁄° 
md_öfo_t
 *
kt
)

557 i‡(
NULL
 =
kt
)

559  
	`md_gë_«me
 (
kt
);

560 
	}
}

563 
	$md_kt_size
 (c⁄° 
md_öfo_t
 *
kt
)

565 i‡(
NULL
 =
kt
)

567  
	`md_gë_size
(
kt
);

568 
	}
}

577 
	$md_fuŒ
 (c⁄° 
md_kt_t
 *
kt
, c⁄° 
uöt8_t
 *
§c
, 
§c_Àn
, uöt8_à*
d°
)

579  0 =
	`md
(
kt
, 
§c
, 
§c_Àn
, 
d°
);

580 
	}
}

584 
	$md_˘x_öô
 (
md_c⁄ãxt_t
 *
˘x
, c⁄° 
md_öfo_t
 *
kt
)

586 
	`ASSERT
(
NULL
 !
˘x
 && NULL !
kt
);

588 
	`CLEAR
(*
˘x
);

590 
	`ASSERT
(0 =
	`md_öô_˘x
(
˘x
, 
kt
));

591 
	`ASSERT
(0 =
	`md_°¨ts
(
˘x
));

592 
	}
}

595 
	$md_˘x_˛ónup
(
md_c⁄ãxt_t
 *
˘x
)

597 
	}
}

600 
	$md_˘x_size
 (c⁄° 
md_c⁄ãxt_t
 *
˘x
)

602 i‡(
NULL
 =
˘x
)

604  
	`md_gë_size
(
˘x
->
md_öfo
);

605 
	}
}

608 
	$md_˘x_upd©e
 (
md_c⁄ãxt_t
 *
˘x
, c⁄° 
uöt8_t
 *
§c
, 
§c_Àn
)

610 
	`ASSERT
(0 =
	`md_upd©e
(
˘x
, 
§c
, 
§c_Àn
));

611 
	}
}

614 
	$md_˘x_föÆ
 (
md_c⁄ãxt_t
 *
˘x
, 
uöt8_t
 *
d°
)

616 
	`ASSERT
(0 =
	`md_föish
(
˘x
, 
d°
));

617 
	`ASSERT
(0 =
	`md_‰ì_˘x
(
˘x
));

618 
	}
}

632 
	$hmac_˘x_öô
 (
md_c⁄ãxt_t
 *
˘x
, c⁄° 
uöt8_t
 *
key
, 
key_Àn
, c⁄° 
md_öfo_t
 *
kt
)

634 
	`ASSERT
(
NULL
 !
kt
 && NULL !
˘x
);

636 
	`CLEAR
(*
˘x
);

638 
	`ASSERT
(0 =
	`md_öô_˘x
(
˘x
, 
kt
));

639 
	`ASSERT
(0 =
	`md_hmac_°¨ts
(
˘x
, 
key
, 
key_Àn
));

642 
	`ASSERT
 (
	`md_gë_size
(
kt
Ë<
key_Àn
);

643 
	}
}

646 
	$hmac_˘x_˛ónup
(
md_c⁄ãxt_t
 *
˘x
)

648 
	`ASSERT
(0 =
	`md_‰ì_˘x
(
˘x
));

649 
	}
}

652 
	$hmac_˘x_size
 (c⁄° 
md_c⁄ãxt_t
 *
˘x
)

654 i‡(
NULL
 =
˘x
)

656  
	`md_gë_size
(
˘x
->
md_öfo
);

657 
	}
}

660 
	$hmac_˘x_ª£t
 (
md_c⁄ãxt_t
 *
˘x
)

662 
	`ASSERT
(0 =
	`md_hmac_ª£t
(
˘x
));

663 
	}
}

666 
	$hmac_˘x_upd©e
 (
md_c⁄ãxt_t
 *
˘x
, c⁄° 
uöt8_t
 *
§c
, 
§c_Àn
)

668 
	`ASSERT
(0 =
	`md_hmac_upd©e
(
˘x
, 
§c
, 
§c_Àn
));

669 
	}
}

672 
	$hmac_˘x_föÆ
 (
md_c⁄ãxt_t
 *
˘x
, 
uöt8_t
 *
d°
)

674 
	`ASSERT
(0 =
	`md_hmac_föish
(
˘x
, 
d°
));

675 
	}
}

	@src/openvpn/crypto_polarssl.h

30 #i‚de‡
CRYPTO_POLARSSL_H_


31 
	#CRYPTO_POLARSSL_H_


	)

33 
	~<pﬁ¨s¶/cùhî.h
>

34 
	~<pﬁ¨s¶/md.h
>

35 
	~<pﬁ¨s¶/˘r_drbg.h
>

38 
cùhî_öfo_t
 
	tcùhî_kt_t
;

41 
md_öfo_t
 
	tmd_kt_t
;

44 
cùhî_c⁄ãxt_t
 
	tcùhî_˘x_t
;

47 
md_c⁄ãxt_t
 
	tmd_˘x_t
;

50 
md_c⁄ãxt_t
 
	thmac_˘x_t
;

53 
	#OPENVPN_MAX_IV_LENGTH
 
POLARSSL_MAX_IV_LENGTH


	)

56 
	#OPENVPN_MODE_CBC
 
POLARSSL_MODE_CBC


	)

59 
	#OPENVPN_MODE_OFB
 
POLARSSL_MODE_OFB


	)

62 
	#OPENVPN_MODE_CFB
 
POLARSSL_MODE_CFB


	)

65 
	#OPENVPN_OP_ENCRYPT
 
POLARSSL_ENCRYPT


	)

68 
	#OPENVPN_OP_DECRYPT
 
POLARSSL_DECRYPT


	)

70 
	#MD4_DIGEST_LENGTH
 16

	)

71 
	#MD5_DIGEST_LENGTH
 16

	)

72 
	#SHA_DIGEST_LENGTH
 20

	)

73 
	#DES_KEY_LENGTH
 8

	)

85 
˘r_drbg_c⁄ãxt
 * 
ønd_˘x_gë
();

87 #ifde‡
ENABLE_PREDICTION_RESISTANCE


91 
ønd_˘x_íabÀ_¥edi˘i⁄_ªsi°™˚
();

	@src/openvpn/cryptoapi.c

31 #ifde‡
HAVE_CONFIG_H


32 
	~"c⁄fig.h
"

33 #ñi‡
deföed
(
_MSC_VER
)

34 
	~"c⁄fig-msvc.h
"

37 
	~"syshód.h
"

39 #ifde‡
ENABLE_CRYPTOAPI


41 
	~<›ís¶/s¶.h
>

42 
	~<›ís¶/îr.h
>

43 
	~<wödows.h
>

44 
	~<wö¸y±.h
>

45 
	~<°dio.h
>

46 
	~<˘y≥.h
>

47 
	~<as£π.h
>

52 #i‚de‡
CERT_SYSTEM_STORE_LOCATION_SHIFT


53 
	#CERT_SYSTEM_STORE_LOCATION_SHIFT
 16

	)

55 #i‚de‡
CERT_SYSTEM_STORE_CURRENT_USER_ID


56 
	#CERT_SYSTEM_STORE_CURRENT_USER_ID
 1

	)

58 #i‚de‡
CERT_SYSTEM_STORE_CURRENT_USER


59 
	#CERT_SYSTEM_STORE_CURRENT_USER
 (
CERT_SYSTEM_STORE_CURRENT_USER_ID
 << 
CERT_SYSTEM_STORE_LOCATION_SHIFT
)

	)

61 #i‚de‡
CERT_STORE_READONLY_FLAG


62 
	#CERT_STORE_READONLY_FLAG
 0x00008000

	)

64 #i‚de‡
CERT_STORE_OPEN_EXISTING_FLAG


65 
	#CERT_STORE_OPEN_EXISTING_FLAG
 0x00004000

	)

69 
	#SSL_SIG_LENGTH
 36

	)

72 
	#ERR_LIB_CRYPTOAPI
 (
ERR_LIB_USER
 + 69Ë

	)

73 
	#CRYPTOAPIîr
(
f
Ë
	`îr_put_ms_îr‹
(
	`GëLa°Eº‹
(), (f), 
__FILE__
, 
__LINE__
)

	)

74 
	#CRYPTOAPI_F_CERT_OPEN_SYSTEM_STORE
 100

	)

75 
	#CRYPTOAPI_F_CERT_FIND_CERTIFICATE_IN_STORE
 101

	)

76 
	#CRYPTOAPI_F_CRYPT_ACQUIRE_CERTIFICATE_PRIVATE_KEY
 102

	)

77 
	#CRYPTOAPI_F_CRYPT_CREATE_HASH
 103

	)

78 
	#CRYPTOAPI_F_CRYPT_GET_HASH_PARAM
 104

	)

79 
	#CRYPTOAPI_F_CRYPT_SET_HASH_PARAM
 105

	)

80 
	#CRYPTOAPI_F_CRYPT_SIGN_HASH
 106

	)

81 
	#CRYPTOAPI_F_LOAD_LIBRARY
 107

	)

82 
	#CRYPTOAPI_F_GET_PROC_ADDRESS
 108

	)

84 
ERR_STRING_DATA
 
	gCRYPTOAPI_°r_fun˘s
[] = {

85 { 
ERR_PACK
(
ERR_LIB_CRYPTOAPI
, 0, 0), "microsoft cryptoapi"},

86 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CERT_OPEN_SYSTEM_STORE
, 0), "CertOpenSystemStore" },

87 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CERT_FIND_CERTIFICATE_IN_STORE
, 0), "CertFindCertificateInStore" },

88 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CRYPT_ACQUIRE_CERTIFICATE_PRIVATE_KEY
, 0), "CryptAcquireCertificatePrivateKey" },

89 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CRYPT_CREATE_HASH
, 0), "CryptCreateHash" },

90 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CRYPT_GET_HASH_PARAM
, 0), "CryptGetHashParam" },

91 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CRYPT_SET_HASH_PARAM
, 0), "CryptSetHashParam" },

92 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CRYPT_SIGN_HASH
, 0), "CryptSignHash" },

93 { 
ERR_PACK
(0, 
CRYPTOAPI_F_LOAD_LIBRARY
, 0), "LoadLibrary" },

94 { 
ERR_PACK
(0, 
CRYPTOAPI_F_GET_PROC_ADDRESS
, 0), "GetProcAddress" },

95 { 0, 
NULL
 }

98 
	s_CAPI_DATA
 {

99 c⁄° 
CERT_CONTEXT
 *
	m˚π_c⁄ãxt
;

100 
HCRYPTPROV
 
	m¸y±_¥ov
;

101 
DWORD
 
	mkey_•ec
;

102 
BOOL
 
	m‰ì_¸y±_¥ov
;

103 } 
	tCAPI_DATA
;

105 *
	$ms_îr‹_ãxt
(
DWORD
 
ms_îr
)

107 
LPVOID
 
ÕMsgBuf
 = 
NULL
;

108 *
rv
 = 
NULL
;

110 
	`F‹m©Mesßge
(

111 
FORMAT_MESSAGE_ALLOCATE_BUFFER
 |

112 
FORMAT_MESSAGE_FROM_SYSTEM
 |

113 
FORMAT_MESSAGE_IGNORE_INSERTS
,

114 
NULL
, 
ms_îr
,

115 
	`MAKELANGID
(
LANG_NEUTRAL
, 
SUBLANG_DEFAULT
),

116 (
LPTSTR
Ë&
ÕMsgBuf
, 0, 
NULL
);

117 i‡(
ÕMsgBuf
) {

118 *
p
;

119 
rv
 = 
	`°rdup
(
ÕMsgBuf
);

120 
	`LoˇlFªe
(
ÕMsgBuf
);

122 i‡(
rv
)

123 
p
 = 
rv
 + 
	`°æí
(rv) - 1;Ö >=Ñv;Ö--) {

124 i‡(
	`is•a˚
(*
p
))

125 *
p
 = '\0';

130  
rv
;

131 
	}
}

133 
	$îr_put_ms_îr‹
(
DWORD
 
ms_îr
, 
func
, c⁄° *
fûe
, 
löe
)

135 
öô
 = 0;

136 
	#ERR_MAP_SZ
 16

	)

138 
îr
;

139 
DWORD
 
ms_îr
;

140 } 
îr_m≠
[
ERR_MAP_SZ
];

141 
i
;

143 i‡(
ms_îr
 == 0)

146 i‡(!
öô
) {

147 
	`ERR_lﬂd_°rögs
(
ERR_LIB_CRYPTOAPI
, 
CRYPTOAPI_°r_fun˘s
);

148 
	`mem£t
(&
îr_m≠
, 0, (err_map));

149 
öô
++;

153 
i
 = 0; i < 
ERR_MAP_SZ
; i++) {

154 i‡(
îr_m≠
[
i
].
ms_îr
 == ms_err) {

155 
	`ERR_PUT_îr‹
(
ERR_LIB_CRYPTOAPI
, 
func
, 
îr_m≠
[
i
].
îr
, 
fûe
, 
löe
);

157 } i‡(
îr_m≠
[
i
].
ms_îr
 == 0 ) {

159 
ERR_STRING_DATA
 *
esd
 = 
	`ˇŒoc
(2, (*esd));

160 i‡(
esd
 =
NULL
)

162 
îr_m≠
[
i
].
ms_îr
 = ms_err;

163 
îr_m≠
[
i
].
îr
 = 
esd
->
îr‹
 = i + 100;

164 
esd
->
°rög
 = 
	`ms_îr‹_ãxt
(
ms_îr
);

165 
	`ERR_lﬂd_°rögs
(
ERR_LIB_CRYPTOAPI
, 
esd
);

166 
	`ERR_PUT_îr‹
(
ERR_LIB_CRYPTOAPI
, 
func
, 
îr_m≠
[
i
].
îr
, 
fûe
, 
löe
);

170 
	}
}

173 
	$rß_pub_íc
(
Êí
, c⁄° *
‰om
, *
to
, 
RSA
 *
rß
, 
∑ddög
)

176 
	`as£π
(0);

179 
	}
}

182 
	$rß_pub_dec
(
Êí
, c⁄° *
‰om
, *
to
, 
RSA
 *
rß
, 
∑ddög
)

185 
	`as£π
(0);

188 
	}
}

191 
	$rß_¥iv_íc
(
Êí
, c⁄° *
‰om
, *
to
, 
RSA
 *
rß
, 
∑ddög
)

193 
CAPI_DATA
 *
cd
 = (CAPI_DATA *Ë
rß
->
mëh
->
≠p_d©a
;

194 
HCRYPTHASH
 
hash
;

195 
DWORD
 
hash_size
, 
Àn
, 
i
;

196 *
buf
;

198 i‡(
cd
 =
NULL
) {

199 
	`RSAîr
(
RSA_F_RSA_EAY_PRIVATE_ENCRYPT
, 
ERR_R_PASSED_NULL_PARAMETER
);

202 i‡(
∑ddög
 !
RSA_PKCS1_PADDING
) {

204 
	`RSAîr
(
RSA_F_RSA_EAY_PRIVATE_ENCRYPT
, 
RSA_R_UNKNOWN_PADDING_TYPE
);

212 i‡(
Êí
 !
SSL_SIG_LENGTH
) {

213 
	`RSAîr
(
RSA_F_RSA_EAY_PRIVATE_ENCRYPT
, 
RSA_R_INVALID_MESSAGE_LENGTH
);

216 i‡(!
	`Cry±Cª©eHash
(
cd
->
¸y±_¥ov
, 
CALG_SSL3_SHAMD5
, 0, 0, &
hash
)) {

217 
	`CRYPTOAPIîr
(
CRYPTOAPI_F_CRYPT_CREATE_HASH
);

220 
Àn
 = (
hash_size
);

221 i‡(!
	`Cry±GëHashP¨am
(
hash
, 
HP_HASHSIZE
, (
BYTE
 *Ë&
hash_size
, &
Àn
, 0)) {

222 
	`CRYPTOAPIîr
(
CRYPTOAPI_F_CRYPT_GET_HASH_PARAM
);

223 
	`Cry±De°royHash
(
hash
);

226 i‡((Ë
hash_size
 !
Êí
) {

227 
	`RSAîr
(
RSA_F_RSA_EAY_PRIVATE_ENCRYPT
, 
RSA_R_INVALID_MESSAGE_LENGTH
);

228 
	`Cry±De°royHash
(
hash
);

231 i‡(!
	`Cry±SëHashP¨am
(
hash
, 
HP_HASHVAL
, (
BYTE
 * ) 
‰om
, 0)) {

232 
	`CRYPTOAPIîr
(
CRYPTOAPI_F_CRYPT_SET_HASH_PARAM
);

233 
	`Cry±De°royHash
(
hash
);

237 
Àn
 = 
	`RSA_size
(
rß
);

238 
buf
 = 
	`mÆloc
(
Àn
);

239 i‡(
buf
 =
NULL
) {

240 
	`RSAîr
(
RSA_F_RSA_EAY_PRIVATE_ENCRYPT
, 
ERR_R_MALLOC_FAILURE
);

241 
	`Cry±De°royHash
(
hash
);

244 i‡(!
	`Cry±SignHash
(
hash
, 
cd
->
key_•ec
, 
NULL
, 0, 
buf
, &
Àn
)) {

245 
	`CRYPTOAPIîr
(
CRYPTOAPI_F_CRYPT_SIGN_HASH
);

246 
	`Cry±De°royHash
(
hash
);

247 
	`‰ì
(
buf
);

251 
i
 = 0; i < 
Àn
; i++)

252 
to
[
i
] = 
buf
[
Àn
 - i - 1];

253 
	`‰ì
(
buf
);

255 
	`Cry±De°royHash
(
hash
);

256  
Àn
;

257 
	}
}

260 
	$rß_¥iv_dec
(
Êí
, c⁄° *
‰om
, *
to
, 
RSA
 *
rß
, 
∑ddög
)

263 
	`as£π
(0);

266 
	}
}

269 
	$öô
(
RSA
 *
rß
)

273 
	}
}

276 
	$föish
(
RSA
 *
rß
)

278 
CAPI_DATA
 *
cd
 = (CAPI_DATA *Ë
rß
->
mëh
->
≠p_d©a
;

280 i‡(
cd
 =
NULL
)

282 i‡(
cd
->
¸y±_¥ov
 && cd->
‰ì_¸y±_¥ov
)

283 
	`Cry±Rñó£C⁄ãxt
(
cd
->
¸y±_¥ov
, 0);

284 i‡(
cd
->
˚π_c⁄ãxt
)

285 
	`CîtFªeCîtifiˇãC⁄ãxt
(
cd
->
˚π_c⁄ãxt
);

286 
	`‰ì
(
rß
->
mëh
->
≠p_d©a
);

287 
	`‰ì
((*Ë
rß
->
mëh
);

288 
rß
->
mëh
 = 
NULL
;

290 
	}
}

292 c⁄° 
CERT_CONTEXT
 *
	$föd_˚πifiˇã_ö_°‹e
(c⁄° *
˚π_¥›
, 
HCERTSTORE
 
˚π_°‹e
)

300 c⁄° 
CERT_CONTEXT
 *
rv
 = 
NULL
;

302 i‡(!
	`°∫cmp
(
˚π_¥›
, "SUBJ:", 5)) {

304 
˚π_¥›
 += 5;

305 
rv
 = 
	`CîtFödCîtifiˇãInSt‹e
(
˚π_°‹e
, 
X509_ASN_ENCODING
 | 
PKCS_7_ASN_ENCODING
,

306 0, 
CERT_FIND_SUBJECT_STR_A
, 
˚π_¥›
, 
NULL
);

308 } i‡(!
	`°∫cmp
(
˚π_¥›
, "THUMB:", 6)) {

309 
hash
[255];

310 *
p
;

311 
i
, 
x
 = 0;

312 
CRYPT_HASH_BLOB
 
blob
;

315 
˚π_¥›
 += 6;

316 
p
 = (*Ë
˚π_¥›
, 
i
 = 0; *∞&& i < (
hash
); i++) {

317 i‡(*
p
 >= '0' && *p <= '9')

318 
x
 = (*
p
 - '0') << 4;

319 i‡(*
p
 >= 'A' && *p <= 'F')

320 
x
 = (*
p
 - 'A' + 10) << 4;

321 i‡(*
p
 >= 'a' && *p <= 'f')

322 
x
 = (*
p
 - 'a' + 10) << 4;

323 i‡(!*++
p
)

325 i‡(*
p
 >= '0' && *p <= '9')

326 
x
 +*
p
 - '0';

327 i‡(*
p
 >= 'A' && *p <= 'F')

328 
x
 +*
p
 - 'A' + 10;

329 i‡(*
p
 >= 'a' && *p <= 'f')

330 
x
 +*
p
 - 'a' + 10;

331 
hash
[
i
] = 
x
;

333 
p
++; *p && *p == ' ';Ö++);

335 
blob
.
cbD©a
 = 
i
;

336 
blob
.
pbD©a
 = (*Ë&
hash
;

337 
rv
 = 
	`CîtFödCîtifiˇãInSt‹e
(
˚π_°‹e
, 
X509_ASN_ENCODING
 | 
PKCS_7_ASN_ENCODING
,

338 0, 
CERT_FIND_HASH
, &
blob
, 
NULL
);

342  
rv
;

343 
	}
}

345 
	$SSL_CTX_u£_Cry±oAPI_˚πifiˇã
(
SSL_CTX
 *
s¶_˘x
, c⁄° *
˚π_¥›
)

347 
HCERTSTORE
 
cs
;

348 
X509
 *
˚π
 = 
NULL
;

349 
RSA
 *
rß
 = 
NULL
, *
pub_rß
;

350 
CAPI_DATA
 *
cd
 = 
	`ˇŒoc
(1, (*cd));

351 
RSA_METHOD
 *
my_rß_mëhod
 = 
	`ˇŒoc
(1, (*my_rsa_method));

353 i‡(
cd
 =
NULL
 || 
my_rß_mëhod
 == NULL) {

354 
	`SSLîr
(
SSL_F_SSL_CTX_USE_CERTIFICATE_FILE
, 
ERR_R_MALLOC_FAILURE
);

355 
îr
;

358 
cs
 = 
	`CîtO≥nSt‹e
((
LPCSTR
Ë
CERT_STORE_PROV_SYSTEM
, 0, 0, 
CERT_SYSTEM_STORE_CURRENT_USER
 |

359 
CERT_STORE_OPEN_EXISTING_FLAG
 | 
CERT_STORE_READONLY_FLAG
, 
L
"MY");

360 i‡(
cs
 =
NULL
) {

361 
	`CRYPTOAPIîr
(
CRYPTOAPI_F_CERT_OPEN_SYSTEM_STORE
);

362 
îr
;

364 
cd
->
˚π_c⁄ãxt
 = 
	`föd_˚πifiˇã_ö_°‹e
(
˚π_¥›
, 
cs
);

365 
	`CîtClo£St‹e
(
cs
, 0);

366 i‡(!
cd
->
˚π_c⁄ãxt
) {

367 
cs
 = 
	`CîtO≥nSt‹e
((
LPCSTR
Ë
CERT_STORE_PROV_SYSTEM
, 0, 0, 
CERT_SYSTEM_STORE_LOCAL_MACHINE
 |

368 
CERT_STORE_OPEN_EXISTING_FLAG
 | 
CERT_STORE_READONLY_FLAG
, 
L
"MY");

369 i‡(
cs
 =
NULL
) {

370 
	`CRYPTOAPIîr
(
CRYPTOAPI_F_CERT_OPEN_SYSTEM_STORE
);

371 
îr
;

373 
cd
->
˚π_c⁄ãxt
 = 
	`föd_˚πifiˇã_ö_°‹e
(
˚π_¥›
, 
cs
);

374 
	`CîtClo£St‹e
(
cs
, 0);

375 i‡(
cd
->
˚π_c⁄ãxt
 =
NULL
) {

376 
	`CRYPTOAPIîr
(
CRYPTOAPI_F_CERT_FIND_CERTIFICATE_IN_STORE
);

377 
îr
;

382 
˚π
 = 
	`d2i_X509
(
NULL
, (c⁄° **Ë&
cd
->
˚π_c⁄ãxt
->
pbCîtEncoded
,

383 
cd
->
˚π_c⁄ãxt
->
cbCîtEncoded
);

384 i‡(
˚π
 =
NULL
) {

385 
	`SSLîr
(
SSL_F_SSL_CTX_USE_CERTIFICATE_FILE
, 
ERR_R_ASN1_LIB
);

386 
îr
;

390 i‡(!
	`Cry±AcquúeCîtifiˇãPriv©eKey
(
cd
->
˚π_c⁄ãxt
, 
CRYPT_ACQUIRE_COMPARE_KEY_FLAG
,

391 
NULL
, &
cd
->
¸y±_¥ov
, &cd->
key_•ec
, &cd->
‰ì_¸y±_¥ov
)) {

395 
	`CRYPTOAPIîr
(
CRYPTOAPI_F_CRYPT_ACQUIRE_CERTIFICATE_PRIVATE_KEY
);

396 
îr
;

401 
my_rß_mëhod
->
«me
 = "Microsoft CryptoAPI RSA Method";

402 
my_rß_mëhod
->
rß_pub_íc
 =Ñsa_pub_enc;

403 
my_rß_mëhod
->
rß_pub_dec
 =Ñsa_pub_dec;

404 
my_rß_mëhod
->
rß_¥iv_íc
 =Ñsa_priv_enc;

405 
my_rß_mëhod
->
rß_¥iv_dec
 =Ñsa_priv_dec;

407 
my_rß_mëhod
->
föish
 = finish;

408 
my_rß_mëhod
->
Êags
 = 
RSA_METHOD_FLAG_NO_CHECK
;

409 
my_rß_mëhod
->
≠p_d©a
 = (*Ë
cd
;

411 
rß
 = 
	`RSA_√w
();

412 i‡(
rß
 =
NULL
) {

413 
	`SSLîr
(
SSL_F_SSL_CTX_USE_CERTIFICATE_FILE
, 
ERR_R_MALLOC_FAILURE
);

414 
îr
;

419 i‡(!
	`SSL_CTX_u£_˚πifiˇã
(
s¶_˘x
, 
˚π
))

420 
îr
;

422 
pub_rß
 = 
˚π
->
˚π_öfo
->
key
->
pkey
->pkey.
rß
;

425 
	`X509_‰ì
(
˚π
);

426 
˚π
 = 
NULL
;

430 
rß
->
n
 = 
	`BN_dup
(
pub_rß
->n);

431 
rß
->
Êags
 |
RSA_FLAG_EXT_PKEY
;

432 i‡(!
	`RSA_£t_mëhod
(
rß
, 
my_rß_mëhod
))

433 
îr
;

435 i‡(!
	`SSL_CTX_u£_RSAPriv©eKey
(
s¶_˘x
, 
rß
))

436 
îr
;

439 
	`RSA_‰ì
(
rß
);

442 
îr
:

443 i‡(
˚π
)

444 
	`X509_‰ì
(
˚π
);

445 i‡(
rß
)

446 
	`RSA_‰ì
(
rß
);

448 i‡(
my_rß_mëhod
)

449 
	`‰ì
(
my_rß_mëhod
);

450 i‡(
cd
) {

451 i‡(
cd
->
‰ì_¸y±_¥ov
 && cd->
¸y±_¥ov
)

452 
	`Cry±Rñó£C⁄ãxt
(
cd
->
¸y±_¥ov
, 0);

453 i‡(
cd
->
˚π_c⁄ãxt
)

454 
	`CîtFªeCîtifiˇãC⁄ãxt
(
cd
->
˚π_c⁄ãxt
);

455 
	`‰ì
(
cd
);

459 
	}
}

462 #ifde‡
_MSC_VER


463 
	$dummy
 (Ë{
	}
}

	@src/openvpn/cryptoapi.h

1 #i‚de‡
_CRYPTOAPI_H_


2 
	#_CRYPTOAPI_H_


	)

4 
SSL_CTX_u£_Cry±oAPI_˚πifiˇã
(
SSL_CTX
 *
s¶_˘x
, c⁄° *
˚π_¥›
);

	@src/openvpn/dhcp.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"dh˝.h
"

34 
	~"sockë.h
"

35 
	~"îr‹.h
"

37 
	~"memdbg.h
"

40 
	$gë_dh˝_mesßge_ty≥
 (c⁄° 
dh˝
 *dh˝, c⁄° 
›éí
)

42 c⁄° 
uöt8_t
 *
p
 = (uöt8_à*Ë(
dh˝
 + 1);

43 
i
;

45 
i
 = 0; i < 
›éí
; ++i)

47 c⁄° 
uöt8_t
 
ty≥
 = 
p
[
i
];

48 c⁄° 
room
 = 
›éí
 - 
i
;

49 i‡(
ty≥
 =
DHCP_END
)

51 i‡(
ty≥
 =
DHCP_PAD
)

53 i‡(
ty≥
 =
DHCP_MSG_TYPE
)

55 i‡(
room
 >= 3)

57 i‡(
p
[
i
+1] == 1)

58  
p
[
i
+2];

64 i‡(
room
 >= 2)

66 c⁄° 
Àn
 = 
p
[
i
+1];

67 
i
 +(
Àn
 + 1);

72 
	}
}

74 
ö_addr_t


75 
	$do_exåa˘
 (
dh˝
 *dh˝, 
›éí
)

77 
uöt8_t
 *
p
 = (uöt8_à*Ë(
dh˝
 + 1);

78 
i
;

79 
ö_addr_t
 
ªt
 = 0;

81 
i
 = 0; i < 
›éí
; )

83 c⁄° 
uöt8_t
 
ty≥
 = 
p
[
i
];

84 c⁄° 
room
 = 
›éí
 - 
i
;

85 i‡(
ty≥
 =
DHCP_END
)

87 i‡(
ty≥
 =
DHCP_PAD
)

88 ++
i
;

89 i‡(
ty≥
 =
DHCP_ROUTER
)

91 i‡(
room
 >= 2)

93 c⁄° 
Àn
 = 
p
[
i
+1];

94 i‡(
Àn
 <(
room
-2))

97 i‡(!
ªt
 && 
Àn
 >= 4 && (len & 3) == 0)

99 
	`mem˝y
 (&
ªt
, 
p
+
i
+2, 4);

100 
ªt
 = 
	`¡ohl
 (ret);

104 
uöt8_t
 *
de°
 = 
p
 + 
i
;

105 c⁄° 
owÀn
 = 
Àn
 + 2;

106 
uöt8_t
 *
§c
 = 
de°
 + 
owÀn
;

107 
uöt8_t
 *
íd
 = 
p
 + 
›éí
;

108 c⁄° 
movÀn
 = 
íd
 - 
§c
;

109 i‡(
movÀn
 > 0)

110 
	`memmove
(
de°
, 
§c
, 
movÀn
);

111 
	`mem£t
(
íd
 - 
owÀn
, 
DHCP_PAD
, owlen);

122 i‡(
room
 >= 2)

124 c⁄° 
Àn
 = 
p
[
i
+1];

125 
i
 +(
Àn
 + 2);

131  
ªt
;

132 
	}
}

134 
uöt16_t


135 
	$udp_checksum
 (c⁄° 
uöt8_t
 *
buf
,

136 c⁄° 
Àn_udp
,

137 c⁄° 
uöt8_t
 *
§c_addr
,

138 c⁄° 
uöt8_t
 *
de°_addr
)

140 
uöt16_t
 
w‹d16
;

141 
uöt32_t
 
sum
 = 0;

142 
i
;

146 
i
 = 0; i < 
Àn_udp
; i += 2){

147 
w‹d16
 = ((
buf
[
i
] << 8Ë& 0xFF00Ë+ ((ò+ 1 < 
Àn_udp
) ? (buf[i+1] & 0xFF) : 0);

148 
sum
 +
w‹d16
;

152 
i
 = 0; i < 4; i += 2){

153 
w‹d16
 =((
§c_addr
[
i
] << 8) & 0xFF00) + (src_addr[i+1] & 0xFF);

154 
sum
 +
w‹d16
;

156 
i
 = 0; i < 4; i += 2){

157 
w‹d16
 =((
de°_addr
[
i
] << 8) & 0xFF00) + (dest_addr[i+1] & 0xFF);

158 
sum
 +
w‹d16
;

162 
sum
 +(
uöt16_t
Ë
OPENVPN_IPPROTO_UDP
 + (uöt16_tË
Àn_udp
;

165 
sum
 >> 16)

166 
sum
 = (sum & 0xFFFF) + (sum >> 16);

169  ((
uöt16_t
Ë~
sum
);

170 
	}
}

172 
ö_addr_t


173 
	$dh˝_exåa˘_rouãr_msg
 (
buf„r
 *
ùbuf
)

175 
dh˝_fuŒ
 *
df
 = (dh˝_fuŒ *Ë
	`BPTR
 (
ùbuf
);

176 c⁄° 
›éí
 = 
	`BLEN
 (
ùbuf
Ë- ( (
›ív≤_ùhdr
Ë+  (
›ív≤_udphdr
Ë+  (
dh˝
));

178 i‡(
›éí
 >= 0

179 && 
df
->
ù
.
¥Ÿocﬁ
 =
OPENVPN_IPPROTO_UDP


180 && 
df
->
udp
.
sour˚
 =
	`ht⁄s
 (
BOOTPS_PORT
)

181 && 
df
->
udp
.
de°
 =
	`ht⁄s
 (
BOOTPC_PORT
)

182 && 
df
->
dh˝
.
›
 =
BOOTREPLY
)

184 c⁄° 
mesßge_ty≥
 = 
	`gë_dh˝_mesßge_ty≥
 (&
df
->
dh˝
, 
›éí
);

185 i‡(
mesßge_ty≥
 =
DHCPACK
 || mesßge_ty≥ =
DHCPOFFER
)

188 c⁄° 
ö_addr_t
 
ªt
 = 
	`do_exåa˘
 (&
df
->
dh˝
, 
›éí
);

191 
df
->
udp
.
check
 = 0;

192 
df
->
udp
.
check
 = 
	`ht⁄s
 (
	`udp_checksum
 ((
uöt8_t
 *) &df->udp,

193  (
›ív≤_udphdr
Ë+  (
dh˝
Ë+ 
›éí
,

194 (
uöt8_t
 *)&
df
->
ù
.
ßddr
,

195 (
uöt8_t
 *)&
df
->
ù
.
daddr
));

198 i‡(
mesßge_ty≥
 =
DHCPACK
)

200 i‡(
ªt
)

202 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

203 
	`msg
 (
D_ROUTE
, "Exåa˘ed DHCPÑouã∏addªss: %s", 
	`¥öt_ö_addr_t
 (
ªt
, 0, &
gc
));

204 
	`gc_‰ì
 (&
gc
);

207  
ªt
;

212 
	}
}

	@src/openvpn/dhcp.h

25 #i‚de‡
DHCP_H


26 
	#DHCP_H


	)

28 
	~"comm⁄.h
"

29 
	~"buf„r.h
"

30 
	~"¥Ÿo.h
"

32 #¥agm®
∑ck
(1)

35 
	#DHCP_PAD
 0

	)

36 
	#DHCP_ROUTER
 3

	)

37 
	#DHCP_MSG_TYPE
 53

	)

38 
	#DHCP_END
 255

	)

41 
	#DHCPDISCOVER
 1

	)

42 
	#DHCPOFFER
 2

	)

43 
	#DHCPREQUEST
 3

	)

44 
	#DHCPDECLINE
 4

	)

45 
	#DHCPACK
 5

	)

46 
	#DHCPNAK
 6

	)

47 
	#DHCPRELEASE
 7

	)

48 
	#DHCPINFORM
 8

	)

51 
	#BOOTPS_PORT
 67

	)

52 
	#BOOTPC_PORT
 68

	)

54 
	sdh˝
 {

55 
	#BOOTREQUEST
 1

	)

56 
	#BOOTREPLY
 2

	)

57 
uöt8_t
 
	m›
;

59 
uöt8_t
 
	mhty≥
;

60 
uöt8_t
 
	mhÀn
;

61 
uöt8_t
 
	mh›s
;

62 
uöt32_t
 
	mxid
;

63 
uöt16_t
 
	m£cs
;

64 
uöt16_t
 
	mÊags
;

65 
uöt32_t
 
	mcüddr
;

66 
uöt32_t
 
	myüddr
;

67 
uöt32_t
 
	msüddr
;

68 
uöt32_t
 
	mgüddr
;

69 
uöt8_t
 
	mchaddr
[16];

70 
uöt8_t
 
	m¢ame
[64];

71 
uöt8_t
 
	mfûe
[128];

72 
uöt32_t
 
	mmagic
;

75 
	sdh˝_fuŒ
 {

76 
›ív≤_ùhdr
 
	mù
;

77 
›ív≤_udphdr
 
	mudp
;

78 
dh˝
 
	mdh˝
;

79 
	#DHCP_OPTIONS_BUFFER_SIZE
 256

	)

80 
uöt8_t
 
	m›ti⁄s
[
DHCP_OPTIONS_BUFFER_SIZE
];

83 #¥agm®
∑ck
()

85 
ö_addr_t
 
dh˝_exåa˘_rouãr_msg
 (
buf„r
 *
ùbuf
);

	@src/openvpn/errlevel.h

25 #i‚de‡
ERRLEVEL_H


26 
	#ERRLEVEL_H


	)

28 
	~"îr‹.h
"

34 
	#DEBUG_LEVEL_USEC_TIME
 4

	)

42 
	#P2P_ERROR_DELAY_MS
 0

	)

47 
	#LOG_RW


	)

54 
	#M_VERB0
 
	`LOGLEV
(0, 0, 0Ë

	)

56 
	#M_INFO
 
	`LOGLEV
(1, 0, 0Ë

	)

58 
	#D_LINK_ERRORS
 
	`LOGLEV
(1, 1, 
M_NONFATAL
Ë

	)

59 
	#D_CRYPT_ERRORS
 
	`LOGLEV
(1, 2, 
M_NONFATAL
Ë

	)

60 
	#D_TLS_ERRORS
 
	`LOGLEV
(1, 3, 
M_NONFATAL
Ë

	)

61 
	#D_RESOLVE_ERRORS
 
	`LOGLEV
(1, 4, 
M_NONFATAL
Ë

	)

62 
	#D_COMP_ERRORS
 
	`LOGLEV
(1, 5, 
M_NONFATAL
Ë

	)

63 
	#D_REPLAY_ERRORS
 
	`LOGLEV
(1, 6, 
M_NONFATAL
Ë

	)

64 
	#D_STREAM_ERRORS
 
	`LOGLEV
(1, 7, 
M_NONFATAL
Ë

	)

65 
	#D_IMPORT_ERRORS
 
	`LOGLEV
(1, 8, 
M_NONFATAL
Ë

	)

66 
	#D_MULTI_ERRORS
 
	`LOGLEV
(1, 9, 
M_NONFATAL
Ë

	)

67 
	#D_EVENT_ERRORS
 
	`LOGLEV
(1, 10, 
M_NONFATAL
Ë

	)

68 
	#D_PUSH_ERRORS
 
	`LOGLEV
(1, 11, 
M_NONFATAL
Ë

	)

69 
	#D_PID_PERSIST
 
	`LOGLEV
(1, 12, 
M_NONFATAL
Ë

	)

70 
	#D_FRAG_ERRORS
 
	`LOGLEV
(1, 13, 
M_NONFATAL
Ë

	)

71 
	#D_ALIGN_ERRORS
 
	`LOGLEV
(1, 14, 
M_NONFATAL
Ë

	)

73 
	#D_HANDSHAKE
 
	`LOGLEV
(2, 20, 0Ë

	)

74 
	#D_CLOSE
 
	`LOGLEV
(2, 22, 0Ë

	)

75 
	#D_PROXY
 
	`LOGLEV
(2, 24, 0Ë

	)

76 
	#D_ARGV
 
	`LOGLEV
(2, 25, 0Ë

	)

78 
	#D_TLS_DEBUG_LOW
 
	`LOGLEV
(3, 20, 0Ë

	)

79 
	#D_GREMLIN
 
	`LOGLEV
(3, 30, 0Ë

	)

80 
	#D_GENKEY
 
	`LOGLEV
(3, 31, 0Ë

	)

81 
	#D_ROUTE
 
	`LOGLEV
(3, 0, 0Ë

	)

82 
	#D_TUNTAP_INFO
 
	`LOGLEV
(3, 32, 0Ë

	)

83 
	#D_RESTART
 
	`LOGLEV
(3, 33, 0Ë

	)

84 
	#D_PUSH
 
	`LOGLEV
(3, 34, 0Ë

	)

85 
	#D_IFCONFIG_POOL
 
	`LOGLEV
(3, 35, 0Ë

	)

86 
	#D_AUTH
 
	`LOGLEV
(3, 37, 0Ë

	)

87 
	#D_MULTI_LOW
 
	`LOGLEV
(3, 38, 0Ë

	)

88 
	#D_PLUGIN
 
	`LOGLEV
(3, 39, 0Ë

	)

89 
	#D_MANAGEMENT
 
	`LOGLEV
(3, 40, 0Ë

	)

90 
	#D_SCHED_EXIT
 
	`LOGLEV
(3, 41, 0Ë

	)

91 
	#D_ROUTE_QUOTA
 
	`LOGLEV
(3, 42, 0Ë

	)

92 
	#D_OSBUF
 
	`LOGLEV
(3, 43, 0Ë

	)

93 
	#D_PS_PROXY
 
	`LOGLEV
(3, 44, 0Ë

	)

94 
	#D_PF_INFO
 
	`LOGLEV
(3, 45, 0Ë

	)

96 
	#D_SHOW_PARMS
 
	`LOGLEV
(4, 50, 0Ë

	)

97 
	#D_SHOW_OCC
 
	`LOGLEV
(4, 51, 0Ë

	)

98 
	#D_LOW
 
	`LOGLEV
(4, 52, 0Ë

	)

99 
	#D_DHCP_OPT
 
	`LOGLEV
(4, 53, 0Ë

	)

100 
	#D_MBUF
 
	`LOGLEV
(4, 54, 0Ë

	)

101 
	#D_PACKET_TRUNC_ERR
 
	`LOGLEV
(4, 55, 0Ë

	)

102 
	#D_PF_DROPPED
 
	`LOGLEV
(4, 56, 0Ë

	)

103 
	#D_MULTI_DROPPED
 
	`LOGLEV
(4, 57, 0Ë

	)

104 
	#D_MULTI_MEDIUM
 
	`LOGLEV
(4, 58, 0Ë

	)

105 
	#D_X509_ATTR
 
	`LOGLEV
(4, 59, 0Ë

	)

106 
	#D_INIT_MEDIUM
 
	`LOGLEV
(4, 60, 0Ë

	)

107 
	#D_MTU_INFO
 
	`LOGLEV
(4, 61, 0Ë

	)

108 
	#D_SHOW_OCC_HASH
 
	`LOGLEV
(4, 62, 0Ë

	)

109 
	#D_PID_DEBUG_LOW
 
	`LOGLEV
(4, 63, 0Ë

	)

110 
	#D_PID_DEBUG_MEDIUM
 
	`LOGLEV
(4, 64, 0Ë

	)

112 
	#D_LOG_RW
 
	`LOGLEV
(5, 0, 0Ë

	)

114 
	#D_LINK_RW
 
	`LOGLEV
(6, 69, 
M_DEBUG
Ë

	)

115 
	#D_TUN_RW
 
	`LOGLEV
(6, 69, 
M_DEBUG
Ë

	)

116 
	#D_TAP_WIN_DEBUG
 
	`LOGLEV
(6, 69, 
M_DEBUG
Ë

	)

117 
	#D_CLIENT_NAT
 
	`LOGLEV
(6, 69, 
M_DEBUG
Ë

	)

119 
	#D_SHOW_KEYS
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

120 
	#D_SHOW_KEY_SOURCE
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

121 
	#D_REL_LOW
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

122 
	#D_FRAG_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

123 
	#D_WIN32_IO_LOW
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

124 
	#D_MTU_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

125 
	#D_MULTI_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

126 
	#D_MSS
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

127 
	#D_COMP_LOW
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

128 
	#D_CONNECTION_LIST
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

129 
	#D_SCRIPT
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

130 
	#D_SHOW_NET
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

131 
	#D_ROUTE_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

132 
	#D_TLS_STATE_ERRORS
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

133 
	#D_SEMAPHORE_LOW
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

134 
	#D_SEMAPHORE
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

135 
	#D_TEST_FILE
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

136 
	#D_MANAGEMENT_DEBUG
 
	`LOGLEV
(3, 70, 
M_DEBUG
Ë

	)

137 
	#D_PLUGIN_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

138 
	#D_SOCKET_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

139 
	#D_SHOW_PKCS11
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

140 
	#D_ALIGN_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

141 
	#D_PACKET_TRUNC_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

142 
	#D_PING
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

143 
	#D_PS_PROXY_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

144 
	#D_AUTO_USERID
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

145 
	#D_TLS_KEYSELECT
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

146 
	#D_ARGV_PARSE_CMD
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

147 
	#D_CRYPTO_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

148 
	#D_PID_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
Ë

	)

149 
	#D_PF_DROPPED_BCAST
 
	`LOGLEV
(7, 71, 
M_DEBUG
Ë

	)

150 
	#D_PF_DEBUG
 
	`LOGLEV
(7, 72, 
M_DEBUG
Ë

	)

152 
	#D_HANDSHAKE_VERBOSE
 
	`LOGLEV
(8, 70, 
M_DEBUG
Ë

	)

153 
	#D_TLS_DEBUG_MED
 
	`LOGLEV
(8, 70, 
M_DEBUG
Ë

	)

154 
	#D_INTERVAL
 
	`LOGLEV
(8, 70, 
M_DEBUG
Ë

	)

155 
	#D_SCHEDULER
 
	`LOGLEV
(8, 70, 
M_DEBUG
Ë

	)

156 
	#D_GREMLIN_VERBOSE
 
	`LOGLEV
(8, 70, 
M_DEBUG
Ë

	)

157 
	#D_REL_DEBUG
 
	`LOGLEV
(8, 70, 
M_DEBUG
Ë

	)

158 
	#D_EVENT_WAIT
 
	`LOGLEV
(8, 70, 
M_DEBUG
Ë

	)

159 
	#D_MULTI_TCP
 
	`LOGLEV
(8, 70, 
M_DEBUG
Ë

	)

161 
	#D_TLS_DEBUG
 
	`LOGLEV
(9, 70, 
M_DEBUG
Ë

	)

162 
	#D_COMP
 
	`LOGLEV
(9, 70, 
M_DEBUG
Ë

	)

163 
	#D_READ_WRITE
 
	`LOGLEV
(9, 70, 
M_DEBUG
Ë

	)

164 
	#D_PACKET_CONTENT
 
	`LOGLEV
(9, 70, 
M_DEBUG
Ë

	)

165 
	#D_TLS_NO_SEND_KEY
 
	`LOGLEV
(9, 70, 
M_DEBUG
Ë

	)

166 
	#D_PID_PERSIST_DEBUG
 
	`LOGLEV
(9, 70, 
M_DEBUG
Ë

	)

167 
	#D_LINK_RW_VERBOSE
 
	`LOGLEV
(9, 70, 
M_DEBUG
Ë

	)

168 
	#D_STREAM_DEBUG
 
	`LOGLEV
(9, 70, 
M_DEBUG
Ë

	)

169 
	#D_WIN32_IO
 
	`LOGLEV
(9, 70, 
M_DEBUG
Ë

	)

170 
	#D_PKCS11_DEBUG
 
	`LOGLEV
(9, 70, 
M_DEBUG
Ë

	)

172 
	#D_SHAPER_DEBUG
 
	`LOGLEV
(10, 70, 
M_DEBUG
Ë

	)

174 
	#D_REGISTRY
 
	`LOGLEV
(11, 70, 
M_DEBUG
Ë

	)

175 
	#D_OPENSSL_LOCK
 
	`LOGLEV
(11, 70, 
M_DEBUG
Ë

	)

	@src/openvpn/error.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"îr‹.h
"

34 
	~"buf„r.h
"

35 
	~"misc.h
"

36 
	~"wö32.h
"

37 
	~"sockë.h
"

38 
	~"tun.h
"

39 
	~"Ÿime.h
"

40 
	~"≥rf.h
"

41 
	~"°©us.h
"

42 
	~"öãgî.h
"

43 
	~"ps.h
"

44 
	~"m°©s.h
"

46 #ifde‡
ENABLE_CRYPTO


47 #ifde‡
ENABLE_CRYPTO_OPENSSL


48 
	~<›ís¶/îr.h
>

52 
	~"memdbg.h
"

54 #i‡
SYSLOG_CAPABILITY


55 #i‚de‡
LOG_OPENVPN


56 
	#LOG_OPENVPN
 
LOG_DAEMON


	)

61 
	gx_debug_Àvñ
;

64 
	gmuã_cutoff
;

65 
	gmuã_cou¡
;

66 
	gmuã_ˇãg‹y
;

80 
boﬁ
 
	g°d_ªdú
;

83 
boﬁ
 
	gu£_sy¶og
;

86 
boﬁ
 
	gsuµªss_time°amps
;

89 #i‡
SYSLOG_CAPABILITY


90 *
	gpgm«me_sy¶og
;

94 
FILE
 *
	gmsgÂ
;

97 
boﬁ
 
	gf‹ked
;

100 
FILE
 *
	gdeÁu…_out
;

101 
FILE
 *
	gdeÁu…_îr
;

104 
	$msg_f‹ked
 ()

106 
f‹ked
 = 
åue
;

107 
	}
}

109 
boﬁ


110 
	$£t_debug_Àvñ
 (c⁄° 
Àvñ
, c⁄° 
Êags
)

112 c⁄° 
˚ûög
 = 15;

114 i‡(
Àvñ
 >0 &&Üevñ <
˚ûög
)

116 
x_debug_Àvñ
 = 
Àvñ
;

117  
åue
;

119 i‡(
Êags
 & 
SDL_CONSTRAIN
)

121 
x_debug_Àvñ
 = 
	`c⁄°øö_öt
 (
Àvñ
, 0, 
˚ûög
);

122  
åue
;

124  
Ál£
;

125 
	}
}

127 
boﬁ


128 
	$£t_muã_cutoff
 (c⁄° 
cutoff
)

130 i‡(
cutoff
 >= 0)

132 
muã_cutoff
 = 
cutoff
;

133  
åue
;

136  
Ál£
;

137 
	}
}

140 
	$gë_debug_Àvñ
 ()

142  
x_debug_Àvñ
;

143 
	}
}

146 
	$gë_muã_cutoff
 ()

148  
muã_cutoff
;

149 
	}
}

152 
	$£t_suµªss_time°amps
 (
boﬁ
 
suµªs£d
)

154 
suµªss_time°amps
 = 
suµªs£d
;

155 
	}
}

158 
	$îr‹_ª£t
 ()

160 
u£_sy¶og
 = 
°d_ªdú
 = 
Ál£
;

161 
suµªss_time°amps
 = 
Ál£
;

162 
x_debug_Àvñ
 = 1;

163 
muã_cutoff
 = 0;

164 
muã_cou¡
 = 0;

165 
muã_ˇãg‹y
 = 0;

166 
deÁu…_out
 = 
OPENVPN_MSG_FP
;

167 
deÁu…_îr
 = 
OPENVPN_MSG_FP
;

169 #ifde‡
OPENVPN_DEBUG_COMMAND_LINE


170 
msgÂ
 = 
	`f›í
 (
OPENVPN_DEBUG_FILE
, "w");

171 i‡(!
msgÂ
)

172 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_CANNOT_OPEN_DEBUG_FILE
);

174 
msgÂ
 = 
NULL
;

176 
	}
}

179 
	$îr‹s_to_°dîr
 ()

181 
deÁu…_îr
 = 
OPENVPN_ERROR_FP
;

182 
	}
}

187 
FILE
 *

188 
	$msg_Â
(c⁄° 
Êags
)

190 
FILE
 *
Â
 = 
msgÂ
;

191 i‡(!
Â
)

192 
Â
 = (
Êags
 & (
M_FATAL
|
M_USAGE_SMALL
)Ë? 
deÁu…_îr
 : 
deÁu…_out
;

193 i‡(!
Â
)

194 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_CANNOT_OPEN_DEBUG_FILE
);

195  
Â
;

196 
	}
}

198 
	#SWAP
 { 
tmp
 = 
m1
; m1 = 
m2
; m2 =Åmp; }

	)

200 
	gx_msg_löe_num
;

202 
	$x_msg
 (c⁄° 
Êags
, c⁄° *
f‹m©
, ...)

204 
va_li°
 
¨gli°
;

205 
	`va_°¨t
 (
¨gli°
, 
f‹m©
);

206 
	`x_msg_va
 (
Êags
, 
f‹m©
, 
¨gli°
);

207 
	`va_íd
 (
¨gli°
);

208 
	}
}

210 
	$x_msg_va
 (c⁄° 
Êags
, c⁄° *
f‹m©
, 
va_li°
 
¨gli°
)

212 
gc_¨ía
 
gc
;

213 #i‡
SYSLOG_CAPABILITY


214 
Àvñ
;

216 *
m1
;

217 *
m2
;

218 *
tmp
;

219 
e
;

220 c⁄° *
¥efix
;

221 c⁄° *
¥efix_£p
;

223 
	`ußge_smÆl
 ();

225 #i‚de‡
HAVE_VARARG_MACROS


227 i‡(!
	`MSG_TEST
 (
Êags
))

231 
e
 = 
	`›ív≤_î∫o
 ();

236 #i‚de‡
HAVE_VARARG_MACROS


238 i‡(!
	`d⁄t_muã
 (
Êags
))

242 
	`gc_öô
 (&
gc
);

244 
m1
 = (*Ë
	`gc_mÆloc
 (
ERR_BUF_SIZE
, 
Ál£
, &
gc
);

245 
m2
 = (*Ë
	`gc_mÆloc
 (
ERR_BUF_SIZE
, 
Ál£
, &
gc
);

247 
	`v¢¥ötf
 (
m1
, 
ERR_BUF_SIZE
, 
f‹m©
, 
¨gli°
);

248 
m1
[
ERR_BUF_SIZE
 - 1] = 0;

250 i‡((
Êags
 & 
M_ERRNO
Ë&& 
e
)

252 
	`›ív≤_¢¥ötf
 (
m2
, 
ERR_BUF_SIZE
, "%s: %s (errno=%d)",

253 
m1
, 
	`°ªº‹_ts
 (
e
, &
gc
),É);

254 
SWAP
;

257 #ifde‡
ENABLE_CRYPTO


258 #ifde‡
ENABLE_CRYPTO_OPENSSL


259 i‡(
Êags
 & 
M_SSL
)

261 
√ºs
 = 0;

262 
îr
;

263 (
îr
 = 
	`ERR_gë_îr‹
 ()))

265 
	`›ív≤_¢¥ötf
 (
m2
, 
ERR_BUF_SIZE
, "%s: %s",

266 
m1
, 
	`ERR_îr‹_°rög
 (
îr
, 
NULL
));

267 
SWAP
;

268 ++
√ºs
;

270 i‡(!
√ºs
)

272 
	`›ív≤_¢¥ötf
 (
m2
, 
ERR_BUF_SIZE
, "%†(O≥nSSL)", 
m1
);

273 
SWAP
;

279 i‡(
Êags
 & 
M_OPTERR
)

281 
	`›ív≤_¢¥ötf
 (
m2
, 
ERR_BUF_SIZE
, "O±i⁄†îr‹: %s", 
m1
);

282 
SWAP
;

285 #i‡
SYSLOG_CAPABILITY


286 i‡(
Êags
 & (
M_FATAL
|
M_NONFATAL
|
M_USAGE_SMALL
))

287 
Àvñ
 = 
LOG_ERR
;

288 i‡(
Êags
 & 
M_WARN
)

289 
Àvñ
 = 
LOG_WARNING
;

291 
Àvñ
 = 
LOG_NOTICE
;

295 i‡(
Êags
 & 
M_NOIPREFIX
)

296 
¥efix
 = 
NULL
;

298 
¥efix
 = 
	`msg_gë_¥efix
 ();

299 
¥efix_£p
 = " ";

300 i‡(!
¥efix
)

301 
¥efix_£p
 = 
¥efix
 = "";

304 i‡(!
f‹ked
)

306 c⁄° 
vútuÆ_ouçut
 *
vo
 = 
	`msg_gë_vútuÆ_ouçut
 ();

307 i‡(
vo
)

309 
	`›ív≤_¢¥ötf
 (
m2
, 
ERR_BUF_SIZE
, "%s%s%s",

310 
¥efix
,

311 
¥efix_£p
,

312 
m1
);

313 
	`vútuÆ_ouçut_¥öt
 (
vo
, 
Êags
, 
m2
);

317 i‡(!(
Êags
 & 
M_MSG_VIRT_OUT
))

319 i‡(
u£_sy¶og
 && !
°d_ªdú
 && !
f‹ked
)

321 #i‡
SYSLOG_CAPABILITY


322 
	`sy¶og
 (
Àvñ
, "%s%s%s",

323 
¥efix
,

324 
¥efix_£p
,

325 
m1
);

330 
FILE
 *
Â
 = 
	`msg_Â
(
Êags
);

331 c⁄° 
boﬁ
 
show_u£c
 = 
	`check_debug_Àvñ
 (
DEBUG_LEVEL_USEC_TIME
);

333 i‡((
Êags
 & 
M_NOPREFIX
Ë|| 
suµªss_time°amps
)

335 
	`Ârötf
 (
Â
, "%s%s%s%s",

336 
¥efix
,

337 
¥efix_£p
,

338 
m1
,

339 (
Êags
&
M_NOLF
) ? "" : "\n");

343 
	`Ârötf
 (
Â
, "%s %s%s%s%s",

344 
	`time_°rög
 (0, 0, 
show_u£c
, &
gc
),

345 
¥efix
,

346 
¥efix_£p
,

347 
m1
,

348 (
Êags
&
M_NOLF
) ? "" : "\n");

350 
	`fÊush
(
Â
);

351 ++
x_msg_löe_num
;

355 i‡(
Êags
 & 
M_FATAL
)

356 
	`msg
 (
M_INFO
, "Exiting dueÅo fatalÉrror");

358 i‡(
Êags
 & 
M_FATAL
)

359 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_ERROR
);

361 i‡(
Êags
 & 
M_USAGE_SMALL
)

362 
	`ußge_smÆl
 ();

364 
	`gc_‰ì
 (&
gc
);

365 
	}
}

370 
boﬁ


371 
	$d⁄t_muã
 (
Êags
)

373 
boﬁ
 
ªt
 = 
åue
;

374 i‡(
muã_cutoff
 > 0 && !(
Êags
 & 
M_NOMUTE
))

376 c⁄° 
muã_Àvñ
 = 
	`DECODE_MUTE_LEVEL
 (
Êags
);

377 i‡(
muã_Àvñ
 > 0 && muã_Àvñ =
muã_ˇãg‹y
)

379 i‡(
muã_cou¡
 =
muã_cutoff
)

380 
	`msg
 (
M_INFO
 | 
M_NOMUTE
, "NOTE: --muteÅriggered...");

381 i‡(++
muã_cou¡
 > 
muã_cutoff
)

382 
ªt
 = 
Ál£
;

386 c⁄° 
suµªs£d
 = 
muã_cou¡
 - 
muã_cutoff
;

387 i‡(
suµªs£d
 > 0)

388 
	`msg
 (
M_INFO
 | 
M_NOMUTE
,

390 
suµªs£d
,

391 
muã_cutoff
);

392 
muã_cou¡
 = 1;

393 
muã_ˇãg‹y
 = 
muã_Àvñ
;

396  
ªt
;

397 
	}
}

400 
	$as£π_Áûed
 (c⁄° *
fûíame
, 
löe
)

402 
	`msg
 (
M_FATAL
, "As£πi⁄ faûedáà%s:%d", 
fûíame
, 
löe
);

403 
	}
}

410 
	$out_of_mem‹y
 ()

412 
	`Ârötf
 (
°dîr
, 
PACKAGE_NAME
 ": Out of Memory\n");

413 
	`exô
 (1);

414 
	}
}

417 
	$›í_sy¶og
 (c⁄° *
pgm«me
, 
boﬁ
 
°dio_to_nuŒ
)

419 #i‡
SYSLOG_CAPABILITY


420 i‡(!
msgÂ
 && !
°d_ªdú
)

422 i‡(!
u£_sy¶og
)

424 
pgm«me_sy¶og
 = 
	`°rög_Æloc
 (
pgm«me
 ?Ögm«mê: 
PACKAGE
, 
NULL
);

425 
	`›ílog
 (
pgm«me_sy¶og
, 
LOG_PID
, 
LOG_OPENVPN
);

426 
u£_sy¶og
 = 
åue
;

429 i‡(
°dio_to_nuŒ
)

430 
	`£t_°d_fûes_to_nuŒ
 (
Ál£
);

434 
	`msg
 (
M_WARN
, "Warning on use of --daemon/--inetd:Åhis operating systemÜacks daemonÜogging features,Åherefore when I becomeá daemon, I won't beábleÅoÜog status orÉrror messages");

436 
	}
}

439 
	$˛o£_sy¶og
 ()

441 #i‡
SYSLOG_CAPABILITY


442 i‡(
u£_sy¶og
)

444 
	`˛o£log
();

445 
u£_sy¶og
 = 
Ál£
;

446 i‡(
pgm«me_sy¶og
)

448 
	`‰ì
 (
pgm«me_sy¶og
);

449 
pgm«me_sy¶og
 = 
NULL
;

453 
	}
}

455 #ifde‡
WIN32


457 
HANDLE
 
	g‹ig_°dîr
;

459 
HANDLE


460 
	$gë_‹ig_°dîr
 ()

462 i‡(
‹ig_°dîr
)

463  
‹ig_°dîr
;

465  
	`GëStdH™dÀ
 (
STD_ERROR_HANDLE
);

466 
	}
}

471 
	$ªdúe˘_°dout_°dîr
 (c⁄° *
fûe
, 
boﬁ
 
≠≥nd
)

473 #i‡
	`deföed
(
WIN32
)

474 i‡(!
°d_ªdú
)

476 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

477 
HANDLE
 
log_h™dÀ
;

478 
log_fd
;

480 
SECURITY_ATTRIBUTES
 
ßAâr
;

481 
ßAâr
.
nLígth
 = (
SECURITY_ATTRIBUTES
);

482 
ßAâr
.
bInhîôH™dÀ
 = 
TRUE
;

483 
ßAâr
.
ÕSecurôyDes¸ùt‹
 = 
NULL
;

485 
log_h™dÀ
 = 
	`Cª©eFûeW
 (
	`wide_°rög
 (
fûe
, &
gc
),

486 
GENERIC_WRITE
,

487 
FILE_SHARE_READ
,

488 &
ßAâr
,

489 
≠≥nd
 ? 
OPEN_ALWAYS
 : 
CREATE_ALWAYS
,

490 
FILE_ATTRIBUTE_NORMAL
,

491 
NULL
);

493 
	`gc_‰ì
 (&
gc
);

495 i‡(
log_h™dÀ
 =
INVALID_HANDLE_VALUE
)

497 
	`msg
 (
M_WARN
|
M_ERRNO
, "W¨nög: c™nŸ o≥¿--log fûe: %s", 
fûe
);

502 i‡(
≠≥nd
)

504 i‡(
	`SëFûePoöãr
 (
log_h™dÀ
, 0, 
NULL
, 
FILE_END
Ë=
INVALID_SET_FILE_POINTER
)

505 
	`msg
 (
M_ERR
, "Eº‹: c™nŸ sìkÅÿíd o‡--log fûe: %s", 
fûe
);

509 
‹ig_°dîr
 = 
	`GëStdH™dÀ
 (
STD_ERROR_HANDLE
);

513 i‡(!
	`SëStdH™dÀ
 (
STD_OUTPUT_HANDLE
, 
log_h™dÀ
)

514 || !
	`SëStdH™dÀ
 (
STD_ERROR_HANDLE
, 
log_h™dÀ
))

515 
	`msg
 (
M_ERR
, "Eº‹: c™nŸÑedúe˘ stdout/°dî∏tÿ--log fûe: %s", 
fûe
);

519 
log_fd
 = 
	`_›í_osfh™dÀ
 ((
öçå_t
)
log_h™dÀ
, 
_O_TEXT
);

520 i‡(
log_fd
 == -1)

521 
	`msg
 (
M_ERR
, "Error: --logÑedirect failed dueÅo _open_osfhandle failure");

524 
	`ASSERT
 (
msgÂ
 =
NULL
);

525 
msgÂ
 = 
	`_fd›í
 (
log_fd
, "wt");

526 i‡(
msgÂ
 =
NULL
)

527 
	`msg
 (
M_ERR
, "Error: --logÑedirect failed dueÅo _fdopen");

530 i‡(
	`_dup2
 (
log_fd
, 1) == -1 || _dup2 (log_fd, 2) == -1)

531 
	`msg
 (
M_WARN
, "Error: --logÑedirect of stdout/stderr failed");

533 
°d_ªdú
 = 
åue
;

535 #ñi‡
	`deföed
(
HAVE_DUP2
)

536 i‡(!
°d_ªdú
)

538 
out
 = 
	`›í
 (
fûe
,

539 
O_CREAT
 | 
O_WRONLY
 | (
≠≥nd
 ? 
O_APPEND
 : 
O_TRUNC
),

540 
S_IRUSR
 | 
S_IWUSR
);

542 i‡(
out
 < 0)

544 
	`msg
 (
M_WARN
|
M_ERRNO
, "W¨nög: Eº‹Ñedúe˘ög stdout/°dî∏tÿ--log fûe: %s", 
fûe
);

548 i‡(
	`dup2
 (
out
, 1) == -1)

549 
	`msg
 (
M_ERR
, "--log fileÑedirectionÉrror on stdout");

550 i‡(
	`dup2
 (
out
, 2) == -1)

551 
	`msg
 (
M_ERR
, "--log fileÑedirectionÉrror on stderr");

553 i‡(
out
 > 2)

554 
	`˛o£
 (
out
);

556 
°d_ªdú
 = 
åue
;

560 
	`msg
 (
M_WARN
, "WARNING: The --log option isÇot supported onÅhis OS because itÜacksÅhe dup2 function");

562 
	}
}

569 
	gx_cs_öfo_Àvñ
;

570 
	gx_cs_vîbo£_Àvñ
;

571 
	gx_cs_îr_dñay_ms
;

574 
	$ª£t_check_°©us
 ()

576 
x_cs_öfo_Àvñ
 = 0;

577 
x_cs_vîbo£_Àvñ
 = 0;

578 
	}
}

581 
	$£t_check_°©us
 (
öfo_Àvñ
, 
vîbo£_Àvñ
)

583 
x_cs_öfo_Àvñ
 = 
öfo_Àvñ
;

584 
x_cs_vîbo£_Àvñ
 = 
vîbo£_Àvñ
;

585 
	}
}

596 
	$x_check_°©us
 (
°©us
,

597 c⁄° *
des¸ùti⁄
,

598 
lök_sockë
 *
sock
,

599 
tu¡≠
 *
â
)

601 c⁄° 
my_î∫o
 = 
	`›ív≤_î∫o
 ();

602 c⁄° *
exãnded_msg
 = 
NULL
;

604 
	`msg
 (
x_cs_vîbo£_Àvñ
, "%s %sÑeturned %d",

605 
sock
 ? 
	`¥Ÿo2ascii
 (sock->
öfo
.
¥Ÿo
, 
åue
) : "",

606 
des¸ùti⁄
,

607 
°©us
);

609 i‡(
°©us
 < 0)

611 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

612 #i‡
EXTENDED_SOCKET_ERROR_CAPABILITY


614 i‡(
sock
)

616 
mtu
;

617 
exãnded_msg
 = 
	`f‹m©_exãnded_sockë_îr‹
 (
sock
->
sd
, &
mtu
, &
gc
);

618 i‡(
mtu
 > 0 && 
sock
->mtu != mtu)

620 
sock
->
mtu
 = mtu;

621 
sock
->
öfo
.
mtu_ch™ged
 = 
åue
;

624 #ñi‡
	`deföed
(
WIN32
)

626 
exãnded_msg
 = 
	`èp_wö_gëöfo
 (
â
, &
gc
);

628 i‡(!
	`ign‹e_sys_îr‹
 (
my_î∫o
))

630 i‡(
exãnded_msg
)

631 
	`msg
 (
x_cs_öfo_Àvñ
, "%s %s [%s]: %s (code=%d)",

632 
des¸ùti⁄
,

633 
sock
 ? 
	`¥Ÿo2ascii
 (sock->
öfo
.
¥Ÿo
, 
åue
) : "",

634 
exãnded_msg
,

635 
	`°ªº‹_ts
 (
my_î∫o
, &
gc
),

636 
my_î∫o
);

638 
	`msg
 (
x_cs_öfo_Àvñ
, "%s %s: %s (code=%d)",

639 
des¸ùti⁄
,

640 
sock
 ? 
	`¥Ÿo2ascii
 (sock->
öfo
.
¥Ÿo
, 
åue
) : "",

641 
	`°ªº‹_ts
 (
my_î∫o
, &
gc
),

642 
my_î∫o
);

644 i‡(
x_cs_îr_dñay_ms
)

645 
	`∂©f‹m_¶ìp_mûli£c⁄ds
 (
x_cs_îr_dñay_ms
);

647 
	`gc_‰ì
 (&
gc
);

649 
	}
}

655 c⁄° *
	gx_msg_¥efix
;

661 c⁄° 
vútuÆ_ouçut
 *
	gx_msg_vútuÆ_ouçut
;

668 
	$›ív≤_exô
 (c⁄° 
°©us
)

670 i‡(!
f‹ked
)

672 
	`tun_ab‹t
();

673 #ifde‡
ENABLE_PLUGIN


674 
	`∂ugö_ab‹t
 ();

677 
	`tun_ab‹t
();

679 #ifde‡
WIN32


680 
	`unöô_wö32
 ();

683 
	`˛o£_sy¶og
 ();

685 #ifde‡
ENABLE_PLUGIN


686 
	`∂ugö_ab‹t
 ();

689 #i‡
PORT_SHARE


690 i‡(
p‹t_sh¨e
)

691 
	`p‹t_sh¨e_ab‹t
 (
p‹t_sh¨e
);

694 #ifde‡
ENABLE_MEMSTATS


695 
	`m°©s_˛o£
();

698 #ifde‡
ABORT_ON_ERROR


699 i‡(
°©us
 =
OPENVPN_EXIT_STATUS_ERROR
)

700 
	`ab‹t
 ();

703 i‡(
°©us
 =
OPENVPN_EXIT_STATUS_GOOD
)

704 
	`≥rf_ouçut_ªsu…s
 ();

707 
	`exô
 (
°©us
);

708 
	}
}

714 
	$msg_Êags_°rög
 (c⁄° 
Êags
, 
gc_¨ía
 *
gc
)

716 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (16, 
gc
);

717 i‡(
Êags
 =
M_INFO
)

718 
	`buf_¥ötf
 (&
out
, "I");

719 i‡(
Êags
 & 
M_FATAL
)

720 
	`buf_¥ötf
 (&
out
, "F");

721 i‡(
Êags
 & 
M_NONFATAL
)

722 
	`buf_¥ötf
 (&
out
, "N");

723 i‡(
Êags
 & 
M_WARN
)

724 
	`buf_¥ötf
 (&
out
, "W");

725 i‡(
Êags
 & 
M_DEBUG
)

726 
	`buf_¥ötf
 (&
out
, "D");

727  
	`BSTR
 (&
out
);

728 
	}
}

730 #ifde‡
ENABLE_DEBUG


732 
	$¸ash
 ()

734 *
nuŒ
 = 
NULL
;

735 *
nuŒ
 = 0;

736 
	}
}

739 #ifde‡
WIN32


742 
	$°ªº‹_wö32
 (
DWORD
 
î∫um
, 
gc_¨ía
 *
gc
)

750 
î∫um
) {

755 
ERROR_GEN_FAILURE
:

757 
ERROR_IO_PENDING
:

759 
WSA_IO_INCOMPLETE
:

761 
WSAEINTR
:

763 
WSAEBADF
:

765 
WSAEACCES
:

767 
WSAEFAULT
:

769 
WSAEINVAL
:

771 
WSAEMFILE
:

773 
WSAEWOULDBLOCK
:

775 
WSAEINPROGRESS
:

777 
WSAEALREADY
:

779 
WSAEDESTADDRREQ
:

781 
WSAEMSGSIZE
:

783 
WSAEPROTOTYPE
:

785 
WSAENOPROTOOPT
:

787 
WSAEPROTONOSUPPORT
:

789 
WSAESOCKTNOSUPPORT
:

791 
WSAEOPNOTSUPP
:

793 
WSAEPFNOSUPPORT
:

795 
WSAEAFNOSUPPORT
:

797 
WSAEADDRINUSE
:

799 
WSAENETDOWN
:

801 
WSAENETUNREACH
:

803 
WSAENETRESET
:

805 
WSAECONNABORTED
:

807 
WSAECONNRESET
:

809 
WSAENOBUFS
:

811 
WSAEISCONN
:

813 
WSAENOTCONN
:

815 
WSAETIMEDOUT
:

817 
WSAECONNREFUSED
:

819 
WSAELOOP
:

821 
WSAENAMETOOLONG
:

823 
WSAEHOSTDOWN
:

825 
WSAEHOSTUNREACH
:

827 
WSAENOTEMPTY
:

829 
WSAEPROCLIM
:

831 
WSAEUSERS
:

833 
WSAEDQUOT
:

835 
WSAESTALE
:

837 
WSASYSNOTREADY
:

839 
WSAVERNOTSUPPORTED
:

841 
WSANOTINITIALISED
:

843 
WSAEREMOTE
:

845 
WSAHOST_NOT_FOUND
:

854 
mesßge
[256];

855 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

856 c⁄° 
°©us
 = 
	`F‹m©Mesßge
 (

857 
FORMAT_MESSAGE_IGNORE_INSERTS


858 | 
FORMAT_MESSAGE_FROM_SYSTEM


859 | 
FORMAT_MESSAGE_ARGUMENT_ARRAY
,

860 
NULL
,

861 
î∫um
,

863 
mesßge
,

864  (
mesßge
),

865 
NULL
);

866 i‡(!
°©us
)

868 
	`buf_¥ötf
 (&
out
, "[Unknown Win32 Error]");

872 *
˝
;

873 
˝
 = 
mesßge
; *cp != '\0'; ++cp)

875 i‡(*
˝
 == '\n' || *cp == '\r')

876 *
˝
 = ' ';

879 
	`buf_¥ötf
(&
out
, "%s", 
mesßge
);

882  
	`BSTR
 (&
out
);

884 
	}
}

	@src/openvpn/error.h

25 #i‚de‡
ERROR_H


26 
	#ERROR_H


	)

28 
	~"basic.h
"

32 #ifde‡
ENABLE_PKCS11


33 
	#ERR_BUF_SIZE
 8192

	)

35 
	#ERR_BUF_SIZE
 1280

	)

38 
	ggc_¨ía
;

44 
	#OPENVPN_MSG_FP
 
°dout


	)

45 
	#OPENVPN_ERROR_FP
 
°dîr


	)

51 
	#OPENVPN_EXIT_STATUS_GOOD
 0

	)

52 
	#OPENVPN_EXIT_STATUS_ERROR
 1

	)

53 
	#OPENVPN_EXIT_STATUS_USAGE
 1

	)

54 
	#OPENVPN_EXIT_STATUS_CANNOT_OPEN_DEBUG_FILE
 1

	)

65 
	#OPENVPN_DEBUG_FILE
 
PACKAGE
 ".log"

	)

69 #ifde‡
WIN32


70 
	#›ív≤_î∫o
(Ë
	`GëLa°Eº‹
()

	)

71 
	#›ív≤_°ªº‹
(
e
, 
gc
Ë
	`°ªº‹_wö32
”, gc)

	)

72 c⁄° *
°ªº‹_wö32
 (
DWORD
 
î∫um
, 
gc_¨ía
 *
gc
);

74 
	#›ív≤_î∫o
(Ë
î∫o


	)

75 
	#›ív≤_°ªº‹
(
x
, 
gc
Ë
	`°ªº‹
(x)

	)

82 
x_debug_Àvñ
;

83 
x_msg_löe_num
;

87 
	#M_DEBUG_LEVEL
 (0x0FË

	)

89 
	#M_FATAL
 (1<<4Ë

	)

90 
	#M_NONFATAL
 (1<<5Ë

	)

91 
	#M_WARN
 (1<<6Ë

	)

92 
	#M_DEBUG
 (1<<7)

	)

94 
	#M_ERRNO
 (1<<8Ë

	)

96 #ifde‡
ENABLE_CRYPTO_OPENSSL


97 
	#M_SSL
 (1<<10Ë

	)

100 
	#M_NOMUTE
 (1<<11Ë

	)

101 
	#M_NOPREFIX
 (1<<12Ë

	)

102 
	#M_USAGE_SMALL
 (1<<13Ë

	)

103 
	#M_MSG_VIRT_OUT
 (1<<14Ë

	)

104 
	#M_OPTERR
 (1<<15Ë

	)

105 
	#M_NOLF
 (1<<16Ë

	)

106 
	#M_NOIPREFIX
 (1<<17Ë

	)

109 
	#M_ERR
 (
M_FATAL
 | 
M_ERRNO
)

	)

110 
	#M_SSLERR
 (
M_FATAL
 | 
M_SSL
)

	)

111 
	#M_USAGE
 (
M_USAGE_SMALL
 | 
M_NOPREFIX
 | 
M_OPTERR
)

	)

112 
	#M_CLIENT
 (
M_MSG_VIRT_OUT
 | 
M_NOMUTE
 | 
M_NOIPREFIX
)

	)

120 
	#MUTE_LEVEL_SHIFT
 24

	)

121 
	#MUTE_LEVEL_MASK
 0xFF

	)

123 
	#ENCODE_MUTE_LEVEL
(
muã_Àvñ
Ë(((muã_ÀvñË& 
MUTE_LEVEL_MASK
Ë<< 
MUTE_LEVEL_SHIFT
)

	)

124 
	#DECODE_MUTE_LEVEL
(
Êags
Ë(((ÊagsË>> 
MUTE_LEVEL_SHIFT
Ë& 
MUTE_LEVEL_MASK
)

	)

136 
	#LOGLEV
(
log_Àvñ
, 
muã_Àvñ
, 
Ÿhî
Ë(÷og_ÀvñË| 
	`ENCODE_MUTE_LEVEL
(muã_ÀvñË| othî)

	)

143 
boﬁ
 
d⁄t_muã
 (
Êags
);

145 
	#MSG_TEST
(
Êags
Ë(
	`u∆ikñy
(((()ÊagsË& 
M_DEBUG_LEVEL
Ë<
x_debug_Àvñ
Ë&& 
	`d⁄t_muã
 (Êags))

	)

147 #i‡
deföed
(
HAVE_CPP_VARARG_MACRO_ISO
Ë&& !deföed(
__LCLINT__
)

148 
	#HAVE_VARARG_MACROS


	)

149 
	#msg
(
Êags
, ...Ëdÿ{ i‡(
	`MSG_TEST
(Êags)Ë
	`x_msg
((Êags), 
__VA_ARGS__
); } 
Ál£
)

	)

150 #ifde‡
ENABLE_DEBUG


151 
	#dmsg
(
Êags
, ...Ëdÿ{ i‡(
	`MSG_TEST
(Êags)Ë
	`x_msg
((Êags), 
__VA_ARGS__
); } 
Ál£
)

	)

153 
	#dmsg
(
Êags
, ...)

	)

155 #ñi‡
deföed
(
HAVE_CPP_VARARG_MACRO_GCC
Ë&& !deföed(
__LCLINT__
)

156 
	#HAVE_VARARG_MACROS


	)

157 
	#msg
(
Êags
, 
¨gs
...Ëdÿ{ i‡(
	`MSG_TEST
(Êags)Ë
	`x_msg
((Êags),árgs); } 
Ál£
)

	)

158 #ifde‡
ENABLE_DEBUG


159 
	#dmsg
(
Êags
, 
¨gs
...Ëdÿ{ i‡(
	`MSG_TEST
(Êags)Ë
	`x_msg
((Êags),árgs); } 
Ál£
)

	)

161 
	#dmsg
(
Êags
, 
¨gs
...)

	)

164 #i‡!
PEDANTIC


165 #ifde‡
_MSC_VER


166 #¥agm®
mesßge
("this compileráppearsÅoÜack vararg macros which will causeá significant degradation inÉfficiency")

168 #w¨nög 
this
 
compûî
 
≠≥¨s
 
to
 
œck
 
v¨¨g
 
ma¸os
 
which
 
wûl
 
ˇu£
 
a
 
signifiˇ¡
 
degød©i⁄
 
ö
 
efficõncy
 (
you
 
ˇn
 
ign‹e
Åhi†
w¨nög
 you 
¨e
 
usög
 
LCLINT
)

171 
	#msg
 
x_msg


	)

172 
	#dmsg
 
x_msg


	)

175 
	$x_msg
 (c⁄° 
Êags
, c⁄° *
f‹m©
, ...)

176 #ifde‡
__GNUC__


177 #i‡
__USE_MINGW_ANSI_STDIO


178 
	`__©åibuã__
 ((
	$f‹m©
 (
gnu_¥ötf
, 2, 3)))

180 
	`__©åibuã__
 ((
	$f‹m©
 (
__¥ötf__
, 2, 3)))

185 
	`x_msg_va
 (c⁄° 
Êags
, c⁄° *
f‹m©
, 
va_li°
 
¨gli°
);

191 
	`îr‹_ª£t
 ();

194 
	`îr‹s_to_°dîr
 ();

196 
	`£t_suµªss_time°amps
 (
boﬁ
 
suµªs£d
);

198 
	#SDL_CONSTRAIN
 (1<<0)

	)

199 
boﬁ
 
	`£t_debug_Àvñ
 (c⁄° 
Àvñ
, c⁄° 
Êags
);

201 
boﬁ
 
	`£t_muã_cutoff
 (c⁄° 
cutoff
);

203 
	`gë_debug_Àvñ
 ();

204 
	`gë_muã_cutoff
 ();

206 c⁄° *
	`msg_Êags_°rög
 (c⁄° 
Êags
, 
gc_¨ía
 *
gc
);

211 
FILE
 *
	`msg_Â
(c⁄° 
Êags
);

214 
	#ASSERT
(
x
Ëdÿ{ i‡(!(x)Ë
	`as£π_Áûed
(
__FILE__
, 
__LINE__
); 
	}
} 
Ál£
)

	)

216 
as£π_Áûed
 (c⁄° *
fûíame
, 
löe
);

218 #ifde‡
ENABLE_DEBUG


219 
¸ash
 ();

224 
ölöe
 
boﬁ


225 
	$check_debug_Àvñ
 (
Àvñ
)

227  (
Àvñ
 & 
M_DEBUG_LEVEL
Ë<
x_debug_Àvñ
;

228 
	}
}

231 
msg_f‹ked
 ();

235 
›í_sy¶og
 (c⁄° *
pgm«me
, 
boﬁ
 
°dio_to_nuŒ
);

236 
˛o£_sy¶og
 ();

239 
ªdúe˘_°dout_°dîr
 (c⁄° *
fûe
, 
boﬁ
 
≠≥nd
);

241 #ifde‡
WIN32


243 
HANDLE
 
gë_‹ig_°dîr
 ();

247 
›ív≤_exô
 (c⁄° 
°©us
);

250 
out_of_mem‹y
 ();

256 
	glök_sockë
;

257 
	gtu¡≠
;

259 
x_cs_öfo_Àvñ
;

260 
x_cs_vîbo£_Àvñ
;

261 
x_cs_îr_dñay_ms
;

263 
ª£t_check_°©us
 ();

264 
£t_check_°©us
 (
öfo_Àvñ
, 
vîbo£_Àvñ
);

266 
x_check_°©us
 (
°©us
,

267 c⁄° *
des¸ùti⁄
,

268 
lök_sockë
 *
sock
,

269 
tu¡≠
 *
â
);

271 
ölöe
 

272 
	$check_°©us
 (
°©us
, c⁄° *
des¸ùti⁄
, 
lök_sockë
 *
sock
, 
tu¡≠
 *
â
)

274 i‡(
°©us
 < 0 || 
	`check_debug_Àvñ
 (
x_cs_vîbo£_Àvñ
))

275 
	`x_check_°©us
 (
°©us
, 
des¸ùti⁄
, 
sock
, 
â
);

276 
	}
}

278 
ölöe
 

279 
	$£t_check_°©us_îr‹_dñay
 (
mûli£c⁄ds
)

281 
x_cs_îr_dñay_ms
 = 
mûli£c⁄ds
;

282 
	}
}

291 c⁄° *
x_msg_¥efix
;

293 
msg_thªad_öô
 ();

294 
msg_thªad_unöô
 ();

296 
ölöe
 

297 
	$msg_£t_¥efix
 (c⁄° *
¥efix
)

299 
x_msg_¥efix
 = 
¥efix
;

300 
	}
}

302 
ölöe
 const *

303 
	$msg_gë_¥efix
 ()

305  
x_msg_¥efix
;

306 
	}
}

312 
	gvútuÆ_ouçut
;

314 c⁄° 
vútuÆ_ouçut
 *
x_msg_vútuÆ_ouçut
;

316 
ölöe
 

317 
	$msg_£t_vútuÆ_ouçut
 (c⁄° 
vútuÆ_ouçut
 *
vo
)

319 
x_msg_vútuÆ_ouçut
 = 
vo
;

320 
	}
}

322 
ölöe
 c⁄° 
vútuÆ_ouçut
 *

323 
	$msg_gë_vútuÆ_ouçut
 ()

325  
x_msg_vútuÆ_ouçut
;

326 
	}
}

332 
ölöe
 
boﬁ


333 
	$ign‹e_sys_îr‹
 (c⁄° 
îr
)

336 #ifde‡
WIN32


337 i‡(
îr
 =
WSAEWOULDBLOCK
 ||Éº =
WSAEINVAL
)

338  
åue
;

340 i‡(
îr
 =
EAGAIN
)

341  
åue
;

345 #ifde‡
ENOBUFS


347 i‡(
îr
 =
ENOBUFS
)

348  
åue
;

352  
Ál£
;

353 
	}
}

355 
	~"îæevñ.h
"

	@src/openvpn/event.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"buf„r.h
"

34 
	~"îr‹.h
"

35 
	~"öãgî.h
"

36 
	~"evít.h
"

37 
	~"fdmisc.h
"

39 
	~"memdbg.h
"

45 #i‡
deföed
(
TARGET_DARWIN
)

46 
	#SELECT_PREFERRED_OVER_POLL


	)

52 #ifde‡
WIN32


53 
	#SELECT
 0

	)

55 
	#SELECT
 1

	)

62 #ifde‡
FD_SETSIZE


63 
	#SELECT_MAX_FDS
 
FD_SETSIZE


	)

65 
	#SELECT_MAX_FDS
 256

	)

68 
ölöe
 

69 
	$tv_to_ms_timeout
 (c⁄° 
timevÆ
 *
tv
)

71 i‡(
tv
->
tv_£c
 =0 &&Åv->
tv_u£c
 == 0)

74  
	`max_öt
 (
tv
->
tv_£c
 * 1000 + (tv->
tv_u£c
 + 500) / 1000, 1);

75 
	}
}

77 #ifde‡
WIN32


79 
	swe_£t


81 
evít_£t_fun˘i⁄s
 
	mfunc
;

82 
boﬁ
 
	mÁ°
;

83 
HANDLE
 *
	mevíts
;

84 
evít_£t_ªtu∫
 *
	me§
;

85 
	mn_evíts
;

86 
	mˇ∑côy
;

89 
ölöe
 

90 
	$we_£t_evít
 (
we_£t
 *
wes
, 
i
, 
evít_t
 
evít
, 
rwÊags
, *
¨g
)

92 
	`ASSERT
 (
i
 >0 && i < 
wes
->
ˇ∑côy
);

94 i‡(
rwÊags
 =
EVENT_READ
)

96 
	`ASSERT
 (
evít
->
ªad
 !
NULL
);

97 
wes
->
evíts
[
i
] = 
evít
->
ªad
;

99 i‡(
rwÊags
 =
EVENT_WRITE
)

101 
	`ASSERT
 (
evít
->
wrôe
 !
NULL
);

102 
wes
->
evíts
[
i
] = 
evít
->
wrôe
;

105 
	`msg
 (
M_FATAL
, "Áè»îr‹ i¿we_£t_evíts:ÑwÊags=%d", 
rwÊags
);

107 
wes
->
e§
[
i
].
rwÊags
 =Ñwflags;

108 
wes
->
e§
[
i
].
¨g
 =árg;

109 
	}
}

111 
ölöe
 
boﬁ


112 
	$we_≠≥nd_evít
 (
we_£t
 *
wes
, 
evít_t
 
evít
, 
rwÊags
, *
¨g
)

114 i‡(
rwÊags
 & 
EVENT_WRITE
)

116 i‡(
wes
->
n_evíts
 < wes->
ˇ∑côy
)

118 
	`we_£t_evít
 (
wes
, wes->
n_evíts
, 
evít
, 
EVENT_WRITE
, 
¨g
);

119 ++
wes
->
n_evíts
;

122  
Ál£
;

124 i‡(
rwÊags
 & 
EVENT_READ
)

126 i‡(
wes
->
n_evíts
 < wes->
ˇ∑côy
)

128 
	`we_£t_evít
 (
wes
, wes->
n_evíts
, 
evít
, 
EVENT_READ
, 
¨g
);

129 ++
wes
->
n_evíts
;

132  
Ál£
;

134  
åue
;

135 
	}
}

138 
	$we_dñ_evít
 (
we_£t
 *
wes
, 
evít_t
 
evít
)

140 
i
, 
j
 = 0;

141 c⁄° 
Àn
 = 
wes
->
n_evíts
;

143 
i
 = 0; i < 
Àn
; ++i)

145 c⁄° 
HANDLE
 
h
 = 
wes
->
evíts
[
i
];

146 i‡(
h
 =
evít
->
ªad
 || h =evít->
wrôe
)

147 --
wes
->
n_evíts
;

150 i‡(
i
 !
j
)

152 
wes
->
evíts
[
j
] = wes->evíts[
i
];

153 
wes
->
e§
[
j
] = wes->e§[
i
];

155 ++
j
;

158 
	}
}

161 
	$we_dñ_ödex
 (
we_£t
 *
wes
, 
ödex
)

163 
i
;

164 
	`ASSERT
 (
ödex
 >0 && index < 
wes
->
n_evíts
);

165 
i
 = 
ödex
; i < 
wes
->
n_evíts
 - 1; ++i)

167 
wes
->
evíts
[
i
] = wes->events[i+1];

168 
wes
->
e§
[
i
] = wes->esr[i+1];

170 --
wes
->
n_evíts
;

171 
	}
}

174 
	$we_gë_rw_ödi˚s
 (
we_£t
 *
wes
, 
evít_t
 
evít
, *
ri
, *
wi
)

176 
i
;

177 *
ri
 = *
wi
 = -1;

178 
i
 = 0; i < 
wes
->
n_evíts
; ++i)

180 c⁄° 
HANDLE
 
h
 = 
wes
->
evíts
[
i
];

181 i‡(
h
 =
evít
->
ªad
)

183 
	`ASSERT
 (*
ri
 == -1);

184 *
ri
 = 
i
;

186 i‡(
h
 =
evít
->
wrôe
)

188 
	`ASSERT
 (*
wi
 == -1);

189 *
wi
 = 
i
;

192 
	}
}

195 
	$we_‰ì
 (
evít_£t
 *
es
)

197 
we_£t
 *
wes
 = (we_£à*Ë
es
;

198 
	`‰ì
 (
wes
->
evíts
);

199 
	`‰ì
 (
wes
->
e§
);

200 
	`‰ì
 (
wes
);

201 
	}
}

204 
	$we_ª£t
 (
evít_£t
 *
es
)

206 
we_£t
 *
wes
 = (we_£à*Ë
es
;

207 
	`ASSERT
 (
wes
->
Á°
);

208 
wes
->
n_evíts
 = 0;

209 
	}
}

212 
	$we_dñ
 (
evít_£t
 *
es
, 
evít_t
 
evít
)

214 
we_£t
 *
wes
 = (we_£à*Ë
es
;

215 
	`ASSERT
 (!
wes
->
Á°
);

216 
	`we_dñ_evít
 (
wes
, 
evít
);

217 
	}
}

220 
	$we_˘l
 (
evít_£t
 *
es
, 
evít_t
 
evít
, 
rwÊags
, *
¨g
)

222 
we_£t
 *
wes
 = (we_£à*Ë
es
;

224 
	`dmsg
 (
D_EVENT_WAIT
, "WE_CTLÇ=%dÉv=%∞rwÊags=0x%04xárg=" 
±r_f‹m©
,

225 
wes
->
n_evíts
,

226 
evít
,

227 
rwÊags
,

228 (
±r_ty≥
)
¨g
);

230 i‡(
wes
->
Á°
)

232 i‡(!
	`we_≠≥nd_evít
 (
wes
, 
evít
, 
rwÊags
, 
¨g
))

233 
îr
;

237 
ri
, 
wi
;

238 
⁄e
 = -1;

239 
n
 = 0;

241 
	`we_gë_rw_ödi˚s
 (
wes
, 
evít
, &
ri
, &
wi
);

242 i‡(
wi
 >= 0)

244 
⁄e
 = 
wi
;

245 ++
n
;

247 i‡(
ri
 >= 0)

249 
⁄e
 = 
ri
;

250 ++
n
;

252 
rwÊags
)

255 
n
)

260 
	`we_dñ_ödex
 (
wes
, 
⁄e
);

263 
	`we_dñ_evít
 (
wes
, 
evít
);

266 
	`ASSERT
 (0);

269 
EVENT_READ
:

270 
n
)

273 i‡(!
	`we_≠≥nd_evít
 (
wes
, 
evít
, 
EVENT_READ
, 
¨g
))

274 
îr
;

277 
	`we_£t_evít
 (
wes
, 
⁄e
, 
evít
, 
EVENT_READ
, 
¨g
);

280 
	`we_dñ_ödex
 (
wes
, 
wi
);

283 
	`ASSERT
 (0);

286 
EVENT_WRITE
:

287 
n
)

290 i‡(!
	`we_≠≥nd_evít
 (
wes
, 
evít
, 
EVENT_WRITE
, 
¨g
))

291 
îr
;

294 
	`we_£t_evít
 (
wes
, 
⁄e
, 
evít
, 
EVENT_WRITE
, 
¨g
);

297 
	`we_dñ_ödex
 (
wes
, 
ri
);

300 
	`ASSERT
 (0);

303 
EVENT_READ
|
EVENT_WRITE
:

304 
n
)

307 i‡(!
	`we_≠≥nd_evít
 (
wes
, 
evít
, 
EVENT_READ
|
EVENT_WRITE
, 
¨g
))

308 
îr
;

311 i‡(
ri
 == -1)

313 
	`ASSERT
 (
wi
 != -1);

314 i‡(!
	`we_≠≥nd_evít
 (
wes
, 
evít
, 
EVENT_READ
, 
¨g
))

315 
îr
;

317 i‡(
wi
 == -1)

319 i‡(!
	`we_≠≥nd_evít
 (
wes
, 
evít
, 
EVENT_WRITE
, 
¨g
))

320 
îr
;

323 
	`ASSERT
 (0);

328 
	`ASSERT
 (0);

332 
	`msg
 (
M_FATAL
, "Áè»îr‹ i¿we_˘l:ÑwÊags=%d", 
rwÊags
);

337 
îr
:

338 
	`msg
 (
D_EVENT_ERRORS
, "Eº‹: Wödow†ªsour˚Üimô WSA_MAXIMUM_WAIT_EVENTS (%dËha†bì¿ex˚eded", 
WSA_MAXIMUM_WAIT_EVENTS
);

339 
	}
}

342 
	$we_waô
 (
evít_£t
 *
es
, c⁄° 
timevÆ
 *
tv
, 
evít_£t_ªtu∫
 *
out
, 
ouéí
)

344 
we_£t
 *
wes
 = (we_£à*Ë
es
;

345 c⁄° 
timeout
 = 
	`tv_to_ms_timeout
 (
tv
);

346 
DWORD
 
°©us
;

348 
	`dmsg
 (
D_EVENT_WAIT
, "WE_WAITÉ¡îÇ=%dÅo=%d", 
wes
->
n_evíts
, 
timeout
);

350 #ifde‡
ENABLE_DEBUG


351 i‡(
	`check_debug_Àvñ
 (
D_EVENT_WAIT
)) {

352 
i
;

353 
i
 = 0; i < 
wes
->
n_evíts
; ++i)

354 
	`dmsg
 (
D_EVENT_WAIT
, "[%d]Év=%∞rwÊags=0x%04xárg=" 
±r_f‹m©
,

355 
i
,

356 
wes
->
evíts
[
i
],

357 
wes
->
e§
[
i
].
rwÊags
,

358 (
±r_ty≥
)
wes
->
e§
[
i
].
¨g
);

365 
°©us
 = 
	`WSAWaôF‹Mu…ùÀEvíts
(

366 (
DWORD
Ë
wes
->
n_evíts
,

367 
wes
->
evíts
,

368 
FALSE
,

369 (
DWORD
) 0,

370 
FALSE
);

376 i‡(
°©us
 >
WSA_WAIT_EVENT_0
 && sètu†< WSA_WAIT_EVENT_0 + (
DWORD
Ë
wes
->
n_evíts
)

378 
i
;

379 
j
 = 0;

380 
i
 = 0; i < 
wes
->
n_evíts
; ++i)

382 i‡(
j
 >
ouéí
)

384 i‡(
	`WaôF‹SögÀObje˘
 (
wes
->
evíts
[
i
], 0Ë=
WAIT_OBJECT_0
)

386 *
out
 = 
wes
->
e§
[
i
];

387 
	`dmsg
 (
D_EVENT_WAIT
, "WE_WAITÜóvê[%d,%d]ÑwÊags=0x%04xárg=" 
±r_f‹m©
,

388 
i
, 
j
, 
out
->
rwÊags
, (
±r_ty≥
)out->
¨g
);

389 ++
j
;

390 ++
out
;

393  
j
;

406 i‡(
timeout
 > 0)

407 
°©us
 = 
	`WSAWaôF‹Mu…ùÀEvíts
(

408 (
DWORD
Ë
wes
->
n_evíts
,

409 
wes
->
evíts
,

410 
FALSE
,

411 (
DWORD
Ë
timeout
,

412 
FALSE
);

414 i‡(
ouéí
 >1 && 
°©us
 >
WSA_WAIT_EVENT_0
 && sètu†< WSA_WAIT_EVENT_0 + (
DWORD
Ë
wes
->
n_evíts
)

416 *
out
 = 
wes
->
e§
[
°©us
 - 
WSA_WAIT_EVENT_0
];

417 
	`dmsg
 (
D_EVENT_WAIT
, "WE_WAITÜóvêrwÊags=0x%04xárg=" 
±r_f‹m©
,

418 
out
->
rwÊags
, (
±r_ty≥
)out->
¨g
);

421 i‡(
°©us
 =
WSA_WAIT_TIMEOUT
)

426 
	}
}

428 
evít_£t
 *

429 
	$we_öô
 (*
maxevíts
, 
Êags
)

431 
we_£t
 *
wes
;

433 
	`dmsg
 (
D_EVENT_WAIT
, "WE_INIT maxevíts=%d fœgs=0x%08x", *
maxevíts
, 
Êags
);

435 
	`ALLOC_OBJ_CLEAR
 (
wes
, 
we_£t
);

438 
wes
->
func
.
‰ì
 = 
we_‰ì
;

439 
wes
->
func
.
ª£t
 = 
we_ª£t
;

440 
wes
->
func
.
dñ
 = 
we_dñ
;

441 
wes
->
func
.
˘l
 = 
we_˘l
;

442 
wes
->
func
.
waô
 = 
we_waô
;

444 i‡(
Êags
 & 
EVENT_METHOD_FAST
)

445 
wes
->
Á°
 = 
åue
;

446 
wes
->
n_evíts
 = 0;

449 
	`ASSERT
 (*
maxevíts
 > 0);

450 
wes
->
ˇ∑côy
 = 
	`mö_öt
 (*
maxevíts
 * 2, 
WSA_MAXIMUM_WAIT_EVENTS
);

451 *
maxevíts
 = 
	`mö_öt
 (*maxevíts, 
WSA_MAXIMUM_WAIT_EVENTS
);

454 
	`ALLOC_ARRAY_CLEAR
 (
wes
->
evíts
, 
HANDLE
, wes->
ˇ∑côy
);

457 
	`ALLOC_ARRAY_CLEAR
 (
wes
->
e§
, 
evít_£t_ªtu∫
, wes->
ˇ∑côy
);

459 
	`dmsg
 (
D_EVENT_WAIT
, "WE_INIT maxevents=%d capacity=%d",

460 *
maxevíts
, 
wes
->
ˇ∑côy
);

462  (
evít_£t
 *Ë
wes
;

463 
	}
}

467 #i‡
EPOLL


469 
	sï_£t


471 
evít_£t_fun˘i⁄s
 
	mfunc
;

472 
boﬁ
 
	mÁ°
;

473 
	mïfd
;

474 
	mmaxevíts
;

475 
ïﬁl_evít
 *
	mevíts
;

479 
	$ï_‰ì
 (
evít_£t
 *
es
)

481 
ï_£t
 *
ïs
 = (ï_£à*Ë
es
;

482 
	`˛o£
 (
ïs
->
ïfd
);

483 
	`‰ì
 (
ïs
->
evíts
);

484 
	`‰ì
 (
ïs
);

485 
	}
}

488 
	$ï_ª£t
 (
evít_£t
 *
es
)

490 c⁄° 
ï_£t
 *
ïs
 = (ï_£à*Ë
es
;

491 
	`ASSERT
 (
ïs
->
Á°
);

492 
	}
}

495 
	$ï_dñ
 (
evít_£t
 *
es
, 
evít_t
 
evít
)

497 
ïﬁl_evít
 
ev
;

498 
ï_£t
 *
ïs
 = (ï_£à*Ë
es
;

500 
	`dmsg
 (
D_EVENT_WAIT
, "EP_DELÉv=%d", ()
evít
);

502 
	`ASSERT
 (!
ïs
->
Á°
);

503 
	`CLEAR
 (
ev
);

504 
	`ïﬁl_˘l
 (
ïs
->
ïfd
, 
EPOLL_CTL_DEL
, 
evít
, &
ev
);

505 
	}
}

508 
	$ï_˘l
 (
evít_£t
 *
es
, 
evít_t
 
evít
, 
rwÊags
, *
¨g
)

510 
ï_£t
 *
ïs
 = (ï_£à*Ë
es
;

511 
ïﬁl_evít
 
ev
;

513 
	`CLEAR
 (
ev
);

515 
ev
.
d©a
.
±r
 = 
¨g
;

516 i‡(
rwÊags
 & 
EVENT_READ
)

517 
ev
.
evíts
 |
EPOLLIN
;

518 i‡(
rwÊags
 & 
EVENT_WRITE
)

519 
ev
.
evíts
 |
EPOLLOUT
;

521 
	`dmsg
 (
D_EVENT_WAIT
, "EP_CTL fd=%dÑwÊags=0x%04xÉv=0x%08xárg=" 
±r_f‹m©
,

522 ()
evít
,

523 
rwÊags
,

524 ()
ev
.
evíts
,

525 (
±r_ty≥
)
ev
.
d©a
.
±r
);

527 i‡(
	`ïﬁl_˘l
 (
ïs
->
ïfd
, 
EPOLL_CTL_MOD
, 
evít
, &
ev
) < 0)

529 i‡(
î∫o
 =
ENOENT
)

531 i‡(
	`ïﬁl_˘l
 (
ïs
->
ïfd
, 
EPOLL_CTL_ADD
, 
evít
, &
ev
) < 0)

532 
	`msg
 (
M_ERR
, "EVENT:Épﬁl_˘»EPOLL_CTL_ADD faûed, sd=%d", ()
evít
);

535 
	`msg
 (
M_ERR
, "EVENT:Épﬁl_˘»EPOLL_CTL_MOD faûed, sd=%d", ()
evít
);

537 
	}
}

540 
	$ï_waô
 (
evít_£t
 *
es
, c⁄° 
timevÆ
 *
tv
, 
evít_£t_ªtu∫
 *
out
, 
ouéí
)

542 
ï_£t
 *
ïs
 = (ï_£à*Ë
es
;

543 
°©
;

545 i‡(
ouéí
 > 
ïs
->
maxevíts
)

546 
ouéí
 = 
ïs
->
maxevíts
;

548 
°©
 = 
	`ïﬁl_waô
 (
ïs
->
ïfd
,Éps->
evíts
, 
ouéí
, 
	`tv_to_ms_timeout
 (
tv
));

549 
	`ASSERT
 (
°©
 <
ouéí
);

551 i‡(
°©
 > 0)

553 
i
;

554 c⁄° 
ïﬁl_evít
 *
ev
 = 
ïs
->
evíts
;

555 
evít_£t_ªtu∫
 *
e§
 = 
out
;

556 
i
 = 0; i < 
°©
; ++i)

558 
e§
->
rwÊags
 = 0;

559 i‡(
ev
->
evíts
 & (
EPOLLIN
|
EPOLLPRI
|
EPOLLERR
|
EPOLLHUP
))

560 
e§
->
rwÊags
 |
EVENT_READ
;

561 i‡(
ev
->
evíts
 & 
EPOLLOUT
)

562 
e§
->
rwÊags
 |
EVENT_WRITE
;

563 
e§
->
¨g
 = 
ev
->
d©a
.
±r
;

564 
	`dmsg
 (
D_EVENT_WAIT
, "EP_WAIT[%d]ÑwÊags=0x%04xÉv=0x%08xárg=" 
±r_f‹m©
,

565 
i
, 
e§
->
rwÊags
, 
ev
->
evíts
, (
±r_ty≥
Îv->
d©a
.
±r
);

566 ++
ev
;

567 ++
e§
;

570  
°©
;

571 
	}
}

573 
evít_£t
 *

574 
	$ï_öô
 (*
maxevíts
, 
Êags
)

576 
ï_£t
 *
ïs
;

577 
fd
;

579 
	`dmsg
 (
D_EVENT_WAIT
, "EP_INIT maxevíts=%d fœgs=0x%08x", *
maxevíts
, 
Êags
);

582 
fd
 = 
	`ïﬁl_¸óã
 (*
maxevíts
);

583 i‡(
fd
 < 0)

584  
NULL
;

586 
	`£t_˛€xec
 (
fd
);

588 
	`ALLOC_OBJ_CLEAR
 (
ïs
, 
ï_£t
);

591 
ïs
->
func
.
‰ì
 = 
ï_‰ì
;

592 
ïs
->
func
.
ª£t
 = 
ï_ª£t
;

593 
ïs
->
func
.
dñ
 = 
ï_dñ
;

594 
ïs
->
func
.
˘l
 = 
ï_˘l
;

595 
ïs
->
func
.
waô
 = 
ï_waô
;

598 i‡(
Êags
 & 
EVENT_METHOD_FAST
)

599 
ïs
->
Á°
 = 
åue
;

602 
	`ASSERT
 (*
maxevíts
 > 0);

603 
ïs
->
maxevíts
 = *maxevents;

604 
	`ALLOC_ARRAY_CLEAR
 (
ïs
->
evíts
, 
ïﬁl_evít
,Éps->
maxevíts
);

607 
ïs
->
ïfd
 = 
fd
;

609  (
evít_£t
 *Ë
ïs
;

610 
	}
}

613 #i‡
POLL


615 
	spo_£t


617 
evít_£t_fun˘i⁄s
 
	mfunc
;

618 
boﬁ
 
	mÁ°
;

619 
pﬁlfd
 *
	mevíts
;

620 **
	m¨gs
;

621 
	mn_evíts
;

622 
	mˇ∑côy
;

626 
	$po_‰ì
 (
evít_£t
 *
es
)

628 
po_£t
 *
pos
 = (po_£à*Ë
es
;

629 
	`‰ì
 (
pos
->
evíts
);

630 
	`‰ì
 (
pos
->
¨gs
);

631 
	`‰ì
 (
pos
);

632 
	}
}

635 
	$po_ª£t
 (
evít_£t
 *
es
)

637 
po_£t
 *
pos
 = (po_£à*Ë
es
;

638 
	`ASSERT
 (
pos
->
Á°
);

639 
pos
->
n_evíts
 = 0;

640 
	}
}

643 
	$po_dñ
 (
evít_£t
 *
es
, 
evít_t
 
evít
)

645 
po_£t
 *
pos
 = (po_£à*Ë
es
;

646 
i
;

648 
	`dmsg
 (
D_EVENT_WAIT
, "PO_DELÉv=%d", ()
evít
);

650 
	`ASSERT
 (!
pos
->
Á°
);

651 
i
 = 0; i < 
pos
->
n_evíts
; ++i)

653 i‡(
pos
->
evíts
[
i
].
fd
 =
evít
)

655 
j
;

656 
j
 = 
i
; j < 
pos
->
n_evíts
 - 1; ++j)

658 
pos
->
evíts
[
j
] =Öos->events[j+1];

659 
pos
->
¨gs
[
j
] =Öos->args[j+1];

661 --
pos
->
n_evíts
;

665 
	}
}

667 
ölöe
 

668 
	$po_£t_pﬁlfd_evíts
 (
pﬁlfd
 *
pfdp
, 
rwÊags
)

670 
pfdp
->
evíts
 = 0;

671 i‡(
rwÊags
 & 
EVENT_WRITE
)

672 
pfdp
->
evíts
 |
POLLOUT
;

673 i‡(
rwÊags
 & 
EVENT_READ
)

674 
pfdp
->
evíts
 |(
POLLIN
|
POLLPRI
);

675 
	}
}

677 
ölöe
 
boﬁ


678 
	$po_≠≥nd_evít
 (
po_£t
 *
pos
, 
evít_t
 
evít
, 
rwÊags
, *
¨g
)

680 i‡(
pos
->
n_evíts
 <Öos->
ˇ∑côy
)

682 
pﬁlfd
 *
pfdp
 = &
pos
->
evíts
[pos->
n_evíts
];

683 
pfdp
->
fd
 = 
evít
;

684 
pos
->
¨gs
[pos->
n_evíts
] = 
¨g
;

685 
	`po_£t_pﬁlfd_evíts
 (
pfdp
, 
rwÊags
);

686 ++
pos
->
n_evíts
;

687  
åue
;

690  
Ál£
;

691 
	}
}

694 
	$po_˘l
 (
evít_£t
 *
es
, 
evít_t
 
evít
, 
rwÊags
, *
¨g
)

696 
po_£t
 *
pos
 = (po_£à*Ë
es
;

698 
	`dmsg
 (
D_EVENT_WAIT
, "PO_CTLÑwÊags=0x%04xÉv=%dárg=" 
±r_f‹m©
,

699 
rwÊags
, ()
evít
, (
±r_ty≥
)
¨g
);

701 i‡(
pos
->
Á°
)

703 i‡(!
	`po_≠≥nd_evít
 (
pos
, 
evít
, 
rwÊags
, 
¨g
))

704 
îr
;

708 
i
;

709 
i
 = 0; i < 
pos
->
n_evíts
; ++i)

711 
pﬁlfd
 *
pfdp
 = &
pos
->
evíts
[
i
];

712 i‡(
pfdp
->
fd
 =
evít
)

714 
pos
->
¨gs
[
i
] = 
¨g
;

715 
	`po_£t_pﬁlfd_evíts
 (
pfdp
, 
rwÊags
);

716 
d⁄e
;

719 i‡(!
	`po_≠≥nd_evít
 (
pos
, 
evít
, 
rwÊags
, 
¨g
))

720 
îr
;

723 
d⁄e
:

726 
îr
:

727 
	`msg
 (
D_EVENT_ERRORS
, "Error:Öoll:Åoo many I/O waitÉvents");

728 
	}
}

731 
	$po_waô
 (
evít_£t
 *
es
, c⁄° 
timevÆ
 *
tv
, 
evít_£t_ªtu∫
 *
out
, 
ouéí
)

733 
po_£t
 *
pos
 = (po_£à*Ë
es
;

734 
°©
;

736 
°©
 = 
	`pﬁl
 (
pos
->
evíts
,Öos->
n_evíts
, 
	`tv_to_ms_timeout
 (
tv
));

738 
	`ASSERT
 (
°©
 <
pos
->
n_evíts
);

740 i‡(
°©
 > 0)

742 
i
, 
j
=0;

743 c⁄° 
pﬁlfd
 *
pfdp
 = 
pos
->
evíts
;

744 
i
 = 0; i < 
pos
->
n_evíts
 && 
j
 < 
ouéí
; ++i)

746 i‡(
pfdp
->
ªvíts
 & (
POLLIN
|
POLLPRI
|
POLLERR
|
POLLHUP
|
POLLOUT
))

748 
out
->
rwÊags
 = 0;

749 i‡(
pfdp
->
ªvíts
 & (
POLLIN
|
POLLPRI
|
POLLERR
|
POLLHUP
))

750 
out
->
rwÊags
 |
EVENT_READ
;

751 i‡(
pfdp
->
ªvíts
 & 
POLLOUT
)

752 
out
->
rwÊags
 |
EVENT_WRITE
;

753 
out
->
¨g
 = 
pos
->
¨gs
[
i
];

754 
	`dmsg
 (
D_EVENT_WAIT
, "PO_WAIT[%d,%d] fd=%dÑev=0x%08xÑwÊags=0x%04xárg=" 
±r_f‹m©
 " %s",

755 
i
, 
j
, 
pfdp
->
fd
,Öfdp->
ªvíts
, 
out
->
rwÊags
, (
±r_ty≥
)out->
¨g
, 
pos
->
Á°
 ? "" : "[scalable]");

756 ++
out
;

757 ++
j
;

759 i‡(
pfdp
->
ªvíts
)

761 
	`msg
 (
D_EVENT_ERRORS
, "Eº‹:Öﬁl: unknow¿ªvíts=0x%04x", ()
pfdp
->
ªvíts
);

763 ++
pfdp
;

765  
j
;

767  
°©
;

768 
	}
}

770 
evít_£t
 *

771 
	$po_öô
 (*
maxevíts
, 
Êags
)

773 
po_£t
 *
pos
;

775 
	`dmsg
 (
D_EVENT_WAIT
, "PO_INIT maxevíts=%d fœgs=0x%08x", *
maxevíts
, 
Êags
);

777 
	`ALLOC_OBJ_CLEAR
 (
pos
, 
po_£t
);

780 
pos
->
func
.
‰ì
 = 
po_‰ì
;

781 
pos
->
func
.
ª£t
 = 
po_ª£t
;

782 
pos
->
func
.
dñ
 = 
po_dñ
;

783 
pos
->
func
.
˘l
 = 
po_˘l
;

784 
pos
->
func
.
waô
 = 
po_waô
;

786 i‡(
Êags
 & 
EVENT_METHOD_FAST
)

787 
pos
->
Á°
 = 
åue
;

789 
pos
->
n_evíts
 = 0;

792 
	`ASSERT
 (*
maxevíts
 > 0);

793 
pos
->
ˇ∑côy
 = *
maxevíts
;

796 
	`ALLOC_ARRAY_CLEAR
 (
pos
->
evíts
, 
pﬁlfd
,Öos->
ˇ∑côy
);

799 
	`ALLOC_ARRAY_CLEAR
 (
pos
->
¨gs
, *,Öos->
ˇ∑côy
);

801  (
evít_£t
 *Ë
pos
;

802 
	}
}

805 #i‡
SELECT


807 
	s£_£t


809 
evít_£t_fun˘i⁄s
 
	mfunc
;

810 
boﬁ
 
	mÁ°
;

811 
fd_£t
 
	mªadfds
;

812 
fd_£t
 
	mwrôefds
;

813 **
	m¨gs
;

814 
	mmaxfd
;

815 
	mˇ∑côy
;

819 
	$£_‰ì
 (
evít_£t
 *
es
)

821 
£_£t
 *
£s
 = (£_£à*Ë
es
;

822 
	`‰ì
 (
£s
->
¨gs
);

823 
	`‰ì
 (
£s
);

824 
	}
}

827 
	$£_ª£t
 (
evít_£t
 *
es
)

829 
£_£t
 *
£s
 = (£_£à*Ë
es
;

830 
i
;

831 
	`ASSERT
 (
£s
->
Á°
);

833 
	`dmsg
 (
D_EVENT_WAIT
, "SE_RESET");

835 
	`FD_ZERO
 (&
£s
->
ªadfds
);

836 
	`FD_ZERO
 (&
£s
->
wrôefds
);

837 
i
 = 0; i <
£s
->
maxfd
; ++i)

838 
£s
->
¨gs
[
i
] = 
NULL
;

839 
£s
->
maxfd
 = -1;

840 
	}
}

843 
	$£_dñ
 (
evít_£t
 *
es
, 
evít_t
 
evít
)

845 
£_£t
 *
£s
 = (£_£à*Ë
es
;

846 
	`ASSERT
 (!
£s
->
Á°
);

848 
	`dmsg
 (
D_EVENT_WAIT
, "SE_DELÉv=%d", ()
evít
);

850 i‡(
evít
 >0 &&Évíà< 
£s
->
ˇ∑côy
)

852 
	`FD_CLR
 (
evít
, &
£s
->
ªadfds
);

853 
	`FD_CLR
 (
evít
, &
£s
->
wrôefds
);

854 
£s
->
¨gs
[
evít
] = 
NULL
;

857 
	`msg
 (
D_EVENT_ERRORS
, "Error: select/se_del:Åoo many I/O waitÉvents");

859 
	}
}

862 
	$£_˘l
 (
evít_£t
 *
es
, 
evít_t
 
evít
, 
rwÊags
, *
¨g
)

864 
£_£t
 *
£s
 = (£_£à*Ë
es
;

866 
	`dmsg
 (
D_EVENT_WAIT
, "SE_CTLÑwÊags=0x%04xÉv=%d fa°=%d c≠=%d maxfd=%dárg=" 
±r_f‹m©
,

867 
rwÊags
, ()
evít
, ()
£s
->
Á°
, ses->
ˇ∑côy
, ses->
maxfd
, (
±r_ty≥
)
¨g
);

869 i‡(
evít
 >0 &&Évíà< 
£s
->
ˇ∑côy
)

871 
£s
->
maxfd
 = 
	`max_öt
 (
evít
, ses->maxfd);

872 
£s
->
¨gs
[
evít
] = 
¨g
;

873 i‡(
£s
->
Á°
)

875 i‡(
rwÊags
 & 
EVENT_READ
)

876 
	`FD_SET
 (
evít
, &
£s
->
ªadfds
);

877 i‡(
rwÊags
 & 
EVENT_WRITE
)

878 
	`FD_SET
 (
evít
, &
£s
->
wrôefds
);

882 i‡(
rwÊags
 & 
EVENT_READ
)

883 
	`FD_SET
 (
evít
, &
£s
->
ªadfds
);

885 
	`FD_CLR
 (
evít
, &
£s
->
ªadfds
);

886 i‡(
rwÊags
 & 
EVENT_WRITE
)

887 
	`FD_SET
 (
evít
, &
£s
->
wrôefds
);

889 
	`FD_CLR
 (
evít
, &
£s
->
wrôefds
);

894 
	`msg
 (
D_EVENT_ERRORS
, "Error: select:Åoo many I/O waitÉvents, fd=%d cap=%d",

895 (Ë
evít
,

896 
£s
->
ˇ∑côy
);

898 
	}
}

901 
	$£_waô_ªtu∫
 (
£_£t
 *
£s
,

902 
fd_£t
 *
ªad
,

903 
fd_£t
 *
wrôe
,

904 
evít_£t_ªtu∫
 *
out
,

905 
ouéí
)

907 
i
, 
j
 = 0;

908 
i
 = 0; i <
£s
->
maxfd
 && 
j
 < 
ouéí
; ++i)

910 c⁄° 
boﬁ
 
r
 = 
	`FD_ISSET
 (
i
, 
ªad
);

911 c⁄° 
boﬁ
 
w
 = 
	`FD_ISSET
 (
i
, 
wrôe
);

912 i‡(
r
 || 
w
)

914 
out
->
rwÊags
 = 0;

915 i‡(
r
)

916 
out
->
rwÊags
 |
EVENT_READ
;

917 i‡(
w
)

918 
out
->
rwÊags
 |
EVENT_WRITE
;

919 
out
->
¨g
 = 
£s
->
¨gs
[
i
];

920 
	`dmsg
 (
D_EVENT_WAIT
, "SE_WAIT[%d,%d]ÑwÊags=0x%04xárg=" 
±r_f‹m©
,

921 
i
, 
j
, 
out
->
rwÊags
, (
±r_ty≥
)out->
¨g
);

922 ++
out
;

923 ++
j
;

926  
j
;

927 
	}
}

930 
	$£_waô_Á°
 (
evít_£t
 *
es
, c⁄° 
timevÆ
 *
tv
, 
evít_£t_ªtu∫
 *
out
, 
ouéí
)

932 
£_£t
 *
£s
 = (£_£à*Ë
es
;

933 
timevÆ
 
tv_tmp
 = *
tv
;

934 
°©
;

936 
	`dmsg
 (
D_EVENT_WAIT
, "SE_WAIT_FAST maxfd=%dÅv=%d/%d",

937 
£s
->
maxfd
,

938 ()
tv_tmp
.
tv_£c
,

939 ()
tv_tmp
.
tv_u£c
);

941 
°©
 = 
	`£À˘
 (
£s
->
maxfd
 + 1, &£s->
ªadfds
, &£s->
wrôefds
, 
NULL
, &
tv_tmp
);

943 i‡(
°©
 > 0)

944 
°©
 = 
	`£_waô_ªtu∫
 (
£s
, &£s->
ªadfds
, &£s->
wrôefds
, 
out
, 
ouéí
);

946  
°©
;

947 
	}
}

950 
	$£_waô_sˇœbÀ
 (
evít_£t
 *
es
, c⁄° 
timevÆ
 *
tv
, 
evít_£t_ªtu∫
 *
out
, 
ouéí
)

952 
£_£t
 *
£s
 = (£_£à*Ë
es
;

953 
timevÆ
 
tv_tmp
 = *
tv
;

954 
fd_£t
 
ªad
 = 
£s
->
ªadfds
;

955 
fd_£t
 
wrôe
 = 
£s
->
wrôefds
;

956 
°©
;

958 
	`dmsg
 (
D_EVENT_WAIT
, "SE_WAIT_SCALEABLE maxfd=%dÅv=%d/%d",

959 
£s
->
maxfd
, ()
tv_tmp
.
tv_£c
, (Èv_tmp.
tv_u£c
);

961 
°©
 = 
	`£À˘
 (
£s
->
maxfd
 + 1, &
ªad
, &
wrôe
, 
NULL
, &
tv_tmp
);

963 i‡(
°©
 > 0)

964 
°©
 = 
	`£_waô_ªtu∫
 (
£s
, &
ªad
, &
wrôe
, 
out
, 
ouéí
);

966  
°©
;

967 
	}
}

969 
evít_£t
 *

970 
	$£_öô
 (*
maxevíts
, 
Êags
)

972 
£_£t
 *
£s
;

974 
	`dmsg
 (
D_EVENT_WAIT
, "SE_INIT maxevíts=%d fœgs=0x%08x", *
maxevíts
, 
Êags
);

976 
	`ALLOC_OBJ_CLEAR
 (
£s
, 
£_£t
);

979 
£s
->
func
.
‰ì
 = 
£_‰ì
;

980 
£s
->
func
.
ª£t
 = 
£_ª£t
;

981 
£s
->
func
.
dñ
 = 
£_dñ
;

982 
£s
->
func
.
˘l
 = 
£_˘l
;

983 
£s
->
func
.
waô
 = 
£_waô_sˇœbÀ
;

985 i‡(
Êags
 & 
EVENT_METHOD_FAST
)

987 
£s
->
Á°
 = 
åue
;

988 
£s
->
func
.
waô
 = 
£_waô_Á°
;

992 
£s
->
maxfd
 = -1;

995 
	`ASSERT
 (*
maxevíts
 > 0);

996 *
maxevíts
 = 
	`mö_öt
 (*maxevíts, 
SELECT_MAX_FDS
);

997 
£s
->
ˇ∑côy
 = 
SELECT_MAX_FDS
;

1000 
	`ALLOC_ARRAY_CLEAR
 (
£s
->
¨gs
, *, ses->
ˇ∑côy
);

1002  (
evít_£t
 *Ë
£s
;

1003 
	}
}

1006 
evít_£t
 *

1007 
	$evít_£t_öô_sim∂e
 (*
maxevíts
, 
Êags
)

1009 
evít_£t
 *
ªt
 = 
NULL
;

1010 #ifde‡
WIN32


1011 
ªt
 = 
	`we_öô
 (
maxevíts
, 
Êags
);

1012 #ñi‡
POLL
 && 
SELECT


1014 i‡(
Êags
 & 
EVENT_METHOD_US_TIMEOUT
)

1015 
ªt
 = 
	`£_öô
 (
maxevíts
, 
Êags
);

1017 #ifde‡
SELECT_PREFERRED_OVER_POLL


1018 i‡(!
ªt
)

1019 
ªt
 = 
	`£_öô
 (
maxevíts
, 
Êags
);

1020 i‡(!
ªt
)

1021 
ªt
 = 
	`po_öô
 (
maxevíts
, 
Êags
);

1023 i‡(!
ªt
)

1024 
ªt
 = 
	`po_öô
 (
maxevíts
, 
Êags
);

1025 i‡(!
ªt
)

1026 
ªt
 = 
	`£_öô
 (
maxevíts
, 
Êags
);

1028 #ñi‡
POLL


1029 
ªt
 = 
	`po_öô
 (
maxevíts
, 
Êags
);

1030 #ñi‡
SELECT


1031 
ªt
 = 
	`£_öô
 (
maxevíts
, 
Êags
);

1033 #îr‹ 
At
 
Àa°
 
⁄e
 
of
 
pﬁl
, 
£À˘
, 
‹
 
WSAWaôF‹Mu…ùÀEvíts
 
mu°
 
be
 
suµ‹ãd
 
by
 
the
 
kî√l


1035 
	`ASSERT
 (
ªt
);

1036  
ªt
;

1037 
	}
}

1039 
evít_£t
 *

1040 
	$evít_£t_öô_sˇœbÀ
 (*
maxevíts
, 
Êags
)

1042 
evít_£t
 *
ªt
 = 
NULL
;

1043 #i‡
EPOLL


1044 
ªt
 = 
	`ï_öô
 (
maxevíts
, 
Êags
);

1045 i‡(!
ªt
)

1047 
	`msg
 (
M_WARN
, "Note: sys_epoll API is unavailable, falling backÅoÖoll/select API");

1048 
ªt
 = 
	`evít_£t_öô_sim∂e
 (
maxevíts
, 
Êags
);

1051 
ªt
 = 
	`evít_£t_öô_sim∂e
 (
maxevíts
, 
Êags
);

1053 
	`ASSERT
 (
ªt
);

1054  
ªt
;

1055 
	}
}

1057 
evít_£t
 *

1058 
	$evít_£t_öô
 (*
maxevíts
, 
Êags
)

1060 i‡(
Êags
 & 
EVENT_METHOD_FAST
)

1061  
	`evít_£t_öô_sim∂e
 (
maxevíts
, 
Êags
);

1063  
	`evít_£t_öô_sˇœbÀ
 (
maxevíts
, 
Êags
);

1064 
	}
}

	@src/openvpn/event.h

25 #i‚de‡
EVENT_H


26 
	#EVENT_H


	)

28 
	~"wö32.h
"

29 
	~"sig.h
"

30 
	~"≥rf.h
"

36 
	#EVENT_UNDEF
 4

	)

37 
	#EVENT_READ
 (1<<0)

	)

38 
	#EVENT_WRITE
 (1<<1)

	)

42 
	#EVENT_METHOD_US_TIMEOUT
 (1<<0)

	)

43 
	#EVENT_METHOD_FAST
 (1<<1)

	)

45 #ifde‡
WIN32


47 c⁄° 
	trw_h™dÀ
 *
	tevít_t
;

49 
	#UNDEFINED_EVENT
 (
NULL
)

	)

53 
	tevít_t
;

55 
	#UNDEFINED_EVENT
 (-1)

	)

59 
	gevít_£t
;

60 
	gevít_£t_ªtu∫
;

62 
	sevít_£t_fun˘i⁄s


64 (*
	m‰ì
)(
evít_£t
 *
	mes
);

65 (*
	mª£t
)(
evít_£t
 *
	mes
);

66 (*
	mdñ
)(
evít_£t
 *
	mes
, 
evít_t
 
	mevít
);

67 (*
	m˘l
)(
evít_£t
 *
	mes
, 
evít_t
 
	mevít
, 
	mrwÊags
, *
	m¨g
);

75 (*
	mwaô
)(
evít_£t
 *
	mes
, c⁄° 
timevÆ
 *
	mtv
, 
evít_£t_ªtu∫
 *
	mout
, 
	mouéí
);

78 
	sevít_£t_ªtu∫


80 
	mrwÊags
;

81 *
	m¨g
;

84 
	sevít_£t


86 
evít_£t_fun˘i⁄s
 
	mfunc
;

96 
evít_£t
 *
evít_£t_öô
 (*
maxevíts
, 
Êags
);

98 
ölöe
 

99 
	$evít_‰ì
 (
evít_£t
 *
es
)

101 i‡(
es
)

102 (*
es
->
func
.
‰ì
)(es);

103 
	}
}

105 
ölöe
 

106 
	$evít_ª£t
 (
evít_£t
 *
es
)

108 (*
es
->
func
.
ª£t
)(es);

109 
	}
}

111 
ölöe
 

112 
	$evít_dñ
 (
evít_£t
 *
es
, 
evít_t
 
evít
)

114 (*
es
->
func
.
dñ
)”s, 
evít
);

115 
	}
}

117 
ölöe
 

118 
	$evít_˘l
 (
evít_£t
 *
es
, 
evít_t
 
evít
, 
rwÊags
, *
¨g
)

120 (*
es
->
func
.
˘l
)”s, 
evít
, 
rwÊags
, 
¨g
);

121 
	}
}

123 
ölöe
 

124 
	$evít_waô
 (
evít_£t
 *
es
, c⁄° 
timevÆ
 *
tv
, 
evít_£t_ªtu∫
 *
out
, 
ouéí
)

126 
ªt
;

127 
	`≥rf_push
 (
PERF_IO_WAIT
);

128 
ªt
 = (*
es
->
func
.
waô
)”s, 
tv
, 
out
, 
ouéí
);

129 
	`≥rf_p›
 ();

130  
ªt
;

131 
	}
}

133 
ölöe
 

134 
	$evít_£t_ªtu∫_öô
 (
evít_£t_ªtu∫
 *
e§
)

136 
e§
->
rwÊags
 = 0;

137 
e§
->
¨g
 = 
NULL
;

138 
	}
}

140 #ifde‡
WIN32


142 
ölöe
 

143 
	$waô_sig«l
 (
evít_£t
 *
es
, *
¨g
)

145 i‡(
	`HANDLE_DEFINED
 (
wö32_sig«l
.
ö
.
ªad
))

146 
	`evít_˘l
 (
es
, &
wö32_sig«l
.
ö
, 
EVENT_READ
, 
¨g
);

147 
	}
}

151 
ölöe
 

152 
	$waô_sig«l
 (
evít_£t
 *
es
, *
¨g
)

154 
	}
}

	@src/openvpn/fdmisc.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"fdmisc.h
"

34 
	~"îr‹.h
"

36 
	~"memdbg.h
"

39 
boﬁ


40 
	$£t_n⁄block_a˘i⁄
 (
fd
)

42 #ifde‡
WIN32


43 
u_l⁄g
 
¨g
 = 1;

44 i‡(
	`io˘lsockë
 (
fd
, 
FIONBIO
, &
¨g
))

45  
Ál£
;

47 i‡(
	`f˙é
 (
fd
, 
F_SETFL
, 
O_NONBLOCK
) < 0)

48  
Ál£
;

50  
åue
;

51 
	}
}

54 
boﬁ


55 
	$£t_˛€xec_a˘i⁄
 (
fd
)

57 #i‚de‡
WIN32


58 i‡(
	`f˙é
 (
fd
, 
F_SETFD
, 
FD_CLOEXEC
) < 0)

59  
Ál£
;

61  
åue
;

62 
	}
}

66 
	$£t_n⁄block
 (
fd
)

68 i‡(!
	`£t_n⁄block_a˘i⁄
 (
fd
))

69 
	`msg
 (
M_ERR
, "Set socketÅoÇon-blocking mode failed");

70 
	}
}

74 
	$£t_˛€xec
 (
fd
)

76 i‡(!
	`£t_˛€xec_a˘i⁄
 (
fd
))

77 
	`msg
 (
M_ERR
, "Set FD_CLOEXEC flag on file descriptor failed");

78 
	}
}

	@src/openvpn/fdmisc.h

25 
	~"basic.h
"

27 
boﬁ
 
£t_n⁄block_a˘i⁄
 (
fd
);

28 
boﬁ
 
£t_˛€xec_a˘i⁄
 (
fd
);

30 
£t_n⁄block
 (
fd
);

31 
£t_˛€xec
 (
fd
);

	@src/openvpn/forward-inline.h

25 #i‚de‡
FORWARD_INLINE_H


26 
	#FORWARD_INLINE_H


	)

35 
ölöe
 

36 
	$check_és
 (
c⁄ãxt
 *
c
)

38 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

39 
	`check_és_dow‹k
 (
c⁄ãxt
 *
c
);

40 i‡(
c
->
c2
.
és_mu…i
)

41 
	`check_és_dow‹k
 (
c
);

43 
	}
}

49 
ölöe
 

50 
	$check_és_îr‹s
 (
c⁄ãxt
 *
c
)

52 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

53 
	`check_és_îr‹s_co
 (
c⁄ãxt
 *
c
);

54 
	`check_és_îr‹s_nco
 (
c⁄ãxt
 *
c
);

55 i‡(
c
->
c2
.
és_mu…i
 && c->c2.
és_exô_sig«l
)

57 i‡(
	`lök_sockë_c⁄√˘i⁄_‹õ¡ed
 (
c
->
c2
.
lök_sockë
))

59 i‡(
c
->
c2
.
és_mu…i
->
n_so·_îr‹s
)

60 
	`check_és_îr‹s_co
 (
c
);

64 i‡(
c
->
c2
.
és_mu…i
->
n_h¨d_îr‹s
)

65 
	`check_és_îr‹s_nco
 (
c
);

69 
	}
}

75 
ölöe
 

76 
	$check_öcomög_c⁄åﬁ_ch™√l
 (
c⁄ãxt
 *
c
)

78 #i‡
P2MP


79 
	`check_öcomög_c⁄åﬁ_ch™√l_dow‹k
 (
c⁄ãxt
 *
c
);

80 i‡(
	`és_ã°_∑ylﬂd_Àn
 (
c
->
c2
.
és_mu…i
) > 0)

81 
	`check_öcomög_c⁄åﬁ_ch™√l_dow‹k
 (
c
);

83 
	}
}

89 
ölöe
 

90 
	$check_c⁄√˘i⁄_e°ablished
 (
c⁄ãxt
 *
c
)

92 
	`check_c⁄√˘i⁄_e°ablished_dow‹k
 (
c⁄ãxt
 *
c
);

93 i‡(
	`evít_timeout_deföed
 (&
c
->
c2
.
waô_f‹_c⁄√˘
))

94 
	`check_c⁄√˘i⁄_e°ablished_dow‹k
 (
c
);

95 
	}
}

100 
ölöe
 

101 
	$check_add_rouãs
 (
c⁄ãxt
 *
c
)

103 
	`check_add_rouãs_dow‹k
 (
c⁄ãxt
 *
c
);

104 i‡(
	`evít_timeout_åiggî
 (&
c
->
c2
.
rouã_wakeup
, &c->c2.
timevÆ
, 
ETT_DEFAULT
))

105 
	`check_add_rouãs_dow‹k
 (
c
);

106 
	}
}

111 
ölöe
 

112 
	$check_öa˘ivôy_timeout
 (
c⁄ãxt
 *
c
)

114 
	`check_öa˘ivôy_timeout_dow‹k
 (
c⁄ãxt
 *
c
);

116 i‡(
c
->
›ti⁄s
.
öa˘ivôy_timeout


117 && 
	`evít_timeout_åiggî
 (&
c
->
c2
.
öa˘ivôy_öãrvÆ
, &c->c2.
timevÆ
, 
ETT_DEFAULT
))

118 
	`check_öa˘ivôy_timeout_dow‹k
 (
c
);

119 
	}
}

121 #i‡
P2MP


123 
ölöe
 

124 
	$check_£rvî_pﬁl_timeout
 (
c⁄ãxt
 *
c
)

126 
	`check_£rvî_pﬁl_timeout_dow‹k
 (
c⁄ãxt
 *
c
);

128 i‡(
c
->
›ti⁄s
.
£rvî_pﬁl_timeout


129 && 
	`evít_timeout_åiggî
 (&
c
->
c2
.
£rvî_pﬁl_öãrvÆ
, &c->c2.
timevÆ
, 
ETT_DEFAULT
))

130 
	`check_£rvî_pﬁl_timeout_dow‹k
 (
c
);

131 
	}
}

136 
ölöe
 

137 
	$check_scheduÀd_exô
 (
c⁄ãxt
 *
c
)

139 
	`check_scheduÀd_exô_dow‹k
 (
c⁄ãxt
 *
c
);

141 i‡(
	`evít_timeout_deföed
 (&
c
->
c2
.
scheduÀd_exô
))

143 i‡(
	`evít_timeout_åiggî
 (&
c
->
c2
.
scheduÀd_exô
, &c->c2.
timevÆ
, 
ETT_DEFAULT
))

144 
	`check_scheduÀd_exô_dow‹k
 (
c
);

146 
	}
}

152 
ölöe
 

153 
	$check_°©us_fûe
 (
c⁄ãxt
 *
c
)

155 
	`check_°©us_fûe_dow‹k
 (
c⁄ãxt
 *
c
);

157 i‡(
c
->
c1
.
°©us_ouçut
)

159 i‡(
	`°©us_åiggî_tv
 (
c
->
c1
.
°©us_ouçut
, &c->
c2
.
timevÆ
))

160 
	`check_°©us_fûe_dow‹k
 (
c
);

162 
	}
}

164 #ifde‡
ENABLE_FRAGMENT


168 
ölöe
 

169 
	$check_‰agmít
 (
c⁄ãxt
 *
c
)

171 
	`check_‰agmít_dow‹k
 (
c⁄ãxt
 *
c
);

172 i‡(
c
->
c2
.
‰agmít
)

173 
	`check_‰agmít_dow‹k
 (
c
);

174 
	}
}

177 #i‡
P2MP


182 
ölöe
 

183 
	$check_push_ªque°
 (
c⁄ãxt
 *
c
)

185 
	`check_push_ªque°_dow‹k
 (
c⁄ãxt
 *
c
);

186 i‡(
	`evít_timeout_åiggî
 (&
c
->
c2
.
push_ªque°_öãrvÆ
, &c->c2.
timevÆ
, 
ETT_DEFAULT
))

187 
	`check_push_ªque°_dow‹k
 (
c
);

188 
	}
}

192 #ifde‡
ENABLE_CRYPTO


196 
ölöe
 

197 
	$check_∑ckë_id_≥rsi°_Êush
 (
c⁄ãxt
 *
c
)

199 i‡(
	`∑ckë_id_≥rsi°_íabÀd
 (&
c
->
c1
.
pid_≥rsi°
)

200 && 
	`evít_timeout_åiggî
 (&
c
->
c2
.
∑ckë_id_≥rsi°_öãrvÆ
, &c->c2.
timevÆ
, 
ETT_DEFAULT
))

201 
	`∑ckë_id_≥rsi°_ßve
 (&
c
->
c1
.
pid_≥rsi°
);

202 
	}
}

209 
ölöe
 

210 
	$c⁄ãxt_immedüã_ªscheduÀ
 (
c⁄ãxt
 *
c
)

212 
c
->
c2
.
timevÆ
.
tv_£c
 = 0;

213 
c
->
c2
.
timevÆ
.
tv_u£c
 = 0;

214 
	}
}

216 
ölöe
 

217 
	$c⁄ãxt_ªscheduÀ_£c
 (
c⁄ãxt
 *
c
, 
£c
)

219 i‡(
£c
 < 0)

220 
£c
 = 0;

221 i‡(
£c
 < 
c
->
c2
.
timevÆ
.
tv_£c
)

223 
c
->
c2
.
timevÆ
.
tv_£c
 = 
£c
;

224 
c
->
c2
.
timevÆ
.
tv_u£c
 = 0;

226 
	}
}

228 
ölöe
 
lök_sockë_öfo
 *

229 
	$gë_lök_sockë_öfo
 (
c⁄ãxt
 *
c
)

231 i‡(
c
->
c2
.
lök_sockë_öfo
)

232  
c
->
c2
.
lök_sockë_öfo
;

234  &
c
->
c2
.
lök_sockë
->
öfo
;

235 
	}
}

237 
ölöe
 

238 
	$ªgi°î_a˘ivôy
 (
c⁄ãxt
 *
c
, c⁄° 
size
)

240 i‡(
c
->
›ti⁄s
.
öa˘ivôy_timeout
)

242 
c
->
c2
.
öa˘ivôy_byãs
 +
size
;

243 i‡(
c
->
c2
.
öa˘ivôy_byãs
 >c->
›ti⁄s
.
öa˘ivôy_möimum_byãs
)

245 
c
->
c2
.
öa˘ivôy_byãs
 = 0;

246 
	`evít_timeout_ª£t
 (&
c
->
c2
.
öa˘ivôy_öãrvÆ
);

249 
	}
}

255 
ölöe
 

256 
	$p2p_iow_Êags
 (c⁄° 
c⁄ãxt
 *
c
)

258 
Êags
 = (
IOW_SHAPER
|
IOW_CHECK_RESIDUAL
|
IOW_FRAG
|
IOW_READ
|
IOW_WAIT_SIGNAL
);

259 i‡(
c
->
c2
.
to_lök
.
Àn
 > 0)

260 
Êags
 |
IOW_TO_LINK
;

261 i‡(
c
->
c2
.
to_tun
.
Àn
 > 0)

262 
Êags
 |
IOW_TO_TUN
;

263  
Êags
;

264 
	}
}

270 
ölöe
 

271 
	$io_waô
 (
c⁄ãxt
 *
c
, c⁄° 
Êags
)

273 
	`io_waô_dow‹k
 (
c⁄ãxt
 *
c
, c⁄° 
Êags
);

275 i‡(
c
->
c2
.
Á°_io
 && (
Êags
 & (
IOW_TO_TUN
|
IOW_TO_LINK
|
IOW_MBUF
)))

278 
ªt
 = 0;

279 i‡(
Êags
 & 
IOW_TO_TUN
)

280 
ªt
 |
TUN_WRITE
;

281 i‡(
Êags
 & (
IOW_TO_LINK
|
IOW_MBUF
))

282 
ªt
 |
SOCKET_WRITE
;

283 
c
->
c2
.
evít_£t_°©us
 = 
ªt
;

288 
	`io_waô_dow‹k
 (
c
, 
Êags
);

290 
	}
}

292 
	#CONNECTION_ESTABLISHED
(
c
Ë(
	`gë_lök_sockë_öfo
(c)->
c⁄√˘i⁄_e°ablished
)

	)

	@src/openvpn/forward.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"f‹w¨d.h
"

34 
	~"öô.h
"

35 
	~"push.h
"

36 
	~"gªmlö.h
"

37 
	~"mss.h
"

38 
	~"evít.h
"

39 
	~"ps.h
"

40 
	~"dh˝.h
"

41 
	~"comm⁄.h
"

43 
	~"memdbg.h
"

45 
	~"f‹w¨d-ölöe.h
"

46 
	~"occ-ölöe.h
"

47 
	~"pög-ölöe.h
"

48 
	~"m°©s.h
"

50 
cou¡î_ty≥
 
	glök_ªad_byãs_globÆ
;

51 
cou¡î_ty≥
 
	glök_wrôe_byãs_globÆ
;

55 #ifde‡
ENABLE_DEBUG


58 
	$waô_°©us_°rög
 (
c⁄ãxt
 *
c
, 
gc_¨ía
 *
gc
)

60 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (64, 
gc
);

61 
	`buf_¥ötf
 (&
out
, "I/O WAIT %s|%s|%s|%s %s",

62 
	`tun_°©
 (
c
->
c1
.
tu¡≠
, 
EVENT_READ
, 
gc
),

63 
	`tun_°©
 (
c
->
c1
.
tu¡≠
, 
EVENT_WRITE
, 
gc
),

64 
	`sockë_°©
 (
c
->
c2
.
lök_sockë
, 
EVENT_READ
, 
gc
),

65 
	`sockë_°©
 (
c
->
c2
.
lök_sockë
, 
EVENT_WRITE
, 
gc
),

66 
	`tv_°rög
 (&
c
->
c2
.
timevÆ
, 
gc
));

67  
	`BSTR
 (&
out
);

68 
	}
}

71 
	$show_waô_°©us
 (
c⁄ãxt
 *
c
)

73 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

74 
	`dmsg
 (
D_EVENT_WAIT
, "%s", 
	`waô_°©us_°rög
 (
c
, &
gc
));

75 
	`gc_‰ì
 (&
gc
);

76 
	}
}

90 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

92 
	$check_és_dow‹k
 (
c⁄ãxt
 *
c
)

94 
öãrvÆ_t
 
wakeup
 = 
BIG_TIMEOUT
;

96 i‡(
	`öãrvÆ_ã°
 (&
c
->
c2
.
tmp_öt
))

98 c⁄° 
tmp_°©us
 = 
és_mu…i_¥o˚ss


99 (
c
->
c2
.
és_mu…i
, &c->c2.
to_lök
, &c->c2.
to_lök_addr
,

100 
	`gë_lök_sockë_öfo
 (
c
), &
wakeup
);

101 i‡(
tmp_°©us
 =
TLSMP_ACTIVE
)

103 
	`upd©e_time
 ();

104 
	`öãrvÆ_a˘i⁄
 (&
c
->
c2
.
tmp_öt
);

106 i‡(
tmp_°©us
 =
TLSMP_KILL
)

108 
	`ªgi°î_sig«l
 (
c
, 
SIGTERM
, "auth-control-exit");

111 
	`öãrvÆ_futuª_åiggî
 (&
c
->
c2
.
tmp_öt
, 
wakeup
);

114 
	`öãrvÆ_scheduÀ_wakeup
 (&
c
->
c2
.
tmp_öt
, &
wakeup
);

116 i‡(
wakeup
)

117 
	`c⁄ãxt_ªscheduÀ_£c
 (
c
, 
wakeup
);

118 
	}
}

121 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

124 
	$check_és_îr‹s_co
 (
c⁄ãxt
 *
c
)

126 
	`msg
 (
D_STREAM_ERRORS
, "Fatal TLSÉrror (check_tls_errors_co),Ñestarting");

127 
	`ªgi°î_sig«l
 (
c
, c->
c2
.
és_exô_sig«l
, "tls-error");

128 
	}
}

131 
	$check_és_îr‹s_nco
 (
c⁄ãxt
 *
c
)

133 
	`ªgi°î_sig«l
 (
c
, c->
c2
.
és_exô_sig«l
, "tls-error");

134 
	}
}

138 #i‡
P2MP


145 
	$check_öcomög_c⁄åﬁ_ch™√l_dow‹k
 (
c⁄ãxt
 *
c
)

147 c⁄° 
Àn
 = 
	`és_ã°_∑ylﬂd_Àn
 (
c
->
c2
.
és_mu…i
);

148 i‡(
Àn
)

150 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

151 
buf„r
 
buf
 = 
	`Æloc_buf_gc
 (
Àn
, &
gc
);

152 i‡(
	`és_ªc_∑ylﬂd
 (
c
->
c2
.
és_mu…i
, &
buf
))

155 
	`buf_nuŒ_ãrmö©e
 (&
buf
);

158 
	`°rög_mod
 (
	`BSTR
 (&
buf
), 
CC_PRINT
, 
CC_CRLF
, 0);

160 i‡(
	`buf_°rög_m©ch_hód_°r
 (&
buf
, "AUTH_FAILED"))

161 
	`ª˚ive_auth_Áûed
 (
c
, &
buf
);

162 i‡(
	`buf_°rög_m©ch_hód_°r
 (&
buf
, "PUSH_"))

163 
	`öcomög_push_mesßge
 (
c
, &
buf
);

164 i‡(
	`buf_°rög_m©ch_hód_°r
 (&
buf
, "RESTART"))

165 
	`£rvî_pushed_sig«l
 (
c
, &
buf
, 
åue
, 7);

166 i‡(
	`buf_°rög_m©ch_hód_°r
 (&
buf
, "HALT"))

167 
	`£rvî_pushed_sig«l
 (
c
, &
buf
, 
Ál£
, 4);

169 
	`msg
 (
D_PUSH_ERRORS
, "WARNING: Re˚ived unknow¿c⁄åﬁ mesßge: %s", 
	`BSTR
 (&
buf
));

173 
	`msg
 (
D_PUSH_ERRORS
, "WARNING: Receive control message failed");

176 
	`gc_‰ì
 (&
gc
);

178 
	}
}

184 
	$check_push_ªque°_dow‹k
 (
c⁄ãxt
 *
c
)

186 
	`£nd_push_ªque°
 (
c
);

189 
	`evít_timeout_modify_wakeup
 (&
c
->
c2
.
push_ªque°_öãrvÆ
, 
PUSH_REQUEST_INTERVAL
);

190 
	}
}

198 
	$check_c⁄√˘i⁄_e°ablished_dow‹k
 (
c⁄ãxt
 *
c
)

200 i‡(
	`evít_timeout_åiggî
 (&
c
->
c2
.
waô_f‹_c⁄√˘
, &c->c2.
timevÆ
, 
ETT_DEFAULT
))

202 i‡(
	`CONNECTION_ESTABLISHED
 (
c
))

204 #i‡
P2MP


206 i‡(
c
->
c2
.
és_mu…i
 && c->
›ti⁄s
.
puŒ
)

208 #ifde‡
ENABLE_MANAGEMENT


209 i‡(
m™agemít
)

211 
	`m™agemít_£t_°©e
 (
m™agemít
,

212 
OPENVPN_STATE_GET_CONFIG
,

213 
NULL
,

219 
	`evít_timeout_öô
 (&
c
->
c2
.
push_ªque°_öãrvÆ
, 1, 
now
);

220 
	`ª£t_cﬂr£_timîs
 (
c
);

225 
	`do_up
 (
c
, 
Ál£
, 0);

228 
	`evít_timeout_˛ór
 (&
c
->
c2
.
waô_f‹_c⁄√˘
);

231 
	}
}

238 
boﬁ


239 
	$£nd_c⁄åﬁ_ch™√l_°rög
 (
c⁄ãxt
 *
c
, c⁄° *
°r
, 
msgÀvñ
)

241 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

242 i‡(
c
->
c2
.
és_mu…i
) {

243 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

244 
boﬁ
 
°©
;

247 
°©
 = 
	`és_£nd_∑ylﬂd
 (
c
->
c2
.
és_mu…i
, (
uöt8_t
*Ë
°r
, 
	`°æí
 (str) + 1);

255 
	`öãrvÆ_a˘i⁄
 (&
c
->
c2
.
tmp_öt
);

256 
	`c⁄ãxt_immedüã_ªscheduÀ
 (
c
);

258 
	`msg
 (
msgÀvñ
, "SENT CONTROL [%s]: '%s' (status=%d)",

259 
	`és_comm⁄_«me
 (
c
->
c2
.
és_mu…i
, 
Ál£
),

260 
	`ßnôize_c⁄åﬁ_mesßge
 (
°r
, &
gc
),

261 (Ë
°©
);

263 
	`gc_‰ì
 (&
gc
);

264  
°©
;

267  
åue
;

268 
	}
}

275 
	$check_add_rouãs_a˘i⁄
 (
c⁄ãxt
 *
c
, c⁄° 
boﬁ
 
îr‹s
)

277 
	`do_rouã
 (&
c
->
›ti⁄s
, c->
c1
.
rouã_li°
, c->c1.
rouã_ùv6_li°
,

278 
c
->
c1
.
tu¡≠
, c->
∂ugös
, c->
c2
.
es
);

279 
	`upd©e_time
 ();

280 
	`evít_timeout_˛ór
 (&
c
->
c2
.
rouã_wakeup
);

281 
	`evít_timeout_˛ór
 (&
c
->
c2
.
rouã_wakeup_expúe
);

282 
	`öôüliz©i⁄_£quí˚_com∂ëed
 (
c
, 
îr‹s
 ? 
ISC_ERRORS
 : 0);

283 
	}
}

286 
	$check_add_rouãs_dow‹k
 (
c⁄ãxt
 *
c
)

288 i‡(
	`ã°_rouãs
 (
c
->
c1
.
rouã_li°
, c->c1.
tu¡≠
))

290 
	`check_add_rouãs_a˘i⁄
 (
c
, 
Ál£
);

292 i‡(
	`evít_timeout_åiggî
 (&
c
->
c2
.
rouã_wakeup_expúe
, &c->c2.
timevÆ
, 
ETT_DEFAULT
))

294 
	`check_add_rouãs_a˘i⁄
 (
c
, 
åue
);

298 
	`msg
 (
D_ROUTE
, "Route: Waiting for TUN/TAP interfaceÅo come up...");

299 i‡(
c
->
c1
.
tu¡≠
)

301 i‡(!
	`tun_°™dby
 (
c
->
c1
.
tu¡≠
))

303 
	`ªgi°î_sig«l
 (
c
, 
SIGHUP
, "ip-fail");

304 
c
->
≥rsi°
.
ª°¨t_¶ìp_£c⁄ds
 = 10;

305 #ifde‡
WIN32


306 
	`show_rouãs
 (
M_INFO
|
M_NOPREFIX
);

307 
	`show_ad≠ãrs
 (
M_INFO
|
M_NOPREFIX
);

311 
	`upd©e_time
 ();

312 i‡(
c
->
c2
.
rouã_wakeup
.
n
 != 1)

313 
	`evít_timeout_öô
 (&
c
->
c2
.
rouã_wakeup
, 1, 
now
);

314 
	`evít_timeout_ª£t
 (&
c
->
c2
.
pög_ªc_öãrvÆ
);

316 
	}
}

322 
	$check_öa˘ivôy_timeout_dow‹k
 (
c⁄ãxt
 *
c
)

324 
	`msg
 (
M_INFO
, "InactivityÅimeout (--inactive),Éxiting");

325 
	`ªgi°î_sig«l
 (
c
, 
SIGTERM
, "inactive");

326 
	}
}

328 #i‡
P2MP


331 
	$check_£rvî_pﬁl_timeout_dow‹k
 (
c⁄ãxt
 *
c
)

333 
	`evít_timeout_ª£t
 (&
c
->
c2
.
£rvî_pﬁl_öãrvÆ
);

334 i‡(!
	`és_öôül_∑ckë_ª˚ived
 (
c
->
c2
.
és_mu…i
))

336 
	`msg
 (
M_INFO
, "ServerÖollÅimeout,Ñestarting");

337 
	`ªgi°î_sig«l
 (
c
, 
SIGUSR1
, "server_poll");

338 
c
->
≥rsi°
.
ª°¨t_¶ìp_£c⁄ds
 = -1;

340 
	}
}

346 
	$scheduÀ_exô
 (
c⁄ãxt
 *
c
, c⁄° 
n_£c⁄ds
, c⁄° 
sig«l
)

348 
	`és_£t_sögÀ_£ssi⁄
 (
c
->
c2
.
és_mu…i
);

349 
	`upd©e_time
 ();

350 
	`ª£t_cﬂr£_timîs
 (
c
);

351 
	`evít_timeout_öô
 (&
c
->
c2
.
scheduÀd_exô
, 
n_£c⁄ds
, 
now
);

352 
c
->
c2
.
scheduÀd_exô_sig«l
 = 
sig«l
;

353 
	`msg
 (
D_SCHED_EXIT
, "DñayedÉxô i¿%d sec⁄ds", 
n_£c⁄ds
);

354 
	}
}

360 
	$check_scheduÀd_exô_dow‹k
 (
c⁄ãxt
 *
c
)

362 
	`ªgi°î_sig«l
 (
c
, c->
c2
.
scheduÀd_exô_sig«l
, "delayed-exit");

363 
	}
}

371 
	$check_°©us_fûe_dow‹k
 (
c⁄ãxt
 *
c
)

373 i‡(
c
->
c1
.
°©us_ouçut
)

374 
	`¥öt_°©us
 (
c
, c->
c1
.
°©us_ouçut
);

375 
	}
}

377 #ifde‡
ENABLE_FRAGMENT


382 
	$check_‰agmít_dow‹k
 (
c⁄ãxt
 *
c
)

384 
lök_sockë_öfo
 *
lsi
 = 
	`gë_lök_sockë_öfo
 (
c
);

387 i‡(
lsi
->
mtu_ch™ged
 && 
c
->
c2
.
ùv4_tun
)

389 
	`‰ame_adju°_∑th_mtu
 (&
c
->
c2
.
‰ame_‰agmít
, c->c2.
lök_sockë
->
mtu
,

390 
c
->
›ti⁄s
.
˚
.
¥Ÿo
);

391 
lsi
->
mtu_ch™ged
 = 
Ál£
;

394 i‡(
	`‰agmít_outgoög_deföed
 (
c
->
c2
.
‰agmít
))

396 i‡(!
c
->
c2
.
to_lök
.
Àn
)

399 
	`ASSERT
 (
	`‰agmít_ªady_to_£nd
 (
c
->
c2
.
‰agmít
, &c->c2.
buf
, &c->c2.
‰ame_‰agmít
));

400 
	`í¸y±_sign
 (
c
, 
Ál£
);

404 
	`‰agmít_hou£kìpög
 (
c
->
c2
.
‰agmít
, &c->c2.
‰ame_‰agmít
, &c->c2.
timevÆ
);

405 
	}
}

411 
ölöe
 

412 
	$buf„r_tu∫ovî
 (c⁄° 
uöt8_t
 *
‹ig_buf
, 
buf„r
 *
de°_°ub
, buf„∏*
§c_°ub
, buf„∏*
°‹age
)

414 i‡(
‹ig_buf
 =
§c_°ub
->
d©a
 && src_°ub->d©®!
°‹age
->data)

416 
	`buf_assign
 (
°‹age
, 
§c_°ub
);

417 *
de°_°ub
 = *
°‹age
;

421 *
de°_°ub
 = *
§c_°ub
;

423 
	}
}

431 
	$í¸y±_sign
 (
c⁄ãxt
 *
c
, 
boﬁ
 
comp_‰ag
)

433 
c⁄ãxt_buf„rs
 *
b
 = 
c
->
c2
.
buf„rs
;

434 c⁄° 
uöt8_t
 *
‹ig_buf
 = 
c
->
c2
.
buf
.
d©a
;

436 #i‡
P2MP_SERVER


441 i‡(
c
->
c2
.
c⁄ãxt_auth
 !
CAS_SUCCEEDED
)

442 
c
->
c2
.
buf
.
Àn
 = 0;

445 i‡(
comp_‰ag
)

447 #ifde‡
ENABLE_LZO


449 i‡(
	`lzo_deföed
 (&
c
->
c2
.
lzo_compw‹k
))

450 
	`lzo_com¥ess
 (&
c
->
c2
.
buf
, 
b
->
lzo_com¥ess_buf
, &c->c2.
lzo_compw‹k
, &c->c2.
‰ame
);

452 #ifde‡
ENABLE_FRAGMENT


453 i‡(
c
->
c2
.
‰agmít
)

454 
	`‰agmít_outgoög
 (
c
->
c2
.
‰agmít
, &c->c2.
buf
, &c->c2.
‰ame_‰agmít
);

458 #ifde‡
ENABLE_CRYPTO


459 #ifde‡
ENABLE_SSL


464 i‡(
c
->
c2
.
és_mu…i
)

466 
	`és_¥e_í¸y±
 (
c
->
c2
.
és_mu…i
, &c->c2.
buf
, &c->c2.
¸y±o_›ti⁄s
);

474 
	`›ív≤_í¸y±
 (&
c
->
c2
.
buf
, 
b
->
í¸y±_buf
, &c->c2.
¸y±o_›ti⁄s
, &c->c2.
‰ame
);

479 
	`lök_sockë_gë_outgoög_addr
 (&
c
->
c2
.
buf
, 
	`gë_lök_sockë_öfo
 (c),

480 &
c
->
c2
.
to_lök_addr
);

481 #ifde‡
ENABLE_CRYPTO


482 #ifde‡
ENABLE_SSL


490 i‡(
c
->
c2
.
és_mu…i
)

492 
	`és_po°_í¸y±
 (
c
->
c2
.
és_mu…i
, &c->c2.
buf
);

498 
	`buf„r_tu∫ovî
 (
‹ig_buf
, &
c
->
c2
.
to_lök
, &c->c2.
buf
, &
b
->
ªad_tun_buf
);

499 
	}
}

505 
	$¥o˚ss_cﬂr£_timîs
 (
c⁄ãxt
 *
c
)

507 #ifde‡
ENABLE_CRYPTO


510 
	`check_∑ckë_id_≥rsi°_Êush
 (
c
);

514 
	`check_°©us_fûe
 (
c
);

517 
	`check_c⁄√˘i⁄_e°ablished
 (
c
);

519 #i‡
P2MP


521 
	`check_push_ªque°
 (
c
);

524 #ifde‡
PLUGIN_PF


525 
	`pf_check_ªlﬂd
 (
c
);

529 
	`check_add_rouãs
 (
c
);

532 
	`check_öa˘ivôy_timeout
 (
c
);

533 i‡(
c
->
sig
->
sig«l_ª˚ived
)

537 
	`check_pög_ª°¨t
 (
c
);

538 i‡(
c
->
sig
->
sig«l_ª˚ived
)

541 #i‡
P2MP


542 
	`check_£rvî_pﬁl_timeout
 (
c
);

543 i‡(
c
->
sig
->
sig«l_ª˚ived
)

546 
	`check_scheduÀd_exô
 (
c
);

547 i‡(
c
->
sig
->
sig«l_ª˚ived
)

551 #ifde‡
ENABLE_OCC


553 
	`check_£nd_occ_ªq
 (
c
);

556 
	`check_£nd_occ_lﬂd_ã°
 (
c
);

559 i‡(
c
->
c2
.
ex∂icô_exô_nŸifiˇti⁄_time_waô
)

560 
	`¥o˚ss_ex∂icô_exô_nŸifiˇti⁄_timî_wakeup
 (
c
);

564 
	`check_pög_£nd
 (
c
);

565 
	}
}

568 
	$check_cﬂr£_timîs_dow‹k
 (
c⁄ãxt
 *
c
)

570 c⁄° 
timevÆ
 
ßve
 = 
c
->
c2
.timeval;

571 
c
->
c2
.
timevÆ
.
tv_£c
 = 
BIG_TIMEOUT
;

572 
c
->
c2
.
timevÆ
.
tv_u£c
 = 0;

573 
	`¥o˚ss_cﬂr£_timîs
 (
c
);

574 
c
->
c2
.
cﬂr£_timî_wakeup
 = 
now
 + c->c2.
timevÆ
.
tv_£c
;

576 
	`dmsg
 (
D_INTERVAL
, "TIMER: cﬂr£Åimî wakeu∞%d sec⁄ds", (Ë
c
->
c2
.
timevÆ
.
tv_£c
);

579 i‡(
c
->
c2
.
timevÆ
.
tv_£c
 > 
ßve
.tv_sec)

580 
c
->
c2
.
timevÆ
 = 
ßve
;

581 
	}
}

583 
ölöe
 

584 
	$check_cﬂr£_timîs
 (
c⁄ãxt
 *
c
)

586 c⁄° 
time_t
 
loˇl_now
 = 
now
;

587 i‡(
loˇl_now
 >
c
->
c2
.
cﬂr£_timî_wakeup
)

588 
	`check_cﬂr£_timîs_dow‹k
 (
c
);

590 
	`c⁄ãxt_ªscheduÀ_£c
 (
c
, c->
c2
.
cﬂr£_timî_wakeup
 - 
loˇl_now
);

591 
	}
}

594 
	$check_timeout_øndom_comp⁄ít_dow‹k
 (
c⁄ãxt
 *
c
)

596 c⁄° 
upd©e_öãrvÆ
 = 10;

597 
c
->
c2
.
upd©e_timeout_øndom_comp⁄ít
 = 
now
 + 
upd©e_öãrvÆ
;

598 
c
->
c2
.
timeout_øndom_comp⁄ít
.
tv_u£c
 = (
time_t
Ë
	`gë_øndom
 () & 0x0003FFFF;

599 
c
->
c2
.
timeout_øndom_comp⁄ít
.
tv_£c
 = 0;

601 
	`dmsg
 (
D_INTERVAL
, "RANDOM USEC=%d", (Ë
c
->
c2
.
timeout_øndom_comp⁄ít
.
tv_u£c
);

602 
	}
}

604 
ölöe
 

605 
	$check_timeout_øndom_comp⁄ít
 (
c⁄ãxt
 *
c
)

607 i‡(
now
 >
c
->
c2
.
upd©e_timeout_øndom_comp⁄ít
)

608 
	`check_timeout_øndom_comp⁄ít_dow‹k
 (
c
);

609 i‡(
c
->
c2
.
timevÆ
.
tv_£c
 >= 1)

610 
	`tv_add
 (&
c
->
c2
.
timevÆ
, &c->c2.
timeout_øndom_comp⁄ít
);

611 
	}
}

613 #ifde‡
ENABLE_SOCKS


620 
ölöe
 

621 
	$socks_po°¥o˚ss_öcomög_lök
 (
c⁄ãxt
 *
c
)

623 i‡(
c
->
c2
.
lök_sockë
->
socks_¥oxy
 && c->c2.lök_sockë->
öfo
.
¥Ÿo
 =
PROTO_UDPv4
)

624 
	`socks_¥o˚ss_öcomög_udp
 (&
c
->
c2
.
buf
, &c->c2.
‰om
);

625 
	}
}

627 
ölöe
 

628 
	$socks_¥ïro˚ss_outgoög_lök
 (
c⁄ãxt
 *
c
,

629 
lök_sockë_a˘uÆ
 **
to_addr
,

630 *
size_dñè
)

632 i‡(
c
->
c2
.
lök_sockë
->
socks_¥oxy
 && c->c2.lök_sockë->
öfo
.
¥Ÿo
 =
PROTO_UDPv4
)

634 *
size_dñè
 +
	`socks_¥o˚ss_outgoög_udp
 (&
c
->
c2
.
to_lök
, c->c2.
to_lök_addr
);

635 *
to_addr
 = &
c
->
c2
.
lök_sockë
->
socks_ªœy
;

637 
	}
}

640 
ölöe
 

641 
	$lök_sockë_wrôe_po°_size_adju°
 (*
size
,

642 
size_dñè
,

643 
buf„r
 *
buf
)

645 i‡(
size_dñè
 > 0 && *
size
 > size_delta)

647 *
size
 -
size_dñè
;

648 i‡(!
	`buf_adv™˚
 (
buf
, 
size_dñè
))

649 *
size
 = 0;

651 
	}
}

659 
	$ªad_öcomög_lök
 (
c⁄ãxt
 *
c
)

665 
°©us
;

669 
	`≥rf_push
 (
PERF_READ_IN_LINK
);

671 
c
->
c2
.
buf
 = c->c2.
buf„rs
->
ªad_lök_buf
;

672 
	`ASSERT
 (
	`buf_öô
 (&
c
->
c2
.
buf
, 
	`FRAME_HEADROOM_ADJ
 (&c->c2.
‰ame
, 
FRAME_HEADROOM_MARKER_READ_LINK
)));

674 
°©us
 = 
	`lök_sockë_ªad
 (
c
->
c2
.
lök_sockë
,

675 &
c
->
c2
.
buf
,

676 
	`MAX_RW_SIZE_LINK
 (&
c
->
c2
.
‰ame
),

677 &
c
->
c2
.
‰om
);

679 i‡(
	`sockë_c⁄√˘i⁄_ª£t
 (
c
->
c2
.
lök_sockë
, 
°©us
))

681 #i‡
PORT_SHARE


682 i‡(
p‹t_sh¨e
 && 
	`sockë_f‹eign_¥Ÿocﬁ_dëe˘ed
 (
c
->
c2
.
lök_sockë
))

684 c⁄° 
buf„r
 *
fbuf
 = 
	`sockë_f‹eign_¥Ÿocﬁ_hód
 (
c
->
c2
.
lök_sockë
);

685 c⁄° 
sd
 = 
	`sockë_f‹eign_¥Ÿocﬁ_sd
 (
c
->
c2
.
lök_sockë
);

686 
	`p‹t_sh¨e_ªdúe˘
 (
p‹t_sh¨e
, 
fbuf
, 
sd
);

687 
	`ªgi°î_sig«l
 (
c
, 
SIGTERM
, "port-share-redirect");

693 i‡(
c
->
›ti⁄s
.
öëd
)

695 
	`ªgi°î_sig«l
 (
c
, 
SIGTERM
, "connection-reset-inetd");

696 
	`msg
 (
D_STREAM_ERRORS
, "C⁄√˘i⁄Ñe£t, i√td/xöëdÉxô [%d]", 
°©us
);

700 #ifde‡
ENABLE_OCC


701 i‡(
	`evít_timeout_deföed
(&
c
->
c2
.
ex∂icô_exô_nŸifiˇti⁄_öãrvÆ
))

703 
	`msg
 (
D_STREAM_ERRORS
, "C⁄√˘i⁄Ñe£àdurögÉxôÇŸifiˇti⁄Öîiod, ign‹ög [%d]", 
°©us
);

704 
	`›ív≤_¶ìp
(1);

709 
	`ªgi°î_sig«l
 (
c
, 
SIGUSR1
, "connection-reset");

710 
	`msg
 (
D_STREAM_ERRORS
, "C⁄√˘i⁄Ñe£t,Ñe°¨tög [%d]", 
°©us
);

714 
	`≥rf_p›
 ();

719 
	`check_°©us
 (
°©us
, "ªad", 
c
->
c2
.
lök_sockë
, 
NULL
);

721 #ifde‡
ENABLE_SOCKS


723 
	`socks_po°¥o˚ss_öcomög_lök
 (
c
);

726 
	`≥rf_p›
 ();

727 
	}
}

735 
	$¥o˚ss_öcomög_lök
 (
c⁄ãxt
 *
c
)

737 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

738 
boﬁ
 
de¸y±_°©us
;

739 
lök_sockë_öfo
 *
lsi
 = 
	`gë_lök_sockë_öfo
 (
c
);

740 c⁄° 
uöt8_t
 *
‹ig_buf
 = 
c
->
c2
.
buf
.
d©a
;

742 
	`≥rf_push
 (
PERF_PROC_IN_LINK
);

744 i‡(
c
->
c2
.
buf
.
Àn
 > 0)

746 
c
->
c2
.
lök_ªad_byãs
 +c->c2.
buf
.
Àn
;

747 
lök_ªad_byãs_globÆ
 +
c
->
c2
.
buf
.
Àn
;

748 #ifde‡
ENABLE_MEMSTATS


749 i‡(
mm≠_°©s
)

750 
mm≠_°©s
->
lök_ªad_byãs
 = 
lök_ªad_byãs_globÆ
;

752 
c
->
c2
.
‹igöÆ_ªcv_size
 = c->c2.
buf
.
Àn
;

753 #ifde‡
ENABLE_MANAGEMENT


754 i‡(
m™agemít
)

756 
	`m™agemít_byãs_ö
 (
m™agemít
, 
c
->
c2
.
buf
.
Àn
);

757 #ifde‡
MANAGEMENT_DEF_AUTH


758 
	`m™agemít_byãs_£rvî
 (
m™agemít
, &
c
->
c2
.
lök_ªad_byãs
, &c->c2.
lök_wrôe_byãs
, &c->c2.
mda_c⁄ãxt
);

764 
c
->
c2
.
‹igöÆ_ªcv_size
 = 0;

766 #ifde‡
ENABLE_DEBUG


768 i‡(
c
->
›ti⁄s
.
gªmlö
) {

769 i‡(!
	`ask_gªmlö
 (
c
->
›ti⁄s
.
gªmlö
))

770 
c
->
c2
.
buf
.
Àn
 = 0;

771 
	`c‹ru±_gªmlö
 (&
c
->
c2
.
buf
, c->
›ti⁄s
.
gªmlö
);

776 #ifde‡
LOG_RW


777 i‡(
c
->
c2
.
log_rw
 && c->c2.
buf
.
Àn
 > 0)

778 
	`Ârötf
 (
°dîr
, "R");

780 
	`msg
 (
D_LINK_RW
, "%s READ [%d] from %s: %s",

781 
	`¥Ÿo2ascii
 (
lsi
->
¥Ÿo
, 
åue
),

782 
	`BLEN
 (&
c
->
c2
.
buf
),

783 
	`¥öt_lök_sockë_a˘uÆ
 (&
c
->
c2
.
‰om
, &
gc
),

784 
	`PROTO_DUMP
 (&
c
->
c2
.
buf
, &
gc
));

793 i‡(
c
->
c2
.
buf
.
Àn
 > 0)

795 i‡(!
	`lök_sockë_vîify_öcomög_addr
 (&
c
->
c2
.
buf
, 
lsi
, &c->c2.
‰om
))

796 
	`lök_sockë_bad_öcomög_addr
 (&
c
->
c2
.
buf
, 
lsi
, &c->c2.
‰om
);

798 #ifde‡
ENABLE_CRYPTO


799 #ifde‡
ENABLE_SSL


800 i‡(
c
->
c2
.
és_mu…i
)

812 i‡(
	`és_¥e_de¸y±
 (
c
->
c2
.
és_mu…i
, &c->c2.
‰om
, &c->c2.
buf
, &c->c2.
¸y±o_›ti⁄s
))

814 
	`öãrvÆ_a˘i⁄
 (&
c
->
c2
.
tmp_öt
);

817 i‡(
c
->
›ti⁄s
.
pög_ªc_timeout
)

818 
	`evít_timeout_ª£t
 (&
c
->
c2
.
pög_ªc_öãrvÆ
);

821 #i‡
P2MP_SERVER


826 i‡(
c
->
c2
.
c⁄ãxt_auth
 !
CAS_SUCCEEDED
)

827 
c
->
c2
.
buf
.
Àn
 = 0;

832 
de¸y±_°©us
 = 
	`›ív≤_de¸y±
 (&
c
->
c2
.
buf
, c->c2.
buf„rs
->
de¸y±_buf
, &c->c2.
¸y±o_›ti⁄s
, &c->c2.
‰ame
);

834 i‡(!
de¸y±_°©us
 && 
	`lök_sockë_c⁄√˘i⁄_‹õ¡ed
 (
c
->
c2
.
lök_sockë
))

837 
	`ªgi°î_sig«l
 (
c
, 
SIGUSR1
, "decryption-error");

838 
	`msg
 (
D_STREAM_ERRORS
, "Fatal decryptionÉrror (process_incoming_link),Ñestarting");

839 
d⁄e
;

844 #ifde‡
ENABLE_FRAGMENT


845 i‡(
c
->
c2
.
‰agmít
)

846 
	`‰agmít_öcomög
 (
c
->
c2
.
‰agmít
, &c->c2.
buf
, &c->c2.
‰ame_‰agmít
);

849 #ifde‡
ENABLE_LZO


851 i‡(
	`lzo_deföed
 (&
c
->
c2
.
lzo_compw‹k
))

852 
	`lzo_decom¥ess
 (&
c
->
c2
.
buf
, c->c2.
buf„rs
->
lzo_decom¥ess_buf
, &c->c2.
lzo_compw‹k
, &c->c2.
‰ame
);

855 #ifde‡
PACKET_TRUNCATION_CHECK


857 
	`ùv4_∑ckë_size_vîify
 (
	`BPTR
 (&
c
->
c2
.
buf
),

858 
	`BLEN
 (&
c
->
c2
.
buf
),

859 
	`TUNNEL_TYPE
 (
c
->
c1
.
tu¡≠
),

861 &
c
->
c2
.
n_åunc_po°_de¸y±
);

873 i‡(!
	`TLS_MODE
 (
c
))

874 
	`lök_sockë_£t_outgoög_addr
 (&
c
->
c2
.
buf
, 
lsi
, &c->c2.
‰om
, 
NULL
, c->c2.
es
);

877 i‡(
c
->
›ti⁄s
.
pög_ªc_timeout
 && c->
c2
.
buf
.
Àn
 > 0)

878 
	`evít_timeout_ª£t
 (&
c
->
c2
.
pög_ªc_öãrvÆ
);

881 i‡(
c
->
c2
.
buf
.
Àn
 > 0)

883 
c
->
c2
.
lök_ªad_byãs_auth
 +c->c2.
buf
.
Àn
;

884 
c
->
c2
.
max_ªcv_size_loˇl
 = 
	`max_öt
 (c->c2.
‹igöÆ_ªcv_size
, c->c2.max_recv_size_local);

888 i‡(
	`is_pög_msg
 (&
c
->
c2
.
buf
))

890 
	`dmsg
 (
D_PING
, "RECEIVED PING PACKET");

891 
c
->
c2
.
buf
.
Àn
 = 0;

894 #ifde‡
ENABLE_OCC


896 i‡(
	`is_occ_msg
 (&
c
->
c2
.
buf
))

897 
	`¥o˚ss_ª˚ived_occ_msg
 (
c
);

900 
	`buf„r_tu∫ovî
 (
‹ig_buf
, &
c
->
c2
.
to_tun
, &c->c2.
buf
, &c->c2.
buf„rs
->
ªad_lök_buf
);

903 i‡(!
	`tu¡≠_deföed
 (
c
->
c1
.
tu¡≠
))

904 
c
->
c2
.
to_tun
.
Àn
 = 0;

908 
	`buf_ª£t
 (&
c
->
c2
.
to_tun
);

910 
d⁄e
:

911 
	`≥rf_p›
 ();

912 
	`gc_‰ì
 (&
gc
);

913 
	}
}

920 
	$ªad_öcomög_tun
 (
c⁄ãxt
 *
c
)

927 
	`≥rf_push
 (
PERF_READ_IN_TUN
);

929 
c
->
c2
.
buf
 = c->c2.
buf„rs
->
ªad_tun_buf
;

930 #ifde‡
TUN_PASS_BUFFER


931 
	`ªad_tun_buf„ªd
 (
c
->
c1
.
tu¡≠
, &c->
c2
.
buf
, 
	`MAX_RW_SIZE_TUN
 (&c->c2.
‰ame
));

933 
	`ASSERT
 (
	`buf_öô
 (&
c
->
c2
.
buf
, 
	`FRAME_HEADROOM
 (&c->c2.
‰ame
)));

934 
	`ASSERT
 (
	`buf_ß„
 (&
c
->
c2
.
buf
, 
	`MAX_RW_SIZE_TUN
 (&c->c2.
‰ame
)));

935 
c
->
c2
.
buf
.
Àn
 = 
	`ªad_tun
 (c->
c1
.
tu¡≠
, 
	`BPTR
 (&c->c2.buf), 
	`MAX_RW_SIZE_TUN
 (&c->c2.
‰ame
));

938 #ifde‡
PACKET_TRUNCATION_CHECK


939 
	`ùv4_∑ckë_size_vîify
 (
	`BPTR
 (&
c
->
c2
.
buf
),

940 
	`BLEN
 (&
c
->
c2
.
buf
),

941 
	`TUNNEL_TYPE
 (
c
->
c1
.
tu¡≠
),

943 &
c
->
c2
.
n_åunc_tun_ªad
);

947 i‡(
	`tu¡≠_°›
 (
c
->
c2
.
buf
.
Àn
))

949 
	`ªgi°î_sig«l
 (
c
, 
SIGTERM
, "tun-stop");

950 
	`msg
 (
M_INFO
, "TUN/TAP interface has been stopped,Éxiting");

951 
	`≥rf_p›
 ();

956 i‡(
	`tu¡≠_ab‹t
(
c
->
c2
.
buf
.
Àn
))

958 
	`ªgi°î_sig«l
(
c
, 
SIGTERM
, "tun-abort");

959 
	`msg
(
M_FATAL
, "TUN/TAP I/O operationáborted,Éxiting");

960 
	`≥rf_p›
();

965 
	`check_°©us
 (
c
->
c2
.
buf
.
Àn
, "ªad from TUN/TAP", 
NULL
, c->
c1
.
tu¡≠
);

967 
	`≥rf_p›
 ();

968 
	}
}

976 
	$¥o˚ss_öcomög_tun
 (
c⁄ãxt
 *
c
)

978 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

980 
	`≥rf_push
 (
PERF_PROC_IN_TUN
);

982 i‡(
c
->
c2
.
buf
.
Àn
 > 0)

983 
c
->
c2
.
tun_ªad_byãs
 +c->c2.
buf
.
Àn
;

985 #ifde‡
LOG_RW


986 i‡(
c
->
c2
.
log_rw
 && c->c2.
buf
.
Àn
 > 0)

987 
	`Ârötf
 (
°dîr
, "r");

991 
	`dmsg
 (
D_TUN_RW
, "TUN READ [%d]", 
	`BLEN
 (&
c
->
c2
.
buf
));

993 i‡(
c
->
c2
.
buf
.
Àn
 > 0)

999 
	`¥o˚ss_ù_hódî
 (
c
, 
PIPV4_PASSTOS
|
PIP_MSSFIX
|
PIPV4_CLIENT_NAT
, &c->
c2
.
buf
);

1001 #ifde‡
PACKET_TRUNCATION_CHECK


1003 
	`ùv4_∑ckë_size_vîify
 (
	`BPTR
 (&
c
->
c2
.
buf
),

1004 
	`BLEN
 (&
c
->
c2
.
buf
),

1005 
	`TUNNEL_TYPE
 (
c
->
c1
.
tu¡≠
),

1007 &
c
->
c2
.
n_åunc_¥e_í¸y±
);

1010 
	`í¸y±_sign
 (
c
, 
åue
);

1014 
	`buf_ª£t
 (&
c
->
c2
.
to_lök
);

1016 
	`≥rf_p›
 ();

1017 
	`gc_‰ì
 (&
gc
);

1018 
	}
}

1021 
	$¥o˚ss_ù_hódî
 (
c⁄ãxt
 *
c
, 
Êags
, 
buf„r
 *
buf
)

1023 i‡(!
c
->
›ti⁄s
.
˚
.
mssfix
)

1024 
Êags
 &~
PIP_MSSFIX
;

1025 #i‡
PASSTOS_CAPABILITY


1026 i‡(!
c
->
›ti⁄s
.
∑s°os
)

1027 
Êags
 &~
PIPV4_PASSTOS
;

1029 i‡(!
c
->
›ti⁄s
.
rouã_g©eway_vü_dh˝
)

1030 
Êags
 &~
PIPV4_EXTRACT_DHCP_ROUTER
;

1032 i‡(
buf
->
Àn
 > 0)

1038 #i‡
PASSTOS_CAPABILITY


1039 i‡(
Êags
 & (
PIPV4_PASSTOS
|
PIP_MSSFIX
))

1041 i‡(
Êags
 & 
PIP_MSSFIX
)

1044 
buf„r
 
ùbuf
 = *
buf
;

1045 i‡(
	`is_ùv4
 (
	`TUNNEL_TYPE
 (
c
->
c1
.
tu¡≠
), &
ùbuf
))

1047 #i‡
PASSTOS_CAPABILITY


1049 i‡(
Êags
 & 
PIPV4_PASSTOS
)

1050 
	`lök_sockë_exåa˘_tos
 (
c
->
c2
.
lök_sockë
, &
ùbuf
);

1054 i‡(
Êags
 & 
PIP_MSSFIX
)

1055 
	`mss_fixup_ùv4
 (&
ùbuf
, 
	`MTU_TO_MSS
 (
	`TUN_MTU_SIZE_DYNAMIC
 (&
c
->
c2
.
‰ame
)));

1057 #ifde‡
ENABLE_CLIENT_NAT


1059 i‡((
Êags
 & 
PIPV4_CLIENT_NAT
Ë&& 
c
->
›ti⁄s
.
˛õ¡_«t
)

1061 c⁄° 
dúe˘i⁄
 = (
Êags
 & 
PIPV4_OUTGOING
Ë? 
CN_INCOMING
 : 
CN_OUTGOING
;

1062 
	`˛õ¡_«t_å™sf‹m
 (
c
->
›ti⁄s
.
˛õ¡_«t
, &
ùbuf
, 
dúe˘i⁄
);

1066 i‡(
Êags
 & 
PIPV4_EXTRACT_DHCP_ROUTER
)

1068 c⁄° 
ö_addr_t
 
dh˝_rouãr
 = 
	`dh˝_exåa˘_rouãr_msg
 (&
ùbuf
);

1069 i‡(
dh˝_rouãr
)

1070 
	`rouã_li°_add_v≤_g©eway
 (
c
->
c1
.
rouã_li°
, c->
c2
.
es
, 
dh˝_rouãr
);

1073 i‡(
	`is_ùv6
 (
	`TUNNEL_TYPE
 (
c
->
c1
.
tu¡≠
), &
ùbuf
))

1076 i‡(
Êags
 & 
PIP_MSSFIX
)

1077 
	`mss_fixup_ùv6
 (&
ùbuf
, 
	`MTU_TO_MSS
 (
	`TUN_MTU_SIZE_DYNAMIC
 (&
c
->
c2
.
‰ame
)));

1081 
	}
}

1088 
	$¥o˚ss_outgoög_lök
 (
c⁄ãxt
 *
c
)

1090 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1092 
	`≥rf_push
 (
PERF_PROC_OUT_LINK
);

1094 i‡(
c
->
c2
.
to_lök
.
Àn
 > 0 && c->c2.to_lök.À¿<
	`EXPANDED_SIZE
 (&c->c2.
‰ame
))

1100 
size
 = 0;

1101 
	`ASSERT
 (
	`lök_sockë_a˘uÆ_deföed
 (
c
->
c2
.
to_lök_addr
));

1103 #ifde‡
ENABLE_DEBUG


1105 i‡(!
c
->
›ti⁄s
.
gªmlö
 || 
	`ask_gªmlö
 (c->options.gremlin))

1112 #ifde‡
ENABLE_FEATURE_SHAPER


1113 i‡(
c
->
›ti⁄s
.
sh≠î
)

1114 
	`sh≠î_wrŸe_byãs
 (&
c
->
c2
.
sh≠î
, 
	`BLEN
 (&c->c2.
to_lök
)

1115 + 
	`d©agøm_ovîhód
 (
c
->
›ti⁄s
.
˚
.
¥Ÿo
));

1120 i‡(
c
->
›ti⁄s
.
pög_£nd_timeout
)

1121 
	`evít_timeout_ª£t
 (&
c
->
c2
.
pög_£nd_öãrvÆ
);

1123 #i‡
PASSTOS_CAPABILITY


1125 
	`lök_sockë_£t_tos
 (
c
->
c2
.
lök_sockë
);

1129 #ifde‡
LOG_RW


1130 i‡(
c
->
c2
.
log_rw
)

1131 
	`Ârötf
 (
°dîr
, "W");

1133 
	`msg
 (
D_LINK_RW
, "%s WRITE [%d]Åo %s: %s",

1134 
	`¥Ÿo2ascii
 (
c
->
c2
.
lök_sockë
->
öfo
.
¥Ÿo
, 
åue
),

1135 
	`BLEN
 (&
c
->
c2
.
to_lök
),

1136 
	`¥öt_lök_sockë_a˘uÆ
 (
c
->
c2
.
to_lök_addr
, &
gc
),

1137 
	`PROTO_DUMP
 (&
c
->
c2
.
to_lök
, &
gc
));

1141 
lök_sockë_a˘uÆ
 *
to_addr
 = 
c
->
c2
.
to_lök_addr
;

1142 #ifde‡
ENABLE_SOCKS


1143 
size_dñè
 = 0;

1146 #ifde‡
ENABLE_SOCKS


1148 
	`socks_¥ïro˚ss_outgoög_lök
 (
c
, &
to_addr
, &
size_dñè
);

1151 
size
 = 
	`lök_sockë_wrôe
 (
c
->
c2
.
lök_sockë
,

1152 &
c
->
c2
.
to_lök
,

1153 
to_addr
);

1155 #ifde‡
ENABLE_SOCKS


1157 
	`lök_sockë_wrôe_po°_size_adju°
 (&
size
, 
size_dñè
, &
c
->
c2
.
to_lök
);

1161 i‡(
size
 > 0)

1163 
c
->
c2
.
max_£nd_size_loˇl
 = 
	`max_öt
 (
size
, c->c2.max_send_size_local);

1164 
c
->
c2
.
lök_wrôe_byãs
 +
size
;

1165 
lök_wrôe_byãs_globÆ
 +
size
;

1166 #ifde‡
ENABLE_MEMSTATS


1167 i‡(
mm≠_°©s
)

1168 
mm≠_°©s
->
lök_wrôe_byãs
 = 
lök_wrôe_byãs_globÆ
;

1170 #ifde‡
ENABLE_MANAGEMENT


1171 i‡(
m™agemít
)

1173 
	`m™agemít_byãs_out
 (
m™agemít
, 
size
);

1174 #ifde‡
MANAGEMENT_DEF_AUTH


1175 
	`m™agemít_byãs_£rvî
 (
m™agemít
, &
c
->
c2
.
lök_ªad_byãs
, &c->c2.
lök_wrôe_byãs
, &c->c2.
mda_c⁄ãxt
);

1183 
	`check_°©us
 (
size
, "wrôe", 
c
->
c2
.
lök_sockë
, 
NULL
);

1185 i‡(
size
 > 0)

1188 i‡(
size
 !
	`BLEN
 (&
c
->
c2
.
to_lök
))

1189 
	`msg
 (
D_LINK_ERRORS
,

1191 
	`¥öt_lök_sockë_a˘uÆ
 (
c
->
c2
.
to_lök_addr
, &
gc
),

1192 
	`BLEN
 (&
c
->
c2
.
to_lök
),

1193 
size
);

1197 i‡(
c
->
c2
.
buf
.
Àn
 > 0 )

1198 
	`ªgi°î_a˘ivôy
 (
c
, 
size
);

1202 i‡(
c
->
c2
.
to_lök
.
Àn
 > 0)

1203 
	`msg
 (
D_LINK_ERRORS
, "TCP/UDPÖacketÅooÜarge on writeÅo %s (tried=%d,max=%d)",

1204 
	`¥öt_lök_sockë_a˘uÆ
 (
c
->
c2
.
to_lök_addr
, &
gc
),

1205 
c
->
c2
.
to_lök
.
Àn
,

1206 
	`EXPANDED_SIZE
 (&
c
->
c2
.
‰ame
));

1209 
	`buf_ª£t
 (&
c
->
c2
.
to_lök
);

1211 
	`≥rf_p›
 ();

1212 
	`gc_‰ì
 (&
gc
);

1213 
	}
}

1220 
	$¥o˚ss_outgoög_tun
 (
c⁄ãxt
 *
c
)

1222 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1228 i‡(
c
->
c2
.
to_tun
.
Àn
 <= 0)

1231 
	`≥rf_push
 (
PERF_PROC_OUT_TUN
);

1237 
	`¥o˚ss_ù_hódî
 (
c
, 
PIP_MSSFIX
|
PIPV4_EXTRACT_DHCP_ROUTER
|
PIPV4_CLIENT_NAT
|
PIPV4_OUTGOING
, &c->
c2
.
to_tun
);

1239 i‡(
c
->
c2
.
to_tun
.
Àn
 <
	`MAX_RW_SIZE_TUN
 (&c->c2.
‰ame
))

1244 
size
;

1246 #ifde‡
LOG_RW


1247 i‡(
c
->
c2
.
log_rw
)

1248 
	`Ârötf
 (
°dîr
, "w");

1250 
	`dmsg
 (
D_TUN_RW
, "TUN WRITE [%d]", 
	`BLEN
 (&
c
->
c2
.
to_tun
));

1252 #ifde‡
PACKET_TRUNCATION_CHECK


1253 
	`ùv4_∑ckë_size_vîify
 (
	`BPTR
 (&
c
->
c2
.
to_tun
),

1254 
	`BLEN
 (&
c
->
c2
.
to_tun
),

1255 
	`TUNNEL_TYPE
 (
c
->
c1
.
tu¡≠
),

1257 &
c
->
c2
.
n_åunc_tun_wrôe
);

1260 #ifde‡
TUN_PASS_BUFFER


1261 
size
 = 
	`wrôe_tun_buf„ªd
 (
c
->
c1
.
tu¡≠
, &c->
c2
.
to_tun
);

1263 
size
 = 
	`wrôe_tun
 (
c
->
c1
.
tu¡≠
, 
	`BPTR
 (&c->
c2
.
to_tun
), 
	`BLEN
 (&c->c2.to_tun));

1266 i‡(
size
 > 0)

1267 
c
->
c2
.
tun_wrôe_byãs
 +
size
;

1268 
	`check_°©us
 (
size
, "wrôêtÿTUN/TAP", 
NULL
, 
c
->
c1
.
tu¡≠
);

1271 i‡(
size
 > 0)

1274 i‡(
size
 !
	`BLEN
 (&
c
->
c2
.
to_tun
))

1275 
	`msg
 (
D_LINK_ERRORS
,

1277 
c
->
c1
.
tu¡≠
->
a˘uÆ_«me
,

1278 
	`BLEN
 (&
c
->
c2
.
to_tun
),

1279 
size
);

1282 
	`ªgi°î_a˘ivôy
 (
c
, 
size
);

1291 
	`msg
 (
D_LINK_ERRORS
, "tunÖacketÅooÜarge on write (tried=%d,max=%d)",

1292 
c
->
c2
.
to_tun
.
Àn
,

1293 
	`MAX_RW_SIZE_TUN
 (&
c
->
c2
.
‰ame
));

1296 
	`buf_ª£t
 (&
c
->
c2
.
to_tun
);

1298 
	`≥rf_p›
 ();

1299 
	`gc_‰ì
 (&
gc
);

1300 
	}
}

1303 
	$¥e_£À˘
 (
c⁄ãxt
 *
c
)

1312 
c
->
c2
.
timevÆ
.
tv_£c
 = 
BIG_TIMEOUT
;

1313 
c
->
c2
.
timevÆ
.
tv_u£c
 = 0;

1315 #i‡
	`deföed
(
WIN32
)

1316 i‡(
	`check_debug_Àvñ
 (
D_TAP_WIN_DEBUG
))

1318 
c
->
c2
.
timevÆ
.
tv_£c
 = 1;

1319 i‡(
	`tu¡≠_deföed
 (
c
->
c1
.
tu¡≠
))

1320 
	`tun_show_debug
 (
c
->
c1
.
tu¡≠
);

1325 
	`check_cﬂr£_timîs
 (
c
);

1326 i‡(
c
->
sig
->
sig«l_ª˚ived
)

1330 
	`check_és
 (
c
);

1333 
	`check_és_îr‹s
 (
c
);

1334 i‡(
c
->
sig
->
sig«l_ª˚ived
)

1338 
	`check_öcomög_c⁄åﬁ_ch™√l
 (
c
);

1340 #ifde‡
ENABLE_OCC


1342 
	`check_£nd_occ_msg
 (
c
);

1345 #ifde‡
ENABLE_FRAGMENT


1347 
	`check_‰agmít
 (
c
);

1351 
	`check_timeout_øndom_comp⁄ít
 (
c
);

1352 
	}
}

1361 
	$io_waô_dow‹k
 (
c⁄ãxt
 *
c
, c⁄° 
Êags
)

1363 
sockë
 = 0;

1364 
tu¡≠
 = 0;

1365 
evít_£t_ªtu∫
 
e§
[4];

1368 
sockë_shi·
 = 0;

1369 
tun_shi·
 = 2;

1370 
îr_shi·
 = 4;

1371 #ifde‡
ENABLE_MANAGEMENT


1372 
m™agemít_shi·
 = 6;

1378 
	`evít_ª£t
 (
c
->
c2
.
evít_£t
);

1384 i‡(
Êags
 & 
IOW_WAIT_SIGNAL
)

1385 
	`waô_sig«l
 (
c
->
c2
.
evít_£t
, (*)&
îr_shi·
);

1392 i‡(
Êags
 & 
IOW_TO_LINK
)

1394 i‡(
Êags
 & 
IOW_SHAPER
)

1401 #ifde‡
ENABLE_FEATURE_SHAPER


1402 
dñay
 = 0;

1405 i‡(
c
->
›ti⁄s
.
sh≠î
)

1406 
dñay
 = 
	`max_öt
 (dñay, 
	`sh≠î_dñay
 (&
c
->
c2
.
sh≠î
));

1408 i‡(
dñay
 < 1000)

1410 
sockë
 |
EVENT_WRITE
;

1414 
	`sh≠î_so⁄e°_evít
 (&
c
->
c2
.
timevÆ
, 
dñay
);

1417 
sockë
 |
EVENT_WRITE
;

1422 
sockë
 |
EVENT_WRITE
;

1425 i‡(!((
Êags
 & 
IOW_FRAG
Ë&& 
	`TO_LINK_FRAG
 (
c
)))

1427 i‡(
Êags
 & 
IOW_READ_TUN
)

1428 
tu¡≠
 |
EVENT_READ
;

1435 i‡(
Êags
 & 
IOW_TO_TUN
)

1437 
tu¡≠
 |
EVENT_WRITE
;

1441 i‡(
Êags
 & 
IOW_READ_LINK
)

1442 
sockë
 |
EVENT_READ
;

1448 i‡(
Êags
 & 
IOW_MBUF
)

1449 
sockë
 |
EVENT_WRITE
;

1454 i‡(
Êags
 & 
IOW_READ_TUN_FORCE
)

1455 
tu¡≠
 |
EVENT_READ
;

1460 
	`sockë_£t
 (
c
->
c2
.
lök_sockë
, c->c2.
evít_£t
, 
sockë
, (*)&
sockë_shi·
, 
NULL
);

1461 
	`tun_£t
 (
c
->
c1
.
tu¡≠
, c->
c2
.
evít_£t
,Åu¡≠, (*)&
tun_shi·
, 
NULL
);

1463 #ifde‡
ENABLE_MANAGEMENT


1464 i‡(
m™agemít
)

1465 
	`m™agemít_sockë_£t
 (
m™agemít
, 
c
->
c2
.
evít_£t
, (*)&
m™agemít_shi·
, 
NULL
);

1478 
c
->
c2
.
evít_£t_°©us
 = 
ES_ERROR
;

1480 i‡(!
c
->
sig
->
sig«l_ª˚ived
)

1482 i‡(!(
Êags
 & 
IOW_CHECK_RESIDUAL
Ë|| !
	`sockë_ªad_ªsiduÆ
 (
c
->
c2
.
lök_sockë
))

1484 
°©us
;

1486 #ifde‡
ENABLE_DEBUG


1487 i‡(
	`check_debug_Àvñ
 (
D_EVENT_WAIT
))

1488 
	`show_waô_°©us
 (
c
);

1494 
°©us
 = 
	`evít_waô
 (
c
->
c2
.
evít_£t
, &c->c2.
timevÆ
, 
e§
, 
	`SIZE
(esr));

1496 
	`check_°©us
 (
°©us
, "evít_waô", 
NULL
, NULL);

1498 i‡(
°©us
 > 0)

1500 
i
;

1501 
c
->
c2
.
evít_£t_°©us
 = 0;

1502 
i
 = 0; i < 
°©us
; ++i)

1504 c⁄° 
evít_£t_ªtu∫
 *
e
 = &
e§
[
i
];

1505 
c
->
c2
.
evít_£t_°©us
 |((
e
->
rwÊags
 & 3Ë<< *((*Î->
¨g
));

1508 i‡(
°©us
 == 0)

1510 
c
->
c2
.
evít_£t_°©us
 = 
ES_TIMEOUT
;

1515 
c
->
c2
.
evít_£t_°©us
 = 
SOCKET_READ
;

1520 
	`upd©e_time
 ();

1523 i‡(
c
->
c2
.
evít_£t_°©us
 & 
ES_ERROR
)

1524 
	`gë_sig«l
 (&
c
->
sig
->
sig«l_ª˚ived
);

1526 
	`dmsg
 (
D_EVENT_WAIT
, "I/O WAIT sètus=0x%04x", 
c
->
c2
.
evít_£t_°©us
);

1527 
	}
}

1530 
	$¥o˚ss_io
 (
c⁄ãxt
 *
c
)

1532 c⁄° 
°©us
 = 
c
->
c2
.
evít_£t_°©us
;

1534 #ifde‡
ENABLE_MANAGEMENT


1535 i‡(
°©us
 & (
MANAGEMENT_READ
|
MANAGEMENT_WRITE
))

1537 
	`ASSERT
 (
m™agemít
);

1538 
	`m™agemít_io
 (
m™agemít
);

1543 i‡(
°©us
 & 
SOCKET_WRITE
)

1545 
	`¥o˚ss_outgoög_lök
 (
c
);

1548 i‡(
°©us
 & 
TUN_WRITE
)

1550 
	`¥o˚ss_outgoög_tun
 (
c
);

1553 i‡(
°©us
 & 
SOCKET_READ
)

1555 
	`ªad_öcomög_lök
 (
c
);

1556 i‡(!
	`IS_SIG
 (
c
))

1557 
	`¥o˚ss_öcomög_lök
 (
c
);

1560 i‡(
°©us
 & 
TUN_READ
)

1562 
	`ªad_öcomög_tun
 (
c
);

1563 i‡(!
	`IS_SIG
 (
c
))

1564 
	`¥o˚ss_öcomög_tun
 (
c
);

1566 
	}
}

	@src/openvpn/forward.h

32 #i‚de‡
FORWARD_H


33 
	#FORWARD_H


	)

35 
	~"›ív≤.h
"

36 
	~"occ.h
"

37 
	~"pög.h
"

39 
	#TUN_OUT
(
c
Ë(
	`BLEN
(&(c)->
c2
.
to_tun
Ë> 0)

	)

40 
	#LINK_OUT
(
c
Ë(
	`BLEN
(&(c)->
c2
.
to_lök
Ë> 0)

	)

41 
	#ANY_OUT
(
c
Ë(
	`TUN_OUT
(cË|| 
	`LINK_OUT
(c))

	)

43 #ifde‡
ENABLE_FRAGMENT


44 
	#TO_LINK_FRAG
(
c
Ë((c)->
c2
.
‰agmít
 && 
	`‰agmít_outgoög_deföed
 ((c)->c2.‰agmít))

	)

46 
	#TO_LINK_FRAG
(
c
Ë(
Ál£
)

	)

49 
	#TO_LINK_DEF
(
c
Ë(
	`LINK_OUT
(cË|| 
	`TO_LINK_FRAG
(c))

	)

51 
	#IOW_TO_TUN
 (1<<0)

	)

52 
	#IOW_TO_LINK
 (1<<1)

	)

53 
	#IOW_READ_TUN
 (1<<2)

	)

54 
	#IOW_READ_LINK
 (1<<3)

	)

55 
	#IOW_SHAPER
 (1<<4)

	)

56 
	#IOW_CHECK_RESIDUAL
 (1<<5)

	)

57 
	#IOW_FRAG
 (1<<6)

	)

58 
	#IOW_MBUF
 (1<<7)

	)

59 
	#IOW_READ_TUN_FORCE
 (1<<8)

	)

60 
	#IOW_WAIT_SIGNAL
 (1<<9)

	)

62 
	#IOW_READ
 (
IOW_READ_TUN
|
IOW_READ_LINK
)

	)

65 
¥e_£À˘
 (
c⁄ãxt
 *
c
);

66 
¥o˚ss_io
 (
c⁄ãxt
 *
c
);

68 c⁄° *
waô_°©us_°rög
 (
c⁄ãxt
 *
c
, 
gc_¨ía
 *
gc
);

69 
show_waô_°©us
 (
c⁄ãxt
 *
c
);

105 
í¸y±_sign
 (
c⁄ãxt
 *
c
, 
boﬁ
 
comp_‰ag
);

128 
ªad_öcomög_lök
 (
c⁄ãxt
 *
c
);

162 
¥o˚ss_öcomög_lök
 (
c⁄ãxt
 *
c
);

177 
¥o˚ss_outgoög_lök
 (
c⁄ãxt
 *
c
);

193 
ªad_öcomög_tun
 (
c⁄ãxt
 *
c
);

208 
¥o˚ss_öcomög_tun
 (
c⁄ãxt
 *
c
);

223 
¥o˚ss_outgoög_tun
 (
c⁄ãxt
 *
c
);

228 
boﬁ
 
£nd_c⁄åﬁ_ch™√l_°rög
 (
c⁄ãxt
 *
c
, c⁄° *
°r
, 
msgÀvñ
);

230 
	#PIPV4_PASSTOS
 (1<<0)

	)

231 
	#PIP_MSSFIX
 (1<<1Ë

	)

232 
	#PIPV4_OUTGOING
 (1<<2)

	)

233 
	#PIPV4_EXTRACT_DHCP_ROUTER
 (1<<3)

	)

234 
	#PIPV4_CLIENT_NAT
 (1<<4)

	)

236 
¥o˚ss_ù_hódî
 (
c⁄ãxt
 *
c
, 
Êags
, 
buf„r
 *
buf
);

238 #i‡
P2MP


239 
scheduÀ_exô
 (
c⁄ãxt
 *
c
, c⁄° 
n_£c⁄ds
, c⁄° 
sig«l
);

	@src/openvpn/fragment.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #ifde‡
ENABLE_FRAGMENT


35 
	~"misc.h
"

36 
	~"‰agmít.h
"

37 
	~"öãgî.h
"

38 
	~"memdbg.h
"

40 
	#FRAG_ERR
(
s
Ë{ 
îrmsg
 = s; 
îr‹
; }

	)

43 
	$‰agmít_li°_buf_öô
 (
‰agmít_li°
 *
li°
, c⁄° 
‰ame
 *frame)

45 
i
;

46 
i
 = 0; i < 
N_FRAG_BUF
; ++i)

47 
li°
->
‰agmíts
[
i
].
buf
 = 
	`Æloc_buf
 (
	`BUF_SIZE
 (
‰ame
));

48 
	}
}

51 
	$‰agmít_li°_buf_‰ì
 (
‰agmít_li°
 *
li°
)

53 
i
;

54 
i
 = 0; i < 
N_FRAG_BUF
; ++i)

55 
	`‰ì_buf
 (&
li°
->
‰agmíts
[
i
].
buf
);

56 
	}
}

62 
‰agmít
 *

63 
	$‰agmít_li°_gë_buf
 (
‰agmít_li°
 *
li°
, 
£q_id
)

65 
diff
;

66 i‡(
	`abs
 (
diff
 = 
	`modulo_subåa˘
 (
£q_id
, 
li°
->£q_id, 
N_SEQ_ID
)Ë>
N_FRAG_BUF
)

68 
i
;

69 
i
 = 0; i < 
N_FRAG_BUF
; ++i)

70 
li°
->
‰agmíts
[
i
].
deföed
 = 
Ál£
;

71 
li°
->
ödex
 = 0;

72 
li°
->
£q_id
 = seq_id;

73 
diff
 = 0;

75 
diff
 > 0)

77 
li°
->
‰agmíts
[li°->
ödex
 = 
	`modulo_add
 (li°->ödex, 1, 
N_FRAG_BUF
)].
deföed
 = 
Ál£
;

78 
li°
->
£q_id
 = 
	`modulo_add
 (li°->£q_id, 1, 
N_SEQ_ID
);

79 --
diff
;

81  &
li°
->
‰agmíts
[
	`modulo_add
 (li°->
ödex
, 
diff
, 
N_FRAG_BUF
)];

82 
	}
}

84 
‰agmít_ma°î
 *

85 
	$‰agmít_öô
 (
‰ame
 *frame)

87 
‰agmít_ma°î
 *
ªt
;

91 
	`ALLOC_OBJ_CLEAR
 (
ªt
, 
‰agmít_ma°î
);

94 
	`‰ame_add_to_exåa_‰ame
 (
‰ame
, (
‰agmít_hódî_ty≥
));

104 
ªt
->
outgoög_£q_id
 = ()
	`gë_øndom
(Ë& (
N_SEQ_ID
 - 1);

106 
	`evít_timeout_öô
 (&
ªt
->
wakeup
, 
FRAG_WAKEUP_INTERVAL
, 
now
);

108  
ªt
;

109 
	}
}

112 
	$‰agmít_‰ì
 (
‰agmít_ma°î
 *
f
)

114 
	`‰agmít_li°_buf_‰ì
 (&
f
->
öcomög
);

115 
	`‰ì_buf
 (&
f
->
outgoög
);

116 
	`‰ì_buf
 (&
f
->
outgoög_ªtu∫
);

117 
	`‰ì
 (
f
);

118 
	}
}

121 
	$‰agmít_‰ame_öô
 (
‰agmít_ma°î
 *
f
, c⁄° 
‰ame
 *frame)

123 
	`‰agmít_li°_buf_öô
 (&
f
->
öcomög
, 
‰ame
);

124 
f
->
outgoög
 = 
	`Æloc_buf
 (
	`BUF_SIZE
 (
‰ame
));

125 
f
->
outgoög_ªtu∫
 = 
	`Æloc_buf
 (
	`BUF_SIZE
 (
‰ame
));

126 
	}
}

135 
	$‰agmít_öcomög
 (
‰agmít_ma°î
 *
f
, 
buf„r
 *
buf
,

136 c⁄° 
‰ame
* frame)

138 c⁄° *
îrmsg
 = 
NULL
;

139 
‰agmít_hódî_ty≥
 
Êags
 = 0;

140 
‰ag_ty≥
 = 0;

142 i‡(
buf
->
Àn
 > 0)

145 i‡(!
	`buf_ªad
 (
buf
, &
Êags
,  (flags)))

146 
	`FRAG_ERR
 ("flagsÇot found inÖacket");

147 
Êags
 = 
	`¡oh_‰agmít_hódî_ty≥
 (flags);

150 
‰ag_ty≥
 = ((
Êags
 >> 
FRAG_TYPE_SHIFT
Ë& 
FRAG_TYPE_MASK
);

157 i‡(
‰ag_ty≥
 =
FRAG_WHOLE
 || føg_ty≥ =
FRAG_YES_NOTLAST
)

163 i‡(
‰ag_ty≥
 =
FRAG_WHOLE
)

165 
	`dmsg
 (
D_FRAG_DEBUG
,

167 
‰agmít_hódî_f‹m©
,

168 
buf
->
Àn
,

169 
Êags
);

171 i‡(
Êags
 & (
FRAG_SEQ_ID_MASK
 | 
FRAG_ID_MASK
))

172 
	`FRAG_ERR
 ("spurrious FRAG_WHOLE flags");

174 i‡(
‰ag_ty≥
 =
FRAG_YES_NOTLAST
 || føg_ty≥ =
FRAG_YES_LAST
)

176 c⁄° 
£q_id
 = ((
Êags
 >> 
FRAG_SEQ_ID_SHIFT
Ë& 
FRAG_SEQ_ID_MASK
);

177 c⁄° 
n
 = ((
Êags
 >> 
FRAG_ID_SHIFT
Ë& 
FRAG_ID_MASK
);

178 c⁄° 
size
 = ((
‰ag_ty≥
 =
FRAG_YES_LAST
)

179 ? ()(((
Êags
 >> 
FRAG_SIZE_SHIFT
Ë& 
FRAG_SIZE_MASK
Ë<< 
FRAG_SIZE_ROUND_SHIFT
)

180 : 
buf
->
Àn
);

183 
‰agmít
 *
‰ag
 = 
	`‰agmít_li°_gë_buf
 (&
f
->
öcomög
, 
£q_id
);

185 
	`dmsg
 (
D_FRAG_DEBUG
,

187 
‰agmít_hódî_f‹m©
,

188 
buf
->
Àn
,

189 
‰ag_ty≥
,

190 
£q_id
,

191 
n
,

192 
size
,

193 
Êags
);

196 i‡(
size
 & 
FRAG_SIZE_ROUND_MASK
)

197 
	`FRAG_ERR
 ("bad fragment size");

200 i‡(!
‰ag
->
deföed
 || (‰ag->deföed && føg->
max_‰ag_size
 !
size
))

202 
‰ag
->
deföed
 = 
åue
;

203 
‰ag
->
max_‰ag_size
 = 
size
;

204 
‰ag
->
m≠
 = 0;

205 
	`ASSERT
 (
	`buf_öô
 (&
‰ag
->
buf
, 
	`FRAME_HEADROOM_ADJ
 (
‰ame
, 
FRAME_HEADROOM_MARKER_FRAGMENT
)));

209 i‡(!
	`buf_c›y_ønge
 (&
‰ag
->
buf
, 
n
 * 
size
, buf, 0, buf->
Àn
))

210 
	`FRAG_ERR
 ("fragment buffer overflow");

213 
‰ag
->
m≠
 |(((
‰ag_ty≥
 =
FRAG_YES_LAST
Ë? 
FRAG_MAP_MASK
 : 1Ë<< 
n
);

216 
‰ag
->
time°amp
 = 
now
;

219 i‡((
‰ag
->
m≠
 & 
FRAG_MAP_MASK
) == FRAG_MAP_MASK)

221 
‰ag
->
deföed
 = 
Ál£
;

222 *
buf
 = 
‰ag
->buf;

226 
buf
->
Àn
 = 0;

229 i‡(
‰ag_ty≥
 =
FRAG_TEST
)

231 
	`FRAG_ERR
 ("FRAG_TESTÇot implemented");

235 
	`FRAG_ERR
 ("unknown fragmentÅype");

241 
îr‹
:

242 i‡(
îrmsg
)

243 
	`msg
 (
D_FRAG_ERRORS
, "FRAG_INÉº‹ fœgs=" 
‰agmít_hódî_f‹m©
 ": %s", 
Êags
, 
îrmsg
);

244 
buf
->
Àn
 = 0;

246 
	}
}

250 
	$‰agmít_¥ïíd_Êags
 (
buf„r
 *
buf
,

251 
ty≥
,

252 
£q_id
,

253 
‰ag_id
,

254 
‰ag_size
)

256 
‰agmít_hódî_ty≥
 
Êags
 = ((
ty≥
 & 
FRAG_TYPE_MASK
Ë<< 
FRAG_TYPE_SHIFT
)

257 | ((
£q_id
 & 
FRAG_SEQ_ID_MASK
Ë<< 
FRAG_SEQ_ID_SHIFT
)

258 | ((
‰ag_id
 & 
FRAG_ID_MASK
Ë<< 
FRAG_ID_SHIFT
);

260 i‡(
ty≥
 =
FRAG_WHOLE
 ||Åy≥ =
FRAG_YES_NOTLAST
)

266 
	`dmsg
 (
D_FRAG_DEBUG
,

268 
‰agmít_hódî_f‹m©
,

269 
buf
->
Àn
, 
ty≥
, 
£q_id
, 
‰ag_id
, 
‰ag_size
, 
Êags
);

273 
Êags
 |(((
‰ag_size
 >> 
FRAG_SIZE_ROUND_SHIFT
Ë& 
FRAG_SIZE_MASK
Ë<< 
FRAG_SIZE_SHIFT
);

275 
	`dmsg
 (
D_FRAG_DEBUG
,

277 
‰agmít_hódî_f‹m©
,

278 
buf
->
Àn
, 
ty≥
, 
£q_id
, 
‰ag_id
, 
‰ag_size
, 
Êags
);

281 
Êags
 = 
	`ht⁄_‰agmít_hódî_ty≥
 (flags);

282 
	`ASSERT
 (
	`buf_wrôe_¥ïíd
 (
buf
, &
Êags
,  (flags)));

283 
	}
}

290 
ölöe
 

291 
	$›timÆ_‰agmít_size
 (
Àn
, 
max_‰ag_size
)

293 c⁄° 
mfs_Æig√d
 = (
max_‰ag_size
 & ~
FRAG_SIZE_ROUND_MASK
);

294 c⁄° 
div
 = 
Àn
 / 
mfs_Æig√d
;

295 c⁄° 
mod
 = 
Àn
 % 
mfs_Æig√d
;

297 i‡(
div
 > 0 && 
mod
 > 0 && mod < 
mfs_Æig√d
 * 3 / 4)

298  
	`mö_öt
 (
mfs_Æig√d
, (
max_‰ag_size
 - ((max_‰ag_sizê- 
mod
Ë/ (
div
 + 1))

299 + 
FRAG_SIZE_ROUND_MASK
) & ~FRAG_SIZE_ROUND_MASK);

301  
mfs_Æig√d
;

302 
	}
}

306 
	$‰agmít_outgoög
 (
‰agmít_ma°î
 *
f
, 
buf„r
 *
buf
,

307 c⁄° 
‰ame
* frame)

309 c⁄° *
îrmsg
 = 
NULL
;

310 i‡(
buf
->
Àn
 > 0)

313 i‡(
f
->
outgoög
.
Àn
)

314 
	`msg
 (
D_FRAG_ERRORS
, "FRAG: outgoing buffer isÇotÉmpty,Üen=[%d,%d]",

315 
buf
->
Àn
, 
f
->
outgoög
.len);

316 i‡(
buf
->
Àn
 > 
	`PAYLOAD_SIZE_DYNAMIC
(
‰ame
))

321 
f
->
outgoög_‰ag_size
 = 
	`›timÆ_‰agmít_size
 (
buf
->
Àn
, 
	`PAYLOAD_SIZE_DYNAMIC
(
‰ame
));

322 i‡(
buf
->
Àn
 > 
f
->
outgoög_‰ag_size
 * 
MAX_FRAGS
)

323 
	`FRAG_ERR
 ("too many fragments would beÑequiredÅo send datagram");

324 
	`ASSERT
 (
	`buf_öô
 (&
f
->
outgoög
, 
	`FRAME_HEADROOM
 (
‰ame
)));

325 
	`ASSERT
 (
	`buf_c›y
 (&
f
->
outgoög
, 
buf
));

326 
f
->
outgoög_£q_id
 = 
	`modulo_add
 (f->outgoög_£q_id, 1, 
N_SEQ_ID
);

327 
f
->
outgoög_‰ag_id
 = 0;

328 
buf
->
Àn
 = 0;

329 
	`ASSERT
 (
	`‰agmít_ªady_to_£nd
 (
f
, 
buf
, 
‰ame
));

336 
	`‰agmít_¥ïíd_Êags
 (
buf
,

337 
FRAG_WHOLE
,

345 
îr‹
:

346 i‡(
îrmsg
)

347 
	`msg
 (
D_FRAG_ERRORS
, "FRAG_OUTÉrror,Üen=%d frag_size=%d MAX_FRAGS=%d: %s",

348 
buf
->
Àn
, 
f
->
outgoög_‰ag_size
, 
MAX_FRAGS
, 
îrmsg
);

349 
buf
->
Àn
 = 0;

351 
	}
}

354 
boﬁ


355 
	$‰agmít_ªady_to_£nd
 (
‰agmít_ma°î
 *
f
, 
buf„r
 *
buf
,

356 c⁄° 
‰ame
* frame)

358 i‡(
	`‰agmít_outgoög_deföed
 (
f
))

361 
size
 = 
f
->
outgoög_‰ag_size
;

362 
œ°
 = 
Ál£
;

363 i‡(
f
->
outgoög
.
Àn
 <
size
)

365 
size
 = 
f
->
outgoög
.
Àn
;

366 
œ°
 = 
åue
;

370 *
buf
 = 
f
->
outgoög_ªtu∫
;

371 
	`ASSERT
 (
	`buf_öô
 (
buf
, 
	`FRAME_HEADROOM
 (
‰ame
)));

372 
	`ASSERT
 (
	`buf_c›y_n
 (
buf
, &
f
->
outgoög
, 
size
));

375 
	`‰agmít_¥ïíd_Êags
 (
buf
,

376 
œ°
 ? 
FRAG_YES_LAST
 : 
FRAG_YES_NOTLAST
,

377 
f
->
outgoög_£q_id
,

378 
f
->
outgoög_‰ag_id
++,

379 
f
->
outgoög_‰ag_size
);

381 
	`ASSERT
 (!
œ°
 || !
f
->
outgoög
.
Àn
);

383  
åue
;

386  
Ál£
;

387 
	}
}

390 
	$‰agmít_âl_ª≠
 (
‰agmít_ma°î
 *
f
)

392 
i
;

393 
i
 = 0; i < 
N_FRAG_BUF
; ++i)

395 
‰agmít
 *
‰ag
 = &
f
->
öcomög
.
‰agmíts
[
i
];

396 i‡(
‰ag
->
deföed
 && føg->
time°amp
 + 
FRAG_TTL_SEC
 <
now
)

398 
	`msg
 (
D_FRAG_ERRORS
, "FRAG TTLÉxpúed i=%d", 
i
);

399 
‰ag
->
deföed
 = 
Ál£
;

402 
	}
}

406 
	$‰agmít_wakeup
 (
‰agmít_ma°î
 *
f
, 
‰ame
 *frame)

409 
	`‰agmít_âl_ª≠
 (
f
);

410 
	}
}

413 
	$dummy
(Ë{
	}
}

	@src/openvpn/fragment.h

25 #i‚de‡
FRAGMENT_H


26 
	#FRAGMENT_H


	)

34 #ifde‡
ENABLE_FRAGMENT


42 
	~"comm⁄.h
"

43 
	~"buf„r.h
"

44 
	~"öãrvÆ.h
"

45 
	~"mtu.h
"

46 
	~"sh≠î.h
"

47 
	~"îr‹.h
"

50 
	#N_FRAG_BUF
 25

	)

55 
	#FRAG_TTL_SEC
 10

	)

58 
	#FRAG_WAKEUP_INTERVAL
 5

	)

66 
	s‰agmít
 {

67 
boﬁ
 
	mdeföed
;

70 
	mmax_‰ag_size
;

72 
	#FRAG_MAP_MASK
 0xFFFFFFFF

	)

74 
	#MAX_FRAGS
 32

	)

75 
	mm≠
;

85 
time_t
 
	mtime°amp
;

87 
buf„r
 
	mbuf
;

96 
	s‰agmít_li°
 {

97 
	m£q_id
;

100 
	mödex
;

115 
‰agmít
 
	m‰agmíts
[
N_FRAG_BUF
];

137 
	s‰agmít_ma°î
 {

138 
evít_timeout
 
	mwakeup
;

141 
boﬁ
 
	mª˚ived_os_mtu_höt
;

143 
	#N_SEQ_ID
 256

	)

147 
	moutgoög_£q_id
;

155 
	#MAX_FRAG_PKT_SIZE
 65536

	)

158 
	moutgoög_‰ag_size
;

170 
	moutgoög_‰ag_id
;

173 
buf„r
 
	moutgoög
;

175 
buf„r
 
	moutgoög_ªtu∫
;

180 
‰agmít_li°
 
	möcomög
;

191 
uöt32_t
 
	t‰agmít_hódî_ty≥
;

195 
	#ht⁄_‰agmít_hódî_ty≥
(
x
Ë
	`ht⁄l
(x)

	)

199 
	#¡oh_‰agmít_hódî_ty≥
(
x
Ë
	`¡ohl
(x)

	)

203 
	#FRAG_TYPE_MASK
 0x00000003

	)

205 
	#FRAG_TYPE_SHIFT
 0

	)

207 
	#FRAG_WHOLE
 0

	)

209 
	#FRAG_YES_NOTLAST
 1

	)

212 
	#FRAG_YES_LAST
 2

	)

215 
	#FRAG_TEST
 3

	)

220 
	#FRAG_SEQ_ID_MASK
 0x000000ff

	)

222 
	#FRAG_SEQ_ID_SHIFT
 2

	)

224 
	#FRAG_ID_MASK
 0x0000001f

	)

226 
	#FRAG_ID_SHIFT
 10

	)

238 
	#FRAG_SIZE_MASK
 0x00003fff

	)

240 
	#FRAG_SIZE_SHIFT
 15

	)

242 
	#FRAG_SIZE_ROUND_SHIFT
 2

	)

243 
	#FRAG_SIZE_ROUND_MASK
 ((1 << 
FRAG_SIZE_ROUND_SHIFT
Ë- 1)

	)

251 
	#FRAG_EXTRA_MASK
 0x0000ffff

	)

253 
	#FRAG_EXTRA_SHIFT
 15

	)

274 
‰agmít_ma°î
 *
‰agmít_öô
 (
‰ame
 *frame);

286 
‰agmít_‰ame_öô
 (
‰agmít_ma°î
 *
f
, c⁄° 
‰ame
 *frame);

294 
‰agmít_‰ì
 (
‰agmít_ma°î
 *
f
);

343 
‰agmít_öcomög
 (
‰agmít_ma°î
 *
f
, 
buf„r
 *
buf
,

344 c⁄° 
‰ame
* frame);

394 
‰agmít_outgoög
 (
‰agmít_ma°î
 *
f
, 
buf„r
 *
buf
,

395 c⁄° 
‰ame
* frame);

424 
boﬁ
 
‰agmít_ªady_to_£nd
 (
‰agmít_ma°î
 *
f
, 
buf„r
 *
buf
,

425 c⁄° 
‰ame
* frame);

438 
ölöe
 
boﬁ


439 
	$‰agmít_outgoög_deföed
 (
‰agmít_ma°î
 *
f
)

441  
f
->
outgoög
.
Àn
 > 0;

442 
	}
}

447 
‰agmít_wakeup
 (
‰agmít_ma°î
 *
f
, 
‰ame
 *frame);

465 
ölöe
 

466 
	$‰agmít_hou£kìpög
 (
‰agmít_ma°î
 *
f
, 
‰ame
 *‰ame, 
timevÆ
 *
tv
)

468 i‡(
	`evít_timeout_åiggî
 (&
f
->
wakeup
, 
tv
, 
ETT_DEFAULT
))

469 
	`‰agmít_wakeup
 (
f
, 
‰ame
);

470 
	}
}

	@src/openvpn/gremlin.c

30 #ifde‡
HAVE_CONFIG_H


31 
	~"c⁄fig.h
"

32 #ñi‡
deföed
(
_MSC_VER
)

33 
	~"c⁄fig-msvc.h
"

36 
	~"syshód.h
"

38 #ifde‡
ENABLE_DEBUG


40 
	~"îr‹.h
"

41 
	~"comm⁄.h
"

42 
	~"misc.h
"

43 
	~"Ÿime.h
"

44 
	~"gªmlö.h
"

46 
	~"memdbg.h
"

59 c⁄° 
	gdr›_‰eq
[] = { 500, 100, 50 };

64 c⁄° 
	gc‹ru±_‰eq
[] = { 500, 100, 50 };

70 c⁄° 
	gup_low
[] = { 60, 10, 5 };

71 c⁄° 
	gup_high
[] = { 600, 60, 10 };

77 c⁄° 
	gdown_low
[] = { 5, 10, 10 };

78 c⁄° 
	gdown_high
[] = { 10, 60, 120 };

84 c⁄° 
∑ckë_Êood_∑rms
 
	g∑ckë_Êood_d©a
[] =

87 
∑ckë_Êood_∑rms


88 
	$gë_∑ckë_Êood_∑rms
 (
Àvñ
)

90 
	`ASSERT
 (
Àvñ
 > 0 &&Üevel < 4);

91  
∑ckë_Êood_d©a
 [
Àvñ
 - 1];

92 
	}
}

97 
boﬁ
 
	$Êù
(
n
) {

98  (
	`gë_øndom
(Ë% 
n
) == 0;

99 
	}
}

105 
	$rﬁl
(
low
, 
high
) {

106 
ªt
;

107 
	`ASSERT
 (
low
 <
high
);

108 
ªt
 = 
low
 + (
	`gë_øndom
(Ë% (
high
 -Üow + 1));

109 
	`ASSERT
 (
ªt
 >
low
 &&Ñë <
high
);

110  
ªt
;

111 
	}
}

113 
boﬁ
 
	göôülized
;

114 
boﬁ
 
	gup
;

115 
time_t
 
	g√xt
;

120 
boﬁ


121 
	$ask_gªmlö
 (
Êags
)

123 c⁄° 
up_down_Àvñ
 = 
	`GREMLIN_UP_DOWN_LEVEL
 (
Êags
);

124 c⁄° 
dr›_Àvñ
 = 
	`GREMLIN_DROP_LEVEL
 (
Êags
);

126 i‡(!
öôülized
)

128 
öôülized
 = 
åue
;

130 i‡(
up_down_Àvñ
)

131 
up
 = 
Ál£
;

133 
up
 = 
åue
;

135 
√xt
 = 
now
;

138 i‡(
up_down_Àvñ
)

140 i‡(
now
 >
√xt
)

142 
dñè
;

143 i‡(
up
)

145 
dñè
 = 
	`rﬁl
 (
down_low
[
up_down_Àvñ
-1], 
down_high
[up_down_level-1]);

146 
up
 = 
Ál£
;

150 
dñè
 = 
	`rﬁl
 (
up_low
[
up_down_Àvñ
-1], 
up_high
[up_down_level-1]);

151 
up
 = 
åue
;

154 
	`msg
 (
D_GREMLIN
,

156 (
up
 ? "UP" : "DOWN"),

157 
dñè
);

158 
√xt
 = 
now
 + 
dñè
;

162 i‡(
dr›_Àvñ
)

164 i‡(
up
 && 
	`Êù
 (
dr›_‰eq
[
dr›_Àvñ
-1]))

166 
	`dmsg
 (
D_GREMLIN_VERBOSE
, "GREMLIN: RandomÖacket drop");

167  
Ál£
;

171  
up
;

172 
	}
}

177 
	$c‹ru±_gªmlö
 (
buf„r
 *
buf
, 
Êags
) {

178 c⁄° 
c‹ru±_Àvñ
 = 
	`GREMLIN_CORRUPT_LEVEL
 (
Êags
);

179 i‡(
c‹ru±_Àvñ
)

181 i‡(
	`Êù
 (
c‹ru±_‰eq
[
c‹ru±_Àvñ
-1]))

185 i‡(
buf
->
Àn
 > 0)

187 
uöt8_t
 
r
 = 
	`rﬁl
 (0, 255);

188 
mëhod
 = 
	`rﬁl
 (0, 5);

190 
mëhod
) {

192 *
	`BPTR
 (
buf
Ë
r
;

195 *(
	`BPTR
 (
buf
Ë+ buf->
Àn
 - 1Ë
r
;

198 *(
	`BPTR
(
buf
Ë+ 
	`rﬁl
 (0, buf->
Àn
 - 1)Ë
r
;

201 
	`buf_wrôe
 (
buf
, &
r
, 1);

204 --
buf
->
Àn
;

207 
buf
->
Àn
 -
	`rﬁl
 (0, buf->len - 1);

210 
	`dmsg
 (
D_GREMLIN_VERBOSE
, "GREMLIN: Packë C‹ru±i⁄, mëhod=%d", 
mëhod
);

214 } 
	`Êù
 (2));

217 
	}
}

220 
	$dummy
(Ë{
	}
}

	@src/openvpn/gremlin.h

25 #i‚de‡
GREMLIN_H


26 
	#GREMLIN_H


	)

28 #ifde‡
ENABLE_DEBUG


34 
	#GREMLIN_CONNECTION_FLOOD_SHIFT
 (0)

	)

35 
	#GREMLIN_CONNECTION_FLOOD_MASK
 (0x07)

	)

37 
	#GREMLIN_PACKET_FLOOD_SHIFT
 (3)

	)

38 
	#GREMLIN_PACKET_FLOOD_MASK
 (0x03)

	)

40 
	#GREMLIN_CORRUPT_SHIFT
 (5)

	)

41 
	#GREMLIN_CORRUPT_MASK
 (0x03)

	)

43 
	#GREMLIN_UP_DOWN_SHIFT
 (7)

	)

44 
	#GREMLIN_UP_DOWN_MASK
 (0x03)

	)

48 
	#GREMLIN_DROP_SHIFT
 (9)

	)

49 
	#GREMLIN_DROP_MASK
 (0x03)

	)

53 
	#GREMLIN_CONNECTION_FLOOD_LEVEL
(
x
Ë(((x)>>
GREMLIN_CONNECTION_FLOOD_SHIFT
Ë& 
GREMLIN_CONNECTION_FLOOD_MASK
)

	)

54 
	#GREMLIN_PACKET_FLOOD_LEVEL
(
x
Ë(((x)>>
GREMLIN_PACKET_FLOOD_SHIFT
Ë& 
GREMLIN_PACKET_FLOOD_MASK
)

	)

55 
	#GREMLIN_CORRUPT_LEVEL
(
x
Ë(((x)>>
GREMLIN_CORRUPT_SHIFT
Ë& 
GREMLIN_CORRUPT_MASK
)

	)

56 
	#GREMLIN_UP_DOWN_LEVEL
(
x
Ë(((x)>>
GREMLIN_UP_DOWN_SHIFT
Ë& 
GREMLIN_UP_DOWN_MASK
)

	)

57 
	#GREMLIN_DROP_LEVEL
(
x
Ë(((x)>>
GREMLIN_DROP_SHIFT
Ë& 
GREMLIN_DROP_MASK
)

	)

59 
	~"buf„r.h
"

61 
	s∑ckë_Êood_∑rms


63 
	mn_∑ckës
;

64 
	m∑ckë_size
;

67 
boﬁ
 
ask_gªmlö
 (
Êags
);

68 
c‹ru±_gªmlö
 (
buf„r
* 
buf
, 
Êags
);

69 
∑ckë_Êood_∑rms
 
gë_∑ckë_Êood_∑rms
 (
Àvñ
);

	@src/openvpn/helper.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"f‹w¨d.h
"

34 
	~"hñ≥r.h
"

35 
	~"poﬁ.h
"

36 
	~"push.h
"

38 
	~"memdbg.h
"

40 #i‡
P2MP_SERVER


43 
	$¥öt_√tmask
 (
√tbôs
, 
gc_¨ía
 *
gc
)

45 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (128, 
gc
);

46 c⁄° 
ö_addr_t
 
√tmask
 = 
	`√tbôs_to_√tmask
 (
√tbôs
);

48 
	`buf_¥ötf
 (&
out
, "%†(/%d)", 
	`¥öt_ö_addr_t
 (
√tmask
, 0, 
gc
), 
√tbôs
);

50  
	`BSTR
 (&
out
);

51 
	}
}

54 
	$¥öt_›t_rouã_g©eway
 (c⁄° 
ö_addr_t
 
rouã_g©eway
, 
gc_¨ía
 *
gc
)

56 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (128, 
gc
);

57 
	`ASSERT
 (
rouã_g©eway
);

58 
	`buf_¥ötf
 (&
out
, "rouã-g©eway %s", 
	`¥öt_ö_addr_t
 (
rouã_g©eway
, 0, 
gc
));

59  
	`BSTR
 (&
out
);

60 
	}
}

63 
	$¥öt_›t_rouã_g©eway_dh˝
 (
gc_¨ía
 *
gc
)

65 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (32, 
gc
);

66 
	`buf_¥ötf
 (&
out
, "route-gateway dhcp");

67  
	`BSTR
 (&
out
);

68 
	}
}

71 
	$¥öt_›t_rouã
 (c⁄° 
ö_addr_t
 
√tw‹k
, c⁄° in_addr_à
√tmask
, 
gc_¨ía
 *
gc
)

73 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (128, 
gc
);

74 
	`ASSERT
 (
√tw‹k
);

76 i‡(
√tmask
)

77 
	`buf_¥ötf
 (&
out
, "route %s %s",

78 
	`¥öt_ö_addr_t
 (
√tw‹k
, 0, 
gc
),

79 
	`¥öt_ö_addr_t
 (
√tmask
, 0, 
gc
));

81 
	`buf_¥ötf
 (&
out
, "route %s",

82 
	`¥öt_ö_addr_t
 (
√tw‹k
, 0, 
gc
));

84  
	`BSTR
 (&
out
);

85 
	}
}

88 
	$¥öt_›t_t›ﬁogy
 (c⁄° 
t›ﬁogy
, 
gc_¨ía
 *
gc
)

90 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (128, 
gc
);

92 
	`buf_¥ötf
 (&
out
, "t›ﬁogy %s", 
	`¥öt_t›ﬁogy
 (
t›ﬁogy
));

94  
	`BSTR
 (&
out
);

95 
	}
}

98 
	$¥öt_°r_öt
 (c⁄° *
°r
, c⁄° 
i
, 
gc_¨ía
 *
gc
)

100 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (128, 
gc
);

101 
	`buf_¥ötf
 (&
out
, "%†%d", 
°r
, 
i
);

102  
	`BSTR
 (&
out
);

103 
	}
}

106 
	$¥öt_°r
 (c⁄° *
°r
, 
gc_¨ía
 *
gc
)

108 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (128, 
gc
);

109 
	`buf_¥ötf
 (&
out
, "%s", 
°r
);

110  
	`BSTR
 (&
out
);

111 
	}
}

114 
	$hñ≥r_add_rouã
 (c⁄° 
ö_addr_t
 
√tw‹k
, c⁄° in_addr_à
√tmask
, 
›ti⁄s
 *
o
)

116 
	`rﬁ_check_Æloc
 (
o
);

117 
	`add_rouã_to_›ti⁄_li°
 (
o
->
rouãs
,

118 
	`¥öt_ö_addr_t
 (
√tw‹k
, 0, &
o
->
gc
),

119 
	`¥öt_ö_addr_t
 (
√tmask
, 0, &
o
->
gc
),

120 
NULL
,

121 
NULL
);

122 
	}
}

125 
	$vîify_comm⁄_sub√t
 (c⁄° *
›t
, c⁄° 
ö_addr_t
 
a
, c⁄° in_addr_à
b
, c⁄° in_addr_à
sub√t
)

127 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

128 i‡((
a
 & 
sub√t
Ë!(
b
 & subnet))

129 
	`msg
 (
M_USAGE
, "%s IPáddresses %sánd %sáreÇot inÅhe same %s subnet",

130 
›t
,

131 
	`¥öt_ö_addr_t
 (
a
, 0, &
gc
),

132 
	`¥öt_ö_addr_t
 (
b
, 0, &
gc
),

133 
	`¥öt_ö_addr_t
 (
sub√t
, 0, &
gc
));

134 
	`gc_‰ì
 (&
gc
);

135 
	}
}

145 
	$hñ≥r_˛õ¡_£rvî
 (
›ti⁄s
 *
o
)

147 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

149 #i‡
P2MP


150 #i‡
P2MP_SERVER


155 c⁄° 
dev
 = 
	`dev_ty≥_íum
 (
o
->dev, o->
dev_ty≥
);

156 c⁄° 
t›ﬁogy
 = 
o
->topology;

173 i‡–
o
->
£rvî_ùv6_deföed
 )

175 i‡–! 
o
->
£rvî_deföed
 )

177 
	`msg
 (
M_USAGE
, "--server-ipv6 must be usedÅogether with --server");

179 i‡–
o
->
£rvî_Êags
 & 
SF_NOPOOL
 )

181 
	`msg
–
M_USAGE
, "--server-ipv6 is incompatible with 'nopool' option" );

183 i‡–
o
->
ifc⁄fig_ùv6_poﬁ_deföed
 )

185 
	`msg
–
M_USAGE
, "--server-ipv6álready definesán ifconfig-ipv6-pool, so you can'tálso specify --ifconfig-poolÉxplicitly");

189 
o
->
ifc⁄fig_ùv6_loˇl
 =

190 
	`¥öt_ö6_addr
–
	`add_ö6_addr
–
o
->
£rvî_√tw‹k_ùv6
, 1), 0, &o->
gc
 );

191 
o
->
ifc⁄fig_ùv6_ªmŸe
 =

192 
	`¥öt_ö6_addr
–
	`add_ö6_addr
–
o
->
£rvî_√tw‹k_ùv6
, 2), 0, &o->
gc
 );

193 
o
->
ifc⁄fig_ùv6_√tbôs
 = o->
£rvî_√tbôs_ùv6
;

196 
	`ASSERT
–
o
->
£rvî_√tbôs_ùv6
 <= 112 );

198 
o
->
ifc⁄fig_ùv6_poﬁ_deföed
 = 
åue
;

199 
o
->
ifc⁄fig_ùv6_poﬁ_ba£
 =

200 
	`add_ö6_addr
–
o
->
£rvî_√tw‹k_ùv6
, 0x1000 );

201 
o
->
ifc⁄fig_ùv6_poﬁ_√tbôs
 = o->
£rvî_√tbôs_ùv6
;

203 
o
->
tun_ùv6
 = 
åue
;

205 
	`push_›ti⁄
–
o
, "tun-ùv6", 
M_USAGE
 );

239 i‡(
o
->
£rvî_deföed
)

241 
√tbôs
 = -2;

242 
boﬁ
 
°©us
 = 
Ál£
;

244 i‡(
o
->
˛õ¡
)

245 
	`msg
 (
M_USAGE
, "--serveránd --client cannot be usedÅogether");

247 i‡(
o
->
£rvî_bridge_deföed
 || o->
£rvî_bridge_¥oxy_dh˝
)

248 
	`msg
 (
M_USAGE
, "--serveránd --server-bridge cannot be usedÅogether");

250 i‡(
o
->
sh¨ed_£¸ë_fûe
)

251 
	`msg
 (
M_USAGE
, "--serveránd --secret cannot be usedÅogether (you must use SSL/TLS keys)");

253 i‡(!(
o
->
£rvî_Êags
 & 
SF_NOPOOL
Ë&& o->
ifc⁄fig_poﬁ_deföed
)

254 
	`msg
 (
M_USAGE
, "--serverálready definesán ifconfig-pool, so you can'tálso specify --ifconfig-poolÉxplicitly");

256 i‡(!(
dev
 =
DEV_TYPE_TAP
 || dev =
DEV_TYPE_TUN
))

257 
	`msg
 (
M_USAGE
, "--server directive only makes sense with --devÅun or --devÅap");

259 
°©us
 = 
	`√tmask_to_√tbôs
 (
o
->
£rvî_√tw‹k
, o->
£rvî_√tmask
, &
√tbôs
);

260 i‡(!
°©us
)

261 
	`msg
 (
M_USAGE
, "--server directiveÇetwork/netmask combination is invalid");

263 i‡(
√tbôs
 < 0)

264 
	`msg
 (
M_USAGE
, "--server directiveÇetmask is invalid");

266 i‡(
√tbôs
 < 
IFCONFIG_POOL_MIN_NETBITS
)

267 
	`msg
 (
M_USAGE
, "--server directiveÇetmaskállows forÅoo many hostáddresses (subnet must be %s or higher)",

268 
	`¥öt_√tmask
 (
IFCONFIG_POOL_MIN_NETBITS
, &
gc
));

270 i‡(
dev
 =
DEV_TYPE_TUN
)

272 
poﬁ_íd_ª£rve
 = 4;

274 i‡(
√tbôs
 > 29)

275 
	`msg
 (
M_USAGE
, "--server directive when used with --devÅun must defineá subnet of %s orÜower",

276 
	`¥öt_√tmask
 (29, &
gc
));

278 i‡(
√tbôs
 == 29)

279 
poﬁ_íd_ª£rve
 = 0;

281 
o
->
mode
 = 
MODE_SERVER
;

282 
o
->
és_£rvî
 = 
åue
;

284 i‡(
t›ﬁogy
 =
TOP_NET30
 ||Å›ﬁogy =
TOP_P2P
)

286 
o
->
ifc⁄fig_loˇl
 = 
	`¥öt_ö_addr_t
 (o->
£rvî_√tw‹k
 + 1, 0, &o->
gc
);

287 
o
->
ifc⁄fig_ªmŸe_√tmask
 = 
	`¥öt_ö_addr_t
 (o->
£rvî_√tw‹k
 + 2, 0, &o->
gc
);

289 i‡(!(
o
->
£rvî_Êags
 & 
SF_NOPOOL
))

291 
o
->
ifc⁄fig_poﬁ_deföed
 = 
åue
;

292 
o
->
ifc⁄fig_poﬁ_°¨t
 = o->
£rvî_√tw‹k
 + 4;

293 
o
->
ifc⁄fig_poﬁ_íd
 = (o->
£rvî_√tw‹k
 | ~o->
£rvî_√tmask
Ë- 
poﬁ_íd_ª£rve
;

294 
	`ifc⁄fig_poﬁ_vîify_ønge
 (
M_USAGE
, 
o
->
ifc⁄fig_poﬁ_°¨t
, o->
ifc⁄fig_poﬁ_íd
);

297 
	`hñ≥r_add_rouã
 (
o
->
£rvî_√tw‹k
, o->
£rvî_√tmask
, o);

298 i‡(
o
->
íabÀ_c2c
)

299 
	`push_›ti⁄
 (
o
, 
	`¥öt_›t_rouã
 (o->
£rvî_√tw‹k
, o->
£rvî_√tmask
, &o->
gc
), 
M_USAGE
);

300 i‡(
t›ﬁogy
 =
TOP_NET30
)

301 
	`push_›ti⁄
 (
o
, 
	`¥öt_›t_rouã
 (o->
£rvî_√tw‹k
 + 1, 0, &o->
gc
), 
M_USAGE
);

303 i‡(
t›ﬁogy
 =
TOP_SUBNET
)

305 
o
->
ifc⁄fig_loˇl
 = 
	`¥öt_ö_addr_t
 (o->
£rvî_√tw‹k
 + 1, 0, &o->
gc
);

306 
o
->
ifc⁄fig_ªmŸe_√tmask
 = 
	`¥öt_ö_addr_t
 (o->
£rvî_√tmask
, 0, &o->
gc
);

308 i‡(!(
o
->
£rvî_Êags
 & 
SF_NOPOOL
))

310 
o
->
ifc⁄fig_poﬁ_deföed
 = 
åue
;

311 
o
->
ifc⁄fig_poﬁ_°¨t
 = o->
£rvî_√tw‹k
 + 2;

312 
o
->
ifc⁄fig_poﬁ_íd
 = (o->
£rvî_√tw‹k
 | ~o->
£rvî_√tmask
) - 2;

313 
	`ifc⁄fig_poﬁ_vîify_ønge
 (
M_USAGE
, 
o
->
ifc⁄fig_poﬁ_°¨t
, o->
ifc⁄fig_poﬁ_íd
);

315 
o
->
ifc⁄fig_poﬁ_√tmask
 = o->
£rvî_√tmask
;

317 
	`push_›ti⁄
 (
o
, 
	`¥öt_›t_rouã_g©eway
 (o->
£rvî_√tw‹k
 + 1, &o->
gc
), 
M_USAGE
);

318 i‡(!
o
->
rouã_deÁu…_g©eway
)

319 
o
->
rouã_deÁu…_g©eway
 = 
	`¥öt_ö_addr_t
 (o->
£rvî_√tw‹k
 + 2, 0, &o->
gc
);

322 
	`ASSERT
 (0);

324 
	`push_›ti⁄
 (
o
, 
	`¥öt_›t_t›ﬁogy
 (
t›ﬁogy
, &o->
gc
), 
M_USAGE
);

326 i‡(
dev
 =
DEV_TYPE_TAP
)

328 i‡(
√tbôs
 > 30)

329 
	`msg
 (
M_USAGE
, "--server directive when used with --devÅap must defineá subnet of %s orÜower",

330 
	`¥öt_√tmask
 (30, &
gc
));

332 
o
->
mode
 = 
MODE_SERVER
;

333 
o
->
és_£rvî
 = 
åue
;

334 
o
->
ifc⁄fig_loˇl
 = 
	`¥öt_ö_addr_t
 (o->
£rvî_√tw‹k
 + 1, 0, &o->
gc
);

335 
o
->
ifc⁄fig_ªmŸe_√tmask
 = 
	`¥öt_ö_addr_t
 (o->
£rvî_√tmask
, 0, &o->
gc
);

337 i‡(!(
o
->
£rvî_Êags
 & 
SF_NOPOOL
))

339 
o
->
ifc⁄fig_poﬁ_deföed
 = 
åue
;

340 
o
->
ifc⁄fig_poﬁ_°¨t
 = o->
£rvî_√tw‹k
 + 2;

341 
o
->
ifc⁄fig_poﬁ_íd
 = (o->
£rvî_√tw‹k
 | ~o->
£rvî_√tmask
) - 1;

342 
	`ifc⁄fig_poﬁ_vîify_ønge
 (
M_USAGE
, 
o
->
ifc⁄fig_poﬁ_°¨t
, o->
ifc⁄fig_poﬁ_íd
);

344 
o
->
ifc⁄fig_poﬁ_√tmask
 = o->
£rvî_√tmask
;

346 
	`push_›ti⁄
 (
o
, 
	`¥öt_›t_rouã_g©eway
 (o->
£rvî_√tw‹k
 + 1, &o->
gc
), 
M_USAGE
);

350 
	`ASSERT
 (0);

354 i‡((
dev
 =
DEV_TYPE_TAP
 || 
t›ﬁogy
 =
TOP_SUBNET
))

356 
o
->
push_ifc⁄fig_c⁄°øöt_deföed
 = 
åue
;

357 
o
->
push_ifc⁄fig_c⁄°øöt_√tw‹k
 = o->
£rvî_√tw‹k
;

358 
o
->
push_ifc⁄fig_c⁄°øöt_√tmask
 = o->
£rvî_√tmask
;

387 i‡(
o
->
£rvî_bridge_deföed
 | o->
£rvî_bridge_¥oxy_dh˝
)

389 i‡(
o
->
˛õ¡
)

390 
	`msg
 (
M_USAGE
, "--server-bridgeánd --client cannot be usedÅogether");

392 i‡(!(
o
->
£rvî_Êags
 & 
SF_NOPOOL
Ë&& o->
ifc⁄fig_poﬁ_deföed
)

393 
	`msg
 (
M_USAGE
, "--server-bridgeálready definesán ifconfig-pool, so you can'tálso specify --ifconfig-poolÉxplicitly");

395 i‡(
o
->
sh¨ed_£¸ë_fûe
)

396 
	`msg
 (
M_USAGE
, "--server-bridgeánd --secret cannot be usedÅogether (you must use SSL/TLS keys)");

398 i‡(
dev
 !
DEV_TYPE_TAP
)

399 
	`msg
 (
M_USAGE
, "--server-bridge directive only makes sense with --devÅap");

401 i‡(
o
->
£rvî_bridge_deföed
)

403 
	`vîify_comm⁄_sub√t
 ("--£rvî-bridge", 
o
->
£rvî_bridge_ù
, o->
£rvî_bridge_poﬁ_°¨t
, o->
£rvî_bridge_√tmask
);

404 
	`vîify_comm⁄_sub√t
 ("--£rvî-bridge", 
o
->
£rvî_bridge_poﬁ_°¨t
, o->
£rvî_bridge_poﬁ_íd
, o->
£rvî_bridge_√tmask
);

405 
	`vîify_comm⁄_sub√t
 ("--£rvî-bridge", 
o
->
£rvî_bridge_ù
, o->
£rvî_bridge_poﬁ_íd
, o->
£rvî_bridge_√tmask
);

408 
o
->
mode
 = 
MODE_SERVER
;

409 
o
->
és_£rvî
 = 
åue
;

411 i‡(
o
->
£rvî_bridge_deföed
)

413 
o
->
ifc⁄fig_poﬁ_deföed
 = 
åue
;

414 
o
->
ifc⁄fig_poﬁ_°¨t
 = o->
£rvî_bridge_poﬁ_°¨t
;

415 
o
->
ifc⁄fig_poﬁ_íd
 = o->
£rvî_bridge_poﬁ_íd
;

416 
	`ifc⁄fig_poﬁ_vîify_ønge
 (
M_USAGE
, 
o
->
ifc⁄fig_poﬁ_°¨t
, o->
ifc⁄fig_poﬁ_íd
);

417 
o
->
ifc⁄fig_poﬁ_√tmask
 = o->
£rvî_bridge_√tmask
;

418 
	`push_›ti⁄
 (
o
, 
	`¥öt_›t_rouã_g©eway
 (o->
£rvî_bridge_ù
, &o->
gc
), 
M_USAGE
);

420 i‡(
o
->
£rvî_bridge_¥oxy_dh˝
 && !(o->
£rvî_Êags
 & 
SF_NO_PUSH_ROUTE_GATEWAY
))

422 
	`push_›ti⁄
 (
o
, 
	`¥öt_›t_rouã_g©eway_dh˝
 (&o->
gc
), 
M_USAGE
);

438 i‡(
o
->
˛õ¡
)

440 i‡(
o
->
key_mëhod
 != 2)

441 
	`msg
 (
M_USAGE
, "--clientÑequires --key-method 2");

443 
o
->
puŒ
 = 
åue
;

444 
o
->
és_˛õ¡
 = 
åue
;

449 
	`gc_‰ì
 (&
gc
);

450 
	}
}

470 
	$hñ≥r_kì∑live
 (
›ti⁄s
 *
o
)

472 i‡(
o
->
kì∑live_pög
 || o->
kì∑live_timeout
)

477 i‡(
o
->
kì∑live_pög
 <0 || o->
kì∑live_timeout
 <= 0)

478 
	`msg
 (
M_USAGE
, "--keepaliveÖarameters must be > 0");

479 i‡(
o
->
kì∑live_pög
 * 2 > o->
kì∑live_timeout
)

480 
	`msg
 (
M_USAGE
, "the secondÖarameterÅo --keepalive (restartÅimeout=%d) must beátÜeastÅwiceÅhe value ofÅhe firstÖarameter (ping interval=%d). AÑatio of 1:5 or 1:6 would beÉven better. Recommended setting is --keepalive 10 60.",

481 
o
->
kì∑live_timeout
,

482 
o
->
kì∑live_pög
);

483 i‡(
o
->
pög_£nd_timeout
 || o->
pög_ªc_timeout
)

484 
	`msg
 (
M_USAGE
, "--keepalive conflicts with --ping, --ping-exit, or --ping-restart. If you use --keepalive, you don'tÇeedány ofÅhe other --ping directives.");

489 i‡(
o
->
mode
 =
MODE_POINT_TO_POINT
)

491 
o
->
pög_ªc_timeout_a˘i⁄
 = 
PING_RESTART
;

492 
o
->
pög_£nd_timeout
 = o->
kì∑live_pög
;

493 
o
->
pög_ªc_timeout
 = o->
kì∑live_timeout
;

495 #i‡
P2MP_SERVER


496 i‡(
o
->
mode
 =
MODE_SERVER
)

498 
o
->
pög_ªc_timeout_a˘i⁄
 = 
PING_RESTART
;

499 
o
->
pög_£nd_timeout
 = o->
kì∑live_pög
;

500 
o
->
pög_ªc_timeout
 = o->
kì∑live_timeout
 * 2;

501 
	`push_›ti⁄
 (
o
, 
	`¥öt_°r_öt
 ("pög", o->
kì∑live_pög
, &o->
gc
), 
M_USAGE
);

502 
	`push_›ti⁄
 (
o
, 
	`¥öt_°r_öt
 ("pög-ª°¨t", o->
kì∑live_timeout
, &o->
gc
), 
M_USAGE
);

507 
	`ASSERT
 (0);

510 
	}
}

525 
	$hñ≥r_t˝_nodñay
 (
›ti⁄s
 *
o
)

527 #i‡
P2MP_SERVER


528 i‡(
o
->
£rvî_Êags
 & 
SF_TCP_NODELAY_HELPER
)

530 i‡(
o
->
mode
 =
MODE_SERVER
)

532 
o
->
sockÊags
 |
SF_TCP_NODELAY
;

533 
	`push_›ti⁄
 (
o
, 
	`¥öt_°r
 ("sockë-Êag†TCP_NODELAY", &o->
gc
), 
M_USAGE
);

537 
	`ASSERT
 (0);

541 
	}
}

	@src/openvpn/helper.h

29 #i‚de‡
HELPER_H


30 
	#HELPER_H


	)

32 
	~"›ti⁄s.h
"

34 
hñ≥r_kì∑live
 (
›ti⁄s
 *
o
);

35 
hñ≥r_˛õ¡_£rvî
 (
›ti⁄s
 *
o
);

36 
hñ≥r_t˝_nodñay
 (
›ti⁄s
 *
o
);

	@src/openvpn/httpdigest.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #i‡
PROXY_DIGEST_AUTH


35 
	~"¸y±o.h
"

36 
	~"hâpdige°.h
"

39 
	$CvtHex
(

40 
IN
 
HASH
 
Bö
,

41 
OUT
 
HASHHEX
 
Hex


44 
i
;

45 
j
;

47 
i
 = 0; i < 
HASHLEN
; i++) {

48 
j
 = (
Bö
[
i
] >> 4) & 0xf;

49 i‡(
j
 <= 9)

50 
Hex
[
i
*2] = (
j
 + '0');

52 
Hex
[
i
*2] = (
j
 + 'a' - 10);

53 
j
 = 
Bö
[
i
] & 0xf;

54 i‡(
j
 <= 9)

55 
Hex
[
i
*2+1] = (
j
 + '0');

57 
Hex
[
i
*2+1] = (
j
 + 'a' - 10);

59 
Hex
[
HASHHEXLEN
] = '\0';

60 
	}
};

64 
	$Dige°CÆcHA1
(

65 
IN
 * 
pszAlg
,

66 
IN
 * 
pszU£rName
,

67 
IN
 * 
pszRólm
,

68 
IN
 * 
pszPassw‹d
,

69 
IN
 * 
pszN⁄˚
,

70 
IN
 * 
pszCN⁄˚
,

71 
OUT
 
HASHHEX
 
Sessi⁄Key


74 
HASH
 
HA1
;

75 
md_˘x_t
 
md5_˘x
;

76 c⁄° 
md_kt_t
 *
md5_kt
 = 
	`md_kt_gë
("MD5");

78 
	`md_˘x_öô
(&
md5_˘x
, 
md5_kt
);

79 
	`md_˘x_upd©e
(&
md5_˘x
, 
pszU£rName
, 
	`°æí
(pszUserName));

80 
	`md_˘x_upd©e
(&
md5_˘x
, ":", 1);

81 
	`md_˘x_upd©e
(&
md5_˘x
, 
pszRólm
, 
	`°æí
(pszRealm));

82 
	`md_˘x_upd©e
(&
md5_˘x
, ":", 1);

83 
	`md_˘x_upd©e
(&
md5_˘x
, 
pszPassw‹d
, 
	`°æí
(pszPassword));

84 
	`md_˘x_föÆ
(&
md5_˘x
, 
HA1
);

85 i‡(
pszAlg
 && 
	`°rˇ£cmp
(pszAlg, "md5-sess") == 0)

87 
	`md_˘x_öô
(&
md5_˘x
, 
md5_kt
);

88 
	`md_˘x_upd©e
(&
md5_˘x
, 
HA1
, 
HASHLEN
);

89 
	`md_˘x_upd©e
(&
md5_˘x
, ":", 1);

90 
	`md_˘x_upd©e
(&
md5_˘x
, 
pszN⁄˚
, 
	`°æí
(pszNonce));

91 
	`md_˘x_upd©e
(&
md5_˘x
, ":", 1);

92 
	`md_˘x_upd©e
(&
md5_˘x
, 
pszCN⁄˚
, 
	`°æí
(pszCNonce));

93 
	`md_˘x_föÆ
(&
md5_˘x
, 
HA1
);

95 
	`md_˘x_˛ónup
(&
md5_˘x
);

96 
	`CvtHex
(
HA1
, 
Sessi⁄Key
);

97 
	}
}

101 
	$Dige°CÆcRe•⁄£
(

102 
IN
 
HASHHEX
 
HA1
,

103 
IN
 * 
pszN⁄˚
,

104 
IN
 * 
pszN⁄˚Cou¡
,

105 
IN
 * 
pszCN⁄˚
,

106 
IN
 * 
pszQ›
,

107 
IN
 * 
pszMëhod
,

108 
IN
 * 
pszDige°Uri
,

109 
IN
 
HASHHEX
 
HE¡ôy
,

110 
OUT
 
HASHHEX
 
Re•⁄£


113 
HASH
 
HA2
;

114 
HASH
 
Re•Hash
;

115 
HASHHEX
 
HA2Hex
;

117 
md_˘x_t
 
md5_˘x
;

118 c⁄° 
md_kt_t
 *
md5_kt
 = 
	`md_kt_gë
("MD5");

121 
	`md_˘x_öô
(&
md5_˘x
, 
md5_kt
);

122 
	`md_˘x_upd©e
(&
md5_˘x
, 
pszMëhod
, 
	`°æí
(pszMethod));

123 
	`md_˘x_upd©e
(&
md5_˘x
, ":", 1);

124 
	`md_˘x_upd©e
(&
md5_˘x
, 
pszDige°Uri
, 
	`°æí
(pszDigestUri));

125 i‡(
	`°rˇ£cmp
(
pszQ›
, "auth-int") == 0)

127 
	`md_˘x_upd©e
(&
md5_˘x
, ":", 1);

128 
	`md_˘x_upd©e
(&
md5_˘x
, 
HE¡ôy
, 
HASHHEXLEN
);

130 
	`md_˘x_föÆ
(&
md5_˘x
, 
HA2
);

131 
	`CvtHex
(
HA2
, 
HA2Hex
);

134 
	`md_˘x_öô
(&
md5_˘x
, 
md5_kt
);

135 
	`md_˘x_upd©e
(&
md5_˘x
, 
HA1
, 
HASHHEXLEN
);

136 
	`md_˘x_upd©e
(&
md5_˘x
, ":", 1);

137 
	`md_˘x_upd©e
(&
md5_˘x
, 
pszN⁄˚
, 
	`°æí
(pszNonce));

138 
	`md_˘x_upd©e
(&
md5_˘x
, ":", 1);

139 i‡(*
pszQ›
)

141 
	`md_˘x_upd©e
(&
md5_˘x
, 
pszN⁄˚Cou¡
, 
	`°æí
(pszNonceCount));

142 
	`md_˘x_upd©e
(&
md5_˘x
, ":", 1);

143 
	`md_˘x_upd©e
(&
md5_˘x
, 
pszCN⁄˚
, 
	`°æí
(pszCNonce));

144 
	`md_˘x_upd©e
(&
md5_˘x
, ":", 1);

145 
	`md_˘x_upd©e
(&
md5_˘x
, 
pszQ›
, 
	`°æí
(pszQop));

146 
	`md_˘x_upd©e
(&
md5_˘x
, ":", 1);

148 
	`md_˘x_upd©e
(&
md5_˘x
, 
HA2Hex
, 
HASHHEXLEN
);

149 
	`md_˘x_föÆ
(&
md5_˘x
, 
Re•Hash
);

150 
	`md_˘x_˛ónup
(&
md5_˘x
);

151 
	`CvtHex
(
Re•Hash
, 
Re•⁄£
);

152 
	}
}

	@src/openvpn/httpdigest.h

25 #i‡
PROXY_DIGEST_AUTH


27 
	#HASHLEN
 16

	)

28 
	tHASH
[
HASHLEN
];

29 
	#HASHHEXLEN
 32

	)

30 
	tHASHHEX
[
HASHHEXLEN
+1];

31 #unde‡
IN


32 #unde‡
OUT


33 
	#IN
 c⁄°

	)

34 
	#OUT


	)

37 
Dige°CÆcHA1
(

38 
IN
 * 
pszAlg
,

39 
IN
 * 
pszU£rName
,

40 
IN
 * 
pszRólm
,

41 
IN
 * 
pszPassw‹d
,

42 
IN
 * 
pszN⁄˚
,

43 
IN
 * 
pszCN⁄˚
,

44 
OUT
 
HASHHEX
 
Sessi⁄Key


48 
Dige°CÆcRe•⁄£
(

49 
IN
 
HASHHEX
 
HA1
,

50 
IN
 * 
pszN⁄˚
,

51 
IN
 * 
pszN⁄˚Cou¡
,

52 
IN
 * 
pszCN⁄˚
,

53 
IN
 * 
pszQ›
,

54 
IN
 * 
pszMëhod
,

55 
IN
 * 
pszDige°Uri
,

56 
IN
 
HASHHEX
 
HE¡ôy
,

57 
OUT
 
HASHHEX
 
Re•⁄£


	@src/openvpn/init.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"wö32.h
"

34 
	~"öô.h
"

35 
	~"sig.h
"

36 
	~"occ.h
"

37 
	~"li°.h
"

38 
	~"Ÿime.h
"

39 
	~"poﬁ.h
"

40 
	~"gªmlö.h
"

41 
	~"pkcs11.h
"

42 
	~"ps.h
"

43 
	~"Œaddr.h
"

44 
	~"pög.h
"

45 
	~"m°©s.h
"

47 
	~"memdbg.h
"

49 
	~"occ-ölöe.h
"

51 
c⁄ãxt
 *
	g°©ic_c⁄ãxt
;

56 
	#CF_LOAD_PERSISTED_PACKET_ID
 (1<<0)

	)

57 
	#CF_INIT_TLS_MULTI
 (1<<1)

	)

58 
	#CF_INIT_TLS_AUTH_STANDALONE
 (1<<2)

	)

60 
do_öô_fú°_time
 (
c⁄ãxt
 *
c
);

63 
	$c⁄ãxt_˛ór
 (
c⁄ãxt
 *
c
)

65 
	`CLEAR
 (*
c
);

66 
	}
}

69 
	$c⁄ãxt_˛ór_1
 (
c⁄ãxt
 *
c
)

71 
	`CLEAR
 (
c
->
c1
);

72 
	}
}

75 
	$c⁄ãxt_˛ór_2
 (
c⁄ãxt
 *
c
)

77 
	`CLEAR
 (
c
->
c2
);

78 
	}
}

81 
	$c⁄ãxt_˛ór_Æl_ex˚±_fú°_time
 (
c⁄ãxt
 *
c
)

83 c⁄° 
boﬁ
 
fú°_time_ßve
 = 
c
->
fú°_time
;

84 c⁄° 
c⁄ãxt_≥rsi°
 
˝ßve
 = 
c
->
≥rsi°
;

85 
	`c⁄ãxt_˛ór
 (
c
);

86 
c
->
fú°_time
 = 
fú°_time_ßve
;

87 
c
->
≥rsi°
 = 
˝ßve
;

88 
	}
}

95 
	$upd©e_›ti⁄s_˚_po°
 (
›ti⁄s
 *options)

97 #i‡
P2MP


104 i‡(
›ti⁄s
->
puŒ


105 && 
›ti⁄s
->
pög_ªc_timeout_a˘i⁄
 =
PING_UNDEF


106 && 
	`¥Ÿo_is_dgøm
(
›ti⁄s
->
˚
.
¥Ÿo
))

108 
›ti⁄s
->
pög_ªc_timeout
 = 
PRE_PULL_INITIAL_PING_RESTART
;

109 
›ti⁄s
->
pög_ªc_timeout_a˘i⁄
 = 
PING_RESTART
;

112 
	}
}

114 #ifde‡
ENABLE_MANAGEMENT


115 
boﬁ


116 
	$m™agemít_ˇŒback_¥oxy_cmd
 (*
¨g
, c⁄° **
p
)

118 
c⁄ãxt
 *
c
 = 
¨g
;

119 
c⁄√˘i⁄_íåy
 *
˚
 = &
c
->
›ti⁄s
.ce;

120 
gc_¨ía
 *
gc
 = &
c
->
c2
.gc;

121 
boﬁ
 
ªt
 = 
Ál£
;

123 
	`upd©e_time
();

124 i‡(
	`°ªq
 (
p
[1], "NONE"))

125 
ªt
 = 
åue
;

126 i‡(
p
[2] &&Ö[3])

128 c⁄° 
p‹t
 = 
	`©oi
(
p
[3]);

129 i‡(!
	`ÀgÆ_ùv4_p‹t
 (
p‹t
))

131 
	`msg
 (
M_WARN
, "BadÖroxyÖ‹ànumbî: %s", 
p
[3]);

132  
Ál£
;

135 i‡(
	`°ªq
 (
p
[1], "HTTP"))

137 #i‚de‡
ENABLE_HTTP_PROXY


138 
	`msg
 (
M_WARN
, "HTTPÖroxy support isÇotávailable");

140 
hâp_¥oxy_›ti⁄s
 *
ho
;

141 i‡(
˚
->
¥Ÿo
 !
PROTO_TCPv4
 && ce->¥Ÿÿ!
PROTO_TCPv4_CLIENT
 &&

142 
˚
->
¥Ÿo
 !
PROTO_TCPv6
 && ce->¥Ÿÿ!
PROTO_TCPv6_CLIENT
)

144 
	`msg
 (
M_WARN
, "HTTPÖroxy support only works for TCP based connections");

145  
Ál£
;

147 
ho
 = 
	`öô_hâp_¥oxy_›ti⁄s_⁄˚
 (&
˚
->
hâp_¥oxy_›ti⁄s
, 
gc
);

148 
ho
->
£rvî
 = 
	`°rög_Æloc
 (
p
[2], 
gc
);

149 
ho
->
p‹t
 =Öort;

150 
ho
->
ªåy
 = 
åue
;

151 
ho
->
auth_ªåy
 = (
p
[4] && 
	`°ªq
 (p[4], "n˘"Ë? 
PAR_NCT
 : 
PAR_ALL
);

152 
ªt
 = 
åue
;

155 i‡(
	`°ªq
 (
p
[1], "SOCKS"))

157 #i‚de‡
ENABLE_SOCKS


158 
	`msg
 (
M_WARN
, "SOCKSÖroxy support isÇotávailable");

160 
˚
->
socks_¥oxy_£rvî
 = 
	`°rög_Æloc
 (
p
[2], 
gc
);

161 
˚
->
socks_¥oxy_p‹t
 = 
p‹t
;

162 
ªt
 = 
åue
;

167 
	`msg
 (
M_WARN
, "BadÖroxy command");

169 
˚
->
Êags
 &~
CE_MAN_QUERY_PROXY
;

171  
ªt
;

172 
	}
}

174 
boﬁ


175 
	$˚_m™agemít_quîy_¥oxy
 (
c⁄ãxt
 *
c
)

177 c⁄° 
c⁄√˘i⁄_li°
 *
l
 = 
c
->
›ti⁄s
.connection_list;

178 
c⁄√˘i⁄_íåy
 *
˚
 = &
c
->
›ti⁄s
.ce;

179 
gc_¨ía
 
gc
;

180 
boﬁ
 
ªt
 = 
åue
;

182 
	`upd©e_time
();

183 i‡(
m™agemít
)

185 
gc
 = 
	`gc_√w
 ();

187 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, &
gc
);

188 
	`buf_¥ötf
 (&
out
, ">PROXY:%u,%s,%s", (
l
 ?Ü->
cuºít
 : 0) + 1,

189 (
	`¥Ÿo_is_udp
 (
˚
->
¥Ÿo
Ë? "UDP" : "TCP"), 
	`≈
 (˚->
ªmŸe
));

190 
	`m™agemít_nŸify_gíîic
 (
m™agemít
, 
	`BSTR
 (&
out
));

192 
˚
->
Êags
 |
CE_MAN_QUERY_PROXY
;

193 
˚
->
Êags
 & 
CE_MAN_QUERY_PROXY
)

195 
	`m™agemít_evít_lo›_n_£c⁄ds
 (
m™agemít
, 1);

196 i‡(
	`IS_SIG
 (
c
))

198 
ªt
 = 
Ál£
;

202 
	`gc_‰ì
 (&
gc
);

205  
ªt
;

206 
	}
}

209 
boﬁ


210 
	$m™agemít_ˇŒback_ªmŸe_cmd
 (*
¨g
, c⁄° **
p
)

212 
c⁄ãxt
 *
c
 = (c⁄ãxà*Ë
¨g
;

213 
c⁄√˘i⁄_íåy
 *
˚
 = &
c
->
›ti⁄s
.ce;

214 
ªt
 = 
Ál£
;

215 i‡(
p
[1] && ((
˚
->
Êags
>>
CE_MAN_QUERY_REMOTE_SHIFT
)&
CE_MAN_QUERY_REMOTE_MASK
Ë=
CE_MAN_QUERY_REMOTE_QUERY
)

217 
Êags
 = 0;

218 i‡(!
	`°rcmp
(
p
[1], "ACCEPT"))

220 
Êags
 = 
CE_MAN_QUERY_REMOTE_ACCEPT
;

221 
ªt
 = 
åue
;

223 i‡(!
	`°rcmp
(
p
[1], "SKIP"))

225 
Êags
 = 
CE_MAN_QUERY_REMOTE_SKIP
;

226 
ªt
 = 
åue
;

228 i‡(!
	`°rcmp
(
p
[1], "MOD") &&Ö[2] &&Ö[3])

230 c⁄° 
p‹t
 = 
	`©oi
(
p
[3]);

231 i‡(
	`°æí
(
p
[2]Ë< 
RH_HOST_LEN
 && 
	`ÀgÆ_ùv4_p‹t
(
p‹t
))

233 
ªmŸe_ho°_°‹e
 *
rhs
 = 
c
->
›ti⁄s
.
rh_°‹e
;

234 i‡(!
rhs
)

236 
	`ALLOC_OBJ_CLEAR_GC
 (
rhs
, 
ªmŸe_ho°_°‹e
, &
c
->
›ti⁄s
.
gc
);

237 
c
->
›ti⁄s
.
rh_°‹e
 = 
rhs
;

239 
	`°∫˝y¡
(
rhs
->
ho°
, 
p
[2], 
RH_HOST_LEN
);

240 
˚
->
ªmŸe
 = 
rhs
->
ho°
;

241 
˚
->
ªmŸe_p‹t
 = 
p‹t
;

242 
Êags
 = 
CE_MAN_QUERY_REMOTE_MOD
;

243 
ªt
 = 
åue
;

246 i‡(
ªt
)

248 
˚
->
Êags
 &~(
CE_MAN_QUERY_REMOTE_MASK
<<
CE_MAN_QUERY_REMOTE_SHIFT
);

249 
˚
->
Êags
 |((Êags&
CE_MAN_QUERY_REMOTE_MASK
)<<
CE_MAN_QUERY_REMOTE_SHIFT
);

252  
ªt
;

253 
	}
}

255 
boﬁ


256 
	$˚_m™agemít_quîy_ªmŸe
 (
c⁄ãxt
 *
c
, c⁄° *
ªmŸe_ù_höt
)

258 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

259 vﬁ©ûê
c⁄√˘i⁄_íåy
 *
˚
 = &
c
->
›ti⁄s
.ce;

260 
ªt
 = 
åue
;

261 
	`upd©e_time
();

262 i‡(
m™agemít
)

264 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, &
gc
);

265 
	`buf_¥ötf
 (&
out
, ">REMOTE:%s,%d,%s", 
	`≈
(
˚
->
ªmŸe
), ce->
ªmŸe_p‹t
, 
	`¥Ÿo2ascii
(˚->
¥Ÿo
, 
Ál£
));

266 
	`m™agemít_nŸify_gíîic
(
m™agemít
, 
	`BSTR
 (&
out
));

267 
˚
->
Êags
 &~(
CE_MAN_QUERY_REMOTE_MASK
<<
CE_MAN_QUERY_REMOTE_SHIFT
);

268 
˚
->
Êags
 |(
CE_MAN_QUERY_REMOTE_QUERY
<<
CE_MAN_QUERY_REMOTE_SHIFT
);

269 ((
˚
->
Êags
>>
CE_MAN_QUERY_REMOTE_SHIFT
Ë& 
CE_MAN_QUERY_REMOTE_MASK
Ë=
CE_MAN_QUERY_REMOTE_QUERY
)

271 
	`m™agemít_evít_lo›_n_£c⁄ds
 (
m™agemít
, 1);

272 i‡(
	`IS_SIG
 (
c
))

274 
ªt
 = 
Ál£
;

280 c⁄° 
Êags
 = ((
˚
->Êags>>
CE_MAN_QUERY_REMOTE_SHIFT
Ë& 
CE_MAN_QUERY_REMOTE_MASK
);

281 i‡(
Êags
 =
CE_MAN_QUERY_REMOTE_ACCEPT
 && 
ªmŸe_ù_höt
)

282 
˚
->
ªmŸe
 = 
ªmŸe_ù_höt
;

283 
ªt
 = (
Êags
 !
CE_MAN_QUERY_REMOTE_SKIP
);

285 
	`gc_‰ì
 (&
gc
);

286  
ªt
;

287 
	}
}

294 
	$öô_c⁄√˘i⁄_li°
 (
c⁄ãxt
 *
c
)

296 
c⁄√˘i⁄_li°
 *
l
 = 
c
->
›ti⁄s
.connection_list;

297 i‡(
l
)

299 
l
->
cuºít
 = -1;

300 i‡(
c
->
›ti⁄s
.
ªmŸe_øndom
)

302 
i
;

303 
i
 = 0; i < 
l
->
Àn
; ++i)

305 c⁄° 
j
 = 
	`gë_øndom
 (Ë% 
l
->
Àn
;

306 i‡(
i
 !
j
)

308 
c⁄√˘i⁄_íåy
 *
tmp
;

309 
tmp
 = 
l
->
¨øy
[
i
];

310 
l
->
¨øy
[
i
] =Ü->¨øy[
j
];

311 
l
->
¨øy
[
j
] = 
tmp
;

316 
	}
}

322 
	$√xt_c⁄√˘i⁄_íåy
 (
c⁄ãxt
 *
c
)

324 
c⁄√˘i⁄_li°
 *
l
 = 
c
->
›ti⁄s
.connection_list;

325 i‡(
l
)

327 
boﬁ
 
˚_deföed
;

328 
c⁄√˘i⁄_íåy
 *
˚
;

329 
n_cy˛es
 = 0;

332 c⁄° *
ªmŸe_ù_höt
 = 
NULL
;

333 
boﬁ
 
√wcy˛e
 = 
Ál£
;

335 
˚_deföed
 = 
åue
;

336 i‡(
l
->
no_adv™˚
 &&Ü->
cuºít
 >= 0)

338 
l
->
no_adv™˚
 = 
Ál£
;

342 i‡(++
l
->
cuºít
 >l->
Àn
)

344 
l
->
cuºít
 = 0;

345 ++
l
->
n_cy˛es
;

346 i‡(++
n_cy˛es
 >= 2)

347 
	`msg
 (
M_FATAL
, "No usable connectionÖrofilesáreÖresent");

350 i‡(
l
->
cuºít
 == 0)

351 
√wcy˛e
 = 
åue
;

354 
˚
 = 
l
->
¨øy
[l->
cuºít
];

356 i‡(
c
->
›ti⁄s
.
ªmŸe_ù_höt
 && !
l
->
n_cy˛es
)

357 
ªmŸe_ù_höt
 = 
c
->
›ti⁄s
.remote_ip_hint;

359 i‡(
˚
->
Êags
 & 
CE_DISABLED
)

360 
˚_deföed
 = 
Ál£
;

362 
c
->
›ti⁄s
.
˚
 = *ce;

363 #ifde‡
ENABLE_MANAGEMENT


364 i‡(
˚_deföed
 && 
m™agemít
 && 
	`m™agemít_quîy_ªmŸe_íabÀd
(management))

367 
˚_deföed
 = 
	`˚_m™agemít_quîy_ªmŸe
(
c
, 
ªmŸe_ù_höt
);

368 i‡(
	`IS_SIG
 (
c
))

373 i‡(
ªmŸe_ù_höt
)

374 
c
->
›ti⁄s
.
˚
.
ªmŸe
 = 
ªmŸe_ù_höt
;

376 #ifde‡
ENABLE_MANAGEMENT


377 i‡(
˚_deföed
 && 
m™agemít
 && 
	`m™agemít_quîy_¥oxy_íabÀd
 (management))

379 
˚_deföed
 = 
	`˚_m™agemít_quîy_¥oxy
 (
c
);

380 i‡(
	`IS_SIG
 (
c
))

384 } !
˚_deföed
);

386 
	`upd©e_›ti⁄s_˚_po°
 (&
c
->
›ti⁄s
);

387 
	}
}

393 
	$öô_quîy_∑ssw‹ds
 (
c⁄ãxt
 *
c
)

395 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

397 i‡(
c
->
›ti⁄s
.
key_∑ss_fûe
)

398 
	`≥m_∑ssw‹d_£tup
 (
c
->
›ti⁄s
.
key_∑ss_fûe
);

401 #i‡
P2MP


403 i‡(
c
->
›ti⁄s
.
auth_u£r_∑ss_fûe
)

405 #ifde‡
ENABLE_CLIENT_CR


406 
	`auth_u£r_∑ss_£tup
 (
c
->
›ti⁄s
.
auth_u£r_∑ss_fûe
, &c->›ti⁄s.
sc_öfo
);

408 
	`auth_u£r_∑ss_£tup
 (
c
->
›ti⁄s
.
auth_u£r_∑ss_fûe
, 
NULL
);

412 
	}
}

418 #ifde‡
GENERAL_PROXY_SUPPORT


421 
	$¥oxy_sc›e
 (
c⁄ãxt
 *
c
)

423  
	`c⁄√˘i⁄_li°_deföed
 (&
c
->
›ti⁄s
) ? 2 : 1;

424 
	}
}

427 
	$unöô_¥oxy_dow‹k
 (
c⁄ãxt
 *
c
)

429 #ifde‡
ENABLE_HTTP_PROXY


430 i‡(
c
->
c1
.
hâp_¥oxy_ow√d
 && c->c1.
hâp_¥oxy
)

432 
	`hâp_¥oxy_˛o£
 (
c
->
c1
.
hâp_¥oxy
);

433 
c
->
c1
.
hâp_¥oxy
 = 
NULL
;

434 
c
->
c1
.
hâp_¥oxy_ow√d
 = 
Ál£
;

437 #ifde‡
ENABLE_SOCKS


438 i‡(
c
->
c1
.
socks_¥oxy_ow√d
 && c->c1.
socks_¥oxy
)

440 
	`socks_¥oxy_˛o£
 (
c
->
c1
.
socks_¥oxy
);

441 
c
->
c1
.
socks_¥oxy
 = 
NULL
;

442 
c
->
c1
.
socks_¥oxy_ow√d
 = 
Ál£
;

445 
	}
}

448 
	$öô_¥oxy_dow‹k
 (
c⁄ãxt
 *
c
)

450 #ifde‡
ENABLE_HTTP_PROXY


451 
boﬁ
 
did_hâp
 = 
Ál£
;

453 c⁄° 
boﬁ
 
did_hâp
 = 
Ál£
;

456 
	`unöô_¥oxy_dow‹k
 (
c
);

458 #ifde‡
ENABLE_HTTP_PROXY


459 i‡(
c
->
›ti⁄s
.
˚
.
hâp_¥oxy_›ti⁄s
)

462 
c
->
c1
.
hâp_¥oxy
 = 
	`hâp_¥oxy_√w
 (c->
›ti⁄s
.
˚
.
hâp_¥oxy_›ti⁄s
);

463 i‡(
c
->
c1
.
hâp_¥oxy
)

465 
did_hâp
 = 
åue
;

466 
c
->
c1
.
hâp_¥oxy_ow√d
 = 
åue
;

471 #ifde‡
ENABLE_SOCKS


472 i‡(!
did_hâp
 && 
c
->
›ti⁄s
.
˚
.
socks_¥oxy_£rvî
)

474 
c
->
c1
.
socks_¥oxy
 = 
	`socks_¥oxy_√w
 (c->
›ti⁄s
.
˚
.
socks_¥oxy_£rvî
,

475 
c
->
›ti⁄s
.
˚
.
socks_¥oxy_p‹t
,

476 
c
->
›ti⁄s
.
˚
.
socks_¥oxy_authfûe
,

477 
c
->
›ti⁄s
.
˚
.
socks_¥oxy_ªåy
);

478 i‡(
c
->
c1
.
socks_¥oxy
)

480 
c
->
c1
.
socks_¥oxy_ow√d
 = 
åue
;

484 
	}
}

487 
	$öô_¥oxy
 (
c⁄ãxt
 *
c
, c⁄° 
sc›e
)

489 i‡(
sc›e
 =
	`¥oxy_sc›e
 (
c
))

490 
	`öô_¥oxy_dow‹k
 (
c
);

491 
	}
}

494 
	$unöô_¥oxy
 (
c⁄ãxt
 *
c
)

496 i‡(
c
->
sig
->
sig«l_ª˚ived
 !
SIGUSR1
 || 
	`¥oxy_sc›e
 (c) == 2)

497 
	`unöô_¥oxy_dow‹k
 (
c
);

498 
	}
}

502 
ölöe
 

503 
	$öô_¥oxy
 (
c⁄ãxt
 *
c
, c⁄° 
sc›e
)

505 
	}
}

507 
ölöe
 

508 
	$unöô_¥oxy
 (
c⁄ãxt
 *
c
)

510 
	}
}

515 
	$c⁄ãxt_öô_1
 (
c⁄ãxt
 *
c
)

517 
	`c⁄ãxt_˛ór_1
 (
c
);

519 
	`∑ckë_id_≥rsi°_öô
 (&
c
->
c1
.
pid_≥rsi°
);

521 
	`öô_c⁄√˘i⁄_li°
 (
c
);

523 
	`öô_quîy_∑ssw‹ds
 (
c
);

525 #i‡
	`deföed
(
ENABLE_PKCS11
)

526 i‡(
c
->
fú°_time
) {

527 
i
;

528 
	`pkcs11_öôülize
 (
åue
, 
c
->
›ti⁄s
.
pkcs11_pö_ˇche_≥riod
);

529 
i
=0;i<
MAX_PARMS
 && 
c
->
›ti⁄s
.
pkcs11_¥ovidîs
[i] !
NULL
;i++)

530 
	`pkcs11_addProvidî
 (
c
->
›ti⁄s
.
pkcs11_¥ovidîs
[
i
], c->›ti⁄s.
pkcs11_¥Ÿe˘ed_authítiˇti⁄
[i],

531 
c
->
›ti⁄s
.
pkcs11_¥iv©e_mode
[
i
], c->›ti⁄s.
pkcs11_˚π_¥iv©e
[i]);

540 
u£r_∑ss
 
up
;

541 
	`CLEAR
 (
up
);

542 
	`°r˝y
 (
up
.
u£∫ame
, "Please insert your cryptographicÅoken");

543 
	`gë_u£r_∑ss
 (&
up
, 
NULL
, "tokí-ö£πi⁄-ªque°", 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_NEED_OK
);

544 
	`msg
 (
M_INFO
, "RET:%s", 
up
.
∑ssw‹d
);

550 
	`öô_¥oxy
 (
c
, 1);

551 
	}
}

554 
	$c⁄ãxt_gc_‰ì
 (
c⁄ãxt
 *
c
)

556 
	`gc_‰ì
 (&
c
->
c2
.
gc
);

557 
	`gc_‰ì
 (&
c
->
›ti⁄s
.
gc
);

558 
	`gc_‰ì
 (&
c
->
gc
);

559 
	}
}

561 #i‡
PORT_SHARE


564 
	$˛o£_p‹t_sh¨e
 ()

566 i‡(
p‹t_sh¨e
)

568 
	`p‹t_sh¨e_˛o£
 (
p‹t_sh¨e
);

569 
p‹t_sh¨e
 = 
NULL
;

571 
	}
}

574 
	$öô_p‹t_sh¨e
 (
c⁄ãxt
 *
c
)

576 i‡(!
p‹t_sh¨e
 && (
c
->
›ti⁄s
.
p‹t_sh¨e_ho°
 && c->›ti⁄s.
p‹t_sh¨e_p‹t
))

578 
p‹t_sh¨e
 = 
	`p‹t_sh¨e_›í
 (
c
->
›ti⁄s
.
p‹t_sh¨e_ho°
,

579 
c
->
›ti⁄s
.
p‹t_sh¨e_p‹t
,

580 
	`MAX_RW_SIZE_LINK
 (&
c
->
c2
.
‰ame
),

581 
c
->
›ti⁄s
.
p‹t_sh¨e_jou∫Æ_dú
);

582 i‡(
p‹t_sh¨e
 =
NULL
)

583 
	`msg
 (
M_FATAL
, "FatalÉrror: Port sharing failed");

585 
	}
}

589 
boﬁ


590 
	$öô_°©ic
 ()

594 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
DMALLOC
)

595 
	`¸y±o_öô_dmÆloc
();

598 
	`öô_øndom_£ed
 ();

600 
	`îr‹_ª£t
 ();

601 
	`ª£t_check_°©us
 ();

603 #ifde‡
WIN32


604 
	`öô_wö32
 ();

607 #ifde‡
OPENVPN_DEBUG_COMMAND_LINE


609 
i
;

610 
i
 = 0; i < 
¨gc
; ++i)

611 
	`msg
 (
M_INFO
, "¨gv[%d] = '%s'", 
i
, 
¨gv
[i]);

615 
	`upd©e_time
 ();

617 #ifde‡
ENABLE_CRYPTO


618 
	`öô_s¶_lib
 ();

623 
	`¥ng_öô
 (
NULL
, 0);

626 #ifde‡
PID_TEST


627 
	`∑ckë_id_öãø˘ive_ã°
 ();

628  
Ál£
;

631 #ifde‡
SCHEDULE_TEST


632 
	`scheduÀ_ã°
 ();

633  
Ál£
;

636 #ifde‡
LIST_TEST


637 
	`li°_ã°
 ();

638  
Ál£
;

641 #ifde‡
IFCONFIG_POOL_TEST


642 
	`ifc⁄fig_poﬁ_ã°
 (0x0A010004, 0x0A0100FF);

643  
Ál£
;

646 #ifde‡
CHARACTER_CLASS_DEBUG


647 
	`ch¨a˘î_˛ass_debug
 ();

648  
Ál£
;

651 #ifde‡
EXTRACT_X509_FIELD_TEST


652 
	`exåa˘_x509_fõld_ã°
 ();

653  
Ál£
;

656 #ifde‡
TIME_TEST


657 
	`time_ã°
 ();

658  
Ál£
;

661 #ifde‡
TEST_GET_DEFAULT_GATEWAY


663 
rouã_g©eway_öfo
 
rgi
;

664 
	`gë_deÁu…_g©eway
(&
rgi
);

665 
	`¥öt_deÁu…_g©eway
(
M_INFO
, &
rgi
);

666  
Ál£
;

670 #ifde‡
GEN_PATH_TEST


672 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

673 c⁄° *
‚
 = 
	`gí_∑th
 ("foo",

675 &
gc
);

676 
	`¥ötf
 ("%s\n", 
‚
);

677 
	`gc_‰ì
 (&
gc
);

679  
Ál£
;

682 #ifde‡
STATUS_PRINTF_TEST


684 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

685 c⁄° *
tmp_fûe
 = 
	`¸óã_ãmp_fûe
 ("/tmp", "foo", &
gc
);

686 
°©us_ouçut
 *
so
 = 
	`°©us_›í
 (
tmp_fûe
, 0, -1, 
NULL
, 
STATUS_OUTPUT_WRITE
);

687 
	`°©us_¥ötf
 (
so
, "%s", "foo");

688 
	`°©us_¥ötf
 (
so
, "%s", "bar");

689 i‡(!
	`°©us_˛o£
 (
so
))

690 
	`msg
 (
M_WARN
, "STATUS_PRINTF_TEST: %s: wrôêîr‹", 
tmp_fûe
);

691 
	`gc_‰ì
 (&
gc
);

693  
Ál£
;

696 #ifde‡
ARGV_TEST


698 
	`¨gv_ã°
 ();

699 
	`¨gv_ã°
 ();

700  
Ál£
;

704 #ifde‡
PRNG_TEST


706 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

707 
uöt8_t
 
∫dbuf
[8];

708 
i
;

709 
	`¥ng_öô
 ("sha1", 16);

711 c⁄° 
Á˘‹
 = 1;

712 
i
 = 0; i < 
Á˘‹
 * 8; ++i)

715 
	`¥ng_byãs
 (
∫dbuf
,  (rndbuf));

717 
	`ASSERT
(
	`ønd_byãs
 (
∫dbuf
,  (rndbuf)));

719 
	`¥ötf
 ("[%d] %s\n", 
i
, 
	`f‹m©_hex
 (
∫dbuf
,  (∫dbuf), 0, &
gc
));

721 
	`gc_‰ì
 (&
gc
);

722 
	`¥ng_unöô
 ();

723  
Ál£
;

727 #ifde‡
BUFFER_LIST_AGGREGATE_TEST


730 c⁄° *
ãxt
[] = {

743 
ôî
, 
li°ˇp
;

744 
li°ˇp
 = 0;Üistcap < 12; ++listcap)

746 
ôî
 = 0; iter < 512; ++iter)

748 
buf„r_li°
 *
bl
 = 
	`buf„r_li°_√w
(
li°ˇp
);

750 
i
;

751 
i
 = 0; i < 
	`SIZE
(
ãxt
); ++i)

752 
	`buf„r_li°_push
(
bl
, (*)
ãxt
[
i
]);

754 
	`¥ötf
("[ˇp=%d i=%d] *************************\n", 
li°ˇp
, 
ôî
);

755 i‡(!(
ôî
 & 8))

756 
	`buf„r_li°_aggªg©e
(
bl
, 
ôî
/2);

757 i‡(!(
ôî
 & 16))

758 
	`buf„r_li°_push
(
bl
, (*)"Even moreÅext...");

759 
	`buf„r_li°_aggªg©e
(
bl
, 
ôî
);

760 i‡(!(
ôî
 & 1))

761 
	`buf„r_li°_push
(
bl
, (*)"MoreÅext...");

763 
buf„r
 *
buf
;

764 (
buf
 = 
	`buf„r_li°_≥ek
(
bl
)))

766 
c
;

767 
	`¥ötf
 ("'");

768 (
c
 = 
	`buf_ªad_u8
(
buf
)) >= 0)

769 
	`putch¨
(
c
);

770 
	`¥ötf
 ("'\n");

771 
	`buf„r_li°_adv™˚
(
bl
, 0);

774 
	`buf„r_li°_‰ì
(
bl
);

777  
Ál£
;

781 #ifde‡
MSTATS_TEST


783 
i
;

784 
	`m°©s_›í
("/dev/shm/mstats.dat");

785 
i
 = 0; i < 30; ++i)

787 
mm≠_°©s
->
n_˛õ¡s
 += 1;

788 
mm≠_°©s
->
lök_wrôe_byãs
 += 8;

789 
mm≠_°©s
->
lök_ªad_byãs
 += 16;

790 
	`¶ìp
(1);

792 
	`m°©s_˛o£
();

793  
Ál£
;

797  
åue
;

798 
	}
}

801 
	$unöô_°©ic
 ()

803 #ifde‡
ENABLE_CRYPTO


804 
	`‰ì_s¶_lib
 ();

807 #ifde‡
ENABLE_PKCS11


808 
	`pkcs11_ãrmö©e
 ();

811 #i‡
PORT_SHARE


812 
	`˛o£_p‹t_sh¨e
 ();

815 #i‡
	`deföed
(
MEASURE_TLS_HANDSHAKE_STATS
Ë&& deföed(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

816 
	`show_és_≥rf‹m™˚_°©s
 ();

818 
	}
}

821 
	$öô_vîb_muã
 (
c⁄ãxt
 *
c
, 
Êags
)

823 i‡(
Êags
 & 
IVM_LEVEL_1
)

826 
	`£t_check_°©us
 (
D_LINK_ERRORS
, 
D_READ_WRITE
);

827 
	`£t_debug_Àvñ
 (
c
->
›ti⁄s
.
vîbosôy
, 
SDL_CONSTRAIN
);

828 
	`£t_muã_cutoff
 (
c
->
›ti⁄s
.
muã
);

832 i‡(
Êags
 & 
IVM_LEVEL_2
)

833 
c
->
c2
.
log_rw
 = (
	`check_debug_Àvñ
 (
D_LOG_RW
) && !check_debug_level (D_LOG_RW + 1));

834 
	}
}

842 
	$öô_›ti⁄s_dev
 (
›ti⁄s
 *options)

844 i‡(!
›ti⁄s
->
dev
 && o±i⁄s->
dev_node
) {

845 *
dev_node
 = 
	`°rdup
(
›ti⁄s
->dev_node);

846 
›ti⁄s
->
dev
 = 
	`ba£«me
 (
dev_node
);

848 
	}
}

850 
boﬁ


851 
	$¥öt_›ís¶_öfo
 (c⁄° 
›ti⁄s
 *options)

856 #ifde‡
ENABLE_CRYPTO


857 i‡(
›ti⁄s
->
show_cùhîs
 || o±i⁄s->
show_dige°s
 || o±i⁄s->
show_ígöes


858 #ifde‡
ENABLE_SSL


859 || 
›ti⁄s
->
show_és_cùhîs


863 i‡(
›ti⁄s
->
show_cùhîs
)

864 
	`show_avaûabÀ_cùhîs
 ();

865 i‡(
›ti⁄s
->
show_dige°s
)

866 
	`show_avaûabÀ_dige°s
 ();

867 i‡(
›ti⁄s
->
show_ígöes
)

868 
	`show_avaûabÀ_ígöes
 ();

869 #ifde‡
ENABLE_SSL


870 i‡(
›ti⁄s
->
show_és_cùhîs
)

871 
	`show_avaûabÀ_és_cùhîs
 (
›ti⁄s
->
cùhî_li°
);

873  
åue
;

876  
Ál£
;

877 
	}
}

882 
boﬁ


883 
	$do_gíkey
 (c⁄° 
›ti⁄s
 * options)

885 #ifde‡
ENABLE_CRYPTO


886 i‡(
›ti⁄s
->
gíkey
)

888 
nbôs_wrôãn
;

890 
	`nŸnuŒ
 (
›ti⁄s
->
sh¨ed_£¸ë_fûe
,

893 i‡(
›ti⁄s
->
mlock
)

894 
	`∂©f‹m_mlockÆl
 (
åue
);

896 
nbôs_wrôãn
 = 
	`wrôe_key_fûe
 (2, 
›ti⁄s
->
sh¨ed_£¸ë_fûe
);

898 
	`msg
 (
D_GENKEY
 | 
M_NOPREFIX
,

899 "R™domly gíî©ed %d bô key wrôã¿tÿ%s", 
nbôs_wrôãn
,

900 
›ti⁄s
->
sh¨ed_£¸ë_fûe
);

901  
åue
;

904  
Ál£
;

905 
	}
}

910 
boﬁ


911 
	$do_≥rsi°_tu¡≠
 (c⁄° 
›ti⁄s
 *options)

913 #ifde‡
ENABLE_FEATURE_TUN_PERSIST


914 i‡(
›ti⁄s
->
≥rsi°_c⁄fig
)

917 
	`nŸnuŒ
 (
›ti⁄s
->
dev
, "TUN/TAP device (--dev)");

918 i‡(
›ti⁄s
->
˚
.
ªmŸe
 || o±i⁄s->
ifc⁄fig_loˇl


919 || 
›ti⁄s
->
ifc⁄fig_ªmŸe_√tmask


920 #ifde‡
ENABLE_CRYPTO


921 || 
›ti⁄s
->
sh¨ed_£¸ë_fûe


922 #ifde‡
ENABLE_SSL


923 || 
›ti⁄s
->
és_£rvî
 || o±i⁄s->
és_˛õ¡


927 
	`msg
 (
M_FATAL
|
M_OPTERR
,

929 
	`tuncfg
 (
›ti⁄s
->
dev
, o±i⁄s->
dev_ty≥
, o±i⁄s->
dev_node
,

930 
›ti⁄s
->
≥rsi°_mode
,

931 
›ti⁄s
->
u£∫ame
, o±i⁄s->
grou≤ame
, &›ti⁄s->
tu¡≠_›ti⁄s
);

932 i‡(
›ti⁄s
->
≥rsi°_mode
 && o±i⁄s->
Œaddr
)

933 
	`£t_Œaddr
(
›ti⁄s
->
dev
, o±i⁄s->
Œaddr
, 
NULL
);

934  
åue
;

937  
Ál£
;

938 
	}
}

944 
boﬁ


945 
	$possibly_become_d´m⁄
 (c⁄° 
›ti⁄s
 *›ti⁄s, c⁄° 
boﬁ
 
fú°_time
)

947 
boﬁ
 
ªt
 = 
Ál£
;

948 i‡(
fú°_time
 && 
›ti⁄s
->
d´m⁄
)

950 
	`ASSERT
 (!
›ti⁄s
->
öëd
);

951 i‡(
	`d´m⁄
 (
›ti⁄s
->
cd_dú
 !
NULL
, o±i⁄s->
log
) < 0)

952 
	`msg
 (
M_ERR
, "daemon() failed or unsupported");

953 
	`ª°‹e_sig«l_°©e
 ();

954 i‡(
›ti⁄s
->
log
)

955 
	`£t_°d_fûes_to_nuŒ
 (
åue
);

957 #i‡
	`deföed
(
ENABLE_PKCS11
)

958 
	`pkcs11_f‹kFixup
 ();

961 
ªt
 = 
åue
;

963  
ªt
;

964 
	}
}

970 
	$do_uid_gid_chroŸ
 (
c⁄ãxt
 *
c
, 
boﬁ
 
no_dñay
)

972 c⁄° 
why_nŸ
[] = "will be delayed because of --client, --pull, or --up-delay";

973 
c⁄ãxt_0
 *
c0
 = 
c
->c0;

975 i‡(
c
->
fú°_time
 && 
c0
 && !c0->
uid_gid_£t
)

978 i‡(
c
->
›ti⁄s
.
chroŸ_dú
)

980 i‡(
no_dñay
)

981 
	`∂©f‹m_chroŸ
 (
c
->
›ti⁄s
.
chroŸ_dú
);

983 
	`msg
 (
M_INFO
, "NOTE: chroŸ %s", 
why_nŸ
);

987 i‡(
no_dñay
)

989 
	`∂©f‹m_group_£t
 (&
c0
->
∂©f‹m_°©e_group
);

990 
	`∂©f‹m_u£r_£t
 (&
c0
->
∂©f‹m_°©e_u£r
);

991 
c0
->
uid_gid_£t
 = 
åue
;

993 i‡(
c0
->
uid_gid_•ecifõd
)

995 
	`msg
 (
M_INFO
, "NOTE: UID/GID downgødê%s", 
why_nŸ
);

998 #ifde‡
ENABLE_MEMSTATS


999 i‡(
c
->
›ti⁄s
.
mem°©s_‚
)

1000 
	`m°©s_›í
(
c
->
›ti⁄s
.
mem°©s_‚
);

1003 #ifde‡
ENABLE_SELINUX


1010 i‡(
c
->
›ti⁄s
.
£löux_c⁄ãxt
)

1012 i‡(
no_dñay
) {

1013 i‡(-1 =
	`£tc⁄
 (
c
->
›ti⁄s
.
£löux_c⁄ãxt
))

1014 
	`msg
 (
M_ERR
, "£tc⁄Åÿ'%s' faûed; i†/¥o¯ac˚ssibÀ?", 
c
->
›ti⁄s
.
£löux_c⁄ãxt
);

1016 
	`msg
 (
M_INFO
, "£tc⁄Åÿ'%s' suc˚eded", 
c
->
›ti⁄s
.
£löux_c⁄ãxt
);

1019 
	`msg
 (
M_INFO
, "NOTE: sëc⁄ %s", 
why_nŸ
);

1023 
	}
}

1030 
	$f‹m©_comm⁄_«me
 (
c⁄ãxt
 *
c
, 
gc_¨ía
 *
gc
)

1032 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

1033 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

1034 i‡(
c
->
c2
.
és_mu…i
)

1036 
	`buf_¥ötf
 (&
out
, "[%s] ", 
	`és_comm⁄_«me
 (
c
->
c2
.
és_mu…i
, 
Ál£
));

1039  
	`BSTR
 (&
out
);

1040 
	}
}

1043 
	$¥e_£tup
 (c⁄° 
›ti⁄s
 *options)

1045 #ifde‡
WIN32


1046 i‡(
›ti⁄s
->
exô_evít_«me
)

1048 
	`wö32_sig«l_›í
 (&
wö32_sig«l
,

1049 
WSO_FORCE_SERVICE
,

1050 
›ti⁄s
->
exô_evít_«me
,

1051 
›ti⁄s
->
exô_evít_öôül_°©e
);

1055 
	`wö32_sig«l_›í
 (&
wö32_sig«l
,

1056 
WSO_FORCE_CONSOLE
,

1057 
NULL
,

1058 
Ál£
);

1061 i‡(
wö32_sig«l
.
mode
 =
WSO_MODE_CONSOLE
)

1063 
	`wödow_tôÀ_ßve
 (&
wödow_tôÀ
);

1064 
	`wödow_tôÀ_gíî©e
 (
›ti⁄s
->
c⁄fig
);

1068 
	}
}

1071 
	$ª£t_cﬂr£_timîs
 (
c⁄ãxt
 *
c
)

1073 
c
->
c2
.
cﬂr£_timî_wakeup
 = 0;

1074 
	}
}

1080 
	$do_öô_timîs
 (
c⁄ãxt
 *
c
, 
boﬁ
 
de„ºed
)

1082 
	`upd©e_time
 ();

1083 
	`ª£t_cﬂr£_timîs
 (
c
);

1086 i‡(
c
->
›ti⁄s
.
öa˘ivôy_timeout
)

1087 
	`evít_timeout_öô
 (&
c
->
c2
.
öa˘ivôy_öãrvÆ
, c->
›ti⁄s
.
öa˘ivôy_timeout
, 
now
);

1091 i‡(
c
->
›ti⁄s
.
pög_£nd_timeout
)

1092 
	`evít_timeout_öô
 (&
c
->
c2
.
pög_£nd_öãrvÆ
, c->
›ti⁄s
.
pög_£nd_timeout
, 0);

1094 i‡(
c
->
›ti⁄s
.
pög_ªc_timeout
)

1095 
	`evít_timeout_öô
 (&
c
->
c2
.
pög_ªc_öãrvÆ
, c->
›ti⁄s
.
pög_ªc_timeout
, 
now
);

1097 #i‡
P2MP


1098 i‡(
c
->
›ti⁄s
.
£rvî_pﬁl_timeout
)

1099 
	`evít_timeout_öô
 (&
c
->
c2
.
£rvî_pﬁl_öãrvÆ
, c->
›ti⁄s
.
£rvî_pﬁl_timeout
, 
now
);

1102 i‡(!
de„ºed
)

1105 
	`evít_timeout_öô
 (&
c
->
c2
.
waô_f‹_c⁄√˘
, 1, 
now
);

1107 #ifde‡
ENABLE_OCC


1110 i‡(
c
->
›ti⁄s
.
occ


1111 && !
	`TLS_MODE
 (
c
)

1112 && 
c
->
c2
.
›ti⁄s_°rög_loˇl
 && c->c2.
›ti⁄s_°rög_ªmŸe
)

1113 
	`evít_timeout_öô
 (&
c
->
c2
.
occ_öãrvÆ
, 
OCC_INTERVAL_SECONDS
, 
now
);

1115 i‡(
c
->
›ti⁄s
.
mtu_ã°
)

1116 
	`evít_timeout_öô
 (&
c
->
c2
.
occ_mtu_lﬂd_ã°_öãrvÆ
, 
OCC_MTU_LOAD_INTERVAL_SECONDS
, 
now
);

1120 #ifde‡
ENABLE_CRYPTO


1121 i‡(
c
->
›ti⁄s
.
∑ckë_id_fûe
)

1122 
	`evít_timeout_öô
 (&
c
->
c2
.
∑ckë_id_≥rsi°_öãrvÆ
, 60, 
now
);

1125 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

1128 
	`öãrvÆ_öô
 (&
c
->
c2
.
tmp_öt
, 
TLS_MULTI_HORIZON
, 
TLS_MULTI_REFRESH
);

1131 
	}
}

1137 
	$do_öô_åaffic_sh≠î
 (
c⁄ãxt
 *
c
)

1139 #ifde‡
ENABLE_FEATURE_SHAPER


1141 i‡(
c
->
›ti⁄s
.
sh≠î
)

1143 
	`sh≠î_öô
 (&
c
->
c2
.
sh≠î
, c->
›ti⁄s
.shaper);

1144 
	`sh≠î_msg
 (&
c
->
c2
.
sh≠î
);

1147 
	}
}

1155 
	$do_Æloc_rouã_li°
 (
c⁄ãxt
 *
c
)

1157 i‡(!
c
->
c1
.
rouã_li°
)

1158 
c
->
c1
.
rouã_li°
 = 
	`√w_rouã_li°
 (c->
›ti⁄s
.
max_rouãs
, &c->
gc
);

1159 i‡(
c
->
›ti⁄s
.
rouãs_ùv6
 && !c->
c1
.
rouã_ùv6_li°
)

1160 
c
->
c1
.
rouã_ùv6_li°
 = 
	`√w_rouã_ùv6_li°
 (c->
›ti⁄s
.
max_rouãs
, &c->
gc
);

1161 
	}
}

1169 
	$do_öô_rouã_li°
 (c⁄° 
›ti⁄s
 *options,

1170 
rouã_li°
 *route_list,

1171 c⁄° 
lök_sockë_öfo
 *link_socket_info,

1172 
boﬁ
 
Áèl
,

1173 
ív_£t
 *
es
)

1175 c⁄° *
gw
 = 
NULL
;

1176 
dev
 = 
	`dev_ty≥_íum
 (
›ti⁄s
->dev, o±i⁄s->
dev_ty≥
);

1177 
mëric
 = 0;

1179 i‡(
dev
 =
DEV_TYPE_TUN
 && (
›ti⁄s
->
t›ﬁogy
 =
TOP_NET30
 || o±i⁄s->t›ﬁogy =
TOP_P2P
))

1180 
gw
 = 
›ti⁄s
->
ifc⁄fig_ªmŸe_√tmask
;

1181 i‡(
›ti⁄s
->
rouã_deÁu…_g©eway
)

1182 
gw
 = 
›ti⁄s
->
rouã_deÁu…_g©eway
;

1183 i‡(
›ti⁄s
->
rouã_deÁu…_mëric
)

1184 
mëric
 = 
›ti⁄s
->
rouã_deÁu…_mëric
;

1186 i‡(!
	`öô_rouã_li°
 (
rouã_li°
,

1187 
›ti⁄s
->
rouãs
,

1188 
gw
,

1189 
mëric
,

1190 
	`lök_sockë_cuºít_ªmŸe
 (
lök_sockë_öfo
),

1191 
es
))

1193 i‡(
Áèl
)

1194 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_ERROR
);

1199 
	`£ãnv_rouãs
 (
es
, 
rouã_li°
);

1201 
	}
}

1204 
	$do_öô_rouã_ùv6_li°
 (c⁄° 
›ti⁄s
 *options,

1205 
rouã_ùv6_li°
 *route_ipv6_list,

1206 
boﬁ
 
Áèl
,

1207 
ív_£t
 *
es
)

1209 c⁄° *
gw
 = 
NULL
;

1210 
dev
 = 
	`dev_ty≥_íum
 (
›ti⁄s
->dev, o±i⁄s->
dev_ty≥
);

1211 
mëric
 = -1;

1213 
gw
 = 
›ti⁄s
->
ifc⁄fig_ùv6_ªmŸe
;

1215 i‡–
›ti⁄s
->
rouã_ùv6_deÁu…_g©eway
 )

1216 
gw
 = 
›ti⁄s
->
rouã_ùv6_deÁu…_g©eway
;

1219 i‡(
›ti⁄s
->
rouã_deÁu…_mëric
)

1220 
mëric
 = 
›ti⁄s
->
rouã_deÁu…_mëric
;

1222 i‡(!
	`öô_rouã_ùv6_li°
 (
rouã_ùv6_li°
,

1223 
›ti⁄s
->
rouãs_ùv6
,

1224 
gw
,

1225 
mëric
,

1226 
es
))

1228 i‡(
Áèl
)

1229 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_ERROR
);

1234 
	`£ãnv_rouãs_ùv6
 (
es
, 
rouã_ùv6_li°
);

1236 
	}
}

1243 
	$öôüliz©i⁄_£quí˚_com∂ëed
 (
c⁄ãxt
 *
c
, c⁄° 
Êags
)

1245 c⁄° 
mesßge
[] = "Initialization Sequence Completed";

1248 
	`do_uid_gid_chroŸ
 (
c
, 
åue
);

1251 i‡(
Êags
 & 
ISC_ERRORS
)

1253 #ifde‡
WIN32


1254 
	`show_rouãs
 (
M_INFO
|
M_NOPREFIX
);

1255 
	`show_ad≠ãrs
 (
M_INFO
|
M_NOPREFIX
);

1256 
	`msg
 (
M_INFO
, "%†Wôh Eº‹†–£êhâp://›ív≤.√t/Áq.html#dh˝˛õ¡£rv )", 
mesßge
);

1258 
	`msg
 (
M_INFO
, "%†Wôh Eº‹s", 
mesßge
);

1262 
	`msg
 (
M_INFO
, "%s", 
mesßge
);

1265 i‡((
Êags
 & (
ISC_ERRORS
|
ISC_SERVER
)Ë=0 && 
	`c⁄√˘i⁄_li°_deföed
 (&
c
->
›ti⁄s
))

1266 
	`c⁄√˘i⁄_li°_£t_no_adv™˚
 (&
c
->
›ti⁄s
);

1268 #ifde‡
WIN32


1269 
	`f‹k_ªgi°î_dns_a˘i⁄
 (
c
->
c1
.
tu¡≠
);

1272 #ifde‡
ENABLE_MANAGEMENT


1274 i‡(
m™agemít
)

1276 
ö_addr_t
 
tun_loˇl
 = 0;

1277 
ö_addr_t
 
tun_ªmŸe
 = 0;

1278 c⁄° *
dëaû
 = "SUCCESS";

1279 i‡(
c
->
c1
.
tu¡≠
)

1280 
tun_loˇl
 = 
c
->
c1
.
tu¡≠
->
loˇl
;

1286 
tun_ªmŸe
 = 
	`ht⁄l
 (
c
->
c1
.
lök_sockë_addr
.
a˘uÆ
.
de°
.
addr
.
ö4
.
sö_addr
.
s_addr
);

1287 i‡(
Êags
 & 
ISC_ERRORS
)

1288 
dëaû
 = "ERROR";

1289 
	`m™agemít_£t_°©e
 (
m™agemít
,

1290 
OPENVPN_STATE_CONNECTED
,

1291 
dëaû
,

1292 
tun_loˇl
,

1293 
tun_ªmŸe
);

1294 i‡(
tun_loˇl
)

1295 
	`m™agemít_po°_tu¬ñ_›í
 (
m™agemít
, 
tun_loˇl
);

1298 
	}
}

1305 
	$do_rouã
 (c⁄° 
›ti⁄s
 *options,

1306 
rouã_li°
 *route_list,

1307 
rouã_ùv6_li°
 *route_ipv6_list,

1308 c⁄° 
tu¡≠
 *
â
,

1309 c⁄° 
∂ugö_li°
 *
∂ugös
,

1310 
ív_£t
 *
es
)

1312 i‡(!
›ti⁄s
->
rouã_n€xec
 && ( 
rouã_li°
 || 
rouã_ùv6_li°
 ) )

1314 
	`add_rouãs
 (
rouã_li°
, 
rouã_ùv6_li°
, 
â
, 
	`ROUTE_OPTION_FLAGS
 (
›ti⁄s
), 
es
);

1315 
	`£ãnv_öt
 (
es
, "ªdúe˘_g©eway", 
	`rouã_did_ªdúe˘_deÁu…_g©eway
(
rouã_li°
));

1317 #ifde‡
ENABLE_MANAGEMENT


1318 i‡(
m™agemít
)

1319 
	`m™agemít_up_down
 (
m™agemít
, "UP", 
es
);

1322 i‡(
	`∂ugö_deföed
 (
∂ugös
, 
OPENVPN_PLUGIN_ROUTE_UP
))

1324 i‡(
	`∂ugö_ˇŒ
 (
∂ugös
, 
OPENVPN_PLUGIN_ROUTE_UP
, 
NULL
, NULL, 
es
Ë!
OPENVPN_PLUGIN_FUNC_SUCCESS
)

1325 
	`msg
 (
M_WARN
, "WARNING:Ñoute-upÖlugin call failed");

1328 i‡(
›ti⁄s
->
rouã_s¸ùt
)

1330 
¨gv
árgv = 
	`¨gv_√w
 ();

1331 
	`£ãnv_°r
 (
es
, "script_type", "route-up");

1332 
	`¨gv_¥ötf
 (&
¨gv
, "%sc", 
›ti⁄s
->
rouã_s¸ùt
);

1333 
	`›ív≤_run_s¸ùt
 (&
¨gv
, 
es
, 0, "--route-up");

1334 
	`¨gv_ª£t
 (&
¨gv
);

1337 #ifde‡
WIN32


1338 i‡(
›ti⁄s
->
show_√t_up
)

1340 
	`show_rouãs
 (
M_INFO
|
M_NOPREFIX
);

1341 
	`show_ad≠ãrs
 (
M_INFO
|
M_NOPREFIX
);

1343 i‡(
	`check_debug_Àvñ
 (
D_SHOW_NET
))

1345 
	`show_rouãs
 (
D_SHOW_NET
|
M_NOPREFIX
);

1346 
	`show_ad≠ãrs
 (
D_SHOW_NET
|
M_NOPREFIX
);

1349 
	}
}

1355 #i‡
P2MP


1357 
	$ßve_puŒed_›ti⁄s_dige°
 (
c⁄ãxt
 *
c
, c⁄° 
md5_dige°
 *
√wdige°
)

1359 i‡(
√wdige°
)

1360 
c
->
c1
.
puŒed_›ti⁄s_dige°_ßve
 = *
√wdige°
;

1362 
	`md5_dige°_˛ór
 (&
c
->
c1
.
puŒed_›ti⁄s_dige°_ßve
);

1363 
	}
}

1370 
	$do_öô_tun
 (
c⁄ãxt
 *
c
)

1372 
c
->
c1
.
tu¡≠
 = 
	`öô_tun
 (c->
›ti⁄s
.
dev
,

1373 
c
->
›ti⁄s
.
dev_ty≥
,

1374 
c
->
›ti⁄s
.
t›ﬁogy
,

1375 
c
->
›ti⁄s
.
ifc⁄fig_loˇl
,

1376 
c
->
›ti⁄s
.
ifc⁄fig_ªmŸe_√tmask
,

1377 
c
->
›ti⁄s
.
ifc⁄fig_ùv6_loˇl
,

1378 
c
->
›ti⁄s
.
ifc⁄fig_ùv6_√tbôs
,

1379 
c
->
›ti⁄s
.
ifc⁄fig_ùv6_ªmŸe
,

1380 
	`addr_ho°
 (&
c
->
c1
.
lök_sockë_addr
.
loˇl
),

1381 
	`addr_ho°
 (&
c
->
c1
.
lök_sockë_addr
.
ªmŸe
),

1382 !
c
->
›ti⁄s
.
ifc⁄fig_now¨n
,

1383 
c
->
c2
.
es
);

1386 
c
->
c1
.
tu¡≠
->
ùv6
 = c->
›ti⁄s
.
tun_ùv6
;

1388 
	`öô_tun_po°
 (
c
->
c1
.
tu¡≠
,

1389 &
c
->
c2
.
‰ame
,

1390 &
c
->
›ti⁄s
.
tu¡≠_›ti⁄s
);

1392 
c
->
c1
.
tu¡≠_ow√d
 = 
åue
;

1393 
	}
}

1399 
boﬁ


1400 
	$do_›í_tun
 (
c⁄ãxt
 *
c
)

1402 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1403 
boﬁ
 
ªt
 = 
Ál£
;

1405 
c
->
c2
.
ùv4_tun
 = (!c->
›ti⁄s
.
tun_ùv6


1406 && 
	`is_dev_ty≥
 (
c
->
›ti⁄s
.
dev
, c->›ti⁄s.
dev_ty≥
, "tun"));

1408 i‡(!
c
->
c1
.
tu¡≠
)

1411 
	`do_öô_tun
 (
c
);

1414 
	`do_Æloc_rouã_li°
 (
c
);

1417 i‡(
c
->
›ti⁄s
.
rouãs
 && c->
c1
.
rouã_li°
 && c->
c2
.
lök_sockë
)

1418 
	`do_öô_rouã_li°
 (&
c
->
›ti⁄s
, c->
c1
.
rouã_li°
, &c->
c2
.
lök_sockë
->
öfo
, 
Ál£
, c->c2.
es
);

1419 i‡(
c
->
›ti⁄s
.
rouãs_ùv6
 && c->
c1
.
rouã_ùv6_li°
 )

1420 
	`do_öô_rouã_ùv6_li°
 (&
c
->
›ti⁄s
, c->
c1
.
rouã_ùv6_li°
, 
Ál£
, c->
c2
.
es
);

1423 i‡(!
c
->
›ti⁄s
.
ifc⁄fig_n€xec


1424 && 
	`ifc⁄fig_‹dî
 (Ë=
IFCONFIG_BEFORE_TUN_OPEN
)

1428 c⁄° *
guess
 = 
	`guess_tu¡≠_dev
 (
c
->
›ti⁄s
.
dev
,

1429 
c
->
›ti⁄s
.
dev_ty≥
,

1430 
c
->
›ti⁄s
.
dev_node
,

1431 &
gc
);

1432 
	`do_ifc⁄fig
 (
c
->
c1
.
tu¡≠
, 
guess
, 
	`TUN_MTU_SIZE
 (&c->
c2
.
‰ame
), c->c2.
es
);

1436 
	`›í_tun
 (
c
->
›ti⁄s
.
dev
, c->›ti⁄s.
dev_ty≥
, c->›ti⁄s.
dev_node
,

1437 
c
->
c1
.
tu¡≠
);

1440 i‡(
c
->
›ti⁄s
.
Œaddr
)

1441 
	`£t_Œaddr
(
c
->
c1
.
tu¡≠
->
a˘uÆ_«me
, c->
›ti⁄s
.
Œaddr
, c->
c2
.
es
);

1444 i‡(!
c
->
›ti⁄s
.
ifc⁄fig_n€xec


1445 && 
	`ifc⁄fig_‹dî
 (Ë=
IFCONFIG_AFTER_TUN_OPEN
)

1447 
	`do_ifc⁄fig
 (
c
->
c1
.
tu¡≠
, c->c1.tu¡≠->
a˘uÆ_«me
, 
	`TUN_MTU_SIZE
 (&c->
c2
.
‰ame
), c->c2.
es
);

1451 
	`run_up_down
 (
c
->
›ti⁄s
.
up_s¸ùt
,

1452 
c
->
∂ugös
,

1453 
OPENVPN_PLUGIN_UP
,

1454 
c
->
c1
.
tu¡≠
->
a˘uÆ_«me
,

1455 
	`dev_ty≥_°rög
 (
c
->
›ti⁄s
.
dev
, c->›ti⁄s.
dev_ty≥
),

1456 
	`TUN_MTU_SIZE
 (&
c
->
c2
.
‰ame
),

1457 
	`EXPANDED_SIZE
 (&
c
->
c2
.
‰ame
),

1458 
	`¥öt_ö_addr_t
 (
c
->
c1
.
tu¡≠
->
loˇl
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1459 
	`¥öt_ö_addr_t
 (
c
->
c1
.
tu¡≠
->
ªmŸe_√tmask
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1461 
NULL
,

1463 
c
->
c2
.
es
);

1466 i‡(!
c
->
›ti⁄s
.
rouã_dñay_deföed
)

1467 
	`do_rouã
 (&
c
->
›ti⁄s
, c->
c1
.
rouã_li°
, c->c1.
rouã_ùv6_li°
,

1468 
c
->
c1
.
tu¡≠
, c->
∂ugös
, c->
c2
.
es
);

1473 i‡(
c
->
c1
.
tu¡≠
->
po°_›í_mtu
)

1474 
	`‰ame_£t_mtu_dy«mic
 (&
c
->
c2
.
‰ame
,

1475 
c
->
c1
.
tu¡≠
->
po°_›í_mtu
,

1476 
SET_MTU_TUN
 | 
SET_MTU_UPPER_BOUND
);

1478 
ªt
 = 
åue
;

1479 
°©ic_c⁄ãxt
 = 
c
;

1483 
	`msg
 (
M_INFO
, "PreservingÖrevious TUN/TAP instance: %s",

1484 
c
->
c1
.
tu¡≠
->
a˘uÆ_«me
);

1487 i‡(
c
->
›ti⁄s
.
up_ª°¨t
)

1488 
	`run_up_down
 (
c
->
›ti⁄s
.
up_s¸ùt
,

1489 
c
->
∂ugös
,

1490 
OPENVPN_PLUGIN_UP
,

1491 
c
->
c1
.
tu¡≠
->
a˘uÆ_«me
,

1492 
	`dev_ty≥_°rög
 (
c
->
›ti⁄s
.
dev
, c->›ti⁄s.
dev_ty≥
),

1493 
	`TUN_MTU_SIZE
 (&
c
->
c2
.
‰ame
),

1494 
	`EXPANDED_SIZE
 (&
c
->
c2
.
‰ame
),

1495 
	`¥öt_ö_addr_t
 (
c
->
c1
.
tu¡≠
->
loˇl
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1496 
	`¥öt_ö_addr_t
 (
c
->
c1
.
tu¡≠
->
ªmŸe_√tmask
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1498 
NULL
,

1500 
c
->
c2
.
es
);

1502 
	`gc_‰ì
 (&
gc
);

1503  
ªt
;

1504 
	}
}

1511 
	$do_˛o£_tun_sim∂e
 (
c⁄ãxt
 *
c
)

1513 
	`msg
 (
D_CLOSE
, "Closing TUN/TAP interface");

1514 
	`˛o£_tun
 (
c
->
c1
.
tu¡≠
);

1515 
c
->
c1
.
tu¡≠
 = 
NULL
;

1516 
c
->
c1
.
tu¡≠_ow√d
 = 
Ál£
;

1517 #i‡
P2MP


1518 
	`ßve_puŒed_›ti⁄s_dige°
 (
c
, 
NULL
);

1520 
	}
}

1523 
	$do_˛o£_tun
 (
c⁄ãxt
 *
c
, 
boﬁ
 
f‹˚
)

1525 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1526 i‡(
c
->
c1
.
tu¡≠
 && c->c1.
tu¡≠_ow√d
)

1528 c⁄° *
tu¡≠_a˘uÆ
 = 
	`°rög_Æloc
 (
c
->
c1
.
tu¡≠
->
a˘uÆ_«me
, &
gc
);

1529 c⁄° 
ö_addr_t
 
loˇl
 = 
c
->
c1
.
tu¡≠
->local;

1530 c⁄° 
ö_addr_t
 
ªmŸe_√tmask
 = 
c
->
c1
.
tu¡≠
->remote_netmask;

1532 i‡(
f‹˚
 || !(
c
->
sig
->
sig«l_ª˚ived
 =
SIGUSR1
 && c->
›ti⁄s
.
≥rsi°_tun
))

1534 
°©ic_c⁄ãxt
 = 
NULL
;

1536 #ifde‡
ENABLE_MANAGEMENT


1538 i‡(
m™agemít
)

1540 
	`m™agemít_¥e_tu¬ñ_˛o£
 (
m™agemít
);

1541 
	`m™agemít_up_down
 (
m™agemít
, "DOWN", 
c
->
c2
.
es
);

1546 i‡(
c
->
c1
.
rouã_li°
 || c->c1.
rouã_ùv6_li°
 )

1548 
	`run_up_down
 (
c
->
›ti⁄s
.
rouã_¥edown_s¸ùt
,

1549 
c
->
∂ugös
,

1550 
OPENVPN_PLUGIN_ROUTE_PREDOWN
,

1551 
tu¡≠_a˘uÆ
,

1552 
NULL
,

1553 
	`TUN_MTU_SIZE
 (&
c
->
c2
.
‰ame
),

1554 
	`EXPANDED_SIZE
 (&
c
->
c2
.
‰ame
),

1555 
	`¥öt_ö_addr_t
 (
loˇl
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1556 
	`¥öt_ö_addr_t
 (
ªmŸe_√tmask
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1558 
	`sig«l_des¸ùti⁄
 (
c
->
sig
->
sig«l_ª˚ived
,

1559 
c
->
sig
->
sig«l_ãxt
),

1561 
c
->
c2
.
es
);

1563 
	`dñëe_rouãs
 (
c
->
c1
.
rouã_li°
, c->c1.
rouã_ùv6_li°
,

1564 
c
->
c1
.
tu¡≠
, 
	`ROUTE_OPTION_FLAGS
 (&c->
›ti⁄s
), c->
c2
.
es
);

1568 i‡(!
c
->
›ti⁄s
.
down_¥e
)

1569 
	`do_˛o£_tun_sim∂e
 (
c
);

1573 
	`run_up_down
 (
c
->
›ti⁄s
.
down_s¸ùt
,

1574 
c
->
∂ugös
,

1575 
OPENVPN_PLUGIN_DOWN
,

1576 
tu¡≠_a˘uÆ
,

1577 
NULL
,

1578 
	`TUN_MTU_SIZE
 (&
c
->
c2
.
‰ame
),

1579 
	`EXPANDED_SIZE
 (&
c
->
c2
.
‰ame
),

1580 
	`¥öt_ö_addr_t
 (
loˇl
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1581 
	`¥öt_ö_addr_t
 (
ªmŸe_√tmask
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1583 
	`sig«l_des¸ùti⁄
 (
c
->
sig
->
sig«l_ª˚ived
,

1584 
c
->
sig
->
sig«l_ãxt
),

1586 
c
->
c2
.
es
);

1589 i‡(
c
->
›ti⁄s
.
down_¥e
)

1590 
	`do_˛o£_tun_sim∂e
 (
c
);

1595 i‡(
c
->
›ti⁄s
.
up_ª°¨t
)

1596 
	`run_up_down
 (
c
->
›ti⁄s
.
down_s¸ùt
,

1597 
c
->
∂ugös
,

1598 
OPENVPN_PLUGIN_DOWN
,

1599 
tu¡≠_a˘uÆ
,

1600 
NULL
,

1601 
	`TUN_MTU_SIZE
 (&
c
->
c2
.
‰ame
),

1602 
	`EXPANDED_SIZE
 (&
c
->
c2
.
‰ame
),

1603 
	`¥öt_ö_addr_t
 (
loˇl
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1604 
	`¥öt_ö_addr_t
 (
ªmŸe_√tmask
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1606 
	`sig«l_des¸ùti⁄
 (
c
->
sig
->
sig«l_ª˚ived
,

1607 
c
->
sig
->
sig«l_ãxt
),

1609 
c
->
c2
.
es
);

1612 
	`gc_‰ì
 (&
gc
);

1613 
	}
}

1616 
	$tun_ab‹t
()

1618 
c⁄ãxt
 *
c
 = 
°©ic_c⁄ãxt
;

1619 i‡(
c
)

1621 
°©ic_c⁄ãxt
 = 
NULL
;

1622 
	`do_˛o£_tun
 (
c
, 
åue
);

1624 
	}
}

1631 
	$do_up
 (
c⁄ãxt
 *
c
, 
boﬁ
 
puŒed_›ti⁄s
, 
›ti⁄_ty≥s_found
)

1633 i‡(!
c
->
c2
.
do_up_øn
)

1635 
	`ª£t_cﬂr£_timîs
 (
c
);

1637 i‡(
puŒed_›ti⁄s
 && 
›ti⁄_ty≥s_found
)

1638 
	`do_de„ºed_›ti⁄s
 (
c
, 
›ti⁄_ty≥s_found
);

1641 i‡(
c
->
›ti⁄s
.
up_dñay
 || 
	`PULL_DEFINED
 (&c->options))

1643 
c
->
c2
.
did_›í_tun
 = 
	`do_›í_tun
 (c);

1644 
	`upd©e_time
 ();

1646 #i‡
P2MP


1651 i‡(!
c
->
c2
.
did_›í_tun


1652 && 
	`PULL_DEFINED
 (&
c
->
›ti⁄s
)

1653 && 
c
->
c1
.
tu¡≠


1654 && (!
	`md5_dige°_deföed
 (&
c
->
c1
.
puŒed_›ti⁄s_dige°_ßve
Ë|| !md5_dige°_deföed (&c->
c2
.
puŒed_›ti⁄s_dige°
)

1655 || !
	`md5_dige°_equÆ
 (&
c
->
c1
.
puŒed_›ti⁄s_dige°_ßve
, &c->
c2
.
puŒed_›ti⁄s_dige°
)))

1658 
	`msg
 (
M_INFO
, "NOTE: Pulled options changed onÑestart, willÇeedÅo closeándÑeopen TUN/TAP device.");

1659 
	`do_˛o£_tun
 (
c
, 
åue
);

1660 
	`›ív≤_¶ìp
 (1);

1661 
c
->
c2
.
did_›í_tun
 = 
	`do_›í_tun
 (c);

1662 
	`upd©e_time
 ();

1667 i‡(
c
->
c2
.
did_›í_tun
)

1669 #i‡
P2MP


1670 
	`ßve_puŒed_›ti⁄s_dige°
 (
c
, &c->
c2
.
puŒed_›ti⁄s_dige°
);

1674 i‡(
c
->
›ti⁄s
.
rouã_dñay_deföed
)

1676 
	`evít_timeout_öô
 (&
c
->
c2
.
rouã_wakeup
, c->
›ti⁄s
.
rouã_dñay
, 
now
);

1677 
	`evít_timeout_öô
 (&
c
->
c2
.
rouã_wakeup_expúe
, c->
›ti⁄s
.
rouã_dñay
 + c->›ti⁄s.
rouã_dñay_wödow
, 
now
);

1678 i‡(
c
->
c1
.
tu¡≠
)

1679 
	`tun_°™dby_öô
 (
c
->
c1
.
tu¡≠
);

1683 
	`öôüliz©i⁄_£quí˚_com∂ëed
 (
c
, 0);

1686 i‡(
c
->
›ti⁄s
.
mode
 =
MODE_POINT_TO_POINT
)

1688 
	`öôüliz©i⁄_£quí˚_com∂ëed
 (
c
, 0);

1691 
c
->
c2
.
do_up_øn
 = 
åue
;

1693 
	}
}

1699 
	$puŒ_≥rmissi⁄_mask
 (c⁄° 
c⁄ãxt
 *
c
)

1701 
Êags
 =

1702 
OPT_P_UP


1703 | 
OPT_P_ROUTE_EXTRAS


1704 | 
OPT_P_SOCKBUF


1705 | 
OPT_P_SOCKFLAGS


1706 | 
OPT_P_SETENV


1707 | 
OPT_P_SHAPER


1708 | 
OPT_P_TIMER


1709 | 
OPT_P_COMP


1710 | 
OPT_P_PERSIST


1711 | 
OPT_P_MESSAGES


1712 | 
OPT_P_EXPLICIT_NOTIFY


1713 | 
OPT_P_ECHO


1714 | 
OPT_P_PULL_MODE


1715 | 
OPT_P_PEER_ID
;

1717 i‡(!
c
->
›ti⁄s
.
rouã_n›uŒ
)

1718 
Êags
 |(
OPT_P_ROUTE
 | 
OPT_P_IPWIN32
);

1720  
Êags
;

1721 
	}
}

1727 
	$do_de„ºed_›ti⁄s
 (
c⁄ãxt
 *
c
, c⁄° 
found
)

1729 i‡(
found
 & 
OPT_P_MESSAGES
)

1731 
	`öô_vîb_muã
 (
c
, 
IVM_LEVEL_1
|
IVM_LEVEL_2
);

1732 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT: --verbánd/or --muteÜevel changed");

1734 i‡(
found
 & 
OPT_P_TIMER
)

1736 
	`do_öô_timîs
 (
c
, 
åue
);

1737 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT:Åimersánd/orÅimeouts modified");

1740 #ifde‡
ENABLE_OCC


1741 i‡(
found
 & 
OPT_P_EXPLICIT_NOTIFY
)

1743 i‡(!
	`¥Ÿo_is_udp
(
c
->
›ti⁄s
.
˚
.
¥Ÿo
Ë&& c->›ti⁄s.˚.
ex∂icô_exô_nŸifiˇti⁄
)

1745 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT: --explicit-exit-notify can only be used with --proto udp");

1746 
c
->
›ti⁄s
.
˚
.
ex∂icô_exô_nŸifiˇti⁄
 = 0;

1749 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT:ÉxplicitÇotifyÖarm(s) modified");

1753 #ifde‡
ENABLE_LZO


1754 i‡(
found
 & 
OPT_P_COMP
)

1756 i‡(
	`lzo_deföed
 (&
c
->
c2
.
lzo_compw‹k
))

1758 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT: LZOÖarms modified");

1759 
	`lzo_modify_Êags
 (&
c
->
c2
.
lzo_compw‹k
, c->
›ti⁄s
.
lzo
);

1764 i‡(
found
 & 
OPT_P_SHAPER
)

1766 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT:Åraffic shaperÉnabled");

1767 
	`do_öô_åaffic_sh≠î
 (
c
);

1770 i‡(
found
 & 
OPT_P_SOCKBUF
)

1772 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT: --sndbuf/--rcvbuf options modified");

1773 
	`lök_sockë_upd©e_buf„r_sizes
 (
c
->
c2
.
lök_sockë
, c->
›ti⁄s
.
rcvbuf
, c->›ti⁄s.
¢dbuf
);

1776 i‡(
found
 & 
OPT_P_SOCKFLAGS
)

1778 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT: --socket-flags option modified");

1779 
	`lök_sockë_upd©e_Êags
 (
c
->
c2
.
lök_sockë
, c->
›ti⁄s
.
sockÊags
);

1782 i‡(
found
 & 
OPT_P_PERSIST
)

1783 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT: --persist options modified");

1784 i‡(
found
 & 
OPT_P_UP
)

1785 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT: --ifconfig/up options modified");

1786 i‡(
found
 & 
OPT_P_ROUTE
)

1787 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT:Ñoute options modified");

1788 i‡(
found
 & 
OPT_P_ROUTE_EXTRAS
)

1789 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT:Ñoute-related options modified");

1790 i‡(
found
 & 
OPT_P_IPWIN32
)

1791 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT: --ip-win32ánd/or --dhcp-option options modified");

1792 i‡(
found
 & 
OPT_P_SETENV
)

1793 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT:Énvironment modified");

1795 #ifde‡
ENABLE_SSL


1796 i‡(
found
 & 
OPT_P_PEER_ID
)

1798 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT:Öeer-id set");

1799 
c
->
c2
.
és_mu…i
->
u£_≥î_id
 = 
åue
;

1800 
c
->
c2
.
és_mu…i
->
≥î_id
 = c->
›ti⁄s
.peer_id;

1803 
	}
}

1808 
boﬁ


1809 
	$do_hﬁd
 (
c⁄ãxt
 *
c
)

1811 #ifde‡
ENABLE_MANAGEMENT


1812 i‡(
m™agemít
)

1815 i‡(
c
 && c->
›ti⁄s
.
d´m⁄
 && 
	`m™agemít_should_d´m⁄ize
 (
m™agemít
))

1816 
	`do_öô_fú°_time
 (
c
);

1819 i‡(
	`m™agemít_hﬁd
 (
m™agemít
))

1820  
åue
;

1823  
Ál£
;

1824 
	}
}

1830 
	$sockë_ª°¨t_∑u£
 (
c⁄ãxt
 *
c
)

1832 
boﬁ
 
¥oxy
 = 
Ál£
;

1833 
£c
 = 2;

1835 #ifde‡
ENABLE_HTTP_PROXY


1836 i‡(
c
->
›ti⁄s
.
˚
.
hâp_¥oxy_›ti⁄s
)

1837 
¥oxy
 = 
åue
;

1839 #ifde‡
ENABLE_SOCKS


1840 i‡(
c
->
›ti⁄s
.
˚
.
socks_¥oxy_£rvî
)

1841 
¥oxy
 = 
åue
;

1844 
c
->
›ti⁄s
.
˚
.
¥Ÿo
)

1846 
PROTO_UDPv4
:

1847 
PROTO_UDPv6
:

1848 i‡(
¥oxy
)

1849 
£c
 = 
c
->
›ti⁄s
.
˚
.
c⁄√˘_ªåy_£c⁄ds
;

1851 
PROTO_TCPv4_SERVER
:

1852 
PROTO_TCPv6_SERVER
:

1853 
£c
 = 1;

1855 
PROTO_TCPv4_CLIENT
:

1856 
PROTO_TCPv6_CLIENT
:

1857 
£c
 = 
c
->
›ti⁄s
.
˚
.
c⁄√˘_ªåy_£c⁄ds
;

1861 #ifde‡
ENABLE_DEBUG


1862 i‡(
	`GREMLIN_CONNECTION_FLOOD_LEVEL
 (
c
->
›ti⁄s
.
gªmlö
))

1863 
£c
 = 0;

1866 #i‡
P2MP


1867 i‡(
	`auth_ªåy_gë
 (Ë=
AR_NOINTERACT
)

1868 
£c
 = 10;

1871 i‡(
c
->
›ti⁄s
.
£rvî_pﬁl_timeout
 && 
£c
 > 1)

1872 
£c
 = 1;

1876 i‡(
c
->
≥rsi°
.
ª°¨t_¶ìp_£c⁄ds
 > 0 && c->≥rsi°.ª°¨t_¶ìp_£c⁄d†> 
£c
)

1877 
£c
 = 
c
->
≥rsi°
.
ª°¨t_¶ìp_£c⁄ds
;

1878 i‡(
c
->
≥rsi°
.
ª°¨t_¶ìp_£c⁄ds
 == -1)

1879 
£c
 = 0;

1880 
c
->
≥rsi°
.
ª°¨t_¶ìp_£c⁄ds
 = 0;

1883 i‡(
	`do_hﬁd
 (
NULL
))

1884 
£c
 = 0;

1886 i‡(
£c
)

1888 
	`msg
 (
D_RESTART
, "Re°¨à∑u£, %d sec⁄d(s)", 
£c
);

1889 
	`›ív≤_¶ìp
 (
£c
);

1891 
	}
}

1897 
	$do_°¨tup_∑u£
 (
c⁄ãxt
 *
c
)

1899 i‡(!
c
->
fú°_time
)

1900 
	`sockë_ª°¨t_∑u£
 (
c
);

1902 
	`do_hﬁd
 (
NULL
);

1903 
	}
}

1909 
	$‰ame_föÆize_›ti⁄s
 (
c⁄ãxt
 *
c
, c⁄° 
›ti⁄s
 *
o
)

1911 i‡(!
o
)

1912 
o
 = &
c
->
›ti⁄s
;

1918 i‡(!
	`CIPHER_ENABLED
 (
c
))

1920 
	`‰ame_Æign_to_exåa_‰ame
 (&
c
->
c2
.
‰ame
);

1921 
	`‰ame_‹_Æign_Êags
 (&
c
->
c2
.
‰ame
,

1922 
FRAME_HEADROOM_MARKER_FRAGMENT


1923 |
FRAME_HEADROOM_MARKER_READ_LINK


1924 |
FRAME_HEADROOM_MARKER_READ_STREAM
);

1927 
	`‰ame_föÆize
 (&
c
->
c2
.
‰ame
,

1928 
o
->
˚
.
lök_mtu_deföed
,

1929 
o
->
˚
.
lök_mtu
,

1930 
o
->
˚
.
tun_mtu_deföed
,

1931 
o
->
˚
.
tun_mtu
);

1932 
	}
}

1938 
	$key_scheduÀ_‰ì
 (
key_scheduÀ
 *
ks
, 
boﬁ
 
‰ì_s¶_˘x
)

1940 #ifde‡
ENABLE_CRYPTO


1941 
	`‰ì_key_˘x_bi
 (&
ks
->
°©ic_key
);

1942 #ifde‡
ENABLE_SSL


1943 i‡(
	`és_˘x_öôüli£d
(&
ks
->
s¶_˘x
Ë&& 
‰ì_s¶_˘x
)

1945 
	`és_˘x_‰ì
 (&
ks
->
s¶_˘x
);

1946 
	`‰ì_key_˘x_bi
 (&
ks
->
és_auth_key
);

1950 
	`CLEAR
 (*
ks
);

1951 
	}
}

1953 #ifde‡
ENABLE_CRYPTO


1956 
	$öô_¸y±o_¥e
 (
c⁄ãxt
 *
c
, c⁄° 
Êags
)

1958 i‡(
c
->
›ti⁄s
.
ígöe
)

1959 
	`¸y±o_öô_lib_ígöe
 (
c
->
›ti⁄s
.
ígöe
);

1961 i‡(
Êags
 & 
CF_LOAD_PERSISTED_PACKET_ID
)

1964 i‡(
c
->
›ti⁄s
.
∑ckë_id_fûe
)

1965 
	`∑ckë_id_≥rsi°_lﬂd
 (&
c
->
c1
.
pid_≥rsi°
, c->
›ti⁄s
.
∑ckë_id_fûe
);

1970 i‡(
c
->
›ti⁄s
.
u£_iv
)

1971 
c
->
c2
.
¸y±o_›ti⁄s
.
Êags
 |
CO_USE_IV
;

1973 i‡(
c
->
›ti⁄s
.
muã_ª∂ay_w¨nögs
)

1974 
c
->
c2
.
¸y±o_›ti⁄s
.
Êags
 |
CO_MUTE_REPLAY_WARNINGS
;

1976 #ifde‡
ENABLE_PREDICTION_RESISTANCE


1977 i‡(
c
->
›ti⁄s
.
u£_¥edi˘i⁄_ªsi°™˚
)

1978 
	`ønd_˘x_íabÀ_¥edi˘i⁄_ªsi°™˚
();

1981 
	}
}

1987 
	$do_öô_¸y±o_°©ic
 (
c⁄ãxt
 *
c
, c⁄° 
Êags
)

1989 c⁄° 
›ti⁄s
 *›ti⁄†&
c
->options;

1990 
	`ASSERT
 (
›ti⁄s
->
sh¨ed_£¸ë_fûe
);

1992 
	`öô_¸y±o_¥e
 (
c
, 
Êags
);

1995 i‡(
›ti⁄s
->
ª∂ay
)

1997 
	`∑ckë_id_öô
 (&
c
->
c2
.
∑ckë_id
,

1998 
	`lök_sockë_¥Ÿo_c⁄√˘i⁄_‹õ¡ed
 (
›ti⁄s
->
˚
.
¥Ÿo
),

1999 
›ti⁄s
->
ª∂ay_wödow
,

2000 
›ti⁄s
->
ª∂ay_time
,

2002 
c
->
c2
.
¸y±o_›ti⁄s
.
∑ckë_id
 = &c->c2.packet_id;

2003 
c
->
c2
.
¸y±o_›ti⁄s
.
pid_≥rsi°
 = &c->
c1
.pid_persist;

2004 
c
->
c2
.
¸y±o_›ti⁄s
.
Êags
 |
CO_PACKET_ID_LONG_FORM
;

2005 
	`∑ckë_id_≥rsi°_lﬂd_obj
 (&
c
->
c1
.
pid_≥rsi°
,

2006 
c
->
c2
.
¸y±o_›ti⁄s
.
∑ckë_id
);

2009 i‡(!
	`key_˘x_bi_deföed
 (&
c
->
c1
.
ks
.
°©ic_key
))

2011 
key2
 key2;

2012 
key_dúe˘i⁄_°©e
 
kds
;

2015 
	`öô_key_ty≥
 (&
c
->
c1
.
ks
.
key_ty≥
, 
›ti⁄s
->
cùhî«me
,

2016 
›ti⁄s
->
cùhî«me_deföed
, o±i⁄s->
auth«me
,

2017 
›ti⁄s
->
auth«me_deföed
, o±i⁄s->
keysize
,

2018 
›ti⁄s
->
ã°_¸y±o
, 
åue
);

2022 
rkf_Êags
 = 
RKF_MUST_SUCCEED
;

2023 c⁄° *
rkf_fûe
 = 
›ti⁄s
->
sh¨ed_£¸ë_fûe
;

2025 i‡(
›ti⁄s
->
sh¨ed_£¸ë_fûe_ölöe
)

2027 
rkf_fûe
 = 
›ti⁄s
->
sh¨ed_£¸ë_fûe_ölöe
;

2028 
rkf_Êags
 |
RKF_INLINE
;

2030 
	`ªad_key_fûe
 (&
key2
, 
rkf_fûe
, 
rkf_Êags
);

2034 
	`vîify_fix_key2
 (&
key2
, &
c
->
c1
.
ks
.
key_ty≥
,

2035 
›ti⁄s
->
sh¨ed_£¸ë_fûe
);

2038 
	`key_dúe˘i⁄_°©e_öô
 (&
kds
, 
›ti⁄s
->
key_dúe˘i⁄
);

2039 
	`mu°_have_n_keys
 (
›ti⁄s
->
sh¨ed_£¸ë_fûe
, "£¸ë", &
key2
,

2040 
kds
.
√ed_keys
);

2041 
	`öô_key_˘x
 (&
c
->
c1
.
ks
.
°©ic_key
.
í¸y±
, &
key2
.
keys
[
kds
.
out_key
],

2042 &
c
->
c1
.
ks
.
key_ty≥
, 
OPENVPN_OP_ENCRYPT
, "Static Encrypt");

2043 
	`öô_key_˘x
 (&
c
->
c1
.
ks
.
°©ic_key
.
de¸y±
, &
key2
.
keys
[
kds
.
ö_key
],

2044 &
c
->
c1
.
ks
.
key_ty≥
, 
OPENVPN_OP_DECRYPT
, "Static Decrypt");

2047 
	`CLEAR
 (
key2
);

2051 
	`msg
 (
M_INFO
, "Re-usingÖre-shared static key");

2055 
c
->
c2
.
¸y±o_›ti⁄s
.
key_˘x_bi
 = &c->
c1
.
ks
.
°©ic_key
;

2058 
	`¸y±o_adju°_‰ame_∑ømëîs
 (&
c
->
c2
.
‰ame
,

2059 &
c
->
c1
.
ks
.
key_ty≥
,

2060 
›ti⁄s
->
cùhî«me_deföed
,

2061 
›ti⁄s
->
u£_iv
, o±i⁄s->
ª∂ay
, 
åue
);

2064 
	`check_ª∂ay_iv_c⁄si°ícy
 (&
c
->
c1
.
ks
.
key_ty≥
, 
›ti⁄s
->
ª∂ay
,

2065 
›ti⁄s
->
u£_iv
);

2066 
	}
}

2068 #ifde‡
ENABLE_SSL


2075 
	$do_öô_¸y±o_és_c1
 (
c⁄ãxt
 *
c
)

2077 c⁄° 
›ti⁄s
 *›ti⁄†&
c
->options;

2079 i‡(!
	`és_˘x_öôüli£d
(&
c
->
c1
.
ks
.
s¶_˘x
))

2085 
	`öô_s¶
 (
›ti⁄s
, &(
c
->
c1
.
ks
.
s¶_˘x
));

2086 i‡(!
	`és_˘x_öôüli£d
(&
c
->
c1
.
ks
.
s¶_˘x
))

2088 #i‡
P2MP


2089 
	`auth_ªåy_gë
 ())

2091 
AR_NONE
:

2092 
	`msg
 (
M_FATAL
, "Error:Örivate keyÖassword verification failed");

2094 
AR_INTERACT
:

2095 
	`s¶_purge_auth
 (
Ál£
);

2096 
AR_NOINTERACT
:

2097 
c
->
sig
->
sig«l_ª˚ived
 = 
SIGUSR1
;

2100 
	`ASSERT
 (0);

2102 
c
->
sig
->
sig«l_ãxt
 = "private-key-password-failure";

2105 
	`msg
 (
M_FATAL
, "Error:Örivate keyÖassword verification failed");

2110 
	`öô_key_ty≥
 (&
c
->
c1
.
ks
.
key_ty≥
, 
›ti⁄s
->
cùhî«me
,

2111 
›ti⁄s
->
cùhî«me_deföed
, o±i⁄s->
auth«me
,

2112 
›ti⁄s
->
auth«me_deföed
, o±i⁄s->
keysize
, 
åue
,Årue);

2115 
	`¥ng_öô
 (
›ti⁄s
->
¥ng_hash
, o±i⁄s->
¥ng_n⁄˚_£¸ë_Àn
);

2118 i‡(
›ti⁄s
->
és_auth_fûe
)

2120 
Êags
 = 0;

2121 c⁄° *
fûe
 = 
›ti⁄s
->
és_auth_fûe
;

2123 i‡(
›ti⁄s
->
és_auth_fûe_ölöe
)

2125 
Êags
 |
GHK_INLINE
;

2126 
fûe
 = 
›ti⁄s
->
és_auth_fûe_ölöe
;

2128 
	`gë_és_h™dshake_key
 (&
c
->
c1
.
ks
.
key_ty≥
,

2129 &
c
->
c1
.
ks
.
és_auth_key
,

2130 
fûe
,

2131 
›ti⁄s
->
key_dúe˘i⁄
,

2132 
Êags
);

2136 i‡(
›ti⁄s
->
¥iv_key_fûe_ölöe
)

2138 
	`°rög_˛ór
 (
c
->
›ti⁄s
.
¥iv_key_fûe_ölöe
);

2139 
c
->
›ti⁄s
.
¥iv_key_fûe_ölöe
 = 
NULL
;

2145 
	`msg
 (
D_INIT_MEDIUM
, "Re-using SSL/TLS context");

2147 
	}
}

2150 
	$do_öô_¸y±o_és
 (
c⁄ãxt
 *
c
, c⁄° 
Êags
)

2152 c⁄° 
›ti⁄s
 *›ti⁄†&
c
->options;

2153 
és_›ti⁄s
 
to
;

2154 
boﬁ
 
∑ckë_id_l⁄g_f‹m
;

2156 
	`ASSERT
 (
›ti⁄s
->
és_£rvî
 || o±i⁄s->
és_˛õ¡
);

2157 
	`ASSERT
 (!
›ti⁄s
->
ã°_¸y±o
);

2159 
	`öô_¸y±o_¥e
 (
c
, 
Êags
);

2162 
	`ASSERT
 (
›ti⁄s
->
és_£rvî
 =!›ti⁄s->
és_˛õ¡
);

2165 
	`do_öô_¸y±o_és_c1
 (
c
);

2166 i‡(
	`IS_SIG
 (
c
))

2170 
	`check_ª∂ay_iv_c⁄si°ícy
 (&
c
->
c1
.
ks
.
key_ty≥
, 
›ti⁄s
->
ª∂ay
,

2171 
›ti⁄s
->
u£_iv
);

2174 
∑ckë_id_l⁄g_f‹m
 = 
	`cùhî_kt_mode_ofb_cfb
 (
c
->
c1
.
ks
.
key_ty≥
.
cùhî
);

2177 
	`¸y±o_adju°_‰ame_∑ømëîs
 (&
c
->
c2
.
‰ame
,

2178 &
c
->
c1
.
ks
.
key_ty≥
,

2179 
›ti⁄s
->
cùhî«me_deföed
,

2180 
›ti⁄s
->
u£_iv
,

2181 
›ti⁄s
->
ª∂ay
, 
∑ckë_id_l⁄g_f‹m
);

2182 
	`és_adju°_‰ame_∑ømëîs
 (&
c
->
c2
.
‰ame
);

2185 
	`CLEAR
 (
to
);

2187 
to
.
¸y±o_Êags_™d
 = ~(
CO_PACKET_ID_LONG_FORM
);

2188 i‡(
∑ckë_id_l⁄g_f‹m
)

2189 
to
.
¸y±o_Êags_‹
 = 
CO_PACKET_ID_LONG_FORM
;

2191 
to
.
s¶_˘x
 = 
c
->
c1
.
ks
.ssl_ctx;

2192 
to
.
key_ty≥
 = 
c
->
c1
.
ks
.key_type;

2193 
to
.
£rvî
 = 
›ti⁄s
->
és_£rvî
;

2194 
to
.
key_mëhod
 = 
›ti⁄s
->key_method;

2195 
to
.
ª∂ay
 = 
›ti⁄s
->replay;

2196 
to
.
ª∂ay_wödow
 = 
›ti⁄s
->replay_window;

2197 
to
.
ª∂ay_time
 = 
›ti⁄s
->replay_time;

2198 
to
.
t˝_mode
 = 
	`lök_sockë_¥Ÿo_c⁄√˘i⁄_‹õ¡ed
 (
›ti⁄s
->
˚
.
¥Ÿo
);

2199 
to
.
å™sôi⁄_wödow
 = 
›ti⁄s
->transition_window;

2200 
to
.
h™dshake_wödow
 = 
›ti⁄s
->handshake_window;

2201 
to
.
∑ckë_timeout
 = 
›ti⁄s
->
és_timeout
;

2202 
to
.
ª√gŸüã_byãs
 = 
›ti⁄s
->renegotiate_bytes;

2203 
to
.
ª√gŸüã_∑ckës
 = 
›ti⁄s
->renegotiate_packets;

2204 
to
.
ª√gŸüã_£c⁄ds
 = 
›ti⁄s
->renegotiate_seconds;

2205 
to
.
sögÀ_£ssi⁄
 = 
›ti⁄s
->single_session;

2206 #ifde‡
ENABLE_PUSH_PEER_INFO


2207 i‡(
›ti⁄s
->
push_≥î_öfo
)

2208 
to
.
push_≥î_öfo_dëaû
 = 2;

2209 i‡(
›ti⁄s
->
puŒ
)

2210 
to
.
push_≥î_öfo_dëaû
 = 1;

2212 
to
.
push_≥î_öfo_dëaû
 = 0;

2217 i‡(
to
.
£rvî
 && 
›ti⁄s
->
˚
.
¥Ÿo
 =
PROTO_TCPv4_SERVER
)

2218 
to
.
xmô_hﬁd
 = 
åue
;

2220 #ifde‡
ENABLE_OCC


2221 
to
.
dißbÀ_occ
 = !
›ti⁄s
->
occ
;

2224 
to
.
vîify_comm™d
 = 
›ti⁄s
->
és_vîify
;

2225 
to
.
vîify_exp‹t_˚π
 = 
›ti⁄s
->
és_exp‹t_˚π
;

2226 
to
.
vîify_x509_ty≥
 = (
›ti⁄s
->verify_x509_type & 0xff);

2227 
to
.
vîify_x509_«me
 = 
›ti⁄s
->verify_x509_name;

2228 
to
.
¸l_fûe
 = 
›ti⁄s
->crl_file;

2229 
to
.
s¶_Êags
 = 
›ti⁄s
->ssl_flags;

2230 
to
.
ns_˚π_ty≥
 = 
›ti⁄s
->ns_cert_type;

2231 
	`memmove
 (
to
.
ªmŸe_˚π_ku
, 
›ti⁄s
->remote_cert_ku,  (to.remote_cert_ku));

2232 
to
.
ªmŸe_˚π_eku
 = 
›ti⁄s
->remote_cert_eku;

2233 
to
.
vîify_hash
 = 
›ti⁄s
->verify_hash;

2234 #ifde‡
ENABLE_X509ALTUSERNAME


2235 
to
.
x509_u£∫ame_fõld
 = (*Ë
›ti⁄s
->x509_username_field;

2237 
to
.
x509_u£∫ame_fõld
 = 
X509_USERNAME_FIELD_DEFAULT
;

2239 
to
.
es
 = 
c
->
c2
.es;

2241 #ifde‡
ENABLE_DEBUG


2242 
to
.
gªmlö
 = 
c
->
›ti⁄s
.gremlin;

2245 
to
.
∂ugös
 = 
c
->plugins;

2247 #ifde‡
MANAGEMENT_DEF_AUTH


2248 
to
.
mda_c⁄ãxt
 = &
c
->
c2
.mda_context;

2251 #i‡
P2MP_SERVER


2252 
to
.
auth_u£r_∑ss_vîify_s¸ùt
 = 
›ti⁄s
->auth_user_pass_verify_script;

2253 
to
.
auth_u£r_∑ss_vîify_s¸ùt_vü_fûe
 = 
›ti⁄s
->auth_user_pass_verify_script_via_file;

2254 
to
.
tmp_dú
 = 
›ti⁄s
->tmp_dir;

2255 i‡(
›ti⁄s
->
ccd_ex˛usive
)

2256 
to
.
˛õ¡_c⁄fig_dú_ex˛usive
 = 
›ti⁄s
->
˛õ¡_c⁄fig_dú
;

2259 #ifde‡
ENABLE_X509_TRACK


2260 
to
.
x509_åack
 = 
›ti⁄s
->x509_track;

2263 #i‡
P2MP


2264 #ifde‡
ENABLE_CLIENT_CR


2265 
to
.
sci
 = &
›ti⁄s
->
sc_öfo
;

2270 i‡(
›ti⁄s
->
és_auth_fûe
)

2272 
to
.
és_auth_key
 = 
c
->
c1
.
ks
.tls_auth_key;

2273 
to
.
és_auth
.
pid_≥rsi°
 = &
c
->
c1
.pid_persist;

2274 
to
.
és_auth
.
Êags
 |
CO_PACKET_ID_LONG_FORM
;

2275 
	`¸y±o_adju°_‰ame_∑ømëîs
 (&
to
.
‰ame
,

2276 &
c
->
c1
.
ks
.
key_ty≥
,

2277 
Ál£
, fÆ£, 
åue
,Årue);

2282 
	`sockë_adju°_‰ame_∑ømëîs
 (&
to
.
‰ame
, 
›ti⁄s
->
˚
.
¥Ÿo
);

2287 i‡(
Êags
 & 
CF_INIT_TLS_MULTI
)

2288 
c
->
c2
.
és_mu…i
 = 
	`és_mu…i_öô
 (&
to
);

2290 i‡(
Êags
 & 
CF_INIT_TLS_AUTH_STANDALONE
)

2291 
c
->
c2
.
és_auth_°™dÆ⁄e
 = 
	`és_auth_°™dÆ⁄e_öô
 (&
to
, &c->c2.
gc
);

2292 
	}
}

2295 
	$do_öô_föÆize_és_‰ame
 (
c⁄ãxt
 *
c
)

2297 i‡(
c
->
c2
.
és_mu…i
)

2299 
	`és_mu…i_öô_föÆize
 (
c
->
c2
.
és_mu…i
, &c->c2.
‰ame
);

2300 
	`ASSERT
 (
	`EXPANDED_SIZE
 (&
c
->
c2
.
és_mu…i
->
›t
.
‰ame
) <=

2301 
	`EXPANDED_SIZE
 (&
c
->
c2
.
‰ame
));

2302 
	`‰ame_¥öt
 (&
c
->
c2
.
és_mu…i
->
›t
.
‰ame
, 
D_MTU_INFO
,

2305 i‡(
c
->
c2
.
és_auth_°™dÆ⁄e
)

2307 
	`és_auth_°™dÆ⁄e_föÆize
 (
c
->
c2
.
és_auth_°™dÆ⁄e
, &c->c2.
‰ame
);

2308 
	`‰ame_¥öt
 (&
c
->
c2
.
és_auth_°™dÆ⁄e
->
‰ame
, 
D_MTU_INFO
,

2311 
	}
}

2316 #ifde‡
ENABLE_CRYPTO


2321 
	$do_öô_¸y±o_n⁄e
 (c⁄° 
c⁄ãxt
 *
c
)

2323 
	`ASSERT
 (!
c
->
›ti⁄s
.
ã°_¸y±o
);

2324 
	`msg
 (
M_WARN
,

2326 
	}
}

2330 
	$do_öô_¸y±o
 (
c⁄ãxt
 *
c
, c⁄° 
Êags
)

2332 #ifde‡
ENABLE_CRYPTO


2333 i‡(
c
->
›ti⁄s
.
sh¨ed_£¸ë_fûe
)

2334 
	`do_öô_¸y±o_°©ic
 (
c
, 
Êags
);

2335 #ifde‡
ENABLE_SSL


2336 i‡(
c
->
›ti⁄s
.
és_£rvî
 || c->›ti⁄s.
és_˛õ¡
)

2337 
	`do_öô_¸y±o_és
 (
c
, 
Êags
);

2340 
	`do_öô_¸y±o_n⁄e
 (
c
);

2342 
	`msg
 (
M_WARN
,

2343 "******* WARNING *******: " 
PACKAGE_NAME


2346 
	}
}

2349 
	$do_öô_‰ame
 (
c⁄ãxt
 *
c
)

2351 #ifde‡
ENABLE_LZO


2355 i‡(
c
->
›ti⁄s
.
lzo
 & 
LZO_SELECTED
)

2357 
	`lzo_adju°_‰ame_∑ømëîs
 (&
c
->
c2
.
‰ame
);

2362 i‡(
	`CIPHER_ENABLED
 (
c
))

2364 
	`‰ame_add_to_Æign_adju°
 (&
c
->
c2
.
‰ame
, 
LZO_PREFIX_LEN
);

2365 
	`‰ame_‹_Æign_Êags
 (&
c
->
c2
.
‰ame
,

2366 
FRAME_HEADROOM_MARKER_FRAGMENT


2367 |
FRAME_HEADROOM_MARKER_DECRYPT
);

2370 #ifde‡
ENABLE_FRAGMENT


2371 
	`lzo_adju°_‰ame_∑ømëîs
 (&
c
->
c2
.
‰ame_‰agmít_omô
);

2376 #ifde‡
ENABLE_SOCKS


2380 i‡(
c
->
›ti⁄s
.
˚
.
socks_¥oxy_£rvî
)

2381 
	`socks_adju°_‰ame_∑ømëîs
 (&
c
->
c2
.
‰ame
, c->
›ti⁄s
.
˚
.
¥Ÿo
);

2387 i‡(
c
->
›ti⁄s
.
˚
.
tun_mtu_exåa_deföed
)

2388 
	`tun_adju°_‰ame_∑ømëîs
 (&
c
->
c2
.
‰ame
, c->
›ti⁄s
.
˚
.
tun_mtu_exåa
);

2395 
	`sockë_adju°_‰ame_∑ømëîs
 (&
c
->
c2
.
‰ame
, c->
›ti⁄s
.
˚
.
¥Ÿo
);

2401 
	`‰ame_föÆize_›ti⁄s
 (
c
, 
NULL
);

2403 #ifde‡
ENABLE_FRAGMENT


2409 
c
->
c2
.
‰ame_‰agmít
 = c->c2.
‰ame
;

2410 
	`‰ame_subåa˘_exåa
 (&
c
->
c2
.
‰ame_‰agmít
, &c->c2.
‰ame_‰agmít_omô
);

2413 #i‡
	`deföed
(
ENABLE_FRAGMENT
Ë&& deföed(
ENABLE_OCC
)

2417 i‡(
c
->
›ti⁄s
.
˚
.
‰agmít
 && c->›ti⁄s.
mtu_ã°
)

2418 
	`msg
 (
M_WARN
,

2422 #ifde‡
ENABLE_FRAGMENT


2423 i‡((
c
->
›ti⁄s
.
˚
.
mssfix
 || c->›ti⁄s.˚.
‰agmít
)

2424 && 
	`TUN_MTU_SIZE
 (&
c
->
c2
.
‰ame_‰agmít
Ë!
ETHERNET_MTU
)

2425 
	`msg
 (
M_WARN
,

2427 
ETHERNET_MTU
, 
	`TUN_MTU_SIZE
 (&
c
->
c2
.
‰ame_‰agmít
));

2429 
	}
}

2432 
	$do_›ti⁄_w¨nögs
 (
c⁄ãxt
 *
c
)

2434 c⁄° 
›ti⁄s
 *
o
 = &
c
->options;

2436 i‡(
o
->
pög_£nd_timeout
 && !o->
pög_ªc_timeout
)

2437 
	`msg
 (
M_WARN
, "WARNING: --ping shouldÇormally be used with --ping-restart or --ping-exit");

2439 i‡(
o
->
u£∫ame
 || o->
grou≤ame
 || o->
chroŸ_dú


2440 #ifde‡
ENABLE_SELINUX


2441 || 
o
->
£löux_c⁄ãxt


2445 i‡(!
o
->
≥rsi°_tun
)

2446 
	`msg
 (
M_WARN
, "WARNING: youáre using user/group/chroot/setcon withoutÖersist-tun --Åhis may causeÑestartsÅo fail");

2447 i‡(!
o
->
≥rsi°_key


2448 #ifde‡
ENABLE_PKCS11


2449 && !
o
->
pkcs11_id


2452 
	`msg
 (
M_WARN
, "WARNING: youáre using user/group/chroot/setcon withoutÖersist-key --Åhis may causeÑestartsÅo fail");

2455 i‡(
o
->
chroŸ_dú
 && !(o->
u£∫ame
 && o->
grou≤ame
))

2456 
	`msg
 (
M_WARN
, "WARNING: youáre using chroot without specifying useránd group --Åhis may causeÅhe chroot jailÅo be insecure");

2458 #i‡
P2MP


2459 i‡(
o
->
puŒ
 && o->
ifc⁄fig_loˇl
 && 
c
->
fú°_time
)

2460 
	`msg
 (
M_WARN
, "WARNING: using --pull/--clientánd --ifconfigÅogether isÖrobablyÇot what you want");

2462 #i‡
P2MP_SERVER


2463 i‡(
o
->
£rvî_bridge_deföed
 | o->
£rvî_bridge_¥oxy_dh˝
)

2464 
	`msg
 (
M_WARN
, "NOTE: when bridging your LANádapter withÅhe TAPádapter,ÇoteÅhatÅheÇew bridgeádapter will oftenÅake on its own IPáddressÅhat is different from whatÅhe LANádapter wasÖreviously setÅo");

2466 i‡(
o
->
mode
 =
MODE_SERVER
)

2468 i‡(
o
->
du∂iˇã_˙
 && o->
˛õ¡_c⁄fig_dú
)

2469 
	`msg
 (
M_WARN
, "WARNING: using --duplicate-cnánd --client-config-dirÅogether isÖrobablyÇot what you want");

2470 i‡(
o
->
du∂iˇã_˙
 && o->
ifc⁄fig_poﬁ_≥rsi°_fûíame
)

2471 
	`msg
 (
M_WARN
, "WARNING: --ifconfig-pool-persist willÇot work with --duplicate-cn");

2472 i‡(!
o
->
kì∑live_pög
 || !o->
kì∑live_timeout
)

2473 
	`msg
 (
M_WARN
, "WARNING: --keepalive option is missing from server config");

2478 #ifde‡
ENABLE_CRYPTO


2479 i‡(!
o
->
ª∂ay
)

2480 
	`msg
 (
M_WARN
, "WARNING: You havêdißbÀd Rïœy PrŸe˘i⁄ (--no-ª∂ayËwhich may makê" 
PACKAGE_NAME
 "Üess secure");

2481 i‡(!
o
->
u£_iv
)

2482 
	`msg
 (
M_WARN
, "WARNING: You havêdißbÀd Cry±ÿIV†(--no-ivËwhich may makê" 
PACKAGE_NAME
 "Üess secure");

2484 #ifde‡
ENABLE_SSL


2485 i‡(
o
->
és_£rvî
)

2486 
	`w¨n_⁄_u£_of_comm⁄_sub√ts
 ();

2487 i‡(
o
->
és_˛õ¡


2488 && !
o
->
és_vîify


2489 && 
o
->
vîify_x509_ty≥
 =
VERIFY_X509_NONE


2490 && !(
o
->
ns_˚π_ty≥
 & 
NS_CERT_CHECK_SERVER
)

2491 && !
o
->
ªmŸe_˚π_eku
)

2492 
	`msg
 (
M_WARN
, "WARNING: No server certificate verification method has beenÉnabled. See http://openvpn.net/howto.html#mitm for more info.");

2496 #i‚de‡
CONNECT_NONBLOCK


2497 i‡(
o
->
˚
.
c⁄√˘_timeout_deföed
)

2498 
	`msg
 (
M_WARN
, "NOTE: --connect-timeout option isÇot supported onÅhis OS");

2502 i‡(
o
->
u£r_s¸ùt_u£d
)

2504 i‡(
s¸ùt_£curôy
 >
SSEC_SCRIPTS
)

2505 
	`msg
 (
M_WARN
, "NOTE:Åhe current --script-security setting mayállowÅhis configurationÅo call user-defined scripts");

2506 i‡(
s¸ùt_£curôy
 >
SSEC_PW_ENV
)

2507 
	`msg
 (
M_WARN
, "WARNING:Åhe current --script-security setting mayállowÖasswordsÅo beÖassedÅo scripts viaÉnvironmental variables");

2509 
	`msg
 (
M_WARN
, "NOTE: sèπög wôh " 
PACKAGE_NAME
 " 2.1, '--script-security 2' or higher isÑequiredÅo call user-defined scripts orÉxecutables");

2511 
	}
}

2514 
	$do_öô_‰ame_és
 (
c⁄ãxt
 *
c
)

2516 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

2517 
	`do_öô_föÆize_és_‰ame
 (
c
);

2519 
	}
}

2521 
c⁄ãxt_buf„rs
 *

2522 
	$öô_c⁄ãxt_buf„rs
 (c⁄° 
‰ame
 *frame)

2524 
c⁄ãxt_buf„rs
 *
b
;

2526 
	`ALLOC_OBJ_CLEAR
 (
b
, 
c⁄ãxt_buf„rs
);

2528 
b
->
ªad_lök_buf
 = 
	`Æloc_buf
 (
	`BUF_SIZE
 (
‰ame
));

2529 
b
->
ªad_tun_buf
 = 
	`Æloc_buf
 (
	`BUF_SIZE
 (
‰ame
));

2531 
b
->
aux_buf
 = 
	`Æloc_buf
 (
	`BUF_SIZE
 (
‰ame
));

2533 #ifde‡
ENABLE_CRYPTO


2534 
b
->
í¸y±_buf
 = 
	`Æloc_buf
 (
	`BUF_SIZE
 (
‰ame
));

2535 
b
->
de¸y±_buf
 = 
	`Æloc_buf
 (
	`BUF_SIZE
 (
‰ame
));

2538 #ifde‡
ENABLE_LZO


2539 
b
->
lzo_com¥ess_buf
 = 
	`Æloc_buf
 (
	`BUF_SIZE
 (
‰ame
));

2540 
b
->
lzo_decom¥ess_buf
 = 
	`Æloc_buf
 (
	`BUF_SIZE
 (
‰ame
));

2543  
b
;

2544 
	}
}

2547 
	$‰ì_c⁄ãxt_buf„rs
 (
c⁄ãxt_buf„rs
 *
b
)

2549 i‡(
b
)

2551 
	`‰ì_buf
 (&
b
->
ªad_lök_buf
);

2552 
	`‰ì_buf
 (&
b
->
ªad_tun_buf
);

2553 
	`‰ì_buf
 (&
b
->
aux_buf
);

2555 #ifde‡
ENABLE_LZO


2556 
	`‰ì_buf
 (&
b
->
lzo_com¥ess_buf
);

2557 
	`‰ì_buf
 (&
b
->
lzo_decom¥ess_buf
);

2560 #ifde‡
ENABLE_CRYPTO


2561 
	`‰ì_buf
 (&
b
->
í¸y±_buf
);

2562 
	`‰ì_buf
 (&
b
->
de¸y±_buf
);

2565 
	`‰ì
 (
b
);

2567 
	}
}

2574 
	$do_öô_buf„rs
 (
c⁄ãxt
 *
c
)

2576 
c
->
c2
.
buf„rs
 = 
	`öô_c⁄ãxt_buf„rs
 (&c->c2.
‰ame
);

2577 
c
->
c2
.
buf„rs_ow√d
 = 
åue
;

2578 
	}
}

2580 #ifde‡
ENABLE_FRAGMENT


2586 
	$do_öô_‰agmít
 (
c⁄ãxt
 *
c
)

2588 
	`ASSERT
 (
c
->
›ti⁄s
.
˚
.
‰agmít
);

2589 
	`‰ame_£t_mtu_dy«mic
 (&
c
->
c2
.
‰ame_‰agmít
,

2590 
c
->
›ti⁄s
.
˚
.
‰agmít
, 
SET_MTU_UPPER_BOUND
);

2591 
	`‰agmít_‰ame_öô
 (
c
->
c2
.
‰agmít
, &c->c2.
‰ame_‰agmít
);

2592 
	}
}

2599 
	$do_öô_mssfix
 (
c⁄ãxt
 *
c
)

2601 i‡(
c
->
›ti⁄s
.
˚
.
mssfix
)

2603 
	`‰ame_£t_mtu_dy«mic
 (&
c
->
c2
.
‰ame
,

2604 
c
->
›ti⁄s
.
˚
.
mssfix
, 
SET_MTU_UPPER_BOUND
);

2606 
	}
}

2612 
	$do_lök_sockë_√w
 (
c⁄ãxt
 *
c
)

2614 
	`ASSERT
 (!
c
->
c2
.
lök_sockë
);

2615 
c
->
c2
.
lök_sockë
 = 
	`lök_sockë_√w
 ();

2616 
c
->
c2
.
lök_sockë_ow√d
 = 
åue
;

2617 
	}
}

2623 
	$do_öô_sockë_1
 (
c⁄ãxt
 *
c
, c⁄° 
mode
)

2625 
sockÊags
 = 
c
->
›ti⁄s
.sockflags;

2627 #i‡
PORT_SHARE


2628 i‡(
c
->
›ti⁄s
.
p‹t_sh¨e_ho°
 && c->›ti⁄s.
p‹t_sh¨e_p‹t
)

2629 
sockÊags
 |
SF_PORT_SHARE
;

2632 
	`lök_sockë_öô_pha£1
 (
c
->
c2
.
lök_sockë
,

2633 
	`c⁄√˘i⁄_li°_deföed
 (&
c
->
›ti⁄s
),

2634 
c
->
›ti⁄s
.
˚
.
loˇl
,

2635 
c
->
›ti⁄s
.
˚
.
loˇl_p‹t
,

2636 
c
->
›ti⁄s
.
˚
.
ªmŸe
,

2637 
c
->
›ti⁄s
.
˚
.
ªmŸe_p‹t
,

2638 
c
->
›ti⁄s
.
˚
.
¥Ÿo
,

2639 
mode
,

2640 
c
->
c2
.
ac˚±_‰om
,

2641 #ifde‡
ENABLE_HTTP_PROXY


2642 
c
->
c1
.
hâp_¥oxy
,

2644 #ifde‡
ENABLE_SOCKS


2645 
c
->
c1
.
socks_¥oxy
,

2647 #ifde‡
ENABLE_DEBUG


2648 
c
->
›ti⁄s
.
gªmlö
,

2650 
c
->
›ti⁄s
.
˚
.
böd_loˇl
,

2651 
c
->
›ti⁄s
.
˚
.
ªmŸe_Êﬂt
,

2652 
c
->
›ti⁄s
.
öëd
,

2653 &
c
->
c1
.
lök_sockë_addr
,

2654 
c
->
›ti⁄s
.
ùch™ge
,

2655 
c
->
∂ugös
,

2656 
c
->
›ti⁄s
.
ªsﬁve_ªåy_£c⁄ds
,

2657 
c
->
›ti⁄s
.
˚
.
c⁄√˘_ªåy_£c⁄ds
,

2658 
c
->
›ti⁄s
.
˚
.
c⁄√˘_timeout
,

2659 
c
->
›ti⁄s
.
˚
.
c⁄√˘_ªåy_max
,

2660 
c
->
›ti⁄s
.
˚
.
mtu_discovî_ty≥
,

2661 
c
->
›ti⁄s
.
rcvbuf
,

2662 
c
->
›ti⁄s
.
¢dbuf
,

2663 
c
->
›ti⁄s
.
m¨k
,

2664 
sockÊags
);

2665 
	}
}

2671 
	$do_öô_sockë_2
 (
c⁄ãxt
 *
c
)

2673 
	`lök_sockë_öô_pha£2
 (
c
->
c2
.
lök_sockë
, &c->c2.
‰ame
,

2674 &
c
->
sig
->
sig«l_ª˚ived
);

2675 
	}
}

2681 
	$do_¥öt_d©a_ch™√l_mtu_∑rms
 (
c⁄ãxt
 *
c
)

2683 
	`‰ame_¥öt
 (&
c
->
c2
.
‰ame
, 
D_MTU_INFO
, "Data Channel MTUÖarms");

2684 #ifde‡
ENABLE_FRAGMENT


2685 i‡(
c
->
c2
.
‰agmít
)

2686 
	`‰ame_¥öt
 (&
c
->
c2
.
‰ame_‰agmít
, 
D_MTU_INFO
,

2689 
	}
}

2691 #ifde‡
ENABLE_OCC


2696 
	$do_compuã_occ_°rögs
 (
c⁄ãxt
 *
c
)

2698 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2700 
c
->
c2
.
›ti⁄s_°rög_loˇl
 =

2701 
	`›ti⁄s_°rög
 (&
c
->
›ti⁄s
, &c->
c2
.
‰ame
, c->
c1
.
tu¡≠
, 
Ál£
, &
gc
);

2702 
c
->
c2
.
›ti⁄s_°rög_ªmŸe
 =

2703 
	`›ti⁄s_°rög
 (&
c
->
›ti⁄s
, &c->
c2
.
‰ame
, c->
c1
.
tu¡≠
, 
åue
, &
gc
);

2705 
	`msg
 (
D_SHOW_OCC
, "Loˇ»O±i⁄†Såög: '%s'", 
c
->
c2
.
›ti⁄s_°rög_loˇl
);

2706 
	`msg
 (
D_SHOW_OCC
, "Expected Remote Options String: '%s'",

2707 
c
->
c2
.
›ti⁄s_°rög_ªmŸe
);

2709 #ifde‡
ENABLE_CRYPTO


2710 
	`msg
 (
D_SHOW_OCC_HASH
, "Local Options hash (VER=%s): '%s'",

2711 
	`›ti⁄s_°rög_vîsi⁄
 (
c
->
c2
.
›ti⁄s_°rög_loˇl
, &
gc
),

2712 
	`md5sum
 ((
uöt8_t
*)
c
->
c2
.
›ti⁄s_°rög_loˇl
,

2713 
	`°æí
 (
c
->
c2
.
›ti⁄s_°rög_loˇl
), 9, &
gc
));

2714 
	`msg
 (
D_SHOW_OCC_HASH
, "Expected Remote Options hash (VER=%s): '%s'",

2715 
	`›ti⁄s_°rög_vîsi⁄
 (
c
->
c2
.
›ti⁄s_°rög_ªmŸe
, &
gc
),

2716 
	`md5sum
 ((
uöt8_t
*)
c
->
c2
.
›ti⁄s_°rög_ªmŸe
,

2717 
	`°æí
 (
c
->
c2
.
›ti⁄s_°rög_ªmŸe
), 9, &
gc
));

2720 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

2721 i‡(
c
->
c2
.
és_mu…i
)

2722 
	`és_mu…i_öô_£t_›ti⁄s
 (
c
->
c2
.
és_mu…i
,

2723 
c
->
c2
.
›ti⁄s_°rög_loˇl
,

2724 
c
->
c2
.
›ti⁄s_°rög_ªmŸe
);

2727 
	`gc_‰ì
 (&
gc
);

2728 
	}
}

2737 
	$do_öô_fú°_time
 (
c⁄ãxt
 *
c
)

2739 i‡(
c
->
fú°_time
 && !c->
did_we_d´m⁄ize
 && !c->
c0
)

2741 
c⁄ãxt_0
 *
c0
;

2743 
	`ALLOC_OBJ_CLEAR_GC
 (
c
->
c0
, 
c⁄ãxt_0
, &c->
gc
);

2744 
c0
 = 
c
->c0;

2747 
c0
->
uid_gid_•ecifõd
 =

2748 
	`∂©f‹m_group_gë
 (
c
->
›ti⁄s
.
grou≤ame
, &
c0
->
∂©f‹m_°©e_group
) |

2749 
	`∂©f‹m_u£r_gë
 (
c
->
›ti⁄s
.
u£∫ame
, &
c0
->
∂©f‹m_°©e_u£r
);

2752 
	`gë_pid_fûe
 (
c
->
›ti⁄s
.
wrôïid
, &
c0
->
pid_°©e
);

2755 
c
->
did_we_d´m⁄ize
 = 
	`possibly_become_d´m⁄
 (&c->
›ti⁄s
, c->
fú°_time
);

2758 i‡(
c
->
›ti⁄s
.
mlock
 && c->
did_we_d´m⁄ize
)

2759 
	`∂©f‹m_mlockÆl
 (
åue
);

2762 
	`wrôe_pid
 (&
c0
->
pid_°©e
);

2765 
	`∂©f‹m_ni˚
 (
c
->
›ti⁄s
.
ni˚
);

2767 
	}
}

2773 
	$do_˛o£_check_if_ª°¨t_≥rmôãd
 (
c⁄ãxt
 *
c
)

2775 i‡(
c
->
›ti⁄s
.
öëd


2776 && (
c
->
sig
->
sig«l_ª˚ived
 =
SIGHUP


2777 || 
c
->
sig
->
sig«l_ª˚ived
 =
SIGUSR1
))

2779 
c
->
sig
->
sig«l_ª˚ived
 = 
SIGTERM
;

2780 
	`msg
 (
M_INFO
,

2781 
PACKAGE_NAME


2784 
	}
}

2790 
	$do_˛o£_‰ì_buf
 (
c⁄ãxt
 *
c
)

2792 i‡(
c
->
c2
.
buf„rs_ow√d
)

2794 
	`‰ì_c⁄ãxt_buf„rs
 (
c
->
c2
.
buf„rs
);

2795 
c
->
c2
.
buf„rs
 = 
NULL
;

2796 
c
->
c2
.
buf„rs_ow√d
 = 
Ál£
;

2798 
	}
}

2804 
	$do_˛o£_és
 (
c⁄ãxt
 *
c
)

2806 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

2807 i‡(
c
->
c2
.
és_mu…i
)

2809 
	`és_mu…i_‰ì
 (
c
->
c2
.
és_mu…i
, 
åue
);

2810 
c
->
c2
.
és_mu…i
 = 
NULL
;

2813 #ifde‡
ENABLE_OCC


2815 i‡(
c
->
c2
.
›ti⁄s_°rög_loˇl
)

2816 
	`‰ì
 (
c
->
c2
.
›ti⁄s_°rög_loˇl
);

2817 i‡(
c
->
c2
.
›ti⁄s_°rög_ªmŸe
)

2818 
	`‰ì
 (
c
->
c2
.
›ti⁄s_°rög_ªmŸe
);

2819 
c
->
c2
.
›ti⁄s_°rög_loˇl
 = c->c2.
›ti⁄s_°rög_ªmŸe
 = 
NULL
;

2822 
	}
}

2828 
	$do_˛o£_‰ì_key_scheduÀ
 (
c⁄ãxt
 *
c
, 
boﬁ
 
‰ì_s¶_˘x
)

2830 i‡(!(
c
->
sig
->
sig«l_ª˚ived
 =
SIGUSR1
 && c->
›ti⁄s
.
≥rsi°_key
))

2831 
	`key_scheduÀ_‰ì
 (&
c
->
c1
.
ks
, 
‰ì_s¶_˘x
);

2832 
	}
}

2838 
	$do_˛o£_lök_sockë
 (
c⁄ãxt
 *
c
)

2840 i‡(
c
->
c2
.
lök_sockë
 && c->c2.
lök_sockë_ow√d
)

2842 
	`lök_sockë_˛o£
 (
c
->
c2
.
lök_sockë
);

2843 
c
->
c2
.
lök_sockë
 = 
NULL
;

2846 i‡(!(
c
->
sig
->
sig«l_ª˚ived
 =
SIGUSR1
 && c->
›ti⁄s
.
≥rsi°_ªmŸe_ù
))

2848 
	`CLEAR
 (
c
->
c1
.
lök_sockë_addr
.
ªmŸe
);

2849 
	`CLEAR
 (
c
->
c1
.
lök_sockë_addr
.
a˘uÆ
);

2852 i‡(!(
c
->
sig
->
sig«l_ª˚ived
 =
SIGUSR1
 && c->
›ti⁄s
.
≥rsi°_loˇl_ù
))

2853 
	`CLEAR
 (
c
->
c1
.
lök_sockë_addr
.
loˇl
);

2854 
	}
}

2860 
	$do_˛o£_∑ckë_id
 (
c⁄ãxt
 *
c
)

2862 #ifde‡
ENABLE_CRYPTO


2863 
	`∑ckë_id_‰ì
 (&
c
->
c2
.
∑ckë_id
);

2864 
	`∑ckë_id_≥rsi°_ßve
 (&
c
->
c1
.
pid_≥rsi°
);

2865 i‡(!(
c
->
sig
->
sig«l_ª˚ived
 =
SIGUSR1
))

2866 
	`∑ckë_id_≥rsi°_˛o£
 (&
c
->
c1
.
pid_≥rsi°
);

2868 
	}
}

2870 #ifde‡
ENABLE_FRAGMENT


2875 
	$do_˛o£_‰agmít
 (
c⁄ãxt
 *
c
)

2877 i‡(
c
->
c2
.
‰agmít
)

2879 
	`‰agmít_‰ì
 (
c
->
c2
.
‰agmít
);

2880 
c
->
c2
.
‰agmít
 = 
NULL
;

2882 
	}
}

2890 
	$do_evít_£t_öô
 (
c⁄ãxt
 *
c
,

2891 
boﬁ
 
√ed_us_timeout
)

2893 
Êags
 = 0;

2895 
c
->
c2
.
evít_£t_max
 = 
BASE_N_EVENTS
;

2897 
Êags
 |
EVENT_METHOD_FAST
;

2899 i‡(
√ed_us_timeout
)

2900 
Êags
 |
EVENT_METHOD_US_TIMEOUT
;

2902 
c
->
c2
.
evít_£t
 = 
	`evít_£t_öô
 (&c->c2.
evít_£t_max
, 
Êags
);

2903 
c
->
c2
.
evít_£t_ow√d
 = 
åue
;

2904 
	}
}

2907 
	$do_˛o£_evít_£t
 (
c⁄ãxt
 *
c
)

2909 i‡(
c
->
c2
.
evít_£t
 && c->c2.
evít_£t_ow√d
)

2911 
	`evít_‰ì
 (
c
->
c2
.
evít_£t
);

2912 
c
->
c2
.
evít_£t
 = 
NULL
;

2913 
c
->
c2
.
evít_£t_ow√d
 = 
Ál£
;

2915 
	}
}

2922 
	$do_›í_°©us_ouçut
 (
c⁄ãxt
 *
c
)

2924 i‡(!
c
->
c1
.
°©us_ouçut
)

2926 
c
->
c1
.
°©us_ouçut
 = 
	`°©us_›í
 (c->
›ti⁄s
.
°©us_fûe
,

2927 
c
->
›ti⁄s
.
°©us_fûe_upd©e_‰eq
,

2929 
NULL
,

2930 
STATUS_OUTPUT_WRITE
);

2931 
c
->
c1
.
°©us_ouçut_ow√d
 = 
åue
;

2933 
	}
}

2936 
	$do_˛o£_°©us_ouçut
 (
c⁄ãxt
 *
c
)

2938 i‡(!(
c
->
sig
->
sig«l_ª˚ived
 =
SIGUSR1
))

2940 i‡(
c
->
c1
.
°©us_ouçut_ow√d
 && c->c1.
°©us_ouçut
)

2942 
	`°©us_˛o£
 (
c
->
c1
.
°©us_ouçut
);

2943 
c
->
c1
.
°©us_ouçut
 = 
NULL
;

2944 
c
->
c1
.
°©us_ouçut_ow√d
 = 
Ál£
;

2947 
	}
}

2953 
	$do_›í_ifc⁄fig_poﬁ_≥rsi°
 (
c⁄ãxt
 *
c
)

2955 #i‡
P2MP_SERVER


2956 i‡(!
c
->
c1
.
ifc⁄fig_poﬁ_≥rsi°
 && c->
›ti⁄s
.
ifc⁄fig_poﬁ_≥rsi°_fûíame
)

2958 
c
->
c1
.
ifc⁄fig_poﬁ_≥rsi°
 = 
	`ifc⁄fig_poﬁ_≥rsi°_öô
 (c->
›ti⁄s
.
ifc⁄fig_poﬁ_≥rsi°_fûíame
,

2959 
c
->
›ti⁄s
.
ifc⁄fig_poﬁ_≥rsi°_ª‰esh_‰eq
);

2960 
c
->
c1
.
ifc⁄fig_poﬁ_≥rsi°_ow√d
 = 
åue
;

2963 
	}
}

2966 
	$do_˛o£_ifc⁄fig_poﬁ_≥rsi°
 (
c⁄ãxt
 *
c
)

2968 #i‡
P2MP_SERVER


2969 i‡(!(
c
->
sig
->
sig«l_ª˚ived
 =
SIGUSR1
))

2971 i‡(
c
->
c1
.
ifc⁄fig_poﬁ_≥rsi°
 && c->c1.
ifc⁄fig_poﬁ_≥rsi°_ow√d
)

2973 
	`ifc⁄fig_poﬁ_≥rsi°_˛o£
 (
c
->
c1
.
ifc⁄fig_poﬁ_≥rsi°
);

2974 
c
->
c1
.
ifc⁄fig_poﬁ_≥rsi°
 = 
NULL
;

2975 
c
->
c1
.
ifc⁄fig_poﬁ_≥rsi°_ow√d
 = 
Ál£
;

2979 
	}
}

2986 
	$do_öhîô_ív
 (
c⁄ãxt
 *
c
, c⁄° 
ív_£t
 *
§c
)

2988 
c
->
c2
.
es
 = 
	`ív_£t_¸óã
 (
NULL
);

2989 
c
->
c2
.
es_ow√d
 = 
åue
;

2990 
	`ív_£t_öhîô
 (
c
->
c2
.
es
, 
§c
);

2991 
	}
}

2994 
	$do_ív_£t_de°roy
 (
c⁄ãxt
 *
c
)

2996 i‡(
c
->
c2
.
es
 && c->c2.
es_ow√d
)

2998 
	`ív_£t_de°roy
 (
c
->
c2
.
es
);

2999 
c
->
c2
.
es
 = 
NULL
;

3000 
c
->
c2
.
es_ow√d
 = 
Ál£
;

3002 
	}
}

3013 
	$do_£tup_Á°_io
 (
c⁄ãxt
 *
c
)

3015 i‡(
c
->
›ti⁄s
.
Á°_io
)

3017 #ifde‡
WIN32


3018 
	`msg
 (
M_INFO
, "NOTE: --fast-io is disabled since weáreÑunning on Windows");

3020 i‡(!
	`¥Ÿo_is_udp
(
c
->
›ti⁄s
.
˚
.
¥Ÿo
))

3021 
	`msg
 (
M_INFO
, "NOTE: --fast-io is disabled since weáreÇot using UDP");

3024 #ifde‡
ENABLE_FEATURE_SHAPER


3025 i‡(
c
->
›ti⁄s
.
sh≠î
)

3026 
	`msg
 (
M_INFO
, "NOTE: --fast-io is disabled since weáre using --shaper");

3030 
c
->
c2
.
Á°_io
 = 
åue
;

3035 
	}
}

3038 
	$do_sig«l_⁄_és_îr‹s
 (
c⁄ãxt
 *
c
)

3040 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

3041 i‡(
c
->
›ti⁄s
.
és_exô
)

3042 
c
->
c2
.
és_exô_sig«l
 = 
SIGTERM
;

3044 
c
->
c2
.
és_exô_sig«l
 = 
SIGUSR1
;

3046 
	}
}

3048 #ifde‡
ENABLE_PLUGIN


3051 
	$öô_∂ugös
 (
c⁄ãxt
 *
c
)

3053 i‡(
c
->
›ti⁄s
.
∂ugö_li°
 && !c->
∂ugös
)

3055 
c
->
∂ugös
 = 
	`∂ugö_li°_öô
 (c->
›ti⁄s
.
∂ugö_li°
);

3056 
c
->
∂ugös_ow√d
 = 
åue
;

3058 
	}
}

3061 
	$›í_∂ugös
 (
c⁄ãxt
 *
c
, c⁄° 
boﬁ
 
imp‹t_›ti⁄s
, 
öô_poöt
)

3063 i‡(
c
->
∂ugös
 && c->
∂ugös_ow√d
)

3065 i‡(
imp‹t_›ti⁄s
)

3067 
∂ugö_ªtu∫
 
¥
, 
c⁄fig
;

3068 
	`∂ugö_ªtu∫_öô
 (&
¥
);

3069 
	`∂ugö_li°_›í
 (
c
->
∂ugös
, c->
›ti⁄s
.
∂ugö_li°
, &
¥
, c->
c2
.
es
, 
öô_poöt
);

3070 
	`∂ugö_ªtu∫_gë_cﬁumn
 (&
¥
, &
c⁄fig
, "config");

3071 i‡(
	`∂ugö_ªtu∫_deföed
 (&
c⁄fig
))

3073 
i
;

3074 
i
 = 0; i < 
c⁄fig
.
n
; ++i)

3076 
›ti⁄_ty≥s_found
 = 0;

3077 i‡(
c⁄fig
.
li°
[
i
] && c⁄fig.li°[i]->
vÆue
)

3078 
	`›ti⁄s_°rög_imp‹t
 (&
c
->
›ti⁄s
,

3079 
c⁄fig
.
li°
[
i
]->
vÆue
,

3080 
D_IMPORT_ERRORS
|
M_OPTERR
,

3081 
OPT_P_DEFAULT
 & ~
OPT_P_PLUGIN
,

3082 &
›ti⁄_ty≥s_found
,

3083 
c
->
es
);

3086 
	`∂ugö_ªtu∫_‰ì
 (&
¥
);

3090 
	`∂ugö_li°_›í
 (
c
->
∂ugös
, c->
›ti⁄s
.
∂ugö_li°
, 
NULL
, c->
c2
.
es
, 
öô_poöt
);

3093 
	}
}

3096 
	$do_˛o£_∂ugös
 (
c⁄ãxt
 *
c
)

3098 i‡(
c
->
∂ugös
 && c->
∂ugös_ow√d
 && !(c->
sig
->
sig«l_ª˚ived
 =
SIGUSR1
))

3100 
	`∂ugö_li°_˛o£
 (
c
->
∂ugös
);

3101 
c
->
∂ugös
 = 
NULL
;

3102 
c
->
∂ugös_ow√d
 = 
Ál£
;

3104 
	}
}

3107 
	$do_öhîô_∂ugös
 (
c⁄ãxt
 *
c
, c⁄° c⁄ãxà*
§c
)

3109 i‡(!
c
->
∂ugös
 && 
§c
->plugins)

3111 
c
->
∂ugös
 = 
	`∂ugö_li°_öhîô
 (
§c
->plugins);

3112 
c
->
∂ugös_ow√d
 = 
åue
;

3114 
	}
}

3118 #ifde‡
ENABLE_MANAGEMENT


3121 
	$m™agemít_ˇŒback_°©us_p2p
 (*
¨g
, c⁄° 
vîsi⁄
, 
°©us_ouçut
 *
so
)

3123 
c⁄ãxt
 *
c
 = (c⁄ãxà*Ë
¨g
;

3124 
	`¥öt_°©us
 (
c
, 
so
);

3125 
	}
}

3128 
	$m™agemít_show_√t_ˇŒback
 (*
¨g
, c⁄° 
msgÀvñ
)

3130 #ifde‡
WIN32


3131 
	`show_rouãs
 (
msgÀvñ
);

3132 
	`show_ad≠ãrs
 (
msgÀvñ
);

3133 
	`msg
 (
msgÀvñ
, "END");

3135 
	`msg
 (
msgÀvñ
, "ERROR: Sorry,Åhis command is currently only implemented on Windows");

3137 
	}
}

3142 
	$öô_m™agemít_ˇŒback_p2p
 (
c⁄ãxt
 *
c
)

3144 #ifde‡
ENABLE_MANAGEMENT


3145 i‡(
m™agemít
)

3147 
m™agemít_ˇŒback
 
cb
;

3148 
	`CLEAR
 (
cb
);

3149 
cb
.
¨g
 = 
c
;

3150 
cb
.
°©us
 = 
m™agemít_ˇŒback_°©us_p2p
;

3151 
cb
.
show_√t
 = 
m™agemít_show_√t_ˇŒback
;

3152 
cb
.
¥oxy_cmd
 = 
m™agemít_ˇŒback_¥oxy_cmd
;

3153 
cb
.
ªmŸe_cmd
 = 
m™agemít_ˇŒback_ªmŸe_cmd
;

3154 
	`m™agemít_£t_ˇŒback
 (
m™agemít
, &
cb
);

3157 
	}
}

3159 #ifde‡
ENABLE_MANAGEMENT


3162 
	$öô_m™agemít
 (
c⁄ãxt
 *
c
)

3164 i‡(!
m™agemít
)

3165 
m™agemít
 = 
	`m™agemít_öô
 ();

3166 
	}
}

3168 
boﬁ


3169 
	$›í_m™agemít
 (
c⁄ãxt
 *
c
)

3172 i‡(
m™agemít
)

3174 i‡(
c
->
›ti⁄s
.
m™agemít_addr
)

3176 
Êags
 = 
c
->
›ti⁄s
.
m™agemít_Êags
;

3177 i‡(
c
->
›ti⁄s
.
mode
 =
MODE_SERVER
)

3178 
Êags
 |
MF_SERVER
;

3179 i‡(
	`m™agemít_›í
 (
m™agemít
,

3180 
c
->
›ti⁄s
.
m™agemít_addr
,

3181 
c
->
›ti⁄s
.
m™agemít_p‹t
,

3182 
c
->
›ti⁄s
.
m™agemít_u£r_∑ss
,

3183 
c
->
›ti⁄s
.
m™agemít_˛õ¡_u£r
,

3184 
c
->
›ti⁄s
.
m™agemít_˛õ¡_group
,

3185 
c
->
›ti⁄s
.
m™agemít_log_hi°‹y_ˇche
,

3186 
c
->
›ti⁄s
.
m™agemít_echo_buf„r_size
,

3187 
c
->
›ti⁄s
.
m™agemít_°©e_buf„r_size
,

3188 
c
->
›ti⁄s
.
m™agemít_wrôe_≥î_öfo_fûe
,

3189 
c
->
›ti⁄s
.
ªm≠_sigu§1
,

3190 
Êags
))

3192 
	`m™agemít_£t_°©e
 (
m™agemít
,

3193 
OPENVPN_STATE_CONNECTING
,

3194 
NULL
,

3195 (
ö_addr_t
)0,

3196 (
ö_addr_t
)0);

3200 
	`do_hﬁd
 (
c
);

3201 i‡(
	`IS_SIG
 (
c
))

3203 
	`msg
 (
M_WARN
, "SignalÑeceived from management interface,Éxiting");

3204  
Ál£
;

3208 
	`˛o£_m™agemít
 ();

3210  
åue
;

3211 
	}
}

3214 
	$˛o£_m™agemít
 ()

3216 i‡(
m™agemít
)

3218 
	`m™agemít_˛o£
 (
m™agemít
);

3219 
m™agemít
 = 
NULL
;

3221 
	}
}

3227 
	$unöô_m™agemít_ˇŒback
 ()

3229 #ifde‡
ENABLE_MANAGEMENT


3230 i‡(
m™agemít
)

3232 
	`m™agemít_˛ór_ˇŒback
 (
m™agemít
);

3235 
	}
}

3242 
	$öô_ö°™˚_h™dÀ_sig«ls
 (
c⁄ãxt
 *
c
, c⁄° 
ív_£t
 *
ív
, c⁄° 
Êags
)

3244 
	`¥e_öô_sig«l_ˇtch
 ();

3245 
	`öô_ö°™˚
 (
c
, 
ív
, 
Êags
);

3246 
	`po°_öô_sig«l_ˇtch
 ();

3253 i‡(
	`IS_SIG
 (
c
))

3255 
	`ªm≠_sig«l
 (
c
);

3256 
	`unöô_m™agemít_ˇŒback
 ();

3258 
	}
}

3264 
	$öô_ö°™˚
 (
c⁄ãxt
 *
c
, c⁄° 
ív_£t
 *
ív
, c⁄° 
Êags
)

3266 c⁄° 
›ti⁄s
 *›ti⁄†&
c
->options;

3267 c⁄° 
boﬁ
 
chûd
 = (
c
->
mode
 =
CM_CHILD_TCP
 || c->modê=
CM_CHILD_UDP
);

3268 
lök_sockë_mode
 = 
LS_MODE_DEFAULT
;

3271 
	`gc_öô
 (&
c
->
c2
.
gc
);

3274 
c
->
sig
->
sig«l_ª˚ived
 = 0;

3275 
c
->
sig
->
sig«l_ãxt
 = 
NULL
;

3276 
c
->
sig
->
h¨d
 = 
Ál£
;

3278 i‡(
c
->
mode
 =
CM_P2P
)

3279 
	`öô_m™agemít_ˇŒback_p2p
 (
c
);

3282 i‡(
c
->
mode
 =
CM_P2P
 || c->modê=
CM_TOP
)

3284 
	`do_°¨tup_∑u£
 (
c
);

3285 i‡(
	`IS_SIG
 (
c
))

3286 
sig
;

3290 
	`√xt_c⁄√˘i⁄_íåy
 (
c
);

3295 i‡(
c
->
›ti⁄s
.
˚
.
¥Ÿo
 =
PROTO_TCPv4_SERVER


3296 || 
c
->
›ti⁄s
.
˚
.
¥Ÿo
 =
PROTO_TCPv6_SERVER
)

3298 i‡(
c
->
mode
 =
CM_TOP
)

3299 
lök_sockë_mode
 = 
LS_MODE_TCP_LISTEN
;

3300 i‡(
c
->
mode
 =
CM_CHILD_TCP
)

3301 
lök_sockë_mode
 = 
LS_MODE_TCP_ACCEPT_FROM
;

3305 i‡(
c
->
fú°_time
 && 
›ti⁄s
->
mlock
)

3306 
	`∂©f‹m_mlockÆl
 (
åue
);

3308 #i‡
P2MP


3310 i‡(
	`auth_ªåy_gë
 (Ë=
AR_INTERACT
)

3311 
	`öô_quîy_∑ssw‹ds
 (
c
);

3315 
	`öô_vîb_muã
 (
c
, 
IVM_LEVEL_2
);

3318 i‡(
c
->
mode
 =
CM_P2P
)

3319 
	`£t_check_°©us_îr‹_dñay
 (
P2P_ERROR_DELAY_MS
);

3322 i‡(
c
->
mode
 =
CM_P2P
 || c->modê=
CM_TOP
)

3323 
	`do_›ti⁄_w¨nögs
 (
c
);

3326 i‡(
ív
)

3327 
	`do_öhîô_ív
 (
c
, 
ív
);

3329 #ifde‡
ENABLE_PLUGIN


3331 i‡(
c
->
mode
 =
CM_P2P
 || c->modê=
CM_TOP
)

3332 
	`›í_∂ugös
 (
c
, 
Ál£
, 
OPENVPN_PLUGIN_INIT_PRE_DAEMON
);

3336 i‡(
c
->
mode
 =
CM_P2P
 || c->modê=
CM_TOP
)

3337 
	`do_£tup_Á°_io
 (
c
);

3340 
	`do_sig«l_⁄_és_îr‹s
 (
c
);

3343 i‡(
c
->
mode
 =
CM_P2P
 || c->modê=
CM_TOP
)

3344 
	`do_›í_°©us_ouçut
 (
c
);

3347 i‡(
c
->
mode
 =
CM_TOP
)

3348 
	`do_›í_ifc⁄fig_poﬁ_≥rsi°
 (
c
);

3350 #ifde‡
ENABLE_OCC


3352 i‡(
c
->
mode
 =
CM_P2P
 || 
chûd
)

3353 
c
->
c2
.
occ_›
 = 
	`occ_ª£t_›
 ();

3357 i‡(
c
->
mode
 =
CM_P2P
)

3358 
	`do_evít_£t_öô
 (
c
, 
	`SHAPER_DEFINED
 (&c->
›ti⁄s
));

3359 i‡(
c
->
mode
 =
CM_CHILD_TCP
)

3360 
	`do_evít_£t_öô
 (
c
, 
Ál£
);

3363 
	`öô_¥oxy
 (
c
, 2);

3366 i‡(
c
->
mode
 =
CM_P2P
 || c->modê=
CM_TOP
 || c->modê=
CM_CHILD_TCP
)

3367 
	`do_lök_sockë_√w
 (
c
);

3369 #ifde‡
ENABLE_FRAGMENT


3371 i‡(
›ti⁄s
->
˚
.
‰agmít
 && (
c
->
mode
 =
CM_P2P
 || 
chûd
))

3372 
c
->
c2
.
‰agmít
 = 
	`‰agmít_öô
 (&c->c2.
‰ame
);

3377 
¸y±o_Êags
 = 0;

3378 i‡(
c
->
mode
 =
CM_TOP
)

3379 
¸y±o_Êags
 = 
CF_INIT_TLS_AUTH_STANDALONE
;

3380 i‡(
c
->
mode
 =
CM_P2P
)

3381 
¸y±o_Êags
 = 
CF_LOAD_PERSISTED_PACKET_ID
 | 
CF_INIT_TLS_MULTI
;

3382 i‡(
chûd
)

3383 
¸y±o_Êags
 = 
CF_INIT_TLS_MULTI
;

3384 
	`do_öô_¸y±o
 (
c
, 
¸y±o_Êags
);

3385 i‡(
	`IS_SIG
 (
c
Ë&& !
chûd
)

3386 
sig
;

3389 #ifde‡
ENABLE_LZO


3391 i‡((
›ti⁄s
->
lzo
 & 
LZO_SELECTED
Ë&& (
c
->
mode
 =
CM_P2P
 || 
chûd
))

3392 
	`lzo_com¥ess_öô
 (&
c
->
c2
.
lzo_compw‹k
, 
›ti⁄s
->
lzo
);

3396 
	`do_öô_‰ame
 (
c
);

3399 
	`do_öô_‰ame_és
 (
c
);

3402 i‡(
c
->
mode
 =
CM_P2P
 || c->modê=
CM_CHILD_TCP
)

3403 
	`do_öô_buf„rs
 (
c
);

3405 #ifde‡
ENABLE_FRAGMENT


3407 i‡(
›ti⁄s
->
˚
.
‰agmít
 && (
c
->
mode
 =
CM_P2P
 || 
chûd
))

3408 
	`do_öô_‰agmít
 (
c
);

3412 
	`do_öô_mssfix
 (
c
);

3415 i‡(
c
->
mode
 =
CM_P2P
 || c->modê=
CM_TOP
 || c->modê=
CM_CHILD_TCP
)

3416 
	`do_öô_sockë_1
 (
c
, 
lök_sockë_mode
);

3420 i‡(!(
›ti⁄s
->
up_dñay
 || 
	`PULL_DEFINED
 (›ti⁄s)Ë&& (
c
->
mode
 =
CM_P2P
 || c->modê=
CM_TOP
))

3421 
c
->
c2
.
did_›í_tun
 = 
	`do_›í_tun
 (c);

3424 
	`do_¥öt_d©a_ch™√l_mtu_∑rms
 (
c
);

3426 #ifde‡
ENABLE_OCC


3428 i‡(
c
->
mode
 =
CM_P2P
 || 
chûd
)

3429 
	`do_compuã_occ_°rögs
 (
c
);

3433 i‡(
c
->
mode
 =
CM_P2P
)

3434 
	`do_öô_åaffic_sh≠î
 (
c
);

3437 
	`do_öô_fú°_time
 (
c
);

3439 #ifde‡
ENABLE_PLUGIN


3441 i‡(
c
->
mode
 =
CM_P2P
 || c->modê=
CM_TOP
)

3442 
	`›í_∂ugös
 (
c
, 
Ál£
, 
OPENVPN_PLUGIN_INIT_POST_DAEMON
);

3449 
	`do_uid_gid_chroŸ
 (
c
, c->
c2
.
did_›í_tun
);

3452 i‡(
c
->
mode
 =
CM_P2P
 || c->modê=
CM_TOP
 || c->modê=
CM_CHILD_TCP
)

3453 
	`do_öô_sockë_2
 (
c
);

3456 i‡(
c
->
mode
 =
CM_P2P
 || 
chûd
)

3457 
	`do_öô_timîs
 (
c
, 
Ál£
);

3459 #ifde‡
ENABLE_PLUGIN


3461 i‡(
c
->
mode
 =
CM_P2P
 || c->modê=
CM_TOP
)

3462 
	`›í_∂ugös
 (
c
, 
Ál£
, 
OPENVPN_PLUGIN_INIT_POST_UID_CHANGE
);

3465 #i‡
PORT_SHARE


3467 i‡(
c
->
fú°_time
 && (c->
mode
 =
CM_P2P
 || c->modê=
CM_TOP
))

3468 
	`öô_p‹t_sh¨e
 (
c
);

3471 #ifde‡
ENABLE_PF


3472 i‡(
chûd
)

3473 
	`pf_öô_c⁄ãxt
 (
c
);

3477 i‡(
	`IS_SIG
 (
c
))

3478 
sig
;

3482 
sig
:

3483 i‡(!
c
->
sig
->
sig«l_ãxt
)

3484 
c
->
sig
->
sig«l_ãxt
 = "init_instance";

3485 
	`˛o£_c⁄ãxt
 (
c
, -1, 
Êags
);

3487 
	}
}

3493 
	$˛o£_ö°™˚
 (
c⁄ãxt
 *
c
)

3496 
	`do_˛o£_evít_£t
 (
c
);

3498 i‡(
c
->
mode
 =
CM_P2P


3499 || 
c
->
mode
 =
CM_CHILD_TCP


3500 || 
c
->
mode
 =
CM_CHILD_UDP


3501 || 
c
->
mode
 =
CM_TOP
)

3504 
	`do_˛o£_check_if_ª°¨t_≥rmôãd
 (
c
);

3506 #ifde‡
ENABLE_LZO


3507 i‡(
	`lzo_deföed
 (&
c
->
c2
.
lzo_compw‹k
))

3508 
	`lzo_com¥ess_unöô
 (&
c
->
c2
.
lzo_compw‹k
);

3512 
	`do_˛o£_‰ì_buf
 (
c
);

3515 
	`do_˛o£_és
 (
c
);

3518 
	`do_˛o£_‰ì_key_scheduÀ
 (
c
, (c->
mode
 =
CM_P2P
 || c->modê=
CM_TOP
));

3521 
	`do_˛o£_lök_sockë
 (
c
);

3524 
	`do_˛o£_tun
 (
c
, 
Ál£
);

3526 #ifde‡
MANAGEMENT_DEF_AUTH


3527 i‡(
m™agemít
)

3528 
	`m™agemít_nŸify_˛õ¡_˛o£
 (
m™agemít
, &
c
->
c2
.
mda_c⁄ãxt
, 
NULL
);

3531 #ifde‡
ENABLE_PF


3532 
	`pf_de°roy_c⁄ãxt
 (&
c
->
c2
.
pf
);

3535 #ifde‡
ENABLE_PLUGIN


3537 
	`do_˛o£_∂ugös
 (
c
);

3541 
	`do_˛o£_∑ckë_id
 (
c
);

3544 
	`do_˛o£_°©us_ouçut
 (
c
);

3546 #ifde‡
ENABLE_FRAGMENT


3548 
	`do_˛o£_‰agmít
 (
c
);

3552 
	`do_˛o£_ifc⁄fig_poﬁ_≥rsi°
 (
c
);

3555 
	`do_ív_£t_de°roy
 (
c
);

3558 
	`unöô_¥oxy
 (
c
);

3561 
	`gc_‰ì
 (&
c
->
c2
.
gc
);

3563 
	}
}

3566 
	$öhîô_c⁄ãxt_chûd
 (
c⁄ãxt
 *
de°
,

3567 c⁄° 
c⁄ãxt
 *
§c
)

3569 
	`CLEAR
 (*
de°
);

3572 
de°
->
mode
 = 
	`¥Ÿo_is_dgøm
(
§c
->
›ti⁄s
.
˚
.
¥Ÿo
)? 
CM_CHILD_UDP
 : 
CM_CHILD_TCP
;

3574 
de°
->
gc
 = 
	`gc_√w
 ();

3576 
	`ALLOC_OBJ_CLEAR_GC
 (
de°
->
sig
, 
sig«l_öfo
, &de°->
gc
);

3579 
	`∑ckë_id_≥rsi°_öô
 (&
de°
->
c1
.
pid_≥rsi°
);

3581 #ifde‡
ENABLE_CRYPTO


3582 
de°
->
c1
.
ks
.
key_ty≥
 = 
§c
->c1.ks.key_type;

3583 #ifde‡
ENABLE_SSL


3585 
de°
->
c1
.
ks
.
s¶_˘x
 = 
§c
->c1.ks.ssl_ctx;

3586 
de°
->
c1
.
ks
.
és_auth_key
 = 
§c
->c1.ks.tls_auth_key;

3591 
de°
->
›ti⁄s
 = 
§c
->options;

3592 
	`›ti⁄s_dëach
 (&
de°
->
›ti⁄s
);

3594 i‡(
de°
->
mode
 =
CM_CHILD_TCP
)

3600 
de°
->
c2
.
ac˚±_‰om
 = 
§c
->c2.
lök_sockë
;

3603 #ifde‡
ENABLE_PLUGIN


3605 
	`do_öhîô_∂ugös
 (
de°
, 
§c
);

3609 
	`öô_ö°™˚
 (
de°
, 
§c
->
c2
.
es
, 
CC_NO_CLOSE
 | 
CC_USR1_TO_HUP
);

3610 i‡(
	`IS_SIG
 (
de°
))

3614 
de°
->
c1
.
tu¡≠
 = 
§c
->c1.tuntap;

3617 i‡(
de°
->
mode
 =
CM_CHILD_UDP
)

3620 
de°
->
c2
.
buf„rs
 = 
§c
->c2.buffers;

3623 
de°
->
c2
.
lök_sockë
 = 
§c
->c2.link_socket;

3625 
	`ALLOC_OBJ_GC
 (
de°
->
c2
.
lök_sockë_öfo
, lök_sockë_öfo, &de°->
gc
);

3626 *
de°
->
c2
.
lök_sockë_öfo
 = 
§c
->c2.
lök_sockë
->
öfo
;

3629 
de°
->
c2
.
lök_sockë_öfo
->
lß
 = &de°->
c1
.
lök_sockë_addr
;

3630 
de°
->
c2
.
lök_sockë_öfo
->
c⁄√˘i⁄_e°ablished
 = 
Ál£
;

3632 
	}
}

3635 
	$öhîô_c⁄ãxt_t›
 (
c⁄ãxt
 *
de°
,

3636 c⁄° 
c⁄ãxt
 *
§c
)

3639 *
de°
 = *
§c
;

3648 
de°
->
mode
 = 
CM_TOP_CLONE
;

3650 
de°
->
fú°_time
 = 
Ál£
;

3651 
de°
->
c0
 = 
NULL
;

3653 
	`›ti⁄s_dëach
 (&
de°
->
›ti⁄s
);

3654 
	`gc_dëach
 (&
de°
->
gc
);

3655 
	`gc_dëach
 (&
de°
->
c2
.
gc
);

3658 
de°
->
∂ugös_ow√d
 = 
Ál£
;

3660 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

3661 
de°
->
c2
.
és_mu…i
 = 
NULL
;

3665 
de°
->
c1
.
tu¡≠_ow√d
 = 
Ál£
;

3666 
de°
->
c1
.
°©us_ouçut_ow√d
 = 
Ál£
;

3667 #i‡
P2MP_SERVER


3668 
de°
->
c1
.
ifc⁄fig_poﬁ_≥rsi°_ow√d
 = 
Ál£
;

3672 
de°
->
c2
.
evít_£t_ow√d
 = 
Ál£
;

3673 
de°
->
c2
.
lök_sockë_ow√d
 = 
Ál£
;

3674 
de°
->
c2
.
buf„rs_ow√d
 = 
Ál£
;

3675 
de°
->
c2
.
es_ow√d
 = 
Ál£
;

3677 
de°
->
c2
.
evít_£t
 = 
NULL
;

3678 i‡(
	`¥Ÿo_is_dgøm
(
§c
->
›ti⁄s
.
˚
.
¥Ÿo
))

3679 
	`do_evít_£t_öô
 (
de°
, 
Ál£
);

3680 
	}
}

3683 
	$˛o£_c⁄ãxt
 (
c⁄ãxt
 *
c
, 
sig
, 
Êags
)

3685 
	`ASSERT
 (
c
);

3686 
	`ASSERT
 (
c
->
sig
);

3688 i‡(
sig
 >= 0)

3689 
c
->
sig
->
sig«l_ª˚ived
 = sig;

3691 i‡(
c
->
sig
->
sig«l_ª˚ived
 =
SIGUSR1
)

3693 i‡((
Êags
 & 
CC_USR1_TO_HUP
)

3694 || (
c
->
sig
->
h¨d
 && (
Êags
 & 
CC_HARD_USR1_TO_HUP
)))

3695 
c
->
sig
->
sig«l_ª˚ived
 = 
SIGHUP
;

3698 i‡(!(
Êags
 & 
CC_NO_CLOSE
))

3699 
	`˛o£_ö°™˚
 (
c
);

3701 i‡(
Êags
 & 
CC_GC_FREE
)

3702 
	`c⁄ãxt_gc_‰ì
 (
c
);

3703 
	}
}

3705 #ifde‡
ENABLE_CRYPTO


3712 
	$ã°_¸y±o_thªad
 (*
¨g
)

3714 
c⁄ãxt
 *
c
 = (c⁄ãxà*Ë
¨g
;

3715 c⁄° 
›ti⁄s
 *›ti⁄†&
c
->options;

3717 
	`ASSERT
 (
›ti⁄s
->
ã°_¸y±o
);

3718 
	`öô_vîb_muã
 (
c
, 
IVM_LEVEL_1
);

3719 
	`c⁄ãxt_öô_1
 (
c
);

3720 
	`do_öô_¸y±o_°©ic
 (
c
, 0);

3722 
	`‰ame_föÆize_›ti⁄s
 (
c
, 
›ti⁄s
);

3724 
	`ã°_¸y±o
 (&
c
->
c2
.
¸y±o_›ti⁄s
, &c->c2.
‰ame
);

3726 
	`key_scheduÀ_‰ì
 (&
c
->
c1
.
ks
, 
åue
);

3727 
	`∑ckë_id_‰ì
 (&
c
->
c2
.
∑ckë_id
);

3729 
	`c⁄ãxt_gc_‰ì
 (
c
);

3730  
NULL
;

3731 
	}
}

3735 
boﬁ


3736 
	$do_ã°_¸y±o
 (c⁄° 
›ti⁄s
 *
o
)

3738 #ifde‡
ENABLE_CRYPTO


3739 i‡(
o
->
ã°_¸y±o
)

3741 
c⁄ãxt
 
c
;

3744 
	`msg
 (
M_INFO
, "%s", 
tôÀ_°rög
);

3746 
	`c⁄ãxt_˛ór
 (&
c
);

3747 
c
.
›ti⁄s
 = *
o
;

3748 
	`›ti⁄s_dëach
 (&
c
.
›ti⁄s
);

3749 
c
.
fú°_time
 = 
åue
;

3750 
	`ã°_¸y±o_thªad
 ((*Ë&
c
);

3751  
åue
;

3754  
Ál£
;

3755 
	}
}

	@src/openvpn/init.h

25 #i‚de‡
INIT_H


26 
	#INIT_H


	)

28 
	~"›ív≤.h
"

34 
	#BASE_N_EVENTS
 4

	)

36 
c⁄ãxt_˛ór
 (
c⁄ãxt
 *
c
);

37 
c⁄ãxt_˛ór_1
 (
c⁄ãxt
 *
c
);

38 
c⁄ãxt_˛ór_2
 (
c⁄ãxt
 *
c
);

39 
c⁄ãxt_öô_1
 (
c⁄ãxt
 *
c
);

40 
c⁄ãxt_˛ór_Æl_ex˚±_fú°_time
 (
c⁄ãxt
 *
c
);

42 
boﬁ
 
öô_°©ic
 ();

44 
unöô_°©ic
 ();

46 
	#IVM_LEVEL_1
 (1<<0)

	)

47 
	#IVM_LEVEL_2
 (1<<1)

	)

48 
öô_vîb_muã
 (
c⁄ãxt
 *
c
, 
Êags
);

50 
öô_›ti⁄s_dev
 (
›ti⁄s
 *options);

52 
boﬁ
 
¥öt_›ís¶_öfo
 (c⁄° 
›ti⁄s
 *options);

54 
boﬁ
 
do_gíkey
 (c⁄° 
›ti⁄s
 *options);

56 
boﬁ
 
do_≥rsi°_tu¡≠
 (c⁄° 
›ti⁄s
 *options);

58 
¥e_£tup
 (c⁄° 
›ti⁄s
 *options);

60 
öô_ö°™˚_h™dÀ_sig«ls
 (
c⁄ãxt
 *
c
, c⁄° 
ív_£t
 *
ív
, c⁄° 
Êags
);

62 
öô_ö°™˚
 (
c⁄ãxt
 *
c
, c⁄° 
ív_£t
 *
ív
, c⁄° 
Êags
);

64 
do_rouã
 (c⁄° 
›ti⁄s
 *options,

65 
rouã_li°
 *route_list,

66 
rouã_ùv6_li°
 *route_ipv6_list,

67 c⁄° 
tu¡≠
 *
â
,

68 c⁄° 
∂ugö_li°
 *
∂ugös
,

69 
ív_£t
 *
es
);

71 
˛o£_ö°™˚
 (
c⁄ãxt
 *
c
);

73 
boﬁ
 
do_ã°_¸y±o
 (c⁄° 
›ti⁄s
 *
o
);

75 
c⁄ãxt_gc_‰ì
 (
c⁄ãxt
 *
c
);

77 
do_up
 (
c⁄ãxt
 *
c
,

78 
boﬁ
 
puŒed_›ti⁄s
,

79 
›ti⁄_ty≥s_found
);

81 
puŒ_≥rmissi⁄_mask
 (c⁄° 
c⁄ãxt
 *
c
);

83 c⁄° *
f‹m©_comm⁄_«me
 (
c⁄ãxt
 *
c
, 
gc_¨ía
 *
gc
);

85 
ª£t_cﬂr£_timîs
 (
c⁄ãxt
 *
c
);

87 
do_de„ºed_›ti⁄s
 (
c⁄ãxt
 *
c
, c⁄° 
found
);

89 
öhîô_c⁄ãxt_chûd
 (
c⁄ãxt
 *
de°
,

90 c⁄° 
c⁄ãxt
 *
§c
);

92 
öhîô_c⁄ãxt_t›
 (
c⁄ãxt
 *
de°
,

93 c⁄° 
c⁄ãxt
 *
§c
);

95 
	#CC_GC_FREE
 (1<<0)

	)

96 
	#CC_USR1_TO_HUP
 (1<<1)

	)

97 
	#CC_HARD_USR1_TO_HUP
 (1<<2)

	)

98 
	#CC_NO_CLOSE
 (1<<3)

	)

100 
˛o£_c⁄ãxt
 (
c⁄ãxt
 *
c
, 
sig
, 
Êags
);

102 
c⁄ãxt_buf„rs
 *
öô_c⁄ãxt_buf„rs
 (c⁄° 
‰ame
 *frame);

104 
‰ì_c⁄ãxt_buf„rs
 (
c⁄ãxt_buf„rs
 *
b
);

106 
	#ISC_ERRORS
 (1<<0)

	)

107 
	#ISC_SERVER
 (1<<1)

	)

108 
öôüliz©i⁄_£quí˚_com∂ëed
 (
c⁄ãxt
 *
c
, c⁄° 
Êags
);

110 #ifde‡
ENABLE_MANAGEMENT


112 
öô_m™agemít
 (
c⁄ãxt
 *
c
);

113 
boﬁ
 
›í_m™agemít
 (
c⁄ãxt
 *
c
);

114 
˛o£_m™agemít
 ();

116 
m™agemít_show_√t_ˇŒback
 (*
¨g
, c⁄° 
msgÀvñ
);

120 
öô_m™agemít_ˇŒback_p2p
 (
c⁄ãxt
 *
c
);

121 
unöô_m™agemít_ˇŒback
 ();

123 #ifde‡
ENABLE_PLUGIN


124 
öô_∂ugös
 (
c⁄ãxt
 *
c
);

125 
›í_∂ugös
 (
c⁄ãxt
 *
c
, c⁄° 
boﬁ
 
imp‹t_›ti⁄s
, 
öô_poöt
);

	@src/openvpn/integer.h

25 #i‚de‡
INTEGER_H


26 
	#INTEGER_H


	)

28 
	~"îr‹.h
"

34 
ölöe
 

35 
	$max_öt
 (
x
, 
y
)

37 i‡(
x
 > 
y
)

38  
x
;

40  
y
;

41 
	}
}

43 
ölöe
 

44 
	$mö_öt
 (
x
, 
y
)

46 i‡(
x
 < 
y
)

47  
x
;

49  
y
;

50 
	}
}

52 
ölöe
 

53 
	$c⁄°øö_öt
 (
x
, 
mö
, 
max
)

55 i‡(
mö
 > 
max
)

56  
mö
;

57 i‡(
x
 < 
mö
)

58  
mö
;

59 i‡(
x
 > 
max
)

60  
max
;

62  
x
;

63 
	}
}

75 
ölöe
 

76 
	$modulo_subåa˘
(
x
, 
y
, 
mod
)

78 c⁄° 
d1
 = 
x
 - 
y
;

79 c⁄° 
d2
 = (
x
 > 
y
 ? -
mod
 : modË+ 
d1
;

80 
	`ASSERT
 (0 <
x
 && x < 
mod
 && 0 <
y
 && y < mod);

81  
	`abs
(
d1
Ë>ábs(
d2
) ? d2 : d1;

82 
	}
}

90 
ölöe
 

91 
	$modulo_add
(
x
, 
y
, 
mod
)

93 
sum
 = 
x
 + 
y
;

94 
	`ASSERT
 (0 <
x
 && x < 
mod
 && -mod <
y
 && y <= mod);

95 i‡(
sum
 >
mod
)

96 
sum
 -
mod
;

97 i‡(
sum
 < 0)

98 
sum
 +
mod
;

99  
sum
;

100 
	}
}

102 
ölöe
 

103 
	$ödex_vîify
 (
ödex
, 
size
, c⁄° *
fûe
, 
löe
)

105 i‡(
ödex
 < 0 || index >
size
)

106 
	`msg
 (
M_FATAL
, "Assertion Failed: Array index=%d out of bounds forárray size=%d in %s:%d",

107 
ödex
,

108 
size
,

109 
fûe
,

110 
löe
);

111  
ödex
;

112 
	}
}

	@src/openvpn/interval.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"öãrvÆ.h
"

35 
	~"memdbg.h
"

38 
	$öãrvÆ_öô
 (
öãrvÆ
 *
t›
, 
h‹iz⁄
, 
ª‰esh
)

40 
	`CLEAR
 (*
t›
);

41 
t›
->
ª‰esh
 =Ñefresh;

42 
t›
->
h‹iz⁄
 = horizon;

43 
	}
}

45 
boﬁ


46 
	$evít_timeout_åiggî
 (
evít_timeout
 *
ë
,

47 
timevÆ
 *
tv
,

48 c⁄° 
ë_c⁄°_ªåy
)

50 
boﬁ
 
ªt
 = 
Ál£
;

51 c⁄° 
time_t
 
loˇl_now
 = 
now
;

53 i‡(
ë
->
deföed
)

55 
wakeup
 = (Ë
ë
->
œ°
 +Ét->
n
 - 
loˇl_now
;

56 i‡(
wakeup
 <= 0)

58 #i‡
INTERVAL_DEBUG


59 
	`dmsg
 (
D_INTERVAL
, "EVENTÉvít_timeout_åiggî (%dËë¸=%d", 
ë
->
n
, 
ë_c⁄°_ªåy
);

61 i‡(
ë_c⁄°_ªåy
 < 0)

63 
ë
->
œ°
 = 
loˇl_now
;

64 
wakeup
 = 
ë
->
n
;

65 
ªt
 = 
åue
;

69 
wakeup
 = 
ë_c⁄°_ªåy
;

73 i‡(
tv
 && 
wakeup
 <Åv->
tv_£c
)

75 #i‡
INTERVAL_DEBUG


76 
	`dmsg
 (
D_INTERVAL
, "EVENTÉvít_timeout_wakeu∞(%d/%dËë¸=%d", 
wakeup
, 
ë
->
n
, 
ë_c⁄°_ªåy
);

78 
tv
->
tv_£c
 = 
wakeup
;

79 
tv
->
tv_u£c
 = 0;

82  
ªt
;

83 
	}
}

	@src/openvpn/interval.h

31 #i‚de‡
INTERVAL_H


32 
	#INTERVAL_H


	)

34 
	~"Ÿime.h
"

36 
	#INTERVAL_DEBUG
 0

	)

43 
	söãrvÆ


45 
öãrvÆ_t
 
	mª‰esh
;

46 
öãrvÆ_t
 
	mh‹iz⁄
;

47 
time_t
 
	mfutuª_åiggî
;

48 
time_t
 
	mœ°_a˘i⁄
;

49 
time_t
 
	mœ°_ã°_åue
;

52 
öãrvÆ_öô
 (
öãrvÆ
 *
t›
, 
h‹iz⁄
, 
ª‰esh
);

66 
ölöe
 
boﬁ


67 
	$öãrvÆ_ã°
 (
öãrvÆ
* 
t›
)

69 
boﬁ
 
åiggî
 = 
Ál£
;

70 c⁄° 
time_t
 
loˇl_now
 = 
now
;

72 i‡(
t›
->
futuª_åiggî
 && 
loˇl_now
 >=Åop->future_trigger)

74 
åiggî
 = 
åue
;

75 
t›
->
futuª_åiggî
 = 0;

78 i‡(
t›
->
œ°_a˘i⁄
 +Å›->
h‹iz⁄
 > 
loˇl_now
 ||

79 
t›
->
œ°_ã°_åue
 +Å›->
ª‰esh
 <
loˇl_now
 ||

80 
åiggî
)

82 
t›
->
œ°_ã°_åue
 = 
loˇl_now
;

83 #i‡
INTERVAL_DEBUG


84 
	`dmsg
 (
D_INTERVAL
, "INTERVAL interval_testÅrue");

86  
åue
;

90  
Ál£
;

92 
	}
}

94 
ölöe
 

95 
	$öãrvÆ_scheduÀ_wakeup
 (
öãrvÆ
* 
t›
, 
öãrvÆ_t
 *
wakeup
)

97 c⁄° 
time_t
 
loˇl_now
 = 
now
;

98 
	`öãrvÆ_óæõ°_wakeup
 (
wakeup
, 
t›
->
œ°_ã°_åue
 +Å›->
ª‰esh
, 
loˇl_now
);

99 
	`öãrvÆ_óæõ°_wakeup
 (
wakeup
, 
t›
->
futuª_åiggî
, 
loˇl_now
);

100 #i‡
INTERVAL_DEBUG


101 
	`dmsg
 (
D_INTERVAL
, "INTERVAL i¡îvÆ_scheduÀ wakeup=%d", ()*
wakeup
);

103 
	}
}

108 
ölöe
 

109 
	$öãrvÆ_futuª_åiggî
 (
öãrvÆ
* 
t›
, 
öãrvÆ_t
 
wakeup
) {

110 i‡(
wakeup
)

112 #i‡
INTERVAL_DEBUG


113 
	`dmsg
 (
D_INTERVAL
, "INTERVAL i¡îvÆ_futuª_åiggî %d", ()
wakeup
);

115 
t›
->
futuª_åiggî
 = 
now
 + 
wakeup
;

117 
	}
}

123 
ölöe
 

124 
	$öãrvÆ_a˘i⁄
 (
öãrvÆ
* 
t›
)

126 #i‡
INTERVAL_DEBUG


127 
	`dmsg
 (
D_INTERVAL
, "INTERVALáction");

129 
t›
->
œ°_a˘i⁄
 = 
now
;

130 
	}
}

136 
	sevít_timeout


138 
boﬁ
 
	mdeföed
;

139 
öãrvÆ_t
 
	mn
;

140 
time_t
 
	mœ°
;

143 
ölöe
 
boﬁ


144 
	$evít_timeout_deföed
 (c⁄° 
evít_timeout
* 
ë
)

146  
ë
->
deföed
;

147 
	}
}

149 
ölöe
 

150 
	$evít_timeout_˛ór
 (
evít_timeout
* 
ë
)

152 
ë
->
deföed
 = 
Ál£
;

153 
ë
->
n
 = 0;

154 
ë
->
œ°
 = 0;

155 
	}
}

157 
ölöe
 
evít_timeout


158 
	$evít_timeout_˛ór_ªt
 ()

160 
evít_timeout
 
ªt
;

161 
	`evít_timeout_˛ór
 (&
ªt
);

162  
ªt
;

163 
	}
}

165 
ölöe
 

166 
	$evít_timeout_öô
 (
evít_timeout
* 
ë
, 
öãrvÆ_t
 
n
, c⁄° 
time_t
 
loˇl_now
)

168 
ë
->
deföed
 = 
åue
;

169 
ë
->
n
 = (n >= 0) ?Ç : 0;

170 
ë
->
œ°
 = 
loˇl_now
;

171 
	}
}

173 
ölöe
 

174 
	$evít_timeout_ª£t
 (
evít_timeout
* 
ë
)

176 i‡(
ë
->
deföed
)

177 
ë
->
œ°
 = 
now
;

178 
	}
}

180 
ölöe
 

181 
	$evít_timeout_modify_wakeup
 (
evít_timeout
* 
ë
, 
öãrvÆ_t
 
n
)

184 i‡(
ë
->
deföed
)

185 
ë
->
n
 = (n >= 0) ?Ç : 0;

186 
	}
}

199 
	#ETT_DEFAULT
 (-1)

	)

201 
boﬁ
 
evít_timeout_åiggî
 (
evít_timeout
 *
ë
,

202 
timevÆ
 *
tv
,

203 c⁄° 
ë_c⁄°_ªåy
);

209 
	#USEC_TIMER_MAX
 60

	)

211 
	#USEC_TIMER_MAX_USEC
 (
USEC_TIMER_MAX
 * 1000000)

	)

213 
	su£c_timî
 {

214 
timevÆ
 
	m°¨t
;

215 
timevÆ
 
	míd
;

218 #ifde‡
HAVE_GETTIMEOFDAY


220 
ölöe
 

221 
	$u£c_timî_°¨t
 (
u£c_timî
 *
obj
)

223 
	`CLEAR
 (*
obj
);

224 
	`›ív≤_gëtimeofday
 (&
obj
->
°¨t
, 
NULL
);

225 
	}
}

227 
ölöe
 

228 
	$u£c_timî_íd
 (
u£c_timî
 *
obj
)

230 
	`›ív≤_gëtimeofday
 (&
obj
->
íd
, 
NULL
);

231 
	}
}

235 
ölöe
 
boﬁ


236 
	$u£c_timî_öãrvÆ_deföed
 (
u£c_timî
 *
obj
)

238  
obj
->
°¨t
.
tv_£c
 && obj->
íd
.tv_sec;

239 
	}
}

241 
ölöe
 

242 
	$u£c_timî_öãrvÆ
 (
u£c_timî
 *
obj
)

244  
	`tv_subåa˘
 (&
obj
->
íd
, &obj->
°¨t
, 
USEC_TIMER_MAX
);

245 
	}
}

	@src/openvpn/list.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #i‡
P2MP_SERVER


35 
	~"li°.h
"

36 
	~"misc.h
"

38 
	~"memdbg.h
"

40 
hash
 *

41 
hash_öô
 (c⁄° 
n_buckës
,

42 c⁄° 
uöt32_t
 
iv
,

43 
	$uöt32_t
 (*
hash_fun˘i⁄
)(c⁄° *
key
, 
uöt32_t
 
iv
),

44 
	$boﬁ
 (*
com∑ª_fun˘i⁄
)(c⁄° *
key1
, c⁄° *
key2
))

46 
hash
 *
h
;

47 
i
;

49 
	`ASSERT
 (
n_buckës
 > 0);

50 
	`ALLOC_OBJ_CLEAR
 (
h
, 
hash
);

51 
h
->
n_buckës
 = (Ë
	`adju°_powî_of_2
 (n_buckets);

52 
h
->
mask
 = h->
n_buckës
 - 1;

53 
h
->
hash_fun˘i⁄
 = hash_function;

54 
h
->
com∑ª_fun˘i⁄
 = compare_function;

55 
h
->
iv
 = iv;

56 
	`ALLOC_ARRAY
 (
h
->
buckës
, 
hash_buckë
, h->
n_buckës
);

57 
i
 = 0; i < 
h
->
n_buckës
; ++i)

59 
hash_buckë
 *
b
 = &
h
->
buckës
[
i
];

60 
b
->
li°
 = 
NULL
;

62  
h
;

63 
	}
}

66 
	$hash_‰ì
 (
hash
 *hash)

68 
i
;

69 
i
 = 0; i < 
hash
->
n_buckës
; ++i)

71 
hash_buckë
 *
b
 = &
hash
->
buckës
[
i
];

72 
hash_ñemít
 *
he
 = 
b
->
li°
;

74 
he
)

76 
hash_ñemít
 *
√xt
 = 
he
->next;

77 
	`‰ì
 (
he
);

78 
he
 = 
√xt
;

81 
	`‰ì
 (
hash
->
buckës
);

82 
	`‰ì
 (
hash
);

83 
	}
}

85 
hash_ñemít
 *

86 
	$hash_lookup_Á°
 (
hash
 *hash,

87 
hash_buckë
 *
buckë
,

88 c⁄° *
key
,

89 
uöt32_t
 
hv
)

91 
hash_ñemít
 *
he
;

92 
hash_ñemít
 *
¥ev
 = 
NULL
;

94 
he
 = 
buckë
->
li°
;

96 
he
)

98 i‡(
hv
 =
he
->
hash_vÆue
 && (*
hash
->
com∑ª_fun˘i⁄
)(
key
, he->key))

101 i‡(
¥ev
)

103 
¥ev
->
√xt
 = 
he
->next;

104 
he
->
√xt
 = 
buckë
->
li°
;

105 
buckë
->
li°
 = 
he
;

107  
he
;

109 
¥ev
 = 
he
;

110 
he
 = he->
√xt
;

113  
NULL
;

114 
	}
}

116 
boﬁ


117 
	$hash_ªmove_Á°
 (
hash
 *hash,

118 
hash_buckë
 *
buckë
,

119 c⁄° *
key
,

120 
uöt32_t
 
hv
)

122 
hash_ñemít
 *
he
;

123 
hash_ñemít
 *
¥ev
 = 
NULL
;

125 
he
 = 
buckë
->
li°
;

127 
he
)

129 i‡(
hv
 =
he
->
hash_vÆue
 && (*
hash
->
com∑ª_fun˘i⁄
)(
key
, he->key))

131 i‡(
¥ev
)

132 
¥ev
->
√xt
 = 
he
->next;

134 
buckë
->
li°
 = 
he
->
√xt
;

135 
	`‰ì
 (
he
);

136 --
hash
->
n_ñemíts
;

137  
åue
;

139 
¥ev
 = 
he
;

140 
he
 = he->
√xt
;

142  
Ál£
;

143 
	}
}

145 
boﬁ


146 
	$hash_add
 (
hash
 *hash, c⁄° *
key
, *
vÆue
, 
boﬁ
 
ª∂a˚
)

148 
uöt32_t
 
hv
;

149 
hash_buckë
 *
buckë
;

150 
hash_ñemít
 *
he
;

151 
boﬁ
 
ªt
 = 
Ál£
;

153 
hv
 = 
	`hash_vÆue
 (
hash
, 
key
);

154 
buckë
 = &
hash
->
buckës
[
hv
 & hash->
mask
];

156 i‡((
he
 = 
	`hash_lookup_Á°
 (
hash
, 
buckë
, 
key
, 
hv
)))

158 i‡(
ª∂a˚
)

160 
he
->
vÆue
 = value;

161 
ªt
 = 
åue
;

166 
	`hash_add_Á°
 (
hash
, 
buckë
, 
key
, 
hv
, 
vÆue
);

167 
ªt
 = 
åue
;

170  
ªt
;

171 
	}
}

174 
	$hash_ªmove_by_vÆue
 (
hash
 *hash, *
vÆue
)

176 
hash_ôî©‹
 
hi
;

177 
hash_ñemít
 *
he
;

179 
	`hash_ôî©‹_öô
 (
hash
, &
hi
);

180 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

182 i‡(
he
->
vÆue
 == value)

183 
	`hash_ôî©‹_dñëe_ñemít
 (&
hi
);

185 
	`hash_ôî©‹_‰ì
 (&
hi
);

186 
	}
}

189 
	$hash_ªmove_m¨ked
 (
hash
 *hash, 
hash_buckë
 *
buckë
)

191 
hash_ñemít
 *
¥ev
 = 
NULL
;

192 
hash_ñemít
 *
he
 = 
buckë
->
li°
;

194 
he
)

196 i‡(!
he
->
key
)

198 
hash_ñemít
 *
√whe
;

199 i‡(
¥ev
)

200 
√whe
 = 
¥ev
->
√xt
 = 
he
->next;

202 
√whe
 = 
buckë
->
li°
 = 
he
->
√xt
;

203 
	`‰ì
 (
he
);

204 --
hash
->
n_ñemíts
;

205 
he
 = 
√whe
;

209 
¥ev
 = 
he
;

210 
he
 = he->
√xt
;

213 
	}
}

215 
uöt32_t


216 
	$void_±r_hash_fun˘i⁄
 (c⁄° *
key
, 
uöt32_t
 
iv
)

218  
	`hash_func
 ((c⁄° *)&
key
,  (key), 
iv
);

219 
	}
}

221 
boﬁ


222 
	$void_±r_com∑ª_fun˘i⁄
 (c⁄° *
key1
, c⁄° *
key2
)

224  
key1
 =
key2
;

225 
	}
}

228 
	$hash_ôî©‹_öô_ønge
 (
hash
 *hash,

229 
hash_ôî©‹
 *
hi
,

230 
°¨t_buckë
,

231 
íd_buckë
)

233 i‡(
íd_buckë
 > 
hash
->
n_buckës
)

234 
íd_buckë
 = 
hash
->
n_buckës
;

236 
	`ASSERT
 (
°¨t_buckë
 >0 && sèπ_buckë <
íd_buckë
);

238 
hi
->
hash
 = hash;

239 
hi
->
ñem
 = 
NULL
;

240 
hi
->
buckë
 = 
NULL
;

241 
hi
->
œ°
 = 
NULL
;

242 
hi
->
buckë_m¨ked
 = 
Ál£
;

243 
hi
->
buckë_ödex_°¨t
 = 
°¨t_buckë
;

244 
hi
->
buckë_ödex_íd
 = 
íd_buckë
;

245 
hi
->
buckë_ödex
 = hi->
buckë_ödex_°¨t
 - 1;

246 
	}
}

249 
	$hash_ôî©‹_öô
 (
hash
 *hash,

250 
hash_ôî©‹
 *
hi
)

252 
	`hash_ôî©‹_öô_ønge
 (
hash
, 
hi
, 0, hash->
n_buckës
);

253 
	}
}

255 
ölöe
 

256 
	$hash_ôî©‹_lock
 (
hash_ôî©‹
 *
hi
, 
hash_buckë
 *
b
)

258 
hi
->
buckë
 = 
b
;

259 
hi
->
œ°
 = 
NULL
;

260 
hi
->
buckë_m¨ked
 = 
Ál£
;

261 
	}
}

263 
ölöe
 

264 
	$hash_ôî©‹_u∆ock
 (
hash_ôî©‹
 *
hi
)

266 i‡(
hi
->
buckë
)

268 i‡(
hi
->
buckë_m¨ked
)

270 
	`hash_ªmove_m¨ked
 (
hi
->
hash
, hi->
buckë
);

271 
hi
->
buckë_m¨ked
 = 
Ál£
;

273 
hi
->
buckë
 = 
NULL
;

274 
hi
->
œ°
 = 
NULL
;

276 
	}
}

278 
ölöe
 

279 
	$hash_ôî©‹_adv™˚
 (
hash_ôî©‹
 *
hi
)

281 
hi
->
œ°
 = hi->
ñem
;

282 
hi
->
ñem
 = hi->ñem->
√xt
;

283 
	}
}

286 
	$hash_ôî©‹_‰ì
 (
hash_ôî©‹
 *
hi
)

288 
	`hash_ôî©‹_u∆ock
 (
hi
);

289 
	}
}

291 
hash_ñemít
 *

292 
	$hash_ôî©‹_√xt
 (
hash_ôî©‹
 *
hi
)

294 
hash_ñemít
 *
ªt
 = 
NULL
;

295 i‡(
hi
->
ñem
)

297 
ªt
 = 
hi
->
ñem
;

298 
	`hash_ôî©‹_adv™˚
 (
hi
);

302 ++
hi
->
buckë_ödex
 < hi->
buckë_ödex_íd
)

304 
hash_buckë
 *
b
;

305 
	`hash_ôî©‹_u∆ock
 (
hi
);

306 
b
 = &
hi
->
hash
->
buckës
[hi->
buckë_ödex
];

307 i‡(
b
->
li°
)

309 
	`hash_ôî©‹_lock
 (
hi
, 
b
);

310 
hi
->
ñem
 = 
b
->
li°
;

311 i‡(
hi
->
ñem
)

313 
ªt
 = 
hi
->
ñem
;

314 
	`hash_ôî©‹_adv™˚
 (
hi
);

320  
ªt
;

321 
	}
}

324 
	$hash_ôî©‹_dñëe_ñemít
 (
hash_ôî©‹
 *
hi
)

326 
	`ASSERT
 (
hi
->
œ°
);

327 
hi
->
œ°
->
key
 = 
NULL
;

328 
hi
->
buckë_m¨ked
 = 
åue
;

329 
	}
}

332 #ifde‡
LIST_TEST


339 
	sw‹d


341 c⁄° *
	mw‹d
;

342 
	mn
;

345 
uöt32_t


346 
	$w‹d_hash_fun˘i⁄
 (c⁄° *
key
, 
uöt32_t
 
iv
)

348 c⁄° *
°r
 = (c⁄° *Ë
key
;

349 c⁄° 
Àn
 = 
	`°æí
 (
°r
);

350  
	`hash_func
 ((c⁄° 
uöt8_t
 *)
°r
, 
Àn
, 
iv
);

351 
	}
}

353 
boﬁ


354 
	$w‹d_com∑ª_fun˘i⁄
 (c⁄° *
key1
, c⁄° *
key2
)

356  
	`°rcmp
 ((c⁄° *)
key1
, (c⁄° *)
key2
) == 0;

357 
	}
}

360 
	$¥öt_nhash
 (
hash
 *hash)

362 
hash_ôî©‹
 
hi
;

363 
hash_ñemít
 *
he
;

364 
cou¡
 = 0;

366 
	`hash_ôî©‹_öô
 (
hash
, &
hi
, 
åue
);

368 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

370 
	`¥ötf
 ("%d ", (Ë
he
->
vÆue
);

371 ++
cou¡
;

373 
	`¥ötf
 ("\n");

375 
	`hash_ôî©‹_‰ì
 (&
hi
);

376 
	`ASSERT
 (
cou¡
 =
	`hash_n_ñemíts
 (
hash
));

377 
	}
}

380 
	$rmhash
 (
hash
 *hash, c⁄° *
w‹d
)

382 
	`hash_ªmove
 (
hash
, 
w‹d
);

383 
	}
}

386 
	$li°_ã°
 ()

388 
	`›ív≤_thªad_öô
 ();

391 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

392 
hash
 *hash = 
	`hash_öô
 (10000, 
	`gë_øndom
 (), 
w‹d_hash_fun˘i⁄
, 
w‹d_com∑ª_fun˘i⁄
);

393 
hash
 *
nhash
 = 
	`hash_öô
 (256, 
	`gë_øndom
 (), 
w‹d_hash_fun˘i⁄
, 
w‹d_com∑ª_fun˘i⁄
);

395 
	`¥ötf
 ("hash_öôÇ_buckës=%d mask=0x%08x\n", 
hash
->
n_buckës
, hash->
mask
);

398 
åue
)

400 
buf
[256];

401 
w‹dbuf
[256];

402 
wbi
;

403 
bi
;

404 
c
;

406 i‡(!
	`fgës
(
buf
, (buf), 
°dö
))

409 
bi
 = 
wbi
 = 0;

412 
c
 = 
buf
[
bi
++];

413 i‡(
	`iß um
 (
c
) || c == '_')

415 
	`ASSERT
 (
wbi
 < (Ë (
w‹dbuf
));

416 
w‹dbuf
[
wbi
++] = 
c
;

420 i‡(
wbi
)

422 
w‹d
 *
w
;

423 
	`ASSERT
 (
wbi
 < (Ë (
w‹dbuf
));

424 
w‹dbuf
[
wbi
++] = '\0';

429 
w
 = (
w‹d
 *Ë
	`hash_lookup
 (
hash
, 
w‹dbuf
);

431 i‡(
w
)

434 ++
w
->
n
;

439 
	`ALLOC_OBJ_GC
 (
w
, 
w‹d
, &
gc
);

440 
w
->
w‹d
 = 
	`°rög_Æloc
 (
w‹dbuf
, &
gc
);

441 
w
->
n
 = 1;

442 
	`ASSERT
 (
	`hash_add
 (
hash
, 
w
->
w‹d
, w, 
Ál£
));

443 
	`ASSERT
 (
	`hash_add
 (
nhash
, 
w
->
w‹d
, (*Ë((
	`øndom
(Ë& 0x0FË+ 1), 
Ál£
));

446 
wbi
 = 0;

448 } 
c
);

454 
	`rmhash
 (
hash
, "true");

455 
	`rmhash
 (
hash
, "false");

461 
ba£
;

462 
öc
 = 0;

463 
cou¡
 = 0;

465 
ba£
 = 0; ba£ < 
	`hash_n_buckës
 (
hash
); ba£ +
öc
) {

466 
hash_ôî©‹
 
hi
;

467 
hash_ñemít
 *
he
;

468 
öc
 = (
	`gë_øndom
 () % 3) + 1;

469 
	`hash_ôî©‹_öô_ønge
 (
hash
, &
hi
, 
åue
, 
ba£
, ba£ + 
öc
);

471 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

473 
w‹d
 *
w
 = (w‹d *Ë
he
->
vÆue
;

474 
	`¥ötf
 ("%6d '%s'\n", 
w
->
n
, w->
w‹d
);

475 ++
cou¡
;

478 
	`hash_ôî©‹_‰ì
 (&
hi
);

480 
	`ASSERT
 (
cou¡
 =
	`hash_n_ñemíts
 (
hash
));

486 
i
;

487 
i
 = 1; i <= 16; ++i)

489 
	`¥ötf
 ("[%d] ***********************************\n", 
i
);

490 
	`¥öt_nhash
 (
nhash
);

491 
	`hash_ªmove_by_vÆue
 (
nhash
, (*Ë
i
, 
åue
);

493 
	`¥ötf
 ("FINAL **************************\n");

494 
	`¥öt_nhash
 (
nhash
);

498 
	`hash_‰ì
 (
hash
);

499 
	`hash_‰ì
 (
nhash
);

500 
	`gc_‰ì
 (&
gc
);

503 
	`›ív≤_thªad_˛ónup
 ();

504 
	}
}

573 
	#mix
(
a
,
b
,
c
) \

575 
a
 -
b
;á -
c
;á ^= (c>>13); \

576 
b
 -
c
; b -
a
; b ^= (a<<8); \

577 
c
 -
a
; c -
b
; c ^= (b>>13); \

578 
a
 -
b
;á -
c
;á ^= (c>>12); \

579 
b
 -
c
; b -
a
; b ^= (a<<16); \

580 
c
 -
a
; c -
b
; c ^= (b>>5); \

581 
a
 -
b
;á -
c
;á ^= (c>>3); \

582 
b
 -
c
; b -
a
; b ^= (a<<10); \

583 
c
 -
a
; c -
b
; c ^= (b>>15); \

584 }

	)

586 
uöt32_t


587 
	$hash_func
 (c⁄° 
uöt8_t
 *
k
, 
uöt32_t
 
Àngth
, uöt32_à
öôvÆ
)

589 
uöt32_t
 
a
, 
b
, 
c
, 
Àn
;

592 
Àn
 = 
Àngth
;

593 
a
 = 
b
 = 0x9e3779b9;

594 
c
 = 
öôvÆ
;

597 
Àn
 >= 12)

599 
a
 +(
k
[0] + ((
uöt32_t
) k[1] << 8)

600 + ((
uöt32_t
Ë
k
[2] << 16)

601 + ((
uöt32_t
Ë
k
[3] << 24));

602 
b
 +(
k
[4] + ((
uöt32_t
) k[5] << 8)

603 + ((
uöt32_t
Ë
k
[6] << 16)

604 + ((
uöt32_t
Ë
k
[7] << 24));

605 
c
 +(
k
[8] + ((
uöt32_t
) k[9] << 8)

606 + ((
uöt32_t
Ë
k
[10] << 16)

607 + ((
uöt32_t
Ë
k
[11] << 24));

608 
	`mix
 (
a
, 
b
, 
c
);

609 
k
 += 12;

610 
Àn
 -= 12;

614 
c
 +
Àngth
;

615 
Àn
)

618 
c
 +((
uöt32_t
Ë
k
[10] << 24);

620 
c
 +((
uöt32_t
Ë
k
[9] << 16);

622 
c
 +((
uöt32_t
Ë
k
[8] << 8);

625 
b
 +((
uöt32_t
Ë
k
[7] << 24);

627 
b
 +((
uöt32_t
Ë
k
[6] << 16);

629 
b
 +((
uöt32_t
Ë
k
[5] << 8);

631 
b
 +
k
[4];

633 
a
 +((
uöt32_t
Ë
k
[3] << 24);

635 
a
 +((
uöt32_t
Ë
k
[2] << 16);

637 
a
 +((
uöt32_t
Ë
k
[1] << 8);

639 
a
 +
k
[0];

642 
	`mix
 (
a
, 
b
, 
c
);

644  
c
;

645 
	}
}

648 
	$dummy
(Ë{
	}
}

	@src/openvpn/list.h

25 #i‚de‡
LIST_H


26 
	#LIST_H


	)

37 #i‡
P2MP_SERVER


42 
	~"basic.h
"

43 
	~"buf„r.h
"

45 
	#hashsize
(
n
Ë((
uöt32_t
)1<<“))

	)

46 
	#hashmask
(
n
Ë(
	`hashsize
“)-1)

	)

48 
	shash_ñemít


50 *
	mvÆue
;

51 c⁄° *
	mkey
;

52 
	mhash_vÆue
;

53 
hash_ñemít
 *
	m√xt
;

56 
	shash_buckë


58 
hash_ñemít
 *
	mli°
;

61 
	shash


63 
	mn_buckës
;

64 
	mn_ñemíts
;

65 
	mmask
;

66 
uöt32_t
 
	miv
;

67 
uöt32_t
 (*
hash_fun˘i⁄
)(c⁄° *
	mkey
, uöt32_à
	miv
);

68 
boﬁ
 (*
com∑ª_fun˘i⁄
)(c⁄° *
	mkey1
, c⁄° *
	mkey2
);

69 
hash_buckë
 *
	mbuckës
;

72 
hash
 *
hash_öô
 (c⁄° 
n_buckës
,

73 c⁄° 
uöt32_t
 
iv
,

74 
	$uöt32_t
 (*
hash_fun˘i⁄
)(c⁄° *
key
, 
uöt32_t
 
iv
),

75 
	$boﬁ
 (*
com∑ª_fun˘i⁄
)(c⁄° *
key1
, c⁄° *
key2
));

77 
	`hash_‰ì
 (
hash
 *hash);

79 
boﬁ
 
	`hash_add
 (
hash
 *hash, c⁄° *
key
, *
vÆue
, boﬁ 
ª∂a˚
);

81 
hash_ñemít
 *
	`hash_lookup_Á°
 (
hash
 *hash,

82 
hash_buckë
 *
buckë
,

83 c⁄° *
key
,

84 
uöt32_t
 
hv
);

86 
boﬁ
 
	`hash_ªmove_Á°
 (
hash
 *hash,

87 
hash_buckë
 *
buckë
,

88 c⁄° *
key
,

89 
uöt32_t
 
hv
);

91 
	`hash_ªmove_by_vÆue
 (
hash
 *hash, *
vÆue
);

93 
	shash_ôî©‹


95 
hash
 *hash;

96 
buckë_ödex
;

97 
hash_buckë
 *
buckë
;

98 
hash_ñemít
 *
ñem
;

99 
hash_ñemít
 *
œ°
;

100 
boﬁ
 
buckë_m¨ked
;

101 
buckë_ödex_°¨t
;

102 
buckë_ödex_íd
;

105 
	`hash_ôî©‹_öô_ønge
 (
hash
 *hash,

106 
hash_ôî©‹
 *
hi
,

107 
°¨t_buckë
,

108 
íd_buckë
);

110 
	`hash_ôî©‹_öô
 (
hash
 *hash, 
hash_ôî©‹
 *
ôî
);

111 
hash_ñemít
 *
	`hash_ôî©‹_√xt
 (
hash_ôî©‹
 *
hi
);

112 
	`hash_ôî©‹_dñëe_ñemít
 (
hash_ôî©‹
 *
hi
);

113 
	`hash_ôî©‹_‰ì
 (
hash_ôî©‹
 *
hi
);

115 
uöt32_t
 
	`hash_func
 (c⁄° 
uöt8_t
 *
k
, uöt32_à
Àngth
, uöt32_à
öôvÆ
);

117 
uöt32_t
 
	`void_±r_hash_fun˘i⁄
 (c⁄° *
key
, uöt32_à
iv
);

118 
boﬁ
 
	`void_±r_com∑ª_fun˘i⁄
 (c⁄° *
key1
, c⁄° *
key2
);

120 #ifde‡
LIST_TEST


121 
	`li°_ã°
 ();

124 
ölöe
 
uöt32_t


125 
	$hash_vÆue
 (c⁄° 
hash
 *hash, c⁄° *
key
)

127  (*
hash
->
hash_fun˘i⁄
)(
key
, hash->
iv
);

128 
	}
}

130 
ölöe
 

131 
	$hash_n_ñemíts
 (c⁄° 
hash
 *hash)

133  
hash
->
n_ñemíts
;

134 
	}
}

136 
ölöe
 

137 
	$hash_n_buckës
 (c⁄° 
hash
 *hash)

139  
hash
->
n_buckës
;

140 
	}
}

142 
ölöe
 
hash_buckë
 *

143 
	$hash_buckë
 (
hash
 *hash, 
uöt32_t
 
hv
)

145  &
hash
->
buckës
[
hv
 & hash->
mask
];

146 
	}
}

148 
ölöe
 *

149 
	$hash_lookup
 (
hash
 *hash, c⁄° *
key
)

151 *
ªt
 = 
NULL
;

152 
hash_ñemít
 *
he
;

153 
uöt32_t
 
hv
 = 
	`hash_vÆue
 (
hash
, 
key
);

154 
hash_buckë
 *
buckë
 = &
hash
->
buckës
[
hv
 & hash->
mask
];

156 
he
 = 
	`hash_lookup_Á°
 (
hash
, 
buckë
, 
key
, 
hv
);

157 i‡(
he
)

158 
ªt
 = 
he
->
vÆue
;

160  
ªt
;

161 
	}
}

164 
ölöe
 

165 
	$hash_add_Á°
 (
hash
 *hash,

166 
hash_buckë
 *
buckë
,

167 c⁄° *
key
,

168 
uöt32_t
 
hv
,

169 *
vÆue
)

171 
hash_ñemít
 *
he
;

173 
	`ALLOC_OBJ
 (
he
, 
hash_ñemít
);

174 
he
->
vÆue
 = value;

175 
he
->
key
 = key;

176 
he
->
hash_vÆue
 = 
hv
;

177 
he
->
√xt
 = 
buckë
->
li°
;

178 
buckë
->
li°
 = 
he
;

179 ++
hash
->
n_ñemíts
;

180 
	}
}

182 
ölöe
 
boﬁ


183 
	$hash_ªmove
 (
hash
 *hash, c⁄° *
key
)

185 
uöt32_t
 
hv
;

186 
hash_buckë
 *
buckë
;

187 
boﬁ
 
ªt
;

189 
hv
 = 
	`hash_vÆue
 (
hash
, 
key
);

190 
buckë
 = &
hash
->
buckës
[
hv
 & hash->
mask
];

191 
ªt
 = 
	`hash_ªmove_Á°
 (
hash
, 
buckë
, 
key
, 
hv
);

192  
ªt
;

193 
	}
}

	@src/openvpn/lladdr.c

5 #ifde‡
HAVE_CONFIG_H


6 
	~"c⁄fig.h
"

7 #ñi‡
deföed
(
_MSC_VER
)

8 
	~"c⁄fig-msvc.h
"

11 
	~"syshód.h
"

12 
	~"îr‹.h
"

13 
	~"misc.h
"

15 
	$£t_Œaddr
(c⁄° *
i‚ame
, c⁄° *
Œaddr
,

16 c⁄° 
ív_£t
 *
es
)

18 
¨gv
árgv = 
	`¨gv_√w
 ();

19 
r
;

21 i‡(!
i‚ame
 || !
Œaddr
)

24 #i‡
	`deföed
(
TARGET_LINUX
)

25 #ifde‡
ENABLE_IPROUTE


26 
	`¨gv_¥ötf
 (&
¨gv
,

28 
ùrouã_∑th
, 
Œaddr
, 
i‚ame
);

30 
	`¨gv_¥ötf
 (&
¨gv
,

32 
IFCONFIG_PATH
,

33 
i‚ame
, 
Œaddr
);

35 #ñi‡
	`deföed
(
TARGET_SOLARIS
)

36 
	`¨gv_¥ötf
 (&
¨gv
,

38 
IFCONFIG_PATH
,

39 
i‚ame
, 
Œaddr
);

40 #ñi‡
	`deföed
(
TARGET_OPENBSD
)

41 
	`¨gv_¥ötf
 (&
¨gv
,

43 
IFCONFIG_PATH
,

44 
i‚ame
, 
Œaddr
);

45 #ñi‡
	`deföed
(
TARGET_DARWIN
)

46 
	`¨gv_¥ötf
 (&
¨gv
,

48 
IFCONFIG_PATH
,

49 
i‚ame
, 
Œaddr
);

50 #ñi‡
	`deföed
(
TARGET_FREEBSD
)

51 
	`¨gv_¥ötf
 (&
¨gv
,

53 
IFCONFIG_PATH
,

54 
i‚ame
, 
Œaddr
);

56 
	`msg
 (
M_WARN
, "Sorry, but I don't know howÅo configureÜinkÜayeráddresses onÅhis operating system.");

60 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

61 
r
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
M_WARN
, "ERROR: UnableÅo setÜinkÜayeráddress.");

62 i‡(
r
)

63 
	`msg
 (
M_INFO
, "TUN/TAPÜökÜayîáddªs†£àtÿ%s", 
Œaddr
);

65 
	`¨gv_ª£t
 (&
¨gv
);

66  
r
;

67 
	}
}

	@src/openvpn/lladdr.h

5 
	~"misc.h
"

7 
£t_Œaddr
(c⁄° *
i‚ame
, c⁄° *
Œaddr
,

8 c⁄° 
ív_£t
 *
es
);

	@src/openvpn/lzo.c

29 #ifde‡
HAVE_CONFIG_H


30 
	~"c⁄fig.h
"

31 #ñi‡
deföed
(
_MSC_VER
)

32 
	~"c⁄fig-msvc.h
"

35 
	~"syshód.h
"

37 #ifde‡
ENABLE_LZO


39 
	~"lzo.h
"

40 
	~"îr‹.h
"

41 
	~"Ÿime.h
"

43 
	~"memdbg.h
"

45 #i‚de‡
ENABLE_LZO_STUB


53 
boﬁ


54 
	$lzo_ad≠tive_com¥ess_ã°
 (
lzo_ad≠tive_com¥ess
 *
ac
)

56 c⁄° 
boﬁ
 
ßve
 = 
ac
->
com¥ess_°©e
;

57 c⁄° 
time_t
 
loˇl_now
 = 
now
;

59 i‡(!
ac
->
com¥ess_°©e
)

61 i‡(
loˇl_now
 >
ac
->
√xt
)

63 i‡(
ac
->
n_tŸÆ
 > 
AC_MIN_BYTES


64 && (
ac
->
n_tŸÆ
 -ác->
n_comp
Ë< (ac->n_tŸÆ / (100 / 
AC_SAVE_PCT
)))

66 
ac
->
com¥ess_°©e
 = 
åue
;

67 
ac
->
√xt
 = 
loˇl_now
 + 
AC_OFF_SEC
;

71 
ac
->
√xt
 = 
loˇl_now
 + 
AC_SAMP_SEC
;

73 
	`dmsg
 (
D_COMP
, "lzo_ad≠tive_com¥ess_ã°: comp=%dÅŸÆ=%d", 
ac
->
n_comp
,ác->
n_tŸÆ
);

74 
ac
->
n_tŸÆ
 =ác->
n_comp
 = 0;

79 i‡(
loˇl_now
 >
ac
->
√xt
)

81 
ac
->
√xt
 = 
loˇl_now
 + 
AC_SAMP_SEC
;

82 
ac
->
n_tŸÆ
 =ác->
n_comp
 = 0;

83 
ac
->
com¥ess_°©e
 = 
Ál£
;

87 i‡(
ac
->
com¥ess_°©e
 !
ßve
)

88 
	`dmsg
 (
D_COMP_LOW
, "Ad≠tivêcom¥essi⁄ sèã %s", (
ac
->
com¥ess_°©e
 ? "OFF" : "ON"));

90  !
ac
->
com¥ess_°©e
;

91 
	}
}

93 
ölöe
 

94 
	$lzo_ad≠tive_com¥ess_d©a
 (
lzo_ad≠tive_com¥ess
 *
ac
, 
n_tŸÆ
, 
n_comp
)

96 
ac
->
n_tŸÆ
 +=Ç_total;

97 
ac
->
n_comp
 +=Ç_comp;

98 
	}
}

102 
	$lzo_adju°_‰ame_∑ømëîs
 (
‰ame
 *frame)

105 
	`‰ame_add_to_exåa_‰ame
 (
‰ame
, 
LZO_PREFIX_LEN
);

109 
	`‰ame_add_to_exåa_buf„r
 (
‰ame
, 
	`LZO_EXTRA_BUFFER
 (
	`EXPANDED_SIZE
(frame)));

110 
	}
}

113 
	$lzo_com¥ess_öô
 (
lzo_com¥ess_w‹k•a˚
 *
lzow‹k
, 
Êags
)

115 
	`CLEAR
 (*
lzow‹k
);

117 
lzow‹k
->
Êags
 = flags;

118 #i‚de‡
ENABLE_LZO_STUB


119 
lzow‹k
->
wmem_size
 = 
LZO_WORKSPACE
;

121 i‡(
	`lzo_öô
 (Ë!
LZO_E_OK
)

122 
	`msg
 (
M_FATAL
, "Cannot initialize LZO compressionÜibrary");

123 
lzow‹k
->
wmem
 = (
lzo_voidp
Ë
	`lzo_mÆloc
 (lzow‹k->
wmem_size
);

124 
	`check_mÆloc_ªtu∫
 (
lzow‹k
->
wmem
);

125 
	`msg
 (
D_INIT_MEDIUM
, "LZO compression initialized");

127 
	`msg
 (
D_INIT_MEDIUM
, "LZO stub compression initialized");

129 
lzow‹k
->
deföed
 = 
åue
;

130 
	}
}

133 
	$lzo_com¥ess_unöô
 (
lzo_com¥ess_w‹k•a˚
 *
lzow‹k
)

135 i‡(
lzow‹k
)

137 
	`ASSERT
 (
lzow‹k
->
deföed
);

138 #i‚de‡
ENABLE_LZO_STUB


139 
	`lzo_‰ì
 (
lzow‹k
->
wmem
);

140 
lzow‹k
->
wmem
 = 
NULL
;

142 
lzow‹k
->
deföed
 = 
Ál£
;

144 
	}
}

146 
ölöe
 
boﬁ


147 
	$lzo_com¥essi⁄_íabÀd
 (
lzo_com¥ess_w‹k•a˚
 *
lzow‹k
)

149 #i‚de‡
ENABLE_LZO_STUB


150 i‡((
lzow‹k
->
Êags
 & (
LZO_SELECTED
|
LZO_ON
)) == (LZO_SELECTED|LZO_ON))

152 i‡(
lzow‹k
->
Êags
 & 
LZO_ADAPTIVE
)

153  
	`lzo_ad≠tive_com¥ess_ã°
 (&
lzow‹k
->
ac
);

155  
åue
;

158  
Ál£
;

159 
	}
}

162 
	$lzo_com¥ess
 (
buf„r
 *
buf
, buf„∏
w‹k
,

163 
lzo_com¥ess_w‹k•a˚
 *
lzow‹k
,

164 c⁄° 
‰ame
* frame)

166 #i‚de‡
ENABLE_LZO_STUB


167 
lzo_uöt
 
zÀn
 = 0;

168 
îr
;

169 
boﬁ
 
com¥es£d
 = 
Ál£
;

172 
	`ASSERT
 (
lzow‹k
->
deföed
);

174 i‡(
buf
->
Àn
 <= 0)

177 #i‚de‡
ENABLE_LZO_STUB


182 i‡(
buf
->
Àn
 >
COMPRESS_THRESHOLD
 && 
	`lzo_com¥essi⁄_íabÀd
 (
lzow‹k
))

184 
	`ASSERT
 (
	`buf_öô
 (&
w‹k
, 
	`FRAME_HEADROOM
 (
‰ame
)));

185 
	`ASSERT
 (
	`buf_ß„
 (&
w‹k
, 
	`LZO_EXTRA_BUFFER
 (
	`PAYLOAD_SIZE
 (
‰ame
))));

187 i‡(!(
buf
->
Àn
 <
	`PAYLOAD_SIZE
 (
‰ame
)))

189 
	`dmsg
 (
D_COMP_ERRORS
, "LZO compression buffer overflow");

190 
buf
->
Àn
 = 0;

194 
îr
 = 
	`LZO_COMPRESS
 (
	`BPTR
 (
buf
), 
	`BLEN
 (buf), BPTR (&
w‹k
), &
zÀn
, 
lzow‹k
->
wmem
);

195 i‡(
îr
 !
LZO_E_OK
)

197 
	`dmsg
 (
D_COMP_ERRORS
, "LZO com¥essi⁄Éº‹: %d", 
îr
);

198 
buf
->
Àn
 = 0;

202 
	`ASSERT
 (
	`buf_ß„
 (&
w‹k
, 
zÀn
));

203 
w‹k
.
Àn
 = 
zÀn
;

204 
com¥es£d
 = 
åue
;

206 
	`dmsg
 (
D_COMP
, "com¥es†%d -> %d", 
buf
->
Àn
, 
w‹k
.len);

207 
lzow‹k
->
¥e_com¥ess
 +
buf
->
Àn
;

208 
lzow‹k
->
po°_com¥ess
 +
w‹k
.
Àn
;

211 i‡(
lzow‹k
->
Êags
 & 
LZO_ADAPTIVE
)

212 
	`lzo_ad≠tive_com¥ess_d©a
 (&
lzow‹k
->
ac
, 
buf
->
Àn
, 
w‹k
.len);

216 i‡(
com¥es£d
 && 
w‹k
.
Àn
 < 
buf
->len)

218 
uöt8_t
 *
hódî
 = 
	`buf_¥ïíd
 (&
w‹k
, 1);

219 *
hódî
 = 
YES_COMPRESS
;

220 *
buf
 = 
w‹k
;

225 
uöt8_t
 *
hódî
 = 
	`buf_¥ïíd
 (
buf
, 1);

226 *
hódî
 = 
NO_COMPRESS
;

228 
	}
}

231 
	$lzo_decom¥ess
 (
buf„r
 *
buf
, buf„∏
w‹k
,

232 
lzo_com¥ess_w‹k•a˚
 *
lzow‹k
,

233 c⁄° 
‰ame
* frame)

235 #i‚de‡
ENABLE_LZO_STUB


236 
lzo_uöt
 
zÀn
 = 
	`EXPANDED_SIZE
 (
‰ame
);

237 
îr
;

239 
uöt8_t
 
c
;

241 
	`ASSERT
 (
lzow‹k
->
deföed
);

243 i‡(
buf
->
Àn
 <= 0)

246 
	`ASSERT
 (
	`buf_öô
 (&
w‹k
, 
	`FRAME_HEADROOM
 (
‰ame
)));

248 
c
 = *
	`BPTR
 (
buf
);

249 
	`ASSERT
 (
	`buf_adv™˚
 (
buf
, 1));

251 i‡(
c
 =
YES_COMPRESS
)

253 #i‚de‡
ENABLE_LZO_STUB


254 
	`ASSERT
 (
	`buf_ß„
 (&
w‹k
, 
zÀn
));

255 
îr
 = 
	`LZO_DECOMPRESS
 (
	`BPTR
 (
buf
), 
	`BLEN
 (buf), BPTR (&
w‹k
), &
zÀn
,

256 
lzow‹k
->
wmem
);

257 i‡(
îr
 !
LZO_E_OK
)

259 
	`dmsg
 (
D_COMP_ERRORS
, "LZO decom¥essi⁄Éº‹: %d", 
îr
);

260 
buf
->
Àn
 = 0;

264 
	`ASSERT
 (
	`buf_ß„
 (&
w‹k
, 
zÀn
));

265 
w‹k
.
Àn
 = 
zÀn
;

267 
	`dmsg
 (
D_COMP
, "decom¥es†%d -> %d", 
buf
->
Àn
, 
w‹k
.len);

268 
lzow‹k
->
¥e_decom¥ess
 +
buf
->
Àn
;

269 
lzow‹k
->
po°_decom¥ess
 +
w‹k
.
Àn
;

271 *
buf
 = 
w‹k
;

273 
	`dmsg
 (
D_COMP_ERRORS
, "LZO decompressionÉrror: LZO capabilityÇot compiled");

274 
buf
->
Àn
 = 0;

278 i‡(
c
 =
NO_COMPRESS
)

284 
	`dmsg
 (
D_COMP_ERRORS
, "Bad LZO decom¥essi⁄ hódî byã: %d", 
c
);

285 
buf
->
Àn
 = 0;

287 
	}
}

290 
	$lzo_modify_Êags
 (
lzo_com¥ess_w‹k•a˚
 *
lzow‹k
, 
Êags
)

292 
	`ASSERT
 (
lzow‹k
->
deföed
);

293 
lzow‹k
->
Êags
 = flags;

294 
	}
}

296 
	$lzo_¥öt_°©s
 (c⁄° 
lzo_com¥ess_w‹k•a˚
 *
lzo_compw‹k
, 
°©us_ouçut
 *
so
)

298 
	`ASSERT
 (
lzo_compw‹k
->
deföed
);

300 #i‚de‡
ENABLE_LZO_STUB


301 
	`°©us_¥ötf
 (
so
, "¥e-com¥es†byãs," 
cou¡î_f‹m©
, 
lzo_compw‹k
->
¥e_com¥ess
);

302 
	`°©us_¥ötf
 (
so
, "po°-com¥es†byãs," 
cou¡î_f‹m©
, 
lzo_compw‹k
->
po°_com¥ess
);

303 
	`°©us_¥ötf
 (
so
, "¥e-decom¥es†byãs," 
cou¡î_f‹m©
, 
lzo_compw‹k
->
¥e_decom¥ess
);

304 
	`°©us_¥ötf
 (
so
, "po°-decom¥es†byãs," 
cou¡î_f‹m©
, 
lzo_compw‹k
->
po°_decom¥ess
);

306 
	}
}

309 
	$dummy
(Ë{
	}
}

	@src/openvpn/lzo.h

25 #i‚de‡
OPENVPN_LZO_H


26 
	#OPENVPN_LZO_H


	)

35 #ifde‡
ENABLE_LZO


42 #i‚de‡
ENABLE_LZO_STUB


43 #i‡
deföed
(
HAVE_LZO_LZOUTIL_H
)

44 
	~"lzo/lzoutû.h
"

45 #ñi‡
deföed
(
HAVE_LZOUTIL_H
)

46 
	~"lzoutû.h
"

48 #i‡
deföed
(
HAVE_LZO_LZO1X_H
)

49 
	~"lzo/lzo1x.h
"

50 #ñi‡
deföed
(
HAVE_LZO1X_H
)

51 
	~"lzo1x.h
"

55 
	~"buf„r.h
"

56 
	~"mtu.h
"

57 
	~"comm⁄.h
"

58 
	~"°©us.h
"

63 
	#LZO_SELECTED
 (1<<0Ë

	)

65 
	#LZO_ON
 (1<<1Ë

	)

67 
	#LZO_ADAPTIVE
 (1<<2Ë

	)

74 #i‚de‡
ENABLE_LZO_STUB


75 
	#LZO_COMPRESS
 
lzo1x_1_15_com¥ess


	)

82 
	#LZO_WORKSPACE
 
LZO1X_1_15_MEM_COMPRESS


	)

86 
	#LZO_DECOMPRESS
 
lzo1x_decom¥ess_ß„


	)

102 
	#LZO_EXTRA_BUFFER
(
Àn
Ë(÷í)/8 + 128 + 3)

	)

104 #i‚de‡
ENABLE_LZO_STUB


105 
	#COMPRESS_THRESHOLD
 100

	)

113 
	#LZO_PREFIX_LEN
 1

	)

115 
	#YES_COMPRESS
 0x66

	)

118 
	#NO_COMPRESS
 0xFA

	)

125 #i‚de‡
ENABLE_LZO_STUB


126 
	#AC_SAMP_SEC
 2

	)

127 
	#AC_MIN_BYTES
 1000

	)

130 
	#AC_SAVE_PCT
 5

	)

133 
	#AC_OFF_SEC
 60

	)

138 #i‚de‡
ENABLE_LZO_STUB


143 
	slzo_ad≠tive_com¥ess
 {

144 
boﬁ
 
	mcom¥ess_°©e
;

145 
time_t
 
	m√xt
;

146 
	mn_tŸÆ
;

147 
	mn_comp
;

163 
	slzo_com¥ess_w‹k•a˚


165 
boﬁ
 
	mdeföed
;

166 
	mÊags
;

167 #i‚de‡
ENABLE_LZO_STUB


168 
lzo_voidp
 
	mwmem
;

169 
	mwmem_size
;

170 
lzo_ad≠tive_com¥ess
 
	mac
;

173 
cou¡î_ty≥
 
	m¥e_decom¥ess
;

174 
cou¡î_ty≥
 
	mpo°_decom¥ess
;

175 
cou¡î_ty≥
 
	m¥e_com¥ess
;

176 
cou¡î_ty≥
 
	mpo°_com¥ess
;

197 
lzo_adju°_‰ame_∑ømëîs
(
‰ame
 *frame);

213 
lzo_com¥ess_öô
 (
lzo_com¥ess_w‹k•a˚
 *
lzow‹k
, 
Êags
);

223 
lzo_com¥ess_unöô
 (
lzo_com¥ess_w‹k•a˚
 *
lzow‹k
);

233 
lzo_modify_Êags
 (
lzo_com¥ess_w‹k•a˚
 *
lzow‹k
, 
Êags
);

271 
lzo_com¥ess
 (
buf„r
 *
buf
, buf„∏
w‹k
,

272 
lzo_com¥ess_w‹k•a˚
 *
lzow‹k
,

273 c⁄° 
‰ame
* frame);

307 
lzo_decom¥ess
 (
buf„r
 *
buf
, buf„∏
w‹k
,

308 
lzo_com¥ess_w‹k•a˚
 *
lzow‹k
,

309 c⁄° 
‰ame
* frame);

325 
lzo_¥öt_°©s
 (c⁄° 
lzo_com¥ess_w‹k•a˚
 *
lzo_compw‹k
, 
°©us_ouçut
 *
so
);

334 
ölöe
 
boﬁ


335 
	$lzo_deföed
 (c⁄° 
lzo_com¥ess_w‹k•a˚
 *
lzow‹k
)

337  
lzow‹k
->
deföed
;

338 
	}
}

	@src/openvpn/manage.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #ifde‡
ENABLE_MANAGEMENT


35 
	~"îr‹.h
"

36 
	~"fdmisc.h
"

37 
	~"›ti⁄s.h
"

38 
	~"sig.h
"

39 
	~"evít.h
"

40 
	~"Ÿime.h
"

41 
	~"öãgî.h
"

42 
	~"misc.h
"

43 
	~"s¶.h
"

44 
	~"comm⁄.h
"

45 
	~"m™age.h
"

47 
	~"memdbg.h
"

49 #ifde‡
ENABLE_PKCS11


50 
	~"pkcs11.h
"

53 
	#MANAGEMENT_ECHO_PULL_INFO
 0

	)

55 #i‡
MANAGEMENT_ECHO_PULL_INFO


56 
	#MANAGEMENT_ECHO_FLAGS
 
LOG_PRINT_INTVAL


	)

58 
	#MANAGEMENT_ECHO_FLAGS
 0

	)

62 c⁄° 
	gbœnk_up
[] = "[[BLANK]]";

64 
m™agemít
 *
	gm™agemít
;

67 
m™_ouçut_°™dÆ⁄e
 (
m™agemít
 *
m™
, vﬁ©ûê*
sig«l_ª˚ived
);

68 
m™_ª£t_˛õ¡_sockë
 (
m™agemít
 *
m™
, c⁄° 
boﬁ
 
exôög
);

71 
	$m™_hñp
 ()

73 
	`msg
 (
M_CLIENT
, "M™agemíàI¡îÁ˚ f‹ %s", 
tôÀ_°rög
);

74 
	`msg
 (
M_CLIENT
, "Commands:");

75 
	`msg
 (
M_CLIENT
, "auth-retryÅ : Auth failureÑetry mode (none,interact,nointeract).");

76 
	`msg
 (
M_CLIENT
, "bytecountÇ : Show bytes in/out, updateÉveryÇ secs (0=off).");

77 
	`msg
 (
M_CLIENT
, "echo [on|off] [N|all] : LikeÜog, but only show messages inÉcho buffer.");

78 
	`msg
 (
M_CLIENT
, "exit|quit : Close management session.");

79 
	`msg
 (
M_CLIENT
, "forget-passwords : ForgetÖasswordsÉntered so far.");

80 
	`msg
 (
M_CLIENT
, "help : PrintÅhis message.");

81 
	`msg
 (
M_CLIENT
, "hold [on|off|release] : Set/show hold flagÅo on/off state, or");

82 
	`msg
 (
M_CLIENT
, "Ñelease current holdánd startÅunnel.");

83 
	`msg
 (
M_CLIENT
, "kill cn : KillÅhe client instance(s) having commonÇame cn.");

84 
	`msg
 (
M_CLIENT
, "kill IP:port : KillÅhe client instance connecting from IP:port.");

85 
	`msg
 (
M_CLIENT
, "load-stats : Show global serverÜoad stats.");

86 
	`msg
 (
M_CLIENT
, "log [on|off] [N|all] : Turn on/offÑealtimeÜog display");

87 
	`msg
 (
M_CLIENT
, " + showÜast NÜines or 'all' forÉntire history.");

88 
	`msg
 (
M_CLIENT
, "mute [n] : SetÜog muteÜevelÅoÇ, or showÜevel ifÇ isábsent.");

89 
	`msg
 (
M_CLIENT
, "needokÅypeáction : Enter confirmation for NEED-OKÑequest of 'type',");

90 
	`msg
 (
M_CLIENT
, " whereáction = 'ok' or 'cancel'.");

91 
	`msg
 (
M_CLIENT
, "needstrÅypeáction : Enter confirmation for NEED-STRÑequest of 'type',");

92 
	`msg
 (
M_CLIENT
, " whereáction isÑeply string.");

93 
	`msg
 (
M_CLIENT
, "net : (Windows only) ShowÇetwork infoándÑoutingÅable.");

94 
	`msg
 (
M_CLIENT
, "passwordÅypeÖ : EnterÖasswordÖ forá queried OpenVPNÖassword.");

95 
	`msg
 (
M_CLIENT
, "remoteÅype [hostÖort] : OverrideÑemote directive,Åype=ACCEPT|MOD|SKIP.");

96 
	`msg
 (
M_CLIENT
, "proxyÅype [hostÖort flags] : Enter dynamicÖroxy server info.");

97 
	`msg
 (
M_CLIENT
, "pid : ShowÖrocess ID ofÅhe current OpenVPNÖrocess.");

98 #ifde‡
ENABLE_PKCS11


99 
	`msg
 (
M_CLIENT
, "pkcs11-id-count : GetÇumber ofávailable PKCS#11 identities.");

100 
	`msg
 (
M_CLIENT
, "pkcs11-id-get index : Get PKCS#11 identityát index.");

102 #ifde‡
MANAGEMENT_DEF_AUTH


103 
	`msg
 (
M_CLIENT
, "client-auth CID KID : Authenticate client-id/key-id CID/KID (MULTILINE)");

104 
	`msg
 (
M_CLIENT
, "client-auth-nt CID KID : Authenticate client-id/key-id CID/KID");

105 
	`msg
 (
M_CLIENT
, "client-deny CID KID R [CR] : Denyáuth client-id/key-id CID/KID withÜogÑeason");

106 
	`msg
 (
M_CLIENT
, "Åext Ránd optional clientÑeasonÅext CR");

107 
	`msg
 (
M_CLIENT
, "client-kill CID [M] : Kill client instance CID with message M (def=RESTART)");

108 
	`msg
 (
M_CLIENT
, "env-filter [level] : SetÉnv-var filterÜevel");

109 #ifde‡
MANAGEMENT_PF


110 
	`msg
 (
M_CLIENT
, "client-pf CID : DefineÖacket filter for client CID (MULTILINE)");

113 #ifde‡
MANAGMENT_EXTERNAL_KEY


114 
	`msg
 (
M_CLIENT
, "rsa-sig : Enterán RSA signature inÑesponseÅo >RSA_SIGN challenge");

115 
	`msg
 (
M_CLIENT
, " Enter signature base64 on subsequentÜines followed by END");

117 
	`msg
 (
M_CLIENT
, "signal s : Send signal sÅo daemon,");

118 
	`msg
 (
M_CLIENT
, " s = SIGHUP|SIGTERM|SIGUSR1|SIGUSR2.");

119 
	`msg
 (
M_CLIENT
, "state [on|off] [N|all] : LikeÜog, but show state history.");

120 
	`msg
 (
M_CLIENT
, "status [n] : Show current daemon status info using format #n.");

121 
	`msg
 (
M_CLIENT
, "testÇ : ProduceÇÜines of output forÅesting/debugging.");

122 
	`msg
 (
M_CLIENT
, "usernameÅype u : Enter username u forá queried OpenVPN username.");

123 
	`msg
 (
M_CLIENT
, "verb [n] : SetÜog verbosityÜevelÅoÇ, or show ifÇ isábsent.");

124 
	`msg
 (
M_CLIENT
, "version : Show current versionÇumber.");

125 
	`msg
 (
M_CLIENT
, "END");

126 
	}
}

129 
	$m™_°©e_«me
 (c⁄° 
°©e
)

131 
°©e
)

133 
OPENVPN_STATE_INITIAL
:

135 
OPENVPN_STATE_CONNECTING
:

137 
OPENVPN_STATE_WAIT
:

139 
OPENVPN_STATE_AUTH
:

141 
OPENVPN_STATE_GET_CONFIG
:

143 
OPENVPN_STATE_ASSIGN_IP
:

145 
OPENVPN_STATE_ADD_ROUTES
:

147 
OPENVPN_STATE_CONNECTED
:

149 
OPENVPN_STATE_RECONNECTING
:

151 
OPENVPN_STATE_EXITING
:

153 
OPENVPN_STATE_RESOLVE
:

155 
OPENVPN_STATE_TCP_CONNECT
:

160 
	}
}

163 
	$m™_wñcome
 (
m™agemít
 *
m™
)

165 
	`msg
 (
M_CLIENT
, ">INFO:OpenVPN Management Interface Version %d --Åype 'help' for more info",

166 
MANAGEMENT_VERSION
);

167 i‡(
m™
->
≥rsi°
.
•ecül_°©e_msg
)

168 
	`msg
 (
M_CLIENT
, "%s", 
m™
->
≥rsi°
.
•ecül_°©e_msg
);

169 
	}
}

171 
ölöe
 
boﬁ


172 
	$m™_∑ssw‹d_√eded
 (
m™agemít
 *
m™
)

174  
m™
->
£âögs
.
up
.
deföed
 && !m™->
c⁄√˘i⁄
.
∑ssw‹d_vîifõd
;

175 
	}
}

178 
	$m™_check_∑ssw‹d
 (
m™agemít
 *
m™
, c⁄° *
löe
)

180 i‡(
	`m™_∑ssw‹d_√eded
 (
m™
))

182 i‡(
	`°ªq
 (
löe
, 
m™
->
£âögs
.
up
.
∑ssw‹d
))

184 
m™
->
c⁄√˘i⁄
.
∑ssw‹d_vîifõd
 = 
åue
;

185 
	`msg
 (
M_CLIENT
, "SUCCESS:Öassword is correct");

186 
	`m™_wñcome
 (
m™
);

190 
m™
->
c⁄√˘i⁄
.
∑ssw‹d_vîifõd
 = 
Ál£
;

191 
	`msg
 (
M_CLIENT
, "ERROR: badÖassword");

192 i‡(++
m™
->
c⁄√˘i⁄
.
∑ssw‹d_åõs
 >
MANAGEMENT_N_PASSWORD_RETRIES
)

194 
	`msg
 (
M_WARN
, "MAN: client connectionÑejectedáfter %d failedÖasswordáttempts",

195 
MANAGEMENT_N_PASSWORD_RETRIES
);

196 
m™
->
c⁄√˘i⁄
.
hÆt
 = 
åue
;

200 
	}
}

203 
	$m™_upd©e_io_°©e
 (
m™agemít
 *
m™
)

205 i‡(
	`sockë_deföed
 (
m™
->
c⁄√˘i⁄
.
sd_˛i
))

207 i‡(
	`buf„r_li°_deföed
 (
m™
->
c⁄√˘i⁄
.
out
))

209 
m™
->
c⁄√˘i⁄
.
°©e
 = 
MS_CC_WAIT_WRITE
;

213 
m™
->
c⁄√˘i⁄
.
°©e
 = 
MS_CC_WAIT_READ
;

216 
	}
}

219 
	$m™_ouçut_li°_push_föÆize
 (
m™agemít
 *
m™
)

221 i‡(
	`m™agemít_c⁄√˘ed
 (
m™
))

223 
	`m™_upd©e_io_°©e
 (
m™
);

224 i‡(!
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
)

226 vﬁ©ûê
sig«l_ª˚ived
 = 0;

227 
	`m™_ouçut_°™dÆ⁄e
 (
m™
, &
sig«l_ª˚ived
);

230 
	}
}

233 
	$m™_ouçut_li°_push_°r
 (
m™agemít
 *
m™
, c⁄° *
°r
)

235 i‡(
	`m™agemít_c⁄√˘ed
 (
m™
Ë&& 
°r
)

237 
	`buf„r_li°_push
 (
m™
->
c⁄√˘i⁄
.
out
, (c⁄° *Ë
°r
);

239 
	}
}

242 
	$m™_ouçut_li°_push
 (
m™agemít
 *
m™
, c⁄° *
°r
)

244 
	`m™_ouçut_li°_push_°r
 (
m™
, 
°r
);

245 
	`m™_ouçut_li°_push_föÆize
 (
m™
);

246 
	}
}

249 
	$m™_¥om±
 (
m™agemít
 *
m™
)

251 i‡(
	`m™_∑ssw‹d_√eded
 (
m™
))

252 
	`m™_ouçut_li°_push
 (
m™
, "ENTER PASSWORD:");

255 
	`m™_ouçut_li°_push
 (
m™
, ">");

257 
	}
}

260 
	$m™_dñëe_unix_sockë
 (
m™agemít
 *
m™
)

262 #i‡
UNIX_SOCK_SUPPORT


263 i‡((
m™
->
£âögs
.
Êags
 & (
MF_UNIX_SOCK
|
MF_CONNECT_AS_CLIENT
)) == MF_UNIX_SOCK)

264 
	`sockë_dñëe_unix
 (&
m™
->
£âögs
.
loˇl_unix
);

266 
	}
}

269 
	$m™_˛o£_sockë
 (
m™agemít
 *
m™
, c⁄° 
sockë_des¸ùt‹_t
 
sd
)

271 #i‚de‡
WIN32


276 i‡(
m™
->
≥rsi°
.
ˇŒback
.
dñëe_evít
)

277 (*
m™
->
≥rsi°
.
ˇŒback
.
dñëe_evít
Ë(m™->≥rsi°.ˇŒback.
¨g
, 
sd
);

279 
	`›ív≤_˛o£_sockë
 (
sd
);

280 
	}
}

283 
	$vútuÆ_ouçut_ˇŒback_func
 (*
¨g
, c⁄° 
Êags
, c⁄° *
°r
)

285 
m™agemít
 *
m™
 = (m™agemíà*Ë
¨g
;

286 
ªcursive_Àvñ
 = 0;

288 
	#AF_DID_PUSH
 (1<<0)

	)

289 
	#AF_DID_RESET
 (1<<1)

	)

291 i‡(!
ªcursive_Àvñ
)

293 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

294 
log_íåy
 
e
;

295 c⁄° *
out
 = 
NULL
;

296 
a˘i⁄_Êags
 = 0;

298 ++
ªcursive_Àvñ
;

300 
	`CLEAR
 (
e
);

301 
	`upd©e_time
 ();

302 
e
.
time°amp
 = 
now
;

303 
e
.
u
.
msg_Êags
 = 
Êags
;

304 
e
.
°rög
 = 
°r
;

306 i‡(
Êags
 & 
M_FATAL
)

307 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
 = 
Ál£
;

309 i‡(
Êags
 !
M_CLIENT
)

310 
	`log_hi°‹y_add
 (
m™
->
≥rsi°
.
log
, &
e
);

312 i‡(!
	`m™_∑ssw‹d_√eded
 (
m™
))

314 i‡(
Êags
 =
M_CLIENT
)

315 
out
 = 
	`log_íåy_¥öt
 (&
e
, 
LOG_PRINT_CRLF
, &
gc
);

316 i‡(
m™
->
c⁄√˘i⁄
.
log_ªÆtime
)

317 
out
 = 
	`log_íåy_¥öt
 (&
e
, 
LOG_PRINT_INT_DATE


318 | 
LOG_PRINT_MSG_FLAGS


319 | 
LOG_PRINT_LOG_PREFIX


320 | 
LOG_PRINT_CRLF
, &
gc
);

321 i‡(
out
)

323 
	`m™_ouçut_li°_push_°r
 (
m™
, 
out
);

324 
a˘i⁄_Êags
 |
AF_DID_PUSH
;

326 i‡(
Êags
 & 
M_FATAL
)

328 
out
 = 
	`log_íåy_¥öt
 (&
e
, 
LOG_FATAL_NOTIFY
|
LOG_PRINT_CRLF
, &
gc
);

329 i‡(
out
)

331 
	`m™_ouçut_li°_push_°r
 (
m™
, 
out
);

332 
a˘i⁄_Êags
 |(
AF_DID_PUSH
|
AF_DID_RESET
);

337 
	`gc_‰ì
 (&
gc
);

339 i‡(
a˘i⁄_Êags
 & 
AF_DID_PUSH
)

340 
	`m™_ouçut_li°_push_föÆize
 (
m™
);

341 i‡(
a˘i⁄_Êags
 & 
AF_DID_RESET
)

342 
	`m™_ª£t_˛õ¡_sockë
 (
m™
, 
åue
);

344 --
ªcursive_Àvñ
;

346 
	}
}

353 
	$m™_mod_sig«l
 (c⁄° 
m™agemít
 *
m™
, c⁄° 
signum
)

355 c⁄° 
Êags
 = 
m™
->
£âögs
.
m™sig
;

356 
s
 = 
signum
;

357 i‡(
s
 =
SIGUSR1
)

359 i‡(
Êags
 & 
MANSIG_MAP_USR1_TO_HUP
)

360 
s
 = 
SIGHUP
;

361 i‡(
Êags
 & 
MANSIG_MAP_USR1_TO_TERM
)

362 
s
 = 
SIGTERM
;

364 i‡(
Êags
 & 
MANSIG_IGNORE_USR1_HUP
)

366 i‡(
s
 =
SIGHUP
 || s =
SIGUSR1
)

367 
s
 = -1;

369  
s
;

370 
	}
}

373 
	$m™_sig«l
 (
m™agemít
 *
m™
, c⁄° *
«me
)

375 c⁄° 
sig
 = 
	`∑r£_sig«l
 (
«me
);

376 i‡(
sig
 >= 0)

378 c⁄° 
sig_mod
 = 
	`m™_mod_sig«l
 (
m™
, 
sig
);

379 i‡(
sig_mod
 >= 0)

381 
	`throw_sig«l
 (
sig_mod
);

382 
	`msg
 (
M_CLIENT
, "SUCCESS: sig«»%†thrown", 
	`sig«l_«me
 (
sig_mod
, 
åue
));

386 i‡(
m™
->
≥rsi°
.
•ecül_°©e_msg
)

387 
	`msg
 (
M_CLIENT
, "%s", 
m™
->
≥rsi°
.
•ecül_°©e_msg
);

389 
	`msg
 (
M_CLIENT
, "ERROR: sig«»'%s' i†cuºíéy ign‹ed", 
«me
);

394 
	`msg
 (
M_CLIENT
, "ERROR: sig«»'%s' i†nŸá know¿sig«»ty≥", 
«me
);

396 
	}
}

399 
	$m™_°©us
 (
m™agemít
 *
m™
, c⁄° 
vîsi⁄
, 
°©us_ouçut
 *
so
)

401 i‡(
m™
->
≥rsi°
.
ˇŒback
.
°©us
)

403 (*
m™
->
≥rsi°
.
ˇŒback
.
°©us
Ë(m™->≥rsi°.ˇŒback.
¨g
, 
vîsi⁄
, 
so
);

407 
	`msg
 (
M_CLIENT
, "ERROR: The 'status' command isÇot supported byÅhe current daemon mode");

409 
	}
}

412 
	$m™_byãcou¡
 (
m™agemít
 *
m™
, c⁄° 
upd©e_£c⁄ds
)

414 i‡(
upd©e_£c⁄ds
 >= 0)

415 
m™
->
c⁄√˘i⁄
.
byãcou¡_upd©e_£c⁄ds
 = 
upd©e_£c⁄ds
;

417 
m™
->
c⁄√˘i⁄
.
byãcou¡_upd©e_£c⁄ds
 = 0;

418 
	`msg
 (
M_CLIENT
, "SUCCESS: bytecount interval changed");

419 
	}
}

422 
	$m™_byãcou¡_ouçut_˛õ¡
 (
m™agemít
 *
m™
)

424 
ö
[32];

425 
out
[32];

427 
	`›ív≤_¢¥ötf
 (
ö
,  (ö), 
cou¡î_f‹m©
, 
m™
->
≥rsi°
.
byãs_ö
);

428 
	`›ív≤_¢¥ötf
 (
out
,  (out), 
cou¡î_f‹m©
, 
m™
->
≥rsi°
.
byãs_out
);

429 
	`msg
 (
M_CLIENT
, ">BYTECOUNT:%s,%s", 
ö
, 
out
);

430 
m™
->
c⁄√˘i⁄
.
byãcou¡_œ°_upd©e
 = 
now
;

431 
	}
}

433 #ifde‡
MANAGEMENT_DEF_AUTH


436 
	$m™_byãcou¡_ouçut_£rvî
 (
m™agemít
 *
m™
,

437 c⁄° 
cou¡î_ty≥
 *
byãs_ö_tŸÆ
,

438 c⁄° 
cou¡î_ty≥
 *
byãs_out_tŸÆ
,

439 
m™_def_auth_c⁄ãxt
 *
mdac
)

441 
ö
[32];

442 
out
[32];

444 
	`›ív≤_¢¥ötf
 (
ö
,  (ö), 
cou¡î_f‹m©
, *
byãs_ö_tŸÆ
);

445 
	`›ív≤_¢¥ötf
 (
out
,  (out), 
cou¡î_f‹m©
, *
byãs_out_tŸÆ
);

446 
	`msg
 (
M_CLIENT
, ">BYTECOUNT_CLI:%lu,%s,%s", 
mdac
->
cid
, 
ö
, 
out
);

447 
mdac
->
byãcou¡_œ°_upd©e
 = 
now
;

448 
	}
}

453 
	$m™_kûl
 (
m™agemít
 *
m™
, c⁄° *
vi˘im
)

455 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

457 i‡(
m™
->
≥rsi°
.
ˇŒback
.
kûl_by_˙
 && m™->≥rsi°.ˇŒback.
kûl_by_addr
)

459 
buf„r
 
buf
;

460 
p1
[128];

461 
p2
[128];

462 
n_kûÀd
;

464 
	`buf_£t_ªad
 (&
buf
, (
uöt8_t
*Ë
vi˘im
, 
	`°æí
 (victim) + 1);

465 
	`buf_∑r£
 (&
buf
, ':', 
p1
,  (p1));

466 
	`buf_∑r£
 (&
buf
, ':', 
p2
,  (p2));

468 i‡(
	`°æí
 (
p1
Ë&& såÀ¿(
p2
))

471 
boﬁ
 
°©us
;

472 c⁄° 
ö_addr_t
 
addr
 = 
	`gëaddr
 (
GETADDR_HOST_ORDER
|
GETADDR_MSG_VIRT_OUT
, 
p1
, 0, &
°©us
, 
NULL
);

473 i‡(
°©us
)

475 c⁄° 
p‹t
 = 
	`©oi
 (
p2
);

476 i‡(
p‹t
 > 0 &&Öort < 65536)

478 
n_kûÀd
 = (*
m™
->
≥rsi°
.
ˇŒback
.
kûl_by_addr
Ë(m™->≥rsi°.ˇŒback.
¨g
, 
addr
, 
p‹t
);

479 i‡(
n_kûÀd
 > 0)

481 
	`msg
 (
M_CLIENT
, "SUCCESS: %d client(s)átáddress %s:%d killed",

482 
n_kûÀd
,

483 
	`¥öt_ö_addr_t
 (
addr
, 0, &
gc
),

484 
p‹t
);

488 
	`msg
 (
M_CLIENT
, "ERROR: clientátáddress %s:%dÇot found",

489 
	`¥öt_ö_addr_t
 (
addr
, 0, &
gc
),

490 
p‹t
);

495 
	`msg
 (
M_CLIENT
, "ERROR:Ö‹ànumbî i†ouào‡ønge: %s", 
p2
);

500 
	`msg
 (
M_CLIENT
, "ERROR:Éº‹Ö¨sög IPáddªss: %s", 
p1
);

503 i‡(
	`°æí
 (
p1
))

506 
n_kûÀd
 = (*
m™
->
≥rsi°
.
ˇŒback
.
kûl_by_˙
Ë(m™->≥rsi°.ˇŒback.
¨g
, 
p1
);

507 i‡(
n_kûÀd
 > 0)

509 
	`msg
 (
M_CLIENT
, "SUCCESS: comm⁄Çamê'%s' found, %d clõ¡(sËkûÀd", 
p1
, 
n_kûÀd
);

513 
	`msg
 (
M_CLIENT
, "ERROR: comm⁄Çamê'%s'ÇŸ found", 
p1
);

518 
	`msg
 (
M_CLIENT
, "ERROR: killÖarse");

523 
	`msg
 (
M_CLIENT
, "ERROR: The 'kill' command isÇot supported byÅhe current daemon mode");

526 
	`gc_‰ì
 (&
gc
);

527 
	}
}

534 
	$m™_hi°‹y
 (
m™agemít
 *
m™
,

535 c⁄° *
∑rm
,

536 c⁄° *
ty≥
,

537 
log_hi°‹y
 *
log
,

538 
boﬁ
 *
ªÆtime
,

539 c⁄° 
Àp_Êags
)

541 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

542 
n
 = 0;

544 i‡(
	`°ªq
 (
∑rm
, "on"))

546 *
ªÆtime
 = 
åue
;

547 
	`msg
 (
M_CLIENT
, "SUCCESS:Ñól-timê%†nŸifiˇti⁄ sëÅÿON", 
ty≥
);

549 i‡(
	`°ªq
 (
∑rm
, "off"))

551 *
ªÆtime
 = 
Ál£
;

552 
	`msg
 (
M_CLIENT
, "SUCCESS:Ñól-timê%†nŸifiˇti⁄ sëÅÿOFF", 
ty≥
);

554 i‡(
	`°ªq
 (
∑rm
, "Æl"Ë|| (
n
 = 
	`©oi
 (parm)) > 0)

556 c⁄° 
size
 = 
	`log_hi°‹y_size
 (
log
);

557 c⁄° 
°¨t
 = (
n
 ?Ç : 
size
) - 1;

558 
i
;

560 
i
 = 
°¨t
; i >= 0; --i)

562 c⁄° 
log_íåy
 *
e
 = 
	`log_hi°‹y_ªf
 (
log
, 
i
);

563 i‡(
e
)

565 c⁄° *
out
 = 
	`log_íåy_¥öt
 (
e
, 
Àp_Êags
, &
gc
);

566 
	`vútuÆ_ouçut_ˇŒback_func
 (
m™
, 
M_CLIENT
, 
out
);

569 
	`msg
 (
M_CLIENT
, "END");

573 
	`msg
 (
M_CLIENT
, "ERROR: %†∑ømëî mu° bê'⁄' o∏'off' o∏somênumbîÇ o∏'Æl'", 
ty≥
);

576 
	`gc_‰ì
 (&
gc
);

577 
	}
}

580 
	$m™_log
 (
m™agemít
 *
m™
, c⁄° *
∑rm
)

582 
	`m™_hi°‹y
 (
m™
,

583 
∑rm
,

585 
m™
->
≥rsi°
.
log
,

586 &
m™
->
c⁄√˘i⁄
.
log_ªÆtime
,

587 
LOG_PRINT_INT_DATE
|
LOG_PRINT_MSG_FLAGS
);

588 
	}
}

591 
	$m™_echo
 (
m™agemít
 *
m™
, c⁄° *
∑rm
)

593 
	`m™_hi°‹y
 (
m™
,

594 
∑rm
,

596 
m™
->
≥rsi°
.
echo
,

597 &
m™
->
c⁄√˘i⁄
.
echo_ªÆtime
,

598 
LOG_PRINT_INT_DATE
|
MANAGEMENT_ECHO_FLAGS
);

599 
	}
}

602 
	$m™_°©e
 (
m™agemít
 *
m™
, c⁄° *
∑rm
)

604 
	`m™_hi°‹y
 (
m™
,

605 
∑rm
,

607 
m™
->
≥rsi°
.
°©e
,

608 &
m™
->
c⁄√˘i⁄
.
°©e_ªÆtime
,

609 
LOG_PRINT_INT_DATE
|
LOG_PRINT_STATE
|

610 
LOG_PRINT_LOCAL_IP
|
LOG_PRINT_REMOTE_IP
);

611 
	}
}

614 
	$m™_up_föÆize
 (
m™agemít
 *
m™
)

616 
m™
->
c⁄√˘i⁄
.
up_quîy_mode
)

618 
UP_QUERY_USER_PASS
:

619 i‡(!
	`°æí
 (
m™
->
c⁄√˘i⁄
.
up_quîy
.
u£∫ame
))

622 
UP_QUERY_PASS
:

623 
UP_QUERY_NEED_OK
:

624 
UP_QUERY_NEED_STR
:

625 i‡(
	`°æí
 (
m™
->
c⁄√˘i⁄
.
up_quîy
.
∑ssw‹d
))

626 
m™
->
c⁄√˘i⁄
.
up_quîy
.
deföed
 = 
åue
;

628 
UP_QUERY_DISABLED
:

629 
m™
->
c⁄√˘i⁄
.
up_quîy
.
deföed
 = 
Ál£
;

632 
	`ASSERT
 (0);

634 
	}
}

637 
	$m™_quîy_u£r_∑ss
 (
m™agemít
 *
m™
,

638 c⁄° *
ty≥
,

639 c⁄° *
°rög
,

640 c⁄° 
boﬁ
 
√eded
,

641 c⁄° *
¥om±
,

642 *
de°
,

643 
Àn
)

645 i‡(
√eded
)

647 
	`ASSERT
 (
m™
->
c⁄√˘i⁄
.
up_quîy_ty≥
);

648 i‡(
	`°ªq
 (
m™
->
c⁄√˘i⁄
.
up_quîy_ty≥
, 
ty≥
))

650 
	`°∫˝y¡
 (
de°
, 
°rög
, 
Àn
);

651 
	`m™_up_föÆize
 (
m™
);

652 
	`msg
 (
M_CLIENT
, "SUCCESS: '%s' %sÉntered, butÇot yet verified",

653 
ty≥
,

654 
¥om±
);

657 
	`msg
 (
M_CLIENT
, "ERROR: %s ofÅype '%s'Éntered, but weÇeed one ofÅype '%s'",

658 
¥om±
,

659 
ty≥
,

660 
m™
->
c⁄√˘i⁄
.
up_quîy_ty≥
);

664 
	`msg
 (
M_CLIENT
, "ERROR:Çÿ%†i†cuºíéyÇìdedáàthi†time", 
¥om±
);

666 
	}
}

669 
	$m™_quîy_u£∫ame
 (
m™agemít
 *
m™
, c⁄° *
ty≥
, c⁄° *
°rög
)

671 c⁄° 
boﬁ
 
√eded
 = ((
m™
->
c⁄√˘i⁄
.
up_quîy_mode
 =
UP_QUERY_USER_PASS


672 Ë&& 
m™
->
c⁄√˘i⁄
.
up_quîy_ty≥
);

673 
	`m™_quîy_u£r_∑ss
 (
m™
, 
ty≥
, 
°rög
, 
√eded
, "u£∫ame", m™->
c⁄√˘i⁄
.
up_quîy
.
u£∫ame
, 
USER_PASS_LEN
);

674 
	}
}

677 
	$m™_quîy_∑ssw‹d
 (
m™agemít
 *
m™
, c⁄° *
ty≥
, c⁄° *
°rög
)

679 c⁄° 
boﬁ
 
√eded
 = ((
m™
->
c⁄√˘i⁄
.
up_quîy_mode
 =
UP_QUERY_PASS


680 || 
m™
->
c⁄√˘i⁄
.
up_quîy_mode
 =
UP_QUERY_USER_PASS


681 Ë&& 
m™
->
c⁄√˘i⁄
.
up_quîy_ty≥
);

682 i‡(!
°rög
[0])

683 
°rög
 = 
bœnk_up
;

684 
	`m™_quîy_u£r_∑ss
 (
m™
, 
ty≥
, 
°rög
, 
√eded
, "∑ssw‹d", m™->
c⁄√˘i⁄
.
up_quîy
.
∑ssw‹d
, 
USER_PASS_LEN
);

685 
	}
}

688 
	$m™_quîy_√ed_ok
 (
m™agemít
 *
m™
, c⁄° *
ty≥
, c⁄° *
a˘i⁄
)

690 c⁄° 
boﬁ
 
√eded
 = ((
m™
->
c⁄√˘i⁄
.
up_quîy_mode
 =
UP_QUERY_NEED_OK
Ë&& m™->c⁄√˘i⁄.
up_quîy_ty≥
);

691 
	`m™_quîy_u£r_∑ss
 (
m™
, 
ty≥
, 
a˘i⁄
, 
√eded
, "√edok-c⁄fúm©i⁄", m™->
c⁄√˘i⁄
.
up_quîy
.
∑ssw‹d
, 
USER_PASS_LEN
);

692 
	}
}

695 
	$m™_quîy_√ed_°r
 (
m™agemít
 *
m™
, c⁄° *
ty≥
, c⁄° *
a˘i⁄
)

697 c⁄° 
boﬁ
 
√eded
 = ((
m™
->
c⁄√˘i⁄
.
up_quîy_mode
 =
UP_QUERY_NEED_STR
Ë&& m™->c⁄√˘i⁄.
up_quîy_ty≥
);

698 
	`m™_quîy_u£r_∑ss
 (
m™
, 
ty≥
, 
a˘i⁄
, 
√eded
, "√ed°r-°rög", m™->
c⁄√˘i⁄
.
up_quîy
.
∑ssw‹d
, 
USER_PASS_LEN
);

699 
	}
}

702 
	$m™_f‹gë_∑ssw‹ds
 (
m™agemít
 *
m™
)

704 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

705 
	`s¶_purge_auth
 (
Ál£
);

706 
	`msg
 (
M_CLIENT
, "SUCCESS: Passwords were forgotten");

708 
	}
}

711 
	$m™_√t
 (
m™agemít
 *
m™
)

713 i‡(
m™
->
≥rsi°
.
ˇŒback
.
show_√t
)

715 (*
m™
->
≥rsi°
.
ˇŒback
.
show_√t
Ë(m™->≥rsi°.ˇŒback.
¨g
, 
M_CLIENT
);

719 
	`msg
 (
M_CLIENT
, "ERROR: The 'net' command isÇot supported byÅhe current daemon mode");

721 
	}
}

723 #ifde‡
ENABLE_PKCS11


726 
	$m™_pkcs11_id_cou¡
 (
m™agemít
 *
m™
)

728 
	`msg
 (
M_CLIENT
, ">PKCS11ID-COUNT:%d", 
	`pkcs11_m™agemít_id_cou¡
 ());

729 
	}
}

732 
	$m™_pkcs11_id_gë
 (
m™agemít
 *
m™
, c⁄° 
ödex
)

734 *
id
 = 
NULL
;

735 *
ba£64
 = 
NULL
;

737 i‡(
	`pkcs11_m™agemít_id_gë
 (
ödex
, &
id
, &
ba£64
))

738 
	`msg
 (
M_CLIENT
, ">PKCS11ID-ENTRY:'%d', ID:'%s', BLOB:'%s'", 
ödex
, 
id
, 
ba£64
);

740 
	`msg
 (
M_CLIENT
, ">PKCS11ID-ENTRY:'%d'", 
ödex
);

742 i‡(
id
 !
NULL
)

743 
	`‰ì
 (
id
);

744 i‡(
ba£64
 !
NULL
)

745 
	`‰ì
 (
ba£64
);

746 
	}
}

751 
	$m™_hﬁd
 (
m™agemít
 *
m™
, c⁄° *
cmd
)

753 i‡(
cmd
)

755 i‡(
	`°ªq
 (
cmd
, "on"))

757 
m™
->
£âögs
.
Êags
 |
MF_HOLD
;

758 
	`msg
 (
M_CLIENT
, "SUCCESS: hold flag setÅo ON");

760 i‡(
	`°ªq
 (
cmd
, "off"))

762 
m™
->
£âögs
.
Êags
 &~
MF_HOLD
;

763 
	`msg
 (
M_CLIENT
, "SUCCESS: hold flag setÅo OFF");

765 i‡(
	`°ªq
 (
cmd
, "release"))

767 
m™
->
≥rsi°
.
hﬁd_ªÀa£
 = 
åue
;

768 
	`msg
 (
M_CLIENT
, "SUCCESS: holdÑelease succeeded");

772 
	`msg
 (
M_CLIENT
, "ERROR: bad hold commandÖarameter");

776 
	`msg
 (
M_CLIENT
, "SUCCESS: hﬁd=%d", 
	`BOOL_CAST
(
m™
->
£âögs
.
Êags
 & 
MF_HOLD
));

777 
	}
}

779 #ifde‡
MANAGEMENT_IN_EXTRA


781 
	#IER_RESET
 0

	)

782 
	#IER_NEW
 1

	)

785 
	$ö_exåa_ª£t
 (
m™_c⁄√˘i⁄
 *
mc
, c⁄° 
mode
)

787 i‡(
mc
)

789 i‡(
mode
 !
IER_NEW
)

791 
mc
->
ö_exåa_cmd
 = 
IEC_UNDEF
;

792 #ifde‡
MANAGEMENT_DEF_AUTH


793 
mc
->
ö_exåa_cid
 = 0;

794 
mc
->
ö_exåa_kid
 = 0;

797 i‡(
mc
->
ö_exåa
)

799 
	`buf„r_li°_‰ì
 (
mc
->
ö_exåa
);

800 
mc
->
ö_exåa
 = 
NULL
;

802 i‡(
mode
 =
IER_NEW
)

803 
mc
->
ö_exåa
 = 
	`buf„r_li°_√w
 (0);

805 
	}
}

808 
	$ö_exåa_di•©ch
 (
m™agemít
 *
m™
)

810 
m™
->
c⁄√˘i⁄
.
ö_exåa_cmd
)

812 #ifde‡
MANAGEMENT_DEF_AUTH


813 
IEC_CLIENT_AUTH
:

814 i‡(
m™
->
≥rsi°
.
ˇŒback
.
˛õ¡_auth
)

816 c⁄° 
boﬁ
 
°©us
 = (*
m™
->
≥rsi°
.
ˇŒback
.
˛õ¡_auth
)

817 (
m™
->
≥rsi°
.
ˇŒback
.
¨g
,

818 
m™
->
c⁄√˘i⁄
.
ö_exåa_cid
,

819 
m™
->
c⁄√˘i⁄
.
ö_exåa_kid
,

820 
åue
,

821 
NULL
,

822 
NULL
,

823 
m™
->
c⁄√˘i⁄
.
ö_exåa
);

824 
m™
->
c⁄√˘i⁄
.
ö_exåa
 = 
NULL
;

825 i‡(
°©us
)

827 
	`msg
 (
M_CLIENT
, "SUCCESS: client-auth command succeeded");

831 
	`msg
 (
M_CLIENT
, "ERROR: client-auth command failed");

836 
	`msg
 (
M_CLIENT
, "ERROR: The client-auth command isÇot supported byÅhe current daemon mode");

840 #ifde‡
MANAGEMENT_PF


841 
IEC_CLIENT_PF
:

842 i‡(
m™
->
≥rsi°
.
ˇŒback
.
˛õ¡_pf
)

844 c⁄° 
boﬁ
 
°©us
 = (*
m™
->
≥rsi°
.
ˇŒback
.
˛õ¡_pf
)

845 (
m™
->
≥rsi°
.
ˇŒback
.
¨g
,

846 
m™
->
c⁄√˘i⁄
.
ö_exåa_cid
,

847 
m™
->
c⁄√˘i⁄
.
ö_exåa
);

848 
m™
->
c⁄√˘i⁄
.
ö_exåa
 = 
NULL
;

849 i‡(
°©us
)

851 
	`msg
 (
M_CLIENT
, "SUCCESS: client-pf command succeeded");

855 
	`msg
 (
M_CLIENT
, "ERROR: client-pf command failed");

860 
	`msg
 (
M_CLIENT
, "ERROR: The client-pf command isÇot supported byÅhe current daemon mode");

864 #ifde‡
MANAGMENT_EXTERNAL_KEY


865 
IEC_RSA_SIGN
:

866 
m™
->
c⁄√˘i⁄
.
ext_key_°©e
 = 
EKS_READY
;

867 
	`buf„r_li°_‰ì
 (
m™
->
c⁄√˘i⁄
.
ext_key_öput
);

868 
m™
->
c⁄√˘i⁄
.
ext_key_öput
 = m™->c⁄√˘i⁄.
ö_exåa
;

869 
m™
->
c⁄√˘i⁄
.
ö_exåa
 = 
NULL
;

873 
	`ö_exåa_ª£t
 (&
m™
->
c⁄√˘i⁄
, 
IER_RESET
);

874 
	}
}

878 #ifde‡
MANAGEMENT_DEF_AUTH


880 
boﬁ


881 
	$∑r£_cid
 (c⁄° *
°r
, *
cid
)

883 i‡(
	`ssˇnf
 (
°r
, "%lu", 
cid
) == 1)

884  
åue
;

887 
	`msg
 (
M_CLIENT
, "ERROR: cannotÖarse CID");

888  
Ál£
;

890 
	}
}

892 
boﬁ


893 
	$∑r£_kid
 (c⁄° *
°r
, *
kid
)

895 i‡(
	`ssˇnf
 (
°r
, "%u", 
kid
) == 1)

896  
åue
;

899 
	`msg
 (
M_CLIENT
, "ERROR: cannotÖarse KID");

900  
Ál£
;

902 
	}
}

905 
	$m™_˛õ¡_auth
 (
m™agemít
 *
m™
, c⁄° *
cid_°r
, c⁄° *
kid_°r
, c⁄° 
boﬁ
 
exåa
)

907 
m™_c⁄√˘i⁄
 *
mc
 = &
m™
->
c⁄√˘i⁄
;

908 
mc
->
ö_exåa_cid
 = 0;

909 
mc
->
ö_exåa_kid
 = 0;

910 i‡(
	`∑r£_cid
 (
cid_°r
, &
mc
->
ö_exåa_cid
)

911 && 
	`∑r£_kid
 (
kid_°r
, &
mc
->
ö_exåa_kid
))

913 
mc
->
ö_exåa_cmd
 = 
IEC_CLIENT_AUTH
;

914 
	`ö_exåa_ª£t
 (
mc
, 
IER_NEW
);

915 i‡(!
exåa
)

916 
	`ö_exåa_di•©ch
 (
m™
);

918 
	}
}

921 
	$m™_˛õ¡_díy
 (
m™agemít
 *
m™
, c⁄° *
cid_°r
, c⁄° *
kid_°r
, c⁄° *
ªas⁄
, c⁄° *
˛õ¡_ªas⁄
)

923 
cid
 = 0;

924 
kid
 = 0;

925 i‡(
	`∑r£_cid
 (
cid_°r
, &
cid
Ë&& 
	`∑r£_kid
 (
kid_°r
, &
kid
))

927 i‡(
m™
->
≥rsi°
.
ˇŒback
.
˛õ¡_auth
)

929 c⁄° 
boﬁ
 
°©us
 = (*
m™
->
≥rsi°
.
ˇŒback
.
˛õ¡_auth
)

930 (
m™
->
≥rsi°
.
ˇŒback
.
¨g
,

931 
cid
,

932 
kid
,

933 
Ál£
,

934 
ªas⁄
,

935 
˛õ¡_ªas⁄
,

936 
NULL
);

937 i‡(
°©us
)

939 
	`msg
 (
M_CLIENT
, "SUCCESS: client-deny command succeeded");

943 
	`msg
 (
M_CLIENT
, "ERROR: client-deny command failed");

948 
	`msg
 (
M_CLIENT
, "ERROR: The client-deny command isÇot supported byÅhe current daemon mode");

951 
	}
}

954 
	$m™_˛õ¡_kûl
 (
m™agemít
 *
m™
, c⁄° *
cid_°r
, c⁄° *
kûl_msg
)

956 
cid
 = 0;

957 i‡(
	`∑r£_cid
 (
cid_°r
, &
cid
))

959 i‡(
m™
->
≥rsi°
.
ˇŒback
.
kûl_by_cid
)

961 c⁄° 
boﬁ
 
°©us
 = (*
m™
->
≥rsi°
.
ˇŒback
.
kûl_by_cid
Ë(m™->≥rsi°.ˇŒback.
¨g
, 
cid
, 
kûl_msg
);

962 i‡(
°©us
)

964 
	`msg
 (
M_CLIENT
, "SUCCESS: client-kill command succeeded");

968 
	`msg
 (
M_CLIENT
, "ERROR: client-kill command failed");

973 
	`msg
 (
M_CLIENT
, "ERROR: The client-kill command isÇot supported byÅhe current daemon mode");

976 
	}
}

979 
	$m™_˛õ¡_n_˛õ¡s
 (
m™agemít
 *
m™
)

981 i‡(
m™
->
≥rsi°
.
ˇŒback
.
n_˛õ¡s
)

983 c⁄° 
n˛õ¡s
 = (*
m™
->
≥rsi°
.
ˇŒback
.
n_˛õ¡s
Ë(m™->≥rsi°.ˇŒback.
¨g
);

984 
	`msg
 (
M_CLIENT
, "SUCCESS:Ç˛õ¡s=%d", 
n˛õ¡s
);

988 
	`msg
 (
M_CLIENT
, "ERROR: TheÇclients command isÇot supported byÅhe current daemon mode");

990 
	}
}

993 
	$m™_ív_fûãr
 (
m™agemít
 *
m™
, c⁄° 
Àvñ
)

995 
m™
->
c⁄√˘i⁄
.
ív_fûãr_Àvñ
 = 
Àvñ
;

996 
	`msg
 (
M_CLIENT
, "SUCCESS:Énv_fûãr_Àvñ=%d", 
Àvñ
);

997 
	}
}

999 #ifde‡
MANAGEMENT_PF


1002 
	$m™_˛õ¡_pf
 (
m™agemít
 *
m™
, c⁄° *
cid_°r
)

1004 
m™_c⁄√˘i⁄
 *
mc
 = &
m™
->
c⁄√˘i⁄
;

1005 
mc
->
ö_exåa_cid
 = 0;

1006 
mc
->
ö_exåa_kid
 = 0;

1007 i‡(
	`∑r£_cid
 (
cid_°r
, &
mc
->
ö_exåa_cid
))

1009 
mc
->
ö_exåa_cmd
 = 
IEC_CLIENT_PF
;

1010 
	`ö_exåa_ª£t
 (
mc
, 
IER_NEW
);

1012 
	}
}

1017 #ifde‡
MANAGMENT_EXTERNAL_KEY


1020 
	$m™_rß_sig
 (
m™agemít
 *
m™
)

1022 
m™_c⁄√˘i⁄
 *
mc
 = &
m™
->
c⁄√˘i⁄
;

1023 i‡(
mc
->
ext_key_°©e
 =
EKS_SOLICIT
)

1025 
mc
->
ext_key_°©e
 = 
EKS_INPUT
;

1026 
mc
->
ö_exåa_cmd
 = 
IEC_RSA_SIGN
;

1027 
	`ö_exåa_ª£t
 (
mc
, 
IER_NEW
);

1030 
	`msg
 (
M_CLIENT
, "ERROR: TheÑsa-sig command isÇot currentlyávailable");

1031 
	}
}

1036 
	$m™_lﬂd_°©s
 (
m™agemít
 *
m™
)

1038 
cou¡î_ty≥
 
lök_ªad_byãs_globÆ
;

1039 
cou¡î_ty≥
 
lök_wrôe_byãs_globÆ
;

1040 
n˛õ¡s
 = 0;

1042 i‡(
m™
->
≥rsi°
.
ˇŒback
.
n_˛õ¡s
)

1043 
n˛õ¡s
 = (*
m™
->
≥rsi°
.
ˇŒback
.
n_˛õ¡s
Ë(m™->≥rsi°.ˇŒback.
¨g
);

1044 
	`msg
 (
M_CLIENT
, "SUCCESS:Ç˛õ¡s=%d,byãsö=" 
cou¡î_f‹m©
 ",bytesout=" counter_format,

1045 
n˛õ¡s
,

1046 
lök_ªad_byãs_globÆ
,

1047 
lök_wrôe_byãs_globÆ
);

1048 
	}
}

1050 
	#MN_AT_LEAST
 (1<<0)

	)

1052 
boﬁ


1053 
	$m™_√ed
 (
m™agemít
 *
m™
, c⁄° **
p
, c⁄° 
n
, 
Êags
)

1055 
i
;

1056 
	`ASSERT
 (
p
[0]);

1057 
i
 = 1; i <
n
; ++i)

1059 i‡(!
p
[
i
])

1061 
	`msg
 (
M_CLIENT
, "ERROR:Åhe '%s' commandÑequires %s%dÖarameter%s",

1062 
p
[0],

1063 (
Êags
 & 
MN_AT_LEAST
) ? "atÜeast " : "",

1064 
n
,

1065 
n
 > 1 ? "s" : "");

1066  
Ál£
;

1069  
åue
;

1070 
	}
}

1073 
	$m™_¥oxy
 (
m™agemít
 *
m™
, c⁄° **
p
)

1075 i‡(
m™
->
≥rsi°
.
ˇŒback
.
¥oxy_cmd
)

1077 c⁄° 
boﬁ
 
°©us
 = (*
m™
->
≥rsi°
.
ˇŒback
.
¥oxy_cmd
)(m™->≥rsi°.ˇŒback.
¨g
, 
p
);

1078 i‡(
°©us
)

1079 
	`msg
 (
M_CLIENT
, "SUCCESS:Öroxy command succeeded");

1081 
	`msg
 (
M_CLIENT
, "ERROR:Öroxy command failed");

1084 
	`msg
 (
M_CLIENT
, "ERROR: TheÖroxy command isÇot supported byÅhe current daemon mode");

1085 
	}
}

1088 
	$m™_ªmŸe
 (
m™agemít
 *
m™
, c⁄° **
p
)

1090 i‡(
m™
->
≥rsi°
.
ˇŒback
.
ªmŸe_cmd
)

1092 c⁄° 
boﬁ
 
°©us
 = (*
m™
->
≥rsi°
.
ˇŒback
.
ªmŸe_cmd
)(m™->≥rsi°.ˇŒback.
¨g
, 
p
);

1093 i‡(
°©us
)

1095 
	`msg
 (
M_CLIENT
, "SUCCESS:Ñemote command succeeded");

1099 
	`msg
 (
M_CLIENT
, "ERROR:Ñemote command failed");

1104 
	`msg
 (
M_CLIENT
, "ERROR: TheÑemote command isÇot supported byÅhe current daemon mode");

1106 
	}
}

1109 
	$m™_di•©ch_comm™d
 (
m™agemít
 *
m™
, 
°©us_ouçut
 *
so
, c⁄° **
p
, c⁄° 
≈¨ms
)

1111 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1113 
	`ASSERT
 (
p
[0]);

1114 i‡(
	`°ªq
 (
p
[0], "exit") || streq (p[0], "quit"))

1116 
m™
->
c⁄√˘i⁄
.
hÆt
 = 
åue
;

1117 
d⁄e
;

1119 i‡(
	`°ªq
 (
p
[0], "help"))

1121 
	`m™_hñp
 ();

1123 i‡(
	`°ªq
 (
p
[0], "version"))

1125 
	`msg
 (
M_CLIENT
, "O≥nVPN Vîsi⁄: %s", 
tôÀ_°rög
);

1126 
	`msg
 (
M_CLIENT
, "M™agemíàVîsi⁄: %d", 
MANAGEMENT_VERSION
);

1127 
	`msg
 (
M_CLIENT
, "END");

1129 i‡(
	`°ªq
 (
p
[0], "pid"))

1131 
	`msg
 (
M_CLIENT
, "SUCCESS:Öid=%d", 
	`∂©f‹m_gëpid
 ());

1133 #ifde‡
MANAGEMENT_DEF_AUTH


1134 i‡(
	`°ªq
 (
p
[0], "nclients"))

1136 
	`m™_˛õ¡_n_˛õ¡s
 (
m™
);

1138 i‡(
	`°ªq
 (
p
[0], "env-filter"))

1140 
Àvñ
 = 0;

1141 i‡(
p
[1])

1142 
Àvñ
 = 
	`©oi
 (
p
[1]);

1143 
	`m™_ív_fûãr
 (
m™
, 
Àvñ
);

1146 i‡(
	`°ªq
 (
p
[0], "signal"))

1148 i‡(
	`m™_√ed
 (
m™
, 
p
, 1, 0))

1149 
	`m™_sig«l
 (
m™
, 
p
[1]);

1151 i‡(
	`°ªq
 (
p
[0], "load-stats"))

1153 
	`m™_lﬂd_°©s
 (
m™
);

1155 i‡(
	`°ªq
 (
p
[0], "status"))

1157 
vîsi⁄
 = 0;

1158 i‡(
p
[1])

1159 
vîsi⁄
 = 
	`©oi
 (
p
[1]);

1160 
	`m™_°©us
 (
m™
, 
vîsi⁄
, 
so
);

1162 i‡(
	`°ªq
 (
p
[0], "kill"))

1164 i‡(
	`m™_√ed
 (
m™
, 
p
, 1, 0))

1165 
	`m™_kûl
 (
m™
, 
p
[1]);

1167 i‡(
	`°ªq
 (
p
[0], "verb"))

1169 i‡(
p
[1])

1171 c⁄° 
Àvñ
 = 
	`©oi
(
p
[1]);

1172 i‡(
	`£t_debug_Àvñ
 (
Àvñ
, 0))

1173 
	`msg
 (
M_CLIENT
, "SUCCESS: verbÜevel changed");

1175 
	`msg
 (
M_CLIENT
, "ERROR: verbÜevel is out ofÑange");

1178 
	`msg
 (
M_CLIENT
, "SUCCESS: vîb=%d", 
	`gë_debug_Àvñ
 ());

1180 i‡(
	`°ªq
 (
p
[0], "mute"))

1182 i‡(
p
[1])

1184 c⁄° 
Àvñ
 = 
	`©oi
(
p
[1]);

1185 i‡(
	`£t_muã_cutoff
 (
Àvñ
))

1186 
	`msg
 (
M_CLIENT
, "SUCCESS: muteÜevel changed");

1188 
	`msg
 (
M_CLIENT
, "ERROR: muteÜevel is out ofÑange");

1191 
	`msg
 (
M_CLIENT
, "SUCCESS: muã=%d", 
	`gë_muã_cutoff
 ());

1193 i‡(
	`°ªq
 (
p
[0], "auth-retry"))

1195 #i‡
P2MP


1196 i‡(
p
[1])

1198 i‡(
	`auth_ªåy_£t
 (
M_CLIENT
, 
p
[1]))

1199 
	`msg
 (
M_CLIENT
, "SUCCESS:áuth-retryÖarameter changed");

1201 
	`msg
 (
M_CLIENT
, "ERROR: badáuth-retryÖarameter");

1204 
	`msg
 (
M_CLIENT
, "SUCCESS:áuth-ªåy=%s", 
	`auth_ªåy_¥öt
 ());

1206 
	`msg
 (
M_CLIENT
, "ERROR:áuth-retry feature is unavailable");

1209 i‡(
	`°ªq
 (
p
[0], "state"))

1211 i‡(!
p
[1])

1213 
	`m™_°©e
 (
m™
, "1");

1217 i‡(
p
[1])

1218 
	`m™_°©e
 (
m™
, 
p
[1]);

1219 i‡(
p
[2])

1220 
	`m™_°©e
 (
m™
, 
p
[2]);

1223 i‡(
	`°ªq
 (
p
[0], "log"))

1225 i‡(
	`m™_√ed
 (
m™
, 
p
, 1, 
MN_AT_LEAST
))

1227 i‡(
p
[1])

1228 
	`m™_log
 (
m™
, 
p
[1]);

1229 i‡(
p
[2])

1230 
	`m™_log
 (
m™
, 
p
[2]);

1233 i‡(
	`°ªq
 (
p
[0], "echo"))

1235 i‡(
	`m™_√ed
 (
m™
, 
p
, 1, 
MN_AT_LEAST
))

1237 i‡(
p
[1])

1238 
	`m™_echo
 (
m™
, 
p
[1]);

1239 i‡(
p
[2])

1240 
	`m™_echo
 (
m™
, 
p
[2]);

1243 i‡(
	`°ªq
 (
p
[0], "username"))

1245 i‡(
	`m™_√ed
 (
m™
, 
p
, 2, 0))

1246 
	`m™_quîy_u£∫ame
 (
m™
, 
p
[1],Ö[2]);

1248 i‡(
	`°ªq
 (
p
[0], "password"))

1250 i‡(
	`m™_√ed
 (
m™
, 
p
, 2, 0))

1251 
	`m™_quîy_∑ssw‹d
 (
m™
, 
p
[1],Ö[2]);

1253 i‡(
	`°ªq
 (
p
[0], "forget-passwords"))

1255 
	`m™_f‹gë_∑ssw‹ds
 (
m™
);

1257 i‡(
	`°ªq
 (
p
[0], "needok"))

1259 i‡(
	`m™_√ed
 (
m™
, 
p
, 2, 0))

1260 
	`m™_quîy_√ed_ok
 (
m™
, 
p
[1],Ö[2]);

1262 i‡(
	`°ªq
 (
p
[0], "needstr"))

1264 i‡(
	`m™_√ed
 (
m™
, 
p
, 2, 0))

1265 
	`m™_quîy_√ed_°r
 (
m™
, 
p
[1],Ö[2]);

1267 i‡(
	`°ªq
 (
p
[0], "net"))

1269 
	`m™_√t
 (
m™
);

1271 i‡(
	`°ªq
 (
p
[0], "hold"))

1273 
	`m™_hﬁd
 (
m™
, 
p
[1]);

1275 i‡(
	`°ªq
 (
p
[0], "bytecount"))

1277 i‡(
	`m™_√ed
 (
m™
, 
p
, 1, 0))

1278 
	`m™_byãcou¡
 (
m™
, 
	`©oi
(
p
[1]));

1280 #ifde‡
MANAGEMENT_DEF_AUTH


1281 i‡(
	`°ªq
 (
p
[0], "client-kill"))

1283 i‡(
	`m™_√ed
 (
m™
, 
p
, 1, 
MN_AT_LEAST
))

1284 
	`m™_˛õ¡_kûl
 (
m™
, 
p
[1],Ö[2]);

1286 i‡(
	`°ªq
 (
p
[0], "client-deny"))

1288 i‡(
	`m™_√ed
 (
m™
, 
p
, 3, 
MN_AT_LEAST
))

1289 
	`m™_˛õ¡_díy
 (
m™
, 
p
[1],Ö[2],Ö[3],Ö[4]);

1291 i‡(
	`°ªq
 (
p
[0], "client-auth-nt"))

1293 i‡(
	`m™_√ed
 (
m™
, 
p
, 2, 0))

1294 
	`m™_˛õ¡_auth
 (
m™
, 
p
[1],Ö[2], 
Ál£
);

1296 i‡(
	`°ªq
 (
p
[0], "client-auth"))

1298 i‡(
	`m™_√ed
 (
m™
, 
p
, 2, 0))

1299 
	`m™_˛õ¡_auth
 (
m™
, 
p
[1],Ö[2], 
åue
);

1301 #ifde‡
MANAGEMENT_PF


1302 i‡(
	`°ªq
 (
p
[0], "client-pf"))

1304 i‡(
	`m™_√ed
 (
m™
, 
p
, 1, 0))

1305 
	`m™_˛õ¡_pf
 (
m™
, 
p
[1]);

1309 #ifde‡
MANAGMENT_EXTERNAL_KEY


1310 i‡(
	`°ªq
 (
p
[0], "rsa-sig"))

1312 
	`m™_rß_sig
 (
m™
);

1315 #ifde‡
ENABLE_PKCS11


1316 i‡(
	`°ªq
 (
p
[0], "pkcs11-id-count"))

1318 
	`m™_pkcs11_id_cou¡
 (
m™
);

1320 i‡(
	`°ªq
 (
p
[0], "pkcs11-id-get"))

1322 i‡(
	`m™_√ed
 (
m™
, 
p
, 1, 0))

1323 
	`m™_pkcs11_id_gë
 (
m™
, 
	`©oi
(
p
[1]));

1326 i‡(
	`°ªq
 (
p
[0], "proxy"))

1328 i‡(
	`m™_√ed
 (
m™
, 
p
, 1, 
MN_AT_LEAST
))

1329 
	`m™_¥oxy
 (
m™
, 
p
);

1331 i‡(
	`°ªq
 (
p
[0], "remote"))

1333 i‡(
	`m™_√ed
 (
m™
, 
p
, 1, 
MN_AT_LEAST
))

1334 
	`m™_ªmŸe
 (
m™
, 
p
);

1337 i‡(
	`°ªq
 (
p
[0], "test"))

1339 i‡(
	`m™_√ed
 (
m™
, 
p
, 1, 0))

1341 
i
;

1342 c⁄° 
n
 = 
	`©oi
 (
p
[1]);

1343 
i
 = 0; i < 
n
; ++i)

1345 
	`msg
 (
M_CLIENT
, "[%d] ThêpuΩo£ o‡thi†comm™d i†tÿgíî©êœrgêamou¡†o‡ouçut.", 
i
);

1352 
	`msg
 (
M_CLIENT
, "ERROR: unknown command,Énter 'help' for more options");

1355 
d⁄e
:

1356 
	`gc_‰ì
 (&
gc
);

1357 
	}
}

1359 #ifde‡
WIN32


1362 
	$m™_°¨t_√32
 (
m™agemít
 *
m™
)

1364 
m™
->
c⁄√˘i⁄
.
°©e
)

1366 
MS_LISTEN
:

1367 
	`√t_evít_wö32_°¨t
 (&
m™
->
c⁄√˘i⁄
.
√32
, 
FD_ACCEPT
, m™->c⁄√˘i⁄.
sd_t›
);

1369 
MS_CC_WAIT_READ
:

1370 
MS_CC_WAIT_WRITE
:

1371 
	`√t_evít_wö32_°¨t
 (&
m™
->
c⁄√˘i⁄
.
√32
, 
FD_READ
|
FD_WRITE
|
FD_CLOSE
, m™->c⁄√˘i⁄.
sd_˛i
);

1374 
	`ASSERT
 (0);

1376 
	}
}

1379 
	$m™_°›_√32
 (
m™agemít
 *
m™
)

1381 
	`√t_evít_wö32_°›
 (&
m™
->
c⁄√˘i⁄
.
√32
);

1382 
	}
}

1387 
	$m™_ªc‹d_≥î_öfo
 (
m™agemít
 *
m™
)

1389 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1390 i‡(
m™
->
£âögs
.
wrôe_≥î_öfo_fûe
)

1392 
boﬁ
 
suc˚ss
 = 
Ál£
;

1393 #ifde‡
HAVE_GETSOCKNAME


1394 i‡(
	`sockë_deföed
 (
m™
->
c⁄√˘i⁄
.
sd_˛i
))

1396 
sockaddr_ö
 
addr
;

1397 
sockÀn_t
 
addæí
 =  (
addr
);

1398 
°©us
;

1400 
	`CLEAR
 (
addr
);

1401 
°©us
 = 
	`gësock«me
 (
m™
->
c⁄√˘i⁄
.
sd_˛i
, (
sockaddr
 *)&
addr
, &
addæí
);

1402 i‡(!
°©us
 && 
addæí
 = (
addr
))

1404 c⁄° 
ö_addr_t
 
a
 = 
	`¡ohl
 (
addr
.
sö_addr
.
s_addr
);

1405 c⁄° 
p
 = 
	`¡ohs
 (
addr
.
sö_p‹t
);

1406 
FILE
 *
Â
 = 
	`∂©f‹m_f›í
 (
m™
->
£âögs
.
wrôe_≥î_öfo_fûe
, "w");

1407 i‡(
Â
)

1409 
	`Ârötf
 (
Â
, "%s\n%d\n", 
	`¥öt_ö_addr_t
 (
a
, 0, &
gc
), 
p
);

1410 i‡(!
	`f˛o£
 (
Â
))

1411 
suc˚ss
 = 
åue
;

1416 i‡(!
suc˚ss
)

1418 
	`msg
 (
D_MANAGEMENT
, "MANAGEMENT: failedÅo writeÖeer infoÅo file %s",

1419 
m™
->
£âögs
.
wrôe_≥î_öfo_fûe
);

1420 
	`throw_sig«l_so·
 (
SIGTERM
, "management-connect-failed");

1423 
	`gc_‰ì
 (&
gc
);

1424 
	}
}

1427 
	$m™_c⁄√˘i⁄_£âögs_ª£t
 (
m™agemít
 *
m™
)

1429 
m™
->
c⁄√˘i⁄
.
°©e_ªÆtime
 = 
Ál£
;

1430 
m™
->
c⁄√˘i⁄
.
log_ªÆtime
 = 
Ál£
;

1431 
m™
->
c⁄√˘i⁄
.
echo_ªÆtime
 = 
Ál£
;

1432 
m™
->
c⁄√˘i⁄
.
byãcou¡_upd©e_£c⁄ds
 = 0;

1433 
m™
->
c⁄√˘i⁄
.
∑ssw‹d_vîifõd
 = 
Ál£
;

1434 
m™
->
c⁄√˘i⁄
.
∑ssw‹d_åõs
 = 0;

1435 
m™
->
c⁄√˘i⁄
.
hÆt
 = 
Ál£
;

1436 
m™
->
c⁄√˘i⁄
.
°©e
 = 
MS_CC_WAIT_WRITE
;

1437 
	}
}

1440 
	$m™_√w_c⁄√˘i⁄_po°
 (
m™agemít
 *
m™
, c⁄° *
des¸ùti⁄
)

1442 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1444 
	`£t_n⁄block
 (
m™
->
c⁄√˘i⁄
.
sd_˛i
);

1445 
	`£t_˛€xec
 (
m™
->
c⁄√˘i⁄
.
sd_˛i
);

1447 
	`m™_c⁄√˘i⁄_£âögs_ª£t
 (
m™
);

1449 #ifde‡
WIN32


1450 
	`m™_°¨t_√32
 (
m™
);

1453 #i‡
UNIX_SOCK_SUPPORT


1454 i‡(
m™
->
£âögs
.
Êags
 & 
MF_UNIX_SOCK
)

1456 
	`msg
 (
D_MANAGEMENT
, "MANAGEMENT: %s %s",

1457 
des¸ùti⁄
,

1458 
	`sockaddr_unix_«me
 (&
m™
->
£âögs
.
loˇl_unix
, "NULL"));

1462 
	`msg
 (
D_MANAGEMENT
, "MANAGEMENT: %s %s",

1463 
des¸ùti⁄
,

1464 
	`¥öt_sockaddr
 (&
m™
->
£âögs
.
loˇl
, &
gc
));

1466 
	`buf„r_li°_ª£t
 (
m™
->
c⁄√˘i⁄
.
out
);

1468 i‡(!
	`m™_∑ssw‹d_√eded
 (
m™
))

1469 
	`m™_wñcome
 (
m™
);

1470 
	`m™_¥om±
 (
m™
);

1471 
	`m™_upd©e_io_°©e
 (
m™
);

1473 
	`gc_‰ì
 (&
gc
);

1474 
	}
}

1476 #i‡
UNIX_SOCK_SUPPORT


1477 
boﬁ


1478 
	$m™_vîify_unix_≥î_uid_gid
 (
m™agemít
 *
m™
, c⁄° 
sockë_des¸ùt‹_t
 
sd
)

1480 i‡(
	`sockë_deföed
 (
sd
Ë&& (
m™
->
£âögs
.
˛õ¡_uid
 !-1 || m™->£âögs.
˛õ¡_gid
 != -1))

1482 c⁄° 
îr_¥efix
[] = "MANAGEMENT: unix domain socket client connectionÑejected --";

1483 
uid
, 
gid
;

1484 i‡(
	`unix_sockë_gë_≥î_uid_gid
 (
m™
->
c⁄√˘i⁄
.
sd_˛i
, &
uid
, &
gid
))

1486 i‡(
m™
->
£âögs
.
˛õ¡_uid
 !-1 && m™->£âögs.˛õ¡_uid !
uid
)

1488 
	`msg
 (
D_MANAGEMENT
, "%s UID of socketÖeer (%d) doesn't matchÑequired value (%d)ás given by --management-client-user",

1489 
îr_¥efix
, 
uid
, 
m™
->
£âögs
.
˛õ¡_uid
);

1490  
Ál£
;

1492 i‡(
m™
->
£âögs
.
˛õ¡_gid
 !-1 && m™->£âögs.˛õ¡_gid !
gid
)

1494 
	`msg
 (
D_MANAGEMENT
, "%s GID of socketÖeer (%d) doesn't matchÑequired value (%d)ás given by --management-client-group",

1495 
îr_¥efix
, 
gid
, 
m™
->
£âögs
.
˛õ¡_gid
);

1496  
Ál£
;

1501 
	`msg
 (
D_MANAGEMENT
, "%†ˇ¬Ÿ gë UID/GID o‡sockëÖìr", 
îr_¥efix
);

1502  
Ál£
;

1505  
åue
;

1506 
	}
}

1510 
	$m™_ac˚±
 (
m™agemít
 *
m™
)

1512 
lök_sockë_a˘uÆ
 
a˘
;

1513 
	`CLEAR
 (
a˘
);

1518 #i‡
UNIX_SOCK_SUPPORT


1519 i‡(
m™
->
£âögs
.
Êags
 & 
MF_UNIX_SOCK
)

1521 
sockaddr_un
 
ªmŸe
;

1522 
m™
->
c⁄√˘i⁄
.
sd_˛i
 = 
	`sockë_ac˚±_unix
 (m™->c⁄√˘i⁄.
sd_t›
, &
ªmŸe
);

1523 i‡(!
	`m™_vîify_unix_≥î_uid_gid
 (
m™
, m™->
c⁄√˘i⁄
.
sd_˛i
))

1524 
	`sd_˛o£
 (&
m™
->
c⁄√˘i⁄
.
sd_˛i
);

1528 
m™
->
c⁄√˘i⁄
.
sd_˛i
 = 
	`sockë_do_ac˚±
 (m™->c⁄√˘i⁄.
sd_t›
, &
a˘
, 
Ál£
);

1530 i‡(
	`sockë_deföed
 (
m™
->
c⁄√˘i⁄
.
sd_˛i
))

1532 
m™
->
c⁄√˘i⁄
.
ªmŸe
 = 
a˘
.
de°
;

1534 i‡(
	`sockë_deföed
 (
m™
->
c⁄√˘i⁄
.
sd_t›
))

1536 #ifde‡
WIN32


1537 
	`m™_°›_√32
 (
m™
);

1541 
	`m™_√w_c⁄√˘i⁄_po°
 (
m™
, "Client connected from");

1543 
	}
}

1546 
	$m™_li°í
 (
m™agemít
 *
m™
)

1548 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1553 
m™
->
c⁄√˘i⁄
.
°©e
 = 
MS_LISTEN
;

1554 
m™
->
c⁄√˘i⁄
.
sd_˛i
 = 
SOCKET_UNDEFINED
;

1559 i‡(
m™
->
c⁄√˘i⁄
.
sd_t›
 =
SOCKET_UNDEFINED
)

1561 #i‡
UNIX_SOCK_SUPPORT


1562 i‡(
m™
->
£âögs
.
Êags
 & 
MF_UNIX_SOCK
)

1564 
	`m™_dñëe_unix_sockë
 (
m™
);

1565 
m™
->
c⁄√˘i⁄
.
sd_t›
 = 
	`¸óã_sockë_unix
 ();

1566 
	`sockë_böd_unix
 (
m™
->
c⁄√˘i⁄
.
sd_t›
, &m™->
£âögs
.
loˇl_unix
, "MANAGEMENT");

1571 
m™
->
c⁄√˘i⁄
.
sd_t›
 = 
	`¸óã_sockë_t˝
 (
AF_INET
);

1572 
	`sockë_böd
 (
m™
->
c⁄√˘i⁄
.
sd_t›
, &m™->
£âögs
.
loˇl
, "MANAGEMENT");

1578 i‡(
	`li°í
 (
m™
->
c⁄√˘i⁄
.
sd_t›
, 1))

1579 
	`msg
 (
M_ERR
, "MANAGEMENT:Üisten() failed");

1584 
	`£t_n⁄block
 (
m™
->
c⁄√˘i⁄
.
sd_t›
);

1585 
	`£t_˛€xec
 (
m™
->
c⁄√˘i⁄
.
sd_t›
);

1587 #i‡
UNIX_SOCK_SUPPORT


1588 i‡(
m™
->
£âögs
.
Êags
 & 
MF_UNIX_SOCK
)

1590 
	`msg
 (
D_MANAGEMENT
, "MANAGEMENT: unix domain socketÜistening on %s",

1591 
	`sockaddr_unix_«me
 (&
m™
->
£âögs
.
loˇl_unix
, "NULL"));

1595 
	`msg
 (
D_MANAGEMENT
, "MANAGEMENT: TCP SocketÜistening on %s",

1596 
	`¥öt_sockaddr
 (&
m™
->
£âögs
.
loˇl
, &
gc
));

1599 #ifde‡
WIN32


1600 
	`m™_°¨t_√32
 (
m™
);

1603 
	`gc_‰ì
 (&
gc
);

1604 
	}
}

1607 
	$m™_c⁄√˘
 (
m™agemít
 *
m™
)

1609 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1610 
°©us
;

1611 
sig«l_ª˚ived
 = 0;

1616 
m™
->
c⁄√˘i⁄
.
°©e
 = 
MS_INITIAL
;

1617 
m™
->
c⁄√˘i⁄
.
sd_t›
 = 
SOCKET_UNDEFINED
;

1619 #i‡
UNIX_SOCK_SUPPORT


1620 i‡(
m™
->
£âögs
.
Êags
 & 
MF_UNIX_SOCK
)

1622 
m™
->
c⁄√˘i⁄
.
sd_˛i
 = 
	`¸óã_sockë_unix
 ();

1623 
°©us
 = 
	`sockë_c⁄√˘_unix
 (
m™
->
c⁄√˘i⁄
.
sd_˛i
, &m™->
£âögs
.
loˇl_unix
);

1624 i‡(!
°©us
 && !
	`m™_vîify_unix_≥î_uid_gid
 (
m™
, m™->
c⁄√˘i⁄
.
sd_˛i
))

1626 #ifde‡
EPERM


1627 
°©us
 = 
EPERM
;

1629 
°©us
 = 1;

1631 
	`sd_˛o£
 (&
m™
->
c⁄√˘i⁄
.
sd_˛i
);

1637 
m™
->
c⁄√˘i⁄
.
sd_˛i
 = 
	`¸óã_sockë_t˝
 (
AF_INET
);

1638 
°©us
 = 
	`›ív≤_c⁄√˘
 (
m™
->
c⁄√˘i⁄
.
sd_˛i
,

1639 &
m™
->
£âögs
.
loˇl
,

1641 &
sig«l_ª˚ived
);

1644 i‡(
sig«l_ª˚ived
)

1646 
	`throw_sig«l
 (
sig«l_ª˚ived
);

1647 
d⁄e
;

1650 i‡(
°©us
)

1652 #i‡
UNIX_SOCK_SUPPORT


1653 i‡(
m™
->
£âögs
.
Êags
 & 
MF_UNIX_SOCK
)

1655 
	`msg
 (
D_LINK_ERRORS
,

1657 
	`sockaddr_unix_«me
 (&
m™
->
£âögs
.
loˇl_unix
, "NULL"),

1658 
	`°ªº‹_ts
 (
°©us
, &
gc
));

1662 
	`msg
 (
D_LINK_ERRORS
,

1664 
	`¥öt_sockaddr
 (&
m™
->
£âögs
.
loˇl
, &
gc
),

1665 
	`°ªº‹_ts
 (
°©us
, &
gc
));

1666 
	`throw_sig«l_so·
 (
SIGTERM
, "management-connect-failed");

1667 
d⁄e
;

1670 
	`m™_ªc‹d_≥î_öfo
 (
m™
);

1671 
	`m™_√w_c⁄√˘i⁄_po°
 (
m™
, "ConnectedÅo management serverát");

1673 
d⁄e
:

1674 
	`gc_‰ì
 (&
gc
);

1675 
	}
}

1678 
	$m™_ª£t_˛õ¡_sockë
 (
m™agemít
 *
m™
, c⁄° 
boﬁ
 
exôög
)

1680 i‡(
	`sockë_deföed
 (
m™
->
c⁄√˘i⁄
.
sd_˛i
))

1682 #ifde‡
WIN32


1683 
	`m™_°›_√32
 (
m™
);

1685 
	`m™_˛o£_sockë
 (
m™
, m™->
c⁄√˘i⁄
.
sd_˛i
);

1686 
m™
->
c⁄√˘i⁄
.
sd_˛i
 = 
SOCKET_UNDEFINED
;

1687 
m™
->
c⁄√˘i⁄
.
°©e
 = 
MS_INITIAL
;

1688 
	`comm™d_löe_ª£t
 (
m™
->
c⁄√˘i⁄
.
ö
);

1689 
	`buf„r_li°_ª£t
 (
m™
->
c⁄√˘i⁄
.
out
);

1690 #ifde‡
MANAGEMENT_IN_EXTRA


1691 
	`ö_exåa_ª£t
 (&
m™
->
c⁄√˘i⁄
, 
IER_RESET
);

1693 
	`msg
 (
D_MANAGEMENT
, "MANAGEMENT: Client disconnected");

1695 i‡(!
exôög
)

1697 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

1698 i‡(
m™
->
£âögs
.
Êags
 & 
MF_FORGET_DISCONNECT
)

1699 
	`s¶_purge_auth
 (
Ál£
);

1701 i‡(
m™
->
£âögs
.
Êags
 & 
MF_SIGNAL
) {

1702 
mysig
 = 
	`m™_mod_sig«l
 (
m™
, 
SIGUSR1
);

1703 i‡(
mysig
 >= 0)

1705 
	`msg
 (
D_MANAGEMENT
, "MANAGEMENT: Triggering management signal");

1706 
	`throw_sig«l_so·
 (
mysig
, "management-disconnect");

1710 i‡(
m™
->
£âögs
.
Êags
 & 
MF_CONNECT_AS_CLIENT
)

1712 
	`msg
 (
D_MANAGEMENT
, "MANAGEMENT: Triggering managementÉxit");

1713 
	`throw_sig«l_so·
 (
SIGTERM
, "management-exit");

1716 
	`m™_li°í
 (
m™
);

1718 
	}
}

1721 
	$m™_¥o˚ss_comm™d
 (
m™agemít
 *
m™
, c⁄° *
löe
)

1723 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1724 
°©us_ouçut
 *
so
;

1725 
≈¨ms
;

1726 *
∑rms
[
MAX_PARMS
+1];

1728 
	`CLEAR
 (
∑rms
);

1729 
so
 = 
	`°©us_›í
 (
NULL
, 0, -1, &
m™
->
≥rsi°
.
vout
, 0);

1730 #ifde‡
MANAGEMENT_IN_EXTRA


1731 
	`ö_exåa_ª£t
 (&
m™
->
c⁄√˘i⁄
, 
IER_RESET
);

1734 i‡(
	`m™_∑ssw‹d_√eded
 (
m™
))

1736 
	`m™_check_∑ssw‹d
 (
m™
, 
löe
);

1740 
≈¨ms
 = 
	`∑r£_löe
 (
löe
, 
∑rms
, 
MAX_PARMS
, "TCP", 0, 
M_CLIENT
, &
gc
);

1741 i‡(
∑rms
[0] && 
	`°ªq
 (parms[0], "password"))

1742 
	`msg
 (
D_MANAGEMENT_DEBUG
, "MANAGEMENT: CMD 'password [...]'");

1743 i‡(!
	`°ªq
 (
löe
, "load-stats"))

1744 
	`msg
 (
D_MANAGEMENT_DEBUG
, "MANAGEMENT: CMD '%s'", 
löe
);

1749 
i
;

1750 
i
 = 0; i < 
≈¨ms
; ++i)

1751 
	`msg
 (
M_INFO
, "[%d] '%s'", 
i
, 
∑rms
[i]);

1755 i‡(
≈¨ms
 > 0)

1756 
	`m™_di•©ch_comm™d
 (
m™
, 
so
, (c⁄° **)
∑rms
, 
≈¨ms
);

1759 
	`CLEAR
 (
∑rms
);

1760 
	`°©us_˛o£
 (
so
);

1761 
	`gc_‰ì
 (&
gc
);

1762 
	}
}

1764 
boﬁ


1765 
	$m™_io_îr‹
 (
m™agemít
 *
m™
, c⁄° *
¥efix
)

1767 c⁄° 
îr
 = 
	`›ív≤_î∫o
 ();

1769 i‡(!
	`ign‹e_sys_îr‹
 (
îr
))

1771 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1772 
	`msg
 (
D_MANAGEMENT
, "MANAGEMENT: TCP %sÉrror: %s",

1773 
¥efix
,

1774 
	`°ªº‹_ts
 (
îr
, &
gc
));

1775 
	`gc_‰ì
 (&
gc
);

1776  
åue
;

1779  
Ál£
;

1780 
	}
}

1783 
	$m™_ªad
 (
m™agemít
 *
m™
)

1788 
buf
[256];

1789 
Àn
 = 0;

1791 
Àn
 = 
	`ªcv
 (
m™
->
c⁄√˘i⁄
.
sd_˛i
, 
buf
,  (buf), 
MSG_NOSIGNAL
);

1792 i‡(
Àn
 == 0)

1794 
	`m™_ª£t_˛õ¡_sockë
 (
m™
, 
Ál£
);

1796 i‡(
Àn
 > 0)

1798 
boﬁ
 
¥o˚s£d_comm™d
 = 
Ál£
;

1800 
	`ASSERT
 (
Àn
 <(Ë (
buf
));

1801 
	`comm™d_löe_add
 (
m™
->
c⁄√˘i⁄
.
ö
, 
buf
, 
Àn
);

1806 
	`buf„r_li°_ª£t
 (
m™
->
c⁄√˘i⁄
.
out
);

1812 c⁄° *
löe
;

1813 (
löe
 = 
	`comm™d_löe_gë
 (
m™
->
c⁄√˘i⁄
.
ö
)))

1815 #ifde‡
MANAGEMENT_IN_EXTRA


1816 i‡(
m™
->
c⁄√˘i⁄
.
ö_exåa
)

1818 i‡(!
	`°rcmp
 ((*)
löe
, "END"))

1819 
	`ö_exåa_di•©ch
 (
m™
);

1821 
	`buf„r_li°_push
 (
m™
->
c⁄√˘i⁄
.
ö_exåa
, 
löe
);

1825 
	`m™_¥o˚ss_comm™d
 (
m™
, (*Ë
löe
);

1826 i‡(
m™
->
c⁄√˘i⁄
.
hÆt
)

1828 
	`comm™d_löe_√xt
 (
m™
->
c⁄√˘i⁄
.
ö
);

1829 
¥o˚s£d_comm™d
 = 
åue
;

1836 i‡(
m™
->
c⁄√˘i⁄
.
hÆt
)

1838 
	`m™_ª£t_˛õ¡_sockë
 (
m™
, 
Ál£
);

1839 
Àn
 = 0;

1843 i‡(
¥o˚s£d_comm™d
)

1844 
	`m™_¥om±
 (
m™
);

1845 
	`m™_upd©e_io_°©e
 (
m™
);

1850 i‡(
	`m™_io_îr‹
 (
m™
, "recv"))

1851 
	`m™_ª£t_˛õ¡_sockë
 (
m™
, 
Ál£
);

1853  
Àn
;

1854 
	}
}

1857 
	$m™_wrôe
 (
m™agemít
 *
m™
)

1859 c⁄° 
size_höt
 = 1024;

1860 
£¡
 = 0;

1861 c⁄° 
buf„r
 *
buf
;

1863 
	`buf„r_li°_aggªg©e
(
m™
->
c⁄√˘i⁄
.
out
, 
size_höt
);

1864 
buf
 = 
	`buf„r_li°_≥ek
 (
m™
->
c⁄√˘i⁄
.
out
);

1865 i‡(
buf
 && 
	`BLEN
 (buf))

1867 c⁄° 
Àn
 = 
	`mö_öt
 (
size_höt
, 
	`BLEN
 (
buf
));

1868 
£¡
 = 
	`£nd
 (
m™
->
c⁄√˘i⁄
.
sd_˛i
, 
	`BPTR
 (
buf
), 
Àn
, 
MSG_NOSIGNAL
);

1869 i‡(
£¡
 >= 0)

1871 
	`buf„r_li°_adv™˚
 (
m™
->
c⁄√˘i⁄
.
out
, 
£¡
);

1873 i‡(
£¡
 < 0)

1875 i‡(
	`m™_io_îr‹
 (
m™
, "send"))

1876 
	`m™_ª£t_˛õ¡_sockë
 (
m™
, 
Ál£
);

1883 
	`m™_upd©e_io_°©e
 (
m™
);

1885  
£¡
;

1886 
	}
}

1889 
	$m™_c⁄√˘i⁄_˛ór
 (
m™_c⁄√˘i⁄
 *
mc
)

1891 
	`CLEAR
 (*
mc
);

1894 
mc
->
°©e
 = 
MS_INITIAL
;

1897 
mc
->
sd_t›
 = 
SOCKET_UNDEFINED
;

1898 
mc
->
sd_˛i
 = 
SOCKET_UNDEFINED
;

1899 
	}
}

1902 
	$m™_≥rsi°_öô
 (
m™agemít
 *
m™
,

1903 c⁄° 
log_hi°‹y_ˇche
,

1904 c⁄° 
echo_buf„r_size
,

1905 c⁄° 
°©e_buf„r_size
)

1907 
m™_≥rsi°
 *
mp
 = &
m™
->
≥rsi°
;

1908 i‡(!
mp
->
deföed
)

1910 
	`CLEAR
 (*
mp
);

1913 
mp
->
log
 = 
	`log_hi°‹y_öô
 (
log_hi°‹y_ˇche
);

1920 
mp
->
vout
.
func
 = 
vútuÆ_ouçut_ˇŒback_func
;

1921 
mp
->
vout
.
¨g
 = 
m™
;

1922 
mp
->
vout
.
Êags_deÁu…
 = 
M_CLIENT
;

1923 
	`msg_£t_vútuÆ_ouçut
 (&
mp
->
vout
);

1928 
m™
->
≥rsi°
.
echo
 = 
	`log_hi°‹y_öô
 (
echo_buf„r_size
);

1933 
m™
->
≥rsi°
.
°©e
 = 
	`log_hi°‹y_öô
 (
°©e_buf„r_size
);

1935 
mp
->
deföed
 = 
åue
;

1937 
	}
}

1940 
	$m™_≥rsi°_˛o£
 (
m™_≥rsi°
 *
mp
)

1942 i‡(
mp
->
log
)

1944 
	`msg_£t_vútuÆ_ouçut
 (
NULL
);

1945 
	`log_hi°‹y_˛o£
 (
mp
->
log
);

1948 i‡(
mp
->
echo
)

1949 
	`log_hi°‹y_˛o£
 (
mp
->
echo
);

1951 i‡(
mp
->
°©e
)

1952 
	`log_hi°‹y_˛o£
 (
mp
->
°©e
);

1954 
	`CLEAR
 (*
mp
);

1955 
	}
}

1958 
	$m™_£âögs_öô
 (
m™_£âögs
 *
ms
,

1959 c⁄° *
addr
,

1960 c⁄° 
p‹t
,

1961 c⁄° *
∑ss_fûe
,

1962 c⁄° *
˛õ¡_u£r
,

1963 c⁄° *
˛õ¡_group
,

1964 c⁄° 
log_hi°‹y_ˇche
,

1965 c⁄° 
echo_buf„r_size
,

1966 c⁄° 
°©e_buf„r_size
,

1967 c⁄° *
wrôe_≥î_öfo_fûe
,

1968 c⁄° 
ªm≠_sigu§1
,

1969 c⁄° 
Êags
)

1971 i‡(!
ms
->
deföed
)

1973 
	`CLEAR
 (*
ms
);

1975 
ms
->
Êags
 = flags;

1976 
ms
->
˛õ¡_uid
 = -1;

1977 
ms
->
˛õ¡_gid
 = -1;

1982 i‡(
∑ss_fûe
)

1983 
	`gë_u£r_∑ss
 (&
ms
->
up
, 
∑ss_fûe
, "M™agemít", 
GET_USER_PASS_PASSWORD_ONLY
);

1988 i‡(
˛õ¡_u£r
)

1990 
∂©f‹m_°©e_u£r
 
s
;

1991 
	`∂©f‹m_u£r_gë
 (
˛õ¡_u£r
, &
s
);

1992 
ms
->
˛õ¡_uid
 = 
	`∂©f‹m_°©e_u£r_uid
 (&
s
);

1993 
	`msg
 (
D_MANAGEMENT
, "MANAGEMENT: clõ¡_uid=%d", 
ms
->
˛õ¡_uid
);

1994 
	`ASSERT
 (
ms
->
˛õ¡_uid
 >= 0);

1996 i‡(
˛õ¡_group
)

1998 
∂©f‹m_°©e_group
 
s
;

1999 
	`∂©f‹m_group_gë
 (
˛õ¡_group
, &
s
);

2000 
ms
->
˛õ¡_gid
 = 
	`∂©f‹m_°©e_group_gid
 (&
s
);

2001 
	`msg
 (
D_MANAGEMENT
, "MANAGEMENT: clõ¡_gid=%d", 
ms
->
˛õ¡_gid
);

2002 
	`ASSERT
 (
ms
->
˛õ¡_gid
 >= 0);

2005 
ms
->
wrôe_≥î_öfo_fûe
 = 
	`°rög_Æloc
 (wrôe_≥î_öfo_fûe, 
NULL
);

2007 #i‡
UNIX_SOCK_SUPPORT


2008 i‡(
ms
->
Êags
 & 
MF_UNIX_SOCK
)

2009 
	`sockaddr_unix_öô
 (&
ms
->
loˇl_unix
, 
addr
);

2016 
ms
->
loˇl
.
addr
.
ö4
.
sö_Ámûy
 = 
AF_INET
;

2017 
ms
->
loˇl
.
addr
.
ö4
.
sö_addr
.
s_addr
 = 0;

2018 
ms
->
loˇl
.
addr
.
ö4
.
sö_p‹t
 = 
	`ht⁄s
 (
p‹t
);

2024 i‡(
	`°ªq
 (
addr
, "tu¬ñ"Ë&& !(
Êags
 & 
MF_CONNECT_AS_CLIENT
))

2026 
ms
->
m™agemít_ovî_tu¬ñ
 = 
åue
;

2030 
ms
->
loˇl
.
addr
.
ö4
.
sö_addr
.
s_addr
 = 
gëaddr


2031 (
GETADDR_RESOLVE
|
GETADDR_WARN_ON_SIGNAL
|
GETADDR_FATAL
, 
addr
, 0, 
NULL
, NULL);

2038 
ms
->
log_hi°‹y_ˇche
 =Üog_history_cache;

2039 
ms
->
echo_buf„r_size
 =Écho_buffer_size;

2040 
ms
->
°©e_buf„r_size
 = state_buffer_size;

2045 i‡(
ªm≠_sigu§1
 =
SIGHUP
)

2046 
ms
->
m™sig
 |
MANSIG_MAP_USR1_TO_HUP
;

2047 i‡(
ªm≠_sigu§1
 =
SIGTERM
)

2048 
ms
->
m™sig
 |
MANSIG_MAP_USR1_TO_TERM
;

2050 
ms
->
deföed
 = 
åue
;

2052 
	}
}

2055 
	$m™_£âögs_˛o£
 (
m™_£âögs
 *
ms
)

2057 
	`‰ì
 (
ms
->
wrôe_≥î_öfo_fûe
);

2058 
	`CLEAR
 (*
ms
);

2059 
	}
}

2063 
	$m™_c⁄√˘i⁄_öô
 (
m™agemít
 *
m™
)

2065 i‡(
m™
->
c⁄√˘i⁄
.
°©e
 =
MS_INITIAL
)

2067 #ifde‡
WIN32


2072 
	`√t_evít_wö32_öô
 (&
m™
->
c⁄√˘i⁄
.
√32
);

2079 
m™
->
c⁄√˘i⁄
.
ö
 = 
	`comm™d_löe_√w
 (1024);

2080 
m™
->
c⁄√˘i⁄
.
out
 = 
	`buf„r_li°_√w
 (0);

2087 
maxevíts
 = 1;

2088 
m™
->
c⁄√˘i⁄
.
es
 = 
	`evít_£t_öô
 (&
maxevíts
, 
EVENT_METHOD_FAST
);

2094 i‡(
m™
->
£âögs
.
Êags
 & 
MF_CONNECT_AS_CLIENT
)

2095 
	`m™_c⁄√˘
 (
m™
);

2097 
	`m™_li°í
 (
m™
);

2099 
	}
}

2102 
	$m™_c⁄√˘i⁄_˛o£
 (
m™agemít
 *
m™
)

2104 
m™_c⁄√˘i⁄
 *
mc
 = &
m™
->
c⁄√˘i⁄
;

2106 i‡(
mc
->
es
)

2107 
	`evít_‰ì
 (
mc
->
es
);

2108 #ifde‡
WIN32


2109 
	`√t_evít_wö32_˛o£
 (&
mc
->
√32
);

2111 i‡(
	`sockë_deföed
 (
mc
->
sd_t›
))

2113 
	`m™_˛o£_sockë
 (
m™
, 
mc
->
sd_t›
);

2114 
	`m™_dñëe_unix_sockë
 (
m™
);

2116 i‡(
	`sockë_deföed
 (
mc
->
sd_˛i
))

2117 
	`m™_˛o£_sockë
 (
m™
, 
mc
->
sd_˛i
);

2118 i‡(
mc
->
ö
)

2119 
	`comm™d_löe_‰ì
 (
mc
->
ö
);

2120 i‡(
mc
->
out
)

2121 
	`buf„r_li°_‰ì
 (
mc
->
out
);

2122 #ifde‡
MANAGEMENT_IN_EXTRA


2123 
	`ö_exåa_ª£t
 (&
m™
->
c⁄√˘i⁄
, 
IER_RESET
);

2125 #ifde‡
MANAGMENT_EXTERNAL_KEY


2126 
	`buf„r_li°_‰ì
 (
mc
->
ext_key_öput
);

2128 
	`m™_c⁄√˘i⁄_˛ór
 (
mc
);

2129 
	}
}

2131 
m™agemít
 *

2132 
	$m™agemít_öô
 ()

2134 
m™agemít
 *
m™
;

2135 
	`ALLOC_OBJ_CLEAR
 (
m™
, 
m™agemít
);

2137 
	`m™_≥rsi°_öô
 (
m™
,

2138 
MANAGEMENT_LOG_HISTORY_INITIAL_SIZE
,

2139 
MANAGEMENT_ECHO_BUFFER_SIZE
,

2140 
MANAGEMENT_STATE_BUFFER_SIZE
);

2142 
	`m™_c⁄√˘i⁄_˛ór
 (&
m™
->
c⁄√˘i⁄
);

2144  
m™
;

2145 
	}
}

2147 
boﬁ


2148 
	$m™agemít_›í
 (
m™agemít
 *
m™
,

2149 c⁄° *
addr
,

2150 c⁄° 
p‹t
,

2151 c⁄° *
∑ss_fûe
,

2152 c⁄° *
˛õ¡_u£r
,

2153 c⁄° *
˛õ¡_group
,

2154 c⁄° 
log_hi°‹y_ˇche
,

2155 c⁄° 
echo_buf„r_size
,

2156 c⁄° 
°©e_buf„r_size
,

2157 c⁄° *
wrôe_≥î_öfo_fûe
,

2158 c⁄° 
ªm≠_sigu§1
,

2159 c⁄° 
Êags
)

2161 
boﬁ
 
ªt
 = 
Ál£
;

2167 
	`m™_£âögs_öô
 (&
m™
->
£âögs
,

2168 
addr
,

2169 
p‹t
,

2170 
∑ss_fûe
,

2171 
˛õ¡_u£r
,

2172 
˛õ¡_group
,

2173 
log_hi°‹y_ˇche
,

2174 
echo_buf„r_size
,

2175 
°©e_buf„r_size
,

2176 
wrôe_≥î_öfo_fûe
,

2177 
ªm≠_sigu§1
,

2178 
Êags
);

2184 
	`log_hi°‹y_ªsize
 (
m™
->
≥rsi°
.
log
, m™->
£âögs
.
log_hi°‹y_ˇche
);

2185 
	`log_hi°‹y_ªsize
 (
m™
->
≥rsi°
.
echo
, m™->
£âögs
.
echo_buf„r_size
);

2186 
	`log_hi°‹y_ªsize
 (
m™
->
≥rsi°
.
°©e
, m™->
£âögs
.
°©e_buf„r_size
);

2192 i‡(
m™
->
c⁄√˘i⁄
.
°©e
 =
MS_INITIAL
)

2194 i‡(!
m™
->
£âögs
.
m™agemít_ovî_tu¬ñ
)

2196 
	`m™_c⁄√˘i⁄_öô
 (
m™
);

2197 
ªt
 = 
åue
;

2201  
ªt
;

2202 
	}
}

2205 
	$m™agemít_˛o£
 (
m™agemít
 *
m™
)

2207 
	`m™_ouçut_li°_push_föÆize
 (
m™
);

2208 
	`m™_c⁄√˘i⁄_˛o£
 (
m™
);

2209 
	`m™_£âögs_˛o£
 (&
m™
->
£âögs
);

2210 
	`m™_≥rsi°_˛o£
 (&
m™
->
≥rsi°
);

2211 
	`‰ì
 (
m™
);

2212 
	}
}

2215 
	$m™agemít_£t_ˇŒback
 (
m™agemít
 *
m™
,

2216 c⁄° 
m™agemít_ˇŒback
 *
cb
)

2218 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
 = 
åue
;

2219 
m™
->
≥rsi°
.
ˇŒback
 = *
cb
;

2220 
	}
}

2223 
	$m™agemít_˛ór_ˇŒback
 (
m™agemít
 *
m™
)

2225 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
 = 
Ál£
;

2226 
m™
->
≥rsi°
.
hﬁd_ªÀa£
 = 
Ál£
;

2227 
	`CLEAR
 (
m™
->
≥rsi°
.
ˇŒback
);

2228 
	`m™_ouçut_li°_push_föÆize
 (
m™
);

2229 
	}
}

2232 
	$m™agemít_£t_°©e
 (
m™agemít
 *
m™
,

2233 c⁄° 
°©e
,

2234 c⁄° *
dëaû
,

2235 c⁄° 
ö_addr_t
 
tun_loˇl_ù
,

2236 c⁄° 
ö_addr_t
 
tun_ªmŸe_ù
)

2238 i‡(
m™
->
≥rsi°
.
°©e
 && (!(m™->
£âögs
.
Êags
 & 
MF_SERVER
Ë|| sèã < 
OPENVPN_STATE_CLIENT_BASE
))

2240 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2241 
log_íåy
 
e
;

2242 c⁄° *
out
 = 
NULL
;

2244 
	`upd©e_time
 ();

2245 
	`CLEAR
 (
e
);

2246 
e
.
time°amp
 = 
now
;

2247 
e
.
u
.
°©e
 = state;

2248 
e
.
°rög
 = 
dëaû
;

2249 
e
.
loˇl_ù
 = 
tun_loˇl_ù
;

2250 
e
.
ªmŸe_ù
 = 
tun_ªmŸe_ù
;

2252 
	`log_hi°‹y_add
 (
m™
->
≥rsi°
.
°©e
, &
e
);

2254 i‡(
m™
->
c⁄√˘i⁄
.
°©e_ªÆtime
)

2255 
out
 = 
	`log_íåy_¥öt
 (&
e
, 
LOG_PRINT_STATE_PREFIX


2256 | 
LOG_PRINT_INT_DATE


2257 | 
LOG_PRINT_STATE


2258 | 
LOG_PRINT_LOCAL_IP


2259 | 
LOG_PRINT_REMOTE_IP


2260 | 
LOG_PRINT_CRLF


2261 | 
LOG_ECHO_TO_LOG
, &
gc
);

2263 i‡(
out
)

2264 
	`m™_ouçut_li°_push
 (
m™
, 
out
);

2266 
	`gc_‰ì
 (&
gc
);

2268 
	}
}

2270 
boﬁ


2271 
	$ív_fûãr_m©ch
 (c⁄° *
ív_°r
, c⁄° 
ív_fûãr_Àvñ
)

2273 c⁄° *
ív_«mes
[] = {

2291 i‡(
ív_fûãr_Àvñ
 == 0)

2292  
åue
;

2293 i‡(
ív_fûãr_Àvñ
 <1 && !
	`°∫cmp
(
ív_°r
, "X509_", 5))

2294  
åue
;

2295 i‡(
ív_fûãr_Àvñ
 <= 2)

2297 
size_t
 
i
;

2298 
i
 = 0; i < 
	`SIZE
(
ív_«mes
); ++i)

2300 c⁄° *
í
 = 
ív_«mes
[
i
];

2301 c⁄° 
size_t
 
Àn
 = 
	`°æí
(
í
);

2302 i‡(!
	`°∫cmp
(
ív_°r
, 
í
, 
Àn
))

2303  
åue
;

2305  
Ál£
;

2307  
Ál£
;

2308 
	}
}

2311 
	$m™_ouçut_ív
 (c⁄° 
ív_£t
 *
es
, c⁄° 
boﬁ
 
èû
, c⁄° 
ív_fûãr_Àvñ
, c⁄° *
¥efix
)

2313 i‡(
es
)

2315 
ív_ôem
 *
e
;

2316 
e
 = 
es
->
li°
;É !
NULL
;É =É->
√xt
)

2318 i‡(
e
->
°rög
 && (!
ív_fûãr_Àvñ
 || 
	`ív_fûãr_m©ch
(e->string,Énv_filter_level)))

2319 
	`msg
 (
M_CLIENT
, ">%s:ENV,%s", 
¥efix
, 
e
->
°rög
);

2322 i‡(
èû
)

2323 
	`msg
 (
M_CLIENT
, ">%s:ENV,END", 
¥efix
);

2324 
	}
}

2327 
	$m™_ouçut_exåa_ív
 (
m™agemít
 *
m™
, c⁄° *
¥efix
)

2329 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2330 
ív_£t
 *
es
 = 
	`ív_£t_¸óã
 (&
gc
);

2331 i‡(
m™
->
≥rsi°
.
ˇŒback
.
n_˛õ¡s
)

2333 c⁄° 
n˛õ¡s
 = (*
m™
->
≥rsi°
.
ˇŒback
.
n_˛õ¡s
Ë(m™->≥rsi°.ˇŒback.
¨g
);

2334 
	`£ãnv_öt
 (
es
, "n_˛õ¡s", 
n˛õ¡s
);

2336 
	`m™_ouçut_ív
 (
es
, 
Ál£
, 
m™
->
c⁄√˘i⁄
.
ív_fûãr_Àvñ
, 
¥efix
);

2337 
	`gc_‰ì
 (&
gc
);

2338 
	}
}

2341 
	$m™agemít_up_down
(
m™agemít
 *
m™
, c⁄° *
updown
, c⁄° 
ív_£t
 *
es
)

2343 i‡(
m™
->
£âögs
.
Êags
 & 
MF_UP_DOWN
)

2345 
	`msg
 (
M_CLIENT
, ">UPDOWN:%s", 
updown
);

2346 
	`m™_ouçut_ív
 (
es
, 
åue
, 0, "UPDOWN");

2348 
	}
}

2351 
	$m™agemít_nŸify
(
m™agemít
 *
m™
, c⁄° *
£vîôy
, c⁄° *
ty≥
, c⁄° *
ãxt
)

2353 
	`msg
 (
M_CLIENT
, ">NOTIFY:%s,%s,%s", 
£vîôy
, 
ty≥
, 
ãxt
);

2354 
	}
}

2357 
	$m™agemít_nŸify_gíîic
 (
m™agemít
 *
m™
, c⁄° *
°r
)

2359 
	`msg
 (
M_CLIENT
, "%s", 
°r
);

2360 
	}
}

2362 #ifde‡
MANAGEMENT_DEF_AUTH


2364 
boﬁ


2365 
	$vÆid©e_≥î_öfo_löe
(c⁄° *
löe
)

2367 
uöt8_t
 
c
;

2368 
°©e
 = 0;

2369 (
c
=*
löe
++))

2371 
°©e
)

2375 i‡(
c
 ='=' && 
°©e
 == 1)

2376 
°©e
 = 2;

2377 i‡(
	`iß um
(
c
) || c == '_')

2378 
°©e
 = 1;

2380  
Ál£
;

2382 i‡(
	`i•röt
(
c
))

2385  
Ál£
;

2388  (
°©e
 == 2);

2389 
	}
}

2392 
	$m™_ouçut_≥î_öfo_ív
 (
m™agemít
 *
m™
, 
m™_def_auth_c⁄ãxt
 *
mdac
)

2394 
löe
[256];

2395 i‡(
m™
->
≥rsi°
.
ˇŒback
.
gë_≥î_öfo
)

2397 c⁄° *
≥î_öfo
 = (*
m™
->
≥rsi°
.
ˇŒback
.
gë_≥î_öfo
Ë(m™->≥rsi°.ˇŒback.
¨g
, 
mdac
->
cid
);

2398 i‡(
≥î_öfo
)

2400 
buf„r
 
buf
;

2401 
	`buf_£t_ªad
 (&
buf
, (c⁄° 
uöt8_t
 *Ë
≥î_öfo
, 
	`°æí
(peer_info));

2402 
	`buf_∑r£
 (&
buf
, '\n', 
löe
,  (line)))

2404 
	`chomp
 (
löe
);

2405 i‡(
	`vÆid©e_≥î_öfo_löe
(
löe
))

2407 
	`msg
 (
M_CLIENT
, ">CLIENT:ENV,%s", 
löe
);

2410 
	`msg
 (
D_MANAGEMENT
, "validation failed onÖeer_infoÜineÑeceived from client");

2414 
	}
}

2417 
	$m™agemít_nŸify_˛õ¡_√edög_auth
 (
m™agemít
 *management,

2418 c⁄° 
mda_key_id
,

2419 
m™_def_auth_c⁄ãxt
 *
mdac
,

2420 c⁄° 
ív_£t
 *
es
)

2422 i‡(!(
mdac
->
Êags
 & 
DAF_CONNECTION_CLOSED
))

2424 c⁄° *
mode
 = "CONNECT";

2425 i‡(
mdac
->
Êags
 & 
DAF_CONNECTION_ESTABLISHED
)

2426 
mode
 = "REAUTH";

2427 
	`msg
 (
M_CLIENT
, ">CLIENT:%s,%lu,%u", 
mode
, 
mdac
->
cid
, 
mda_key_id
);

2428 
	`m™_ouçut_exåa_ív
 (
m™agemít
, "CLIENT");

2429 
	`m™_ouçut_≥î_öfo_ív
(
m™agemít
, 
mdac
);

2430 
	`m™_ouçut_ív
 (
es
, 
åue
, 
m™agemít
->
c⁄√˘i⁄
.
ív_fûãr_Àvñ
, "CLIENT");

2431 
mdac
->
Êags
 |
DAF_INITIAL_AUTH
;

2433 
	}
}

2436 
	$m™agemít_c⁄√˘i⁄_e°ablished
 (
m™agemít
 *management,

2437 
m™_def_auth_c⁄ãxt
 *
mdac
,

2438 c⁄° 
ív_£t
 *
es
)

2440 
mdac
->
Êags
 |
DAF_CONNECTION_ESTABLISHED
;

2441 
	`msg
 (
M_CLIENT
, ">CLIENT:ESTABLISHED,%lu", 
mdac
->
cid
);

2442 
	`m™_ouçut_exåa_ív
 (
m™agemít
, "CLIENT");

2443 
	`m™_ouçut_ív
 (
es
, 
åue
, 
m™agemít
->
c⁄√˘i⁄
.
ív_fûãr_Àvñ
, "CLIENT");

2444 
	}
}

2447 
	$m™agemít_nŸify_˛õ¡_˛o£
 (
m™agemít
 *management,

2448 
m™_def_auth_c⁄ãxt
 *
mdac
,

2449 c⁄° 
ív_£t
 *
es
)

2451 i‡((
mdac
->
Êags
 & 
DAF_INITIAL_AUTH
Ë&& !(mdac->Êag†& 
DAF_CONNECTION_CLOSED
))

2453 
	`msg
 (
M_CLIENT
, ">CLIENT:DISCONNECT,%lu", 
mdac
->
cid
);

2454 
	`m™_ouçut_ív
 (
es
, 
åue
, 
m™agemít
->
c⁄√˘i⁄
.
ív_fûãr_Àvñ
, "CLIENT");

2455 
mdac
->
Êags
 |
DAF_CONNECTION_CLOSED
;

2457 
	}
}

2460 
	$m™agemít_À¨n_addr
 (
m™agemít
 *management,

2461 
m™_def_auth_c⁄ãxt
 *
mdac
,

2462 c⁄° 
mrouã_addr
 *
addr
,

2463 c⁄° 
boﬁ
 
¥im¨y
)

2465 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2466 i‡((
mdac
->
Êags
 & 
DAF_INITIAL_AUTH
Ë&& !(mdac->Êag†& 
DAF_CONNECTION_CLOSED
))

2468 
	`msg
 (
M_CLIENT
, ">CLIENT:ADDRESS,%lu,%s,%d",

2469 
mdac
->
cid
,

2470 
	`mrouã_addr_¥öt_ex
 (
addr
, 
MAPF_SUBNET
, &
gc
),

2471 
	`BOOL_CAST
 (
¥im¨y
));

2473 
	`gc_‰ì
 (&
gc
);

2474 
	}
}

2479 
	$m™agemít_echo
 (
m™agemít
 *
m™
, c⁄° *
°rög
, c⁄° 
boﬁ
 
puŒ
)

2481 i‡(
m™
->
≥rsi°
.
echo
)

2483 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2484 
log_íåy
 
e
;

2485 c⁄° *
out
 = 
NULL
;

2487 
	`upd©e_time
 ();

2488 
	`CLEAR
 (
e
);

2489 
e
.
time°amp
 = 
now
;

2490 
e
.
°rög
 = string;

2491 
e
.
u
.
ötvÆ
 = 
	`BOOL_CAST
 (
puŒ
);

2493 
	`log_hi°‹y_add
 (
m™
->
≥rsi°
.
echo
, &
e
);

2495 i‡(
m™
->
c⁄√˘i⁄
.
echo_ªÆtime
)

2496 
out
 = 
	`log_íåy_¥öt
 (&
e
, 
LOG_PRINT_INT_DATE
|
LOG_PRINT_ECHO_PREFIX
|
LOG_PRINT_CRLF
|
MANAGEMENT_ECHO_FLAGS
, &
gc
);

2498 i‡(
out
)

2499 
	`m™_ouçut_li°_push
 (
m™
, 
out
);

2501 
	`gc_‰ì
 (&
gc
);

2503 
	}
}

2506 
	$m™agemít_po°_tu¬ñ_›í
 (
m™agemít
 *
m™
, c⁄° 
ö_addr_t
 
tun_loˇl_ù
)

2512 i‡(
m™
->
£âögs
.
m™agemít_ovî_tu¬ñ


2513 && 
m™
->
c⁄√˘i⁄
.
°©e
 =
MS_INITIAL
)

2516 
m™
->
£âögs
.
loˇl
.
addr
.
ö4
.
sö_addr
.
s_addr
 = 
	`ht⁄l
 (
tun_loˇl_ù
);

2517 
	`m™_c⁄√˘i⁄_öô
 (
m™
);

2520 
	}
}

2523 
	$m™agemít_¥e_tu¬ñ_˛o£
 (
m™agemít
 *
m™
)

2525 i‡(
m™
->
£âögs
.
m™agemít_ovî_tu¬ñ
)

2526 
	`m™_c⁄√˘i⁄_˛o£
 (
m™
);

2527 
	}
}

2530 
	$m™agemít_auth_Áûuª
 (
m™agemít
 *
m™
, c⁄° *
ty≥
, c⁄° *
ªas⁄
)

2532 i‡(
ªas⁄
)

2533 
	`msg
 (
M_CLIENT
, ">PASSWORD:Vîifiˇti⁄ Faûed: '%s' ['%s']", 
ty≥
, 
ªas⁄
);

2535 
	`msg
 (
M_CLIENT
, ">PASSWORD:Vîifiˇti⁄ Faûed: '%s'", 
ty≥
);

2536 
	}
}

2539 
	$m™agemít_auth_tokí
 (
m™agemít
 *
m™
, c⁄° *
tokí
)

2541 
	`msg
 (
M_CLIENT
, ">PASSWORD:Auth-Tokí:%s", 
tokí
);

2542 
	}
}

2544 
ölöe
 
boﬁ


2545 
	$m™_≥rsi°_°©e
 (*
≥rsi°ít
, c⁄° 
n
)

2547 i‡(
≥rsi°ít
)

2549 i‡(*
≥rsi°ít
 =()
n
)

2550  
Ál£
;

2551 *
≥rsi°ít
 = 
n
;

2553  
åue
;

2554 
	}
}

2556 #ifde‡
WIN32


2559 
	$m™agemít_sockë_£t
 (
m™agemít
 *
m™
,

2560 
evít_£t
 *
es
,

2561 *
¨g
,

2562 *
≥rsi°ít
)

2564 i‡(
m™
->
c⁄√˘i⁄
.
°©e
 !
MS_INITIAL
)

2566 
evít_t
 
ev
 = 
	`√t_evít_wö32_gë_evít
 (&
m™
->
c⁄√˘i⁄
.
√32
);

2567 
	`√t_evít_wö32_ª£t_wrôe
 (&
m™
->
c⁄√˘i⁄
.
√32
);

2569 
m™
->
c⁄√˘i⁄
.
°©e
)

2571 
MS_LISTEN
:

2572 i‡(
	`m™_≥rsi°_°©e
 (
≥rsi°ít
, 1))

2573 
	`evít_˘l
 (
es
, 
ev
, 
EVENT_READ
, 
¨g
);

2575 
MS_CC_WAIT_READ
:

2576 i‡(
	`m™_≥rsi°_°©e
 (
≥rsi°ít
, 2))

2577 
	`evít_˘l
 (
es
, 
ev
, 
EVENT_READ
, 
¨g
);

2579 
MS_CC_WAIT_WRITE
:

2580 i‡(
	`m™_≥rsi°_°©e
 (
≥rsi°ít
, 3))

2581 
	`evít_˘l
 (
es
, 
ev
, 
EVENT_READ
|
EVENT_WRITE
, 
¨g
);

2584 
	`ASSERT
 (0);

2587 
	}
}

2590 
	$m™agemít_io
 (
m™agemít
 *
m™
)

2592 i‡(
m™
->
c⁄√˘i⁄
.
°©e
 !
MS_INITIAL
)

2594 
√t_evíts
;

2595 
	`√t_evít_wö32_ª£t
 (&
m™
->
c⁄√˘i⁄
.
√32
);

2596 
√t_evíts
 = 
	`√t_evít_wö32_gë_evít_mask
 (&
m™
->
c⁄√˘i⁄
.
√32
);

2598 i‡(
√t_evíts
 & 
FD_CLOSE
)

2600 
	`m™_ª£t_˛õ¡_sockë
 (
m™
, 
Ál£
);

2604 i‡(
m™
->
c⁄√˘i⁄
.
°©e
 =
MS_LISTEN
)

2606 i‡(
√t_evíts
 & 
FD_ACCEPT
)

2608 
	`m™_ac˚±
 (
m™
);

2609 
	`√t_evít_wö32_˛ór_£À˘ed_evíts
 (&
m™
->
c⁄√˘i⁄
.
√32
, 
FD_ACCEPT
);

2612 i‡(
m™
->
c⁄√˘i⁄
.
°©e
 =
MS_CC_WAIT_READ
 || m™->c⁄√˘i⁄.°©ê=
MS_CC_WAIT_WRITE
)

2614 i‡(
√t_evíts
 & 
FD_READ
)

2616 
	`m™_ªad
 (
m™
) > 0)

2618 
	`√t_evít_wö32_˛ór_£À˘ed_evíts
 (&
m™
->
c⁄√˘i⁄
.
√32
, 
FD_READ
);

2621 i‡(
√t_evíts
 & 
FD_WRITE
)

2623 
°©us
;

2624 
°©us
 = 
	`m™_wrôe
 (
m™
);

2625 i‡(
°©us
 < 0 && 
	`WSAGëLa°Eº‹
(Ë=
WSAEWOULDBLOCK
)

2627 
	`√t_evít_wö32_˛ór_£À˘ed_evíts
 (&
m™
->
c⁄√˘i⁄
.
√32
, 
FD_WRITE
);

2633 
	}
}

2638 
	$m™agemít_sockë_£t
 (
m™agemít
 *
m™
,

2639 
evít_£t
 *
es
,

2640 *
¨g
,

2641 *
≥rsi°ít
)

2643 
m™
->
c⁄√˘i⁄
.
°©e
)

2645 
MS_LISTEN
:

2646 i‡(
	`m™_≥rsi°_°©e
 (
≥rsi°ít
, 1))

2647 
	`evít_˘l
 (
es
, 
m™
->
c⁄√˘i⁄
.
sd_t›
, 
EVENT_READ
, 
¨g
);

2649 
MS_CC_WAIT_READ
:

2650 i‡(
	`m™_≥rsi°_°©e
 (
≥rsi°ít
, 2))

2651 
	`evít_˘l
 (
es
, 
m™
->
c⁄√˘i⁄
.
sd_˛i
, 
EVENT_READ
, 
¨g
);

2653 
MS_CC_WAIT_WRITE
:

2654 i‡(
	`m™_≥rsi°_°©e
 (
≥rsi°ít
, 3))

2655 
	`evít_˘l
 (
es
, 
m™
->
c⁄√˘i⁄
.
sd_˛i
, 
EVENT_WRITE
, 
¨g
);

2657 
MS_INITIAL
:

2660 
	`ASSERT
 (0);

2662 
	}
}

2665 
	$m™agemít_io
 (
m™agemít
 *
m™
)

2667 
m™
->
c⁄√˘i⁄
.
°©e
)

2669 
MS_LISTEN
:

2670 
	`m™_ac˚±
 (
m™
);

2672 
MS_CC_WAIT_READ
:

2673 
	`m™_ªad
 (
m™
);

2675 
MS_CC_WAIT_WRITE
:

2676 
	`m™_wrôe
 (
m™
);

2678 
MS_INITIAL
:

2681 
	`ASSERT
 (0);

2683 
	}
}

2687 
ölöe
 
boﬁ


2688 
	$m™_°™dÆ⁄e_ok
 (c⁄° 
m™agemít
 *
m™
)

2690  !
m™
->
£âögs
.
m™agemít_ovî_tu¬ñ
 && m™->
c⁄√˘i⁄
.
°©e
 !
MS_INITIAL
;

2691 
	}
}

2693 
boﬁ


2694 
	$m™_check_f‹_sig«ls
 (vﬁ©ûê*
sig«l_ª˚ived
)

2696 i‡(
sig«l_ª˚ived
)

2698 
	`gë_sig«l
 (
sig«l_ª˚ived
);

2699 i‡(*
sig«l_ª˚ived
)

2700  
åue
;

2702  
Ál£
;

2703 
	}
}

2709 
	$m™_block
 (
m™agemít
 *
m™
, vﬁ©ûê*
sig«l_ª˚ived
, c⁄° 
time_t
 
expúe
)

2711 
timevÆ
 
tv
;

2712 
evít_£t_ªtu∫
 
e§
;

2713 
°©us
 = -1;

2715 i‡(
	`m™_°™dÆ⁄e_ok
 (
m™
))

2717 
åue
)

2719 
	`evít_ª£t
 (
m™
->
c⁄√˘i⁄
.
es
);

2720 
	`m™agemít_sockë_£t
 (
m™
, m™->
c⁄√˘i⁄
.
es
, 
NULL
, NULL);

2721 
tv
.
tv_u£c
 = 0;

2722 
tv
.
tv_£c
 = 1;

2723 i‡(
	`m™_check_f‹_sig«ls
 (
sig«l_ª˚ived
))

2725 
°©us
 = -1;

2728 
°©us
 = 
	`evít_waô
 (
m™
->
c⁄√˘i⁄
.
es
, &
tv
, &
e§
, 1);

2729 
	`upd©e_time
 ();

2730 i‡(
	`m™_check_f‹_sig«ls
 (
sig«l_ª˚ived
))

2732 
°©us
 = -1;

2736 i‡(
°©us
 > 0)

2738 i‡(
expúe
 && 
now
 >=Éxpire)

2741 
°©us
 = 0;

2742 i‡(
sig«l_ª˚ived
)

2743 *
sig«l_ª˚ived
 = 
SIGINT
;

2748  
°©us
;

2749 
	}
}

2755 
	$m™_ouçut_°™dÆ⁄e
 (
m™agemít
 *
m™
, vﬁ©ûê*
sig«l_ª˚ived
)

2757 i‡(
	`m™_°™dÆ⁄e_ok
 (
m™
))

2759 
m™
->
c⁄√˘i⁄
.
°©e
 =
MS_CC_WAIT_WRITE
)

2761 
	`m™agemít_io
 (
m™
);

2762 i‡(
m™
->
c⁄√˘i⁄
.
°©e
 =
MS_CC_WAIT_WRITE
)

2763 
	`m™_block
 (
m™
, 
sig«l_ª˚ived
, 0);

2764 i‡(
sig«l_ª˚ived
 && *signal_received)

2768 
	}
}

2774 
	$m™_°™dÆ⁄e_evít_lo›
 (
m™agemít
 *
m™
, vﬁ©ûê*
sig«l_ª˚ived
, c⁄° 
time_t
 
expúe
)

2776 
°©us
 = -1;

2777 i‡(
	`m™_°™dÆ⁄e_ok
 (
m™
))

2779 
°©us
 = 
	`m™_block
 (
m™
, 
sig«l_ª˚ived
, 
expúe
);

2780 i‡(
°©us
 > 0)

2781 
	`m™agemít_io
 (
m™
);

2783  
°©us
;

2784 
	}
}

2786 
	#MWCC_PASSWORD_WAIT
 (1<<0)

	)

2787 
	#MWCC_HOLD_WAIT
 (1<<1)

	)

2788 
	#MWCC_OTHER_WAIT
 (1<<2)

	)

2794 
	$m™_waô_f‹_˛õ¡_c⁄√˘i⁄
 (
m™agemít
 *
m™
,

2795 vﬁ©ûê*
sig«l_ª˚ived
,

2796 c⁄° 
time_t
 
expúe
,

2797 
Êags
)

2799 
	`ASSERT
 (
	`m™_°™dÆ⁄e_ok
 (
m™
));

2800 i‡(
m™
->
c⁄√˘i⁄
.
°©e
 =
MS_LISTEN
)

2802 i‡(
Êags
 & 
MWCC_PASSWORD_WAIT
)

2803 
	`msg
 (
D_MANAGEMENT
, "NeedÖassword(s) from management interface, waiting...");

2804 i‡(
Êags
 & 
MWCC_HOLD_WAIT
)

2805 
	`msg
 (
D_MANAGEMENT
, "Need holdÑelease from management interface, waiting...");

2806 i‡(
Êags
 & 
MWCC_OTHER_WAIT
)

2807 
	`msg
 (
D_MANAGEMENT
, "Need information from management interface, waiting...");

2809 
	`m™_°™dÆ⁄e_evít_lo›
 (
m™
, 
sig«l_ª˚ived
, 
expúe
);

2810 i‡(
sig«l_ª˚ived
 && *signal_received)

2812 } 
m™
->
c⁄√˘i⁄
.
°©e
 =
MS_LISTEN
 || 
	`m™_∑ssw‹d_√eded
 (man));

2814 
	}
}

2820 
	$m™agemít_evít_lo›_n_£c⁄ds
 (
m™agemít
 *
m™
, 
£c
)

2822 i‡(
	`m™_°™dÆ⁄e_ok
 (
m™
))

2824 vﬁ©ûê
sig«l_ª˚ived
 = 0;

2825 c⁄° 
boﬁ
 
°™dÆ⁄e_dißbÀd_ßve
 = 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
;

2826 
time_t
 
expúe
 = 0;

2828 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
 = 
Ál£
;

2831 
	`upd©e_time
 ();

2832 i‡(
£c
)

2833 
expúe
 = 
now
 + 
£c
;

2836 
	`m™_waô_f‹_˛õ¡_c⁄√˘i⁄
 (
m™
, &
sig«l_ª˚ived
, 
expúe
, 0);

2837 i‡(
sig«l_ª˚ived
)

2843 
	`m™_°™dÆ⁄e_evít_lo›
 (
m™
, &
sig«l_ª˚ived
, 
expúe
);

2844 i‡(!
sig«l_ª˚ived
)

2845 
	`m™_check_f‹_sig«ls
 (&
sig«l_ª˚ived
);

2846 i‡(
sig«l_ª˚ived
)

2848 } 
expúe
);

2851 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
 = 
°™dÆ⁄e_dißbÀd_ßve
;

2855 
	`¶ìp
 (
£c
);

2857 
	}
}

2862 
boﬁ


2863 
	$m™agemít_quîy_u£r_∑ss
 (
m™agemít
 *
m™
,

2864 
u£r_∑ss
 *
up
,

2865 c⁄° *
ty≥
,

2866 c⁄° 
Êags
,

2867 c⁄° *
°©ic_chÆÀnge
)

2869 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2870 
boﬁ
 
ªt
 = 
Ál£
;

2872 i‡(
	`m™_°™dÆ⁄e_ok
 (
m™
))

2874 vﬁ©ûê
sig«l_ª˚ived
 = 0;

2875 c⁄° 
boﬁ
 
°™dÆ⁄e_dißbÀd_ßve
 = 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
;

2876 
buf„r
 
Æît_msg
 = 
	`Æloc_buf_gc
 (128, &
gc
);

2877 c⁄° *
Æît_ty≥
 = 
NULL
;

2878 c⁄° *
¥efix
 = 
NULL
;

2879 
up_quîy_mode
 = 0;

2880 #ifde‡
ENABLE_CLIENT_CR


2881 c⁄° *
sc
 = 
NULL
;

2883 
ªt
 = 
åue
;

2884 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
 = 
Ál£
;

2885 
m™
->
≥rsi°
.
•ecül_°©e_msg
 = 
NULL
;

2887 
	`CLEAR
 (
m™
->
c⁄√˘i⁄
.
up_quîy
);

2889 i‡(
Êags
 & 
GET_USER_PASS_NEED_OK
)

2891 
up_quîy_mode
 = 
UP_QUERY_NEED_OK
;

2892 
¥efix
= "NEED-OK";

2893 
Æît_ty≥
 = "confirmation";

2895 i‡(
Êags
 & 
GET_USER_PASS_NEED_STR
)

2897 
up_quîy_mode
 = 
UP_QUERY_NEED_STR
;

2898 
¥efix
= "NEED-STR";

2899 
Æît_ty≥
 = "string";

2901 i‡(
Êags
 & 
GET_USER_PASS_PASSWORD_ONLY
)

2903 
up_quîy_mode
 = 
UP_QUERY_PASS
;

2904 
¥efix
 = "PASSWORD";

2905 
Æît_ty≥
 = "password";

2909 
up_quîy_mode
 = 
UP_QUERY_USER_PASS
;

2910 
¥efix
 = "PASSWORD";

2911 
Æît_ty≥
 = "username/password";

2912 #ifde‡
ENABLE_CLIENT_CR


2913 i‡(
°©ic_chÆÀnge
)

2914 
sc
 = 
°©ic_chÆÀnge
;

2917 
	`buf_¥ötf
 (&
Æît_msg
, ">%s:Need '%s' %s",

2918 
¥efix
,

2919 
ty≥
,

2920 
Æît_ty≥
);

2922 i‡(
Êags
 & (
GET_USER_PASS_NEED_OK
 | 
GET_USER_PASS_NEED_STR
))

2923 
	`buf_¥ötf
 (&
Æît_msg
, " MSG:%s", 
up
->
u£∫ame
);

2925 #ifde‡
ENABLE_CLIENT_CR


2926 i‡(
sc
)

2927 
	`buf_¥ötf
 (&
Æît_msg
, " SC:%d,%s",

2928 
	`BOOL_CAST
(
Êags
 & 
GET_USER_PASS_STATIC_CHALLENGE_ECHO
),

2929 
sc
);

2932 
	`m™_waô_f‹_˛õ¡_c⁄√˘i⁄
 (
m™
, &
sig«l_ª˚ived
, 0, 
MWCC_PASSWORD_WAIT
);

2933 i‡(
sig«l_ª˚ived
)

2934 
ªt
 = 
Ál£
;

2936 i‡(
ªt
)

2938 
m™
->
≥rsi°
.
•ecül_°©e_msg
 = 
	`BSTR
 (&
Æît_msg
);

2939 
	`msg
 (
M_CLIENT
, "%s", 
m™
->
≥rsi°
.
•ecül_°©e_msg
);

2942 
m™
->
c⁄√˘i⁄
.
up_quîy_mode
 = up_query_mode;

2943 
m™
->
c⁄√˘i⁄
.
up_quîy_ty≥
 = 
ty≥
;

2948 
	`m™_°™dÆ⁄e_evít_lo›
 (
m™
, &
sig«l_ª˚ived
, 0);

2949 i‡(!
sig«l_ª˚ived
)

2950 
	`m™_check_f‹_sig«ls
 (&
sig«l_ª˚ived
);

2951 i‡(
sig«l_ª˚ived
)

2953 
ªt
 = 
Ál£
;

2956 } !
m™
->
c⁄√˘i⁄
.
up_quîy
.
deföed
);

2960 
m™
->
c⁄√˘i⁄
.
up_quîy_mode
 = 
UP_QUERY_DISABLED
;

2961 
m™
->
c⁄√˘i⁄
.
up_quîy_ty≥
 = 
NULL
;

2962 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
 = 
°™dÆ⁄e_dißbÀd_ßve
;

2963 
m™
->
≥rsi°
.
•ecül_°©e_msg
 = 
NULL
;

2966 i‡(!
	`°rcmp
 (
m™
->
c⁄√˘i⁄
.
up_quîy
.
∑ssw‹d
, 
bœnk_up
))

2967 
	`CLEAR
 (
m™
->
c⁄√˘i⁄
.
up_quîy
.
∑ssw‹d
);

2973 i‡(
ªt
)

2975 
m™
->
c⁄√˘i⁄
.
up_quîy
.
noˇche
 = 
up
->nocache;

2976 *
up
 = 
m™
->
c⁄√˘i⁄
.
up_quîy
;

2978 
	`CLEAR
 (
m™
->
c⁄√˘i⁄
.
up_quîy
);

2981 
	`gc_‰ì
 (&
gc
);

2982  
ªt
;

2983 
	}
}

2985 #ifde‡
MANAGMENT_EXTERNAL_KEY


2988 
	$m™agemít_quîy_rß_sig
 (
m™agemít
 *
m™
,

2989 c⁄° *
b64_d©a
)

2991 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2992 *
ªt
 = 
NULL
;

2993 vﬁ©ûê
sig«l_ª˚ived
 = 0;

2994 
buf„r
 
Æît_msg
 = 
	`˛ór_buf
();

2995 
buf„r
 *
buf
;

2996 c⁄° 
boﬁ
 
°™dÆ⁄e_dißbÀd_ßve
 = 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
;

2997 
m™_c⁄√˘i⁄
 *
mc
 = &
m™
->
c⁄√˘i⁄
;

2999 i‡(
	`m™_°™dÆ⁄e_ok
 (
m™
))

3001 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
 = 
Ál£
;

3002 
m™
->
≥rsi°
.
•ecül_°©e_msg
 = 
NULL
;

3004 
mc
->
ext_key_°©e
 = 
EKS_SOLICIT
;

3006 
Æît_msg
 = 
	`Æloc_buf_gc
 (
	`°æí
(
b64_d©a
)+64, &
gc
);

3007 
	`buf_¥ötf
 (&
Æît_msg
, ">RSA_SIGN:%s", 
b64_d©a
);

3009 
	`m™_waô_f‹_˛õ¡_c⁄√˘i⁄
 (
m™
, &
sig«l_ª˚ived
, 0, 
MWCC_OTHER_WAIT
);

3011 i‡(
sig«l_ª˚ived
)

3012 
d⁄e
;

3014 
m™
->
≥rsi°
.
•ecül_°©e_msg
 = 
	`BSTR
 (&
Æît_msg
);

3015 
	`msg
 (
M_CLIENT
, "%s", 
m™
->
≥rsi°
.
•ecül_°©e_msg
);

3020 
	`m™_°™dÆ⁄e_evít_lo›
 (
m™
, &
sig«l_ª˚ived
, 0);

3021 i‡(!
sig«l_ª˚ived
)

3022 
	`m™_check_f‹_sig«ls
 (&
sig«l_ª˚ived
);

3023 i‡(
sig«l_ª˚ived
)

3024 
d⁄e
;

3025 } 
mc
->
ext_key_°©e
 !
EKS_READY
);

3027 i‡(
	`buf„r_li°_deföed
(
mc
->
ext_key_öput
))

3029 
	`buf„r_li°_aggªg©e
 (
mc
->
ext_key_öput
, 2048);

3030 
buf
 = 
	`buf„r_li°_≥ek
 (
mc
->
ext_key_öput
);

3031 i‡(
buf
 && 
	`BLEN
(buf) > 0)

3033 
ªt
 = (*Ë
	`mÆloc
(
	`BLEN
(
buf
)+1);

3034 
	`check_mÆloc_ªtu∫
(
ªt
);

3035 
	`mem˝y
(
ªt
, 
buf
->
d©a
, 
	`BLEN
(buf));

3036 
ªt
[
	`BLEN
(
buf
)] = '\0';

3041 
d⁄e
:

3042 i‡(
mc
->
ext_key_°©e
 =
EKS_READY
 && 
ªt
)

3043 
	`msg
 (
M_CLIENT
, "SUCCESS:Ñsa-sig command succeeded");

3044 i‡(
mc
->
ext_key_°©e
 =
EKS_INPUT
 || mc->ext_key_°©ê=
EKS_READY
)

3045 
	`msg
 (
M_CLIENT
, "ERROR:Ñsa-sig command failed");

3048 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
 = 
°™dÆ⁄e_dißbÀd_ßve
;

3049 
m™
->
≥rsi°
.
•ecül_°©e_msg
 = 
NULL
;

3050 
	`ö_exåa_ª£t
 (
mc
, 
IER_RESET
);

3051 
mc
->
ext_key_°©e
 = 
EKS_UNDEF
;

3052 
	`buf„r_li°_‰ì
 (
mc
->
ext_key_öput
);

3053 
mc
->
ext_key_öput
 = 
NULL
;

3055 
	`gc_‰ì
 (&
gc
);

3056  
ªt
;

3057 
	}
}

3064 
boﬁ


3065 
	$m™agemít_would_hﬁd
 (
m™agemít
 *
m™
)

3067  (
m™
->
£âögs
.
Êags
 & 
MF_HOLD
Ë&& !m™->
≥rsi°
.
hﬁd_ªÀa£
 && 
	`m™_°™dÆ⁄e_ok
 (man);

3068 
	}
}

3074 
boﬁ


3075 
	$m™agemít_should_d´m⁄ize
 (
m™agemít
 *
m™
)

3077  
	`m™agemít_would_hﬁd
 (
m™
Ë|| (m™->
£âögs
.
Êags
 & 
MF_QUERY_PASSWORDS
);

3078 
	}
}

3084 
boﬁ


3085 
	$m™agemít_hﬁd
 (
m™agemít
 *
m™
)

3087 i‡(
	`m™agemít_would_hﬁd
 (
m™
))

3089 vﬁ©ûê
sig«l_ª˚ived
 = 0;

3090 c⁄° 
boﬁ
 
°™dÆ⁄e_dißbÀd_ßve
 = 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
;

3092 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
 = 
Ál£
;

3093 
m™
->
≥rsi°
.
•ecül_°©e_msg
 = 
NULL
;

3094 
m™
->
£âögs
.
m™sig
 |
MANSIG_IGNORE_USR1_HUP
;

3096 
	`m™_waô_f‹_˛õ¡_c⁄√˘i⁄
 (
m™
, &
sig«l_ª˚ived
, 0, 
MWCC_HOLD_WAIT
);

3098 i‡(!
sig«l_ª˚ived
)

3100 
m™
->
≥rsi°
.
•ecül_°©e_msg
 = ">HOLD:Waiting for holdÑelease";

3101 
	`msg
 (
M_CLIENT
, "%s", 
m™
->
≥rsi°
.
•ecül_°©e_msg
);

3106 
	`m™_°™dÆ⁄e_evít_lo›
 (
m™
, &
sig«l_ª˚ived
, 0);

3107 i‡(!
sig«l_ª˚ived
)

3108 
	`m™_check_f‹_sig«ls
 (&
sig«l_ª˚ived
);

3109 i‡(
sig«l_ª˚ived
)

3111 } !
m™
->
≥rsi°
.
hﬁd_ªÀa£
);

3115 
m™
->
≥rsi°
.
°™dÆ⁄e_dißbÀd
 = 
°™dÆ⁄e_dißbÀd_ßve
;

3116 
m™
->
≥rsi°
.
•ecül_°©e_msg
 = 
NULL
;

3117 
m™
->
£âögs
.
m™sig
 &~
MANSIG_IGNORE_USR1_HUP
;

3119  
åue
;

3121  
Ál£
;

3122 
	}
}

3128 
comm™d_löe
 *

3129 
	$comm™d_löe_√w
 (c⁄° 
buf_Àn
)

3131 
comm™d_löe
 *
˛
;

3132 
	`ALLOC_OBJ_CLEAR
 (
˛
, 
comm™d_löe
);

3133 
˛
->
buf
 = 
	`Æloc_buf
 (
buf_Àn
);

3134 
˛
->
ªsiduÆ
 = 
	`Æloc_buf
 (
buf_Àn
);

3135  
˛
;

3136 
	}
}

3139 
	$comm™d_löe_ª£t
 (
comm™d_löe
 *
˛
)

3141 
	`buf_˛ór
 (&
˛
->
buf
);

3142 
	`buf_˛ór
 (&
˛
->
ªsiduÆ
);

3143 
	}
}

3146 
	$comm™d_löe_‰ì
 (
comm™d_löe
 *
˛
)

3148 
	`comm™d_löe_ª£t
 (
˛
);

3149 
	`‰ì_buf
 (&
˛
->
buf
);

3150 
	`‰ì_buf
 (&
˛
->
ªsiduÆ
);

3151 
	`‰ì
 (
˛
);

3152 
	}
}

3155 
	$comm™d_löe_add
 (
comm™d_löe
 *
˛
, c⁄° *
buf
, c⁄° 
Àn
)

3157 
i
;

3158 
i
 = 0; i < 
Àn
; ++i)

3160 i‡(
buf
[
i
] && 
	`ch¨_˛ass
(buf[i], (
CC_PRINT
|
CC_NEWLINE
)))

3162 i‡(!
	`buf_wrôe_u8
 (&
˛
->
buf
, buf[
i
]))

3163 
	`buf_˛ór
 (&
˛
->
buf
);

3166 
	}
}

3169 
	$comm™d_löe_gë
 (
comm™d_löe
 *
˛
)

3171 
i
;

3172 c⁄° *
ªt
 = 
NULL
;

3174 
i
 = 
	`buf_sub°rög_Àn
 (&
˛
->
buf
, '\n');

3175 i‡(
i
 >= 0)

3177 
	`buf_c›y_ex˚ss
 (&
˛
->
ªsiduÆ
, &˛->
buf
, 
i
);

3178 
	`buf_chomp
 (&
˛
->
buf
);

3179 
ªt
 = (c⁄° *Ë
	`BSTR
 (&
˛
->
buf
);

3181  
ªt
;

3182 
	}
}

3185 
	$comm™d_löe_√xt
 (
comm™d_löe
 *
˛
)

3187 
	`buf_˛ór
 (&
˛
->
buf
);

3188 
	`buf_c›y
 (&
˛
->
buf
, &˛->
ªsiduÆ
);

3189 
	`buf_˛ór
 (&
˛
->
ªsiduÆ
);

3190 
	}
}

3197 
	$log_íåy_¥öt
 (c⁄° 
log_íåy
 *
e
, 
Êags
, 
gc_¨ía
 *
gc
)

3199 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (
ERR_BUF_SIZE
, 
gc
);

3200 i‡(
Êags
 & 
LOG_FATAL_NOTIFY
)

3201 
	`buf_¥ötf
 (&
out
, ">FATAL:");

3202 i‡(
Êags
 & 
LOG_PRINT_LOG_PREFIX
)

3203 
	`buf_¥ötf
 (&
out
, ">LOG:");

3204 i‡(
Êags
 & 
LOG_PRINT_ECHO_PREFIX
)

3205 
	`buf_¥ötf
 (&
out
, ">ECHO:");

3206 i‡(
Êags
 & 
LOG_PRINT_STATE_PREFIX
)

3207 
	`buf_¥ötf
 (&
out
, ">STATE:");

3208 i‡(
Êags
 & 
LOG_PRINT_INT_DATE
)

3209 
	`buf_¥ötf
 (&
out
, "%u,", ()
e
->
time°amp
);

3210 i‡(
Êags
 & 
LOG_PRINT_MSG_FLAGS
)

3211 
	`buf_¥ötf
 (&
out
, "%s,", 
	`msg_Êags_°rög
 (
e
->
u
.
msg_Êags
, 
gc
));

3212 i‡(
Êags
 & 
LOG_PRINT_STATE
)

3213 
	`buf_¥ötf
 (&
out
, "%s,", 
	`m™_°©e_«me
 (
e
->
u
.
°©e
));

3214 i‡(
Êags
 & 
LOG_PRINT_INTVAL
)

3215 
	`buf_¥ötf
 (&
out
, "%d,", 
e
->
u
.
ötvÆ
);

3216 i‡(
e
->
°rög
)

3217 
	`buf_¥ötf
 (&
out
, "%s", 
e
->
°rög
);

3218 i‡(
Êags
 & 
LOG_PRINT_LOCAL_IP
)

3219 
	`buf_¥ötf
 (&
out
, ",%s", 
	`¥öt_ö_addr_t
 (
e
->
loˇl_ù
, 
IA_EMPTY_IF_UNDEF
, 
gc
));

3220 i‡(
Êags
 & 
LOG_PRINT_REMOTE_IP
)

3221 
	`buf_¥ötf
 (&
out
, ",%s", 
	`¥öt_ö_addr_t
 (
e
->
ªmŸe_ù
, 
IA_EMPTY_IF_UNDEF
, 
gc
));

3222 i‡(
Êags
 & 
LOG_ECHO_TO_LOG
)

3223 
	`msg
 (
D_MANAGEMENT
, "MANAGEMENT: %s", 
	`BSTR
 (&
out
));

3224 i‡(
Êags
 & 
LOG_PRINT_CRLF
)

3225 
	`buf_¥ötf
 (&
out
, "\r\n");

3226  
	`BSTR
 (&
out
);

3227 
	}
}

3230 
	$log_íåy_‰ì_c⁄ã¡s
 (
log_íåy
 *
e
)

3232 i‡(
e
->
°rög
)

3233 
	`‰ì
 ((*)
e
->
°rög
);

3234 
	`CLEAR
 (*
e
);

3235 
	}
}

3241 
ölöe
 

3242 
	$log_ödex
 (c⁄° 
log_hi°‹y
 *
h
, 
i
)

3244  
	`modulo_add
 (
h
->
ba£
, 
i
, h->
ˇ∑côy
);

3245 
	}
}

3248 
	$log_hi°‹y_obj_öô
 (
log_hi°‹y
 *
h
, 
ˇ∑côy
)

3250 
	`CLEAR
 (*
h
);

3251 
h
->
ˇ∑côy
 = capacity;

3252 
	`ALLOC_ARRAY_CLEAR
 (
h
->
¨øy
, 
log_íåy
, 
ˇ∑côy
);

3253 
	}
}

3255 
log_hi°‹y
 *

3256 
	$log_hi°‹y_öô
 (c⁄° 
ˇ∑côy
)

3258 
log_hi°‹y
 *
h
;

3259 
	`ASSERT
 (
ˇ∑côy
 > 0);

3260 
	`ALLOC_OBJ
 (
h
, 
log_hi°‹y
);

3261 
	`log_hi°‹y_obj_öô
 (
h
, 
ˇ∑côy
);

3262  
h
;

3263 
	}
}

3266 
	$log_hi°‹y_‰ì_c⁄ã¡s
 (
log_hi°‹y
 *
h
)

3268 
i
;

3269 
i
 = 0; i < 
h
->
size
; ++i)

3270 
	`log_íåy_‰ì_c⁄ã¡s
 (&
h
->
¨øy
[
	`log_ödex
(h, 
i
)]);

3271 
	`‰ì
 (
h
->
¨øy
);

3272 
	}
}

3275 
	$log_hi°‹y_˛o£
 (
log_hi°‹y
 *
h
)

3277 
	`log_hi°‹y_‰ì_c⁄ã¡s
 (
h
);

3278 
	`‰ì
 (
h
);

3279 
	}
}

3282 
	$log_hi°‹y_add
 (
log_hi°‹y
 *
h
, c⁄° 
log_íåy
 *
À
)

3284 
log_íåy
 *
e
;

3285 
	`ASSERT
 (
h
->
size
 >0 && h->sizê<h->
ˇ∑côy
);

3286 i‡(
h
->
size
 =h->
ˇ∑côy
)

3288 
e
 = &
h
->
¨øy
[h->
ba£
];

3289 
	`log_íåy_‰ì_c⁄ã¡s
 (
e
);

3290 
h
->
ba£
 = 
	`log_ödex
 (h, 1);

3294 
e
 = &
h
->
¨øy
[
	`log_ödex
(h, h->
size
)];

3295 ++
h
->
size
;

3298 *
e
 = *
À
;

3299 
e
->
°rög
 = 
	`°rög_Æloc
 (
À
->°rög, 
NULL
);

3300 
	}
}

3303 
	$log_hi°‹y_ªsize
 (
log_hi°‹y
 *
h
, c⁄° 
ˇ∑côy
)

3305 i‡(
ˇ∑côy
 !
h
->capacity)

3307 
log_hi°‹y
 
√wlog
;

3308 
i
;

3310 
	`ASSERT
 (
ˇ∑côy
 > 0);

3311 
	`log_hi°‹y_obj_öô
 (&
√wlog
, 
ˇ∑côy
);

3313 
i
 = 0; i < 
h
->
size
; ++i)

3314 
	`log_hi°‹y_add
 (&
√wlog
, &
h
->
¨øy
[
	`log_ödex
(h, 
i
)]);

3316 
	`log_hi°‹y_‰ì_c⁄ã¡s
 (
h
);

3317 *
h
 = 
√wlog
;

3319 
	}
}

3321 c⁄° 
log_íåy
 *

3322 
	$log_hi°‹y_ªf
 (c⁄° 
log_hi°‹y
 *
h
, c⁄° 
ödex
)

3324 i‡(
ödex
 >0 && index < 
h
->
size
)

3325  &
h
->
¨øy
[
	`log_ödex
(h, (h->
size
 - 1Ë- 
ödex
)];

3327  
NULL
;

3328 
	}
}

3331 
	$dummy
(Ë{
	}
}

	@src/openvpn/manage.h

25 #i‚de‡
MANAGE_H


26 
	#MANAGE_H


	)

28 #ifde‡
ENABLE_MANAGEMENT


30 
	~"misc.h
"

31 
	~"evít.h
"

32 
	~"sockë.h
"

33 
	~"mrouã.h
"

35 
	#MANAGEMENT_VERSION
 1

	)

36 
	#MANAGEMENT_N_PASSWORD_RETRIES
 3

	)

37 
	#MANAGEMENT_LOG_HISTORY_INITIAL_SIZE
 100

	)

38 
	#MANAGEMENT_ECHO_BUFFER_SIZE
 100

	)

39 
	#MANAGEMENT_STATE_BUFFER_SIZE
 100

	)

44 #ifde‡
MANAGEMENT_DEF_AUTH


45 
	sm™_def_auth_c⁄ãxt
 {

46 
	mcid
;

48 
	#DAF_CONNECTION_ESTABLISHED
 (1<<0)

	)

49 
	#DAF_CONNECTION_CLOSED
 (1<<1)

	)

50 
	#DAF_INITIAL_AUTH
 (1<<2)

	)

51 
	mÊags
;

53 
	mmda_key_id_cou¡î
;

55 
time_t
 
	mbyãcou¡_œ°_upd©e
;

62 
	scomm™d_löe


64 
buf„r
 
	mbuf
;

65 
buf„r
 
	mªsiduÆ
;

68 
comm™d_löe
 *
comm™d_löe_√w
 (c⁄° 
buf_Àn
);

69 
comm™d_löe_‰ì
 (
comm™d_löe
 *
˛
);

71 
comm™d_löe_add
 (
comm™d_löe
 *
˛
, c⁄° *
buf
, c⁄° 
Àn
);

72 c⁄° *
comm™d_löe_gë
 (
comm™d_löe
 *
˛
);

73 
comm™d_löe_ª£t
 (
comm™d_löe
 *
˛
);

74 
comm™d_löe_√xt
 (
comm™d_löe
 *
˛
);

80 
	ulog_íåy_uni⁄
 {

81 
	mmsg_Êags
;

82 
	m°©e
;

83 
	mötvÆ
;

86 
	slog_íåy


88 
time_t
 
	mtime°amp
;

89 c⁄° *
	m°rög
;

90 
ö_addr_t
 
	mloˇl_ù
;

91 
ö_addr_t
 
	mªmŸe_ù
;

92 
log_íåy_uni⁄
 
	mu
;

95 
	#LOG_PRINT_LOG_PREFIX
 (1<<0)

	)

96 
	#LOG_PRINT_ECHO_PREFIX
 (1<<1)

	)

97 
	#LOG_PRINT_STATE_PREFIX
 (1<<2)

	)

99 
	#LOG_PRINT_INT_DATE
 (1<<3)

	)

100 
	#LOG_PRINT_MSG_FLAGS
 (1<<4)

	)

101 
	#LOG_PRINT_STATE
 (1<<5)

	)

102 
	#LOG_PRINT_LOCAL_IP
 (1<<6)

	)

104 
	#LOG_PRINT_CRLF
 (1<<7)

	)

105 
	#LOG_FATAL_NOTIFY
 (1<<8)

	)

107 
	#LOG_PRINT_INTVAL
 (1<<9)

	)

109 
	#LOG_PRINT_REMOTE_IP
 (1<<10)

	)

111 
	#LOG_ECHO_TO_LOG
 (1<<11)

	)

113 c⁄° *
log_íåy_¥öt
 (c⁄° 
log_íåy
 *
e
, 
Êags
, 
gc_¨ía
 *
gc
);

115 
	slog_hi°‹y


117 
	mba£
;

118 
	msize
;

119 
	mˇ∑côy
;

120 
log_íåy
 *
	m¨øy
;

123 
log_hi°‹y
 *
log_hi°‹y_öô
 (c⁄° 
ˇ∑côy
);

124 
log_hi°‹y_˛o£
 (
log_hi°‹y
 *
h
);

125 
log_hi°‹y_add
 (
log_hi°‹y
 *
h
, c⁄° 
log_íåy
 *
À
);

126 
log_hi°‹y_ªsize
 (
log_hi°‹y
 *
h
, c⁄° 
ˇ∑côy
);

127 c⁄° 
log_íåy
 *
log_hi°‹y_ªf
 (c⁄° 
log_hi°‹y
 *
h
, c⁄° 
ödex
);

129 
ölöe
 

130 
	$log_hi°‹y_size
 (c⁄° 
log_hi°‹y
 *
h
)

132  
h
->
size
;

133 
	}
}

135 
ölöe
 

136 
	$log_hi°‹y_ˇ∑côy
 (c⁄° 
log_hi°‹y
 *
h
)

138  
h
->
ˇ∑côy
;

139 
	}
}

145 
	sm™agemít_ˇŒback


147 *
	m¨g
;

149 
	#MCF_SERVER
 (1<<0Ë

	)

150 
	mÊags
;

152 (*
	m°©us
Ë(*
	m¨g
, c⁄° 
	mvîsi⁄
, 
°©us_ouçut
 *
	mso
);

153 (*
	mshow_√t
Ë(*
	m¨g
, c⁄° 
	mmsgÀvñ
);

154 (*
	mkûl_by_˙
Ë(*
	m¨g
, c⁄° *
	mcomm⁄_«me
);

155 (*
	mkûl_by_addr
Ë(*
	m¨g
, c⁄° 
ö_addr_t
 
	maddr
, c⁄° 
	mp‹t
);

156 (*
	mdñëe_evít
Ë(*
	m¨g
, 
evít_t
 
	mevít
);

157 (*
	mn_˛õ¡s
Ë(*
	m¨g
);

158 #ifde‡
MANAGEMENT_DEF_AUTH


159 
boﬁ
 (*
kûl_by_cid
Ë(*
	m¨g
, c⁄° 
	mcid
, c⁄° *
	mkûl_msg
);

160 
boﬁ
 (*
˛õ¡_auth
Ë(*
	m¨g
,

161 c⁄° 
	mcid
,

162 c⁄° 
	mmda_key_id
,

163 c⁄° 
boﬁ
 
	mauth
,

164 c⁄° *
	mªas⁄
,

165 c⁄° *
	m˛õ¡_ªas⁄
,

166 
buf„r_li°
 *
	mcc_c⁄fig
);

167 *(*
	mgë_≥î_öfo
Ë(*
	m¨g
, c⁄° 
	mcid
);

169 #ifde‡
MANAGEMENT_PF


170 
boﬁ
 (*
˛õ¡_pf
Ë(*
	m¨g
,

171 c⁄° 
	mcid
,

172 
buf„r_li°
 *
	mpf_c⁄fig
);

174 
boﬁ
 (*
¥oxy_cmd
Ë(*
	m¨g
, c⁄° **
	mp
);

175 
boﬁ
 (*
ªmŸe_cmd
Ë(*
	m¨g
, c⁄° **
	mp
);

192 
	sm™_≥rsi°
 {

193 
boﬁ
 
	mdeföed
;

195 
log_hi°‹y
 *
	mlog
;

196 
vútuÆ_ouçut
 
	mvout
;

198 
boﬁ
 
	m°™dÆ⁄e_dißbÀd
;

199 
m™agemít_ˇŒback
 
	mˇŒback
;

201 
log_hi°‹y
 *
	mecho
;

202 
log_hi°‹y
 *
	m°©e
;

204 
boﬁ
 
	mhﬁd_ªÀa£
;

206 c⁄° *
	m•ecül_°©e_msg
;

208 
cou¡î_ty≥
 
	mbyãs_ö
;

209 
cou¡î_ty≥
 
	mbyãs_out
;

212 
	sm™_£âögs
 {

213 
boﬁ
 
	mdeföed
;

214 
	mÊags
;

215 
›ív≤_sockaddr
 
	mloˇl
;

216 #i‡
UNIX_SOCK_SUPPORT


217 
sockaddr_un
 
	mloˇl_unix
;

219 
boﬁ
 
	mm™agemít_ovî_tu¬ñ
;

220 
u£r_∑ss
 
	mup
;

221 
	mlog_hi°‹y_ˇche
;

222 
	mecho_buf„r_size
;

223 
	m°©e_buf„r_size
;

224 *
	mwrôe_≥î_öfo_fûe
;

225 
	m˛õ¡_uid
;

226 
	m˛õ¡_gid
;

229 
	#MANSIG_IGNORE_USR1_HUP
 (1<<0)

	)

230 
	#MANSIG_MAP_USR1_TO_HUP
 (1<<1)

	)

231 
	#MANSIG_MAP_USR1_TO_TERM
 (1<<2)

	)

232 
	mm™sig
;

236 
	#UP_QUERY_DISABLED
 0

	)

237 
	#UP_QUERY_USER_PASS
 1

	)

238 
	#UP_QUERY_PASS
 2

	)

239 
	#UP_QUERY_NEED_OK
 3

	)

240 
	#UP_QUERY_NEED_STR
 4

	)

243 
	#MS_INITIAL
 0

	)

244 
	#MS_LISTEN
 1

	)

245 
	#MS_CC_WAIT_READ
 2

	)

246 
	#MS_CC_WAIT_WRITE
 3

	)

248 
	sm™_c⁄√˘i⁄
 {

249 
	m°©e
;

251 
sockë_des¸ùt‹_t
 
	msd_t›
;

252 
sockë_des¸ùt‹_t
 
	msd_˛i
;

253 
›ív≤_sockaddr
 
	mªmŸe
;

255 #ifde‡
WIN32


256 
√t_evít_wö32
 
	m√32
;

259 
boﬁ
 
	mhÆt
;

260 
boﬁ
 
	m∑ssw‹d_vîifõd
;

261 
	m∑ssw‹d_åõs
;

263 
comm™d_löe
 *
	mö
;

264 
buf„r_li°
 *
	mout
;

266 #ifde‡
MANAGEMENT_IN_EXTRA


267 
	#IEC_UNDEF
 0

	)

268 
	#IEC_CLIENT_AUTH
 1

	)

269 
	#IEC_CLIENT_PF
 2

	)

270 
	#IEC_RSA_SIGN
 3

	)

271 
	mö_exåa_cmd
;

272 
buf„r_li°
 *
	mö_exåa
;

273 #ifde‡
MANAGEMENT_DEF_AUTH


274 
	mö_exåa_cid
;

275 
	mö_exåa_kid
;

277 #ifde‡
MANAGMENT_EXTERNAL_KEY


278 
	#EKS_UNDEF
 0

	)

279 
	#EKS_SOLICIT
 1

	)

280 
	#EKS_INPUT
 2

	)

281 
	#EKS_READY
 3

	)

282 
	mext_key_°©e
;

283 
buf„r_li°
 *
	mext_key_öput
;

286 
evít_£t
 *
	mes
;

287 
	mív_fûãr_Àvñ
;

289 
boﬁ
 
	m°©e_ªÆtime
;

290 
boﬁ
 
	mlog_ªÆtime
;

291 
boﬁ
 
	mecho_ªÆtime
;

292 
	mbyãcou¡_upd©e_£c⁄ds
;

293 
time_t
 
	mbyãcou¡_œ°_upd©e
;

295 c⁄° *
	mup_quîy_ty≥
;

296 
	mup_quîy_mode
;

297 
u£r_∑ss
 
	mup_quîy
;

299 #ifde‡
MANAGMENT_EXTERNAL_KEY


300 
buf„r_li°
 *
	mrß_sig
;

304 
	sm™agemít


306 
m™_≥rsi°
 
	m≥rsi°
;

307 
m™_£âögs
 
	m£âögs
;

308 
m™_c⁄√˘i⁄
 
	mc⁄√˘i⁄
;

311 
m™agemít
 *management;

313 
	gu£r_∑ss
;

315 
m™agemít
 *
m™agemít_öô
 ();

318 
	#MF_SERVER
 (1<<0)

	)

319 
	#MF_QUERY_PASSWORDS
 (1<<1)

	)

320 
	#MF_HOLD
 (1<<2)

	)

321 
	#MF_SIGNAL
 (1<<3)

	)

322 
	#MF_FORGET_DISCONNECT
 (1<<4)

	)

323 
	#MF_CONNECT_AS_CLIENT
 (1<<5)

	)

324 #ifde‡
MANAGEMENT_DEF_AUTH


325 
	#MF_CLIENT_AUTH
 (1<<6)

	)

327 #ifde‡
MANAGEMENT_PF


328 
	#MF_CLIENT_PF
 (1<<7)

	)

330 
	#MF_UNIX_SOCK
 (1<<8)

	)

331 #ifde‡
MANAGMENT_EXTERNAL_KEY


332 
	#MF_EXTERNAL_KEY
 (1<<9)

	)

334 
	#MF_UP_DOWN
 (1<<10)

	)

335 
	#MF_QUERY_REMOTE
 (1<<11)

	)

336 
	#MF_QUERY_PROXY
 (1<<12)

	)

338 
boﬁ
 
m™agemít_›í
 (
m™agemít
 *
m™
,

339 c⁄° *
addr
,

340 c⁄° 
p‹t
,

341 c⁄° *
∑ss_fûe
,

342 c⁄° *
˛õ¡_u£r
,

343 c⁄° *
˛õ¡_group
,

344 c⁄° 
log_hi°‹y_ˇche
,

345 c⁄° 
echo_buf„r_size
,

346 c⁄° 
°©e_buf„r_size
,

347 c⁄° *
wrôe_≥î_öfo_fûe
,

348 c⁄° 
ªm≠_sigu§1
,

349 c⁄° 
Êags
);

351 
m™agemít_˛o£
 (
m™agemít
 *
m™
);

353 
m™agemít_po°_tu¬ñ_›í
 (
m™agemít
 *
m™
, c⁄° 
ö_addr_t
 
tun_loˇl_ù
);

355 
m™agemít_¥e_tu¬ñ_˛o£
 (
m™agemít
 *
m™
);

357 
m™agemít_sockë_£t
 (
m™agemít
 *
m™
,

358 
evít_£t
 *
es
,

359 *
¨g
,

360 *
≥rsi°ít
);

362 
m™agemít_io
 (
m™agemít
 *
m™
);

364 
m™agemít_£t_ˇŒback
 (
m™agemít
 *
m™
,

365 c⁄° 
m™agemít_ˇŒback
 *
cb
);

367 
m™agemít_˛ór_ˇŒback
 (
m™agemít
 *
m™
);

369 
boﬁ
 
m™agemít_quîy_u£r_∑ss
 (
m™agemít
 *
m™
,

370 
u£r_∑ss
 *
up
,

371 c⁄° *
ty≥
,

372 c⁄° 
Êags
,

373 c⁄° *
°©ic_chÆÀnge
);

375 
boﬁ
 
m™agemít_should_d´m⁄ize
 (
m™agemít
 *
m™
);

376 
boﬁ
 
m™agemít_would_hﬁd
 (
m™agemít
 *
m™
);

377 
boﬁ
 
m™agemít_hﬁd
 (
m™agemít
 *
m™
);

379 
m™agemít_evít_lo›_n_£c⁄ds
 (
m™agemít
 *
m™
, 
£c
);

381 
m™agemít_up_down
(
m™agemít
 *
m™
, c⁄° *
updown
, c⁄° 
ív_£t
 *
es
);

383 
m™agemít_nŸify
(
m™agemít
 *
m™
, c⁄° *
£vîôy
, c⁄° *
ty≥
, c⁄° *
ãxt
);

385 
m™agemít_nŸify_gíîic
 (
m™agemít
 *
m™
, c⁄° *
°r
);

387 #ifde‡
MANAGEMENT_DEF_AUTH


388 
m™agemít_nŸify_˛õ¡_√edög_auth
 (
m™agemít
 *management,

389 c⁄° 
auth_id
,

390 
m™_def_auth_c⁄ãxt
 *
mdac
,

391 c⁄° 
ív_£t
 *
es
);

393 
m™agemít_c⁄√˘i⁄_e°ablished
 (
m™agemít
 *management,

394 
m™_def_auth_c⁄ãxt
 *
mdac
,

395 c⁄° 
ív_£t
 *
es
);

397 
m™agemít_nŸify_˛õ¡_˛o£
 (
m™agemít
 *management,

398 
m™_def_auth_c⁄ãxt
 *
mdac
,

399 c⁄° 
ív_£t
 *
es
);

401 
m™agemít_À¨n_addr
 (
m™agemít
 *management,

402 
m™_def_auth_c⁄ãxt
 *
mdac
,

403 c⁄° 
mrouã_addr
 *
addr
,

404 c⁄° 
boﬁ
 
¥im¨y
);

407 #ifde‡
MANAGMENT_EXTERNAL_KEY


409 *
m™agemít_quîy_rß_sig
 (
m™agemít
 *
m™
, c⁄° *
b64_d©a
);

413 
ölöe
 
boﬁ


414 
	$m™agemít_c⁄√˘ed
 (c⁄° 
m™agemít
 *
m™
)

416  
m™
->
c⁄√˘i⁄
.
°©e
 =
MS_CC_WAIT_READ
 || m™->c⁄√˘i⁄.°©ê=
MS_CC_WAIT_WRITE
;

417 
	}
}

419 
ölöe
 
boﬁ


420 
	$m™agemít_quîy_u£r_∑ss_íabÀd
 (c⁄° 
m™agemít
 *
m™
)

422  
	`BOOL_CAST
(
m™
->
£âögs
.
Êags
 & 
MF_QUERY_PASSWORDS
);

423 
	}
}

425 
ölöe
 
boﬁ


426 
	$m™agemít_quîy_ªmŸe_íabÀd
 (c⁄° 
m™agemít
 *
m™
)

428  
	`BOOL_CAST
(
m™
->
£âögs
.
Êags
 & 
MF_QUERY_REMOTE
);

429 
	}
}

431 
ölöe
 
boﬁ


432 
	$m™agemít_quîy_¥oxy_íabÀd
 (c⁄° 
m™agemít
 *
m™
)

434  
	`BOOL_CAST
(
m™
->
£âögs
.
Êags
 & 
MF_QUERY_PROXY
);

435 
	}
}

437 #ifde‡
MANAGEMENT_PF


438 
ölöe
 
boﬁ


439 
	$m™agemít_íabÀ_pf
 (c⁄° 
m™agemít
 *
m™
)

441  
m™
 && 
	`BOOL_CAST
(m™->
£âögs
.
Êags
 & 
MF_CLIENT_PF
);

442 
	}
}

445 #ifde‡
MANAGEMENT_DEF_AUTH


446 
ölöe
 
boﬁ


447 
	$m™agemít_íabÀ_def_auth
 (c⁄° 
m™agemít
 *
m™
)

449  
m™
 && 
	`BOOL_CAST
(m™->
£âögs
.
Êags
 & 
MF_CLIENT_AUTH
);

450 
	}
}

458 
	#OPENVPN_STATE_INITIAL
 0

	)

459 
	#OPENVPN_STATE_CONNECTING
 1

	)

460 
	#OPENVPN_STATE_ASSIGN_IP
 2

	)

461 
	#OPENVPN_STATE_ADD_ROUTES
 3

	)

462 
	#OPENVPN_STATE_CONNECTED
 4

	)

463 
	#OPENVPN_STATE_RECONNECTING
 5

	)

464 
	#OPENVPN_STATE_EXITING
 6

	)

467 
	#OPENVPN_STATE_WAIT
 7

	)

468 
	#OPENVPN_STATE_AUTH
 8

	)

469 
	#OPENVPN_STATE_GET_CONFIG
 9

	)

470 
	#OPENVPN_STATE_RESOLVE
 10

	)

471 
	#OPENVPN_STATE_TCP_CONNECT
 11

	)

473 
	#OPENVPN_STATE_CLIENT_BASE
 7

	)

475 
m™agemít_£t_°©e
 (
m™agemít
 *
m™
,

476 c⁄° 
°©e
,

477 c⁄° *
dëaû
,

478 c⁄° 
ö_addr_t
 
tun_loˇl_ù
,

479 c⁄° 
ö_addr_t
 
tun_ªmŸe_ù
);

485 
m™agemít_echo
 (
m™agemít
 *
m™
, c⁄° *
°rög
, c⁄° 
boﬁ
 
puŒ
);

491 
m™agemít_auth_Áûuª
 (
m™agemít
 *
m™
, c⁄° *
ty≥
, c⁄° *
ªas⁄
);

496 
m™agemít_auth_tokí
 (
m™agemít
 *
m™
, c⁄° *
tokí
);

502 
m™_byãcou¡_ouçut_˛õ¡
 (
m™agemít
 *
m™
);

504 
ölöe
 

505 
	$m™_byãcou¡_possibÀ_ouçut_˛õ¡
 (
m™agemít
 *
m™
)

507 i‡(
m™
->
c⁄√˘i⁄
.
byãcou¡_upd©e_£c⁄ds
 > 0

508 && 
now
 >
m™
->
c⁄√˘i⁄
.
byãcou¡_œ°_upd©e


509 + 
m™
->
c⁄√˘i⁄
.
byãcou¡_upd©e_£c⁄ds
)

510 
	`m™_byãcou¡_ouçut_˛õ¡
 (
m™
);

511 
	}
}

513 
ölöe
 

514 
	$m™agemít_byãs_out_˛õ¡
 (
m™agemít
 *
m™
, c⁄° 
size
)

516 
m™
->
≥rsi°
.
byãs_out
 +
size
;

517 
	`m™_byãcou¡_possibÀ_ouçut_˛õ¡
 (
m™
);

518 
	}
}

520 
ölöe
 

521 
	$m™agemít_byãs_ö_˛õ¡
 (
m™agemít
 *
m™
, c⁄° 
size
)

523 
m™
->
≥rsi°
.
byãs_ö
 +
size
;

524 
	`m™_byãcou¡_possibÀ_ouçut_˛õ¡
 (
m™
);

525 
	}
}

527 
ölöe
 

528 
	$m™agemít_byãs_out
 (
m™agemít
 *
m™
, c⁄° 
size
)

530 i‡(!(
m™
->
≥rsi°
.
ˇŒback
.
Êags
 & 
MCF_SERVER
))

531 
	`m™agemít_byãs_out_˛õ¡
 (
m™
, 
size
);

532 
	}
}

534 
ölöe
 

535 
	$m™agemít_byãs_ö
 (
m™agemít
 *
m™
, c⁄° 
size
)

537 i‡(!(
m™
->
≥rsi°
.
ˇŒback
.
Êags
 & 
MCF_SERVER
))

538 
	`m™agemít_byãs_ö_˛õ¡
 (
m™
, 
size
);

539 
	}
}

541 #ifde‡
MANAGEMENT_DEF_AUTH


543 
ölöe
 

544 
	$m™agemít_byãs_£rvî
 (
m™agemít
 *
m™
,

545 c⁄° 
cou¡î_ty≥
 *
byãs_ö_tŸÆ
,

546 c⁄° 
cou¡î_ty≥
 *
byãs_out_tŸÆ
,

547 
m™_def_auth_c⁄ãxt
 *
mdac
)

549 
	`m™_byãcou¡_ouçut_£rvî
 (
m™agemít
 *
m™
,

550 c⁄° 
cou¡î_ty≥
 *
byãs_ö_tŸÆ
,

551 c⁄° 
cou¡î_ty≥
 *
byãs_out_tŸÆ
,

552 
m™_def_auth_c⁄ãxt
 *
mdac
);

554 i‡(
m™
->
c⁄√˘i⁄
.
byãcou¡_upd©e_£c⁄ds
 > 0

555 && 
now
 >
mdac
->
byãcou¡_œ°_upd©e
 + 
m™
->
c⁄√˘i⁄
.
byãcou¡_upd©e_£c⁄ds


556 && (
mdac
->
Êags
 & (
DAF_CONNECTION_ESTABLISHED
|
DAF_CONNECTION_CLOSED
)) == DAF_CONNECTION_ESTABLISHED)

557 
	`m™_byãcou¡_ouçut_£rvî
 (
m™
, 
byãs_ö_tŸÆ
, 
byãs_out_tŸÆ
, 
mdac
);

558 
	}
}

	@src/openvpn/mbuf.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #i‡
P2MP


35 
	~"buf„r.h
"

36 
	~"îr‹.h
"

37 
	~"misc.h
"

38 
	~"mbuf.h
"

40 
	~"memdbg.h
"

42 
mbuf_£t
 *

43 
	$mbuf_öô
 (
size
)

45 
mbuf_£t
 *
ªt
;

46 
	`ALLOC_OBJ_CLEAR
 (
ªt
, 
mbuf_£t
);

47 
ªt
->
ˇ∑côy
 = 
	`adju°_powî_of_2
 (
size
);

48 
	`ALLOC_ARRAY
 (
ªt
->
¨øy
, 
mbuf_ôem
,Ñë->
ˇ∑côy
);

49  
ªt
;

50 
	}
}

53 
	$mbuf_‰ì
 (
mbuf_£t
 *
ms
)

55 i‡(
ms
)

57 
i
;

58 
i
 = 0; i < (Ë
ms
->
Àn
; ++i)

60 
mbuf_ôem
 *
ôem
 = &
ms
->
¨øy
[
	`MBUF_INDEX
(ms->
hód
, 
i
, ms->
ˇ∑côy
)];

61 
	`mbuf_‰ì_buf
 (
ôem
->
buf„r
);

63 
	`‰ì
 (
ms
->
¨øy
);

64 
	`‰ì
 (
ms
);

66 
	}
}

68 
mbuf_buf„r
 *

69 
	$mbuf_Æloc_buf
 (c⁄° 
buf„r
 *
buf
)

71 
mbuf_buf„r
 *
ªt
;

72 
	`ALLOC_OBJ
 (
ªt
, 
mbuf_buf„r
);

73 
ªt
->
buf
 = 
	`˛⁄e_buf
 (buf);

74 
ªt
->
ªfcou¡
 = 1;

75 
ªt
->
Êags
 = 0;

76  
ªt
;

77 
	}
}

80 
	$mbuf_‰ì_buf
 (
mbuf_buf„r
 *
mb
)

82 i‡(
mb
)

84 i‡(--
mb
->
ªfcou¡
 <= 0)

86 
	`‰ì_buf
 (&
mb
->
buf
);

87 
	`‰ì
 (
mb
);

90 
	}
}

93 
	$mbuf_add_ôem
 (
mbuf_£t
 *
ms
, c⁄° 
mbuf_ôem
 *
ôem
)

95 
	`ASSERT
 (
ms
);

96 i‡(
ms
->
Àn
 =ms->
ˇ∑côy
)

98 
mbuf_ôem
 
rm
;

99 
	`ASSERT
 (
	`mbuf_exåa˘_ôem
 (
ms
, &
rm
));

100 
	`mbuf_‰ì_buf
 (
rm
.
buf„r
);

101 
	`msg
 (
D_MULTI_DROPPED
, "MBUF: mbufÖacket dropped");

104 
	`ASSERT
 (
ms
->
Àn
 < ms->
ˇ∑côy
);

106 
ms
->
¨øy
[
	`MBUF_INDEX
(ms->
hód
, ms->
Àn
, ms->
ˇ∑côy
)] = *
ôem
;

107 i‡(++
ms
->
Àn
 > ms->
max_queued
)

108 
ms
->
max_queued
 = ms->
Àn
;

109 ++
ôem
->
buf„r
->
ªfcou¡
;

110 
	}
}

112 
boﬁ


113 
	$mbuf_exåa˘_ôem
 (
mbuf_£t
 *
ms
, 
mbuf_ôem
 *
ôem
)

115 
boﬁ
 
ªt
 = 
Ál£
;

116 i‡(
ms
)

118 
ms
->
Àn
)

120 *
ôem
 = 
ms
->
¨øy
[ms->
hód
];

121 
ms
->
hód
 = 
	`MBUF_INDEX
(ms->hód, 1, ms->
ˇ∑côy
);

122 --
ms
->
Àn
;

123 i‡(
ôem
->
ö°™˚
)

125 
ªt
 = 
åue
;

130  
ªt
;

131 
	}
}

133 
mu…i_ö°™˚
 *

134 
	$mbuf_≥ek_dow‹k
 (
mbuf_£t
 *
ms
)

136 
mu…i_ö°™˚
 *
ªt
 = 
NULL
;

137 i‡(
ms
)

139 
i
;

140 
i
 = 0; i < (Ë
ms
->
Àn
; ++i)

142 
mbuf_ôem
 *
ôem
 = &
ms
->
¨øy
[
	`MBUF_INDEX
(ms->
hód
, 
i
, ms->
ˇ∑côy
)];

143 i‡(
ôem
->
ö°™˚
)

145 
ªt
 = 
ôem
->
ö°™˚
;

150  
ªt
;

151 
	}
}

154 
	$mbuf_dîe„ªn˚_ö°™˚
 (
mbuf_£t
 *
ms
, 
mu…i_ö°™˚
 *
mi
)

156 i‡(
ms
)

158 
i
;

159 
i
 = 0; i < (Ë
ms
->
Àn
; ++i)

161 
mbuf_ôem
 *
ôem
 = &
ms
->
¨øy
[
	`MBUF_INDEX
(ms->
hód
, 
i
, ms->
ˇ∑côy
)];

162 i‡(
ôem
->
ö°™˚
 =
mi
)

164 
	`mbuf_‰ì_buf
 (
ôem
->
buf„r
);

165 
ôem
->
buf„r
 = 
NULL
;

166 
ôem
->
ö°™˚
 = 
NULL
;

167 
	`msg
 (
D_MBUF
, "MBUF: dereferenced queuedÖacket");

171 
	}
}

174 
	$dummy
(Ë{
	}
}

	@src/openvpn/mbuf.h

25 #i‚de‡
MBUF_H


26 
	#MBUF_H


	)

32 #i‡
P2MP


37 
	~"basic.h
"

38 
	~"buf„r.h
"

40 
	gmu…i_ö°™˚
;

42 
	#MBUF_INDEX
(
hód
, 
off£t
, 
size
Ë(((hódË+ (off£t)Ë& ((size)-1))

	)

44 
	smbuf_buf„r


46 
buf„r
 
	mbuf
;

47 
	mªfcou¡
;

49 
	#MF_UNICAST
 (1<<0)

	)

50 
	mÊags
;

53 
	smbuf_ôem


55 
mbuf_buf„r
 *
	mbuf„r
;

56 
mu…i_ö°™˚
 *
	mö°™˚
;

59 
	smbuf_£t


61 
	mhód
;

62 
	mÀn
;

63 
	mˇ∑côy
;

64 
	mmax_queued
;

65 
mbuf_ôem
 *
	m¨øy
;

68 
mbuf_£t
 *
mbuf_öô
 (
size
);

69 
mbuf_‰ì
 (
mbuf_£t
 *
ms
);

71 
mbuf_buf„r
 *
mbuf_Æloc_buf
 (c⁄° 
buf„r
 *
buf
);

72 
mbuf_‰ì_buf
 (
mbuf_buf„r
 *
mb
);

74 
mbuf_add_ôem
 (
mbuf_£t
 *
ms
, c⁄° 
mbuf_ôem
 *
ôem
);

76 
boﬁ
 
mbuf_exåa˘_ôem
 (
mbuf_£t
 *
ms
, 
mbuf_ôem
 *
ôem
);

78 
mbuf_dîe„ªn˚_ö°™˚
 (
mbuf_£t
 *
ms
, 
mu…i_ö°™˚
 *
mi
);

80 
ölöe
 
boﬁ


81 
	$mbuf_deföed
 (c⁄° 
mbuf_£t
 *
ms
)

83  
ms
 && ms->
Àn
;

84 
	}
}

86 
ölöe
 

87 
	$mbuf_Àn
 (c⁄° 
mbuf_£t
 *
ms
)

89  
ms
->
Àn
;

90 
	}
}

92 
ölöe
 

93 
	$mbuf_maximum_queued
 (c⁄° 
mbuf_£t
 *
ms
)

95  (Ë
ms
->
max_queued
;

96 
	}
}

98 
ölöe
 
mu…i_ö°™˚
 *

99 
	$mbuf_≥ek
 (
mbuf_£t
 *
ms
)

101 
mu…i_ö°™˚
 *
	`mbuf_≥ek_dow‹k
 (
mbuf_£t
 *
ms
);

102 i‡(
	`mbuf_deföed
 (
ms
))

103  
	`mbuf_≥ek_dow‹k
 (
ms
);

105  
NULL
;

106 
	}
}

	@src/openvpn/memdbg.h

25 #i‚de‡
MEMDBG_H


26 
	#MEMDBG_H


	)

46 #ifde‡
USE_VALGRIND


48 
	~"vÆgröd/memcheck.h
"

50 
	#VALGRIND_MAKE_READABLE
(
addr
, 
Àn
)

	)

54 
	#VALGRIND_MAKE_READABLE
(
addr
, 
Àn
)

	)

58 #ifde‡
DMALLOC


88 
	~"dmÆloc.h
"

90 
	#›ív≤_dmÆloc
(
fûe
, 
löe
, 
size
Ë
	`dmÆloc_mÆloc
((fûe), (löe), (size), 
DMALLOC_FUNC_MALLOC
, 0, 0)

	)

102 #unde‡
mÆloc


103 
	#mÆloc
(
size
Ë
	`›ív≤_dmÆloc
("logfûe", 
x_msg_löe_num
, (size))

	)

	@src/openvpn/misc.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"buf„r.h
"

34 
	~"misc.h
"

35 
	~"ba£64.h
"

36 
	~"tun.h
"

37 
	~"îr‹.h
"

38 
	~"Ÿime.h
"

39 
	~"∂ugö.h
"

40 
	~"›ti⁄s.h
"

41 
	~"m™age.h
"

42 
	~"¸y±o.h
"

43 
	~"rouã.h
"

44 
	~"c⁄sﬁe.h
"

45 
	~"wö32.h
"

47 
	~"memdbg.h
"

49 #ifde‡
ENABLE_IPROUTE


50 c⁄° *
	gùrouã_∑th
 = 
IPROUTE_PATH
;

54 
	gs¸ùt_£curôy
 = 
SSEC_BUILT_IN
;

61 
	$run_up_down
 (c⁄° *
comm™d
,

62 c⁄° 
∂ugö_li°
 *
∂ugös
,

63 
∂ugö_ty≥
,

64 c⁄° *
¨g
,

65 c⁄° *
dev_ty≥
,

66 
tun_mtu
,

67 
lök_mtu
,

68 c⁄° *
ifc⁄fig_loˇl
,

69 c⁄° * 
ifc⁄fig_ªmŸe
,

70 c⁄° *
c⁄ãxt
,

71 c⁄° *
sig«l_ãxt
,

72 c⁄° *
s¸ùt_ty≥
,

73 
ív_£t
 *
es
)

75 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

77 i‡(
sig«l_ãxt
)

78 
	`£ãnv_°r
 (
es
, "sig«l", 
sig«l_ãxt
);

79 
	`£ãnv_°r
 (
es
, "s¸ùt_c⁄ãxt", 
c⁄ãxt
);

80 
	`£ãnv_öt
 (
es
, "tun_mtu", 
tun_mtu
);

81 
	`£ãnv_öt
 (
es
, "lök_mtu", 
lök_mtu
);

82 
	`£ãnv_°r
 (
es
, "dev", 
¨g
);

83 i‡(
dev_ty≥
)

84 
	`£ãnv_°r
 (
es
, "dev_ty≥", 
dev_ty≥
);

86 i‡(!
ifc⁄fig_loˇl
)

87 
ifc⁄fig_loˇl
 = "";

88 i‡(!
ifc⁄fig_ªmŸe
)

89 
ifc⁄fig_ªmŸe
 = "";

90 i‡(!
c⁄ãxt
)

91 
c⁄ãxt
 = "";

93 i‡(
	`∂ugö_deföed
 (
∂ugös
, 
∂ugö_ty≥
))

95 
¨gv
árgv = 
	`¨gv_√w
 ();

96 
	`ASSERT
 (
¨g
);

97 
	`¨gv_¥ötf
 (&
¨gv
,

99 
¨g
,

100 
tun_mtu
, 
lök_mtu
,

101 
ifc⁄fig_loˇl
, 
ifc⁄fig_ªmŸe
,

102 
c⁄ãxt
);

104 i‡(
	`∂ugö_ˇŒ
 (
∂ugös
, 
∂ugö_ty≥
, &
¨gv
, 
NULL
, 
es
Ë!
OPENVPN_PLUGIN_FUNC_SUCCESS
)

105 
	`msg
 (
M_FATAL
, "ERROR: up/downÖlugin call failed");

107 
	`¨gv_ª£t
 (&
¨gv
);

110 i‡(
comm™d
)

112 
¨gv
árgv = 
	`¨gv_√w
 ();

113 
	`ASSERT
 (
¨g
);

114 
	`£ãnv_°r
 (
es
, "s¸ùt_ty≥", 
s¸ùt_ty≥
);

115 
	`¨gv_¥ötf
 (&
¨gv
,

117 
comm™d
,

118 
¨g
,

119 
tun_mtu
, 
lök_mtu
,

120 
ifc⁄fig_loˇl
, 
ifc⁄fig_ªmŸe
,

121 
c⁄ãxt
);

122 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

123 
	`›ív≤_run_s¸ùt
 (&
¨gv
, 
es
, 
S_FATAL
, "--up/--down");

124 
	`¨gv_ª£t
 (&
¨gv
);

127 
	`gc_‰ì
 (&
gc
);

128 
	}
}

132 
	$gë_pid_fûe
 (c⁄° * 
fûíame
, 
pid_°©e
 *
°©e
)

134 
	`CLEAR
 (*
°©e
);

135 i‡(
fûíame
)

137 
°©e
->
Â
 = 
	`∂©f‹m_f›í
 (
fûíame
, "w");

138 i‡(!
°©e
->
Â
)

139 
	`msg
 (
M_ERR
, "O≥¿îr‹ o¿pid fûê%s", 
fûíame
);

140 
°©e
->
fûíame
 = filename;

142 
	}
}

146 
	$wrôe_pid
 (c⁄° 
pid_°©e
 *
°©e
)

148 i‡(
°©e
->
fûíame
 && sèã->
Â
)

150 
pid
 = 
	`∂©f‹m_gëpid
 ();

151 
	`Ârötf
(
°©e
->
Â
, "%u\n", 
pid
);

152 i‡(
	`f˛o£
 (
°©e
->
Â
))

153 
	`msg
 (
M_ERR
, "Clo£Éº‹ o¿pid fûê%s", 
°©e
->
fûíame
);

155 
	}
}

161 
	$£t_°d_fûes_to_nuŒ
 (
boﬁ
 
°dö_⁄ly
)

163 #i‡
	`deföed
(
HAVE_DUP
Ë&& deföed(
HAVE_DUP2
)

164 
fd
;

165 i‡((
fd
 = 
	`›í
 ("/dev/nuŒ", 
O_RDWR
, 0)) != -1)

167 
	`dup2
 (
fd
, 0);

168 i‡(!
°dö_⁄ly
)

170 
	`dup2
 (
fd
, 1);

171 
	`dup2
 (
fd
, 2);

173 i‡(
fd
 > 2)

174 
	`˛o£
 (
fd
);

177 
	}
}

183 
	göëd_sockë_des¸ùt‹
 = 
SOCKET_UNDEFINED
;

186 
	$ßve_öëd_sockë_des¸ùt‹
 ()

188 
öëd_sockë_des¸ùt‹
 = 
INETD_SOCKET_DESCRIPTOR
;

189 #i‡
	`deföed
(
HAVE_DUP
Ë&& deföed(
HAVE_DUP2
)

191 i‡((
öëd_sockë_des¸ùt‹
 = 
	`dup
 (
INETD_SOCKET_DESCRIPTOR
)) < 0)

192 
	`msg
 (
M_ERR
, "INETD_SOCKET_DESCRIPTOR dup(%dËÁûed", 
INETD_SOCKET_DESCRIPTOR
);

193 
	`£t_°d_fûes_to_nuŒ
 (
åue
);

195 
	}
}

201 
	$w¨n_if_group_Ÿhîs_ac˚ssibÀ
 (c⁄° * 
fûíame
)

203 #i‚de‡
WIN32


204 #ifde‡
HAVE_STAT


205 i‡(
	`°rcmp
 (
fûíame
, 
INLINE_FILE_TAG
))

207 
°©
 
°
;

208 i‡(
	`°©
 (
fûíame
, &
°
))

210 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "WARNING: c™nŸ sèàfûê'%s'", 
fûíame
);

214 i‡(
°
.
°_mode
 & (
S_IRWXG
|
S_IRWXO
))

215 
	`msg
 (
M_WARN
, "WARNING: fûê'%s' i†grou∞‹ othî†ac˚ssibÀ", 
fûíame
);

220 
	}
}

226 
	$sy°em_îr‹_mesßge
 (
°©
, 
gc_¨ía
 *
gc
)

228 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

229 #ifde‡
WIN32


230 i‡(
°©
 == -1)

231 
	`buf_¥ötf
 (&
out
, "externalÖrogram didÇotÉxecute -- ");

232 
	`buf_¥ötf
 (&
out
, "ªtu∫edÉº‹ codê%d", 
°©
);

234 i‡(
°©
 == -1)

235 
	`buf_¥ötf
 (&
out
, "externalÖrogram fork failed");

236 i‡(!
	`WIFEXITED
 (
°©
))

237 
	`buf_¥ötf
 (&
out
, "externalÖrogram didÇotÉxitÇormally");

240 c⁄° 
cmd_ªt
 = 
	`WEXITSTATUS
 (
°©
);

241 i‡(!
cmd_ªt
)

242 
	`buf_¥ötf
 (&
out
, "externalÖrogramÉxitedÇormally");

243 i‡(
cmd_ªt
 == 127)

244 
	`buf_¥ötf
 (&
out
, "couldÇotÉxecuteÉxternalÖrogram");

246 
	`buf_¥ötf
 (&
out
, "exã∫ÆÖrogømÉxôed wôhÉº‹ sètus: %d", 
cmd_ªt
);

249  (c⁄° *)
out
.
d©a
;

250 
	}
}

255 
boﬁ


256 
	$›ív≤_execve_check
 (c⁄° 
¨gv
 *
a
, c⁄° 
ív_£t
 *
es
, c⁄° 
Êags
, c⁄° *
îr‹_mesßge
)

258 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

259 c⁄° 
°©
 = 
	`›ív≤_execve
 (
a
, 
es
, 
Êags
);

260 
ªt
 = 
Ál£
;

262 i‡(
	`∂©f‹m_sy°em_ok
 (
°©
))

263 
ªt
 = 
åue
;

266 i‡(
îr‹_mesßge
)

267 
	`msg
 (((
Êags
 & 
S_FATAL
Ë? 
M_FATAL
 : 
M_WARN
), "%s: %s",

268 
îr‹_mesßge
,

269 
	`sy°em_îr‹_mesßge
 (
°©
, &
gc
));

271 
	`gc_‰ì
 (&
gc
);

272  
ªt
;

273 
	}
}

275 
boﬁ


276 
	$›ív≤_execve_Ælowed
 (c⁄° 
Êags
)

278 i‡(
Êags
 & 
S_SCRIPT
)

279  
s¸ùt_£curôy
 >
SSEC_SCRIPTS
;

281  
s¸ùt_£curôy
 >
SSEC_BUILT_IN
;

282 
	}
}

285 #i‚de‡
WIN32


292 
	$›ív≤_execve
 (c⁄° 
¨gv
 *
a
, c⁄° 
ív_£t
 *
es
, c⁄° 
Êags
)

294 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

295 
ªt
 = -1;

296 
boﬁ
 
w¨n_shown
 = 
Ál£
;

298 i‡(
a
 &&á->
¨gv
[0])

300 #i‡
	`deföed
(
ENABLE_FEATURE_EXECVE
)

301 i‡(
	`›ív≤_execve_Ælowed
 (
Êags
))

303 c⁄° *
cmd
 = 
a
->
¨gv
[0];

304 *c⁄° *
¨gv
 = 
a
->argv;

305 *c⁄° *
ívp
 = (*c⁄° *)
	`make_ív_¨øy
 (
es
, 
åue
, &
gc
);

306 
pid_t
 
pid
;

308 
pid
 = 
	`f‹k
 ();

309 i‡(
pid
 =(
pid_t
)0)

311 
	`execve
 (
cmd
, 
¨gv
, 
ívp
);

312 
	`exô
 (127);

314 i‡(
pid
 < (
pid_t
)0)

315 
	`msg
 (
M_ERR
, "openvpn_execve: unableÅo fork");

318 i‡(
	`waôpid
 (
pid
, &
ªt
, 0) !=Öid)

319 
ªt
 = -1;

322 i‡(!
w¨n_shown
 && (
s¸ùt_£curôy
 < 
SSEC_SCRIPTS
))

324 
	`msg
 (
M_WARN
, 
SCRIPT_SECURITY_WARNING
);

325 
w¨n_shown
 = 
åue
;

328 
	`msg
 (
M_WARN
, "openvpn_execve:Éxecve functionÇotávailable");

333 
	`msg
 (
M_FATAL
, "openvpn_execve: called withÉmptyárgv");

336 
	`gc_‰ì
 (&
gc
);

337  
ªt
;

338 
	}
}

347 
	$›ív≤_p›í
 (c⁄° 
¨gv
 *
a
, c⁄° 
ív_£t
 *
es
)

349 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

350 
ªt
 = -1;

351 
boﬁ
 
w¨n_shown
 = 
Ál£
;

353 i‡(
a
 &&á->
¨gv
[0])

355 #i‡
	`deföed
(
ENABLE_FEATURE_EXECVE
)

356 i‡(
s¸ùt_£curôy
 >
SSEC_BUILT_IN
)

358 c⁄° *
cmd
 = 
a
->
¨gv
[0];

359 *c⁄° *
¨gv
 = 
a
->argv;

360 *c⁄° *
ívp
 = (*c⁄° *)
	`make_ív_¨øy
 (
es
, 
åue
, &
gc
);

361 
pid_t
 
pid
;

362 
pùe_°dout
[2];

364 i‡(
	`pùe
 (
pùe_°dout
) == 0) {

365 
pid
 = 
	`f‹k
 ();

366 i‡(
pid
 =(
pid_t
)0)

368 
	`˛o£
 (
pùe_°dout
[0]);

369 
	`dup2
 (
pùe_°dout
[1],1);

370 
	`execve
 (
cmd
, 
¨gv
, 
ívp
);

371 
	`exô
 (127);

373 i‡(
pid
 < (
pid_t
)0)

375 
	`msg
 (
M_ERR
, "openvpn_popen: unableÅo fork");

379 
°©us
 = 0;

381 
	`waôpid
(
pid
, &
°©us
, 0);

382 
ªt
 = 
pùe_°dout
[0];

383 
	`˛o£
 (
pùe_°dout
[1]);

387 
	`msg
 (
M_WARN
, "openvpn_popen: unableÅo create stdoutÖipe");

388 
ªt
 = -1;

391 i‡(!
w¨n_shown
 && (
s¸ùt_£curôy
 < 
SSEC_SCRIPTS
))

393 
	`msg
 (
M_WARN
, 
SCRIPT_SECURITY_WARNING
);

394 
w¨n_shown
 = 
åue
;

397 
	`msg
 (
M_WARN
, "openvpn_popen:Éxecve functionÇotávailable");

402 
	`msg
 (
M_FATAL
, "openvpn_popen: called withÉmptyárgv");

405 
	`gc_‰ì
 (&
gc
);

406  
ªt
;

407 
	}
}

419 
	$öô_øndom_£ed
()

421 
timevÆ
 
tv
;

423 i‡(!
	`gëtimeofday
 (&
tv
, 
NULL
))

425 c⁄° 
£ed
 = (Ë
tv
.
tv_£c
 ^Åv.
tv_u£c
;

426 
	`§™dom
 (
£ed
);

428 
	}
}

433 
	$°ªº‹_ts
 (
î∫um
, 
gc_¨ía
 *
gc
)

435 #ifde‡
HAVE_STRERROR


436 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

438 
	`buf_¥ötf
 (&
out
, "%s", 
	`›ív≤_°ªº‹
 (
î∫um
, 
gc
));

439  
	`BSTR
 (&
out
);

443 
	}
}

456 
	$c⁄°ru˘_«me_vÆue
 (c⁄° *
«me
, c⁄° *
vÆue
, 
gc_¨ía
 *
gc
)

458 
buf„r
 
out
;

460 
	`ASSERT
 (
«me
);

461 i‡(!
vÆue
)

462 
vÆue
 = "";

463 
out
 = 
	`Æloc_buf_gc
 (
	`°æí
 (
«me
Ë+ såÀ¿(
vÆue
Ë+ 2, 
gc
);

464 
	`buf_¥ötf
 (&
out
, "%s=%s", 
«me
, 
vÆue
);

465  
	`BSTR
 (&
out
);

466 
	}
}

468 
boﬁ


469 
	$dec⁄°ru˘_«me_vÆue
 (c⁄° *
°r
, c⁄° **
«me
, c⁄° **
vÆue
, 
gc_¨ía
 *
gc
)

471 *
˝
;

473 
	`ASSERT
 (
°r
);

474 
	`ASSERT
 (
«me
 && 
vÆue
);

476 *
«me
 = 
˝
 = 
	`°rög_Æloc
 (
°r
, 
gc
);

477 *
vÆue
 = 
NULL
;

479 (*
˝
))

481 i‡(*
˝
 ='=' && !*
vÆue
)

483 *
˝
 = 0;

484 *
vÆue
 = 
˝
 + 1;

486 ++
˝
;

488  *
«me
 && *
vÆue
;

489 
	}
}

491 
boﬁ


492 
	$ív_°rög_equÆ
 (c⁄° *
s1
, c⁄° *
s2
)

494 
c1
, 
c2
;

495 
	`ASSERT
 (
s1
);

496 
	`ASSERT
 (
s2
);

498 
åue
)

500 
c1
 = *
s1
++;

501 
c2
 = *
s2
++;

502 i‡(
c1
 == '=')

503 
c1
 = 0;

504 i‡(
c2
 == '=')

505 
c2
 = 0;

506 i‡(!
c1
 && !
c2
)

507  
åue
;

508 i‡(
c1
 !
c2
)

511  
Ál£
;

512 
	}
}

514 
boﬁ


515 
	$ªmove_ív_ôem
 (c⁄° *
°r
, c⁄° 
boﬁ
 
do_‰ì
, 
ív_ôem
 **
li°
)

517 
ív_ôem
 *
cuºít
, *
¥ev
;

519 
	`ASSERT
 (
°r
);

520 
	`ASSERT
 (
li°
);

522 
cuºít
 = *
li°
, 
¥ev
 = 
NULL
; cuºíà!NULL; cuºíàcuºít->
√xt
)

524 i‡(
	`ív_°rög_equÆ
 (
cuºít
->
°rög
, 
°r
))

526 i‡(
¥ev
)

527 
¥ev
->
√xt
 = 
cuºít
->next;

529 *
li°
 = 
cuºít
->
√xt
;

530 i‡(
do_‰ì
)

532 
	`mem£t
 (
cuºít
->
°rög
, 0, 
	`°æí
 (current->string));

533 
	`‰ì
 (
cuºít
->
°rög
);

534 
	`‰ì
 (
cuºít
);

536  
åue
;

538 
¥ev
 = 
cuºít
;

540  
Ál£
;

541 
	}
}

544 
	$add_ív_ôem
 (*
°r
, c⁄° 
boﬁ
 
do_Æloc
, 
ív_ôem
 **
li°
, 
gc_¨ía
 *
gc
)

546 
ív_ôem
 *
ôem
;

548 
	`ASSERT
 (
°r
);

549 
	`ASSERT
 (
li°
);

551 
	`ALLOC_OBJ_GC
 (
ôem
, 
ív_ôem
, 
gc
);

552 
ôem
->
°rög
 = 
do_Æloc
 ? 
	`°rög_Æloc
 (
°r
, 
gc
): str;

553 
ôem
->
√xt
 = *
li°
;

554 *
li°
 = 
ôem
;

555 
	}
}

559 
boﬁ


560 
	$ív_£t_dñ_nﬁock
 (
ív_£t
 *
es
, c⁄° *
°r
)

562  
	`ªmove_ív_ôem
 (
°r
, 
es
->
gc
 =
NULL
, &es->
li°
);

563 
	}
}

566 
	$ív_£t_add_nﬁock
 (
ív_£t
 *
es
, c⁄° *
°r
)

568 
	`ªmove_ív_ôem
 (
°r
, 
es
->
gc
 =
NULL
, &es->
li°
);

569 
	`add_ív_ôem
 ((*)
°r
, 
åue
, &
es
->
li°
,És->
gc
);

570 
	}
}

572 
ív_£t
 *

573 
	$ív_£t_¸óã
 (
gc_¨ía
 *
gc
)

575 
ív_£t
 *
es
;

576 
	`ALLOC_OBJ_CLEAR_GC
 (
es
, 
ív_£t
, 
gc
);

577 
es
->
li°
 = 
NULL
;

578 
es
->
gc
 = gc;

579  
es
;

580 
	}
}

583 
	$ív_£t_de°roy
 (
ív_£t
 *
es
)

585 i‡(
es
 &&És->
gc
 =
NULL
)

587 
ív_ôem
 *
e
 = 
es
->
li°
;

588 
e
)

590 
ív_ôem
 *
√xt
 = 
e
->next;

591 
	`‰ì
 (
e
->
°rög
);

592 
	`‰ì
 (
e
);

593 
e
 = 
√xt
;

595 
	`‰ì
 (
es
);

597 
	}
}

599 
boﬁ


600 
	$ív_£t_dñ
 (
ív_£t
 *
es
, c⁄° *
°r
)

602 
boﬁ
 
ªt
;

603 
	`ASSERT
 (
es
);

604 
	`ASSERT
 (
°r
);

605 
ªt
 = 
	`ív_£t_dñ_nﬁock
 (
es
, 
°r
);

606  
ªt
;

607 
	}
}

610 
	$ív_£t_add
 (
ív_£t
 *
es
, c⁄° *
°r
)

612 
	`ASSERT
 (
es
);

613 
	`ASSERT
 (
°r
);

614 
	`ív_£t_add_nﬁock
 (
es
, 
°r
);

615 
	}
}

618 
	$ív_£t_¥öt
 (
msgÀvñ
, c⁄° 
ív_£t
 *
es
)

620 i‡(
	`check_debug_Àvñ
 (
msgÀvñ
))

622 c⁄° 
ív_ôem
 *
e
;

623 
i
;

625 i‡(
es
)

627 
e
 = 
es
->
li°
;

628 
i
 = 0;

630 
e
)

632 i‡(
	`ív_ß„_to_¥öt
 (
e
->
°rög
))

633 
	`msg
 (
msgÀvñ
, "ENV [%d] '%s'", 
i
, 
e
->
°rög
);

634 ++
i
;

635 
e
 =É->
√xt
;

639 
	}
}

642 
	$ív_£t_öhîô
 (
ív_£t
 *
es
, c⁄° ív_£à*
§c
)

644 c⁄° 
ív_ôem
 *
e
;

646 
	`ASSERT
 (
es
);

648 i‡(
§c
)

650 
e
 = 
§c
->
li°
;

651 
e
)

653 
	`ív_£t_add_nﬁock
 (
es
, 
e
->
°rög
);

654 
e
 =É->
√xt
;

657 
	}
}

660 
	$ív_£t_add_to_ívú⁄mít
 (c⁄° 
ív_£t
 *
es
)

662 i‡(
es
)

664 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

665 c⁄° 
ív_ôem
 *
e
;

667 
e
 = 
es
->
li°
;

669 
e
)

671 c⁄° *
«me
;

672 c⁄° *
vÆue
;

674 i‡(
	`dec⁄°ru˘_«me_vÆue
 (
e
->
°rög
, &
«me
, &
vÆue
, &
gc
))

675 
	`£ãnv_°r
 (
NULL
, 
«me
, 
vÆue
);

677 
e
 =É->
√xt
;

679 
	`gc_‰ì
 (&
gc
);

681 
	}
}

684 
	$ív_£t_ªmove_‰om_ívú⁄mít
 (c⁄° 
ív_£t
 *
es
)

686 i‡(
es
)

688 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

689 c⁄° 
ív_ôem
 *
e
;

691 
e
 = 
es
->
li°
;

693 
e
)

695 c⁄° *
«me
;

696 c⁄° *
vÆue
;

698 i‡(
	`dec⁄°ru˘_«me_vÆue
 (
e
->
°rög
, &
«me
, &
vÆue
, &
gc
))

699 
	`£ãnv_dñ
 (
NULL
, 
«me
);

701 
e
 =É->
√xt
;

703 
	`gc_‰ì
 (&
gc
);

705 
	}
}

707 #ifde‡
HAVE_PUTENV


711 
ív_ôem
 *
	gglobÆ_ív
 = 
NULL
;

718 
	$£ãnv_cou¡î
 (
ív_£t
 *
es
, c⁄° *
«me
, 
cou¡î_ty≥
 
vÆue
)

720 
buf
[64];

721 
	`›ív≤_¢¥ötf
 (
buf
, (buf), 
cou¡î_f‹m©
, 
vÆue
);

722 
	`£ãnv_°r
 (
es
, 
«me
, 
buf
);

723 
	}
}

726 
	$£ãnv_öt
 (
ív_£t
 *
es
, c⁄° *
«me
, 
vÆue
)

728 
buf
[64];

729 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "%d", 
vÆue
);

730 
	`£ãnv_°r
 (
es
, 
«me
, 
buf
);

731 
	}
}

734 
	$£ãnv_unsig√d
 (
ív_£t
 *
es
, c⁄° *
«me
, 
vÆue
)

736 
buf
[64];

737 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "%u", 
vÆue
);

738 
	`£ãnv_°r
 (
es
, 
«me
, 
buf
);

739 
	}
}

742 
	$£ãnv_°r
 (
ív_£t
 *
es
, c⁄° *
«me
, c⁄° *
vÆue
)

744 
	`£ãnv_°r_ex
 (
es
, 
«me
, 
vÆue
, 
CC_NAME
, 0, 0, 
CC_PRINT
, 0, 0);

745 
	}
}

748 
	$£ãnv_°r_ß„
 (
ív_£t
 *
es
, c⁄° *
«me
, c⁄° *
vÆue
)

750 
uöt8_t
 
b
[64];

751 
buf„r
 
buf
;

752 
	`buf_£t_wrôe
 (&
buf
, 
b
,  (b));

753 i‡(
	`buf_¥ötf
 (&
buf
, "OPENVPN_%s", 
«me
))

754 
	`£ãnv_°r
 (
es
, 
	`BSTR
(&
buf
), 
vÆue
);

756 
	`msg
 (
M_WARN
, "setenv_str_safe:Çame overflow");

757 
	}
}

760 
	$£ãnv_dñ
 (
ív_£t
 *
es
, c⁄° *
«me
)

762 
	`ASSERT
 (
«me
);

763 
	`£ãnv_°r
 (
es
, 
«me
, 
NULL
);

764 
	}
}

767 
	$£ãnv_°r_ex
 (
ív_£t
 *
es
,

768 c⁄° *
«me
,

769 c⁄° *
vÆue
,

770 c⁄° 
«me_ö˛ude
,

771 c⁄° 
«me_ex˛ude
,

772 c⁄° 
«me_ª∂a˚
,

773 c⁄° 
vÆue_ö˛ude
,

774 c⁄° 
vÆue_ex˛ude
,

775 c⁄° 
vÆue_ª∂a˚
)

777 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

778 c⁄° *
«me_tmp
;

779 c⁄° *
vÆ_tmp
 = 
NULL
;

781 
	`ASSERT
 (
«me
 && 
	`°æí
 (name) > 1);

783 
«me_tmp
 = 
	`°rög_mod_c⁄°
 (
«me
, 
«me_ö˛ude
, 
«me_ex˛ude
, 
«me_ª∂a˚
, &
gc
);

785 i‡(
vÆue
)

786 
vÆ_tmp
 = 
	`°rög_mod_c⁄°
 (
vÆue
, 
vÆue_ö˛ude
, 
vÆue_ex˛ude
, 
vÆue_ª∂a˚
, &
gc
);

788 
	`ASSERT
 (
es
);

790 i‡(
vÆ_tmp
)

792 c⁄° *
°r
 = 
	`c⁄°ru˘_«me_vÆue
 (
«me_tmp
, 
vÆ_tmp
, &
gc
);

793 
	`ív_£t_add
 (
es
, 
°r
);

794 #i‡
DEBUG_VERBOSE_SETENV


795 
	`msg
 (
M_INFO
, "SETENV_ES '%s'", 
°r
);

799 
	`ív_£t_dñ
 (
es
, 
«me_tmp
);

801 
	`gc_‰ì
 (&
gc
);

802 
	}
}

808 
	$£ãnv_f‹m©_ödexed_«me
 (c⁄° *
«me
, c⁄° 
i
, 
gc_¨ía
 *
gc
)

810 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (
	`°æí
 (
«me
Ë+ 16, 
gc
);

811 i‡(
i
 >= 0)

812 
	`buf_¥ötf
 (&
out
, "%s_%d", 
«me
, 
i
);

814 
	`buf_¥ötf
 (&
out
, "%s", 
«me
);

815  
	`BSTR
 (&
out
);

816 
	}
}

819 
	$£ãnv_öt_i
 (
ív_£t
 *
es
, c⁄° *
«me
, c⁄° 
vÆue
, c⁄° 
i
)

821 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

822 c⁄° *
«me_°r
 = 
	`£ãnv_f‹m©_ödexed_«me
 (
«me
, 
i
, &
gc
);

823 
	`£ãnv_öt
 (
es
, 
«me_°r
, 
vÆue
);

824 
	`gc_‰ì
 (&
gc
);

825 
	}
}

828 
	$£ãnv_°r_i
 (
ív_£t
 *
es
, c⁄° *
«me
, c⁄° *
vÆue
, c⁄° 
i
)

830 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

831 c⁄° *
«me_°r
 = 
	`£ãnv_f‹m©_ödexed_«me
 (
«me
, 
i
, &
gc
);

832 
	`£ãnv_°r
 (
es
, 
«me_°r
, 
vÆue
);

833 
	`gc_‰ì
 (&
gc
);

834 
	}
}

840 
	$cou¡_bôs
(
a
)

842 
ªsu…
;

843 
ªsu…
 = (
a
 & 0x55) + ((a >> 1) & 0x55);

844 
ªsu…
 = (result & 0x33) + ((result >> 2) & 0x33);

845 ((
ªsu…
 & 0x0F) + ((result >> 4) & 0x0F));

846 
	}
}

849 
	$cou¡_√tmask_bôs
(c⁄° *
dŸãd_quad
)

851 
ªsu…
, 
a
, 
b
, 
c
, 
d
;

853 i‡(
	`ssˇnf
(
dŸãd_quad
, "%u.%u.%u.%u", &
a
, &
b
, &
c
, &
d
) != 4)

855 
ªsu…
 = 
	`cou¡_bôs
(
a
);

856 
ªsu…
 +
	`cou¡_bôs
(
b
);

857 
ªsu…
 +
	`cou¡_bôs
(
c
);

858 
ªsu…
 +
	`cou¡_bôs
(
d
);

859  (()
ªsu…
);

860 
	}
}

863 
boﬁ


864 
	$ã°_fûe
 (c⁄° *
fûíame
)

866 
boﬁ
 
ªt
 = 
Ál£
;

867 i‡(
fûíame
)

869 
FILE
 *
Â
 = 
	`∂©f‹m_f›í
 (
fûíame
, "r");

870 i‡(
Â
)

872 
	`f˛o£
 (
Â
);

873 
ªt
 = 
åue
;

877 if–
	`›ív≤_î∫o
 (Ë=
EACCES
 ) {

878 
	`msg
–
M_WARN
 | 
M_ERRNO
, "CouldÇŸác˚s†fûê'%s'", 
fûíame
);

883 
	`dmsg
 (
D_TEST_FILE
, "TEST FILE '%s' [%d]",

884 
fûíame
 ? filename : "UNDEF",

885 
ªt
);

887  
ªt
;

888 
	}
}

890 #ifde‡
ENABLE_CRYPTO


894 
	$¸óã_ãmp_fûe
 (c⁄° *
dúe˘‹y
, c⁄° *
¥efix
, 
gc_¨ía
 *
gc
)

896 
cou¡î
;

897 
buf„r
 
‚ame
 = 
	`Æloc_buf_gc
 (256, 
gc
);

898 
fd
;

899 c⁄° *
ªt‚ame
 = 
NULL
;

900 
©ãm±s
 = 0;

904 
uöt8_t
 
∫dbyãs
[16];

905 c⁄° *
∫d°r
;

907 ++
©ãm±s
;

908 ++
cou¡î
;

910 
	`¥ng_byãs
 (
∫dbyãs
, Ñndbytes);

911 
∫d°r
 = 
	`f‹m©_hex_ex
 (
∫dbyãs
, Ñndbyãs, 40, 0, 
NULL
, 
gc
);

912 
	`buf_¥ötf
 (&
‚ame
, 
PACKAGE
 "_%s_%s.tmp", 
¥efix
, 
∫d°r
);

914 
ªt‚ame
 = 
	`gí_∑th
 (
dúe˘‹y
, 
	`BSTR
 (&
‚ame
), 
gc
);

915 i‡(!
ªt‚ame
)

917 
	`msg
 (
M_FATAL
, "FailedÅo createÅemporary filenameándÖath");

918  
NULL
;

923 
fd
 = 
	`∂©f‹m_›í
 (
ªt‚ame
, 
O_CREAT
 | 
O_EXCL
 | 
O_WRONLY
, 
S_IRUSR
 | 
S_IWUSR
);

924 i‡(
fd
 != -1)

926 
	`˛o£
 (
fd
);

927  
ªt‚ame
;

929 i‡(
fd
 =-1 && 
î∫o
 !
EEXIST
)

932 
gc_¨ía
 
g˚º
 = 
	`gc_√w
 ();

933 
	`msg
 (
M_FATAL
, "CouldÇot createÅemporary file '%s': %s",

934 
ªt‚ame
, 
	`°ªº‹_ts
 (
î∫o
, &
g˚º
));

935 
	`gc_‰ì
 (&
g˚º
);

936  
NULL
;

939 
©ãm±s
 < 6);

941 
	`msg
 (
M_FATAL
, "FaûedÅÿ¸óãÅemp‹¨y fûêa·î %ò©ãm±s", 
©ãm±s
);

942  
NULL
;

943 
	}
}

951 
	$ho°«me_øndomize
(c⁄° *
ho°«me
, 
gc_¨ía
 *
gc
)

953 
	#n_∫d_byãs
 6

	)

955 
uöt8_t
 
∫d_byãs
[
n_∫d_byãs
];

956 c⁄° *
∫d_°r
;

957 
buf„r
 
h«me
 = 
	`Æloc_buf_gc
 (
	`°æí
(
ho°«me
)+(
∫d_byãs
)*2+4, 
gc
);

959 
	`¥ng_byãs
 (
∫d_byãs
,  (rnd_bytes));

960 
∫d_°r
 = 
	`f‹m©_hex_ex
 (
∫d_byãs
,  (∫d_byãs), 40, 0, 
NULL
, 
gc
);

961 
	`buf_¥ötf
(&
h«me
, "%s.%s", 
∫d_°r
, 
ho°«me
);

962  
	`BSTR
(&
h«me
);

963 #unde‡
n_∫d_byãs


964 
	}
}

969 
	$ho°«me_øndomize
(c⁄° *
ho°«me
, 
gc_¨ía
 *
gc
)

971 
	`msg
 (
M_WARN
, "WARNING: hostnameÑandomization disabled when crypto support isÇot compiled");

972  
ho°«me
;

973 
	}
}

981 
	$gí_∑th
 (c⁄° *
dúe˘‹y
, c⁄° *
fûíame
, 
gc_¨ía
 *
gc
)

983 #i‡
WIN32


984 c⁄° 
CC_PATH_RESERVED
 = 
CC_LESS_THAN
|
CC_GREATER_THAN
|
CC_COLON
|

985 
CC_DOUBLE_QUOTE
|
CC_SLASH
|
CC_BACKSLASH
|
CC_PIPE
|
CC_QUESTION_MARK
|
CC_ASTERISK
;

987 c⁄° 
CC_PATH_RESERVED
 = 
CC_SLASH
;

989 c⁄° *
ß„_fûíame
 = 
	`°rög_mod_c⁄°
 (
fûíame
, 
CC_PRINT
, 
CC_PATH_RESERVED
, '_', 
gc
);

991 i‡(
ß„_fûíame


992 && 
	`°rcmp
 (
ß„_fûíame
, ".")

993 && 
	`°rcmp
 (
ß„_fûíame
, "..")

994 #ifde‡
WIN32


995 && 
	`wö_ß„_fûíame
 (
ß„_fûíame
)

999 c⁄° 
size_t
 
outsize
 = 
	`°æí
(
ß„_fûíame
Ë+ (
dúe˘‹y
 ? strlen (directory) : 0) + 16;

1000 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (
outsize
, 
gc
);

1001 
dú£p
[2];

1003 
dú£p
[0] = 
OS_SPECIFIC_DIRSEP
;

1004 
dú£p
[1] = '\0';

1006 i‡(
dúe˘‹y
)

1007 
	`buf_¥ötf
 (&
out
, "%s%s", 
dúe˘‹y
, 
dú£p
);

1008 
	`buf_¥ötf
 (&
out
, "%s", 
ß„_fûíame
);

1010  
	`BSTR
 (&
out
);

1013  
NULL
;

1014 
	}
}

1016 
boﬁ


1017 
	$absﬁuã_∑th«me
 (c⁄° *
∑th«me
)

1019 i‡(
∑th«me
)

1021 c⁄° 
c
 = 
∑th«me
[0];

1022 #ifde‡
WIN32


1023  
c
 ='\\' || (
	`ißÕha
(cË&& 
∑th«me
[1] == ':' &&Öathname[2] == '\\');

1025  
c
 == '/';

1029  
Ál£
;

1030 
	}
}

1036 
boﬁ


1037 
	$gë_u£r_∑ss_¸
 (
u£r_∑ss
 *
up
,

1038 c⁄° *
auth_fûe
,

1039 c⁄° *
¥efix
,

1040 c⁄° 
Êags
,

1041 c⁄° *
auth_chÆÀnge
)

1043 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1045 i‡(!
up
->
deföed
)

1047 c⁄° 
boﬁ
 
‰om_°dö
 = (!
auth_fûe
 || !
	`°rcmp
 (auth_file, "stdin"));

1049 i‡(
Êags
 & 
GET_USER_PASS_PREVIOUS_CREDS_FAILED
)

1050 
	`msg
 (
M_WARN
, "NŸe:Öªviou†'%s' cªdítül†Áûed", 
¥efix
);

1052 #ifde‡
ENABLE_MANAGEMENT


1056 i‡(
m™agemít


1057 && ((
auth_fûe
 && 
	`°ªq
 (auth_fûe, "m™agemít")Ë|| (
‰om_°dö
 && (
Êags
 & 
GET_USER_PASS_MANAGEMENT
)))

1058 && 
	`m™agemít_quîy_u£r_∑ss_íabÀd
 (
m™agemít
))

1060 c⁄° *
sc
 = 
NULL
;

1062 i‡(
Êags
 & 
GET_USER_PASS_PREVIOUS_CREDS_FAILED
)

1063 
	`m™agemít_auth_Áûuª
 (
m™agemít
, 
¥efix
, "previousáuth credentials failed");

1065 #ifde‡
ENABLE_CLIENT_CR


1066 i‡(
auth_chÆÀnge
 && (
Êags
 & 
GET_USER_PASS_STATIC_CHALLENGE
))

1067 
sc
 = 
auth_chÆÀnge
;

1069 i‡(!
	`m™agemít_quîy_u£r_∑ss
 (
m™agemít
, 
up
, 
¥efix
, 
Êags
, 
sc
))

1071 i‡((
Êags
 & 
GET_USER_PASS_NOFATAL
) != 0)

1072  
Ál£
;

1074 
	`msg
 (
M_FATAL
, "ERROR: couldÇŸÑód %†u£∫ame/∑ssw‹d/ok/°rög from m™agemíàöãrÁ˚", 
¥efix
);

1082 i‡(
Êags
 & 
GET_USER_PASS_NEED_OK
)

1084 
buf„r
 
u£r_¥om±
 = 
	`Æloc_buf_gc
 (128, &
gc
);

1086 
	`buf_¥ötf
 (&
u£r_¥om±
, "NEED-OK|%s|%s:", 
¥efix
, 
up
->
u£∫ame
);

1088 i‡(!
	`gë_c⁄sﬁe_öput
 (
	`BSTR
 (&
u£r_¥om±
), 
åue
, 
up
->
∑ssw‹d
, 
USER_PASS_LEN
))

1089 
	`msg
 (
M_FATAL
, "ERROR: couldÇŸÑód %†ok-c⁄fúm©i⁄ from stdö", 
¥efix
);

1091 i‡(!
	`°æí
 (
up
->
∑ssw‹d
))

1092 
	`°r˝y
 (
up
->
∑ssw‹d
, "ok");

1098 i‡(
‰om_°dö
)

1100 #ifde‡
ENABLE_CLIENT_CR


1101 i‡(
auth_chÆÀnge
 && (
Êags
 & 
GET_USER_PASS_DYNAMIC_CHALLENGE
))

1103 
auth_chÆÀnge_öfo
 *
ac
 = 
	`gë_auth_chÆÀnge
 (
auth_chÆÀnge
, &
gc
);

1104 i‡(
ac
)

1106 *
ª•⁄£
 = (*Ë
	`gc_mÆloc
 (
USER_PASS_LEN
, 
Ál£
, &
gc
);

1107 
buf„r
 
∑cked_ª•
;

1109 
	`buf_£t_wrôe
 (&
∑cked_ª•
, (
uöt8_t
*)
up
->
∑ssw‹d
, 
USER_PASS_LEN
);

1110 
	`msg
 (
M_INFO
|
M_NOPREFIX
, "CHALLENGE: %s", 
ac
->
chÆÀnge_ãxt
);

1111 i‡(!
	`gë_c⁄sﬁe_öput
 ("Re•⁄£:", 
	`BOOL_CAST
(
ac
->
Êags
&
CR_ECHO
), 
ª•⁄£
, 
USER_PASS_LEN
))

1112 
	`msg
 (
M_FATAL
, "ERROR: couldÇotÑead challengeÑesponse from stdin");

1113 
	`°∫˝y¡
 (
up
->
u£∫ame
, 
ac
->
u£r
, 
USER_PASS_LEN
);

1114 
	`buf_¥ötf
 (&
∑cked_ª•
, "CRV1::%s::%s", 
ac
->
°©e_id
, 
ª•⁄£
);

1118 
	`msg
 (
M_FATAL
, "ERROR:Ñeceived malformed challengeÑequest from server");

1124 
buf„r
 
u£r_¥om±
 = 
	`Æloc_buf_gc
 (128, &
gc
);

1125 
buf„r
 
∑ss_¥om±
 = 
	`Æloc_buf_gc
 (128, &
gc
);

1127 
	`buf_¥ötf
 (&
u£r_¥om±
, "E¡î %†U£∫ame:", 
¥efix
);

1128 
	`buf_¥ötf
 (&
∑ss_¥om±
, "E¡î %†Passw‹d:", 
¥efix
);

1130 i‡(!(
Êags
 & 
GET_USER_PASS_PASSWORD_ONLY
))

1132 i‡(!
	`gë_c⁄sﬁe_öput
 (
	`BSTR
 (&
u£r_¥om±
), 
åue
, 
up
->
u£∫ame
, 
USER_PASS_LEN
))

1133 
	`msg
 (
M_FATAL
, "ERROR: couldÇŸÑód %†u£∫amê‰om stdö", 
¥efix
);

1134 i‡(
	`°æí
 (
up
->
u£∫ame
) == 0)

1135 
	`msg
 (
M_FATAL
, "ERROR: %†u£∫amêi†em±y", 
¥efix
);

1138 i‡(!
	`gë_c⁄sﬁe_öput
 (
	`BSTR
 (&
∑ss_¥om±
), 
Ál£
, 
up
->
∑ssw‹d
, 
USER_PASS_LEN
))

1139 
	`msg
 (
M_FATAL
, "ERROR: couldÇŸÇŸÑód %†∑ssw‹d from stdö", 
¥efix
);

1141 #ifde‡
ENABLE_CLIENT_CR


1142 i‡(
auth_chÆÀnge
 && (
Êags
 & 
GET_USER_PASS_STATIC_CHALLENGE
))

1144 *
ª•⁄£
 = (*Ë
	`gc_mÆloc
 (
USER_PASS_LEN
, 
Ál£
, &
gc
);

1145 
buf„r
 
∑cked_ª•
;

1146 *
pw64
=
NULL
, *
ª•64
=NULL;

1148 
	`msg
 (
M_INFO
|
M_NOPREFIX
, "CHALLENGE: %s", 
auth_chÆÀnge
);

1149 i‡(!
	`gë_c⁄sﬁe_öput
 ("Re•⁄£:", 
	`BOOL_CAST
(
Êags
 & 
GET_USER_PASS_STATIC_CHALLENGE_ECHO
), 
ª•⁄£
, 
USER_PASS_LEN
))

1150 
	`msg
 (
M_FATAL
, "ERROR: couldÇotÑead static challengeÑesponse from stdin");

1151 i‡(
	`›ív≤_ba£64_ícode
(
up
->
∑ssw‹d
, 
	`°æí
(up->∑ssw‹d), &
pw64
) == -1

1152 || 
	`›ív≤_ba£64_ícode
(
ª•⁄£
, 
	`°æí
‘e•⁄£), &
ª•64
) == -1)

1153 
	`msg
 (
M_FATAL
, "ERROR: couldÇot base64-encodeÖassword/static_response");

1154 
	`buf_£t_wrôe
 (&
∑cked_ª•
, (
uöt8_t
*)
up
->
∑ssw‹d
, 
USER_PASS_LEN
);

1155 
	`buf_¥ötf
 (&
∑cked_ª•
, "SCRV1:%s:%s", 
pw64
, 
ª•64
);

1156 
	`°rög_˛ór
(
pw64
);

1157 
	`‰ì
(
pw64
);

1158 
	`°rög_˛ór
(
ª•64
);

1159 
	`‰ì
(
ª•64
);

1169 
FILE
 *
Â
;

1171 #i‚de‡
ENABLE_PASSWORD_SAVE


1176 i‡(
Êags
 & 
GET_USER_PASS_SENSITIVE
)

1177 
	`msg
 (
M_FATAL
, "S‹ry, '%s'Öassw‹d c™nŸ bêªad fromá fûe", 
¥efix
);

1180 
	`w¨n_if_group_Ÿhîs_ac˚ssibÀ
 (
auth_fûe
);

1182 
Â
 = 
	`∂©f‹m_f›í
 (
auth_fûe
, "r");

1183 i‡(!
Â
)

1184 
	`msg
 (
M_ERR
, "Eº‹ o≥nög '%s'áuth fûe: %s", 
¥efix
, 
auth_fûe
);

1186 i‡(
Êags
 & 
GET_USER_PASS_PASSWORD_ONLY
)

1188 i‡(
	`fgës
 (
up
->
∑ssw‹d
, 
USER_PASS_LEN
, 
Â
Ë=
NULL
)

1189 
	`msg
 (
M_FATAL
, "ErrorÑeadingÖassword from %sáuthfile: %s",

1190 
¥efix
,

1191 
auth_fûe
);

1195 i‡(
	`fgës
 (
up
->
u£∫ame
, 
USER_PASS_LEN
, 
Â
Ë=
NULL


1196 || 
	`fgës
 (
up
->
∑ssw‹d
, 
USER_PASS_LEN
, 
Â
Ë=
NULL
)

1197 
	`msg
 (
M_FATAL
, "ErrorÑeading usernameándÖassword (must be onÅwo consecutiveÜines) from %sáuthfile: %s",

1198 
¥efix
,

1199 
auth_fûe
);

1202 
	`f˛o£
 (
Â
);

1204 
	`chomp
 (
up
->
u£∫ame
);

1205 
	`chomp
 (
up
->
∑ssw‹d
);

1207 i‡(!(
Êags
 & 
GET_USER_PASS_PASSWORD_ONLY
Ë&& 
	`°æí
 (
up
->
u£∫ame
) == 0)

1208 
	`msg
 (
M_FATAL
, "ERROR: u£∫amê‰om %†authfûê'%s' i†em±y", 
¥efix
, 
auth_fûe
);

1211 
	`°rög_mod
 (
up
->
u£∫ame
, 
CC_PRINT
, 
CC_CRLF
, 0);

1212 
	`°rög_mod
 (
up
->
∑ssw‹d
, 
CC_PRINT
, 
CC_CRLF
, 0);

1214 
up
->
deföed
 = 
åue
;

1218 
	`msg
 (
M_INFO
, "GET_USER_PASS %†u='%s'Ö='%s'", 
¥efix
, 
up
->
u£∫ame
, up->
∑ssw‹d
);

1221 
	`gc_‰ì
 (&
gc
);

1223  
åue
;

1224 
	}
}

1226 #ifde‡
ENABLE_CLIENT_CR


1232 
auth_chÆÀnge_öfo
 *

1233 
	$gë_auth_chÆÀnge
 (c⁄° *
auth_chÆÀnge
, 
gc_¨ía
 *
gc
)

1235 i‡(
auth_chÆÀnge
)

1237 
auth_chÆÀnge_öfo
 *
ac
;

1238 c⁄° 
Àn
 = 
	`°æí
 (
auth_chÆÀnge
);

1239 *
w‹k
 = (*Ë
	`gc_mÆloc
 (
Àn
+1, 
Ál£
, 
gc
);

1240 *
˝
;

1242 
buf„r
 
b
;

1243 
	`buf_£t_ªad
 (&
b
, (c⁄° 
uöt8_t
 *)
auth_chÆÀnge
, 
Àn
);

1245 
	`ALLOC_OBJ_CLEAR_GC
 (
ac
, 
auth_chÆÀnge_öfo
, 
gc
);

1248 i‡(!
	`buf_∑r£
(&
b
, ':', 
w‹k
, 
Àn
))

1249  
NULL
;

1250 i‡(
	`°rcmp
(
w‹k
, "CRV1"))

1251  
NULL
;

1254 i‡(!
	`buf_∑r£
(&
b
, ':', 
w‹k
, 
Àn
))

1255  
NULL
;

1256 
˝
 = 
w‹k
; *cp != '\0'; ++cp)

1258 c⁄° 
c
 = *
˝
;

1259 i‡(
c
 == 'E')

1260 
ac
->
Êags
 |
CR_ECHO
;

1261 i‡(
c
 == 'R')

1262 
ac
->
Êags
 |
CR_RESPONSE
;

1266 i‡(!
	`buf_∑r£
(&
b
, ':', 
w‹k
, 
Àn
))

1267  
NULL
;

1268 
ac
->
°©e_id
 = 
	`°rög_Æloc
(
w‹k
, 
gc
);

1271 i‡(!
	`buf_∑r£
(&
b
, ':', 
w‹k
, 
Àn
))

1272  
NULL
;

1273 
ac
->
u£r
 = (*Ë
	`gc_mÆloc
 (
	`°æí
(
w‹k
)+1, 
åue
, 
gc
);

1274 
	`›ív≤_ba£64_decode
(
w‹k
, (*)
ac
->
u£r
, -1);

1277 
ac
->
chÆÀnge_ãxt
 = 
	`°rög_Æloc
(
	`BSTR
(&
b
), 
gc
);

1279  
ac
;

1282  
NULL
;

1283 
	}
}

1287 #i‡
AUTO_USERID


1290 
	$gë_u£r_∑ss_auto_u£rid
 (
u£r_∑ss
 *
up
, c⁄° *
èg
)

1292 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1293 
buf„r
 
buf
;

1294 
uöt8_t
 
maˇddr
[6];

1295 
uöt8_t
 
dige°
 [
MD5_DIGEST_LENGTH
];

1296 c⁄° 
uöt8_t
 
hash¥efix
[] = "AUTO_USERID_DIGEST";

1298 c⁄° 
md_kt_t
 *
md5_kt
 = 
	`md_kt_gë
("MD5");

1299 
md_˘x_t
 
˘x
;

1301 
	`CLEAR
 (*
up
);

1302 
	`buf_£t_wrôe
 (&
buf
, (
uöt8_t
*)
up
->
u£∫ame
, 
USER_PASS_LEN
);

1303 
	`buf_¥ötf
 (&
buf
, "%s", 
TARGET_PREFIX
);

1304 i‡(
	`gë_deÁu…_g©eway_mac_addr
 (
maˇddr
))

1306 
	`dmsg
 (
D_AUTO_USERID
, "GUPAU: maˇddr=%s", 
	`f‹m©_hex_ex
 (
maˇddr
,  (maˇddr), 0, 1, ":", &
gc
));

1307 
	`md_˘x_öô
(&
˘x
, 
md5_kt
);

1308 
	`md_˘x_upd©e
(&
˘x
, 
hash¥efix
,  (hashprefix) - 1);

1309 
	`md_˘x_upd©e
(&
˘x
, 
maˇddr
,  (macaddr));

1310 
	`md_˘x_föÆ
(&
˘x
, 
dige°
);

1311 
	`md_˘x_˛ónup
(&
˘x
)

1312 
	`buf_¥ötf
(&
buf
, "%s", 
	`f‹m©_hex_ex
 (
dige°
,  (dige°), 0, 256, " ", &
gc
));

1316 
	`buf_¥ötf
 (&
buf
, "UNKNOWN");

1318 i‡(
èg
 && 
	`°rcmp
 (tag, "stdin"))

1319 
	`buf_¥ötf
 (&
buf
, "-%s", 
èg
);

1320 
up
->
deföed
 = 
åue
;

1321 
	`gc_‰ì
 (&
gc
);

1323 
	`dmsg
 (
D_AUTO_USERID
, "GUPAU: AUTO_USERID: '%s'", 
up
->
u£∫ame
);

1324 
	}
}

1329 
	$purge_u£r_∑ss
 (
u£r_∑ss
 *
up
, c⁄° 
boﬁ
 
f‹˚
)

1331 c⁄° 
boﬁ
 
noˇche
 = 
up
->nocache;

1332 
boﬁ
 
w¨n_shown
 = 
Ál£
;

1333 i‡(
noˇche
 || 
f‹˚
)

1335 
	`CLEAR
 (*
up
);

1336 
up
->
noˇche
 =Çocache;

1338 i‡(!
w¨n_shown
)

1340 
	`msg
 (
M_WARN
, "WARNING:Åhis configuration may cacheÖasswords in memory -- useÅheáuth-nocache optionÅoÖreventÅhis");

1341 
w¨n_shown
 = 
åue
;

1343 
	}
}

1346 
	$£t_auth_tokí
 (
u£r_∑ss
 *
up
, c⁄° *
tokí
)

1348 i‡(
tokí
 && 
	`°æí
—okíË&& 
up
 && up->
deföed
 && !up->
noˇche
)

1350 
	`CLEAR
 (
up
->
∑ssw‹d
);

1351 
	`°∫˝y¡
 (
up
->
∑ssw‹d
, 
tokí
, 
USER_PASS_LEN
);

1353 
	}
}

1362 
	$ß„_¥öt
 (c⁄° *
°r
, 
gc_¨ía
 *
gc
)

1364  
	`°rög_mod_c⁄°
 (
°r
, 
CC_PRINT
, 
CC_CRLF
, '.', 
gc
);

1365 
	}
}

1367 
boﬁ


1368 
	$is_∑ssw‹d_ív_v¨
 (c⁄° *
°r
)

1370  (
	`°∫cmp
 (
°r
, "password", 8) == 0);

1371 
	}
}

1373 
boﬁ


1374 
	$ív_Ælowed
 (c⁄° *
°r
)

1376  (
s¸ùt_£curôy
 >
SSEC_PW_ENV
 || !
	`is_∑ssw‹d_ív_v¨
 (
°r
));

1377 
	}
}

1379 
boﬁ


1380 
	$ív_ß„_to_¥öt
 (c⁄° *
°r
)

1382 #i‚de‡
UNSAFE_DEBUG


1383 i‡(
	`is_∑ssw‹d_ív_v¨
 (
°r
))

1384  
Ál£
;

1386  
åue
;

1387 
	}
}

1392 
	$make_ív_¨øy
 (c⁄° 
ív_£t
 *
es
,

1393 c⁄° 
boﬁ
 
check_Ælowed
,

1394 
gc_¨ía
 *
gc
)

1396 **
ªt
 = 
NULL
;

1397 
ív_ôem
 *
e
 = 
NULL
;

1398 
i
 = 0, 
n
 = 0;

1401 i‡(
es
)

1403 
e
 = 
es
->
li°
;É !
NULL
;É =É->
√xt
)

1404 ++
n
;

1408 
	`ALLOC_ARRAY_CLEAR_GC
 (
ªt
, *, 
n
+1, 
gc
);

1411 i‡(
es
)

1413 
i
 = 0;

1414 
e
 = 
es
->
li°
;É !
NULL
;É =É->
√xt
)

1416 i‡(!
check_Ælowed
 || 
	`ív_Ælowed
 (
e
->
°rög
))

1418 
	`ASSERT
 (
i
 < 
n
);

1419 
ªt
[
i
++] = 
e
->
°rög
;

1424 
ªt
[
i
] = 
NULL
;

1425  (c⁄° **)
ªt
;

1426 
	}
}

1429 
	$make_¨g_¨øy
 (c⁄° *
fú°
, c⁄° *
∑rms
, 
gc_¨ía
 *
gc
)

1431 **
ªt
 = 
NULL
;

1432 
ba£
 = 0;

1433 c⁄° 
max_∑rms
 = 
MAX_PARMS
 + 2;

1434 
n
 = 0;

1437 
	`ALLOC_ARRAY_CLEAR_GC
 (
ªt
, *, 
max_∑rms
, 
gc
);

1440 i‡(
fú°
)

1442 
ªt
[
ba£
++] = 
	`°rög_Æloc
 (
fú°
, 
gc
);

1445 i‡(
∑rms
)

1447 
n
 = 
	`∑r£_löe
 (
∑rms
, &
ªt
[
ba£
], 
max_∑rms
 - ba£ - 1, "make_¨g_¨øy", 0, 
M_WARN
, 
gc
);

1448 
	`ASSERT
 (
n
 >0 &&Ç + 
ba£
 + 1 <
max_∑rms
);

1450 
ªt
[
ba£
 + 
n
] = 
NULL
;

1452  (c⁄° **)
ªt
;

1453 
	}
}

1456 
	$make_ölöe_¨øy
 (c⁄° *
°r
, 
gc_¨ía
 *
gc
)

1458 
löe
[
OPTION_LINE_SIZE
];

1459 
buf„r
 
buf
;

1460 
Àn
 = 0;

1461 **
ªt
 = 
NULL
;

1462 
i
 = 0;

1464 
	`buf_£t_ªad
 (&
buf
, (c⁄° 
uöt8_t
 *Ë
°r
, 
	`°æí
 (str));

1465 
	`buf_∑r£
 (&
buf
, '\n', 
löe
,  (line)))

1466 ++
Àn
;

1469 
	`ALLOC_ARRAY_CLEAR_GC
 (
ªt
, *, 
Àn
 + 1, 
gc
);

1471 
	`buf_£t_ªad
 (&
buf
, (c⁄° 
uöt8_t
 *Ë
°r
, 
	`°æí
(str));

1472 
	`buf_∑r£
 (&
buf
, '\n', 
löe
,  (line)))

1474 
	`chomp
 (
löe
);

1475 
	`ASSERT
 (
i
 < 
Àn
);

1476 
ªt
[
i
] = 
	`°rög_Æloc
 (
	`skù_Àadög_whôe•a˚
 (
löe
), 
gc
);

1477 ++
i
;

1479 
	`ASSERT
 (
i
 <
Àn
);

1480 
ªt
[
i
] = 
NULL
;

1481  (c⁄° **)
ªt
;

1482 
	}
}

1485 
	$make_¨g_c›y
 (**
p
, 
gc_¨ía
 *
gc
)

1487 **
ªt
 = 
NULL
;

1488 c⁄° 
Àn
 = 
	`°rög_¨øy_Àn
 ((c⁄° **)
p
);

1489 c⁄° 
max_∑rms
 = 
Àn
 + 1;

1490 
i
;

1493 
	`ALLOC_ARRAY_CLEAR_GC
 (
ªt
, *, 
max_∑rms
, 
gc
);

1495 
i
 = 0; i < 
Àn
; ++i)

1496 
ªt
[
i
] = 
p
[i];

1498  (c⁄° **)
ªt
;

1499 
	}
}

1502 
	$make_exãnded_¨g_¨øy
 (**
p
, 
gc_¨ía
 *
gc
)

1504 c⁄° 
¨gc
 = 
	`°rög_¨øy_Àn
 ((c⁄° **)
p
);

1505 i‡(!
	`°rcmp
 (
p
[0], 
INLINE_FILE_TAG
Ë&& 
¨gc
 == 2)

1506  
	`make_ölöe_¨øy
 (
p
[1], 
gc
);

1508 i‡(
¨gc
 == 0)

1509  
	`make_¨g_¨øy
 (
NULL
, NULL, 
gc
);

1510 i‡(
¨gc
 == 1)

1511  
	`make_¨g_¨øy
 (
p
[0], 
NULL
, 
gc
);

1512 i‡(
¨gc
 == 2)

1513  
	`make_¨g_¨øy
 (
p
[0],Ö[1], 
gc
);

1515  
	`make_¨g_c›y
 (
p
, 
gc
);

1516 
	}
}

1519 
	$›ív≤_¶ìp
 (c⁄° 
n
)

1521 #ifde‡
ENABLE_MANAGEMENT


1522 i‡(
m™agemít
)

1524 
	`m™agemít_evít_lo›_n_£c⁄ds
 (
m™agemít
, 
n
);

1528 
	`¶ìp
 (
n
);

1529 
	}
}

1535 
size_t


1536 
	$adju°_powî_of_2
 (
size_t
 
u
)

1538 
size_t
 
ªt
 = 1;

1540 
ªt
 < 
u
)

1542 
ªt
 <<= 1;

1543 
	`ASSERT
 (
ªt
 > 0);

1546  
ªt
;

1547 
	}
}

1557 
	$¨gv_öô
 (
¨gv
 *
a
)

1559 
a
->
ˇ∑côy
 = 0;

1560 
a
->
¨gc
 = 0;

1561 
a
->
¨gv
 = 
NULL
;

1562 
a
->
sy°em_°r
 = 
NULL
;

1563 
	}
}

1565 
¨gv


1566 
	$¨gv_√w
 ()

1568 
¨gv
 
ªt
;

1569 
	`¨gv_öô
 (&
ªt
);

1570  
ªt
;

1571 
	}
}

1574 
	$¨gv_ª£t
 (
¨gv
 *
a
)

1576 
size_t
 
i
;

1577 
i
 = 0; i < 
a
->
¨gc
; ++i)

1578 
	`‰ì
 (
a
->
¨gv
[
i
]);

1579 
	`‰ì
 (
a
->
¨gv
);

1580 
	`‰ì
 (
a
->
sy°em_°r
);

1581 
	`¨gv_öô
 (
a
);

1582 
	}
}

1585 
	$¨gv_exãnd
 (
¨gv
 *
a
, c⁄° 
size_t
 
√wˇp
)

1587 i‡(
√wˇp
 > 
a
->
ˇ∑côy
)

1589 **
√w¨gv
;

1590 
size_t
 
i
;

1591 
	`ALLOC_ARRAY_CLEAR
 (
√w¨gv
, *, 
√wˇp
);

1592 
i
 = 0; i < 
a
->
¨gc
; ++i)

1593 
√w¨gv
[
i
] = 
a
->
¨gv
[i];

1594 
	`‰ì
 (
a
->
¨gv
);

1595 
a
->
¨gv
 = 
√w¨gv
;

1596 
a
->
ˇ∑côy
 = 
√wˇp
;

1598 
	}
}

1601 
	$¨gv_grow
 (
¨gv
 *
a
, c⁄° 
size_t
 
add
)

1603 c⁄° 
size_t
 
√w¨gc
 = 
a
->
¨gc
 + 
add
 + 1;

1604 
	`ASSERT
 (
√w¨gc
 > 
a
->
¨gc
);

1605 
	`¨gv_exãnd
 (
a
, 
	`adju°_powî_of_2
 (
√w¨gc
));

1606 
	}
}

1609 
	$¨gv_≠≥nd
 (
¨gv
 *
a
, *
°r
)

1611 
	`¨gv_grow
 (
a
, 1);

1612 
a
->
¨gv
[a->
¨gc
++] = 
°r
;

1613 
	}
}

1616 
	$¨gv_sy°em_°r_≠≥nd
 (
¨gv
 *
a
, c⁄° *
°r
, c⁄° 
boﬁ
 
íquŸe
)

1618 i‡(
°r
)

1620 *
√w°r
;

1623 
size_t
 
l
 = 
	`°æí
 (
°r
) + 1;

1624 i‡(
a
->
sy°em_°r
)

1625 
l
 +
	`°æí
 (
a
->
sy°em_°r
) + 1;

1626 i‡(
íquŸe
)

1627 
l
 += 2;

1630 
√w°r
 = (*Ë
	`mÆloc
 (
l
);

1631 
√w°r
[0] = '\0';

1632 
	`check_mÆloc_ªtu∫
 (
√w°r
);

1633 i‡(
a
->
sy°em_°r
)

1635 
	`°r˝y
 (
√w°r
, 
a
->
sy°em_°r
);

1636 
	`°rˇt
 (
√w°r
, " ");

1638 i‡(
íquŸe
)

1639 
	`°rˇt
 (
√w°r
, "\"");

1640 
	`°rˇt
 (
√w°r
, 
°r
);

1641 i‡(
íquŸe
)

1642 
	`°rˇt
 (
√w°r
, "\"");

1643 
	`‰ì
 (
a
->
sy°em_°r
);

1644 
a
->
sy°em_°r
 = 
√w°r
;

1646 
	}
}

1649 
	$¨gv_exåa˘_cmd_«me
 (c⁄° *
∑th
)

1651 i‡(
∑th
)

1653 *
∑th_˝
 = 
	`°rdup
(
∑th
);

1654 c⁄° *
bn
 = 
	`ba£«me
 (
∑th_˝
);

1655 i‡(
bn
)

1657 *
ªt
 = 
	`°rög_Æloc
 (
bn
, 
NULL
);

1658 *
dŸ
 = 
	`°ºchr
 (
ªt
, '.');

1659 i‡(
dŸ
)

1660 *
dŸ
 = '\0';

1661 
	`‰ì
(
∑th_˝
);

1662 i‡(
ªt
[0] != '\0')

1663  
ªt
;

1666  
NULL
;

1667 
	}
}

1670 
	$¨gv_sy°em_°r
 (c⁄° 
¨gv
 *
a
)

1672  
a
->
sy°em_°r
;

1673 
	}
}

1675 
¨gv


1676 
	$¨gv_˛⁄e
 (c⁄° 
¨gv
 *
a
, c⁄° 
size_t
 
hódroom
)

1678 
¨gv
 
r
;

1679 
size_t
 
i
;

1681 
	`¨gv_öô
 (&
r
);

1682 
i
 = 0; i < 
hódroom
; ++i)

1683 
	`¨gv_≠≥nd
 (&
r
, 
NULL
);

1684 i‡(
a
)

1686 
i
 = 0; i < 
a
->
¨gc
; ++i)

1687 
	`¨gv_≠≥nd
 (&
r
, 
	`°rög_Æloc
 (
a
->
¨gv
[
i
], 
NULL
));

1688 
r
.
sy°em_°r
 = 
	`°rög_Æloc
 (
a
->sy°em_°r, 
NULL
);

1690  
r
;

1691 
	}
}

1693 
¨gv


1694 
	$¨gv_ö£π_hód
 (c⁄° 
¨gv
 *
a
, c⁄° *
hód
)

1696 
¨gv
 
r
;

1697 *
s
;

1699 
r
 = 
	`¨gv_˛⁄e
 (
a
, 1);

1700 
r
.
¨gv
[0] = 
	`°rög_Æloc
 (
hód
, 
NULL
);

1701 
s
 = 
r
.
sy°em_°r
;

1702 
r
.
sy°em_°r
 = 
	`°rög_Æloc
 (
hód
, 
NULL
);

1703 i‡(
s
)

1705 
	`¨gv_sy°em_°r_≠≥nd
 (&
r
, 
s
, 
Ál£
);

1706 
	`‰ì
 (
s
);

1708  
r
;

1709 
	}
}

1712 
	$¨gv_ãrm
 (c⁄° **
f
)

1714 c⁄° *
p
 = *
f
;

1715 c⁄° *
ãrm
 = 
NULL
;

1716 
size_t
 
ãrmÀn
 = 0;

1718 i‡(*
p
 == '\0')

1719  
NULL
;

1721 
åue
)

1723 c⁄° 
c
 = *
p
;

1724 i‡(
c
 == '\0')

1726 i‡(
ãrm
)

1728 i‡(!
	`is•a˚
 (
c
))

1729 ++
ãrmÀn
;

1735 i‡(!
	`is•a˚
 (
c
))

1737 
ãrm
 = 
p
;

1738 
ãrmÀn
 = 1;

1741 ++
p
;

1743 *
f
 = 
p
;

1745 i‡(
ãrm
)

1747 *
ªt
;

1748 
	`ASSERT
 (
ãrmÀn
 > 0);

1749 
ªt
 = 
	`mÆloc
 (
ãrmÀn
 + 1);

1750 
	`check_mÆloc_ªtu∫
 (
ªt
);

1751 
	`mem˝y
 (
ªt
, 
ãrm
, 
ãrmÀn
);

1752 
ªt
[
ãrmÀn
] = '\0';

1753  
ªt
;

1756  
NULL
;

1757 
	}
}

1760 
	$¨gv_°r
 (c⁄° 
¨gv
 *
a
, 
gc_¨ía
 *
gc
, c⁄° 
Êags
)

1762 i‡(
a
->
¨gv
)

1763  
	`¥öt_¨gv
 ((c⁄° **)
a
->
¨gv
, 
gc
, 
Êags
);

1766 
	}
}

1769 
	$¨gv_msg
 (c⁄° 
msgÀv
, c⁄° 
¨gv
 *
a
)

1771 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1772 
	`msg
 (
msgÀv
, "%s", 
	`¨gv_°r
 (
a
, &
gc
, 0));

1773 
	`gc_‰ì
 (&
gc
);

1774 
	}
}

1777 
	$¨gv_msg_¥efix
 (c⁄° 
msgÀv
, c⁄° 
¨gv
 *
a
, c⁄° *
¥efix
)

1779 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1780 
	`msg
 (
msgÀv
, "%s: %s", 
¥efix
, 
	`¨gv_°r
 (
a
, &
gc
, 0));

1781 
	`gc_‰ì
 (&
gc
);

1782 
	}
}

1785 
	$¨gv_¥ötf
 (
¨gv
 *
a
, c⁄° *
f‹m©
, ...)

1787 
va_li°
 
¨gli°
;

1788 
	`va_°¨t
 (
¨gli°
, 
f‹m©
);

1789 
	`¨gv_¥ötf_¨gli°
 (
a
, 
f‹m©
, 0, 
¨gli°
);

1790 
	`va_íd
 (
¨gli°
);

1791 
	}
}

1794 
	$¨gv_¥ötf_ˇt
 (
¨gv
 *
a
, c⁄° *
f‹m©
, ...)

1796 
va_li°
 
¨gli°
;

1797 
	`va_°¨t
 (
¨gli°
, 
f‹m©
);

1798 
	`¨gv_¥ötf_¨gli°
 (
a
, 
f‹m©
, 
APA_CAT
, 
¨gli°
);

1799 
	`va_íd
 (
¨gli°
);

1800 
	}
}

1803 
	$¨gv_¥ötf_¨gli°
 (
¨gv
 *
a
, c⁄° *
f‹m©
, c⁄° 
Êags
, 
va_li°
 
¨gli°
)

1805 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1806 *
ãrm
;

1807 c⁄° *
f
 = 
f‹m©
;

1809 i‡(!(
Êags
 & 
APA_CAT
))

1810 
	`¨gv_ª£t
 (
a
);

1811 
	`¨gv_exãnd
 (
a
, 1);

1813 (
ãrm
 = 
	`¨gv_ãrm
 (&
f
)Ë!
NULL
)

1815 i‡(
ãrm
[0] == '%')

1817 i‡(!
	`°rcmp
 (
ãrm
, "%s"))

1819 *
s
 = 
	`va_¨g
 (
¨gli°
, *);

1820 i‡(!
s
)

1821 
s
 = "";

1822 
	`¨gv_≠≥nd
 (
a
, 
	`°rög_Æloc
 (
s
, 
NULL
));

1823 
	`¨gv_sy°em_°r_≠≥nd
 (
a
, 
s
, 
åue
);

1825 i‡(!
	`°rcmp
 (
ãrm
, "%sc"))

1827 *
s
 = 
	`va_¨g
 (
¨gli°
, *);

1828 i‡(
s
)

1830 
≈¨ms
;

1831 *
∑rms
[
MAX_PARMS
+1];

1832 
i
;

1834 
≈¨ms
 = 
	`∑r£_löe
 (
s
, 
∑rms
, 
MAX_PARMS
, "SCRIPT-ARGV", 0, 
D_ARGV_PARSE_CMD
, &
gc
);

1835 i‡(
≈¨ms
)

1837 
i
 = 0; i < 
≈¨ms
; ++i)

1838 
	`¨gv_≠≥nd
 (
a
, 
	`°rög_Æloc
 (
∑rms
[
i
], 
NULL
));

1841 
	`¨gv_≠≥nd
 (
a
, 
	`°rög_Æloc
 (
s
, 
NULL
));

1843 
	`¨gv_sy°em_°r_≠≥nd
 (
a
, 
s
, 
Ál£
);

1847 
	`¨gv_≠≥nd
 (
a
, 
	`°rög_Æloc
 ("", 
NULL
));

1848 
	`¨gv_sy°em_°r_≠≥nd
 (
a
, "echo", 
Ál£
);

1851 i‡(!
	`°rcmp
 (
ãrm
, "%d"))

1853 
num°r
[64];

1854 
	`›ív≤_¢¥ötf
 (
num°r
,  (num°r), "%d", 
	`va_¨g
 (
¨gli°
, ));

1855 
	`¨gv_≠≥nd
 (
a
, 
	`°rög_Æloc
 (
num°r
, 
NULL
));

1856 
	`¨gv_sy°em_°r_≠≥nd
 (
a
, 
num°r
, 
Ál£
);

1858 i‡(!
	`°rcmp
 (
ãrm
, "%u"))

1860 
num°r
[64];

1861 
	`›ív≤_¢¥ötf
 (
num°r
,  (num°r), "%u", 
	`va_¨g
 (
¨gli°
, ));

1862 
	`¨gv_≠≥nd
 (
a
, 
	`°rög_Æloc
 (
num°r
, 
NULL
));

1863 
	`¨gv_sy°em_°r_≠≥nd
 (
a
, 
num°r
, 
Ál£
);

1865 i‡(!
	`°rcmp
 (
ãrm
, "%s/%d"))

1867 
num°r
[64];

1868 *
s
 = 
	`va_¨g
 (
¨gli°
, *);

1870 i‡(!
s
)

1871 
s
 = "";

1873 
	`›ív≤_¢¥ötf
 (
num°r
,  (num°r), "%d", 
	`va_¨g
 (
¨gli°
, ));

1876 c⁄° 
size_t
 
Àn
 = 
	`°æí
(
s
Ë+ såÀn(
num°r
) + 2;

1877 *
comböed
 = (*Ë
	`mÆloc
 (
Àn
);

1878 
	`check_mÆloc_ªtu∫
 (
comböed
);

1880 
	`°r˝y
 (
comböed
, 
s
);

1881 
	`°rˇt
 (
comböed
, "/");

1882 
	`°rˇt
 (
comböed
, 
num°r
);

1883 
	`¨gv_≠≥nd
 (
a
, 
comböed
);

1884 
	`¨gv_sy°em_°r_≠≥nd
 (
a
, 
comböed
, 
Ál£
);

1887 i‡(!
	`°rcmp
 (
ãrm
, "%s%sc"))

1889 *
s1
 = 
	`va_¨g
 (
¨gli°
, *);

1890 *
s2
 = 
	`va_¨g
 (
¨gli°
, *);

1891 *
comböed
;

1892 *
cmd_«me
;

1894 i‡(!
s1
) s1 = "";

1895 i‡(!
s2
) s2 = "";

1896 
comböed
 = (*Ë
	`mÆloc
 (
	`°æí
(
s1
Ë+ såÀn(
s2
) + 1);

1897 
	`check_mÆloc_ªtu∫
 (
comböed
);

1898 
	`°r˝y
 (
comböed
, 
s1
);

1899 
	`°rˇt
 (
comböed
, 
s2
);

1900 
	`¨gv_≠≥nd
 (
a
, 
comböed
);

1902 
cmd_«me
 = 
	`¨gv_exåa˘_cmd_«me
 (
comböed
);

1903 i‡(
cmd_«me
)

1905 
	`¨gv_sy°em_°r_≠≥nd
 (
a
, 
cmd_«me
, 
Ál£
);

1906 
	`‰ì
 (
cmd_«me
);

1910 
	`ASSERT
 (0);

1911 
	`‰ì
 (
ãrm
);

1915 
	`¨gv_≠≥nd
 (
a
, 
ãrm
);

1916 
	`¨gv_sy°em_°r_≠≥nd
 (
a
, 
ãrm
, 
Ál£
);

1919 
	`gc_‰ì
 (&
gc
);

1920 
	}
}

1922 #ifde‡
ARGV_TEST


1924 
	$¨gv_ã°
 ()

1926 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1927 c⁄° *
s
;

1929 
¨gv
 
a
;

1931 
	`¨gv_öô
 (&
a
);

1932 
	`¨gv_¥ötf
 (&
a
, "%sc foo bar %s", "c:\\\\src\\\\test\\\\jyargs.exe", "foo bar");

1933 
	`¨gv_msg_¥efix
 (
M_INFO
, &
a
, "ARGV");

1934 
	`msg
 (
M_INFO
, "ARGV-S: %s", 
	`¨gv_sy°em_°r
(&
a
));

1937 
	`¨gv_¥ötf
 (&
a
, "%sc %s %s", "c:\\\\src\\\\test files\\\\batargs.bat", "foo", "bar");

1938 
	`¨gv_msg_¥efix
 (
M_INFO
, &
a
, "ARGV");

1939 
	`msg
 (
M_INFO
, "ARGV-S: %s", 
	`¨gv_sy°em_°r
(&
a
));

1942 
	`¨gv_¥ötf
 (&
a
, "%s%sc foo bar %s %s/%d %d %u", "/foo", "/bar.exe", "oneÅwo", "1.2.3.4", 24, -69, 96);

1943 
	`¨gv_msg_¥efix
 (
M_INFO
, &
a
, "ARGV");

1944 
	`msg
 (
M_INFO
, "ARGV-S: %s", 
	`¨gv_sy°em_°r
(&
a
));

1947 
	`¨gv_¥ötf
 (&
a
, "this isá %sÅest of int %d unsigned %u", "FOO", -69, 42);

1948 
s
 = 
	`¨gv_°r
 (&
a
, &
gc
, 
PA_BRACKET
);

1949 
	`¥ötf
 ("PF: %s\n", 
s
);

1950 
	`¥ötf
 ("PF-S: %s\n", 
	`¨gv_sy°em_°r
(&
a
));

1953 
¨gv
 
b
 = 
	`¨gv_ö£π_hód
 (&
a
, "MARK");

1954 
s
 = 
	`¨gv_°r
 (&
b
, &
gc
, 
PA_BRACKET
);

1955 
	`¥ötf
 ("PF: %s\n", 
s
);

1956 
	`¥ötf
 ("PF-S: %s\n", 
	`¨gv_sy°em_°r
(&
b
));

1957 
	`¨gv_ª£t
 (&
b
);

1960 
	`¨gv_¥ötf
 (&
a
, "%sc foo bar %d", "\"multiÅerm\" command following \\\"spaces", 99);

1961 
s
 = 
	`¨gv_°r
 (&
a
, &
gc
, 
PA_BRACKET
);

1962 
	`¥ötf
 ("PF: %s\n", 
s
);

1963 
	`¥ötf
 ("PF-S: %s\n", 
	`¨gv_sy°em_°r
(&
a
));

1964 
	`¨gv_ª£t
 (&
a
);

1966 
s
 = 
	`¨gv_°r
 (&
a
, &
gc
, 
PA_BRACKET
);

1967 
	`¥ötf
 ("PF: %s\n", 
s
);

1968 
	`¥ötf
 ("PF-S: %s\n", 
	`¨gv_sy°em_°r
(&
a
));

1969 
	`¨gv_ª£t
 (&
a
);

1971 
	`¨gv_¥ötf
 (&
a
, "foo bar %d", 99);

1972 
	`¨gv_¥ötf_ˇt
 (&
a
, "bar %d foo %sc", 42, "nonesuch");

1973 
	`¨gv_¥ötf_ˇt
 (&
a
, "cool %s %d u %s/%dÉnd", "frood", 4, "hello", 7);

1974 
s
 = 
	`¨gv_°r
 (&
a
, &
gc
, 
PA_BRACKET
);

1975 
	`¥ötf
 ("PF: %s\n", 
s
);

1976 
	`¥ötf
 ("PF-S: %s\n", 
	`¨gv_sy°em_°r
(&
a
));

1977 
	`¨gv_ª£t
 (&
a
);

1981 
löe
[512];

1982 
	`fgës
 (
löe
, ÷öe), 
°dö
Ë!
NULL
)

1984 *
ãrm
;

1985 c⁄° *
f
 = 
löe
;

1986 
i
 = 0;

1988 (
ãrm
 = 
	`¨gv_ãrm
 (&
f
)Ë!
NULL
)

1990 
	`¥ötf
 ("[%d] '%s'\n", 
i
, 
ãrm
);

1991 ++
i
;

1992 
	`‰ì
 (
ãrm
);

1998 
	`¨gv_ª£t
 (&
a
);

1999 
	`gc_‰ì
 (&
gc
);

2000 
	}
}

2008 
	$ßnôize_c⁄åﬁ_mesßge
(c⁄° *
§c
, 
gc_¨ía
 *
gc
)

2010 *
ªt
 = 
	`gc_mÆloc
 (
	`°æí
(
§c
)+1, 
Ál£
, 
gc
);

2011 *
de°
 = 
ªt
;

2012 
boﬁ
 
ªda˘
 = 
Ál£
;

2013 
skù
 = 0;

2017 c⁄° 
c
 = *
§c
;

2018 i‡(
c
 == '\0')

2020 i‡(
c
 ='S' && !
	`°∫cmp
(
§c
, "SESS_ID_", 8))

2022 
skù
 = 7;

2023 
ªda˘
 = 
åue
;

2025 i‡(
c
 ='e' && !
	`°∫cmp
(
§c
, "echo ", 5))

2027 
skù
 = 4;

2028 
ªda˘
 = 
åue
;

2031 i‡(
c
 == ',')

2033 
skù
 = 0;

2034 
ªda˘
 = 
Ál£
;

2037 i‡(
ªda˘
)

2039 i‡(
skù
 > 0)

2041 --
skù
;

2042 *
de°
++ = 
c
;

2046 *
de°
++ = 
c
;

2048 ++
§c
;

2050 *
de°
 = '\0';

2051  
ªt
;

2052 
	}
}

2063 
boﬁ


2064 
	$com∑t_Êag
 (
Êag
)

2066 
com∑t_Êags
 = 0;

2068 i‡(
Êag
 & 
COMPAT_FLAG_SET
)

2069 
com∑t_Êags
 |(
Êag
 >> 1);

2071  (
com∑t_Êags
 & (
Êag
 >> 1));

2073 
	}
}

	@src/openvpn/misc.h

25 #i‚de‡
MISC_H


26 
	#MISC_H


	)

28 
	~"basic.h
"

29 
	~"comm⁄.h
"

30 
	~"öãgî.h
"

31 
	~"buf„r.h
"

32 
	~"∂©f‹m.h
"

35 
	#INETD_SOCKET_DESCRIPTOR
 0

	)

38 
	g∂ugö_li°
;

41 
	s¨gv
 {

42 
size_t
 
	mˇ∑côy
;

43 
size_t
 
	m¨gc
;

44 **
	m¨gv
;

45 *
	msy°em_°r
;

52 
	sív_ôem
 {

53 *
	m°rög
;

54 
ív_ôem
 *
	m√xt
;

57 
	sív_£t
 {

58 
gc_¨ía
 *
	mgc
;

59 
ív_ôem
 *
	mli°
;

62 
run_up_down
 (c⁄° *
comm™d
,

63 c⁄° 
∂ugö_li°
 *
∂ugös
,

64 
∂ugö_ty≥
,

65 c⁄° *
¨g
,

66 c⁄° *
dev_ty≥
,

67 
tun_mtu
,

68 
lök_mtu
,

69 c⁄° *
ifc⁄fig_loˇl
,

70 c⁄° * 
ifc⁄fig_ªmŸe
,

71 c⁄° *
c⁄ãxt
,

72 c⁄° *
sig«l_ãxt
,

73 c⁄° *
s¸ùt_ty≥
,

74 
ív_£t
 *
es
);

77 
	spid_°©e
 {

78 
FILE
 *
	mÂ
;

79 c⁄° *
	mfûíame
;

82 
gë_pid_fûe
 (c⁄° * 
fûíame
, 
pid_°©e
 *
°©e
);

83 
wrôe_pid
 (c⁄° 
pid_°©e
 *
°©e
);

86 
w¨n_if_group_Ÿhîs_ac˚ssibÀ
(c⁄° * 
fûíame
);

89 
	#S_SCRIPT
 (1<<0)

	)

90 
	#S_FATAL
 (1<<1)

	)

92 c⁄° *
sy°em_îr‹_mesßge
 (, 
gc_¨ía
 *
gc
);

95 
›ív≤_p›í
 (c⁄° 
¨gv
 *
a
, c⁄° 
ív_£t
 *
es
);

96 
›ív≤_execve
 (c⁄° 
¨gv
 *
a
, c⁄° 
ív_£t
 *
es
, c⁄° 
Êags
);

97 
boﬁ
 
›ív≤_execve_check
 (c⁄° 
¨gv
 *
a
, c⁄° 
ív_£t
 *
es
, c⁄° 
Êags
, c⁄° *
îr‹_mesßge
);

98 
boﬁ
 
›ív≤_execve_Ælowed
 (c⁄° 
Êags
);

100 
ölöe
 
boﬁ


101 
	$›ív≤_run_s¸ùt
 (c⁄° 
¨gv
 *
a
, c⁄° 
ív_£t
 *
es
, c⁄° 
Êags
, c⁄° *
hook
)

103 
msg
[256];

105 
	`›ív≤_¢¥ötf
(
msg
, (msg), "WARNING: FaûedÑu¬ög comm™d (%s)", 
hook
);

106  
	`›ív≤_execve_check
(
a
, 
es
, 
Êags
 | 
S_SCRIPT
, 
msg
);

107 
	}
}

110 #ifde‡
HAVE_STRERROR


112 c⁄° * 
°ªº‹_ts
 (
î∫um
, 
gc_¨ía
 *
gc
);

116 
£t_°d_fûes_to_nuŒ
 (
boﬁ
 
°dö_⁄ly
);

119 
öëd_sockë_des¸ùt‹
;

120 
ßve_öëd_sockë_des¸ùt‹
 ();

123 
öô_øndom_£ed
();

126 
£ãnv_°r_ex
 (
ív_£t
 *
es
,

127 c⁄° *
«me
,

128 c⁄° *
vÆue
,

129 c⁄° 
«me_ö˛ude
,

130 c⁄° 
«me_ex˛ude
,

131 c⁄° 
«me_ª∂a˚
,

132 c⁄° 
vÆue_ö˛ude
,

133 c⁄° 
vÆue_ex˛ude
,

134 c⁄° 
vÆue_ª∂a˚
);

136 
£ãnv_cou¡î
 (
ív_£t
 *
es
, c⁄° *
«me
, 
cou¡î_ty≥
 
vÆue
);

137 
£ãnv_öt
 (
ív_£t
 *
es
, c⁄° *
«me
, 
vÆue
);

138 
£ãnv_unsig√d
 (
ív_£t
 *
es
, c⁄° *
«me
, 
vÆue
);

139 
£ãnv_°r
 (
ív_£t
 *
es
, c⁄° *
«me
, c⁄° *
vÆue
);

140 
£ãnv_°r_ß„
 (
ív_£t
 *
es
, c⁄° *
«me
, c⁄° *
vÆue
);

141 
£ãnv_dñ
 (
ív_£t
 *
es
, c⁄° *
«me
);

143 
£ãnv_öt_i
 (
ív_£t
 *
es
, c⁄° *
«me
, c⁄° 
vÆue
, c⁄° 
i
);

144 
£ãnv_°r_i
 (
ív_£t
 *
es
, c⁄° *
«me
, c⁄° *
vÆue
, c⁄° 
i
);

148 
ív_£t
 *
ív_£t_¸óã
 (
gc_¨ía
 *
gc
);

149 
ív_£t_de°roy
 (
ív_£t
 *
es
);

150 
boﬁ
 
ív_£t_dñ
 (
ív_£t
 *
es
, c⁄° *
°r
);

151 
ív_£t_add
 (
ív_£t
 *
es
, c⁄° *
°r
);

153 
ív_£t_¥öt
 (
msgÀvñ
, c⁄° 
ív_£t
 *
es
);

155 
ív_£t_öhîô
 (
ív_£t
 *
es
, c⁄° ív_£à*
§c
);

157 
ív_£t_add_to_ívú⁄mít
 (c⁄° 
ív_£t
 *
es
);

158 
ív_£t_ªmove_‰om_ívú⁄mít
 (c⁄° 
ív_£t
 *
es
);

162 c⁄° **
make_ív_¨øy
 (c⁄° 
ív_£t
 *
es
,

163 c⁄° 
boﬁ
 
check_Ælowed
,

164 
gc_¨ía
 *
gc
);

166 c⁄° **
make_¨g_¨øy
 (c⁄° *
fú°
, c⁄° *
∑rms
, 
gc_¨ía
 *
gc
);

167 c⁄° **
make_exãnded_¨g_¨øy
 (**
p
, 
gc_¨ía
 *
gc
);

170 
cou¡_√tmask_bôs
(const *);

171 
cou¡_bôs
();

174 #ifde‡
ENABLE_CRYPTO


175 
gë_øndom
();

177 
	#gë_øndom
 
øndom


	)

181 
boﬁ
 
ã°_fûe
 (c⁄° *
fûíame
);

184 c⁄° *
¸óã_ãmp_fûe
 (c⁄° *
dúe˘‹y
, c⁄° *
¥efix
, 
gc_¨ía
 *
gc
);

187 c⁄° *
gí_∑th
 (c⁄° *
dúe˘‹y
, c⁄° *
fûíame
, 
gc_¨ía
 *
gc
);

190 
boﬁ
 
absﬁuã_∑th«me
 (c⁄° *
∑th«me
);

193 c⁄° *
ho°«me_øndomize
(c⁄° *
ho°«me
, 
gc_¨ía
 *
gc
);

199 
	su£r_∑ss


201 
boﬁ
 
	mdeföed
;

202 
boﬁ
 
	mnoˇche
;

205 #ifde‡
ENABLE_PKCS11


206 
	#USER_PASS_LEN
 4096

	)

208 
	#USER_PASS_LEN
 128

	)

210 
	mu£∫ame
[
USER_PASS_LEN
];

211 
	m∑ssw‹d
[
USER_PASS_LEN
];

214 #ifde‡
ENABLE_CLIENT_CR


218 
	sauth_chÆÀnge_öfo
 {

219 
	#CR_ECHO
 (1<<0Ë

	)

220 
	#CR_RESPONSE
 (1<<1Ë

	)

221 
	mÊags
;

223 c⁄° *
	mu£r
;

224 c⁄° *
	m°©e_id
;

225 c⁄° *
	mchÆÀnge_ãxt
;

228 
auth_chÆÀnge_öfo
 *
gë_auth_chÆÀnge
 (c⁄° *
auth_chÆÀnge
, 
gc_¨ía
 *
gc
);

233 
	s°©ic_chÆÀnge_öfo
 {

234 
	#SC_ECHO
 (1<<0Ë

	)

235 
	mÊags
;

237 c⁄° *
	mchÆÀnge_ãxt
;

241 
	sauth_chÆÀnge_öfo
 {};

242 
	s°©ic_chÆÀnge_öfo
 {};

248 
	#GET_USER_PASS_MANAGEMENT
 (1<<0)

	)

249 
	#GET_USER_PASS_SENSITIVE
 (1<<1)

	)

250 
	#GET_USER_PASS_PASSWORD_ONLY
 (1<<2)

	)

251 
	#GET_USER_PASS_NEED_OK
 (1<<3)

	)

252 
	#GET_USER_PASS_NOFATAL
 (1<<4)

	)

253 
	#GET_USER_PASS_NEED_STR
 (1<<5)

	)

254 
	#GET_USER_PASS_PREVIOUS_CREDS_FAILED
 (1<<6)

	)

256 
	#GET_USER_PASS_DYNAMIC_CHALLENGE
 (1<<7Ë

	)

257 
	#GET_USER_PASS_STATIC_CHALLENGE
 (1<<8Ë

	)

258 
	#GET_USER_PASS_STATIC_CHALLENGE_ECHO
 (1<<9Ë

	)

260 
boﬁ
 
gë_u£r_∑ss_¸
 (
u£r_∑ss
 *
up
,

261 c⁄° *
auth_fûe
,

262 c⁄° *
¥efix
,

263 c⁄° 
Êags
,

264 c⁄° *
auth_chÆÀnge
);

266 
ölöe
 
boﬁ


267 
	$gë_u£r_∑ss
 (
u£r_∑ss
 *
up
,

268 c⁄° *
auth_fûe
,

269 c⁄° *
¥efix
,

270 c⁄° 
Êags
)

272  
	`gë_u£r_∑ss_¸
 (
up
, 
auth_fûe
, 
¥efix
, 
Êags
, 
NULL
);

273 
	}
}

275 
Áû_u£r_∑ss
 (c⁄° *
¥efix
,

276 c⁄° 
Êags
,

277 c⁄° *
ªas⁄
);

279 
purge_u£r_∑ss
 (
u£r_∑ss
 *
up
, c⁄° 
boﬁ
 
f‹˚
);

281 
£t_auth_tokí
 (
u£r_∑ss
 *
up
, c⁄° *
tokí
);

288 c⁄° *
ß„_¥öt
 (c⁄° *
°r
, 
gc_¨ía
 *
gc
);

291 
boﬁ
 
ív_ß„_to_¥öt
 (c⁄° *
°r
);

294 
boﬁ
 
ív_Ælowed
 (c⁄° *
°r
);

300 
›ív≤_¶ìp
 (c⁄° 
n
);

302 
c⁄figuª_∑th
 ();

304 c⁄° *
ßnôize_c⁄åﬁ_mesßge
(c⁄° *
°r
, 
gc_¨ía
 *
gc
);

306 #i‡
AUTO_USERID


307 
gë_u£r_∑ss_auto_u£rid
 (
u£r_∑ss
 *
up
, c⁄° *
èg
);

313 #ifde‡
ENABLE_IPROUTE


314 c⁄° *
ùrouã_∑th
;

318 
	#SSEC_NONE
 0

	)

319 
	#SSEC_BUILT_IN
 1

	)

320 
	#SSEC_SCRIPTS
 2

	)

321 
	#SSEC_PW_ENV
 3

	)

322 
s¸ùt_£curôy
;

325 
size_t
 
adju°_powî_of_2
 (size_à
u
);

333 
¨gv_öô
 (
¨gv
 *
a
);

334 
¨gv
 
¨gv_√w
 ();

335 
¨gv_ª£t
 (
¨gv
 *
a
);

336 *
¨gv_ãrm
 (c⁄° **
f
);

337 c⁄° *
¨gv_°r
 (c⁄° 
¨gv
 *
a
, 
gc_¨ía
 *
gc
, c⁄° 
Êags
);

338 
¨gv
 
¨gv_ö£π_hód
 (c⁄° ¨gv *
a
, c⁄° *
hód
);

339 
¨gv_msg
 (c⁄° 
msgÀv
, c⁄° 
¨gv
 *
a
);

340 
¨gv_msg_¥efix
 (c⁄° 
msgÀv
, c⁄° 
¨gv
 *
a
, c⁄° *
¥efix
);

341 c⁄° *
¨gv_sy°em_°r
 (c⁄° 
¨gv
 *
a
);

343 
	#APA_CAT
 (1<<0Ë

	)

344 
¨gv_¥ötf_¨gli°
 (
¨gv
 *
a
, c⁄° *
f‹m©
, c⁄° 
Êags
, 
va_li°
 
¨gli°
);

346 
	$¨gv_¥ötf
 (
¨gv
 *
a
, c⁄° *
f‹m©
, ...)

347 #ifde‡
__GNUC__


348 #i‡
__USE_MINGW_ANSI_STDIO


349 
	`__©åibuã__
 ((
	$f‹m©
 (
gnu_¥ötf
, 2, 3)))

351 
	`__©åibuã__
 ((
	$f‹m©
 (
__¥ötf__
, 2, 3)))

356 
	$¨gv_¥ötf_ˇt
 (
¨gv
 *
a
, c⁄° *
f‹m©
, ...)

357 #ifde‡
__GNUC__


358 #i‡
__USE_MINGW_ANSI_STDIO


359 
	`__©åibuã__
 ((
	$f‹m©
 (
gnu_¥ötf
, 2, 3)))

361 
	`__©åibuã__
 ((
	$f‹m©
 (
__¥ötf__
, 2, 3)))

366 
	#COMPAT_FLAG_QUERY
 0

	)

367 
	#COMPAT_FLAG_SET
 (1<<0Ë

	)

368 
	#COMPAT_NAMES
 (1<<1Ë

	)

369 
	#COMPAT_NO_NAME_REMAPPING
 (1<<2Ë

	)

370 
boﬁ
 
	`com∑t_Êag
 (
Êag
);

	@src/openvpn/mroute.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #i‡
P2MP_SERVER


35 
	~"mrouã.h
"

36 
	~"¥Ÿo.h
"

37 
	~"îr‹.h
"

38 
	~"sockë.h
"

40 
	~"memdbg.h
"

43 
	$mrouã_addr_öô
 (
mrouã_addr
 *
addr
)

45 
	`CLEAR
 (*
addr
);

46 
	}
}

52 
ölöe
 
boﬁ


53 
	$is_mac_mˇ°_addr
 (c⁄° 
uöt8_t
 *
mac
)

55  (
boﬁ
Ë(
mac
[0] & 1);

56 
	}
}

58 
ölöe
 
boﬁ


59 
	$is_mac_mˇ°_maddr
 (c⁄° 
mrouã_addr
 *
addr
)

61  (
addr
->
ty≥
 & 
MR_ADDR_MASK
Ë=
MR_ADDR_ETHER
 && 
	`is_mac_mˇ°_addr
 (addr->addr);

62 
	}
}

67 
boﬁ


68 
	$mrouã_À¨«bÀ_addªss
 (c⁄° 
mrouã_addr
 *
addr
)

70 
i
;

71 
boﬁ
 
nŸ_Æl_zîos
 = 
Ál£
;

72 
boﬁ
 
nŸ_Æl_⁄es
 = 
Ál£
;

74 
i
 = 0; i < 
addr
->
Àn
; ++i)

76 
b
 = 
addr
->addr[
i
];

77 i‡(
b
 != 0x00)

78 
nŸ_Æl_zîos
 = 
åue
;

79 i‡(
b
 != 0xFF)

80 
nŸ_Æl_⁄es
 = 
åue
;

82  
nŸ_Æl_zîos
 && 
nŸ_Æl_⁄es
 && !
	`is_mac_mˇ°_maddr
 (
addr
);

83 
	}
}

85 
ölöe
 

86 
	$mrouã_gë_ö_addr_t
 (
mrouã_addr
 *
ma
, c⁄° 
ö_addr_t
 
§c
, 
mask
)

88 i‡(
ma
)

90 
ma
->
ty≥
 = 
MR_ADDR_IPV4
 | 
mask
;

91 
ma
->
√tbôs
 = 0;

92 
ma
->
Àn
 = 4;

93 *(
ö_addr_t
*)
ma
->
addr
 = 
§c
;

95 
	}
}

97 
ölöe
 

98 
	$mrouã_gë_ö6_addr
 (
mrouã_addr
 *
ma
, c⁄° 
ö6_addr
 
§c
, 
mask
)

100 i‡(
ma
)

102 
ma
->
ty≥
 = 
MR_ADDR_IPV6
 | 
mask
;

103 
ma
->
√tbôs
 = 0;

104 
ma
->
Àn
 = 16;

105 *(
ö6_addr
 *)
ma
->
addr
 = 
§c
;

107 
	}
}

109 
ölöe
 
boﬁ


110 
	$mrouã_is_mˇ°
 (c⁄° 
ö_addr_t
 
addr
)

112  ((
addr
 & 
	`ht⁄l
(
IP_MCAST_SUBNET_MASK
)Ë=ht⁄l(
IP_MCAST_NETWORK
));

113 
	}
}

118 
ölöe
 
boﬁ


119 
	$mrouã_is_mˇ°_ùv6
 (c⁄° 
ö6_addr
 
addr
)

121  (
addr
.
s6_addr
[0] == 0xff);

122 
	}
}

124 #ifde‡
ENABLE_PF


127 
	$mrouã_exåa˘_addr_¨p
 (
mrouã_addr
 *
§c
,

128 
mrouã_addr
 *
de°
,

129 c⁄° 
buf„r
 *
buf
)

131 
ªt
 = 0;

132 i‡(
	`BLEN
 (
buf
Ë>(Ë (
›ív≤_¨p
))

134 c⁄° 
›ív≤_¨p
 *
¨p
 = (c⁄° ›ív≤_¨∞*Ë
	`BPTR
 (
buf
);

135 i‡(
¨p
->
mac_addr_ty≥
 =
	`ht⁄s
(0x0001)

136 && 
¨p
->
¥Ÿo_addr_ty≥
 =
	`ht⁄s
(0x0800)

137 && 
¨p
->
mac_addr_size
 == 0x06

138 && 
¨p
->
¥Ÿo_addr_size
 == 0x04)

140 
	`mrouã_gë_ö_addr_t
 (
§c
, 
¨p
->
ù_§c
, 
MR_ARP
);

141 
	`mrouã_gë_ö_addr_t
 (
de°
, 
¨p
->
ù_de°
, 
MR_ARP
);

144 i‡(
	`mrouã_is_mˇ°
 (
¨p
->
ù_de°
))

145 
ªt
 |
MROUTE_EXTRACT_MCAST
;

147 
ªt
 |
MROUTE_EXTRACT_SUCCEEDED
;

150  
ªt
;

151 
	}
}

156 
	$mrouã_exåa˘_addr_ùv4
 (
mrouã_addr
 *
§c
,

157 
mrouã_addr
 *
de°
,

158 c⁄° 
buf„r
 *
buf
)

160 
ªt
 = 0;

161 i‡(
	`BLEN
 (
buf
) >= 1)

163 
	`OPENVPN_IPH_GET_VER
 (*
	`BPTR
(
buf
)))

166 i‡(
	`BLEN
 (
buf
Ë>(Ë (
›ív≤_ùhdr
))

168 c⁄° 
›ív≤_ùhdr
 *
ù
 = (c⁄° ›ív≤_ùhd∏*Ë
	`BPTR
 (
buf
);

170 
	`mrouã_gë_ö_addr_t
 (
§c
, 
ù
->
ßddr
, 0);

171 
	`mrouã_gë_ö_addr_t
 (
de°
, 
ù
->
daddr
, 0);

174 i‡(
	`mrouã_is_mˇ°
 (
ù
->
daddr
))

175 
ªt
 |
MROUTE_EXTRACT_MCAST
;

178 i‡(
ù
->
¥Ÿocﬁ
 =
OPENVPN_IPPROTO_IGMP
)

179 
ªt
 |
MROUTE_EXTRACT_IGMP
;

181 
ªt
 |
MROUTE_EXTRACT_SUCCEEDED
;

185 i‡(
	`BLEN
 (
buf
Ë>(Ë (
›ív≤_ùv6hdr
))

187 c⁄° 
›ív≤_ùv6hdr
 *
ùv6
 = (c⁄° ›ív≤_ùv6hd∏*Ë
	`BPTR
 (
buf
);

189 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

190 
	`msg
–
M_INFO
, "IPv6Öacket! src=%s, dst=%s",

191 
	`¥öt_ö6_addr
–
ùv6
->
ßddr
, 0, &
gc
 ),

192 
	`¥öt_ö6_addr
–
ùv6
->
daddr
, 0, &
gc
 ));

193 
	`gc_‰ì
 (&
gc
);

196 
	`mrouã_gë_ö6_addr
 (
§c
, 
ùv6
->
ßddr
, 0);

197 
	`mrouã_gë_ö6_addr
 (
de°
, 
ùv6
->
daddr
, 0);

199 i‡(
	`mrouã_is_mˇ°_ùv6
 (
ùv6
->
daddr
))

200 
ªt
 |
MROUTE_EXTRACT_MCAST
;

202 
ªt
 |
MROUTE_EXTRACT_SUCCEEDED
;

206 
	`msg
 (
M_WARN
, "IPÖacket with unknown IP version=%d seen",

207 
	`OPENVPN_IPH_GET_VER
 (*
	`BPTR
(
buf
)));

210  
ªt
;

211 
	}
}

214 
	$mrouã_exåa˘_addr_ëhî
 (
mrouã_addr
 *
§c
,

215 
mrouã_addr
 *
de°
,

216 
mrouã_addr
 *
e§c
,

217 
mrouã_addr
 *
ede°
,

218 c⁄° 
buf„r
 *
buf
)

220 
ªt
 = 0;

221 i‡(
	`BLEN
 (
buf
Ë>(Ë (
›ív≤_ëhhdr
))

223 c⁄° 
›ív≤_ëhhdr
 *
ëh
 = (c⁄° ›ív≤_ëhhd∏*Ë
	`BPTR
 (
buf
);

224 i‡(
§c
)

226 
§c
->
ty≥
 = 
MR_ADDR_ETHER
;

227 
§c
->
√tbôs
 = 0;

228 
§c
->
Àn
 = 6;

229 
	`mem˝y
 (
§c
->
addr
, 
ëh
->
sour˚
, 6);

231 i‡(
de°
)

233 
de°
->
ty≥
 = 
MR_ADDR_ETHER
;

234 
de°
->
√tbôs
 = 0;

235 
de°
->
Àn
 = 6;

236 
	`mem˝y
 (
de°
->
addr
, 
ëh
->dest, 6);

239 i‡(
	`is_mac_mˇ°_addr
 (
ëh
->
de°
))

240 
ªt
 |
MROUTE_EXTRACT_BCAST
;

243 
ªt
 |
MROUTE_EXTRACT_SUCCEEDED
;

245 #ifde‡
ENABLE_PF


246 i‡(
e§c
 || 
ede°
)

248 
buf„r
 
b
 = *
buf
;

249 i‡(
	`buf_adv™˚
 (&
b
,  (
›ív≤_ëhhdr
)))

251 
	`¡ohs
 (
ëh
->
¥Ÿo
))

253 
OPENVPN_ETH_P_IPV4
:

254 
ªt
 |(
	`mrouã_exåa˘_addr_ùv4
 (
e§c
, 
ede°
, &
b
Ë<< 
MROUTE_SEC_SHIFT
);

256 
OPENVPN_ETH_P_ARP
:

257 
ªt
 |(
	`mrouã_exåa˘_addr_¨p
 (
e§c
, 
ede°
, &
b
Ë<< 
MROUTE_SEC_SHIFT
);

264  
ªt
;

265 
	}
}

271 
boﬁ
 
	$mrouã_exåa˘_›ív≤_sockaddr
 (
mrouã_addr
 *
addr
,

272 c⁄° 
›ív≤_sockaddr
 *
oßddr
,

273 
boﬁ
 
u£_p‹t
)

275 
oßddr
->
addr
.
ß
.
ß_Ámûy
)

277 
AF_INET
:

279 i‡(
u£_p‹t
)

281 
addr
->
ty≥
 = 
MR_ADDR_IPV4
 | 
MR_WITH_PORT
;

282 
addr
->
√tbôs
 = 0;

283 
addr
->
Àn
 = 6;

284 
	`mem˝y
 (
addr
->addr, &
oßddr
->addr.
ö4
.
sö_addr
.
s_addr
, 4);

285 
	`mem˝y
 (
addr
->add∏+ 4, &
oßddr
->addr.
ö4
.
sö_p‹t
, 2);

289 
addr
->
ty≥
 = 
MR_ADDR_IPV4
;

290 
addr
->
√tbôs
 = 0;

291 
addr
->
Àn
 = 4;

292 
	`mem˝y
 (
addr
->addr, &
oßddr
->addr.
ö4
.
sö_addr
.
s_addr
, 4);

294  
åue
;

296 
AF_INET6
:

297 i‡(
u£_p‹t
)

299 
addr
->
ty≥
 = 
MR_ADDR_IPV6
 | 
MR_WITH_PORT
;

300 
addr
->
√tbôs
 = 0;

301 
addr
->
Àn
 = 18;

302 
	`mem˝y
 (
addr
->addr, &
oßddr
->addr.
ö6
.
sö6_addr
, 16);

303 
	`mem˝y
 (
addr
->add∏+ 16, &
oßddr
->addr.
ö6
.
sö6_p‹t
, 2);

307 
addr
->
ty≥
 = 
MR_ADDR_IPV6
;

308 
addr
->
√tbôs
 = 0;

309 
addr
->
Àn
 = 16;

310 
	`mem˝y
 (
addr
->addr, &
oßddr
->addr.
ö6
.
sö6_addr
, 16);

312  
åue
;

314  
Ál£
;

315 
	}
}

327 
	$mrouã_addr_mask_ho°_bôs
 (
mrouã_addr
 *
ma
)

329 
ö_addr_t
 
addr
 = 
	`¡ohl
(*(ö_addr_t*)
ma
->addr);

330 i‡((
ma
->
ty≥
 & 
MR_ADDR_MASK
Ë=
MR_ADDR_IPV4
)

332 
addr
 &
	`√tbôs_to_√tmask
 (
ma
->
√tbôs
);

333 *(
ö_addr_t
*)
ma
->
addr
 = 
	`ht⁄l
 (addr);

335 i‡((
ma
->
ty≥
 & 
MR_ADDR_MASK
Ë=
MR_ADDR_IPV6
)

337 
byã
 = 
ma
->
Àn
-1;

338 
bôs_to_˛ór
 = 128 - 
ma
->
√tbôs
;

340  
byã
 >0 && 
bôs_to_˛ór
 > 0 )

342 i‡–
bôs_to_˛ór
 >= 8 )

343 { 
ma
->
addr
[
byã
--] = 0; 
bôs_to_˛ór
 -= 8; }

345 { 
ma
->
addr
[
byã
--] &(
IPV4_NETMASK_HOST
 << 
bôs_to_˛ór
); bits_to_clear = 0; }

347 
	`ASSERT
–
bôs_to_˛ór
 == 0 );

350 
	`ASSERT
(0);

351 
	}
}

358 
uöt32_t


359 
	$mrouã_addr_hash_fun˘i⁄
 (c⁄° *
key
, 
uöt32_t
 
iv
)

361  
	`hash_func
 (
	`mrouã_addr_hash_±r
 ((c⁄° 
mrouã_addr
 *Ë
key
),

362 
	`mrouã_addr_hash_Àn
 ((c⁄° 
mrouã_addr
 *Ë
key
),

363 
iv
);

364 
	}
}

366 
boﬁ


367 
	$mrouã_addr_com∑ª_fun˘i⁄
 (c⁄° *
key1
, c⁄° *
key2
)

369  
	`mrouã_addr_equÆ
 ((c⁄° 
mrouã_addr
 *Ë
key1
,

370 (c⁄° 
mrouã_addr
 *Ë
key2
);

371 
	}
}

374 
	$mrouã_addr_¥öt
 (c⁄° 
mrouã_addr
 *
ma
,

375 
gc_¨ía
 *
gc
)

377  
	`mrouã_addr_¥öt_ex
 (
ma
, 
MAPF_IA_EMPTY_IF_UNDEF
, 
gc
);

378 
	}
}

381 
	$mrouã_addr_¥öt_ex
 (c⁄° 
mrouã_addr
 *
ma
,

382 c⁄° 
Êags
,

383 
gc_¨ía
 *
gc
)

385 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (64, 
gc
);

386 i‡(
ma
)

388 
mrouã_addr
 
maddr
 = *
ma
;

390 
maddr
.
ty≥
 & 
MR_ADDR_MASK
)

392 
MR_ADDR_ETHER
:

393 
	`buf_¥ötf
 (&
out
, "%s", 
	`f‹m©_hex_ex
 (
ma
->
addr
, 6, 0, 1, ":", 
gc
));

395 
MR_ADDR_IPV4
:

397 
buf„r
 
buf
;

398 
ö_addr_t
 
addr
;

399 
p‹t
;

400 
boﬁ
 
°©us
;

401 
	`buf_£t_ªad
 (&
buf
, 
maddr
.
addr
, maddr.
Àn
);

402 
addr
 = 
	`buf_ªad_u32
 (&
buf
, &
°©us
);

403 i‡(
°©us
)

405 i‡((
Êags
 & 
MAPF_SHOW_ARP
Ë&& (
maddr
.
ty≥
 & 
MR_ARP
))

406 
	`buf_¥ötf
 (&
out
, "ARP/");

407 
	`buf_¥ötf
 (&
out
, "%s", 
	`¥öt_ö_addr_t
 (
addr
, (
Êags
 & 
MAPF_IA_EMPTY_IF_UNDEF
Ë? 
IA_EMPTY_IF_UNDEF
 : 0, 
gc
));

408 i‡(
maddr
.
ty≥
 & 
MR_WITH_NETBITS
)

410 i‡(
Êags
 & 
MAPF_SUBNET
)

412 c⁄° 
ö_addr_t
 
√tmask
 = 
	`√tbôs_to_√tmask
 (
maddr
.
√tbôs
);

413 
	`buf_¥ötf
 (&
out
, "/%s", 
	`¥öt_ö_addr_t
 (
√tmask
, 0, 
gc
));

416 
	`buf_¥ötf
 (&
out
, "/%d", 
maddr
.
√tbôs
);

419 i‡(
maddr
.
ty≥
 & 
MR_WITH_PORT
)

421 
p‹t
 = 
	`buf_ªad_u16
 (&
buf
);

422 i‡(
p‹t
 >= 0)

423 
	`buf_¥ötf
 (&
out
, ":%d", 
p‹t
);

427 
MR_ADDR_IPV6
:

429 
	`buf_¥ötf
 (&
out
, "%s",

430 
	`¥öt_ö6_addr
–*(
ö6_addr
*)&
maddr
.
addr
, 0, 
gc
));

431 i‡(
maddr
.
ty≥
 & 
MR_WITH_NETBITS
)

433 
	`buf_¥ötf
 (&
out
, "/%d", 
maddr
.
√tbôs
);

438 
	`buf_¥ötf
 (&
out
, "UNKNOWN");

441  
	`BSTR
 (&
out
);

445 
	}
}

453 
mrouã_hñ≥r
 *

454 
	$mrouã_hñ≥r_öô
 (
agóbÀ_âl_£cs
)

456 
mrouã_hñ≥r
 *
mh
;

457 
	`ALLOC_OBJ_CLEAR
 (
mh
, 
mrouã_hñ≥r
);

458 
mh
->
agóbÀ_âl_£cs
 =ágeable_ttl_secs;

459  
mh
;

460 
	}
}

463 
	$mrouã_hñ≥r_ªgíî©e
 (
mrouã_hñ≥r
 *
mh
)

465 
i
, 
j
 = 0;

466 
i
 = 
MR_HELPER_NET_LEN
 - 1; i >= 0; --i)

468 i‡(
mh
->
√t_Àn_ªfcou¡
[
i
] > 0)

469 
mh
->
√t_Àn
[
j
++] = (
uöt8_t
Ë
i
;

471 
mh
->
n_√t_Àn
 = 
j
;

473 #ifde‡
ENABLE_DEBUG


474 i‡(
	`check_debug_Àvñ
 (
D_MULTI_DEBUG
))

476 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

477 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, &
gc
);

478 
	`buf_¥ötf
 (&
out
, "MROUTE CIDRÇetlen:");

479 
i
 = 0; i < 
mh
->
n_√t_Àn
; ++i)

481 
	`buf_¥ötf
 (&
out
, " /%d", 
mh
->
√t_Àn
[
i
]);

483 
	`dmsg
 (
D_MULTI_DEBUG
, "%s", 
	`BSTR
 (&
out
));

484 
	`gc_‰ì
 (&
gc
);

487 
	}
}

490 
	$mrouã_hñ≥r_add_úouã
 (
mrouã_hñ≥r
 *
mh
, c⁄° 
úouã
 *
ú
)

492 i‡(
ú
->
√tbôs
 >= 0)

494 
	`ASSERT
 (
ú
->
√tbôs
 < 
MR_HELPER_NET_LEN
);

495 ++
mh
->
ˇche_gíî©i⁄
;

496 ++
mh
->
√t_Àn_ªfcou¡
[
ú
->
√tbôs
];

497 i‡(
mh
->
√t_Àn_ªfcou¡
[
ú
->
√tbôs
] == 1)

498 
	`mrouã_hñ≥r_ªgíî©e
 (
mh
);

500 
	}
}

503 
	$mrouã_hñ≥r_dñ_úouã
 (
mrouã_hñ≥r
 *
mh
, c⁄° 
úouã
 *
ú
)

505 i‡(
ú
->
√tbôs
 >= 0)

507 
	`ASSERT
 (
ú
->
√tbôs
 < 
MR_HELPER_NET_LEN
);

508 ++
mh
->
ˇche_gíî©i⁄
;

509 --
mh
->
√t_Àn_ªfcou¡
[
ú
->
√tbôs
];

510 
	`ASSERT
 (
mh
->
√t_Àn_ªfcou¡
[
ú
->
√tbôs
] >= 0);

511 i‡(!
mh
->
√t_Àn_ªfcou¡
[
ú
->
√tbôs
])

512 
	`mrouã_hñ≥r_ªgíî©e
 (
mh
);

514 
	}
}

522 
	$mrouã_hñ≥r_add_úouã6
 (
mrouã_hñ≥r
 *
mh
,

523 c⁄° 
úouã_ùv6
 *
ú6
)

525 i‡(
ú6
->
√tbôs
 >= 0)

527 
	`ASSERT
 (
ú6
->
√tbôs
 < 
MR_HELPER_NET_LEN
);

528 ++
mh
->
ˇche_gíî©i⁄
;

529 ++
mh
->
√t_Àn_ªfcou¡
[
ú6
->
√tbôs
];

530 i‡(
mh
->
√t_Àn_ªfcou¡
[
ú6
->
√tbôs
] == 1)

531 
	`mrouã_hñ≥r_ªgíî©e
 (
mh
);

533 
	}
}

536 
	$mrouã_hñ≥r_dñ_úouã6
 (
mrouã_hñ≥r
 *
mh
,

537 c⁄° 
úouã_ùv6
 *
ú6
)

539 i‡(
ú6
->
√tbôs
 >= 0)

541 
	`ASSERT
 (
ú6
->
√tbôs
 < 
MR_HELPER_NET_LEN
);

542 ++
mh
->
ˇche_gíî©i⁄
;

543 --
mh
->
√t_Àn_ªfcou¡
[
ú6
->
√tbôs
];

544 
	`ASSERT
 (
mh
->
√t_Àn_ªfcou¡
[
ú6
->
√tbôs
] >= 0);

545 i‡(!
mh
->
√t_Àn_ªfcou¡
[
ú6
->
√tbôs
])

546 
	`mrouã_hñ≥r_ªgíî©e
 (
mh
);

548 
	}
}

551 
	$mrouã_hñ≥r_‰ì
 (
mrouã_hñ≥r
 *
mh
)

553 
	`‰ì
 (
mh
);

554 
	}
}

557 
	$dummy
(Ë{
	}
}

	@src/openvpn/mroute.h

25 #i‚de‡
MROUTE_H


26 
	#MROUTE_H


	)

28 #i‡
P2MP_SERVER


30 
	~"buf„r.h
"

31 
	~"li°.h
"

32 
	~"rouã.h
"

34 
	#IP_MCAST_SUBNET_MASK
 ((
ö_addr_t
)240<<24)

	)

35 
	#IP_MCAST_NETWORK
 ((
ö_addr_t
)224<<24)

	)

39 
	#MROUTE_EXTRACT_SUCCEEDED
 (1<<0)

	)

40 
	#MROUTE_EXTRACT_BCAST
 (1<<1)

	)

41 
	#MROUTE_EXTRACT_MCAST
 (1<<2)

	)

42 
	#MROUTE_EXTRACT_IGMP
 (1<<3)

	)

44 
	#MROUTE_SEC_EXTRACT_SUCCEEDED
 (1<<(0+
MROUTE_SEC_SHIFT
))

	)

45 
	#MROUTE_SEC_EXTRACT_BCAST
 (1<<(1+
MROUTE_SEC_SHIFT
))

	)

46 
	#MROUTE_SEC_EXTRACT_MCAST
 (1<<(2+
MROUTE_SEC_SHIFT
))

	)

47 
	#MROUTE_SEC_EXTRACT_IGMP
 (1<<(3+
MROUTE_SEC_SHIFT
))

	)

49 
	#MROUTE_SEC_SHIFT
 4

	)

56 
	#MR_MAX_ADDR_LEN
 20

	)

61 
	#MR_ADDR_NONE
 0

	)

62 
	#MR_ADDR_ETHER
 1

	)

63 
	#MR_ADDR_IPV4
 2

	)

64 
	#MR_ADDR_IPV6
 3

	)

65 
	#MR_ADDR_MASK
 3

	)

68 
	#MR_WITH_PORT
 4

	)

71 
	#MR_WITH_NETBITS
 8

	)

74 
	#MR_ARP
 16

	)

76 
	smrouã_addr
 {

77 
uöt8_t
 
	mÀn
;

78 
uöt8_t
 
	munu£d
;

79 
uöt8_t
 
	mty≥
;

80 
uöt8_t
 
	m√tbôs
;

82 
uöt8_t
 
	maddr
[
MR_MAX_ADDR_LEN
];

88 
	#MR_HELPER_NET_LEN
 129

	)

93 
	smrouã_hñ≥r
 {

94 
	mˇche_gíî©i⁄
;

95 
	magóbÀ_âl_£cs
;

96 
	mn_√t_Àn
;

97 
uöt8_t
 
	m√t_Àn
[
MR_HELPER_NET_LEN
];

98 
	m√t_Àn_ªfcou¡
[
MR_HELPER_NET_LEN
];

101 
	g›ív≤_sockaddr
;

103 
boﬁ
 
mrouã_exåa˘_›ív≤_sockaddr
 (
mrouã_addr
 *
addr
,

104 c⁄° 
›ív≤_sockaddr
 *
oßddr
,

105 
boﬁ
 
u£_p‹t
);

107 
boﬁ
 
mrouã_À¨«bÀ_addªss
 (c⁄° 
mrouã_addr
 *
addr
);

109 
uöt32_t
 
mrouã_addr_hash_fun˘i⁄
 (c⁄° *
key
, uöt32_à
iv
);

110 
boﬁ
 
mrouã_addr_com∑ª_fun˘i⁄
 (c⁄° *
key1
, c⁄° *
key2
);

112 
mrouã_addr_öô
 (
mrouã_addr
 *
addr
);

114 c⁄° *
mrouã_addr_¥öt
 (c⁄° 
mrouã_addr
 *
ma
,

115 
gc_¨ía
 *
gc
);

117 
	#MAPF_SUBNET
 (1<<0)

	)

118 
	#MAPF_IA_EMPTY_IF_UNDEF
 (1<<1)

	)

119 
	#MAPF_SHOW_ARP
 (1<<2)

	)

120 c⁄° *
mrouã_addr_¥öt_ex
 (c⁄° 
mrouã_addr
 *
ma
,

121 c⁄° 
Êags
,

122 
gc_¨ía
 *
gc
);

124 
mrouã_addr_mask_ho°_bôs
 (
mrouã_addr
 *
ma
);

126 
mrouã_hñ≥r
 *
mrouã_hñ≥r_öô
 (
agóbÀ_âl_£cs
);

127 
mrouã_hñ≥r_‰ì
 (
mrouã_hñ≥r
 *
mh
);

128 
mrouã_hñ≥r_add_úouã
 (
mrouã_hñ≥r
 *
mh
, c⁄° 
úouã
 *
ú
);

129 
mrouã_hñ≥r_dñ_úouã
 (
mrouã_hñ≥r
 *
mh
, c⁄° 
úouã
 *
ú
);

130 
mrouã_hñ≥r_add_úouã6
 (
mrouã_hñ≥r
 *
mh
, c⁄° 
úouã_ùv6
 *
ú6
);

131 
mrouã_hñ≥r_dñ_úouã6
 (
mrouã_hñ≥r
 *
mh
, c⁄° 
úouã_ùv6
 *
ú6
);

137 
ölöe
 

138 
	$mrouã_exåa˘_addr_‰om_∑ckë
 (
mrouã_addr
 *
§c
,

139 
mrouã_addr
 *
de°
,

140 
mrouã_addr
 *
e§c
,

141 
mrouã_addr
 *
ede°
,

142 c⁄° 
buf„r
 *
buf
,

143 
tu¬ñ_ty≥
)

145 
	`mrouã_exåa˘_addr_ùv4
 (
mrouã_addr
 *
§c
,

146 
mrouã_addr
 *
de°
,

147 c⁄° 
buf„r
 *
buf
);

149 
	`mrouã_exåa˘_addr_ëhî
 (
mrouã_addr
 *
§c
,

150 
mrouã_addr
 *
de°
,

151 
mrouã_addr
 *
e§c
,

152 
mrouã_addr
 *
ede°
,

153 c⁄° 
buf„r
 *
buf
);

154 
ªt
 = 0;

155 
	`vîify_Æign_4
 (
buf
);

156 i‡(
tu¬ñ_ty≥
 =
DEV_TYPE_TUN
)

157 
ªt
 = 
	`mrouã_exåa˘_addr_ùv4
 (
§c
, 
de°
, 
buf
);

158 i‡(
tu¬ñ_ty≥
 =
DEV_TYPE_TAP
)

159 
ªt
 = 
	`mrouã_exåa˘_addr_ëhî
 (
§c
, 
de°
, 
e§c
, 
ede°
, 
buf
);

160  
ªt
;

161 
	}
}

163 
ölöe
 
boﬁ


164 
	$mrouã_addr_equÆ
 (c⁄° 
mrouã_addr
 *
a1
, c⁄° mrouã_add∏*
a2
)

166 i‡(
a1
->
ty≥
 !
a2
->type)

167  
Ál£
;

168 i‡(
a1
->
√tbôs
 !
a2
->netbits)

169  
Ál£
;

170 i‡(
a1
->
Àn
 !
a2
->len)

171  
Ál£
;

172  
	`memcmp
 (
a1
->
addr
, 
a2
->addr,á1->
Àn
) == 0;

173 
	}
}

175 
ölöe
 c⁄° 
uöt8_t
 *

176 
	$mrouã_addr_hash_±r
 (c⁄° 
mrouã_addr
 *
a
)

179  (
uöt8_t
 *Ë&
a
->
ty≥
;

180 
	}
}

182 
ölöe
 
uöt32_t


183 
	$mrouã_addr_hash_Àn
 (c⁄° 
mrouã_addr
 *
a
)

185  (
uöt32_t
Ë
a
->
Àn
 + 2;

186 
	}
}

188 
ölöe
 

189 
	$mrouã_exåa˘_ö_addr_t
 (
mrouã_addr
 *
de°
, c⁄° 
ö_addr_t
 
§c
)

191 
de°
->
ty≥
 = 
MR_ADDR_IPV4
;

192 
de°
->
√tbôs
 = 0;

193 
de°
->
Àn
 = 4;

194 *(
ö_addr_t
*)
de°
->
addr
 = 
	`ht⁄l
 (
§c
);

195 
	}
}

197 
ölöe
 
ö_addr_t


198 
	$ö_addr_t_‰om_mrouã_addr
 (c⁄° 
mrouã_addr
 *
addr
)

200 i‡((
addr
->
ty≥
 & 
MR_ADDR_MASK
Ë=
MR_ADDR_IPV4
 &&áddr->
√tbôs
 =0 &&áddr->
Àn
 == 4)

201  
	`¡ohl
(*(
ö_addr_t
*)
addr
->addr);

204 
	}
}

206 
ölöe
 

207 
	$mrouã_addr_ª£t
 (
mrouã_addr
 *
ma
)

209 
ma
->
Àn
 = 0;

210 
ma
->
ty≥
 = 
MR_ADDR_NONE
;

211 
	}
}

	@src/openvpn/mss.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

32 
	~"îr‹.h
"

33 
	~"mss.h
"

34 
	~"memdbg.h
"

47 
	$mss_fixup_ùv4
 (
buf„r
 *
buf
, 
maxmss
)

49 c⁄° 
›ív≤_ùhdr
 *
pù
;

50 
hÀn
;

52 i‡(
	`BLEN
 (
buf
Ë< (Ë (
›ív≤_ùhdr
))

55 
	`vîify_Æign_4
 (
buf
);

56 
pù
 = (
›ív≤_ùhdr
 *Ë
	`BPTR
 (
buf
);

58 
hÀn
 = 
	`OPENVPN_IPH_GET_LEN
 (
pù
->
vîsi⁄_Àn
);

60 i‡(
pù
->
¥Ÿocﬁ
 =
OPENVPN_IPPROTO_TCP


61 && 
	`¡ohs
 (
pù
->
tŸ_Àn
Ë=
	`BLEN
 (
buf
)

62 && (
	`¡ohs
 (
pù
->
‰ag_off
Ë& 
OPENVPN_IP_OFFMASK
) == 0

63 && 
hÀn
 <
	`BLEN
 (
buf
)

64 && 
	`BLEN
 (
buf
Ë- 
hÀn


65 >(Ë (
›ív≤_t˝hdr
))

67 
buf„r
 
√wbuf
 = *
buf
;

68 i‡(
	`buf_adv™˚
 (&
√wbuf
, 
hÀn
))

70 
›ív≤_t˝hdr
 *
tc
 = (›ív≤_t˝hd∏*Ë
	`BPTR
 (&
√wbuf
);

71 i‡(
tc
->
Êags
 & 
OPENVPN_TCPH_SYN_MASK
)

72 
	`mss_fixup_dow‹k
 (&
√wbuf
, (
uöt16_t
Ë
maxmss
);

75 
	}
}

83 
	$mss_fixup_ùv6
 (
buf„r
 *
buf
, 
maxmss
)

85 c⁄° 
›ív≤_ùv6hdr
 *
pù6
;

86 
buf„r
 
√wbuf
;

88 i‡(
	`BLEN
 (
buf
Ë< (Ë (
›ív≤_ùv6hdr
))

91 
	`vîify_Æign_4
 (
buf
);

92 
pù6
 = (
›ív≤_ùv6hdr
 *Ë
	`BPTR
 (
buf
);

97 i‡(
	`BLEN
 (
buf
Ë!(Ë
	`¡ohs
(
pù6
->
∑ylﬂd_Àn
)+40 )

110 i‡–
pù6
->
√xthdr
 !
OPENVPN_IPPROTO_TCP
 )

113 
√wbuf
 = *
buf
;

114 i‡–
	`buf_adv™˚
–&
√wbuf
, 40 ) )

116 
›ív≤_t˝hdr
 *
tc
 = (›ív≤_t˝hd∏*Ë
	`BPTR
 (&
√wbuf
);

117 i‡(
tc
->
Êags
 & 
OPENVPN_TCPH_SYN_MASK
)

118 
	`mss_fixup_dow‹k
 (&
√wbuf
, (
uöt16_t
Ë
maxmss
-20);

120 
	}
}

128 
	$mss_fixup_dow‹k
 (
buf„r
 *
buf
, 
uöt16_t
 
maxmss
)

130 
hÀn
, 
ﬁí
, 
›éí
;

131 
uöt8_t
 *
›t
;

132 
uöt16_t
 *
mss
;

133 
accumuœã
;

134 
›ív≤_t˝hdr
 *
tc
;

136 
	`ASSERT
 (
	`BLEN
 (
buf
Ë>(Ë (
›ív≤_t˝hdr
));

138 
	`vîify_Æign_4
 (
buf
);

139 
tc
 = (
›ív≤_t˝hdr
 *Ë
	`BPTR
 (
buf
);

140 
hÀn
 = 
	`OPENVPN_TCPH_GET_DOFF
 (
tc
->
doff_ªs
);

143 i‡(
hÀn
 <(Ë (
›ív≤_t˝hdr
)

144 || 
hÀn
 > 
	`BLEN
 (
buf
))

147 
ﬁí
 = 
hÀn
 -  (
›ív≤_t˝hdr
),

148 
›t
 = (
uöt8_t
 *)(
tc
 + 1);

149 
ﬁí
 > 0;

150 
ﬁí
 -
›éí
, 
›t
 += optlen) {

151 i‡(*
›t
 =
OPENVPN_TCPOPT_EOL
)

153 i‡(*
›t
 =
OPENVPN_TCPOPT_NOP
)

154 
›éí
 = 1;

156 
›éí
 = *(
›t
 + 1);

157 i‡(
›éí
 <0 || o±À¿> 
ﬁí
)

159 i‡(*
›t
 =
OPENVPN_TCPOPT_MAXSEG
) {

160 i‡(
›éí
 !
OPENVPN_TCPOLEN_MAXSEG
)

162 
mss
 = (
uöt16_t
 *)(
›t
 + 2);

163 i‡(
	`¡ohs
 (*
mss
Ë> 
maxmss
) {

164 
	`dmsg
 (
D_MSS
, "MSS: %d -> %d",

165 (Ë
	`¡ohs
 (*
mss
),

166 (Ë
maxmss
);

167 
accumuœã
 = *
mss
;

168 *
mss
 = 
	`ht⁄s
 (
maxmss
);

169 
accumuœã
 -*
mss
;

170 
	`ADJUST_CHECKSUM
 (
accumuœã
, 
tc
->
check
);

175 
	}
}

	@src/openvpn/mss.h

25 #i‚de‡
MSS_H


26 
	#MSS_H


	)

28 
	~"¥Ÿo.h
"

29 
	~"îr‹.h
"

31 
mss_fixup_ùv4
 (
buf„r
 *
buf
, 
maxmss
);

32 
mss_fixup_ùv6
 (
buf„r
 *
buf
, 
maxmss
);

33 
mss_fixup_dow‹k
 (
buf„r
 *
buf
, 
uöt16_t
 
maxmss
);

	@src/openvpn/mstats.c

29 #ifde‡
HAVE_CONFIG_H


30 
	~"c⁄fig.h
"

31 #ñi‡
deföed
(
_MSC_VER
)

32 
	~"c⁄fig-msvc.h
"

35 
	~"syshód.h
"

37 #i‡
deföed
(
ENABLE_MEMSTATS
)

39 
	~<sys/mm™.h
>

41 
	~"îr‹.h
"

42 
	~"misc.h
"

43 
	~"m°©s.h
"

45 
	~"memdbg.h
"

47 vﬁ©ûê
mm≠_°©s
 *
	gmm≠_°©s
 = 
NULL
;

48 
	gmm≠_‚
[128];

51 
	$m°©s_›í
(c⁄° *
‚
)

53 *
d©a
;

54 
ssize_t
 
°©
;

55 
fd
;

56 
mm≠_°©s
 
ms
;

58 i‡(
mm≠_°©s
)

62 i‡(
	`°æí
(
‚
Ë>(
mm≠_‚
))

63 
	`msg
 (
M_FATAL
, "mstats_open: filenameÅooÜong");

66 
fd
 = 
	`›í
 (
‚
, 
O_CREAT
 | 
O_TRUNC
 | 
O_RDWR
, 
S_IRUSR
 | 
S_IWUSR
);

67 i‡(
fd
 < 0)

69 
	`msg
 (
M_ERR
, "m°©s_›í: c™nŸ o≥n: %s", 
‚
);

75 
	`CLEAR
(
ms
);

76 
ms
.
°©e
 = 
MSTATS_ACTIVE
;

77 
°©
 = 
	`wrôe
(
fd
, &
ms
, (ms));

78 i‡(
°©
 !(
ms
))

80 
	`msg
 (
M_ERR
, "m°©s_›í: wrôêîr‹: %s", 
‚
);

81 
	`˛o£
(
fd
);

86 
d©a
 = 
	`mm≠
(
NULL
, (
mm≠_°©s
), 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
fd
, 0);

87 i‡(
d©a
 =
MAP_FAILED
)

89 
	`msg
 (
M_ERR
, "m°©s_›í: wrôêîr‹: %s", 
‚
);

90 
	`˛o£
(
fd
);

95 i‡(
	`˛o£
(
fd
))

97 
	`msg
 (
M_ERR
, "m°©s_›í: clo£Éº‹: %s", 
‚
);

101 
	`°r˝y
(
mm≠_‚
, 
‚
);

104 
mm≠_°©s
 = (mm≠_°©†*)
d©a
;

106 
	`msg
 (
M_INFO
, "mem°©†d©®wû»bêwrôã¿tÿ%s", 
‚
);

107 
	}
}

110 
	$m°©s_˛o£
()

112 i‡(
mm≠_°©s
)

114 
mm≠_°©s
->
°©e
 = 
MSTATS_EXPIRED
;

115 i‡(
	`munm≠
((*)
mm≠_°©s
, (mmap_stats)))

116 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "mstats_close: munmapÉrror");

117 
	`∂©f‹m_u∆ök
(
mm≠_‚
);

118 
mm≠_°©s
 = 
NULL
;

120 
	}
}

	@src/openvpn/mstats.h

29 #i‡!
deföed
(
OPENVPN_MEMSTATS_H
Ë&& deföed(
ENABLE_MEMSTATS
)

30 
	#OPENVPN_MEMSTATS_H


	)

32 
	~"basic.h
"

35 
	smm≠_°©s
 {

36 
cou¡î_ty≥
 
	mlök_ªad_byãs
;

37 
cou¡î_ty≥
 
	mlök_wrôe_byãs
;

38 
	mn_˛õ¡s
;

40 
	#MSTATS_UNDEF
 0

	)

41 
	#MSTATS_ACTIVE
 1

	)

42 
	#MSTATS_EXPIRED
 2

	)

43 
	m°©e
;

46 vﬁ©ûê
mm≠_°©s
 *mmap_stats;

48 
m°©s_›í
(c⁄° *
‚
);

49 
m°©s_˛o£
();

	@src/openvpn/mtcp.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #i‡
P2MP_SERVER


35 
	~"mu…i.h
"

36 
	~"f‹w¨d-ölöe.h
"

38 
	~"memdbg.h
"

43 
	#TA_UNDEF
 0

	)

44 
	#TA_SOCKET_READ
 1

	)

45 
	#TA_SOCKET_READ_RESIDUAL
 2

	)

46 
	#TA_SOCKET_WRITE
 3

	)

47 
	#TA_SOCKET_WRITE_READY
 4

	)

48 
	#TA_SOCKET_WRITE_DEFERRED
 5

	)

49 
	#TA_TUN_READ
 6

	)

50 
	#TA_TUN_WRITE
 7

	)

51 
	#TA_INITIAL
 8

	)

52 
	#TA_TIMEOUT
 9

	)

53 
	#TA_TUN_WRITE_TIMEOUT
 10

	)

58 
	#MTCP_SOCKET
 ((*)1)

	)

59 
	#MTCP_TUN
 ((*)2)

	)

60 
	#MTCP_SIG
 ((*)3Ë

	)

61 #ifde‡
ENABLE_MANAGEMENT


62 
	#MTCP_MANAGEMENT
 ((*)4)

	)

65 
	#MTCP_N
 ((*)16Ë

	)

67 
	sè_iow_Êags


69 
	mÊags
;

70 
	mªt
;

71 
	mtun
;

72 
	msock
;

76 
	$¥a˘
 (
a˘i⁄
)

78 
a˘i⁄
)

80 
TA_UNDEF
:

82 
TA_SOCKET_READ
:

84 
TA_SOCKET_READ_RESIDUAL
:

86 
TA_SOCKET_WRITE
:

88 
TA_SOCKET_WRITE_READY
:

90 
TA_SOCKET_WRITE_DEFERRED
:

92 
TA_TUN_READ
:

94 
TA_TUN_WRITE
:

96 
TA_INITIAL
:

98 
TA_TIMEOUT
:

100 
TA_TUN_WRITE_TIMEOUT
:

105 
	}
}

107 
mu…i_ö°™˚
 *

108 
	$mu…i_¸óã_ö°™˚_t˝
 (
mu…i_c⁄ãxt
 *
m
)

110 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

111 
mu…i_ö°™˚
 *
mi
 = 
NULL
;

112 
hash
 *hash = 
m
->hash;

114 
mi
 = 
	`mu…i_¸óã_ö°™˚
 (
m
, 
NULL
);

115 i‡(
mi
)

117 
hash_ñemít
 *
he
;

118 c⁄° 
uöt32_t
 
hv
 = 
	`hash_vÆue
 (
hash
, &
mi
->
ªÆ
);

119 
hash_buckë
 *
buckë
 = 
	`hash_buckë
 (
hash
, 
hv
);

121 
he
 = 
	`hash_lookup_Á°
 (
hash
, 
buckë
, &
mi
->
ªÆ
, 
hv
);

123 i‡(
he
)

125 
mu…i_ö°™˚
 *
ﬁdmi
 = (mu…i_ö°™˚ *Ë
he
->
vÆue
;

126 
	`msg
 (
D_MULTI_LOW
, "MULTI TCP:Çew incoming clientáddress matchesÉxisting clientáddress --Çew clientÅakesÖrecedence");

127 
ﬁdmi
->
did_ªÆ_hash
 = 
Ál£
;

128 
	`mu…i_˛o£_ö°™˚
 (
m
, 
ﬁdmi
, 
Ál£
);

129 
he
->
key
 = &
mi
->
ªÆ
;

130 
he
->
vÆue
 = 
mi
;

133 
	`hash_add_Á°
 (
hash
, 
buckë
, &
mi
->
ªÆ
, 
hv
, mi);

135 
mi
->
did_ªÆ_hash
 = 
åue
;

138 #ifde‡
ENABLE_DEBUG


139 i‡(
mi
)

140 
	`dmsg
 (
D_MULTI_DEBUG
, "MULTI TCP: in°™˚ádded: %s", 
	`mrouã_addr_¥öt
 (&
mi
->
ªÆ
, &
gc
));

142 
	`dmsg
 (
D_MULTI_DEBUG
, "MULTI TCP:Çew client instance failed");

145 
	`gc_‰ì
 (&
gc
);

146 
	`ASSERT
 (!(
mi
 && mi->
hÆt
));

147  
mi
;

148 
	}
}

150 
boﬁ


151 
	$mu…i_t˝_ö°™˚_•ecific_öô
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
)

154 
mi
->
t˝_lök_out_de„ºed
 = 
	`mbuf_öô
 (
m
->
t›
.
›ti⁄s
.
n_bˇ°_buf
);

156 
	`ASSERT
 (
mi
->
c⁄ãxt
.
c2
.
lök_sockë
);

157 
	`ASSERT
 (
mi
->
c⁄ãxt
.
c2
.
lök_sockë
->
öfo
.
lß
);

158 
	`ASSERT
 (
mi
->
c⁄ãxt
.
c2
.
lök_sockë
->
mode
 =
LS_MODE_TCP_ACCEPT_FROM
);

159 
	`ASSERT
 (
mi
->
c⁄ãxt
.
c2
.
lök_sockë
->
öfo
.
lß
->
a˘uÆ
.
de°
.
addr
.
ß
.
ß_Ámûy
 =
AF_INET


160 || 
mi
->
c⁄ãxt
.
c2
.
lök_sockë
->
öfo
.
lß
->
a˘uÆ
.
de°
.
addr
.
ß
.
ß_Ámûy
 =
AF_INET6


162 i‡(!
	`mrouã_exåa˘_›ív≤_sockaddr
 (&
mi
->
ªÆ
, &mi->
c⁄ãxt
.
c2
.
lök_sockë
->
öfo
.
lß
->
a˘uÆ
.
de°
, 
åue
))

164 
	`msg
 (
D_MULTI_ERRORS
, "MULTI TCP: TCP clientáddress is undefined");

165  
Ál£
;

167  
åue
;

168 
	}
}

171 
	$mu…i_t˝_ö°™˚_•ecific_‰ì
 (
mu…i_ö°™˚
 *
mi
)

173 
	`mbuf_‰ì
 (
mi
->
t˝_lök_out_de„ºed
);

174 
	}
}

176 
mu…i_t˝
 *

177 
	$mu…i_t˝_öô
 (
maxevíts
, *
max˛õ¡s
)

179 
mu…i_t˝
 *
mt˝
;

180 c⁄° 
exåa_evíts
 = 
BASE_N_EVENTS
;

182 
	`ASSERT
 (
maxevíts
 >= 1);

183 
	`ASSERT
 (
max˛õ¡s
);

185 
	`ALLOC_OBJ_CLEAR
 (
mt˝
, 
mu…i_t˝
);

186 
mt˝
->
maxevíts
 = maxevít†+ 
exåa_evíts
;

187 
mt˝
->
es
 = 
	`evít_£t_öô
 (&mt˝->
maxevíts
, 0);

188 
	`waô_sig«l
 (
mt˝
->
es
, 
MTCP_SIG
);

189 
	`ALLOC_ARRAY
 (
mt˝
->
e§
, 
evít_£t_ªtu∫
, mt˝->
maxevíts
);

190 *
max˛õ¡s
 = 
	`max_öt
 (
	`mö_öt
 (
mt˝
->
maxevíts
 - 
exåa_evíts
, *maxclients), 1);

191 
	`msg
 (
D_MULTI_LOW
, "MULTI: TCP INIT max˛õ¡s=%d maxevíts=%d", *
max˛õ¡s
, 
mt˝
->
maxevíts
);

192  
mt˝
;

193 
	}
}

196 
	$mu…i_t˝_dñëe_evít
 (
mu…i_t˝
 *
mt˝
, 
evít_t
 
evít
)

198 i‡(
mt˝
 && mt˝->
es
)

199 
	`evít_dñ
 (
mt˝
->
es
, 
evít
);

200 
	}
}

203 
	$mu…i_t˝_‰ì
 (
mu…i_t˝
 *
mt˝
)

205 i‡(
mt˝
)

207 
	`evít_‰ì
 (
mt˝
->
es
);

208 i‡(
mt˝
->
e§
)

209 
	`‰ì
 (
mt˝
->
e§
);

210 
	`‰ì
 (
mt˝
);

212 
	}
}

215 
	$mu…i_t˝_dîe„ªn˚_ö°™˚
 (
mu…i_t˝
 *
mt˝
, 
mu…i_ö°™˚
 *
mi
)

217 
lök_sockë
 *
ls
 = 
mi
->
c⁄ãxt
.
c2
.link_socket;

218 i‡(
ls
 && 
mi
->
sockë_£t_ˇŒed
)

219 
	`evít_dñ
 (
mt˝
->
es
, 
	`sockë_evít_h™dÀ
 (
ls
));

220 
mt˝
->
n_e§
 = 0;

221 
	}
}

223 
ölöe
 

224 
	$mu…i_t˝_£t_globÆ_rw_Êags
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
)

226 i‡(
mi
)

228 
mi
->
sockë_£t_ˇŒed
 = 
åue
;

229 
	`sockë_£t
 (
mi
->
c⁄ãxt
.
c2
.
lök_sockë
,

230 
m
->
mt˝
->
es
,

231 
	`mbuf_deföed
 (
mi
->
t˝_lök_out_de„ºed
Ë? 
EVENT_WRITE
 : 
EVENT_READ
,

232 
mi
,

233 &
mi
->
t˝_rwÊags
);

235 
	}
}

237 
ölöe
 

238 
	$mu…i_t˝_waô
 (c⁄° 
c⁄ãxt
 *
c
,

239 
mu…i_t˝
 *
mt˝
)

241 
°©us
;

242 
	`sockë_£t_li°í_≥rsi°ít
 (
c
->
c2
.
lök_sockë
, 
mt˝
->
es
, 
MTCP_SOCKET
);

243 
	`tun_£t
 (
c
->
c1
.
tu¡≠
, 
mt˝
->
es
, 
EVENT_READ
, 
MTCP_TUN
, &mt˝->
tun_rwÊags
);

244 #ifde‡
ENABLE_MANAGEMENT


245 i‡(
m™agemít
)

246 
	`m™agemít_sockë_£t
 (
m™agemít
, 
mt˝
->
es
, 
MTCP_MANAGEMENT
, &mt˝->
m™agemít_≥rsi°_Êags
);

248 
°©us
 = 
	`evít_waô
 (
mt˝
->
es
, &
c
->
c2
.
timevÆ
, mt˝->
e§
, mt˝->
maxevíts
);

249 
	`upd©e_time
 ();

250 
mt˝
->
n_e§
 = 0;

251 i‡(
°©us
 > 0)

252 
mt˝
->
n_e§
 = 
°©us
;

253  
°©us
;

254 
	}
}

256 
ölöe
 
c⁄ãxt
 *

257 
	$mu…i_t˝_c⁄ãxt
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
)

259 i‡(
mi
)

260  &
mi
->
c⁄ãxt
;

262  &
m
->
t›
;

263 
	}
}

265 
boﬁ


266 
	$mu…i_t˝_¥o˚ss_outgoög_lök_ªady
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
, c⁄° 
mµ_Êags
)

268 
mbuf_ôem
 
ôem
;

269 
boﬁ
 
ªt
 = 
åue
;

270 
	`ASSERT
 (
mi
);

273 i‡(
	`mbuf_exåa˘_ôem
 (
mi
->
t˝_lök_out_de„ºed
, &
ôem
))

275 
	`dmsg
 (
D_MULTI_TCP
, "MULTI TCP:ÅransmittingÖreviously deferredÖacket");

277 
	`ASSERT
 (
mi
 =
ôem
.
ö°™˚
);

278 
mi
->
c⁄ãxt
.
c2
.
to_lök
 = 
ôem
.
buf„r
->
buf
;

279 
ªt
 = 
	`mu…i_¥o˚ss_outgoög_lök_dow‹k
 (
m
, 
mi
, 
mµ_Êags
);

280 i‡(!
ªt
)

281 
mi
 = 
NULL
;

282 
	`mbuf_‰ì_buf
 (
ôem
.
buf„r
);

284  
ªt
;

285 
	}
}

287 
boﬁ


288 
	$mu…i_t˝_¥o˚ss_outgoög_lök
 (
mu…i_c⁄ãxt
 *
m
, 
boﬁ
 
de„r
, c⁄° 
mµ_Êags
)

290 
mu…i_ö°™˚
 *
mi
 = 
	`mu…i_¥o˚ss_outgoög_lök_¥e
 (
m
);

291 
boﬁ
 
ªt
 = 
åue
;

293 i‡(
mi
)

295 i‡(
de„r
 || 
	`mbuf_deföed
 (
mi
->
t˝_lök_out_de„ºed
))

298 
buf„r
 *
buf
 = &
mi
->
c⁄ãxt
.
c2
.
to_lök
;

299 i‡(
	`BLEN
 (
buf
) > 0)

301 
mbuf_buf„r
 *
mb
 = 
	`mbuf_Æloc_buf
 (
buf
);

302 
mbuf_ôem
 
ôem
;

304 
	`£t_¥efix
 (
mi
);

305 
	`dmsg
 (
D_MULTI_TCP
, "MULTI TCP: queuing deferredÖacket");

306 
ôem
.
buf„r
 = 
mb
;

307 
ôem
.
ö°™˚
 = 
mi
;

308 
	`mbuf_add_ôem
 (
mi
->
t˝_lök_out_de„ºed
, &
ôem
);

309 
	`mbuf_‰ì_buf
 (
mb
);

310 
	`buf_ª£t
 (
buf
);

311 
ªt
 = 
	`mu…i_¥o˚ss_po°
 (
m
, 
mi
, 
mµ_Êags
);

312 i‡(!
ªt
)

313 
mi
 = 
NULL
;

314 
	`˛ór_¥efix
 ();

319 
ªt
 = 
	`mu…i_¥o˚ss_outgoög_lök_dow‹k
 (
m
, 
mi
, 
mµ_Êags
);

320 i‡(!
ªt
)

321 
mi
 = 
NULL
;

324  
ªt
;

325 
	}
}

328 
	$mu…i_t˝_waô_lôe
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
, c⁄° 
a˘i⁄
, 
boﬁ
 *
tun_öput_≥ndög
)

330 
c⁄ãxt
 *
c
 = 
	`mu…i_t˝_c⁄ãxt
 (
m
, 
mi
);

331 
lookög_f‹
 = 0;

333 
	`dmsg
 (
D_MULTI_DEBUG
, "MULTI TCP: mu…i_t˝_waô_lôêa=%†mi=" 
±r_f‹m©
,

334 
	`¥a˘
(
a˘i⁄
),

335 (
±r_ty≥
)
mi
);

337 
	`tv_˛ór
 (&
c
->
c2
.
timevÆ
);

339 
a˘i⁄
)

341 
TA_TUN_READ
:

342 
lookög_f‹
 = 
TUN_READ
;

343 
tun_öput_≥ndög
 = 
NULL
;

344 
	`io_waô
 (
c
, 
IOW_READ_TUN
);

346 
TA_SOCKET_READ
:

347 
lookög_f‹
 = 
SOCKET_READ
;

348 
tun_öput_≥ndög
 = 
NULL
;

349 
	`io_waô
 (
c
, 
IOW_READ_LINK
);

351 
TA_TUN_WRITE
:

352 
lookög_f‹
 = 
TUN_WRITE
;

353 
tun_öput_≥ndög
 = 
NULL
;

354 
c
->
c2
.
timevÆ
.
tv_£c
 = 1;

355 
	`≥rf_push
 (
PERF_PROC_OUT_TUN_MTCP
);

356 
	`io_waô
 (
c
, 
IOW_TO_TUN
);

357 
	`≥rf_p›
 ();

359 
TA_SOCKET_WRITE
:

360 
lookög_f‹
 = 
SOCKET_WRITE
;

361 
	`io_waô
 (
c
, 
IOW_TO_LINK
|
IOW_READ_TUN_FORCE
);

364 
	`msg
 (
M_FATAL
, "MULTI TCP: mu…i_t˝_waô_lôe, unh™dÀdá˘i⁄=%d", 
a˘i⁄
);

367 i‡(
tun_öput_≥ndög
 && (
c
->
c2
.
evít_£t_°©us
 & 
TUN_READ
))

368 *
tun_öput_≥ndög
 = 
åue
;

370 i‡(
c
->
c2
.
evít_£t_°©us
 & 
lookög_f‹
)

372  
a˘i⁄
;

376 
a˘i⁄
)

379 
TA_SOCKET_WRITE
:

380  
TA_SOCKET_WRITE_DEFERRED
;

383 
TA_TUN_WRITE
:

384  
TA_TUN_WRITE_TIMEOUT
;

387  
TA_UNDEF
;

389 
	}
}

391 
mu…i_ö°™˚
 *

392 
	$mu…i_t˝_di•©ch
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
, c⁄° 
a˘i⁄
)

394 c⁄° 
mµ_Êags
 = 
MPP_PRE_SELECT
|
MPP_RECORD_TOUCH
;

395 
mu…i_ö°™˚
 *
touched
 = 
mi
;

396 
m
->
mµ_touched
 = &
touched
;

398 
	`dmsg
 (
D_MULTI_DEBUG
, "MULTI TCP: mu…i_t˝_di•©chá=%†mi=" 
±r_f‹m©
,

399 
	`¥a˘
(
a˘i⁄
),

400 (
±r_ty≥
)
mi
);

402 
a˘i⁄
)

404 
TA_TUN_READ
:

405 
	`ªad_öcomög_tun
 (&
m
->
t›
);

406 i‡(!
	`IS_SIG
 (&
m
->
t›
))

407 
	`mu…i_¥o˚ss_öcomög_tun
 (
m
, 
mµ_Êags
);

409 
TA_SOCKET_READ
:

410 
TA_SOCKET_READ_RESIDUAL
:

411 
	`ASSERT
 (
mi
);

412 
	`ASSERT
 (
mi
->
c⁄ãxt
.
c2
.
lök_sockë
);

413 
	`£t_¥efix
 (
mi
);

414 
	`ªad_öcomög_lök
 (&
mi
->
c⁄ãxt
);

415 
	`˛ór_¥efix
 ();

416 i‡(!
	`IS_SIG
 (&
mi
->
c⁄ãxt
))

418 
	`mu…i_¥o˚ss_öcomög_lök
 (
m
, 
mi
, 
mµ_Êags
);

419 i‡(!
	`IS_SIG
 (&
mi
->
c⁄ãxt
))

420 
	`°ªam_buf_ªad_£tup
 (
mi
->
c⁄ãxt
.
c2
.
lök_sockë
);

423 
TA_TIMEOUT
:

424 
	`mu…i_¥o˚ss_timeout
 (
m
, 
mµ_Êags
);

426 
TA_TUN_WRITE
:

427 
	`mu…i_¥o˚ss_outgoög_tun
 (
m
, 
mµ_Êags
);

429 
TA_TUN_WRITE_TIMEOUT
:

430 
	`mu…i_¥o˚ss_dr›_outgoög_tun
 (
m
, 
mµ_Êags
);

432 
TA_SOCKET_WRITE_READY
:

433 
	`ASSERT
 (
mi
);

434 
	`mu…i_t˝_¥o˚ss_outgoög_lök_ªady
 (
m
, 
mi
, 
mµ_Êags
);

436 
TA_SOCKET_WRITE
:

437 
	`mu…i_t˝_¥o˚ss_outgoög_lök
 (
m
, 
Ál£
, 
mµ_Êags
);

439 
TA_SOCKET_WRITE_DEFERRED
:

440 
	`mu…i_t˝_¥o˚ss_outgoög_lök
 (
m
, 
åue
, 
mµ_Êags
);

442 
TA_INITIAL
:

443 
	`ASSERT
 (
mi
);

444 
	`mu…i_t˝_£t_globÆ_rw_Êags
 (
m
, 
mi
);

445 
	`mu…i_¥o˚ss_po°
 (
m
, 
mi
, 
mµ_Êags
);

448 
	`msg
 (
M_FATAL
, "MULTI TCP: mu…i_t˝_di•©ch, unh™dÀdá˘i⁄=%d", 
a˘i⁄
);

451 
m
->
mµ_touched
 = 
NULL
;

452  
touched
;

453 
	}
}

456 
	$mu…i_t˝_po°
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
, c⁄° 
a˘i⁄
)

458 
c⁄ãxt
 *
c
 = 
	`mu…i_t˝_c⁄ãxt
 (
m
, 
mi
);

459 
√wa˘i⁄
 = 
TA_UNDEF
;

461 
	#MTP_NONE
 0

	)

462 
	#MTP_TUN_OUT
 (1<<0)

	)

463 
	#MTP_LINK_OUT
 (1<<1)

	)

464 
Êags
 = 
MTP_NONE
;

466 i‡(
	`TUN_OUT
(
c
))

467 
Êags
 |
MTP_TUN_OUT
;

468 i‡(
	`LINK_OUT
(
c
))

469 
Êags
 |
MTP_LINK_OUT
;

471 
Êags
)

473 
MTP_TUN_OUT
|
MTP_LINK_OUT
:

474 
MTP_TUN_OUT
:

475 
√wa˘i⁄
 = 
TA_TUN_WRITE
;

477 
MTP_LINK_OUT
:

478 
√wa˘i⁄
 = 
TA_SOCKET_WRITE
;

480 
MTP_NONE
:

481 i‡(
mi
 && 
	`sockë_ªad_ªsiduÆ
 (
c
->
c2
.
lök_sockë
))

482 
√wa˘i⁄
 = 
TA_SOCKET_READ_RESIDUAL
;

484 
	`mu…i_t˝_£t_globÆ_rw_Êags
 (
m
, 
mi
);

488 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

489 
	`msg
 (
M_FATAL
, "MULTI TCP: multi_tcp_post bad state, mi=%s flags=%d",

490 
	`mu…i_ö°™˚_°rög
 (
mi
, 
Ál£
, &
gc
),

491 
Êags
);

492 
	`gc_‰ì
 (&
gc
);

497 
	`dmsg
 (
D_MULTI_DEBUG
, "MULTI TCP: multi_tcp_post %s -> %s",

498 
	`¥a˘
(
a˘i⁄
),

499 
	`¥a˘
(
√wa˘i⁄
));

501  
√wa˘i⁄
;

502 
	}
}

505 
	$mu…i_t˝_a˘i⁄
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
, 
a˘i⁄
, 
boﬁ
 
pﬁl
)

507 
boﬁ
 
tun_öput_≥ndög
 = 
Ál£
;

510 
	`dmsg
 (
D_MULTI_DEBUG
, "MULTI TCP: multi_tcp_actioná=%sÖ=%d",

511 
	`¥a˘
(
a˘i⁄
),

512 
pﬁl
);

525 i‡(
pﬁl
 && 
a˘i⁄
 !
TA_SOCKET_READ_RESIDUAL
)

527 c⁄° 
‹ig_a˘i⁄
 = 
a˘i⁄
;

528 
a˘i⁄
 = 
	`mu…i_t˝_waô_lôe
 (
m
, 
mi
,á˘i⁄, &
tun_öput_≥ndög
);

529 i‡(
a˘i⁄
 =
TA_UNDEF
)

530 
	`msg
 (
M_FATAL
, "MULTI TCP: I/O waôÑequúed blockög i¿mu…i_t˝_a˘i⁄,á˘i⁄=%d", 
‹ig_a˘i⁄
);

537 
mu…i_ö°™˚
 *
touched
 = 
	`mu…i_t˝_di•©ch
 (
m
, 
mi
, 
a˘i⁄
);

543 i‡(
touched
 && 
	`IS_SIG
 (&touched->
c⁄ãxt
))

545 i‡(
mi
 =
touched
)

546 
mi
 = 
NULL
;

547 
	`mu…i_˛o£_ö°™˚_⁄_sig«l
 (
m
, 
touched
);

556 i‡(
m
->
≥ndög
)

557 
mi
 = 
m
->
≥ndög
;

564 
a˘i⁄
 = 
	`mu…i_t˝_po°
 (
m
, 
mi
,áction);

571 i‡(
tun_öput_≥ndög
 && 
a˘i⁄
 =
TA_UNDEF
)

573 
a˘i⁄
 = 
TA_TUN_READ
;

574 
mi
 = 
NULL
;

575 
tun_öput_≥ndög
 = 
Ál£
;

576 
pﬁl
 = 
Ál£
;

579 
pﬁl
 = 
åue
;

581 } 
a˘i⁄
 !
TA_UNDEF
);

582 
	}
}

585 
	$mu…i_t˝_¥o˚ss_io
 (
mu…i_c⁄ãxt
 *
m
)

587 
mu…i_t˝
 *
mt˝
 = 
m
->mtcp;

588 
i
;

590 
i
 = 0; i < 
mt˝
->
n_e§
; ++i)

592 
evít_£t_ªtu∫
 *
e
 = &
mt˝
->
e§
[
i
];

595 i‡(
e
->
¨g
 >
MTCP_N
)

597 
mu…i_ö°™˚
 *
mi
 = (mu…i_ö°™˚ *Ë
e
->
¨g
;

598 i‡(
mi
)

600 i‡(
e
->
rwÊags
 & 
EVENT_WRITE
)

601 
	`mu…i_t˝_a˘i⁄
 (
m
, 
mi
, 
TA_SOCKET_WRITE_READY
, 
Ál£
);

602 i‡(
e
->
rwÊags
 & 
EVENT_READ
)

603 
	`mu…i_t˝_a˘i⁄
 (
m
, 
mi
, 
TA_SOCKET_READ
, 
Ál£
);

608 #ifde‡
ENABLE_MANAGEMENT


609 i‡(
e
->
¨g
 =
MTCP_MANAGEMENT
)

611 
	`ASSERT
 (
m™agemít
);

612 
	`m™agemít_io
 (
m™agemít
);

617 i‡(
e
->
¨g
 =
MTCP_TUN
)

619 i‡(
e
->
rwÊags
 & 
EVENT_WRITE
)

620 
	`mu…i_t˝_a˘i⁄
 (
m
, 
NULL
, 
TA_TUN_WRITE
, 
Ál£
);

621 i‡(
e
->
rwÊags
 & 
EVENT_READ
)

622 
	`mu…i_t˝_a˘i⁄
 (
m
, 
NULL
, 
TA_TUN_READ
, 
Ál£
);

625 i‡(
e
->
¨g
 =
MTCP_SOCKET
)

627 
mu…i_ö°™˚
 *
mi
;

628 
	`ASSERT
 (
m
->
t›
.
c2
.
lök_sockë
);

629 
	`sockë_ª£t_li°í_≥rsi°ít
 (
m
->
t›
.
c2
.
lök_sockë
);

630 
mi
 = 
	`mu…i_¸óã_ö°™˚_t˝
 (
m
);

631 i‡(
mi
)

632 
	`mu…i_t˝_a˘i⁄
 (
m
, 
mi
, 
TA_INITIAL
, 
Ál£
);

635 i‡(
e
->
¨g
 =
MTCP_SIG
)

637 
	`gë_sig«l
 (&
m
->
t›
.
sig
->
sig«l_ª˚ived
);

640 i‡(
	`IS_SIG
 (&
m
->
t›
))

643 
mt˝
->
n_e§
 = 0;

649 
mu…i_ö°™˚
 *
mi
;

650 !
	`IS_SIG
 (&
m
->
t›
Ë&& (
mi
 = 
	`mbuf_≥ek
 (m->
mbuf
)Ë!
NULL
)

652 
	`mu…i_t˝_a˘i⁄
 (
m
, 
mi
, 
TA_SOCKET_WRITE
, 
åue
);

655 
	}
}

662 
	$tu¬ñ_£rvî_t˝
 (
c⁄ãxt
 *
t›
)

664 
mu…i_c⁄ãxt
 
mu…i
;

665 
°©us
;

667 
t›
->
mode
 = 
CM_TOP
;

668 
	`c⁄ãxt_˛ór_2
 (
t›
);

671 
	`öô_ö°™˚_h™dÀ_sig«ls
 (
t›
,Å›->
es
, 
CC_HARD_USR1_TO_HUP
);

672 i‡(
	`IS_SIG
 (
t›
))

676 
	`mu…i_öô
 (&
mu…i
, 
t›
, 
åue
, 
MC_SINGLE_THREADED
);

679 
	`mu…i_t›_öô
 (&
mu…i
, 
t›
, 
åue
);

682 
	`öô_m™agemít_ˇŒback_mu…i
 (&
mu…i
);

685 
	`öôüliz©i⁄_£quí˚_com∂ëed
 (
t›
, 
ISC_SERVER
);

688 
åue
)

690 
	`≥rf_push
 (
PERF_EVENT_LOOP
);

693 
	`mu…i_gë_timeout
 (&
mu…i
, &mu…i.
t›
.
c2
.
timevÆ
);

694 
°©us
 = 
	`mu…i_t˝_waô
 (&
mu…i
.
t›
, mu…i.
mt˝
);

695 
	`MULTI_CHECK_SIG
 (&
mu…i
);

698 
	`mu…i_¥o˚ss_≥r_£c⁄d_timîs
 (&
mu…i
);

701 i‡(
°©us
 > 0)

704 
	`mu…i_t˝_¥o˚ss_io
 (&
mu…i
);

705 
	`MULTI_CHECK_SIG
 (&
mu…i
);

707 i‡(
°©us
 == 0)

709 
	`mu…i_t˝_a˘i⁄
 (&
mu…i
, 
NULL
, 
TA_TIMEOUT
, 
Ál£
);

712 
	`≥rf_p›
 ();

716 
	`unöô_m™agemít_ˇŒback_mu…i
 (&
mu…i
);

719 
	`mu…i_ifc⁄fig_poﬁ_≥rsi°
 (&
mu…i
, 
åue
);

722 
	`mu…i_unöô
 (&
mu…i
);

723 
	`mu…i_t›_‰ì
 (&
mu…i
);

724 
	`˛o£_ö°™˚
 (
t›
);

725 
	}
}

	@src/openvpn/mtcp.h

29 #i‚de‡
MTCP_H


30 
	#MTCP_H


	)

32 #i‡
P2MP_SERVER


34 
	~"evít.h
"

39 
	smu…i_t˝


41 
evít_£t
 *
	mes
;

42 
evít_£t_ªtu∫
 *
	me§
;

43 
	mn_e§
;

44 
	mmaxevíts
;

45 
	mtun_rwÊags
;

46 #ifde‡
ENABLE_MANAGEMENT


47 
	mm™agemít_≥rsi°_Êags
;

51 
	gmu…i_ö°™˚
;

52 
	gc⁄ãxt
;

54 
mu…i_t˝
 *
mu…i_t˝_öô
 (
maxevíts
, *
max˛õ¡s
);

55 
mu…i_t˝_‰ì
 (
mu…i_t˝
 *
mt˝
);

56 
mu…i_t˝_dîe„ªn˚_ö°™˚
 (
mu…i_t˝
 *
mt˝
, 
mu…i_ö°™˚
 *
mi
);

58 
boﬁ
 
mu…i_t˝_ö°™˚_•ecific_öô
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
);

59 
mu…i_t˝_ö°™˚_•ecific_‰ì
 (
mu…i_ö°™˚
 *
mi
);

61 
mu…i_t˝_lök_out_de„ºed
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
);

71 
tu¬ñ_£rvî_t˝
 (
c⁄ãxt
 *
t›
);

74 
mu…i_t˝_dñëe_evít
 (
mu…i_t˝
 *
mt˝
, 
evít_t
 
evít
);

	@src/openvpn/mtu.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"comm⁄.h
"

34 
	~"buf„r.h
"

35 
	~"îr‹.h
"

36 
	~"öãgî.h
"

37 
	~"mtu.h
"

39 
	~"memdbg.h
"

43 
	$Æloc_buf_sock_tun
 (
buf„r
 *
buf
,

44 c⁄° 
‰ame
 *frame,

45 c⁄° 
boﬁ
 
tu¡≠_buf„r
,

46 c⁄° 
Æign_mask
)

49 *
buf
 = 
	`Æloc_buf
 (
	`BUF_SIZE
 (
‰ame
));

50 
	`ASSERT
 (
	`buf_öô
 (
buf
, 
	`FRAME_HEADROOM_ADJ
 (
‰ame
, 
Æign_mask
)));

51 
buf
->
Àn
 = 
tu¡≠_buf„r
 ? 
	`MAX_RW_SIZE_TUN
 (
‰ame
Ë: 
	`MAX_RW_SIZE_LINK
 (frame);

52 
	`ASSERT
 (
	`buf_ß„
 (
buf
, 0));

53 
	}
}

56 
	$‰ame_föÆize
 (
‰ame
 *frame,

57 
boﬁ
 
lök_mtu_deföed
,

58 
lök_mtu
,

59 
boﬁ
 
tun_mtu_deföed
,

60 
tun_mtu
)

63 i‡(
tun_mtu_deföed
)

65 
	`ASSERT
 (!
lök_mtu_deföed
);

66 
‰ame
->
lök_mtu
 = 
tun_mtu
 + 
	`TUN_LINK_DELTA
 (frame);

70 
	`ASSERT
 (
lök_mtu_deföed
);

71 
‰ame
->
lök_mtu
 =Üink_mtu;

74 i‡(
	`TUN_MTU_SIZE
 (
‰ame
Ë< 
TUN_MTU_MIN
)

76 
	`msg
 (
M_WARN
, "TUN MTU vÆuê(%dËmu° bê©Üó° %d", 
	`TUN_MTU_SIZE
 (
‰ame
), 
TUN_MTU_MIN
);

77 
	`‰ame_¥öt
 (
‰ame
, 
M_FATAL
, "MTU isÅoo small");

80 
‰ame
->
lök_mtu_dy«mic
 = føme->
lök_mtu
;

82 
‰ame
->
exåa_buf„r
 +
PAYLOAD_ALIGN
;

83 
	}
}

89 
	$‰ame_£t_mtu_dy«mic
 (
‰ame
 *‰ame, 
mtu
, 
Êags
)

92 #ifde‡
ENABLE_DEBUG


93 c⁄° 
‹ig_mtu
 = 
mtu
;

94 c⁄° 
‹ig_lök_mtu_dy«mic
 = 
‰ame
->
lök_mtu_dy«mic
;

97 
	`ASSERT
 (
mtu
 >= 0);

99 i‡(
Êags
 & 
SET_MTU_TUN
)

100 
mtu
 +
	`TUN_LINK_DELTA
 (
‰ame
);

102 i‡(!(
Êags
 & 
SET_MTU_UPPER_BOUND
Ë|| 
mtu
 < 
‰ame
->
lök_mtu_dy«mic
)

104 
‰ame
->
lök_mtu_dy«mic
 = 
	`c⁄°øö_öt
 (

105 
mtu
,

106 
	`EXPANDED_SIZE_MIN
 (
‰ame
),

107 
	`EXPANDED_SIZE
 (
‰ame
));

110 
	`dmsg
 (
D_MTU_DEBUG
, "MTU DYNAMIC mtu=%d, flags=%u, %d -> %d",

111 
‹ig_mtu
,

112 
Êags
,

113 
‹ig_lök_mtu_dy«mic
,

114 
‰ame
->
lök_mtu_dy«mic
);

115 
	}
}

123 
	$‰ame_subåa˘_exåa
 (
‰ame
 *‰ame, c⁄° ‰amê*
§c
)

125 
‰ame
->
exåa_‰ame
 -
§c
->extra_frame;

126 
‰ame
->
exåa_tun
 +
§c
->
exåa_‰ame
;

127 
	}
}

130 
	$‰ame_¥öt
 (c⁄° 
‰ame
 *frame,

131 
Àvñ
,

132 c⁄° *
¥efix
)

134 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

135 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, &
gc
);

136 i‡(
¥efix
)

137 
	`buf_¥ötf
 (&
out
, "%†", 
¥efix
);

138 
	`buf_¥ötf
 (&
out
, "[");

139 
	`buf_¥ötf
 (&
out
, " L:%d", 
‰ame
->
lök_mtu
);

140 
	`buf_¥ötf
 (&
out
, " D:%d", 
‰ame
->
lök_mtu_dy«mic
);

141 
	`buf_¥ötf
 (&
out
, " EF:%d", 
‰ame
->
exåa_‰ame
);

142 
	`buf_¥ötf
 (&
out
, " EB:%d", 
‰ame
->
exåa_buf„r
);

143 
	`buf_¥ötf
 (&
out
, " ET:%d", 
‰ame
->
exåa_tun
);

144 
	`buf_¥ötf
 (&
out
, " EL:%d", 
‰ame
->
exåa_lök
);

145 i‡(
‰ame
->
Æign_Êags
 && føme->
Æign_adju°
)

146 
	`buf_¥ötf
 (&
out
, " AF:%u/%d", 
‰ame
->
Æign_Êags
, føme->
Æign_adju°
);

147 
	`buf_¥ötf
 (&
out
, " ]");

149 
	`msg
 (
Àvñ
, "%s", 
out
.
d©a
);

150 
	`gc_‰ì
 (&
gc
);

151 
	}
}

153 
	#MTUDISC_NOT_SUPPORTED_MSG
 "--mtu-dis¯i†nŸ suµ‹ãd o¿thi†OS"

	)

156 
	$£t_mtu_discovî_ty≥
 (
sd
, 
mtu_ty≥
)

158 i‡(
mtu_ty≥
 >= 0)

160 #i‡
	`deföed
(
HAVE_SETSOCKOPT
Ë&& deföed(
SOL_IP
Ë&& deföed(
IP_MTU_DISCOVER
)

161 i‡(
£tsock›t


162 (
sd
, 
SOL_IP
, 
IP_MTU_DISCOVER
, &
mtu_ty≥
,  (mtu_type)))

163 
	`msg
 (
M_ERR
, "Error setting IP_MTU_DISCOVERÅype=%d on TCP/UDP socket",

164 
mtu_ty≥
);

166 
	`msg
 (
M_FATAL
, 
MTUDISC_NOT_SUPPORTED_MSG
);

169 
	}
}

172 
	$å™¶©e_mtu_discovî_ty≥_«me
 (c⁄° *
«me
)

174 #i‡
	`deföed
(
IP_PMTUDISC_DONT
Ë&& deföed(
IP_PMTUDISC_WANT
Ë&& deföed(
IP_PMTUDISC_DO
)

175 i‡(!
	`°rcmp
 (
«me
, "yes"))

176  
IP_PMTUDISC_DO
;

177 i‡(!
	`°rcmp
 (
«me
, "maybe"))

178  
IP_PMTUDISC_WANT
;

179 i‡(!
	`°rcmp
 (
«me
, "no"))

180  
IP_PMTUDISC_DONT
;

181 
	`msg
 (
M_FATAL
,

183 
«me
);

185 
	`msg
 (
M_FATAL
, 
MTUDISC_NOT_SUPPORTED_MSG
);

188 
	}
}

190 #i‡
EXTENDED_SOCKET_ERROR_CAPABILITY


192 
	s¥obehdr


194 
uöt32_t
 
	mâl
;

195 
timevÆ
 
	mtv
;

199 
	$f‹m©_exãnded_sockë_îr‹
 (
fd
, *
mtu
, 
gc_¨ía
 *
gc
)

201 
ªs
;

202 
¥obehdr
 
rcvbuf
;

203 
iovec
 
iov
;

204 
msghdr
 
msg
;

205 
cmsghdr
 *
cmsg
;

206 
sock_exãnded_îr
 *
e
;

207 
sockaddr_ö
 
addr
;

208 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

209 *
cbuf
 = (*Ë
	`gc_mÆloc
 (256, 
Ál£
, 
gc
);

211 *
mtu
 = 0;

213 
åue
)

215 
	`mem£t
 (&
rcvbuf
, -1,  (rcvbuf));

216 
iov
.
iov_ba£
 = &
rcvbuf
;

217 
iov
.
iov_Àn
 =  (
rcvbuf
);

218 
msg
.
msg_«me
 = (
uöt8_t
 *Ë&
addr
;

219 
msg
.
msg_«mñí
 =  (
addr
);

220 
msg
.
msg_iov
 = &
iov
;

221 
msg
.
msg_iovÀn
 = 1;

222 
msg
.
msg_Êags
 = 0;

223 
msg
.
msg_c⁄åﬁ
 = 
cbuf
;

224 
msg
.
msg_c⁄åﬁÀn
 = 256;

226 
ªs
 = 
	`ªcvmsg
 (
fd
, &
msg
, 
MSG_ERRQUEUE
);

227 i‡(
ªs
 < 0)

228 
exô
;

230 
e
 = 
NULL
;

232 
cmsg
 = 
	`CMSG_FIRSTHDR
 (&
msg
); cmsg; cmsg = 
	`CMSG_NXTHDR
 (&msg, cmsg))

234 i‡(
cmsg
->
cmsg_Àvñ
 =
SOL_IP
)

236 i‡(
cmsg
->
cmsg_ty≥
 =
IP_RECVERR
)

238 
e
 = (
sock_exãnded_îr
 *Ë
	`CMSG_DATA
 (
cmsg
);

242 
	`buf_¥ötf
 (&
out
 ,"CMSG=%d|", 
cmsg
->
cmsg_ty≥
);

246 i‡(
e
 =
NULL
)

248 
	`buf_¥ötf
 (&
out
, "NO-INFO|");

249 
exô
;

252 
e
->
ì_î∫o
)

254 
ETIMEDOUT
:

255 
	`buf_¥ötf
 (&
out
, "ETIMEDOUT|");

257 
EMSGSIZE
:

258 
	`buf_¥ötf
 (&
out
, "EMSGSIZE P©h-MTU=%d|", 
e
->
ì_öfo
);

259 *
mtu
 = 
e
->
ì_öfo
;

261 
ECONNREFUSED
:

262 
	`buf_¥ötf
 (&
out
, "ECONNREFUSED|");

264 
EPROTO
:

265 
	`buf_¥ötf
 (&
out
, "EPROTO|");

267 
EHOSTUNREACH
:

268 
	`buf_¥ötf
 (&
out
, "EHOSTUNREACH|");

270 
ENETUNREACH
:

271 
	`buf_¥ötf
 (&
out
, "ENETUNREACH|");

273 
EACCES
:

274 
	`buf_¥ötf
 (&
out
, "EACCES|");

277 
	`buf_¥ötf
 (&
out
, "UNKNOWN|");

282 
exô
:

283 
	`buf_rmèû
 (&
out
, '|');

284  
	`BSTR
 (&
out
);

285 
	}
}

288 
	$£t_sock_exãnded_îr‹_∑ssög
 (
sd
)

290 
⁄
 = 1;

291 i‡(
	`£tsock›t
 (
sd
, 
SOL_IP
, 
IP_RECVERR
, &
⁄
,  (on)))

292 
	`msg
 (
M_WARN
 | 
M_ERRNO
,

294 
	}
}

	@src/openvpn/mtu.h

25 #i‚de‡
MTU_H


26 
	#MTU_H


	)

28 
	~"buf„r.h
"

55 
	#ETHERNET_MTU
 1500

	)

61 
	#TUN_MTU_MIN
 100

	)

66 
	#LINK_MTU_DEFAULT
 1500

	)

71 
	#TUN_MTU_DEFAULT
 1500

	)

76 
	#TAP_MTU_EXTRA_DEFAULT
 32

	)

81 
	#MSSFIX_DEFAULT
 1450

	)

87 
	#PAYLOAD_ALIGN
 4

	)

94 
	s‰ame
 {

95 
	mlök_mtu
;

98 
	mlök_mtu_dy«mic
;

101 
	mexåa_‰ame
;

108 
	mexåa_buf„r
;

118 
	mexåa_tun
;

123 
	mexåa_lök
;

130 
	#FRAME_HEADROOM_MARKER_DECRYPT
 (1<<0)

	)

131 
	#FRAME_HEADROOM_MARKER_FRAGMENT
 (1<<1)

	)

132 
	#FRAME_HEADROOM_MARKER_READ_LINK
 (1<<2)

	)

133 
	#FRAME_HEADROOM_MARKER_READ_STREAM
 (1<<3)

	)

134 
	mÆign_Êags
;

135 
	mÆign_adju°
;

143 
	#EXTRA_FRAME
(
f
Ë((f)->
exåa_‰ame
)

	)

149 
	#TUN_LINK_DELTA
(
f
Ë((f)->
exåa_‰ame
 + (f)->
exåa_tun
)

	)

154 
	#TUN_MTU_SIZE
(
f
Ë((f)->
lök_mtu
 - 
	`TUN_LINK_DELTA
(f))

	)

155 
	#TUN_MTU_SIZE_DYNAMIC
(
f
Ë((f)->
lök_mtu_dy«mic
 - 
	`TUN_LINK_DELTA
(f))

	)

163 
	#PAYLOAD_SIZE
(
f
Ë((f)->
lök_mtu
 - (f)->
exåa_‰ame
)

	)

164 
	#PAYLOAD_SIZE_DYNAMIC
(
f
Ë((f)->
lök_mtu_dy«mic
 - (f)->
exåa_‰ame
)

	)

170 
	#EXPANDED_SIZE
(
f
Ë((f)->
lök_mtu
)

	)

171 
	#EXPANDED_SIZE_DYNAMIC
(
f
Ë((f)->
lök_mtu_dy«mic
)

	)

172 
	#EXPANDED_SIZE_MIN
(
f
Ë(
TUN_MTU_MIN
 + 
	`TUN_LINK_DELTA
(f))

	)

178 
	#MAX_RW_SIZE_TUN
(
f
Ë(
	`PAYLOAD_SIZE
(f))

	)

179 
	#MAX_RW_SIZE_LINK
(
f
Ë(
	`EXPANDED_SIZE
(fË+ (f)->
exåa_lök
)

	)

184 
	#FRAME_HEADROOM_BASE
(
f
Ë(
	`TUN_LINK_DELTA
(fË+ (f)->
exåa_buf„r
 + (f)->
exåa_lök
)

	)

185 
	#FRAME_HEADROOM
(
f
Ë
	`‰ame_hódroom
(f, 0)

	)

186 
	#FRAME_HEADROOM_ADJ
(
f
, 
fm
Ë
	`‰ame_hódroom
(f, fm)

	)

192 
	#BUF_SIZE
(
f
Ë(
	`TUN_MTU_SIZE
(fË+ 
	`FRAME_HEADROOM_BASE
(fË* 2)

	)

198 
‰ame_föÆize
 (
‰ame
 *frame,

199 
boﬁ
 
lök_mtu_deföed
,

200 
lök_mtu
,

201 
boﬁ
 
tun_mtu_deföed
,

202 
tun_mtu
);

204 
‰ame_subåa˘_exåa
 (
‰ame
 *‰ame, c⁄° ‰amê*
§c
);

206 
‰ame_¥öt
 (c⁄° 
‰ame
 *frame,

207 
Àvñ
,

208 c⁄° *
¥efix
);

210 
£t_mtu_discovî_ty≥
 (
sd
, 
mtu_ty≥
);

211 
å™¶©e_mtu_discovî_ty≥_«me
 (c⁄° *
«me
);

217 
	#SET_MTU_TUN
 (1<<0Ë

	)

218 
	#SET_MTU_UPPER_BOUND
 (1<<1Ë

	)

220 
‰ame_£t_mtu_dy«mic
 (
‰ame
 *‰ame, 
mtu
, 
Êags
);

225 
Æloc_buf_sock_tun
 (
buf„r
 *
buf
,

226 c⁄° 
‰ame
 *frame,

227 c⁄° 
boﬁ
 
tu¡≠_buf„r
,

228 c⁄° 
Æign_mask
);

236 #i‡
EXTENDED_SOCKET_ERROR_CAPABILITY


238 
£t_sock_exãnded_îr‹_∑ssög
 (
sd
);

239 c⁄° *
f‹m©_exãnded_sockë_îr‹
 (
fd
, *
mtu
, 
gc_¨ía
 *
gc
);

247 
ölöe
 

248 
	$‰ame_hódroom
 (c⁄° 
‰ame
 *
f
, c⁄° 
Êag_mask
)

250 c⁄° 
off£t
 = 
	`FRAME_HEADROOM_BASE
 (
f
);

251 c⁄° 
adju°
 = (
Êag_mask
 & 
f
->
Æign_Êags
Ë? f->
Æign_adju°
 : 0;

252 c⁄° 
dñè
 = ((
PAYLOAD_ALIGN
 << 24Ë- (
off£t
 + 
adju°
)) & (PAYLOAD_ALIGN - 1);

253  
off£t
 + 
dñè
;

254 
	}
}

260 
ölöe
 

261 
	$‰ame_add_to_exåa_‰ame
 (
‰ame
 *‰ame, c⁄° 
ö¸emít
)

263 
‰ame
->
exåa_‰ame
 +
ö¸emít
;

264 
	}
}

266 
ölöe
 

267 
	$‰ame_add_to_exåa_tun
 (
‰ame
 *‰ame, c⁄° 
ö¸emít
)

269 
‰ame
->
exåa_tun
 +
ö¸emít
;

270 
	}
}

272 
ölöe
 

273 
	$‰ame_add_to_exåa_lök
 (
‰ame
 *‰ame, c⁄° 
ö¸emít
)

275 
‰ame
->
exåa_lök
 +
ö¸emít
;

276 
	}
}

278 
ölöe
 

279 
	$‰ame_add_to_exåa_buf„r
 (
‰ame
 *‰ame, c⁄° 
ö¸emít
)

281 
‰ame
->
exåa_buf„r
 +
ö¸emít
;

282 
	}
}

284 
ölöe
 

285 
	$‰ame_add_to_Æign_adju°
 (
‰ame
 *‰ame, c⁄° 
ö¸emít
)

287 
‰ame
->
Æign_adju°
 +
ö¸emít
;

288 
	}
}

290 
ölöe
 

291 
	$‰ame_Æign_to_exåa_‰ame
 (
‰ame
 *frame)

293 
‰ame
->
Æign_adju°
 = føme->
exåa_‰ame
 + føme->
exåa_lök
;

294 
	}
}

296 
ölöe
 

297 
	$‰ame_‹_Æign_Êags
 (
‰ame
 *‰ame, c⁄° 
Êag_mask
)

299 
‰ame
->
Æign_Êags
 |
Êag_mask
;

300 
	}
}

302 
ölöe
 
boﬁ


303 
	$‰ame_deföed
 (c⁄° 
‰ame
 *frame)

305  
‰ame
->
lök_mtu
 > 0;

306 
	}
}

	@src/openvpn/mudp.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #i‡
P2MP_SERVER


35 
	~"mu…i.h
"

36 
	~"f‹w¨d-ölöe.h
"

38 
	~"memdbg.h
"

46 
mu…i_ö°™˚
 *

47 
	$mu…i_gë_¸óã_ö°™˚_udp
 (
mu…i_c⁄ãxt
 *
m
)

49 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

50 
mrouã_addr
 
ªÆ
;

51 
mu…i_ö°™˚
 *
mi
 = 
NULL
;

52 
hash
 *hash = 
m
->hash;

54 i‡(
	`mrouã_exåa˘_›ív≤_sockaddr
 (&
ªÆ
, &
m
->
t›
.
c2
.
‰om
.
de°
, 
åue
))

56 
hash_ñemít
 *
he
;

57 c⁄° 
uöt32_t
 
hv
 = 
	`hash_vÆue
 (
hash
, &
ªÆ
);

58 
hash_buckë
 *
buckë
 = 
	`hash_buckë
 (
hash
, 
hv
);

60 
he
 = 
	`hash_lookup_Á°
 (
hash
, 
buckë
, &
ªÆ
, 
hv
);

62 i‡(
he
)

64 
mi
 = (
mu…i_ö°™˚
 *Ë
he
->
vÆue
;

68 i‡(!
m
->
t›
.
c2
.
és_auth_°™dÆ⁄e


69 || 
	`és_¥e_de¸y±_lôe
 (
m
->
t›
.
c2
.
és_auth_°™dÆ⁄e
, &m->t›.c2.
‰om
, &m->t›.c2.
buf
))

71 i‡(
	`‰equícy_limô_evít_Ælowed
 (
m
->
√w_c⁄√˘i⁄_limôî
))

73 
mi
 = 
	`mu…i_¸óã_ö°™˚
 (
m
, &
ªÆ
);

74 i‡(
mi
)

76 
	`hash_add_Á°
 (
hash
, 
buckë
, &
mi
->
ªÆ
, 
hv
, mi);

77 
mi
->
did_ªÆ_hash
 = 
åue
;

82 
	`msg
 (
D_MULTI_ERRORS
,

84 
	`mrouã_addr_¥öt
 (&
ªÆ
, &
gc
));

89 #ifde‡
ENABLE_DEBUG


90 i‡(
	`check_debug_Àvñ
 (
D_MULTI_DEBUG
))

92 c⁄° *
°©us
;

94 i‡(
he
 && 
mi
)

95 
°©us
 = "[succeeded]";

96 i‡(!
he
 && 
mi
)

97 
°©us
 = "[created]";

99 
°©us
 = "[failed]";

101 
	`dmsg
 (
D_MULTI_DEBUG
, "GET INST BY REAL: %s %s",

102 
	`mrouã_addr_¥öt
 (&
ªÆ
, &
gc
),

103 
°©us
);

108 
	`gc_‰ì
 (&
gc
);

109 
	`ASSERT
 (!(
mi
 && mi->
hÆt
));

110  
mi
;

111 
	}
}

116 
ölöe
 

117 
	$mu…i_¥o˚ss_outgoög_lök
 (
mu…i_c⁄ãxt
 *
m
, c⁄° 
mµ_Êags
)

119 
mu…i_ö°™˚
 *
mi
 = 
	`mu…i_¥o˚ss_outgoög_lök_¥e
 (
m
);

120 i‡(
mi
)

121 
	`mu…i_¥o˚ss_outgoög_lök_dow‹k
 (
m
, 
mi
, 
mµ_Êags
);

122 
	}
}

128 
	$mu…i_¥o˚ss_io_udp
 (
mu…i_c⁄ãxt
 *
m
)

130 c⁄° 
°©us
 = 
m
->
t›
.
c2
.
evít_£t_°©us
;

131 c⁄° 
mµ_Êags
 = 
m
->
t›
.
c2
.
Á°_io


132 ? (
MPP_CONDITIONAL_PRE_SELECT
 | 
MPP_CLOSE_ON_SIGNAL
)

133 : (
MPP_PRE_SELECT
 | 
MPP_CLOSE_ON_SIGNAL
);

135 #ifde‡
MULTI_DEBUG_EVENT_LOOP


136 
buf
[16];

137 
buf
[0] = 0;

138 i‡(
°©us
 & 
SOCKET_READ
)

139 
	`°rˇt
 (
buf
, "SR/");

140 i‡(
°©us
 & 
SOCKET_WRITE
)

141 
	`°rˇt
 (
buf
, "SW/");

142 i‡(
°©us
 & 
TUN_READ
)

143 
	`°rˇt
 (
buf
, "TR/");

144 i‡(
°©us
 & 
TUN_WRITE
)

145 
	`°rˇt
 (
buf
, "TW/");

146 
	`¥ötf
 ("IO %s\n", 
buf
);

149 #ifde‡
ENABLE_MANAGEMENT


150 i‡(
°©us
 & (
MANAGEMENT_READ
|
MANAGEMENT_WRITE
))

152 
	`ASSERT
 (
m™agemít
);

153 
	`m™agemít_io
 (
m™agemít
);

158 i‡(
°©us
 & 
SOCKET_WRITE
)

160 
	`mu…i_¥o˚ss_outgoög_lök
 (
m
, 
mµ_Êags
);

163 i‡(
°©us
 & 
TUN_WRITE
)

165 
	`mu…i_¥o˚ss_outgoög_tun
 (
m
, 
mµ_Êags
);

168 i‡(
°©us
 & 
SOCKET_READ
)

170 
	`ªad_öcomög_lök
 (&
m
->
t›
);

171 
	`mu…i_ªÀa£_io_lock
 (
m
);

172 i‡(!
	`IS_SIG
 (&
m
->
t›
))

173 
	`mu…i_¥o˚ss_öcomög_lök
 (
m
, 
NULL
, 
mµ_Êags
);

176 i‡(
°©us
 & 
TUN_READ
)

178 
	`ªad_öcomög_tun
 (&
m
->
t›
);

179 
	`mu…i_ªÀa£_io_lock
 (
m
);

180 i‡(!
	`IS_SIG
 (&
m
->
t›
))

181 
	`mu…i_¥o˚ss_öcomög_tun
 (
m
, 
mµ_Êags
);

183 
	}
}

189 
ölöe
 

190 
	$p2mp_iow_Êags
 (c⁄° 
mu…i_c⁄ãxt
 *
m
)

192 
Êags
 = 
IOW_WAIT_SIGNAL
;

193 i‡(
m
->
≥ndög
)

195 i‡(
	`TUN_OUT
 (&
m
->
≥ndög
->
c⁄ãxt
))

196 
Êags
 |
IOW_TO_TUN
;

197 i‡(
	`LINK_OUT
 (&
m
->
≥ndög
->
c⁄ãxt
))

198 
Êags
 |
IOW_TO_LINK
;

200 i‡(
	`mbuf_deföed
 (
m
->
mbuf
))

201 
Êags
 |
IOW_MBUF
;

203 
Êags
 |
IOW_READ
;

205  
Êags
;

206 
	}
}

221 
	$tu¬ñ_£rvî_udp_sögÀ_thªaded
 (
c⁄ãxt
 *
t›
)

223 
mu…i_c⁄ãxt
 
mu…i
;

225 
t›
->
mode
 = 
CM_TOP
;

226 
	`c⁄ãxt_˛ór_2
 (
t›
);

229 
	`öô_ö°™˚_h™dÀ_sig«ls
 (
t›
,Å›->
es
, 
CC_HARD_USR1_TO_HUP
);

230 i‡(
	`IS_SIG
 (
t›
))

234 
	`mu…i_öô
 (&
mu…i
, 
t›
, 
Ál£
, 
MC_SINGLE_THREADED
);

237 
	`mu…i_t›_öô
 (&
mu…i
, 
t›
, 
åue
);

240 
	`öô_m™agemít_ˇŒback_mu…i
 (&
mu…i
);

243 
	`öôüliz©i⁄_£quí˚_com∂ëed
 (
t›
, 
ISC_SERVER
);

246 
åue
)

248 
	`≥rf_push
 (
PERF_EVENT_LOOP
);

251 
	`mu…i_gë_timeout
 (&
mu…i
, &mu…i.
t›
.
c2
.
timevÆ
);

252 
	`io_waô
 (&
mu…i
.
t›
, 
	`p2mp_iow_Êags
 (&multi));

253 
	`MULTI_CHECK_SIG
 (&
mu…i
);

256 
	`mu…i_¥o˚ss_≥r_£c⁄d_timîs
 (&
mu…i
);

259 i‡(
mu…i
.
t›
.
c2
.
evít_£t_°©us
 =
ES_TIMEOUT
)

261 
	`mu…i_¥o˚ss_timeout
 (&
mu…i
, 
MPP_PRE_SELECT
|
MPP_CLOSE_ON_SIGNAL
);

266 
	`mu…i_¥o˚ss_io_udp
 (&
mu…i
);

267 
	`MULTI_CHECK_SIG
 (&
mu…i
);

270 
	`≥rf_p›
 ();

274 
	`unöô_m™agemít_ˇŒback_mu…i
 (&
mu…i
);

277 
	`mu…i_ifc⁄fig_poﬁ_≥rsi°
 (&
mu…i
, 
åue
);

280 
	`mu…i_unöô
 (&
mu…i
);

281 
	`mu…i_t›_‰ì
 (&
mu…i
);

282 
	`˛o£_ö°™˚
 (
t›
);

283 
	}
}

286 
	$tu¬ñ_£rvî_udp
 (
c⁄ãxt
 *
t›
)

288 
	`tu¬ñ_£rvî_udp_sögÀ_thªaded
 (
t›
);

289 
	}
}

	@src/openvpn/mudp.h

29 #i‚de‡
MUDP_H


30 
	#MUDP_H


	)

32 #i‡
P2MP_SERVER


34 
	gc⁄ãxt
;

35 
	gmu…i_c⁄ãxt
;

47 
tu¬ñ_£rvî_udp
 (
c⁄ãxt
 *
t›
);

68 
mu…i_ö°™˚
 *
mu…i_gë_¸óã_ö°™˚_udp
 (
mu…i_c⁄ãxt
 *
m
);

	@src/openvpn/multi.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #i‡
P2MP_SERVER


35 
	~"mu…i.h
"

36 
	~"push.h
"

37 
	~"misc.h
"

38 
	~"Ÿime.h
"

39 
	~"gªmlö.h
"

40 
	~"m°©s.h
"

42 
	~"memdbg.h
"

44 
	~"f‹w¨d-ölöe.h
"

45 
	~"pf-ölöe.h
"

49 #ifde‡
MULTI_DEBUG_EVENT_LOOP


51 
	$id
 (
mu…i_ö°™˚
 *
mi
)

53 i‡(
mi
)

54  
	`és_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
Ál£
);

57 
	}
}

60 #ifde‡
MANAGEMENT_DEF_AUTH


62 
	$£t_cc_c⁄fig
 (
mu…i_ö°™˚
 *
mi
, 
buf„r_li°
 *
cc_c⁄fig
)

64 i‡(
mi
->
cc_c⁄fig
)

65 
	`buf„r_li°_‰ì
 (
mi
->
cc_c⁄fig
);

66 
mi
->
cc_c⁄fig
 = cc_config;

67 
	}
}

70 
ölöe
 

71 
	$upd©e_m°©_n_˛õ¡s
(c⁄° 
n_˛õ¡s
)

73 #ifde‡
ENABLE_MEMSTATS


74 i‡(
mm≠_°©s
)

75 
mm≠_°©s
->
n_˛õ¡s
 =Ç_clients;

77 
	}
}

79 
boﬁ


80 
	$À¨n_addªss_s¸ùt
 (c⁄° 
mu…i_c⁄ãxt
 *
m
,

81 c⁄° 
mu…i_ö°™˚
 *
mi
,

82 c⁄° *
›
,

83 c⁄° 
mrouã_addr
 *
addr
)

85 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

86 
ív_£t
 *
es
;

87 
boﬁ
 
ªt
 = 
åue
;

88 
∂ugö_li°
 *
∂ugös
;

91 i‡(
mi
 && mi->
c⁄ãxt
.
c2
.
es
)

92 
es
 = 
mi
->
c⁄ãxt
.
c2
.es;

94 
es
 = 
	`ív_£t_¸óã
 (&
gc
);

97 i‡(
mi
)

98 
∂ugös
 = 
mi
->
c⁄ãxt
.plugins;

100 
∂ugös
 = 
m
->
t›
.plugins;

102 i‡(
	`∂ugö_deföed
 (
∂ugös
, 
OPENVPN_PLUGIN_LEARN_ADDRESS
))

104 
¨gv
árgv = 
	`¨gv_√w
 ();

105 
	`¨gv_¥ötf
 (&
¨gv
, "%s %s",

106 
›
,

107 
	`mrouã_addr_¥öt
 (
addr
, &
gc
));

108 i‡(
mi
)

109 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "%s", 
	`és_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
Ál£
));

110 i‡(
	`∂ugö_ˇŒ
 (
∂ugös
, 
OPENVPN_PLUGIN_LEARN_ADDRESS
, &
¨gv
, 
NULL
, 
es
Ë!
OPENVPN_PLUGIN_FUNC_SUCCESS
)

112 
	`msg
 (
M_WARN
, "WARNING:Üearn-addressÖlugin call failed");

113 
ªt
 = 
Ál£
;

115 
	`¨gv_ª£t
 (&
¨gv
);

118 i‡(
m
->
t›
.
›ti⁄s
.
À¨n_addªss_s¸ùt
)

120 
¨gv
árgv = 
	`¨gv_√w
 ();

121 
	`£ãnv_°r
 (
es
, "script_type", "learn-address");

122 
	`¨gv_¥ötf
 (&
¨gv
, "%sc %s %s",

123 
m
->
t›
.
›ti⁄s
.
À¨n_addªss_s¸ùt
,

124 
›
,

125 
	`mrouã_addr_¥öt
 (
addr
, &
gc
));

126 i‡(
mi
)

127 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "%s", 
	`és_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
Ál£
));

128 i‡(!
	`›ív≤_run_s¸ùt
 (&
¨gv
, 
es
, 0, "--learn-address"))

129 
ªt
 = 
Ál£
;

130 
	`¨gv_ª£t
 (&
¨gv
);

133 
	`gc_‰ì
 (&
gc
);

134  
ªt
;

135 
	}
}

138 
	$mu…i_ifc⁄fig_poﬁ_≥rsi°
 (
mu…i_c⁄ãxt
 *
m
, 
boﬁ
 
f‹˚
)

141 i‡(
m
->
ifc⁄fig_poﬁ


142 && 
m
->
t›
.
c1
.
ifc⁄fig_poﬁ_≥rsi°


143 && (
f‹˚
 || 
	`ifc⁄fig_poﬁ_wrôe_åiggî
 (
m
->
t›
.
c1
.
ifc⁄fig_poﬁ_≥rsi°
)))

145 
	`ifc⁄fig_poﬁ_wrôe
 (
m
->
t›
.
c1
.
ifc⁄fig_poﬁ_≥rsi°
, m->
ifc⁄fig_poﬁ
);

147 
	}
}

150 
	$mu…i_ª≠_ønge
 (c⁄° 
mu…i_c⁄ãxt
 *
m
,

151 
°¨t_buckë
,

152 
íd_buckë
)

154 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

155 
hash_ôî©‹
 
hi
;

156 
hash_ñemít
 *
he
;

158 i‡(
°¨t_buckë
 < 0)

160 
°¨t_buckë
 = 0;

161 
íd_buckë
 = 
	`hash_n_buckës
 (
m
->
vhash
);

164 
	`dmsg
 (
D_MULTI_DEBUG
, "MULTI: REAPÑ™gê%d -> %d", 
°¨t_buckë
, 
íd_buckë
);

165 
	`hash_ôî©‹_öô_ønge
 (
m
->
vhash
, &
hi
, 
°¨t_buckë
, 
íd_buckë
);

166 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)Ë!
NULL
)

168 
mu…i_rouã
 *
r
 = (mu…i_rouã *Ë
he
->
vÆue
;

169 i‡(!
	`mu…i_rouã_deföed
 (
m
, 
r
))

171 
	`dmsg
 (
D_MULTI_DEBUG
, "MULTI: REAP DEL %s",

172 
	`mrouã_addr_¥öt
 (&
r
->
addr
, &
gc
));

173 
	`À¨n_addªss_s¸ùt
 (
m
, 
NULL
, "dñëe", &
r
->
addr
);

174 
	`mu…i_rouã_dñ
 (
r
);

175 
	`hash_ôî©‹_dñëe_ñemít
 (&
hi
);

178 
	`hash_ôî©‹_‰ì
 (&
hi
);

179 
	`gc_‰ì
 (&
gc
);

180 
	}
}

183 
	$mu…i_ª≠_Æl
 (c⁄° 
mu…i_c⁄ãxt
 *
m
)

185 
	`mu…i_ª≠_ønge
 (
m
, -1, 0);

186 
	}
}

188 
mu…i_ª≠
 *

189 
	$mu…i_ª≠_√w
 (
buckës_≥r_∑ss
)

191 
mu…i_ª≠
 *
mr
;

192 
	`ALLOC_OBJ
 (
mr
, 
mu…i_ª≠
);

193 
mr
->
buckë_ba£
 = 0;

194 
mr
->
buckës_≥r_∑ss
 = buckets_per_pass;

195 
mr
->
œ°_ˇŒ
 = 
now
;

196  
mr
;

197 
	}
}

200 
	$mu…i_ª≠_¥o˚ss_dow‹k
 (c⁄° 
mu…i_c⁄ãxt
 *
m
)

202 
mu…i_ª≠
 *
mr
 = 
m
->
ª≠î
;

203 i‡(
mr
->
buckë_ba£
 >
	`hash_n_buckës
 (
m
->
vhash
))

204 
mr
->
buckë_ba£
 = 0;

205 
	`mu…i_ª≠_ønge
 (
m
, 
mr
->
buckë_ba£
, mr->buckë_ba£ + mr->
buckës_≥r_∑ss
);

206 
mr
->
buckë_ba£
 +mr->
buckës_≥r_∑ss
;

207 
mr
->
œ°_ˇŒ
 = 
now
;

208 
	}
}

211 
	$mu…i_ª≠_‰ì
 (
mu…i_ª≠
 *
mr
)

213 
	`‰ì
 (
mr
);

214 
	}
}

220 
	$ª≠_buckës_≥r_∑ss
 (
n_buckës
)

222  
	`c⁄°øö_öt
 (
n_buckës
 / 
REAP_DIVISOR
, 
REAP_MIN
, 
REAP_MAX
);

223 
	}
}

225 #ifde‡
MANAGEMENT_DEF_AUTH


227 
uöt32_t


228 
	$cid_hash_fun˘i⁄
 (c⁄° *
key
, 
uöt32_t
 
iv
)

230 c⁄° *
k
 = (c⁄° *)
key
;

231  (
uöt32_t
Ë*
k
;

232 
	}
}

234 
boﬁ


235 
	$cid_com∑ª_fun˘i⁄
 (c⁄° *
key1
, c⁄° *
key2
)

237 c⁄° *
k1
 = (c⁄° *)
key1
;

238 c⁄° *
k2
 = (c⁄° *)
key2
;

239  *
k1
 =*
k2
;

240 
	}
}

248 
	$mu…i_öô
 (
mu…i_c⁄ãxt
 *
m
, 
c⁄ãxt
 *
t
, 
boﬁ
 
t˝_mode
, 
thªad_mode
)

250 
dev
 = 
DEV_TYPE_UNDEF
;

252 
	`msg
 (
D_MULTI_LOW
, "MULTI: multi_init called,Ñ=%d v=%d",

253 
t
->
›ti⁄s
.
ªÆ_hash_size
,

254 
t
->
›ti⁄s
.
vútuÆ_hash_size
);

259 
dev
 = 
	`dev_ty≥_íum
 (
t
->
›ti⁄s
.dev,Å->›ti⁄s.
dev_ty≥
);

264 
	`CLEAR
 (*
m
);

266 
m
->
thªad_mode
 =Åhread_mode;

274 
m
->
hash
 = 
	`hash_öô
 (
t
->
›ti⁄s
.
ªÆ_hash_size
,

275 
	`gë_øndom
 (),

276 
mrouã_addr_hash_fun˘i⁄
,

277 
mrouã_addr_com∑ª_fun˘i⁄
);

283 
m
->
vhash
 = 
	`hash_öô
 (
t
->
›ti⁄s
.
vútuÆ_hash_size
,

284 
	`gë_øndom
 (),

285 
mrouã_addr_hash_fun˘i⁄
,

286 
mrouã_addr_com∑ª_fun˘i⁄
);

293 
m
->
ôî
 = 
	`hash_öô
 (1,

294 
	`gë_øndom
 (),

295 
mrouã_addr_hash_fun˘i⁄
,

296 
mrouã_addr_com∑ª_fun˘i⁄
);

298 #ifde‡
MANAGEMENT_DEF_AUTH


299 
m
->
cid_hash
 = 
	`hash_öô
 (
t
->
›ti⁄s
.
ªÆ_hash_size
,

301 
cid_hash_fun˘i⁄
,

302 
cid_com∑ª_fun˘i⁄
);

309 
m
->
scheduÀ
 = 
	`scheduÀ_öô
 ();

315 
m
->
√w_c⁄√˘i⁄_limôî
 = 
	`‰equícy_limô_öô
 (
t
->
›ti⁄s
.
cf_max
,

316 
t
->
›ti⁄s
.
cf_≥r
);

321 
m
->
mbuf
 = 
	`mbuf_öô
 (
t
->
›ti⁄s
.
n_bˇ°_buf
);

326 
m
->
°©us_fûe_vîsi⁄
 = 
t
->
›ti⁄s
.status_file_version;

333 i‡(
t
->
›ti⁄s
.
ifc⁄fig_poﬁ_deföed
)

335 
poﬁ_ty≥
 = 
IFCONFIG_POOL_INDIV
;

337 i‡–
dev
 =
DEV_TYPE_TUN
 && 
t
->
›ti⁄s
.
t›ﬁogy
 =
TOP_NET30
 )

338 
poﬁ_ty≥
 = 
IFCONFIG_POOL_30NET
;

340 
m
->
ifc⁄fig_poﬁ
 = 
	`ifc⁄fig_poﬁ_öô
 (
poﬁ_ty≥
,

341 
t
->
›ti⁄s
.
ifc⁄fig_poﬁ_°¨t
,

342 
t
->
›ti⁄s
.
ifc⁄fig_poﬁ_íd
,

343 
t
->
›ti⁄s
.
du∂iˇã_˙
,

344 
t
->
›ti⁄s
.
ifc⁄fig_ùv6_poﬁ_deföed
,

345 
t
->
›ti⁄s
.
ifc⁄fig_ùv6_poﬁ_ba£
,

346 
t
->
›ti⁄s
.
ifc⁄fig_ùv6_poﬁ_√tbôs
 );

349 i‡(
t
->
c1
.
ifc⁄fig_poﬁ_≥rsi°
)

350 
	`ifc⁄fig_poﬁ_ªad
 (
t
->
c1
.
ifc⁄fig_poﬁ_≥rsi°
, 
m
->
ifc⁄fig_poﬁ
);

356 
m
->
rouã_hñ≥r
 = 
	`mrouã_hñ≥r_öô
 (
MULTI_CACHE_ROUTE_TTL
);

361 
m
->
ª≠î
 = 
	`mu…i_ª≠_√w
 (
	`ª≠_buckës_≥r_∑ss
 (
t
->
›ti⁄s
.
vútuÆ_hash_size
));

366 
	`CLEAR
 (
m
->
loˇl
);

367 
	`ASSERT
 (
t
->
c1
.
tu¡≠
);

368 
	`mrouã_exåa˘_ö_addr_t
 (&
m
->
loˇl
, 
t
->
c1
.
tu¡≠
->local);

373 
m
->
max_˛õ¡s
 = 
t
->
›ti⁄s
.max_clients;

378 i‡(
t˝_mode
)

379 
m
->
mt˝
 = 
	`mu…i_t˝_öô
 (
t
->
›ti⁄s
.
max_˛õ¡s
, &m->max_clients);

380 
m
->
t˝_queue_limô
 = 
t
->
›ti⁄s
.tcp_queue_limit;

386 
m
->
íabÀ_c2c
 = 
t
->
›ti⁄s
.enable_c2c;

389 i‡(
t
->
›ti⁄s
.
°Æe_rouãs_check_öãrvÆ
 > 0)

391 
	`msg
 (
M_INFO
, "Initializing staleÑoute checkÅimerÅoÑunÉvery %i secondsándÅoÑemovingÑoutes witháctivityÅimeout olderÅhan %i seconds",

392 
t
->
›ti⁄s
.
°Æe_rouãs_check_öãrvÆ
,Å->›ti⁄s.
°Æe_rouãs_ageög_time
);

393 
	`evít_timeout_öô
 (&
m
->
°Æe_rouãs_check_ë
, 
t
->
›ti⁄s
.
°Æe_rouãs_check_öãrvÆ
, 0);

395 
	}
}

398 
	$mu…i_ö°™˚_°rög
 (c⁄° 
mu…i_ö°™˚
 *
mi
, 
boﬁ
 
nuŒ
, 
gc_¨ía
 *
gc
)

400 i‡(
mi
)

402 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

403 c⁄° *
˙
 = 
	`és_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
åue
);

405 i‡(
˙
)

406 
	`buf_¥ötf
 (&
out
, "%s/", 
˙
);

407 
	`buf_¥ötf
 (&
out
, "%s", 
	`mrouã_addr_¥öt
 (&
mi
->
ªÆ
, 
gc
));

408  
	`BSTR
 (&
out
);

410 i‡(
nuŒ
)

411  
NULL
;

414 
	}
}

417 
	$gíî©e_¥efix
 (
mu…i_ö°™˚
 *
mi
)

419 
mi
->
msg_¥efix
 = 
	`mu…i_ö°™˚_°rög
 (mi, 
åue
, &mi->
gc
);

420 
	`£t_¥efix
 (
mi
);

421 
	}
}

424 
	$ungíî©e_¥efix
 (
mu…i_ö°™˚
 *
mi
)

426 
mi
->
msg_¥efix
 = 
NULL
;

427 
	`£t_¥efix
 (
mi
);

428 
	}
}

431 
	$mi_¥efix
 (c⁄° 
mu…i_ö°™˚
 *
mi
)

433 i‡(
mi
 && mi->
msg_¥efix
)

434  
mi
->
msg_¥efix
;

437 
	}
}

445 
	$mu…i_dñ_úouãs
 (
mu…i_c⁄ãxt
 *
m
,

446 
mu…i_ö°™˚
 *
mi
)

448 c⁄° 
úouã
 *
ú
;

449 c⁄° 
úouã_ùv6
 *
ú6
;

450 i‡(
	`TUNNEL_TYPE
 (
mi
->
c⁄ãxt
.
c1
.
tu¡≠
Ë=
DEV_TYPE_TUN
)

452 
ú
 = 
mi
->
c⁄ãxt
.
›ti⁄s
.
úouãs
; i∏!
NULL
; i∏ú->
√xt
)

453 
	`mrouã_hñ≥r_dñ_úouã
 (
m
->
rouã_hñ≥r
, 
ú
);

455  
ú6
 = 
mi
->
c⁄ãxt
.
›ti⁄s
.
úouãs_ùv6
; ir6 !
NULL
; ir6 = ir6->
√xt
 )

456 
	`mrouã_hñ≥r_dñ_úouã6
 (
m
->
rouã_hñ≥r
, 
ú6
);

458 
	}
}

461 
	$£ãnv_°©s
 (
c⁄ãxt
 *
c
)

463 
	`£ãnv_cou¡î
 (
c
->
c2
.
es
, "byãs_ª˚ived", c->c2.
lök_ªad_byãs
);

464 
	`£ãnv_cou¡î
 (
c
->
c2
.
es
, "byãs_£¡", c->c2.
lök_wrôe_byãs
);

465 
	}
}

468 
	$mu…i_˛õ¡_disc⁄√˘_£ãnv
 (
mu…i_c⁄ãxt
 *
m
,

469 
mu…i_ö°™˚
 *
mi
)

472 
	`£ãnv_åu°ed
 (
mi
->
c⁄ãxt
.
c2
.
es
, 
	`gë_lök_sockë_öfo
 (&mi->context));

475 
	`£ãnv_°©s
 (&
mi
->
c⁄ãxt
);

479 c⁄° 
duøti⁄
 = (Ë
now
 - 
mi
->
¸óãd
;

480 
	`£ãnv_unsig√d
 (
mi
->
c⁄ãxt
.
c2
.
es
, "time_duøti⁄", 
duøti⁄
);

482 
	}
}

485 
	$mu…i_˛õ¡_disc⁄√˘_s¸ùt
 (
mu…i_c⁄ãxt
 *
m
,

486 
mu…i_ö°™˚
 *
mi
)

488 i‡((
mi
->
c⁄ãxt
.
c2
.
c⁄ãxt_auth
 =
CAS_SUCCEEDED
 && mi->
c⁄√˘i⁄_e°ablished_Êag
)

489 || 
mi
->
c⁄ãxt
.
c2
.
c⁄ãxt_auth
 =
CAS_PARTIAL
)

491 
	`mu…i_˛õ¡_disc⁄√˘_£ãnv
 (
m
, 
mi
);

493 i‡(
	`∂ugö_deföed
 (
mi
->
c⁄ãxt
.
∂ugös
, 
OPENVPN_PLUGIN_CLIENT_DISCONNECT
))

495 i‡(
	`∂ugö_ˇŒ
 (
mi
->
c⁄ãxt
.
∂ugös
, 
OPENVPN_PLUGIN_CLIENT_DISCONNECT
, 
NULL
, NULL, mi->c⁄ãxt.
c2
.
es
Ë!
OPENVPN_PLUGIN_FUNC_SUCCESS
)

496 
	`msg
 (
M_WARN
, "WARNING: client-disconnectÖlugin call failed");

499 i‡(
mi
->
c⁄ãxt
.
›ti⁄s
.
˛õ¡_disc⁄√˘_s¸ùt
)

501 
¨gv
árgv = 
	`¨gv_√w
 ();

502 
	`£ãnv_°r
 (
mi
->
c⁄ãxt
.
c2
.
es
, "script_type", "client-disconnect");

503 
	`¨gv_¥ötf
 (&
¨gv
, "%sc", 
mi
->
c⁄ãxt
.
›ti⁄s
.
˛õ¡_disc⁄√˘_s¸ùt
);

504 
	`›ív≤_run_s¸ùt
 (&
¨gv
, 
mi
->
c⁄ãxt
.
c2
.
es
, 0, "--client-disconnect");

505 
	`¨gv_ª£t
 (&
¨gv
);

507 #ifde‡
MANAGEMENT_DEF_AUTH


508 i‡(
m™agemít
)

509 
	`m™agemít_nŸify_˛õ¡_˛o£
 (
m™agemít
, &
mi
->
c⁄ãxt
.
c2
.
mda_c⁄ãxt
, mi->c⁄ãxt.c2.
es
);

513 
	}
}

516 
	$mu…i_˛o£_ö°™˚
 (
mu…i_c⁄ãxt
 *
m
,

517 
mu…i_ö°™˚
 *
mi
,

518 
boﬁ
 
shutdown
)

520 
	`≥rf_push
 (
PERF_MULTI_CLOSE_INSTANCE
);

522 
	`ASSERT
 (!
mi
->
hÆt
);

523 
mi
->
hÆt
 = 
åue
;

525 
	`dmsg
 (
D_MULTI_DEBUG
, "MULTI: multi_close_instance called");

528 
m
->
n_˛õ¡s
 +
mi
->
n_˛õ¡s_dñè
;

529 
	`upd©e_m°©_n_˛õ¡s
(
m
->
n_˛õ¡s
);

530 
mi
->
n_˛õ¡s_dñè
 = 0;

533 i‡(
m
->
≥ndög
 =
mi
)

534 
	`mu…i_£t_≥ndög
 (
m
, 
NULL
);

535 i‡(
m
->
óæõ°_wakeup
 =
mi
)

536 
m
->
óæõ°_wakeup
 = 
NULL
;

538 i‡(!
shutdown
)

540 i‡(
mi
->
did_ªÆ_hash
)

542 
	`ASSERT
 (
	`hash_ªmove
 (
m
->
hash
, &
mi
->
ªÆ
));

544 i‡(
mi
->
did_ôî
)

546 
	`ASSERT
 (
	`hash_ªmove
 (
m
->
ôî
, &
mi
->
ªÆ
));

548 #ifde‡
MANAGEMENT_DEF_AUTH


549 i‡(
mi
->
did_cid_hash
)

551 
	`ASSERT
 (
	`hash_ªmove
 (
m
->
cid_hash
, &
mi
->
c⁄ãxt
.
c2
.
mda_c⁄ãxt
.
cid
));

555 
	`scheduÀ_ªmove_íåy
 (
m
->
scheduÀ
, (
scheduÀ_íåy
 *Ë
mi
);

557 
	`ifc⁄fig_poﬁ_ªÀa£
 (
m
->
ifc⁄fig_poﬁ
, 
mi
->
vaddr_h™dÀ
, 
Ál£
);

559 i‡(
mi
->
did_úouãs
)

561 
	`mu…i_dñ_úouãs
 (
m
, 
mi
);

562 
mi
->
did_úouãs
 = 
Ál£
;

565 i‡(
m
->
mt˝
)

566 
	`mu…i_t˝_dîe„ªn˚_ö°™˚
 (
m
->
mt˝
, 
mi
);

568 
	`mbuf_dîe„ªn˚_ö°™˚
 (
m
->
mbuf
, 
mi
);

571 #ifde‡
MANAGEMENT_DEF_AUTH


572 
	`£t_cc_c⁄fig
 (
mi
, 
NULL
);

575 
	`mu…i_˛õ¡_disc⁄√˘_s¸ùt
 (
m
, 
mi
);

577 i‡(
mi
->
did_›í_c⁄ãxt
)

578 
	`˛o£_c⁄ãxt
 (&
mi
->
c⁄ãxt
, 
SIGTERM
, 
CC_GC_FREE
);

580 
	`mu…i_t˝_ö°™˚_•ecific_‰ì
 (
mi
);

582 
	`ungíî©e_¥efix
 (
mi
);

589 
	`mu…i_ö°™˚_dec_ªfcou¡
 (
mi
);

591 
	`≥rf_p›
 ();

592 
	}
}

598 
	$mu…i_unöô
 (
mu…i_c⁄ãxt
 *
m
)

600 i‡(
m
->
thªad_mode
 & 
MC_WORK_THREAD
)

602 
	`mu…i_t›_‰ì
 (
m
);

603 
m
->
thªad_mode
 = 
MC_UNDEF
;

605 i‡(
m
->
thªad_mode
)

607 i‡(
m
->
hash
)

609 
hash_ôî©‹
 
hi
;

610 
hash_ñemít
 *
he
;

612 
	`hash_ôî©‹_öô
 (
m
->
ôî
, &
hi
);

613 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

615 
mu…i_ö°™˚
 *
mi
 = (mu…i_ö°™˚ *Ë
he
->
vÆue
;

616 
mi
->
did_ôî
 = 
Ál£
;

617 
	`mu…i_˛o£_ö°™˚
 (
m
, 
mi
, 
åue
);

619 
	`hash_ôî©‹_‰ì
 (&
hi
);

621 
	`mu…i_ª≠_Æl
 (
m
);

623 
	`hash_‰ì
 (
m
->
hash
);

624 
	`hash_‰ì
 (
m
->
vhash
);

625 
	`hash_‰ì
 (
m
->
ôî
);

626 #ifde‡
MANAGEMENT_DEF_AUTH


627 
	`hash_‰ì
 (
m
->
cid_hash
);

629 
m
->
hash
 = 
NULL
;

631 
	`scheduÀ_‰ì
 (
m
->
scheduÀ
);

632 
	`mbuf_‰ì
 (
m
->
mbuf
);

633 
	`ifc⁄fig_poﬁ_‰ì
 (
m
->
ifc⁄fig_poﬁ
);

634 
	`‰equícy_limô_‰ì
 (
m
->
√w_c⁄√˘i⁄_limôî
);

635 
	`mu…i_ª≠_‰ì
 (
m
->
ª≠î
);

636 
	`mrouã_hñ≥r_‰ì
 (
m
->
rouã_hñ≥r
);

637 
	`mu…i_t˝_‰ì
 (
m
->
mt˝
);

638 
m
->
thªad_mode
 = 
MC_UNDEF
;

641 
	}
}

646 
mu…i_ö°™˚
 *

647 
	$mu…i_¸óã_ö°™˚
 (
mu…i_c⁄ãxt
 *
m
, c⁄° 
mrouã_addr
 *
ªÆ
)

649 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

650 
mu…i_ö°™˚
 *
mi
;

652 
	`≥rf_push
 (
PERF_MULTI_CREATE_INSTANCE
);

654 
	`msg
 (
D_MULTI_MEDIUM
, "MULTI: multi_create_instance called");

656 
	`ALLOC_OBJ_CLEAR
 (
mi
, 
mu…i_ö°™˚
);

658 
mi
->
gc
 = 
	`gc_√w
 ();

659 
	`mu…i_ö°™˚_öc_ªfcou¡
 (
mi
);

660 
mi
->
vaddr_h™dÀ
 = -1;

661 
mi
->
¸óãd
 = 
now
;

662 
	`mrouã_addr_öô
 (&
mi
->
ªÆ
);

664 i‡(
ªÆ
)

666 
mi
->
ªÆ
 = *real;

667 
	`gíî©e_¥efix
 (
mi
);

670 
mi
->
did_›í_c⁄ãxt
 = 
åue
;

671 
	`öhîô_c⁄ãxt_chûd
 (&
mi
->
c⁄ãxt
, &
m
->
t›
);

672 i‡(
	`IS_SIG
 (&
mi
->
c⁄ãxt
))

673 
îr
;

675 
mi
->
c⁄ãxt
.
c2
.
c⁄ãxt_auth
 = 
CAS_PENDING
;

677 i‡(
	`hash_n_ñemíts
 (
m
->
hash
Ë>m->
max_˛õ¡s
)

679 
	`msg
 (
D_MULTI_ERRORS
, "MULTI:Çew incomög c⁄√˘i⁄ wouldÉx˚ed maximumÇumbî o‡˛õ¡†(%d)", 
m
->
max_˛õ¡s
);

680 
îr
;

683 i‡(!
ªÆ
)

685 i‡(!
	`mu…i_t˝_ö°™˚_•ecific_öô
 (
m
, 
mi
))

686 
îr
;

687 
	`gíî©e_¥efix
 (
mi
);

690 i‡(!
	`hash_add
 (
m
->
ôî
, &
mi
->
ªÆ
, mi, 
Ál£
))

692 
	`msg
 (
D_MULTI_LOW
, "MULTI: unableÅoáddÑealáddress [%s]Åo iterator hashÅable",

693 
	`mrouã_addr_¥öt
 (&
mi
->
ªÆ
, &
gc
));

694 
îr
;

696 
mi
->
did_ôî
 = 
åue
;

698 #ifde‡
MANAGEMENT_DEF_AUTH


700 
mi
->
c⁄ãxt
.
c2
.
mda_c⁄ãxt
.
cid
 = 
m
->
cid_cou¡î
++;

701 } !
	`hash_add
 (
m
->
cid_hash
, &
mi
->
c⁄ãxt
.
c2
.
mda_c⁄ãxt
.
cid
, mi, 
Ál£
));

702 
mi
->
did_cid_hash
 = 
åue
;

705 
mi
->
c⁄ãxt
.
c2
.
push_ª∂y_de„ºed
 = 
åue
;

707 i‡(!
	`mu…i_¥o˚ss_po°
 (
m
, 
mi
, 
MPP_PRE_SELECT
))

709 
	`msg
 (
D_MULTI_ERRORS
, "MULTI: signal occurred during client instance initialization");

710 
îr
;

713 
	`≥rf_p›
 ();

714 
	`gc_‰ì
 (&
gc
);

715  
mi
;

717 
îr
:

718 
	`mu…i_˛o£_ö°™˚
 (
m
, 
mi
, 
Ál£
);

719 
	`≥rf_p›
 ();

720 
	`gc_‰ì
 (&
gc
);

721  
NULL
;

722 
	}
}

730 
	$mu…i_¥öt_°©us
 (
mu…i_c⁄ãxt
 *
m
, 
°©us_ouçut
 *
so
, c⁄° 
vîsi⁄
)

732 i‡(
m
->
hash
)

734 
gc_¨ía
 
gc_t›
 = 
	`gc_√w
 ();

735 
hash_ôî©‹
 
hi
;

736 c⁄° 
hash_ñemít
 *
he
;

738 
	`°©us_ª£t
 (
so
);

740 i‡(
vîsi⁄
 == 1)

745 
	`°©us_¥ötf
 (
so
, "OpenVPN CLIENT LIST");

746 
	`°©us_¥ötf
 (
so
, "Upd©ed,%s", 
	`time_°rög
 (0, 0, 
Ál£
, &
gc_t›
));

747 
	`°©us_¥ötf
 (
so
, "Common Name,Real Address,Bytes Received,Bytes Sent,Connected Since");

748 
	`hash_ôî©‹_öô
 (
m
->
hash
, &
hi
);

749 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

751 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

752 c⁄° 
mu…i_ö°™˚
 *
mi
 = (mu…i_ö°™˚ *Ë
he
->
vÆue
;

754 i‡(!
mi
->
hÆt
)

756 
	`°©us_¥ötf
 (
so
, "%s,%s," 
cou¡î_f‹m©
 "," counter_format ",%s",

757 
	`és_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
Ál£
),

758 
	`mrouã_addr_¥öt
 (&
mi
->
ªÆ
, &
gc
),

759 
mi
->
c⁄ãxt
.
c2
.
lök_ªad_byãs
,

760 
mi
->
c⁄ãxt
.
c2
.
lök_wrôe_byãs
,

761 
	`time_°rög
 (
mi
->
¸óãd
, 0, 
Ál£
, &
gc
));

763 
	`gc_‰ì
 (&
gc
);

765 
	`hash_ôî©‹_‰ì
 (&
hi
);

767 
	`°©us_¥ötf
 (
so
, "ROUTING TABLE");

768 
	`°©us_¥ötf
 (
so
, "Virtual Address,Common Name,Real Address,Last Ref");

769 
	`hash_ôî©‹_öô
 (
m
->
vhash
, &
hi
);

770 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

772 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

773 c⁄° 
mu…i_rouã
 *
rouã
 = (mu…i_rouã *Ë
he
->
vÆue
;

775 i‡(
	`mu…i_rouã_deföed
 (
m
, 
rouã
))

777 c⁄° 
mu…i_ö°™˚
 *
mi
 = 
rouã
->
ö°™˚
;

778 c⁄° 
mrouã_addr
 *
ma
 = &
rouã
->
addr
;

779 
Êags
[2] = {0, 0};

781 i‡(
rouã
->
Êags
 & 
MULTI_ROUTE_CACHE
)

782 
Êags
[0] = 'C';

783 
	`°©us_¥ötf
 (
so
, "%s%s,%s,%s,%s",

784 
	`mrouã_addr_¥öt
 (
ma
, &
gc
),

785 
Êags
,

786 
	`és_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
Ál£
),

787 
	`mrouã_addr_¥öt
 (&
mi
->
ªÆ
, &
gc
),

788 
	`time_°rög
 (
rouã
->
œ°_ª„ªn˚
, 0, 
Ál£
, &
gc
));

790 
	`gc_‰ì
 (&
gc
);

792 
	`hash_ôî©‹_‰ì
 (&
hi
);

794 
	`°©us_¥ötf
 (
so
, "GLOBAL STATS");

795 i‡(
m
->
mbuf
)

796 
	`°©us_¥ötf
 (
so
, "Max bcast/mcast queueÜength,%d",

797 
	`mbuf_maximum_queued
 (
m
->
mbuf
));

799 
	`°©us_¥ötf
 (
so
, "END");

801 i‡(
vîsi⁄
 == 2 || version == 3)

803 c⁄° 
£p
 = (
vîsi⁄
 == 3) ? '\t' : ',';

808 
	`°©us_¥ötf
 (
so
, "TITLE%c%s", 
£p
, 
tôÀ_°rög
);

809 
	`°©us_¥ötf
 (
so
, "TIME%c%s%c%u", 
£p
, 
	`time_°rög
 (
now
, 0, 
Ál£
, &
gc_t›
), sep, ()now);

810 
	`°©us_¥ötf
 (
so
, "HEADER%cCLIENT_LIST%cCommon Name%cReal Address%cVirtual Address%cBytes Received%cBytes Sent%cConnected Since%cConnected Since (time_t)%cUsername",

811 
£p
, sep, sep, sep, sep, sep, sep, sep, sep);

812 
	`hash_ôî©‹_öô
 (
m
->
hash
, &
hi
);

813 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

815 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

816 c⁄° 
mu…i_ö°™˚
 *
mi
 = (mu…i_ö°™˚ *Ë
he
->
vÆue
;

818 i‡(!
mi
->
hÆt
)

820 
	`°©us_¥ötf
 (
so
, "CLIENT_LIST%c%s%c%s%c%s%c" 
cou¡î_f‹m©
 "%c" counter_format "%c%s%c%u%c%s",

821 
£p
, 
	`és_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
Ál£
),

822 
£p
, 
	`mrouã_addr_¥öt
 (&
mi
->
ªÆ
, &
gc
),

823 
£p
, 
	`¥öt_ö_addr_t
 (
mi
->
ªp‹tög_addr
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

824 
£p
, 
mi
->
c⁄ãxt
.
c2
.
lök_ªad_byãs
,

825 
£p
, 
mi
->
c⁄ãxt
.
c2
.
lök_wrôe_byãs
,

826 
£p
, 
	`time_°rög
 (
mi
->
¸óãd
, 0, 
Ál£
, &
gc
),

827 
£p
, ()
mi
->
¸óãd
,

828 
£p
, 
	`és_u£∫ame
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
Ál£
));

830 
	`gc_‰ì
 (&
gc
);

832 
	`hash_ôî©‹_‰ì
 (&
hi
);

834 
	`°©us_¥ötf
 (
so
, "HEADER%cROUTING_TABLE%cVirtual Address%cCommon Name%cReal Address%cLast Ref%cLast Ref (time_t)",

835 
£p
, sep, sep, sep, sep, sep);

836 
	`hash_ôî©‹_öô
 (
m
->
vhash
, &
hi
);

837 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

839 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

840 c⁄° 
mu…i_rouã
 *
rouã
 = (mu…i_rouã *Ë
he
->
vÆue
;

842 i‡(
	`mu…i_rouã_deföed
 (
m
, 
rouã
))

844 c⁄° 
mu…i_ö°™˚
 *
mi
 = 
rouã
->
ö°™˚
;

845 c⁄° 
mrouã_addr
 *
ma
 = &
rouã
->
addr
;

846 
Êags
[2] = {0, 0};

848 i‡(
rouã
->
Êags
 & 
MULTI_ROUTE_CACHE
)

849 
Êags
[0] = 'C';

850 
	`°©us_¥ötf
 (
so
, "ROUTING_TABLE%c%s%s%c%s%c%s%c%s%c%u",

851 
£p
, 
	`mrouã_addr_¥öt
 (
ma
, &
gc
), 
Êags
,

852 
£p
, 
	`és_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
Ál£
),

853 
£p
, 
	`mrouã_addr_¥öt
 (&
mi
->
ªÆ
, &
gc
),

854 
£p
, 
	`time_°rög
 (
rouã
->
œ°_ª„ªn˚
, 0, 
Ál£
, &
gc
),

855 
£p
, ()
rouã
->
œ°_ª„ªn˚
);

857 
	`gc_‰ì
 (&
gc
);

859 
	`hash_ôî©‹_‰ì
 (&
hi
);

861 i‡(
m
->
mbuf
)

862 
	`°©us_¥ötf
 (
so
, "GLOBAL_STATS%cMax bcast/mcast queueÜength%c%d",

863 
£p
, sï, 
	`mbuf_maximum_queued
 (
m
->
mbuf
));

865 
	`°©us_¥ötf
 (
so
, "END");

869 
	`°©us_¥ötf
 (
so
, "ERROR: bad status format versionÇumber");

872 #ifde‡
PACKET_TRUNCATION_CHECK


874 
	`°©us_¥ötf
 (
so
, "HEADER,ERRORS,Common Name,TUN Read Trunc,TUN Write Trunc,Pre-encrypt Trunc,Post-decrypt Trunc");

875 
	`hash_ôî©‹_öô
 (
m
->
hash
, &
hi
);

876 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

878 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

879 c⁄° 
mu…i_ö°™˚
 *
mi
 = (mu…i_ö°™˚ *Ë
he
->
vÆue
;

881 i‡(!
mi
->
hÆt
)

883 
	`°©us_¥ötf
 (
so
, "ERRORS,%s," 
cou¡î_f‹m©
 "," counter_format "," counter_format "," counter_format,

884 
	`és_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
Ál£
),

885 
m
->
t›
.
c2
.
n_åunc_tun_ªad
,

886 
mi
->
c⁄ãxt
.
c2
.
n_åunc_tun_wrôe
,

887 
mi
->
c⁄ãxt
.
c2
.
n_åunc_¥e_í¸y±
,

888 
mi
->
c⁄ãxt
.
c2
.
n_åunc_po°_de¸y±
);

890 
	`gc_‰ì
 (&
gc
);

892 
	`hash_ôî©‹_‰ì
 (&
hi
);

896 
	`°©us_Êush
 (
so
);

897 
	`gc_‰ì
 (&
gc_t›
);

899 
	}
}

909 
mu…i_ö°™˚
 *

910 
	$mu…i_À¨n_addr
 (
mu…i_c⁄ãxt
 *
m
,

911 
mu…i_ö°™˚
 *
mi
,

912 c⁄° 
mrouã_addr
 *
addr
,

913 c⁄° 
Êags
)

915 
hash_ñemít
 *
he
;

916 c⁄° 
uöt32_t
 
hv
 = 
	`hash_vÆue
 (
m
->
vhash
, 
addr
);

917 
hash_buckë
 *
buckë
 = 
	`hash_buckë
 (
m
->
vhash
, 
hv
);

918 
mu…i_rouã
 *
ﬁdrouã
 = 
NULL
;

919 
mu…i_ö°™˚
 *
ow√r
 = 
NULL
;

922 
he
 = 
	`hash_lookup_Á°
 (
m
->
vhash
, 
buckë
, 
addr
, 
hv
);

923 i‡(
he
)

924 
ﬁdrouã
 = (
mu…i_rouã
 *Ë
he
->
vÆue
;

925 i‡(
ﬁdrouã
 && 
	`mu…i_rouã_deföed
 (
m
, oldroute))

926 
ow√r
 = 
ﬁdrouã
->
ö°™˚
;

929 i‡((!
ow√r
 || ow√∏!
mi
)

930 && 
	`mrouã_À¨«bÀ_addªss
 (
addr
)

931 && !
	`mrouã_addr_equÆ
 (
addr
, &
m
->
loˇl
))

933 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

934 
mu…i_rouã
 *
√wrouã
;

935 
boﬁ
 
À¨n_suc˚eded
 = 
Ál£
;

937 
	`ALLOC_OBJ
 (
√wrouã
, 
mu…i_rouã
);

938 
√wrouã
->
addr
 = *addr;

939 
√wrouã
->
ö°™˚
 = 
mi
;

940 
√wrouã
->
Êags
 = flags;

941 
√wrouã
->
œ°_ª„ªn˚
 = 
now
;

942 
√wrouã
->
ˇche_gíî©i⁄
 = 0;

945 i‡(
Êags
 & 
MULTI_ROUTE_CACHE
)

946 
√wrouã
->
ˇche_gíî©i⁄
 = 
m
->
rouã_hñ≥r
->cache_generation;

948 i‡(
ﬁdrouã
)

950 i‡(
	`rouã_quŸa_ã°
 (
m
, 
mi
Ë&& 
	`À¨n_addªss_s¸ùt
 (m, mi, "upd©e", &
√wrouã
->
addr
))

952 
À¨n_suc˚eded
 = 
åue
;

953 
ow√r
 = 
mi
;

954 
	`mu…i_ö°™˚_öc_ªfcou¡
 (
mi
);

955 
	`rouã_quŸa_öc
 (
mi
);

958 
	`mu…i_rouã_dñ
 (
ﬁdrouã
);

961 
he
->
key
 = &
√wrouã
->
addr
;

962 
he
->
vÆue
 = 
√wrouã
;

967 i‡(
	`rouã_quŸa_ã°
 (
m
, 
mi
Ë&& 
	`À¨n_addªss_s¸ùt
 (m, mi, "add", &
√wrouã
->
addr
))

969 
À¨n_suc˚eded
 = 
åue
;

970 
ow√r
 = 
mi
;

971 
	`mu…i_ö°™˚_öc_ªfcou¡
 (
mi
);

972 
	`rouã_quŸa_öc
 (
mi
);

975 
	`hash_add_Á°
 (
m
->
vhash
, 
buckë
, &
√wrouã
->
addr
, 
hv
,Çewroute);

979 
	`msg
 (
D_MULTI_LOW
, "MULTI: Learn%s: %s -> %s",

980 
À¨n_suc˚eded
 ? "" : " FAILED",

981 
	`mrouã_addr_¥öt
 (&
√wrouã
->
addr
, &
gc
),

982 
	`mu…i_ö°™˚_°rög
 (
mi
, 
Ál£
, &
gc
));

984 i‡(!
À¨n_suc˚eded
)

985 
	`‰ì
 (
√wrouã
);

987 
	`gc_‰ì
 (&
gc
);

990  
ow√r
;

991 
	}
}

996 
mu…i_ö°™˚
 *

997 
	$mu…i_gë_ö°™˚_by_vútuÆ_addr
 (
mu…i_c⁄ãxt
 *
m
,

998 c⁄° 
mrouã_addr
 *
addr
,

999 
boﬁ
 
cidr_routög
)

1001 
mu…i_rouã
 *
rouã
;

1002 
mu…i_ö°™˚
 *
ªt
 = 
NULL
;

1005 i‡(
	`mrouã_addr_equÆ
 (
addr
, &
m
->
loˇl
))

1006  
NULL
;

1008 
rouã
 = (
mu…i_rouã
 *Ë
	`hash_lookup
 (
m
->
vhash
, 
addr
);

1011 i‡(
rouã
 && 
	`mu…i_rouã_deföed
 (
m
,Ñoute))

1013 
mu…i_ö°™˚
 *
mi
 = 
rouã
->
ö°™˚
;

1014 
rouã
->
œ°_ª„ªn˚
 = 
now
;

1015 
ªt
 = 
mi
;

1017 i‡(
cidr_routög
)

1019 
mrouã_hñ≥r
 *
rh
 = 
m
->
rouã_hñ≥r
;

1020 
mrouã_addr
 
åyaddr
;

1021 
i
;

1024 
i
 = 0; i < 
rh
->
n_√t_Àn
; ++i)

1026 
åyaddr
 = *
addr
;

1027 
åyaddr
.
ty≥
 |
MR_WITH_NETBITS
;

1028 
åyaddr
.
√tbôs
 = 
rh
->
√t_Àn
[
i
];

1029 
	`mrouã_addr_mask_ho°_bôs
 (&
åyaddr
);

1032 
rouã
 = (
mu…i_rouã
 *Ë
	`hash_lookup
 (
m
->
vhash
, &
åyaddr
);

1034 i‡(
rouã
 && 
	`mu…i_rouã_deföed
 (
m
,Ñoute))

1037 
mu…i_ö°™˚
 *
mi
 = 
rouã
->
ö°™˚
;

1038 
	`mu…i_À¨n_addr
 (
m
, 
mi
, 
addr
, 
MULTI_ROUTE_CACHE
|
MULTI_ROUTE_AGEABLE
);

1039 
ªt
 = 
mi
;

1045 #ifde‡
ENABLE_DEBUG


1046 i‡(
	`check_debug_Àvñ
 (
D_MULTI_DEBUG
))

1048 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1049 c⁄° *
addr_ãxt
 = 
	`mrouã_addr_¥öt
 (
addr
, &
gc
);

1050 i‡(
ªt
)

1052 
	`dmsg
 (
D_MULTI_DEBUG
, "GET INST BY VIRT: %s -> %s via %s",

1053 
addr_ãxt
,

1054 
	`mu…i_ö°™˚_°rög
 (
ªt
, 
Ál£
, &
gc
),

1055 
	`mrouã_addr_¥öt
 (&
rouã
->
addr
, &
gc
));

1059 
	`dmsg
 (
D_MULTI_DEBUG
, "GET INST BY VIRT: %s [failed]",

1060 
addr_ãxt
);

1062 
	`gc_‰ì
 (&
gc
);

1066 
	`ASSERT
 (!(
ªt
 &&Ñë->
hÆt
));

1067  
ªt
;

1068 
	}
}

1073 
mu…i_ö°™˚
 *

1074 
	$mu…i_À¨n_ö_addr_t
 (
mu…i_c⁄ãxt
 *
m
,

1075 
mu…i_ö°™˚
 *
mi
,

1076 
ö_addr_t
 
a
,

1077 
√tbôs
,

1078 
boﬁ
 
¥im¨y
)

1080 
›ív≤_sockaddr
 
ªmŸe_si
;

1081 
mrouã_addr
 
addr
;

1083 
	`CLEAR
 (
ªmŸe_si
);

1084 
ªmŸe_si
.
addr
.
ö4
.
sö_Ámûy
 = 
AF_INET
;

1085 
ªmŸe_si
.
addr
.
ö4
.
sö_addr
.
s_addr
 = 
	`ht⁄l
 (
a
);

1086 
	`ASSERT
 (
	`mrouã_exåa˘_›ív≤_sockaddr
 (&
addr
, &
ªmŸe_si
, 
Ál£
));

1088 i‡(
√tbôs
 >= 0)

1090 
addr
.
ty≥
 |
MR_WITH_NETBITS
;

1091 
addr
.
√tbôs
 = (
uöt8_t
)Çetbits;

1095 
mu…i_ö°™˚
 *
ow√r
 = 
	`mu…i_À¨n_addr
 (
m
, 
mi
, &
addr
, 0);

1096 #ifde‡
MANAGEMENT_DEF_AUTH


1097 i‡(
m™agemít
 && 
ow√r
)

1098 
	`m™agemít_À¨n_addr
 (
m™agemít
, &
mi
->
c⁄ãxt
.
c2
.
mda_c⁄ãxt
, &
addr
, 
¥im¨y
);

1100  
ow√r
;

1102 
	}
}

1104 
mu…i_ö°™˚
 *

1105 
	$mu…i_À¨n_ö6_addr
 (
mu…i_c⁄ãxt
 *
m
,

1106 
mu…i_ö°™˚
 *
mi
,

1107 
ö6_addr
 
a6
,

1108 
√tbôs
,

1109 
boﬁ
 
¥im¨y
)

1111 
mrouã_addr
 
addr
;

1113 
addr
.
Àn
 = 16;

1114 
addr
.
ty≥
 = 
MR_ADDR_IPV6
;

1115 
addr
.
√tbôs
 = 0;

1116 
	`mem˝y
–&
addr
.addr, &
a6
, (a6) );

1118 i‡(
√tbôs
 >= 0)

1120 
addr
.
ty≥
 |
MR_WITH_NETBITS
;

1121 
addr
.
√tbôs
 = (
uöt8_t
)Çetbits;

1122 
	`mrouã_addr_mask_ho°_bôs
–&
addr
 );

1126 
mu…i_ö°™˚
 *
ow√r
 = 
	`mu…i_À¨n_addr
 (
m
, 
mi
, &
addr
, 0);

1127 #ifde‡
MANAGEMENT_DEF_AUTH


1128 i‡(
m™agemít
 && 
ow√r
)

1129 
	`m™agemít_À¨n_addr
 (
m™agemít
, &
mi
->
c⁄ãxt
.
c2
.
mda_c⁄ãxt
, &
addr
, 
¥im¨y
);

1131  
ow√r
;

1133 
	}
}

1140 
	$mu…i_add_úouãs
 (
mu…i_c⁄ãxt
 *
m
,

1141 
mu…i_ö°™˚
 *
mi
)

1143 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1144 c⁄° 
úouã
 *
ú
;

1145 c⁄° 
úouã_ùv6
 *
ú6
;

1146 i‡(
	`TUNNEL_TYPE
 (
mi
->
c⁄ãxt
.
c1
.
tu¡≠
Ë=
DEV_TYPE_TUN
)

1148 
mi
->
did_úouãs
 = 
åue
;

1149 
ú
 = 
mi
->
c⁄ãxt
.
›ti⁄s
.
úouãs
; i∏!
NULL
; i∏ú->
√xt
)

1151 i‡(
ú
->
√tbôs
 >= 0)

1152 
	`msg
 (
D_MULTI_LOW
, "MULTI: internalÑoute %s/%d -> %s",

1153 
	`¥öt_ö_addr_t
 (
ú
->
√tw‹k
, 0, &
gc
),

1154 
ú
->
√tbôs
,

1155 
	`mu…i_ö°™˚_°rög
 (
mi
, 
Ál£
, &
gc
));

1157 
	`msg
 (
D_MULTI_LOW
, "MULTI: internalÑoute %s -> %s",

1158 
	`¥öt_ö_addr_t
 (
ú
->
√tw‹k
, 0, &
gc
),

1159 
	`mu…i_ö°™˚_°rög
 (
mi
, 
Ál£
, &
gc
));

1161 
	`mrouã_hñ≥r_add_úouã
 (
m
->
rouã_hñ≥r
, 
ú
);

1163 
	`mu…i_À¨n_ö_addr_t
 (
m
, 
mi
, 
ú
->
√tw‹k
, ir->
√tbôs
, 
Ál£
);

1165  
ú6
 = 
mi
->
c⁄ãxt
.
›ti⁄s
.
úouãs_ùv6
; ir6 !
NULL
; ir6 = ir6->
√xt
 )

1167 i‡(
ú6
->
√tbôs
 >= 0)

1168 
	`msg
 (
D_MULTI_LOW
, "MULTI: internalÑoute %s/%d -> %s",

1169 
	`¥öt_ö6_addr
 (
ú6
->
√tw‹k
, 0, &
gc
),

1170 
ú6
->
√tbôs
,

1171 
	`mu…i_ö°™˚_°rög
 (
mi
, 
Ál£
, &
gc
));

1173 
	`msg
 (
D_MULTI_LOW
, "MULTI: internalÑoute %s -> %s",

1174 
	`¥öt_ö6_addr
 (
ú6
->
√tw‹k
, 0, &
gc
),

1175 
	`mu…i_ö°™˚_°rög
 (
mi
, 
Ál£
, &
gc
));

1177 
	`mrouã_hñ≥r_add_úouã6
 (
m
->
rouã_hñ≥r
, 
ú6
);

1179 
	`mu…i_À¨n_ö6_addr
 (
m
, 
mi
, 
ú6
->
√tw‹k
, ir6->
√tbôs
, 
Ál£
);

1182 
	`gc_‰ì
 (&
gc
);

1183 
	}
}

1190 
	$mu…i_dñëe_dup
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
√w_mi
)

1192 i‡(
√w_mi
)

1194 c⁄° *
√w_˙
 = 
	`és_comm⁄_«me
 (
√w_mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
åue
);

1195 i‡(
√w_˙
)

1197 
hash_ôî©‹
 
hi
;

1198 
hash_ñemít
 *
he
;

1199 
cou¡
 = 0;

1201 
	`hash_ôî©‹_öô
 (
m
->
ôî
, &
hi
);

1202 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

1204 
mu…i_ö°™˚
 *
mi
 = (mu…i_ö°™˚ *Ë
he
->
vÆue
;

1205 i‡(
mi
 !
√w_mi
 && !mi->
hÆt
)

1207 c⁄° *
˙
 = 
	`és_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
åue
);

1208 i‡(
˙
 && !
	`°rcmp
 (˙, 
√w_˙
))

1210 
mi
->
did_ôî
 = 
Ál£
;

1211 
	`mu…i_˛o£_ö°™˚
 (
m
, 
mi
, 
Ál£
);

1212 
	`hash_ôî©‹_dñëe_ñemít
 (&
hi
);

1213 ++
cou¡
;

1217 
	`hash_ôî©‹_‰ì
 (&
hi
);

1219 i‡(
cou¡
)

1220 
	`msg
 (
D_MULTI_LOW
, "MULTI:Çew c⁄√˘i⁄ by clõ¡ '%s' wû»ˇu£Öªviou†a˘ivê£ssi⁄†byÅhi†˛õ¡Åÿbêdr›≥d. RemembîÅÿu£Åhê--du∂iˇã-˙ o±i⁄ i‡you w™àmu…ùÀ clõ¡†usögÅhêßmê˚πifiˇã o∏u£∫amêtÿc⁄cuºíéy c⁄√˘.", 
√w_˙
);

1223 
	}
}

1226 
	$check_°Æe_rouãs
 (
mu…i_c⁄ãxt
 *
m
)

1229 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1230 
hash_ôî©‹
 
hi
;

1231 
hash_ñemít
 *
he
;

1233 
	`dmsg
 (
D_MULTI_DEBUG
, "MULTI: Checking staleÑoutes");

1234 
	`hash_ôî©‹_öô_ønge
 (
m
->
vhash
, &
hi
, 0, 
	`hash_n_buckës
 (m->vhash));

1235 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)Ë!
NULL
)

1237 
mu…i_rouã
 *
r
 = (mu…i_rouã *Ë
he
->
vÆue
;

1238 i‡(
	`mu…i_rouã_deföed
 (
m
, 
r
Ë&& 
	`dif·ime
(
now
,Ñ->
œ°_ª„ªn˚
Ë>m->
t›
.
›ti⁄s
.
°Æe_rouãs_ageög_time
)

1240 
	`dmsg
 (
D_MULTI_DEBUG
, "MULTI: Deleting staleÑoute foráddress '%s'",

1241 
	`mrouã_addr_¥öt
 (&
r
->
addr
, &
gc
));

1242 
	`À¨n_addªss_s¸ùt
 (
m
, 
NULL
, "dñëe", &
r
->
addr
);

1243 
	`mu…i_rouã_dñ
 (
r
);

1244 
	`hash_ôî©‹_dñëe_ñemít
 (&
hi
);

1247 
	`hash_ôî©‹_‰ì
 (&
hi
);

1248 
	`gc_‰ì
 (&
gc
);

1249 
	}
}

1255 
boﬁ


1256 
	$ifc⁄fig_push_c⁄°øöt_ßtisfõd
 (c⁄° 
c⁄ãxt
 *
c
)

1258 c⁄° 
›ti⁄s
 *
o
 = &
c
->options;

1259 i‡(
o
->
push_ifc⁄fig_c⁄°øöt_deföed
 && 
c
->
c2
.
push_ifc⁄fig_deföed
)

1260  (
o
->
push_ifc⁄fig_c⁄°øöt_√tmask
 & 
c
->
c2
.
push_ifc⁄fig_loˇl
Ë=o->
push_ifc⁄fig_c⁄°øöt_√tw‹k
;

1262  
åue
;

1263 
	}
}

1271 
	$mu…i_£À˘_vútuÆ_addr
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
)

1273 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1279 i‡(
mi
->
c⁄ãxt
.
›ti⁄s
.
push_ifc⁄fig_deföed
)

1283 i‡(
mi
->
vaddr_h™dÀ
 >= 0)

1285 
	`ifc⁄fig_poﬁ_ªÀa£
 (
m
->
ifc⁄fig_poﬁ
, 
mi
->
vaddr_h™dÀ
, 
åue
);

1286 
mi
->
vaddr_h™dÀ
 = -1;

1289 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_deföed
 = 
åue
;

1290 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_loˇl
 = mi->c⁄ãxt.
›ti⁄s
.push_ifconfig_local;

1291 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ªmŸe_√tmask
 = mi->c⁄ãxt.
›ti⁄s
.push_ifconfig_remote_netmask;

1292 #ifde‡
ENABLE_CLIENT_NAT


1293 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_loˇl_Æüs
 = mi->c⁄ãxt.
›ti⁄s
.push_ifconfig_local_alias;

1300 i‡–
mi
->
c⁄ãxt
.
c1
.
tu¡≠
->
ùv6
 &&

1301 
mi
->
c⁄ãxt
.
›ti⁄s
.
ifc⁄fig_ùv6_poﬁ_deföed
 &&

1302 ! 
mi
->
c⁄ãxt
.
›ti⁄s
.
push_ifc⁄fig_ùv6_deföed
 )

1304 
	`msg
–
M_INFO
, "MULTI_sva: WARNING: if --ifconfig-push is used for IPv4,áutomatic IPv6ássignment from --ifconfig-ipv6-pool doesÇot work. Use --ifconfig-ipv6-push for IPv6Åhen." );

1307 i‡(
m
->
ifc⁄fig_poﬁ
 && 
mi
->
vaddr_h™dÀ
 < 0)

1309 
ö_addr_t
 
loˇl
=0, 
ªmŸe
=0;

1310 
ö6_addr
 
ªmŸe_ùv6
;

1311 c⁄° *
˙
 = 
NULL
;

1313 i‡(!
mi
->
c⁄ãxt
.
›ti⁄s
.
du∂iˇã_˙
)

1314 
˙
 = 
	`és_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
åue
);

1316 
	`CLEAR
(
ªmŸe_ùv6
);

1317 
mi
->
vaddr_h™dÀ
 = 
	`ifc⁄fig_poﬁ_acquúe
 (
m
->
ifc⁄fig_poﬁ
, &
loˇl
, &
ªmŸe
, &
ªmŸe_ùv6
, 
˙
);

1318 i‡(
mi
->
vaddr_h™dÀ
 >= 0)

1320 c⁄° 
tu¬ñ_ty≥
 = 
	`TUNNEL_TYPE
 (
mi
->
c⁄ãxt
.
c1
.
tu¡≠
);

1321 c⁄° 
tu¬ñ_t›ﬁogy
 = 
	`TUNNEL_TOPOLOGY
 (
mi
->
c⁄ãxt
.
c1
.
tu¡≠
);

1323 
	`msg
–
M_INFO
, "MULTI_sva:ÖoolÑeturned IPv4=%s, IPv6=%s",

1324 
	`¥öt_ö_addr_t
–
ªmŸe
, 0, &
gc
 ),

1325 (
mi
->
c⁄ãxt
.
›ti⁄s
.
ifc⁄fig_ùv6_poﬁ_deföed


1326 ? 
	`¥öt_ö6_addr
–
ªmŸe_ùv6
, 0, &
gc
 )

1330 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_loˇl
 = 
ªmŸe
;

1331 i‡(
tu¬ñ_ty≥
 =
DEV_TYPE_TAP
 || (tu¬ñ_ty≥ =
DEV_TYPE_TUN
 && 
tu¬ñ_t›ﬁogy
 =
TOP_SUBNET
))

1333 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ªmŸe_√tmask
 = mi->c⁄ãxt.
›ti⁄s
.
ifc⁄fig_poﬁ_√tmask
;

1334 i‡(!
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ªmŸe_√tmask
)

1335 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ªmŸe_√tmask
 = mi->c⁄ãxt.
c1
.
tu¡≠
->
ªmŸe_√tmask
;

1337 i‡(
tu¬ñ_ty≥
 =
DEV_TYPE_TUN
)

1339 i‡(
tu¬ñ_t›ﬁogy
 =
TOP_P2P
)

1340 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ªmŸe_√tmask
 = mi->c⁄ãxt.
c1
.
tu¡≠
->
loˇl
;

1341 i‡(
tu¬ñ_t›ﬁogy
 =
TOP_NET30
)

1342 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ªmŸe_√tmask
 = 
loˇl
;

1345 i‡(
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ªmŸe_√tmask
)

1346 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_deföed
 = 
åue
;

1348 
	`msg
 (
D_MULTI_ERRORS
, "MULTI:Ço --ifconfig-poolÇetmaskÖarameter isávailableÅoÖushÅo %s",

1349 
	`mu…i_ö°™˚_°rög
 (
mi
, 
Ál£
, &
gc
));

1351 i‡–
mi
->
c⁄ãxt
.
›ti⁄s
.
ifc⁄fig_ùv6_poﬁ_deföed
 )

1353 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ùv6_loˇl
 = 
ªmŸe_ùv6
;

1354 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ùv6_ªmŸe
 =

1355 
mi
->
c⁄ãxt
.
c1
.
tu¡≠
->
loˇl_ùv6
;

1356 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ùv6_√tbôs
 =

1357 
mi
->
c⁄ãxt
.
›ti⁄s
.
ifc⁄fig_ùv6_poﬁ_√tbôs
;

1358 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ùv6_deföed
 = 
åue
;

1363 
	`msg
 (
D_MULTI_ERRORS
, "MULTI:Ço free --ifconfig-pooláddressesáreávailable");

1374 i‡–
mi
->
c⁄ãxt
.
c1
.
tu¡≠
->
ùv6
 &&

1375 
mi
->
c⁄ãxt
.
›ti⁄s
.
push_ifc⁄fig_ùv6_deföed
 )

1377 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ùv6_loˇl
 =

1378 
mi
->
c⁄ãxt
.
›ti⁄s
.
push_ifc⁄fig_ùv6_loˇl
;

1379 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ùv6_ªmŸe
 =

1380 
mi
->
c⁄ãxt
.
›ti⁄s
.
push_ifc⁄fig_ùv6_ªmŸe
;

1381 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ùv6_√tbôs
 =

1382 
mi
->
c⁄ãxt
.
›ti⁄s
.
push_ifc⁄fig_ùv6_√tbôs
;

1383 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ùv6_deföed
 = 
åue
;

1385 
	`msg
–
M_INFO
, "MULTI_sva:Öush_ifconfig_ipv6 %s/%d",

1386 
	`¥öt_ö6_addr
–
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ùv6_loˇl
, 0, &
gc
 ),

1387 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ùv6_√tbôs
 );

1390 
	`gc_‰ì
 (&
gc
);

1391 
	}
}

1397 
	$mu…i_£t_vútuÆ_addr_ív
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
)

1399 
	`£ãnv_dñ
 (
mi
->
c⁄ãxt
.
c2
.
es
, "ifconfig_pool_local_ip");

1400 
	`£ãnv_dñ
 (
mi
->
c⁄ãxt
.
c2
.
es
, "ifconfig_pool_remote_ip");

1401 
	`£ãnv_dñ
 (
mi
->
c⁄ãxt
.
c2
.
es
, "ifconfig_pool_netmask");

1403 i‡(
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_deföed
)

1405 c⁄° 
tu¬ñ_ty≥
 = 
	`TUNNEL_TYPE
 (
mi
->
c⁄ãxt
.
c1
.
tu¡≠
);

1406 c⁄° 
tu¬ñ_t›ﬁogy
 = 
	`TUNNEL_TOPOLOGY
 (
mi
->
c⁄ãxt
.
c1
.
tu¡≠
);

1408 
	`£ãnv_ö_addr_t
 (
mi
->
c⁄ãxt
.
c2
.
es
,

1410 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_loˇl
,

1411 
SA_SET_IF_NONZERO
);

1413 i‡(
tu¬ñ_ty≥
 =
DEV_TYPE_TAP
 || (tu¬ñ_ty≥ =
DEV_TYPE_TUN
 && 
tu¬ñ_t›ﬁogy
 =
TOP_SUBNET
))

1415 
	`£ãnv_ö_addr_t
 (
mi
->
c⁄ãxt
.
c2
.
es
,

1417 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ªmŸe_√tmask
,

1418 
SA_SET_IF_NONZERO
);

1420 i‡(
tu¬ñ_ty≥
 =
DEV_TYPE_TUN
)

1422 
	`£ãnv_ö_addr_t
 (
mi
->
c⁄ãxt
.
c2
.
es
,

1424 
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ªmŸe_√tmask
,

1425 
SA_SET_IF_NONZERO
);

1433 
	}
}

1439 
	$mu…i_˛õ¡_c⁄√˘_po°
 (
mu…i_c⁄ãxt
 *
m
,

1440 
mu…i_ö°™˚
 *
mi
,

1441 c⁄° *
dc_fûe
,

1442 
›ti⁄_≥rmissi⁄s_mask
,

1443 *
›ti⁄_ty≥s_found
)

1446 i‡(
	`ã°_fûe
 (
dc_fûe
))

1448 
	`›ti⁄s_£rvî_imp‹t
 (&
mi
->
c⁄ãxt
.
›ti⁄s
,

1449 
dc_fûe
,

1450 
D_IMPORT_ERRORS
|
M_OPTERR
,

1451 
›ti⁄_≥rmissi⁄s_mask
,

1452 
›ti⁄_ty≥s_found
,

1453 
mi
->
c⁄ãxt
.
c2
.
es
);

1461 
	`mu…i_£À˘_vútuÆ_addr
 (
m
, 
mi
);

1462 
	`mu…i_£t_vútuÆ_addr_ív
 (
m
, 
mi
);

1464 
	}
}

1466 #ifde‡
ENABLE_PLUGIN


1472 
	$mu…i_˛õ¡_c⁄√˘_po°_∂ugö
 (
mu…i_c⁄ãxt
 *
m
,

1473 
mu…i_ö°™˚
 *
mi
,

1474 c⁄° 
∂ugö_ªtu∫
 *
¥
,

1475 
›ti⁄_≥rmissi⁄s_mask
,

1476 *
›ti⁄_ty≥s_found
)

1478 
∂ugö_ªtu∫
 
c⁄fig
;

1480 
	`∂ugö_ªtu∫_gë_cﬁumn
 (
¥
, &
c⁄fig
, "config");

1483 i‡(
	`∂ugö_ªtu∫_deföed
 (&
c⁄fig
))

1485 
i
;

1486 
i
 = 0; i < 
c⁄fig
.
n
; ++i)

1488 i‡(
c⁄fig
.
li°
[
i
] && c⁄fig.li°[i]->
vÆue
)

1489 
	`›ti⁄s_°rög_imp‹t
 (&
mi
->
c⁄ãxt
.
›ti⁄s
,

1490 
c⁄fig
.
li°
[
i
]->
vÆue
,

1491 
D_IMPORT_ERRORS
|
M_OPTERR
,

1492 
›ti⁄_≥rmissi⁄s_mask
,

1493 
›ti⁄_ty≥s_found
,

1494 
mi
->
c⁄ãxt
.
c2
.
es
);

1503 
	`mu…i_£À˘_vútuÆ_addr
 (
m
, 
mi
);

1504 
	`mu…i_£t_vútuÆ_addr_ív
 (
m
, 
mi
);

1506 
	}
}

1510 #ifde‡
MANAGEMENT_DEF_AUTH


1516 
	$mu…i_˛õ¡_c⁄√˘_mda
 (
mu…i_c⁄ãxt
 *
m
,

1517 
mu…i_ö°™˚
 *
mi
,

1518 c⁄° 
buf„r_li°
 *
c⁄fig
,

1519 
›ti⁄_≥rmissi⁄s_mask
,

1520 *
›ti⁄_ty≥s_found
)

1522 i‡(
c⁄fig
)

1524 
buf„r_íåy
 *
be
;

1526 
be
 = 
c⁄fig
->
hód
; bê!
NULL
; bêbe->
√xt
)

1528 c⁄° *
›t
 = 
	`BSTR
(&
be
->
buf
);

1529 
	`›ti⁄s_°rög_imp‹t
 (&
mi
->
c⁄ãxt
.
›ti⁄s
,

1530 
›t
,

1531 
D_IMPORT_ERRORS
|
M_OPTERR
,

1532 
›ti⁄_≥rmissi⁄s_mask
,

1533 
›ti⁄_ty≥s_found
,

1534 
mi
->
c⁄ãxt
.
c2
.
es
);

1543 
	`mu…i_£À˘_vútuÆ_addr
 (
m
, 
mi
);

1544 
	`mu…i_£t_vútuÆ_addr_ív
 (
m
, 
mi
);

1546 
	}
}

1551 
	$mu…i_˛õ¡_c⁄√˘_£ãnv
 (
mu…i_c⁄ãxt
 *
m
,

1552 
mu…i_ö°™˚
 *
mi
)

1554 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1557 
	`£ãnv_°r
 (
mi
->
c⁄ãxt
.
c2
.
es
, "comm⁄_«me", 
	`és_comm⁄_«me
 (mi->c⁄ãxt.c2.
és_mu…i
, 
åue
));

1560 
	`£ãnv_åu°ed
 (
mi
->
c⁄ãxt
.
c2
.
es
, 
	`gë_lök_sockë_öfo
 (&mi->context));

1563 
	`mu…i_£t_vútuÆ_addr_ív
 (
m
, 
mi
);

1567 c⁄° *
¸óãd_ascii
 = 
	`time_°rög
 (
mi
->
¸óãd
, 0, 
Ál£
, &
gc
);

1568 
	`£ãnv_°r
 (
mi
->
c⁄ãxt
.
c2
.
es
, "time_ascii", 
¸óãd_ascii
);

1569 
	`£ãnv_unsig√d
 (
mi
->
c⁄ãxt
.
c2
.
es
, "time_unix", ()mi->
¸óãd
);

1572 
	`gc_‰ì
 (&
gc
);

1573 
	}
}

1585 
	$mu…i_c⁄√˘i⁄_e°ablished
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
)

1587 i‡(
	`és_authítiˇti⁄_°©us
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 0Ë=
TLS_AUTHENTICATION_SUCCEEDED
)

1589 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1590 
›ti⁄_ty≥s_found
 = 0;

1592 c⁄° 
›ti⁄_≥rmissi⁄s_mask
 =

1593 
OPT_P_INSTANCE


1594 | 
OPT_P_INHERIT


1595 | 
OPT_P_PUSH


1596 | 
OPT_P_TIMER


1597 | 
OPT_P_CONFIG


1598 | 
OPT_P_ECHO


1599 | 
OPT_P_COMP


1600 | 
OPT_P_SOCKFLAGS
;

1602 
cc_suc˚eded
 = 
åue
;

1603 
cc_suc˚eded_cou¡
 = 0;

1605 
	`ASSERT
 (
mi
->
c⁄ãxt
.
c1
.
tu¡≠
);

1608 
	`és_lock_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
);

1609 
	`és_lock_˚π_hash_£t
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
);

1612 
	`gíî©e_¥efix
 (
mi
);

1615 i‡(!
mi
->
c⁄ãxt
.
›ti⁄s
.
du∂iˇã_˙
)

1616 
	`mu…i_dñëe_dup
 (
m
, 
mi
);

1619 
mi
->
vaddr_h™dÀ
 = -1;

1625 i‡(
mi
->
c⁄ãxt
.
›ti⁄s
.
˛õ¡_c⁄fig_dú
)

1627 c⁄° *
ccd_fûe
;

1629 
ccd_fûe
 = 
	`gí_∑th
 (
mi
->
c⁄ãxt
.
›ti⁄s
.
˛õ¡_c⁄fig_dú
,

1630 
	`és_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
Ál£
),

1631 &
gc
);

1634 i‡(
	`ã°_fûe
 (
ccd_fûe
))

1636 
	`›ti⁄s_£rvî_imp‹t
 (&
mi
->
c⁄ãxt
.
›ti⁄s
,

1637 
ccd_fûe
,

1638 
D_IMPORT_ERRORS
|
M_OPTERR
,

1639 
›ti⁄_≥rmissi⁄s_mask
,

1640 &
›ti⁄_ty≥s_found
,

1641 
mi
->
c⁄ãxt
.
c2
.
es
);

1645 
ccd_fûe
 = 
	`gí_∑th
 (
mi
->
c⁄ãxt
.
›ti⁄s
.
˛õ¡_c⁄fig_dú
,

1646 
CCD_DEFAULT
,

1647 &
gc
);

1649 i‡(
	`ã°_fûe
 (
ccd_fûe
))

1651 
	`›ti⁄s_£rvî_imp‹t
 (&
mi
->
c⁄ãxt
.
›ti⁄s
,

1652 
ccd_fûe
,

1653 
D_IMPORT_ERRORS
|
M_OPTERR
,

1654 
›ti⁄_≥rmissi⁄s_mask
,

1655 &
›ti⁄_ty≥s_found
,

1656 
mi
->
c⁄ãxt
.
c2
.
es
);

1665 
	`mu…i_£À˘_vútuÆ_addr
 (
m
, 
mi
);

1668 
	`mu…i_˛õ¡_c⁄√˘_£ãnv
 (
m
, 
mi
);

1670 #ifde‡
ENABLE_PLUGIN


1676 i‡(
	`∂ugö_deföed
 (
mi
->
c⁄ãxt
.
∂ugös
, 
OPENVPN_PLUGIN_CLIENT_CONNECT
))

1678 
¨gv
árgv = 
	`¨gv_√w
 ();

1679 c⁄° *
dc_fûe
 = 
	`¸óã_ãmp_fûe
 (
mi
->
c⁄ãxt
.
›ti⁄s
.
tmp_dú
, "cc", &
gc
);

1681 if–!
dc_fûe
 ) {

1682 
cc_suc˚eded
 = 
Ál£
;

1683 
s¸ùt_dïr_Áûed
;

1686 
	`¨gv_¥ötf
 (&
¨gv
, "%s", 
dc_fûe
);

1687 i‡(
	`∂ugö_ˇŒ
 (
mi
->
c⁄ãxt
.
∂ugös
, 
OPENVPN_PLUGIN_CLIENT_CONNECT
, &
¨gv
, 
NULL
, mi->c⁄ãxt.
c2
.
es
Ë!
OPENVPN_PLUGIN_FUNC_SUCCESS
)

1689 
	`msg
 (
M_WARN
, "WARNING: client-connectÖlugin call failed");

1690 
cc_suc˚eded
 = 
Ál£
;

1694 
	`mu…i_˛õ¡_c⁄√˘_po°
 (
m
, 
mi
, 
dc_fûe
, 
›ti⁄_≥rmissi⁄s_mask
, &
›ti⁄_ty≥s_found
);

1695 ++
cc_suc˚eded_cou¡
;

1698 i‡(!
	`∂©f‹m_u∆ök
 (
dc_fûe
))

1699 
	`msg
 (
D_MULTI_ERRORS
, "MULTI:Öroblem deletingÅemporary file: %s",

1700 
dc_fûe
);

1702 
s¸ùt_dïr_Áûed
:

1703 
	`¨gv_ª£t
 (&
¨gv
);

1707 i‡(
	`∂ugö_deföed
 (
mi
->
c⁄ãxt
.
∂ugös
, 
OPENVPN_PLUGIN_CLIENT_CONNECT_V2
))

1709 
∂ugö_ªtu∫
 
¥
;

1711 
	`∂ugö_ªtu∫_öô
 (&
¥
);

1713 i‡(
	`∂ugö_ˇŒ
 (
mi
->
c⁄ãxt
.
∂ugös
, 
OPENVPN_PLUGIN_CLIENT_CONNECT_V2
, 
NULL
, &
¥
, mi->c⁄ãxt.
c2
.
es
Ë!
OPENVPN_PLUGIN_FUNC_SUCCESS
)

1715 
	`msg
 (
M_WARN
, "WARNING: client-connect-v2Ölugin call failed");

1716 
cc_suc˚eded
 = 
Ál£
;

1720 
	`mu…i_˛õ¡_c⁄√˘_po°_∂ugö
 (
m
, 
mi
, &
¥
, 
›ti⁄_≥rmissi⁄s_mask
, &
›ti⁄_ty≥s_found
);

1721 ++
cc_suc˚eded_cou¡
;

1724 
	`∂ugö_ªtu∫_‰ì
 (&
¥
);

1731 i‡(
mi
->
c⁄ãxt
.
›ti⁄s
.
˛õ¡_c⁄√˘_s¸ùt
 && 
cc_suc˚eded
)

1733 
¨gv
árgv = 
	`¨gv_√w
 ();

1734 c⁄° *
dc_fûe
 = 
NULL
;

1736 
	`£ãnv_°r
 (
mi
->
c⁄ãxt
.
c2
.
es
, "script_type", "client-connect");

1738 
dc_fûe
 = 
	`¸óã_ãmp_fûe
 (
mi
->
c⁄ãxt
.
›ti⁄s
.
tmp_dú
, "cc", &
gc
);

1739 if–!
dc_fûe
 ) {

1740 
cc_suc˚eded
 = 
Ál£
;

1741 
s¸ùt_Áûed
;

1744 
	`¨gv_¥ötf
 (&
¨gv
, "%sc %s",

1745 
mi
->
c⁄ãxt
.
›ti⁄s
.
˛õ¡_c⁄√˘_s¸ùt
,

1746 
dc_fûe
);

1748 i‡(
	`›ív≤_run_s¸ùt
 (&
¨gv
, 
mi
->
c⁄ãxt
.
c2
.
es
, 0, "--client-connect"))

1750 
	`mu…i_˛õ¡_c⁄√˘_po°
 (
m
, 
mi
, 
dc_fûe
, 
›ti⁄_≥rmissi⁄s_mask
, &
›ti⁄_ty≥s_found
);

1751 ++
cc_suc˚eded_cou¡
;

1754 
cc_suc˚eded
 = 
Ál£
;

1756 i‡(!
	`∂©f‹m_u∆ök
 (
dc_fûe
))

1757 
	`msg
 (
D_MULTI_ERRORS
, "MULTI:Öroblem deletingÅemporary file: %s",

1758 
dc_fûe
);

1760 
s¸ùt_Áûed
:

1761 
	`¨gv_ª£t
 (&
¨gv
);

1767 #ifde‡
MANAGEMENT_DEF_AUTH


1768 i‡(
cc_suc˚eded
 && 
mi
->
cc_c⁄fig
)

1770 
	`mu…i_˛õ¡_c⁄√˘_mda
 (
m
, 
mi
, mi->
cc_c⁄fig
, 
›ti⁄_≥rmissi⁄s_mask
, &
›ti⁄_ty≥s_found
);

1771 ++
cc_suc˚eded_cou¡
;

1779 i‡(
mi
->
c⁄ãxt
.
›ti⁄s
.
dißbÀ
)

1781 
	`msg
 (
D_MULTI_ERRORS
, "MULTI: client has beenÑejected dueÅo 'disable' directive");

1782 
cc_suc˚eded
 = 
Ál£
;

1785 i‡(
cc_suc˚eded
)

1790 
	`do_de„ºed_›ti⁄s
 (&
mi
->
c⁄ãxt
, 
›ti⁄_ty≥s_found
);

1795 i‡(!
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_deföed
)

1797 
	`msg
 (
D_MULTI_ERRORS
, "MULTI:Ço dynamic or staticÑemote --ifconfigáddress isávailable for %s",

1798 
	`mu…i_ö°™˚_°rög
 (
mi
, 
Ál£
, &
gc
));

1804 i‡(!
	`ifc⁄fig_push_c⁄°øöt_ßtisfõd
 (&
mi
->
c⁄ãxt
))

1807 
	`msg
 (
D_MULTI_ERRORS
, "MULTI ERROR:Örimary virtual IP for %s (%s) violatesÅunnelÇetwork/netmask constraint (%s/%s)",

1808 
	`mu…i_ö°™˚_°rög
 (
mi
, 
Ál£
, &
gc
),

1809 
	`¥öt_ö_addr_t
 (
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_loˇl
, 0, &
gc
),

1810 
	`¥öt_ö_addr_t
 (
mi
->
c⁄ãxt
.
›ti⁄s
.
push_ifc⁄fig_c⁄°øöt_√tw‹k
, 0, &
gc
),

1811 
	`¥öt_ö_addr_t
 (
mi
->
c⁄ãxt
.
›ti⁄s
.
push_ifc⁄fig_c⁄°øöt_√tmask
, 0, &
gc
));

1818 i‡(
	`TUNNEL_TYPE
 (
mi
->
c⁄ãxt
.
c1
.
tu¡≠
Ë=
DEV_TYPE_TUN
)

1820 i‡(
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_deföed
)

1822 
	`mu…i_À¨n_ö_addr_t
 (
m
, 
mi
, mi->
c⁄ãxt
.
c2
.
push_ifc⁄fig_loˇl
, -1, 
åue
);

1823 
	`msg
 (
D_MULTI_LOW
, "MULTI:Örimary virtual IP for %s: %s",

1824 
	`mu…i_ö°™˚_°rög
 (
mi
, 
Ál£
, &
gc
),

1825 
	`¥öt_ö_addr_t
 (
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_loˇl
, 0, &
gc
));

1828 i‡(
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ùv6_deföed
)

1830 
	`mu…i_À¨n_ö6_addr
 (
m
, 
mi
, mi->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ùv6_loˇl
, -1, 
åue
);

1832 
	`msg
 (
D_MULTI_LOW
, "MULTI:Örimary virtual IPv6 for %s: %s",

1833 
	`mu…i_ö°™˚_°rög
 (
mi
, 
Ál£
, &
gc
),

1834 
	`¥öt_ö6_addr
 (
mi
->
c⁄ãxt
.
c2
.
push_ifc⁄fig_ùv6_loˇl
, 0, &
gc
));

1839 
	`mu…i_add_úouãs
 (
m
, 
mi
);

1846 
	`ªmove_úouãs_‰om_push_rouã_li°
 (&
mi
->
c⁄ãxt
.
›ti⁄s
);

1848 i‡(
mi
->
c⁄ãxt
.
›ti⁄s
.
úouãs
)

1850 
	`msg
 (
D_MULTI_ERRORS
, "MULTI: --iroute optionsÑejected for %s -- iroute only works withÅun-styleÅunnels",

1851 
	`mu…i_ö°™˚_°rög
 (
mi
, 
Ál£
, &
gc
));

1855 
mi
->
ªp‹tög_addr
 = mi->
c⁄ãxt
.
c2
.
push_ifc⁄fig_loˇl
;

1858 
mi
->
c⁄ãxt
.
c2
.
c⁄ãxt_auth
 = 
CAS_SUCCEEDED
;

1863 
mi
->
c⁄ãxt
.
c2
.
c⁄ãxt_auth
 = 
cc_suc˚eded_cou¡
 ? 
CAS_PARTIAL
 : 
CAS_FAILED
;

1867 
mi
->
c⁄√˘i⁄_e°ablished_Êag
 = 
åue
;

1870 ++
m
->
n_˛õ¡s
;

1871 
	`upd©e_m°©_n_˛õ¡s
(
m
->
n_˛õ¡s
);

1872 --
mi
->
n_˛õ¡s_dñè
;

1874 #ifde‡
MANAGEMENT_DEF_AUTH


1875 i‡(
m™agemít
)

1876 
	`m™agemít_c⁄√˘i⁄_e°ablished
 (
m™agemít
, &
mi
->
c⁄ãxt
.
c2
.
mda_c⁄ãxt
, mi->c⁄ãxt.c2.
es
);

1879 
	`gc_‰ì
 (&
gc
);

1885 
mi
->
c⁄ãxt
.
c2
.
push_ª∂y_de„ºed
 = 
Ál£
;

1886 
	}
}

1893 
	$mu…i_add_mbuf
 (
mu…i_c⁄ãxt
 *
m
,

1894 
mu…i_ö°™˚
 *
mi
,

1895 
mbuf_buf„r
 *
mb
)

1897 i‡(
	`mu…i_ouçut_queue_ªady
 (
m
, 
mi
))

1899 
mbuf_ôem
 
ôem
;

1900 
ôem
.
buf„r
 = 
mb
;

1901 
ôem
.
ö°™˚
 = 
mi
;

1902 
	`mbuf_add_ôem
 (
m
->
mbuf
, &
ôem
);

1906 
	`msg
 (
D_MULTI_DROPPED
, "MULTI:Öacket dropped dueÅo output saturation (multi_add_mbuf)");

1908 
	}
}

1913 
ölöe
 

1914 
	$mu…i_uniˇ°
 (
mu…i_c⁄ãxt
 *
m
,

1915 c⁄° 
buf„r
 *
buf
,

1916 
mu…i_ö°™˚
 *
mi
)

1918 
mbuf_buf„r
 *
mb
;

1920 i‡(
	`BLEN
 (
buf
) > 0)

1922 
mb
 = 
	`mbuf_Æloc_buf
 (
buf
);

1923 
mb
->
Êags
 = 
MF_UNICAST
;

1924 
	`mu…i_add_mbuf
 (
m
, 
mi
, 
mb
);

1925 
	`mbuf_‰ì_buf
 (
mb
);

1927 
	}
}

1933 
	$mu…i_bˇ°
 (
mu…i_c⁄ãxt
 *
m
,

1934 c⁄° 
buf„r
 *
buf
,

1935 c⁄° 
mu…i_ö°™˚
 *
£ndî_ö°™˚
,

1936 c⁄° 
mrouã_addr
 *
£ndî_addr
)

1938 
hash_ôî©‹
 
hi
;

1939 
hash_ñemít
 *
he
;

1940 
mu…i_ö°™˚
 *
mi
;

1941 
mbuf_buf„r
 *
mb
;

1943 i‡(
	`BLEN
 (
buf
) > 0)

1945 
	`≥rf_push
 (
PERF_MULTI_BCAST
);

1946 #ifde‡
MULTI_DEBUG_EVENT_LOOP


1947 
	`¥ötf
 ("BCASTÜí=%d\n", 
	`BLEN
 (
buf
));

1949 
mb
 = 
	`mbuf_Æloc_buf
 (
buf
);

1950 
	`hash_ôî©‹_öô
 (
m
->
ôî
, &
hi
);

1952 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

1954 
mi
 = (
mu…i_ö°™˚
 *Ë
he
->
vÆue
;

1955 i‡(
mi
 !
£ndî_ö°™˚
 && !mi->
hÆt
)

1957 #ifde‡
ENABLE_PF


1958 i‡(
£ndî_ö°™˚
)

1960 i‡(!
	`pf_c2c_ã°
 (&
£ndî_ö°™˚
->
c⁄ãxt
, &
mi
->context, "bcast_c2c"))

1962 
	`msg
 (
D_PF_DROPPED_BCAST
, "PF: client[%s] -> client[%s]Öacket dropped by BCASTÖacket filter",

1963 
	`mi_¥efix
 (
£ndî_ö°™˚
),

1964 
	`mi_¥efix
 (
mi
));

1968 i‡(
£ndî_addr
)

1970 i‡(!
	`pf_addr_ã°
 (&
mi
->
c⁄ãxt
, 
£ndî_addr
, "bcast_src_addr"))

1972 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1973 
	`msg
 (
D_PF_DROPPED_BCAST
, "PF:áddr[%s] -> client[%s]Öacket dropped by BCASTÖacket filter",

1974 
	`mrouã_addr_¥öt_ex
 (
£ndî_addr
, 
MAPF_SHOW_ARP
, &
gc
),

1975 
	`mi_¥efix
 (
mi
));

1976 
	`gc_‰ì
 (&
gc
);

1981 
	`mu…i_add_mbuf
 (
m
, 
mi
, 
mb
);

1985 
	`hash_ôî©‹_‰ì
 (&
hi
);

1986 
	`mbuf_‰ì_buf
 (
mb
);

1987 
	`≥rf_p›
 ();

1989 
	}
}

2002 
ölöe
 

2003 
	$compuã_wakeup_sigma
 (c⁄° 
timevÆ
 *
dñè
)

2005 i‡(
dñè
->
tv_£c
 < 1)

2008  
dñè
->
tv_u£c
 >> 3;

2013 i‡(
dñè
->
tv_£c
 < 600)

2014  
dñè
->
tv_£c
 << 17;

2018 
	}
}

2021 
	$mu…i_scheduÀ_c⁄ãxt_wakeup
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
)

2024 
	`ASSERT
 (!
	`›ív≤_gëtimeofday
 (&
mi
->
wakeup
, 
NULL
));

2025 
	`tv_add
 (&
mi
->
wakeup
, &mi->
c⁄ãxt
.
c2
.
timevÆ
);

2028 
	`scheduÀ_add_íåy
 (
m
->
scheduÀ
,

2029 (
scheduÀ_íåy
 *Ë
mi
,

2030 &
mi
->
wakeup
,

2031 
	`compuã_wakeup_sigma
 (&
mi
->
c⁄ãxt
.
c2
.
timevÆ
));

2032 
	}
}

2041 
boﬁ


2042 
	$mu…i_¥o˚ss_po°
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
, c⁄° 
Êags
)

2044 
boﬁ
 
ªt
 = 
åue
;

2046 i‡(!
	`IS_SIG
 (&
mi
->
c⁄ãxt
Ë&& ((
Êags
 & 
MPP_PRE_SELECT
Ë|| ((Êag†& 
MPP_CONDITIONAL_PRE_SELECT
Ë&& !
	`ANY_OUT
 (&mi->context))))

2050 
	`¥e_£À˘
 (&
mi
->
c⁄ãxt
);

2052 i‡(!
	`IS_SIG
 (&
mi
->
c⁄ãxt
))

2055 
	`mu…i_scheduÀ_c⁄ãxt_wakeup
(
m
, 
mi
);

2059 i‡(!
mi
->
c⁄√˘i⁄_e°ablished_Êag
 && 
	`CONNECTION_ESTABLISHED
 (&mi->
c⁄ãxt
))

2060 
	`mu…i_c⁄√˘i⁄_e°ablished
 (
m
, 
mi
);

2064 i‡(
	`IS_SIG
 (&
mi
->
c⁄ãxt
))

2066 i‡(
Êags
 & 
MPP_CLOSE_ON_SIGNAL
)

2068 
	`mu…i_˛o£_ö°™˚_⁄_sig«l
 (
m
, 
mi
);

2069 
ªt
 = 
Ál£
;

2075 
	`mu…i_£t_≥ndög
 (
m
, 
	`ANY_OUT
 (&
mi
->
c⁄ãxt
Ë? mò: 
NULL
);

2077 #ifde‡
MULTI_DEBUG_EVENT_LOOP


2078 
	`¥ötf
 ("POST %s[%d]Åo=%dÜo=%d/%d w=%d/%d\n",

2079 
	`id
(
mi
),

2080 (Ë(
mi
 =
m
->
≥ndög
),

2081 
mi
 ? mi->
c⁄ãxt
.
c2
.
to_tun
.
Àn
 : -1,

2082 
mi
 ? mi->
c⁄ãxt
.
c2
.
to_lök
.
Àn
 : -1,

2083 (
mi
 && mi->
c⁄ãxt
.
c2
.
‰agmít
Ë? mi->c⁄ãxt.c2.‰agmít->
outgoög
.
Àn
 : -1,

2084 ()
mi
->
c⁄ãxt
.
c2
.
timevÆ
.
tv_£c
,

2085 ()
mi
->
c⁄ãxt
.
c2
.
timevÆ
.
tv_u£c
);

2089 i‡((
Êags
 & 
MPP_RECORD_TOUCH
Ë&& 
m
->
mµ_touched
)

2090 *
m
->
mµ_touched
 = 
mi
;

2092  
ªt
;

2093 
	}
}

2099 
boﬁ


2100 
	$mu…i_¥o˚ss_öcomög_lök
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
ö°™˚
, c⁄° 
mµ_Êags
)

2102 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2104 
c⁄ãxt
 *
c
;

2105 
mrouã_addr
 
§c
, 
de°
;

2106 
mrouã_Êags
;

2107 
mu…i_ö°™˚
 *
mi
;

2108 
boﬁ
 
ªt
 = 
åue
;

2110 i‡(
m
->
≥ndög
)

2111  
åue
;

2113 i‡(!
ö°™˚
)

2115 #ifde‡
MULTI_DEBUG_EVENT_LOOP


2116 
	`¥ötf
 ("TCP/UDP -> TUN [%d]\n", 
	`BLEN
 (&
m
->
t›
.
c2
.
buf
));

2118 
	`mu…i_£t_≥ndög
 (
m
, 
	`mu…i_gë_¸óã_ö°™˚_udp
 (m));

2121 
	`mu…i_£t_≥ndög
 (
m
, 
ö°™˚
);

2123 i‡(
m
->
≥ndög
)

2125 
	`£t_¥efix
 (
m
->
≥ndög
);

2128 
c
 = &
m
->
≥ndög
->
c⁄ãxt
;

2130 i‡(!
ö°™˚
)

2133 
c
->
c2
.
buf
 = 
m
->
t›
.c2.buf;

2136 
c
->
c2
.
‰om
 = 
m
->
t›
.c2.from;

2139 i‡(
	`BLEN
 (&
c
->
c2
.
buf
) > 0)

2142 
	`¥o˚ss_öcomög_lök
 (
c
);

2144 i‡(
	`TUNNEL_TYPE
 (
m
->
t›
.
c1
.
tu¡≠
Ë=
DEV_TYPE_TUN
)

2147 
mrouã_Êags
 = 
	`mrouã_exåa˘_addr_‰om_∑ckë
 (&
§c
,

2148 &
de°
,

2149 
NULL
,

2150 
NULL
,

2151 &
c
->
c2
.
to_tun
,

2152 
DEV_TYPE_TUN
);

2155 i‡(!(
mrouã_Êags
 & 
MROUTE_EXTRACT_SUCCEEDED
))

2157 
c
->
c2
.
to_tun
.
Àn
 = 0;

2160 i‡(
	`mu…i_gë_ö°™˚_by_vútuÆ_addr
 (
m
, &
§c
, 
åue
Ë!m->
≥ndög
)

2163 i‡–(
§c
.
ty≥
 & 
MR_ADDR_MASK
Ë=
MR_ADDR_IPV6
 &&

2164 
§c
.
addr
[0] == 0xfe && src.addr[1] == 0x80 )

2170 
	`msg
 (
D_MULTI_DROPPED
, "MULTI: bad sourceáddress from client [%s],Öacket dropped",

2171 
	`mrouã_addr_¥öt
 (&
§c
, &
gc
));

2173 
c
->
c2
.
to_tun
.
Àn
 = 0;

2176 i‡(
m
->
íabÀ_c2c
)

2179 i‡(
mrouã_Êags
 & 
MROUTE_EXTRACT_MCAST
)

2182 
	`mu…i_bˇ°
 (
m
, &
c
->
c2
.
to_tun
, m->
≥ndög
, 
NULL
);

2186 
	`ASSERT
 (!(
mrouã_Êags
 & 
MROUTE_EXTRACT_BCAST
));

2187 
mi
 = 
	`mu…i_gë_ö°™˚_by_vútuÆ_addr
 (
m
, &
de°
, 
åue
);

2190 i‡(
mi
)

2192 #ifde‡
ENABLE_PF


2193 i‡(!
	`pf_c2c_ã°
 (
c
, &
mi
->
c⁄ãxt
, "tun_c2c"))

2195 
	`msg
 (
D_PF_DROPPED
, "PF: client -> client[%s]Öacket dropped by TUNÖacket filter",

2196 
	`mi_¥efix
 (
mi
));

2201 
	`mu…i_uniˇ°
 (
m
, &
c
->
c2
.
to_tun
, 
mi
);

2202 
	`ªgi°î_a˘ivôy
 (
c
, 
	`BLEN
(&c->
c2
.
to_tun
));

2204 
c
->
c2
.
to_tun
.
Àn
 = 0;

2208 #ifde‡
ENABLE_PF


2209 i‡(
c
->
c2
.
to_tun
.
Àn
 && !
	`pf_addr_ã°
 (c, &
de°
, "tun_dest_addr"))

2211 
	`msg
 (
D_PF_DROPPED
, "PF: client ->áddr[%s]Öacket dropped by TUNÖacket filter",

2212 
	`mrouã_addr_¥öt_ex
 (&
de°
, 
MAPF_SHOW_ARP
, &
gc
));

2213 
c
->
c2
.
to_tun
.
Àn
 = 0;

2217 i‡(
	`TUNNEL_TYPE
 (
m
->
t›
.
c1
.
tu¡≠
Ë=
DEV_TYPE_TAP
)

2219 #ifde‡
ENABLE_PF


2220 
mrouã_addr
 
ede°
;

2221 
	`mrouã_addr_ª£t
 (&
ede°
);

2224 
mrouã_Êags
 = 
	`mrouã_exåa˘_addr_‰om_∑ckë
 (&
§c
,

2225 &
de°
,

2226 
NULL
,

2227 #ifde‡
ENABLE_PF


2228 &
ede°
,

2230 
NULL
,

2232 &
c
->
c2
.
to_tun
,

2233 
DEV_TYPE_TAP
);

2235 i‡(
mrouã_Êags
 & 
MROUTE_EXTRACT_SUCCEEDED
)

2237 i‡(
	`mu…i_À¨n_addr
 (
m
, m->
≥ndög
, &
§c
, 0) == m->pending)

2240 i‡(
m
->
íabÀ_c2c
)

2242 i‡(
mrouã_Êags
 & (
MROUTE_EXTRACT_BCAST
|
MROUTE_EXTRACT_MCAST
))

2244 
	`mu…i_bˇ°
 (
m
, &
c
->
c2
.
to_tun
, m->
≥ndög
, 
NULL
);

2248 
mi
 = 
	`mu…i_gë_ö°™˚_by_vútuÆ_addr
 (
m
, &
de°
, 
Ál£
);

2251 i‡(
mi
)

2253 #ifde‡
ENABLE_PF


2254 i‡(!
	`pf_c2c_ã°
 (
c
, &
mi
->
c⁄ãxt
, "tap_c2c"))

2256 
	`msg
 (
D_PF_DROPPED
, "PF: client -> client[%s]Öacket dropped by TAPÖacket filter",

2257 
	`mi_¥efix
 (
mi
));

2262 
	`mu…i_uniˇ°
 (
m
, &
c
->
c2
.
to_tun
, 
mi
);

2263 
	`ªgi°î_a˘ivôy
 (
c
, 
	`BLEN
(&c->
c2
.
to_tun
));

2265 
c
->
c2
.
to_tun
.
Àn
 = 0;

2269 #ifde‡
ENABLE_PF


2270 i‡(
c
->
c2
.
to_tun
.
Àn
 && !
	`pf_addr_ã°
 (c, &
ede°
, "tap_dest_addr"))

2272 
	`msg
 (
D_PF_DROPPED
, "PF: client ->áddr[%s]Öacket dropped by TAPÖacket filter",

2273 
	`mrouã_addr_¥öt_ex
 (&
ede°
, 
MAPF_SHOW_ARP
, &
gc
));

2274 
c
->
c2
.
to_tun
.
Àn
 = 0;

2280 
	`msg
 (
D_MULTI_DROPPED
, "MULTI: bad sourceáddress from client [%s],Öacket dropped",

2281 
	`mrouã_addr_¥öt
 (&
§c
, &
gc
));

2282 
c
->
c2
.
to_tun
.
Àn
 = 0;

2287 
c
->
c2
.
to_tun
.
Àn
 = 0;

2293 
ªt
 = 
	`mu…i_¥o˚ss_po°
 (
m
, m->
≥ndög
, 
mµ_Êags
);

2295 
	`˛ór_¥efix
 ();

2298 
	`gc_‰ì
 (&
gc
);

2299  
ªt
;

2300 
	}
}

2306 
boﬁ


2307 
	$mu…i_¥o˚ss_öcomög_tun
 (
mu…i_c⁄ãxt
 *
m
, c⁄° 
mµ_Êags
)

2309 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2310 
boﬁ
 
ªt
 = 
åue
;

2312 i‡(
	`BLEN
 (&
m
->
t›
.
c2
.
buf
) > 0)

2314 
mrouã_Êags
;

2315 
mrouã_addr
 
§c
, 
de°
;

2316 c⁄° 
dev_ty≥
 = 
	`TUNNEL_TYPE
 (
m
->
t›
.
c1
.
tu¡≠
);

2318 #ifde‡
ENABLE_PF


2319 
mrouã_addr
 
e§c
, *
e1
, *
e2
;

2320 i‡(
dev_ty≥
 =
DEV_TYPE_TUN
)

2322 
e1
 = 
NULL
;

2323 
e2
 = &
§c
;

2327 
e1
 = 
e2
 = &
e§c
;

2328 
	`mrouã_addr_ª£t
 (&
e§c
);

2332 #ifde‡
MULTI_DEBUG_EVENT_LOOP


2333 
	`¥ötf
 ("TUN -> TCP/UDP [%d]\n", 
	`BLEN
 (&
m
->
t›
.
c2
.
buf
));

2336 i‡(
m
->
≥ndög
)

2337  
åue
;

2344 
mrouã_Êags
 = 
	`mrouã_exåa˘_addr_‰om_∑ckë
 (&
§c
,

2345 &
de°
,

2346 #ifde‡
ENABLE_PF


2347 
e1
,

2349 
NULL
,

2351 
NULL
,

2352 &
m
->
t›
.
c2
.
buf
,

2353 
dev_ty≥
);

2355 i‡(
mrouã_Êags
 & 
MROUTE_EXTRACT_SUCCEEDED
)

2357 
c⁄ãxt
 *
c
;

2360 i‡(
mrouã_Êags
 & (
MROUTE_EXTRACT_BCAST
|
MROUTE_EXTRACT_MCAST
))

2363 #ifde‡
ENABLE_PF


2364 
	`mu…i_bˇ°
 (
m
, &m->
t›
.
c2
.
buf
, 
NULL
, 
e2
);

2366 
	`mu…i_bˇ°
 (
m
, &m->
t›
.
c2
.
buf
, 
NULL
, NULL);

2371 
	`mu…i_£t_≥ndög
 (
m
, 
	`mu…i_gë_ö°™˚_by_vútuÆ_addr
 (m, &
de°
, 
dev_ty≥
 =
DEV_TYPE_TUN
));

2373 i‡(
m
->
≥ndög
)

2376 
c
 = &
m
->
≥ndög
->
c⁄ãxt
;

2378 
	`£t_¥efix
 (
m
->
≥ndög
);

2380 #ifde‡
ENABLE_PF


2381 i‡(!
	`pf_addr_ã°
 (
c
, 
e2
, "tun_tap_src_addr"))

2383 
	`msg
 (
D_PF_DROPPED
, "PF:áddr[%s] -> clientÖacket dropped byÖacket filter",

2384 
	`mrouã_addr_¥öt_ex
 (&
§c
, 
MAPF_SHOW_ARP
, &
gc
));

2385 
	`buf_ª£t_Àn
 (&
c
->
c2
.
buf
);

2390 i‡(
	`mu…i_ouçut_queue_ªady
 (
m
, m->
≥ndög
))

2393 
c
->
c2
.
buf
 = 
m
->
t›
.c2.buf;

2398 
	`msg
 (
D_MULTI_DROPPED
, "MULTI:Öacket dropped dueÅo output saturation (multi_process_incoming_tun)");

2399 
	`buf_ª£t_Àn
 (&
c
->
c2
.
buf
);

2404 
	`¥o˚ss_öcomög_tun
 (
c
);

2407 
ªt
 = 
	`mu…i_¥o˚ss_po°
 (
m
, m->
≥ndög
, 
mµ_Êags
);

2409 
	`˛ór_¥efix
 ();

2414 
	`gc_‰ì
 (&
gc
);

2415  
ªt
;

2416 
	}
}

2422 
mu…i_ö°™˚
 *

2423 
	$mu…i_gë_queue
 (
mbuf_£t
 *
ms
)

2425 
mbuf_ôem
 
ôem
;

2427 i‡(
	`mbuf_exåa˘_ôem
 (
ms
, &
ôem
))

2429 
pù_Êags
 = 
PIPV4_PASSTOS
;

2431 
	`£t_¥efix
 (
ôem
.
ö°™˚
);

2432 
ôem
.
ö°™˚
->
c⁄ãxt
.
c2
.
buf
 = iãm.
buf„r
->buf;

2433 i‡(
ôem
.
buf„r
->
Êags
 & 
MF_UNICAST
)

2434 
pù_Êags
 |
PIP_MSSFIX
;

2435 
	`¥o˚ss_ù_hódî
 (&
ôem
.
ö°™˚
->
c⁄ãxt
, 
pù_Êags
, &ôem.ö°™˚->c⁄ãxt.
c2
.
buf
);

2436 
	`í¸y±_sign
 (&
ôem
.
ö°™˚
->
c⁄ãxt
, 
åue
);

2437 
	`mbuf_‰ì_buf
 (
ôem
.
buf„r
);

2439 
	`dmsg
 (
D_MULTI_DEBUG
, "MULTI: C2C/MCAST/BCAST");

2441 
	`˛ór_¥efix
 ();

2442  
ôem
.
ö°™˚
;

2446  
NULL
;

2448 
	}
}

2454 
boﬁ


2455 
	$mu…i_¥o˚ss_timeout
 (
mu…i_c⁄ãxt
 *
m
, c⁄° 
mµ_Êags
)

2457 
boﬁ
 
ªt
 = 
åue
;

2459 #ifde‡
MULTI_DEBUG_EVENT_LOOP


2460 
	`¥ötf
 ("%†-> TIMEOUT\n", 
	`id
(
m
->
óæõ°_wakeup
));

2464 i‡(
m
->
óæõ°_wakeup
)

2466 
	`£t_¥efix
 (
m
->
óæõ°_wakeup
);

2467 
ªt
 = 
	`mu…i_¥o˚ss_po°
 (
m
, m->
óæõ°_wakeup
, 
mµ_Êags
);

2468 
m
->
óæõ°_wakeup
 = 
NULL
;

2469 
	`˛ór_¥efix
 ();

2471  
ªt
;

2472 
	}
}

2478 
	$mu…i_¥o˚ss_dr›_outgoög_tun
 (
mu…i_c⁄ãxt
 *
m
, c⁄° 
mµ_Êags
)

2480 
mu…i_ö°™˚
 *
mi
 = 
m
->
≥ndög
;

2482 
	`ASSERT
 (
mi
);

2484 
	`£t_¥efix
 (
mi
);

2486 
	`msg
 (
D_MULTI_ERRORS
, "MULTI: Outgoing TUN queue full, droppedÖacketÜen=%d",

2487 
mi
->
c⁄ãxt
.
c2
.
to_tun
.
Àn
);

2489 
	`buf_ª£t
 (&
mi
->
c⁄ãxt
.
c2
.
to_tun
);

2491 
	`mu…i_¥o˚ss_po°
 (
m
, 
mi
, 
mµ_Êags
);

2492 
	`˛ór_¥efix
 ();

2493 
	}
}

2500 
	$rouã_quŸa_ex˚eded
 (c⁄° 
mu…i_c⁄ãxt
 *
m
, c⁄° 
mu…i_ö°™˚
 *
mi
)

2502 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2503 
	`msg
 (
D_ROUTE_QUOTA
, "MULTI ROUTE:Ñoute quota (%d)Éxceeded for %s (see --max-routes-per-client option)",

2504 
mi
->
c⁄ãxt
.
›ti⁄s
.
max_rouãs_≥r_˛õ¡
,

2505 
	`mu…i_ö°™˚_°rög
 (
mi
, 
Ál£
, &
gc
));

2506 
	`gc_‰ì
 (&
gc
);

2507 
	}
}

2509 #ifde‡
ENABLE_DEBUG


2514 
	$gªmlö_Êood_˛õ¡s
 (
mu…i_c⁄ãxt
 *
m
)

2516 c⁄° 
Àvñ
 = 
	`GREMLIN_PACKET_FLOOD_LEVEL
 (
m
->
t›
.
›ti⁄s
.
gªmlö
);

2517 i‡(
Àvñ
)

2519 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2520 
buf„r
 
buf
 = 
	`Æloc_buf_gc
 (
	`BUF_SIZE
 (&
m
->
t›
.
c2
.
‰ame
), &
gc
);

2521 
∑ckë_Êood_∑rms
 
∑rm
 = 
	`gë_∑ckë_Êood_∑rms
 (
Àvñ
);

2522 
i
;

2524 
	`ASSERT
 (
	`buf_öô
 (&
buf
, 
	`FRAME_HEADROOM
 (&
m
->
t›
.
c2
.
‰ame
)));

2525 
∑rm
.
∑ckë_size
 = 
	`mö_öt
 (∑rm.∑ckë_size, 
	`MAX_RW_SIZE_TUN
 (&
m
->
t›
.
c2
.
‰ame
));

2527 
	`msg
 (
D_GREMLIN
, "GREMLIN_FLOOD_CLIENTS: flooding clients with %dÖackets of size %d",

2528 
∑rm
.
n_∑ckës
,

2529 
∑rm
.
∑ckë_size
);

2531 
i
 = 0; i < 
∑rm
.
∑ckë_size
; ++i)

2532 
	`ASSERT
 (
	`buf_wrôe_u8
 (&
buf
, 
	`gë_øndom
 () & 0xFF));

2534 
i
 = 0; i < 
∑rm
.
n_∑ckës
; ++i)

2535 
	`mu…i_bˇ°
 (
m
, &
buf
, 
NULL
, NULL);

2537 
	`gc_‰ì
 (&
gc
);

2539 
	}
}

2542 
boﬁ


2543 
	$°Æe_rouã_check_åiggî
 (
mu…i_c⁄ãxt
 *
m
)

2545 
timevÆ
 
nuŒ
;

2546 
	`CLEAR
 (
nuŒ
);

2547  
	`evít_timeout_åiggî
 (&
m
->
°Æe_rouãs_check_ë
, &
nuŒ
, 
ETT_DEFAULT
);

2548 
	}
}

2554 
	$mu…i_¥o˚ss_≥r_£c⁄d_timîs_dow‹k
 (
mu…i_c⁄ãxt
 *
m
)

2557 
	`mu…i_ª≠_¥o˚ss
 (
m
);

2560 i‡(
m
->
t›
.
c1
.
°©us_ouçut
)

2562 i‡(
	`°©us_åiggî
 (
m
->
t›
.
c1
.
°©us_ouçut
))

2563 
	`mu…i_¥öt_°©us
 (
m
, m->
t›
.
c1
.
°©us_ouçut
, m->
°©us_fûe_vîsi⁄
);

2567 
	`mu…i_ifc⁄fig_poﬁ_≥rsi°
 (
m
, 
Ál£
);

2569 #ifde‡
ENABLE_DEBUG


2570 
	`gªmlö_Êood_˛õ¡s
 (
m
);

2574 i‡(
m
->
t›
.
›ti⁄s
.
°Æe_rouãs_check_öãrvÆ
 && 
	`°Æe_rouã_check_åiggî
 (m))

2575 
	`check_°Æe_rouãs
 (
m
);

2576 
	}
}

2579 
	$mu…i_t›_öô
 (
mu…i_c⁄ãxt
 *
m
, c⁄° 
c⁄ãxt
 *
t›
, c⁄° 
boﬁ
 
Æloc_buf„rs
)

2581 
	`öhîô_c⁄ãxt_t›
 (&
m
->
t›
,Åop);

2582 
m
->
t›
.
c2
.
buf„rs
 = 
NULL
;

2583 i‡(
Æloc_buf„rs
)

2584 
m
->
t›
.
c2
.
buf„rs
 = 
	`öô_c⁄ãxt_buf„rs
 (&t›->c2.
‰ame
);

2585 
	}
}

2588 
	$mu…i_t›_‰ì
 (
mu…i_c⁄ãxt
 *
m
)

2590 
	`˛o£_c⁄ãxt
 (&
m
->
t›
, -1, 
CC_GC_FREE
);

2591 
	`‰ì_c⁄ãxt_buf„rs
 (
m
->
t›
.
c2
.
buf„rs
);

2592 
	}
}

2598 
boﬁ


2599 
	$mu…i_¥o˚ss_sig«l
 (
mu…i_c⁄ãxt
 *
m
)

2601 i‡(
m
->
t›
.
sig
->
sig«l_ª˚ived
 =
SIGUSR2
)

2603 
°©us_ouçut
 *
so
 = 
	`°©us_›í
 (
NULL
, 0, 
M_INFO
, NULL, 0);

2604 
	`mu…i_¥öt_°©us
 (
m
, 
so
, m->
°©us_fûe_vîsi⁄
);

2605 
	`°©us_˛o£
 (
so
);

2606 
m
->
t›
.
sig
->
sig«l_ª˚ived
 = 0;

2607  
Ál£
;

2609  
åue
;

2610 
	}
}

2617 
	$mu…i_˛o£_ö°™˚_⁄_sig«l
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
)

2619 
	`ªm≠_sig«l
 (&
mi
->
c⁄ãxt
);

2620 
	`£t_¥efix
 (
mi
);

2621 
	`¥öt_sig«l
 (
mi
->
c⁄ãxt
.
sig
, "˛õ¡-ö°™˚", 
D_MULTI_LOW
);

2622 
	`˛ór_¥efix
 ();

2623 
	`mu…i_˛o£_ö°™˚
 (
m
, 
mi
, 
Ál£
);

2624 
	}
}

2627 
	$mu…i_sig«l_ö°™˚
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
, c⁄° 
sig
)

2629 
mi
->
c⁄ãxt
.
sig
->
sig«l_ª˚ived
 = sig;

2630 
	`mu…i_˛o£_ö°™˚_⁄_sig«l
 (
m
, 
mi
);

2631 
	}
}

2637 #ifde‡
ENABLE_MANAGEMENT


2640 
	$m™agemít_ˇŒback_°©us
 (*
¨g
, c⁄° 
vîsi⁄
, 
°©us_ouçut
 *
so
)

2642 
mu…i_c⁄ãxt
 *
m
 = (mu…i_c⁄ãxà*Ë
¨g
;

2644 i‡(!
vîsi⁄
)

2645 
	`mu…i_¥öt_°©us
 (
m
, 
so
, m->
°©us_fûe_vîsi⁄
);

2647 
	`mu…i_¥öt_°©us
 (
m
, 
so
, 
vîsi⁄
);

2648 
	}
}

2651 
	$m™agemít_ˇŒback_n_˛õ¡s
 (*
¨g
)

2653 
mu…i_c⁄ãxt
 *
m
 = (mu…i_c⁄ãxà*Ë
¨g
;

2654  
m
->
n_˛õ¡s
;

2655 
	}
}

2658 
	$m™agemít_ˇŒback_kûl_by_˙
 (*
¨g
, c⁄° *
dñ_˙
)

2660 
mu…i_c⁄ãxt
 *
m
 = (mu…i_c⁄ãxà*Ë
¨g
;

2661 
hash_ôî©‹
 
hi
;

2662 
hash_ñemít
 *
he
;

2663 
cou¡
 = 0;

2665 
	`hash_ôî©‹_öô
 (
m
->
ôî
, &
hi
);

2666 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

2668 
mu…i_ö°™˚
 *
mi
 = (mu…i_ö°™˚ *Ë
he
->
vÆue
;

2669 i‡(!
mi
->
hÆt
)

2671 c⁄° *
˙
 = 
	`és_comm⁄_«me
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
Ál£
);

2672 i‡(
˙
 && !
	`°rcmp
 (˙, 
dñ_˙
))

2674 
	`mu…i_sig«l_ö°™˚
 (
m
, 
mi
, 
SIGTERM
);

2675 ++
cou¡
;

2679 
	`hash_ôî©‹_‰ì
 (&
hi
);

2680  
cou¡
;

2681 
	}
}

2684 
	$m™agemít_ˇŒback_kûl_by_addr
 (*
¨g
, c⁄° 
ö_addr_t
 
addr
, c⁄° 
p‹t
)

2686 
mu…i_c⁄ãxt
 *
m
 = (mu…i_c⁄ãxà*Ë
¨g
;

2687 
hash_ôî©‹
 
hi
;

2688 
hash_ñemít
 *
he
;

2689 
›ív≤_sockaddr
 
ßddr
;

2690 
mrouã_addr
 
maddr
;

2691 
cou¡
 = 0;

2693 
	`CLEAR
 (
ßddr
);

2694 
ßddr
.
addr
.
ö4
.
sö_Ámûy
 = 
AF_INET
;

2695 
ßddr
.
addr
.
ö4
.
sö_addr
.
s_addr
 = 
	`ht⁄l
 (addr);

2696 
ßddr
.
addr
.
ö4
.
sö_p‹t
 = 
	`ht⁄s
 (
p‹t
);

2697 i‡(
	`mrouã_exåa˘_›ív≤_sockaddr
 (&
maddr
, &
ßddr
, 
åue
))

2699 
	`hash_ôî©‹_öô
 (
m
->
ôî
, &
hi
);

2700 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

2702 
mu…i_ö°™˚
 *
mi
 = (mu…i_ö°™˚ *Ë
he
->
vÆue
;

2703 i‡(!
mi
->
hÆt
 && 
	`mrouã_addr_equÆ
 (&
maddr
, &mi->
ªÆ
))

2705 
	`mu…i_sig«l_ö°™˚
 (
m
, 
mi
, 
SIGTERM
);

2706 ++
cou¡
;

2709 
	`hash_ôî©‹_‰ì
 (&
hi
);

2711  
cou¡
;

2712 
	}
}

2715 
	$m™agemít_dñëe_evít
 (*
¨g
, 
evít_t
 
evít
)

2717 
mu…i_c⁄ãxt
 *
m
 = (mu…i_c⁄ãxà*Ë
¨g
;

2718 i‡(
m
->
mt˝
)

2719 
	`mu…i_t˝_dñëe_evít
 (
m
->
mt˝
, 
evít
);

2720 
	}
}

2724 #ifde‡
MANAGEMENT_DEF_AUTH


2726 
mu…i_ö°™˚
 *

2727 
	$lookup_by_cid
 (
mu…i_c⁄ãxt
 *
m
, c⁄° 
cid
)

2729 i‡(
m
)

2731 
mu…i_ö°™˚
 *
mi
 = (mu…i_ö°™˚ *Ë
	`hash_lookup
 (
m
->
cid_hash
, &
cid
);

2732 i‡(
mi
 && !mi->
hÆt
)

2733  
mi
;

2735  
NULL
;

2736 
	}
}

2738 
boﬁ


2739 
	$m™agemít_kûl_by_cid
 (*
¨g
, c⁄° 
cid
, c⁄° *
kûl_msg
)

2741 
mu…i_c⁄ãxt
 *
m
 = (mu…i_c⁄ãxà*Ë
¨g
;

2742 
mu…i_ö°™˚
 *
mi
 = 
	`lookup_by_cid
 (
m
, 
cid
);

2743 i‡(
mi
)

2745 
	`£nd_ª°¨t
 (&
mi
->
c⁄ãxt
, 
kûl_msg
);

2746 
	`mu…i_scheduÀ_c⁄ãxt_wakeup
(
m
, 
mi
);

2747  
åue
;

2750  
Ál£
;

2751 
	}
}

2753 
boﬁ


2754 
	$m™agemít_˛õ¡_auth
 (*
¨g
,

2755 c⁄° 
cid
,

2756 c⁄° 
mda_key_id
,

2757 c⁄° 
boﬁ
 
auth
,

2758 c⁄° *
ªas⁄
,

2759 c⁄° *
˛õ¡_ªas⁄
,

2760 
buf„r_li°
 *
cc_c⁄fig
)

2762 
mu…i_c⁄ãxt
 *
m
 = (mu…i_c⁄ãxà*Ë
¨g
;

2763 
mu…i_ö°™˚
 *
mi
 = 
	`lookup_by_cid
 (
m
, 
cid
);

2764 
boﬁ
 
cc_c⁄fig_ow√d
 = 
åue
;

2765 
boﬁ
 
ªt
 = 
Ál£
;

2767 i‡(
mi
)

2769 
ªt
 = 
	`és_authítiˇã_key
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
, 
mda_key_id
, 
auth
, 
˛õ¡_ªas⁄
);

2770 i‡(
ªt
)

2772 i‡(
auth
)

2774 i‡(!
mi
->
c⁄√˘i⁄_e°ablished_Êag
)

2776 
	`£t_cc_c⁄fig
 (
mi
, 
cc_c⁄fig
);

2777 
cc_c⁄fig_ow√d
 = 
Ál£
;

2782 i‡(
ªas⁄
)

2783 
	`msg
 (
D_MULTI_LOW
, "MULTI: c⁄√˘i⁄Ñeje˘ed: %s, CLI:%s", 
ªas⁄
, 
	`≈
(
˛õ¡_ªas⁄
));

2784 i‡(
mi
->
c⁄√˘i⁄_e°ablished_Êag
)

2786 
	`£nd_auth_Áûed
 (&
mi
->
c⁄ãxt
, 
˛õ¡_ªas⁄
);

2787 
	`mu…i_scheduÀ_c⁄ãxt_wakeup
(
m
, 
mi
);

2792 i‡(
cc_c⁄fig_ow√d
 && 
cc_c⁄fig
)

2793 
	`buf„r_li°_‰ì
 (
cc_c⁄fig
);

2794  
ªt
;

2795 
	}
}

2798 
	$m™agemít_gë_≥î_öfo
 (*
¨g
, c⁄° 
cid
)

2800 
mu…i_c⁄ãxt
 *
m
 = (mu…i_c⁄ãxà*Ë
¨g
;

2801 
mu…i_ö°™˚
 *
mi
 = 
	`lookup_by_cid
 (
m
, 
cid
);

2802 *
ªt
 = 
NULL
;

2804 i‡(
mi
)

2805 
ªt
 = 
	`és_gë_≥î_öfo
 (
mi
->
c⁄ãxt
.
c2
.
és_mu…i
);

2807  
ªt
;

2808 
	}
}

2812 #ifde‡
MANAGEMENT_PF


2813 
boﬁ


2814 
	$m™agemít_˛õ¡_pf
 (*
¨g
,

2815 c⁄° 
cid
,

2816 
buf„r_li°
 *
pf_c⁄fig
)

2818 
mu…i_c⁄ãxt
 *
m
 = (mu…i_c⁄ãxà*Ë
¨g
;

2819 
mu…i_ö°™˚
 *
mi
 = 
	`lookup_by_cid
 (
m
, 
cid
);

2820 
boﬁ
 
ªt
 = 
Ál£
;

2822 i‡(
mi
 && 
pf_c⁄fig
)

2823 
ªt
 = 
	`pf_lﬂd_‰om_buf„r_li°
 (&
mi
->
c⁄ãxt
, 
pf_c⁄fig
);

2825 i‡(
pf_c⁄fig
)

2826 
	`buf„r_li°_‰ì
 (
pf_c⁄fig
);

2827  
ªt
;

2828 
	}
}

2832 
	$öô_m™agemít_ˇŒback_mu…i
 (
mu…i_c⁄ãxt
 *
m
)

2834 #ifde‡
ENABLE_MANAGEMENT


2835 i‡(
m™agemít
)

2837 
m™agemít_ˇŒback
 
cb
;

2838 
	`CLEAR
 (
cb
);

2839 
cb
.
¨g
 = 
m
;

2840 
cb
.
Êags
 = 
MCF_SERVER
;

2841 
cb
.
°©us
 = 
m™agemít_ˇŒback_°©us
;

2842 
cb
.
show_√t
 = 
m™agemít_show_√t_ˇŒback
;

2843 
cb
.
kûl_by_˙
 = 
m™agemít_ˇŒback_kûl_by_˙
;

2844 
cb
.
kûl_by_addr
 = 
m™agemít_ˇŒback_kûl_by_addr
;

2845 
cb
.
dñëe_evít
 = 
m™agemít_dñëe_evít
;

2846 
cb
.
n_˛õ¡s
 = 
m™agemít_ˇŒback_n_˛õ¡s
;

2847 #ifde‡
MANAGEMENT_DEF_AUTH


2848 
cb
.
kûl_by_cid
 = 
m™agemít_kûl_by_cid
;

2849 
cb
.
˛õ¡_auth
 = 
m™agemít_˛õ¡_auth
;

2850 
cb
.
gë_≥î_öfo
 = 
m™agemít_gë_≥î_öfo
;

2852 #ifde‡
MANAGEMENT_PF


2853 
cb
.
˛õ¡_pf
 = 
m™agemít_˛õ¡_pf
;

2855 
	`m™agemít_£t_ˇŒback
 (
m™agemít
, &
cb
);

2858 
	}
}

2861 
	$unöô_m™agemít_ˇŒback_mu…i
 (
mu…i_c⁄ãxt
 *
m
)

2863 
	`unöô_m™agemít_ˇŒback
 ();

2864 
	}
}

2870 
	$tu¬ñ_£rvî
 (
c⁄ãxt
 *
t›
)

2872 
	`ASSERT
 (
t›
->
›ti⁄s
.
mode
 =
MODE_SERVER
);

2874 i‡(
	`¥Ÿo_is_dgøm
(
t›
->
›ti⁄s
.
˚
.
¥Ÿo
))

2875 
	`tu¬ñ_£rvî_udp
(
t›
);

2877 
	`tu¬ñ_£rvî_t˝
(
t›
);

2878 
	}
}

2881 
	$dummy
(Ë{
	}
}

	@src/openvpn/multi.h

29 #i‚de‡
MULTI_H


30 
	#MULTI_H


	)

32 #i‡
P2MP_SERVER


34 
	~"öô.h
"

35 
	~"f‹w¨d.h
"

36 
	~"mrouã.h
"

37 
	~"mbuf.h
"

38 
	~"li°.h
"

39 
	~"scheduÀ.h
"

40 
	~"poﬁ.h
"

41 
	~"mudp.h
"

42 
	~"mt˝.h
"

43 
	~"≥rf.h
"

50 
	smu…i_ª≠


52 
	mbuckë_ba£
;

53 
	mbuckës_≥r_∑ss
;

54 
time_t
 
	mœ°_ˇŒ
;

68 
	smu…i_ö°™˚
 {

69 
scheduÀ_íåy
 
	m£
;

70 
gc_¨ía
 
	mgc
;

71 
boﬁ
 
	mdeföed
;

72 
boﬁ
 
	mhÆt
;

73 
	mªfcou¡
;

74 
	mrouã_cou¡
;

75 
time_t
 
	m¸óãd
;

79 
timevÆ
 
	mwakeup
;

80 
mrouã_addr
 
	mªÆ
;

82 
ifc⁄fig_poﬁ_h™dÀ
 
	mvaddr_h™dÀ
;

83 c⁄° *
	mmsg_¥efix
;

86 
	mt˝_rwÊags
;

87 
mbuf_£t
 *
	mt˝_lök_out_de„ºed
;

88 
boﬁ
 
	msockë_£t_ˇŒed
;

90 
ö_addr_t
 
	mªp‹tög_addr
;

92 
boﬁ
 
	mdid_›í_c⁄ãxt
;

93 
boﬁ
 
	mdid_ªÆ_hash
;

94 
boﬁ
 
	mdid_ôî
;

95 #ifde‡
MANAGEMENT_DEF_AUTH


96 
boﬁ
 
	mdid_cid_hash
;

97 
buf„r_li°
 *
	mcc_c⁄fig
;

99 
boﬁ
 
	mc⁄√˘i⁄_e°ablished_Êag
;

100 
boﬁ
 
	mdid_úouãs
;

101 
	mn_˛õ¡s_dñè
;

103 
c⁄ãxt
 
	mc⁄ãxt
;

118 
	smu…i_c⁄ãxt
 {

119 
	#MC_UNDEF
 0

	)

120 
	#MC_SINGLE_THREADED
 (1<<0)

	)

121 
	#MC_MULTI_THREADED_MASTER
 (1<<1)

	)

122 
	#MC_MULTI_THREADED_WORKER
 (1<<2)

	)

123 
	#MC_MULTI_THREADED_SCHEDULER
 (1<<3)

	)

124 
	#MC_WORK_THREAD
 (
MC_MULTI_THREADED_WORKER
|
MC_MULTI_THREADED_SCHEDULER
)

	)

125 
	mthªad_mode
;

127 
hash
 *
	mhash
;

129 
hash
 *
	mvhash
;

131 
hash
 *
	môî
;

134 
scheduÀ
 *
	mscheduÀ
;

135 
mbuf_£t
 *
	mmbuf
;

138 
mu…i_t˝
 *
	mmt˝
;

140 
ifc⁄fig_poﬁ
 *
	mifc⁄fig_poﬁ
;

141 
‰equícy_limô
 *
	m√w_c⁄√˘i⁄_limôî
;

142 
mrouã_hñ≥r
 *
	mrouã_hñ≥r
;

143 
mu…i_ª≠
 *
	mª≠î
;

144 
mrouã_addr
 
	mloˇl
;

145 
boﬁ
 
	míabÀ_c2c
;

146 
	mmax_˛õ¡s
;

147 
	mt˝_queue_limô
;

148 
	m°©us_fûe_vîsi⁄
;

149 
	mn_˛õ¡s
;

151 #ifde‡
MANAGEMENT_DEF_AUTH


152 
hash
 *
	mcid_hash
;

153 
	mcid_cou¡î
;

156 
mu…i_ö°™˚
 *
	m≥ndög
;

157 
mu…i_ö°™˚
 *
	móæõ°_wakeup
;

158 
mu…i_ö°™˚
 **
	mmµ_touched
;

159 
c⁄ãxt_buf„rs
 *
	mc⁄ãxt_buf„rs
;

160 
time_t
 
	m≥r_£c⁄d_åiggî
;

162 
c⁄ãxt
 
	mt›
;

168 
evít_timeout
 
	m°Æe_rouãs_check_ë
;

174 
	smu…i_rouã


176 
mrouã_addr
 
	maddr
;

177 
mu…i_ö°™˚
 *
	mö°™˚
;

179 
	#MULTI_ROUTE_CACHE
 (1<<0)

	)

180 
	#MULTI_ROUTE_AGEABLE
 (1<<1)

	)

181 
	mÊags
;

183 
	mˇche_gíî©i⁄
;

184 
time_t
 
	mœ°_ª„ªn˚
;

200 
tu¬ñ_£rvî
 (
c⁄ãxt
 *
t›
);

203 c⁄° *
mu…i_ö°™˚_°rög
 (c⁄° 
mu…i_ö°™˚
 *
mi
, 
boﬁ
 
nuŒ
, 
gc_¨ía
 *
gc
);

209 
mu…i_öô
 (
mu…i_c⁄ãxt
 *
m
, 
c⁄ãxt
 *
t
, 
boﬁ
 
t˝_mode
, 
thªad_mode
);

210 
mu…i_unöô
 (
mu…i_c⁄ãxt
 *
m
);

212 
mu…i_t›_öô
 (
mu…i_c⁄ãxt
 *
m
, c⁄° 
c⁄ãxt
 *
t›
, c⁄° 
boﬁ
 
Æloc_buf„rs
);

213 
mu…i_t›_‰ì
 (
mu…i_c⁄ãxt
 *
m
);

215 
mu…i_ö°™˚
 *
mu…i_¸óã_ö°™˚
 (
mu…i_c⁄ãxt
 *
m
, c⁄° 
mrouã_addr
 *
ªÆ
);

216 
mu…i_˛o£_ö°™˚
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
, 
boﬁ
 
shutdown
);

218 
boﬁ
 
mu…i_¥o˚ss_timeout
 (
mu…i_c⁄ãxt
 *
m
, c⁄° 
mµ_Êags
);

220 
	#MPP_PRE_SELECT
 (1<<0)

	)

221 
	#MPP_CONDITIONAL_PRE_SELECT
 (1<<1)

	)

222 
	#MPP_CLOSE_ON_SIGNAL
 (1<<2)

	)

223 
	#MPP_RECORD_TOUCH
 (1<<3)

	)

248 
boﬁ
 
mu…i_¥o˚ss_po°
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
, c⁄° 
Êags
);

274 
boﬁ
 
mu…i_¥o˚ss_öcomög_lök
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
ö°™˚
, c⁄° 
mµ_Êags
);

292 
boﬁ
 
mu…i_¥o˚ss_öcomög_tun
 (
mu…i_c⁄ãxt
 *
m
, c⁄° 
mµ_Êags
);

295 
mu…i_¥o˚ss_dr›_outgoög_tun
 (
mu…i_c⁄ãxt
 *
m
, c⁄° 
mµ_Êags
);

297 
mu…i_¥öt_°©us
 (
mu…i_c⁄ãxt
 *
m
, 
°©us_ouçut
 *
so
, c⁄° 
vîsi⁄
);

299 
mu…i_ö°™˚
 *
mu…i_gë_queue
 (
mbuf_£t
 *
ms
);

301 
mu…i_add_mbuf
 (
mu…i_c⁄ãxt
 *
m
,

302 
mu…i_ö°™˚
 *
mi
,

303 
mbuf_buf„r
 *
mb
);

305 
mu…i_ifc⁄fig_poﬁ_≥rsi°
 (
mu…i_c⁄ãxt
 *
m
, 
boﬁ
 
f‹˚
);

307 
boﬁ
 
mu…i_¥o˚ss_sig«l
 (
mu…i_c⁄ãxt
 *
m
);

309 
mu…i_˛o£_ö°™˚_⁄_sig«l
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
);

311 
öô_m™agemít_ˇŒback_mu…i
 (
mu…i_c⁄ãxt
 *
m
);

312 
unöô_m™agemít_ˇŒback_mu…i
 (
mu…i_c⁄ãxt
 *
m
);

317 
ölöe
 
boﬁ


318 
	$mu…i_ouçut_queue_ªady
 (c⁄° 
mu…i_c⁄ãxt
 *
m
,

319 c⁄° 
mu…i_ö°™˚
 *
mi
)

321 i‡(
mi
->
t˝_lök_out_de„ºed
)

322  
	`mbuf_Àn
 (
mi
->
t˝_lök_out_de„ºed
Ë<
m
->
t˝_queue_limô
;

324  
åue
;

325 
	}
}

332 
ölöe
 
mu…i_ö°™˚
 *

333 
	$mu…i_¥o˚ss_outgoög_lök_¥e
 (
mu…i_c⁄ãxt
 *
m
)

335 
mu…i_ö°™˚
 *
mi
 = 
NULL
;

337 i‡(
m
->
≥ndög
)

338 
mi
 = 
m
->
≥ndög
;

339 i‡(
	`mbuf_deföed
 (
m
->
mbuf
))

340 
mi
 = 
	`mu…i_gë_queue
 (
m
->
mbuf
);

341  
mi
;

342 
	}
}

348 
rouã_quŸa_ex˚eded
 (c⁄° 
mu…i_c⁄ãxt
 *
m
, c⁄° 
mu…i_ö°™˚
 *
mi
);

350 
ölöe
 

351 
	$rouã_quŸa_öc
 (
mu…i_ö°™˚
 *
mi
)

353 ++
mi
->
rouã_cou¡
;

354 
	}
}

356 
ölöe
 

357 
	$rouã_quŸa_dec
 (
mu…i_ö°™˚
 *
mi
)

359 --
mi
->
rouã_cou¡
;

360 
	}
}

363 
ölöe
 
boﬁ


364 
	$rouã_quŸa_ã°
 (c⁄° 
mu…i_c⁄ãxt
 *
m
, c⁄° 
mu…i_ö°™˚
 *
mi
)

366 i‡(
mi
->
rouã_cou¡
 >mi->
c⁄ãxt
.
›ti⁄s
.
max_rouãs_≥r_˛õ¡
)

368 
	`rouã_quŸa_ex˚eded
 (
m
, 
mi
);

369  
Ál£
;

372  
åue
;

373 
	}
}

379 
ölöe
 

380 
	$mu…i_ö°™˚_öc_ªfcou¡
 (
mu…i_ö°™˚
 *
mi
)

382 ++
mi
->
ªfcou¡
;

383 
	}
}

385 
ölöe
 

386 
	$mu…i_ö°™˚_dec_ªfcou¡
 (
mu…i_ö°™˚
 *
mi
)

388 i‡(--
mi
->
ªfcou¡
 <= 0)

390 
	`gc_‰ì
 (&
mi
->
gc
);

391 
	`‰ì
 (
mi
);

393 
	}
}

395 
ölöe
 

396 
	$mu…i_rouã_dñ
 (
mu…i_rouã
 *
rouã
)

398 
mu…i_ö°™˚
 *
mi
 = 
rouã
->
ö°™˚
;

399 
	`rouã_quŸa_dec
 (
mi
);

400 
	`mu…i_ö°™˚_dec_ªfcou¡
 (
mi
);

401 
	`‰ì
 (
rouã
);

402 
	}
}

404 
ölöe
 
boﬁ


405 
	$mu…i_rouã_deföed
 (c⁄° 
mu…i_c⁄ãxt
 *
m
,

406 c⁄° 
mu…i_rouã
 *
r
)

408 i‡(
r
->
ö°™˚
->
hÆt
)

409  
Ál£
;

410 i‡((
r
->
Êags
 & 
MULTI_ROUTE_CACHE
)

411 && 
r
->
ˇche_gíî©i⁄
 !
m
->
rouã_hñ≥r
->cache_generation)

412  
Ál£
;

413 i‡((
r
->
Êags
 & 
MULTI_ROUTE_AGEABLE
)

414 && 
r
->
œ°_ª„ªn˚
 + 
m
->
rouã_hñ≥r
->
agóbÀ_âl_£cs
 < 
now
)

415  
Ál£
;

417  
åue
;

418 
	}
}

424 
ölöe
 

425 
	$£t_¥efix
 (
mu…i_ö°™˚
 *
mi
)

427 #ifde‡
MULTI_DEBUG_EVENT_LOOP


428 i‡(
mi
->
msg_¥efix
)

429 
	`¥ötf
 ("[%s]\n", 
mi
->
msg_¥efix
);

431 
	`msg_£t_¥efix
 (
mi
->
msg_¥efix
);

432 
	}
}

434 
ölöe
 

435 
	$˛ór_¥efix
 ()

437 #ifde‡
MULTI_DEBUG_EVENT_LOOP


438 
	`¥ötf
 ("[NULL]\n");

440 
	`msg_£t_¥efix
 (
NULL
);

441 
	}
}

452 
	#REAP_MAX_WAKEUP
 10

	)

453 
	#REAP_DIVISOR
 256

	)

454 
	#REAP_MIN
 16

	)

455 
	#REAP_MAX
 1024

	)

461 
	#MULTI_CACHE_ROUTE_TTL
 60

	)

463 
ölöe
 

464 
	$mu…i_ª≠_¥o˚ss
 (c⁄° 
mu…i_c⁄ãxt
 *
m
)

466 
	`mu…i_ª≠_¥o˚ss_dow‹k
 (c⁄° 
mu…i_c⁄ãxt
 *
m
);

467 i‡(
m
->
ª≠î
->
œ°_ˇŒ
 !
now
)

468 
	`mu…i_ª≠_¥o˚ss_dow‹k
 (
m
);

469 
	}
}

471 
ölöe
 

472 
	$mu…i_¥o˚ss_≥r_£c⁄d_timîs
 (
mu…i_c⁄ãxt
 *
m
)

474 i‡(
m
->
≥r_£c⁄d_åiggî
 !
now
)

476 
	`mu…i_¥o˚ss_≥r_£c⁄d_timîs_dow‹k
 (
mu…i_c⁄ãxt
 *
m
);

477 
	`mu…i_¥o˚ss_≥r_£c⁄d_timîs_dow‹k
 (
m
);

478 
m
->
≥r_£c⁄d_åiggî
 = 
now
;

480 
	}
}

490 
ölöe
 

491 
	$mu…i_gë_timeout
 (
mu…i_c⁄ãxt
 *
m
, 
timevÆ
 *
de°
)

493 
timevÆ
 
tv
, 
cuºít
;

495 
	`CLEAR
 (
tv
);

496 
m
->
óæõ°_wakeup
 = (
mu…i_ö°™˚
 *Ë
	`scheduÀ_gë_óæõ°_wakeup
 (m->
scheduÀ
, &
tv
);

497 i‡(
m
->
óæõ°_wakeup
)

499 
	`ASSERT
 (!
	`›ív≤_gëtimeofday
 (&
cuºít
, 
NULL
));

500 
	`tv_dñè
 (
de°
, &
cuºít
, &
tv
);

501 i‡(
de°
->
tv_£c
 >
REAP_MAX_WAKEUP
)

503 
m
->
óæõ°_wakeup
 = 
NULL
;

504 
de°
->
tv_£c
 = 
REAP_MAX_WAKEUP
;

505 
de°
->
tv_u£c
 = 0;

510 
de°
->
tv_£c
 = 
REAP_MAX_WAKEUP
;

511 
de°
->
tv_u£c
 = 0;

513 
	}
}

533 
ölöe
 
boﬁ


534 
	$mu…i_¥o˚ss_outgoög_tun
 (
mu…i_c⁄ãxt
 *
m
, c⁄° 
mµ_Êags
)

536 
mu…i_ö°™˚
 *
mi
 = 
m
->
≥ndög
;

537 
boﬁ
 
ªt
 = 
åue
;

539 
	`ASSERT
 (
mi
);

540 #ifde‡
MULTI_DEBUG_EVENT_LOOP


541 
	`¥ötf
 ("%s -> TUNÜen=%d\n",

542 
	`id
(
mi
),

543 
mi
->
c⁄ãxt
.
c2
.
to_tun
.
Àn
);

545 
	`£t_¥efix
 (
mi
);

546 
	`¥o˚ss_outgoög_tun
 (&
mi
->
c⁄ãxt
);

547 
ªt
 = 
	`mu…i_¥o˚ss_po°
 (
m
, 
mi
, 
mµ_Êags
);

548 
	`˛ór_¥efix
 ();

549  
ªt
;

550 
	}
}

554 
ölöe
 
boﬁ


555 
	$mu…i_¥o˚ss_outgoög_lök_dow‹k
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
, c⁄° 
mµ_Êags
)

557 
boﬁ
 
ªt
 = 
åue
;

558 
	`£t_¥efix
 (
mi
);

559 
	`¥o˚ss_outgoög_lök
 (&
mi
->
c⁄ãxt
);

560 
ªt
 = 
	`mu…i_¥o˚ss_po°
 (
m
, 
mi
, 
mµ_Êags
);

561 
	`˛ór_¥efix
 ();

562  
ªt
;

563 
	}
}

568 
	#MULTI_CHECK_SIG
(
m
Ë
	`EVENT_LOOP_CHECK_SIGNAL
 (&(m)->
t›
, 
mu…i_¥o˚ss_sig«l
, (m))

	)

570 
ölöe
 

571 
	$mu…i_£t_≥ndög
 (
mu…i_c⁄ãxt
 *
m
, 
mu…i_ö°™˚
 *
mi
)

573 
m
->
≥ndög
 = 
mi
;

574 
	}
}

576 
ölöe
 

577 
	$mu…i_ªÀa£_io_lock
 (
mu…i_c⁄ãxt
 *
m
)

579 
	}
}

	@src/openvpn/ntlm.c

24 #ifde‡
HAVE_CONFIG_H


25 
	~"c⁄fig.h
"

26 #ñi‡
deföed
(
_MSC_VER
)

27 
	~"c⁄fig-msvc.h
"

30 
	~"syshód.h
"

32 #i‡
NTLM


34 
	~"comm⁄.h
"

35 
	~"buf„r.h
"

36 
	~"misc.h
"

37 
	~"sockë.h
"

38 
	~"fdmisc.h
"

39 
	~"¥oxy.h
"

40 
	~"¡lm.h
"

41 
	~"ba£64.h
"

42 
	~"¸y±o.h
"

44 
	~"memdbg.h
"

48 #ifde‡
_MSC_VER


50 
	#UINTEGER64
 
__öt64


	)

51 
	#UINT64
(
c
Ë¯## 
Ui64


	)

54 
	#UINTEGER64
 

	)

55 
	#UINT64
(
c
Ë¯## 
LL


	)

62 
	$¸óã_des_keys
(c⁄° *
hash
, *
key
)

64 
key
[0] = 
hash
[0];

65 
key
[1] = ((
hash
[0]&1)<<7)|(hash[1]>>1);

66 
key
[2] = ((
hash
[1]&3)<<6)|(hash[2]>>2);

67 
key
[3] = ((
hash
[2]&7)<<5)|(hash[3]>>3);

68 
key
[4] = ((
hash
[3]&15)<<4)|(hash[4]>>4);

69 
key
[5] = ((
hash
[4]&31)<<3)|(hash[5]>>5);

70 
key
[6] = ((
hash
[5]&63)<<2)|(hash[6]>>6);

71 
key
[7] = ((
hash
[6]&127)<<1);

72 
	`key_des_fixup
(
key
, 8, 1);

73 
	}
}

76 
	$gí_md4_hash
 (c⁄° * 
d©a
, 
d©a_Àn
, *
ªsu…
)

79 c⁄° 
md_kt_t
 *
md4_kt
 = 
	`md_kt_gë
("MD4");

80 
md
[
MD4_DIGEST_LENGTH
];

82 
	`md_fuŒ
(
md4_kt
, 
d©a
, 
d©a_Àn
, 
md
);

83 
	`mem˝y
 (
ªsu…
, 
md
, 
MD4_DIGEST_LENGTH
);

84 
	}
}

87 
	$gí_hmac_md5
 (c⁄° * 
d©a
, 
d©a_Àn
, c⁄° * 
key
, 
key_Àn
,*
ªsu…
)

89 c⁄° 
md_kt_t
 *
md5_kt
 = 
	`md_kt_gë
("MD5");

90 
hmac_˘x_t
 
hmac_˘x
;

91 
	`CLEAR
(
hmac_˘x
);

93 
	`hmac_˘x_öô
(&
hmac_˘x
, 
key
, 
key_Àn
, 
md5_kt
);

94 
	`hmac_˘x_upd©e
(&
hmac_˘x
, (c⁄° *)
d©a
, 
d©a_Àn
);

95 
	`hmac_˘x_föÆ
(&
hmac_˘x
, (*)
ªsu…
);

96 
	`hmac_˘x_˛ónup
(&
hmac_˘x
);

97 
	}
}

100 
	$gí_time°amp
 (*
time°amp
)

106 
UINTEGER64
 
time°amp_uŒ
;

108 
time°amp_uŒ
 = 
	`›ív≤_time
(
NULL
);

109 
time°amp_uŒ
 = (time°amp_uŒ + 
	`UINT64
(11644473600)) * UINT64(10000000);

112 
time°amp
[0]
time°amp_uŒ
 & 
	`UINT64
(0xFF);

113 
time°amp
[1](
time°amp_uŒ
 >> 8Ë& 
	`UINT64
(0xFF);

114 
time°amp
[2](
time°amp_uŒ
 >> 16Ë& 
	`UINT64
(0xFF);

115 
time°amp
[3](
time°amp_uŒ
 >> 24Ë& 
	`UINT64
(0xFF);

116 
time°amp
[4](
time°amp_uŒ
 >> 32Ë& 
	`UINT64
(0xFF);

117 
time°amp
[5](
time°amp_uŒ
 >> 40Ë& 
	`UINT64
(0xFF);

118 
time°amp
[6](
time°amp_uŒ
 >> 48Ë& 
	`UINT64
(0xFF);

119 
time°amp
[7](
time°amp_uŒ
 >> 56Ë& 
	`UINT64
(0xFF);

120 
	}
}

123 
	$gí_n⁄˚
 (*
n⁄˚
)

126 
i
;

128 
i
=0;i<8;i++){

129 
n⁄˚
[
i
] = ()
	`gë_øndom
();

131 
	}
}

133 *
	$my_°ru¥
(*
°r
)

136 *
tmp
 = 
°r
;;

138 dÿ*
°r
 = 
	`touµî
(*str); *(++str));

139  
tmp
;

140 
	}
}

143 
	$unicodize
 (*
d°
, c⁄° *
§c
)

146 
i
 = 0;

149 
d°
[
i
++] = *
§c
;

150 
d°
[
i
++] = 0;

152 *
§c
++);

154  
i
;

155 
	}
}

158 
	$add_£curôy_buf„r
(
sb_off£t
, *
d©a
, 
Àngth
, *
msg_buf
, *
msg_buÂos
)

161 
msg_buf
[
sb_off£t
] = ()
Àngth
;

162 
msg_buf
[
sb_off£t
 + 2] = msg_buf[sb_offset];

163 
msg_buf
[
sb_off£t
 + 4] = ()(*
msg_buÂos
 & 0xff);

164 
msg_buf
[
sb_off£t
 + 5] = ()((*
msg_buÂos
 >> 8) & 0xff);

165 
	`mem˝y
(&
msg_buf
[*
msg_buÂos
], 
d©a
, msg_buf[
sb_off£t
]);

166 *
msg_buÂos
 +
Àngth
;

167 
	}
}

170 
	$¡lm_pha£_1
 (c⁄° 
hâp_¥oxy_öfo
 *
p
, 
gc_¨ía
 *
gc
)

172 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (96, 
gc
);

182 
	`buf_¥ötf
 (&
out
, "%s", "TlRMTVNTUAABAAAAAgIAAA==");

183  (
	`BSTR
 (&
out
));

184 
	}
}

187 
	$¡lm_pha£_3
 (c⁄° 
hâp_¥oxy_öfo
 *
p
, c⁄° *
pha£_2
, 
gc_¨ía
 *
gc
)

195 
pwbuf
[ (
p
->
up
.
∑ssw‹d
) * 2];

196 
buf2
[128];

197 
pha£3
[464];

199 
md4_hash
[
MD4_DIGEST_LENGTH
+5];

200 
chÆÀnge
[8], 
¡lm_ª•⁄£
[24];

201 
i
, 
ªt_vÆ
;

203 
¡lmv2_ª•⁄£
[144];

204 
u£rdomaö_u
[256];

205 
u£rdomaö
[128];

206 
¡lmv2_hash
[
MD5_DIGEST_LENGTH
];

207 
¡lmv2_hmacmd5
[16];

208 *
¡lmv2_blob
 = 
¡lmv2_ª•⁄£
 + 16;

209 
¡lmv2_blob_size
=0;

210 
pha£3_buÂos
 = 0x40;

211 
size_t
 
Àn
;

213 
domaö
[128];

214 
u£∫ame
[128];

215 *
£∑øt‹
;

217 
boﬁ
 
¡lmv2_íabÀd
 = (
p
->
auth_mëhod
 =
HTTP_AUTH_NTLM2
);

219 
	`CLEAR
 (
buf2
);

221 
	`ASSERT
 (
	`°æí
 (
p
->
up
.
u£∫ame
) > 0);

222 
	`ASSERT
 (
	`°æí
 (
p
->
up
.
∑ssw‹d
) > 0);

225 
£∑øt‹
 = 
	`°rchr
(
p
->
up
.
u£∫ame
, '\\');

226 i‡(
£∑øt‹
 =
NULL
) {

227 
	`°∫˝y
(
u£∫ame
, 
p
->
up
.username, (username)-1);

228 
u£∫ame
[(username)-1]=0;

229 
domaö
[0]=0;

231 
	`°∫˝y
(
u£∫ame
, 
£∑øt‹
+1, (username)-1);

232 
u£∫ame
[(username)-1]=0;

233 
Àn
 = 
£∑øt‹
 - 
p
->
up
.
u£∫ame
;

234 i‡(
Àn
 > (
domaö
) - 1)Üen = (domain) - 1;

235 
	`°∫˝y
(
domaö
, 
p
->
up
.
u£∫ame
, 
Àn
);

236 
domaö
[
Àn
]=0;

241 
	`gí_md4_hash
 (
pwbuf
, 
	`unicodize
 (pwbuf, 
p
->
up
.
∑ssw‹d
Ë- 2, 
md4_hash
);

244 
	`mem£t
(
md4_hash
 + 
MD4_DIGEST_LENGTH
, 0, 5);

246 
ªt_vÆ
 = 
	`›ív≤_ba£64_decode
–
pha£_2
, (*)
buf2
, -1);

247 i‡(
ªt_vÆ
 < 0)

248  
NULL
;

254 
i
=0; i<8; i++)

256 
chÆÀnge
[
i
] = 
buf2
[i+24];

259 i‡(
¡lmv2_íabÀd
){

260 
tib_Àn
;

263 
	`my_°ru¥
((*)
	`°r˝y
(
u£rdomaö
, 
u£∫ame
));

264 i‡(
	`°æí
(
u£∫ame
Ë+ såÀn(
domaö
Ë< (
u£rdomaö
))

265 
	`°rˇt
(
u£rdomaö
, 
domaö
);

267 
	`msg
 (
M_INFO
, "Warning: Username or domainÅooÜong");

268 
	`unicodize
 (
u£rdomaö_u
, 
u£rdomaö
);

269 
	`gí_hmac_md5
(
u£rdomaö_u
, 2 * 
	`°æí
(
u£rdomaö
), 
md4_hash
, 
MD5_DIGEST_LENGTH
, 
¡lmv2_hash
);

272 
	`mem£t
(
¡lmv2_blob
, 0, 128);

273 
¡lmv2_blob
[0x00]=1;

274 
¡lmv2_blob
[0x01]=1;

275 
¡lmv2_blob
[0x04]=0;

276 
	`gí_time°amp
((*)&
¡lmv2_blob
[0x08]);

277 
	`gí_n⁄˚
((*)&
¡lmv2_blob
[0x10]);

278 
¡lmv2_blob
[0x18]=0;

281 i‡(–*((*)&
buf2
[0x14]) & 0x00800000) == 0x00800000){

282 
tib_Àn
 = 
buf2
[0x28];

283 i‡(
tib_Àn
 > 96)Åib_len = 96;

285 *
tib_±r
 = 
buf2
 + buf2[0x2c];

286 
	`mem˝y
(&
¡lmv2_blob
[0x1c], 
tib_±r
, 
tib_Àn
);

289 
tib_Àn
 = 0;

292 
¡lmv2_blob
[0x1¯+ 
tib_Àn
] = 0;

295 
¡lmv2_blob_size
 = 0x20 + 
tib_Àn
;

298 
	`mem˝y
(&
¡lmv2_ª•⁄£
[8], 
chÆÀnge
, 8);

301 
	`gí_hmac_md5
(&
¡lmv2_ª•⁄£
[8], 
¡lmv2_blob_size
 + 8, 
¡lmv2_hash
, 
MD5_DIGEST_LENGTH
, 
¡lmv2_hmacmd5
);

304 
	`mem˝y
(
¡lmv2_ª•⁄£
, 
¡lmv2_hmacmd5
, 
MD5_DIGEST_LENGTH
);

307 
key1
[
DES_KEY_LENGTH
], 
key2
[DES_KEY_LENGTH], 
key3
[DES_KEY_LENGTH];

309 
	`¸óã_des_keys
 ((*)
md4_hash
, 
key1
);

310 
	`cùhî_des_í¸y±_ecb
 (
key1
, 
chÆÀnge
, 
¡lm_ª•⁄£
);

312 
	`¸óã_des_keys
 ((*)&(
md4_hash
[
DES_KEY_LENGTH
-1]), 
key2
);

313 
	`cùhî_des_í¸y±_ecb
 (
key2
, 
chÆÀnge
, &
¡lm_ª•⁄£
[
DES_KEY_LENGTH
]);

315 
	`¸óã_des_keys
 ((*)&(
md4_hash
[2*(
DES_KEY_LENGTH
-1)]), 
key3
);

316 
	`cùhî_des_í¸y±_ecb
 (
key3
, 
chÆÀnge
, &
¡lm_ª•⁄£
[
DES_KEY_LENGTH
*2]);

320 
	`mem£t
 (
pha£3
, 0,  (phase3));

322 
	`°r˝y
 ((*)
pha£3
, "NTLMSSP\0");

323 
pha£3
[8] = 3;

325 i‡(
¡lmv2_íabÀd
){

326 
	`add_£curôy_buf„r
(0x14, 
¡lmv2_ª•⁄£
, 
¡lmv2_blob_size
 + 16, 
pha£3
, &
pha£3_buÂos
);

328 
	`add_£curôy_buf„r
(0x14, 
¡lm_ª•⁄£
, 24, 
pha£3
, &
pha£3_buÂos
);

332 
	`add_£curôy_buf„r
(0x24, 
u£∫ame
, 
	`°æí
 (u£∫ame), 
pha£3
, &
pha£3_buÂos
);

335 
	`add_£curôy_buf„r
(0x1c, 
domaö
, 
	`°æí
 (domaö), 
pha£3
, &
pha£3_buÂos
);

339 
pha£3
[0x10] = 
pha£3_buÂos
;

340 
pha£3
[0x30] = 
pha£3_buÂos
;

341 
pha£3
[0x38] = 
pha£3_buÂos
;

344 
pha£3
[0x3c] = 0x02;

345 
pha£3
[0x3d] = 0x02;

347  ((c⁄° *)
	`make_ba£64_°rög2
 ((*)
pha£3
, 
pha£3_buÂos
, 
gc
));

348 
	}
}

351 
	$dummy
(Ë{
	}
}

	@src/openvpn/ntlm.h

1 #i‚de‡
NTLM_H


2 
	#NTLM_H


	)

4 #i‡
NTLM


6 c⁄° *
¡lm_pha£_1
 (c⁄° 
hâp_¥oxy_öfo
 *
p
, 
gc_¨ía
 *
gc
);

7 c⁄° *
¡lm_pha£_3
 (c⁄° 
hâp_¥oxy_öfo
 *
p
, c⁄° *
pha£_2
, 
gc_¨ía
 *
gc
);

	@src/openvpn/occ-inline.h

25 #i‚de‡
OCC_INLINE_H


26 
	#OCC_INLINE_H


	)

28 #ifde‡
ENABLE_OCC


34 
ölöe
 

35 
	$occ_ª£t_›
 ()

38 
	}
}

43 
ölöe
 

44 
	$check_£nd_occ_ªq
 (
c⁄ãxt
 *
c
)

46 
	`check_£nd_occ_ªq_dow‹k
 (
c⁄ãxt
 *
c
);

47 i‡(
	`evít_timeout_deföed
 (&
c
->
c2
.
occ_öãrvÆ
)

48 && 
	`evít_timeout_åiggî
 (&
c
->
c2
.
occ_öãrvÆ
,

49 &
c
->
c2
.
timevÆ
,

50 (!
	`TO_LINK_DEF
(
c
Ë&& c->
c2
.
occ_›
 < 0Ë? 
ETT_DEFAULT
 : 0))

51 
	`check_£nd_occ_ªq_dow‹k
 (
c
);

52 
	}
}

57 
ölöe
 

58 
	$check_£nd_occ_lﬂd_ã°
 (
c⁄ãxt
 *
c
)

60 
	`check_£nd_occ_lﬂd_ã°_dow‹k
 (
c⁄ãxt
 *
c
);

61 i‡(
	`evít_timeout_deföed
 (&
c
->
c2
.
occ_mtu_lﬂd_ã°_öãrvÆ
)

62 && 
	`evít_timeout_åiggî
 (&
c
->
c2
.
occ_mtu_lﬂd_ã°_öãrvÆ
,

63 &
c
->
c2
.
timevÆ
,

64 (!
	`TO_LINK_DEF
(
c
Ë&& c->
c2
.
occ_›
 < 0Ë? 
ETT_DEFAULT
 : 0))

65 
	`check_£nd_occ_lﬂd_ã°_dow‹k
 (
c
);

66 
	}
}

71 
ölöe
 

72 
	$check_£nd_occ_msg
 (
c⁄ãxt
 *
c
)

74 
	`check_£nd_occ_msg_dow‹k
 (
c⁄ãxt
 *
c
);

75 i‡(
c
->
c2
.
occ_›
 >= 0)

77 i‡(!
	`TO_LINK_DEF
(
c
))

78 
	`check_£nd_occ_msg_dow‹k
 (
c
);

80 
	`tv_˛ór
 (&
c
->
c2
.
timevÆ
);

82 
	}
}

	@src/openvpn/occ.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #ifde‡
ENABLE_OCC


35 
	~"occ.h
"

37 
	~"memdbg.h
"

39 
	~"f‹w¨d-ölöe.h
"

40 
	~"occ-ölöe.h
"

62 c⁄° 
uöt8_t
 
	gocc_magic
[] = {

67 c⁄° 
mtu_lﬂd_ã°
 
	gmtu_lﬂd_ã°_£quí˚
[] = {

69 {
OCC_MTU_LOAD_REQUEST
, -1000},

70 {
OCC_MTU_LOAD
, -1000},

71 {
OCC_MTU_LOAD_REQUEST
, -1000},

72 {
OCC_MTU_LOAD
, -1000},

73 {
OCC_MTU_LOAD_REQUEST
, -1000},

74 {
OCC_MTU_LOAD
, -1000},

76 {
OCC_MTU_LOAD_REQUEST
, -750},

77 {
OCC_MTU_LOAD
, -750},

78 {
OCC_MTU_LOAD_REQUEST
, -750},

79 {
OCC_MTU_LOAD
, -750},

80 {
OCC_MTU_LOAD_REQUEST
, -750},

81 {
OCC_MTU_LOAD
, -750},

83 {
OCC_MTU_LOAD_REQUEST
, -500},

84 {
OCC_MTU_LOAD
, -500},

85 {
OCC_MTU_LOAD_REQUEST
, -500},

86 {
OCC_MTU_LOAD
, -500},

87 {
OCC_MTU_LOAD_REQUEST
, -500},

88 {
OCC_MTU_LOAD
, -500},

90 {
OCC_MTU_LOAD_REQUEST
, -400},

91 {
OCC_MTU_LOAD
, -400},

92 {
OCC_MTU_LOAD_REQUEST
, -400},

93 {
OCC_MTU_LOAD
, -400},

94 {
OCC_MTU_LOAD_REQUEST
, -400},

95 {
OCC_MTU_LOAD
, -400},

97 {
OCC_MTU_LOAD_REQUEST
, -300},

98 {
OCC_MTU_LOAD
, -300},

99 {
OCC_MTU_LOAD_REQUEST
, -300},

100 {
OCC_MTU_LOAD
, -300},

101 {
OCC_MTU_LOAD_REQUEST
, -300},

102 {
OCC_MTU_LOAD
, -300},

104 {
OCC_MTU_LOAD_REQUEST
, -200},

105 {
OCC_MTU_LOAD
, -200},

106 {
OCC_MTU_LOAD_REQUEST
, -200},

107 {
OCC_MTU_LOAD
, -200},

108 {
OCC_MTU_LOAD_REQUEST
, -200},

109 {
OCC_MTU_LOAD
, -200},

111 {
OCC_MTU_LOAD_REQUEST
, -150},

112 {
OCC_MTU_LOAD
, -150},

113 {
OCC_MTU_LOAD_REQUEST
, -150},

114 {
OCC_MTU_LOAD
, -150},

115 {
OCC_MTU_LOAD_REQUEST
, -150},

116 {
OCC_MTU_LOAD
, -150},

118 {
OCC_MTU_LOAD_REQUEST
, -100},

119 {
OCC_MTU_LOAD
, -100},

120 {
OCC_MTU_LOAD_REQUEST
, -100},

121 {
OCC_MTU_LOAD
, -100},

122 {
OCC_MTU_LOAD_REQUEST
, -100},

123 {
OCC_MTU_LOAD
, -100},

125 {
OCC_MTU_LOAD_REQUEST
, -50},

126 {
OCC_MTU_LOAD
, -50},

127 {
OCC_MTU_LOAD_REQUEST
, -50},

128 {
OCC_MTU_LOAD
, -50},

129 {
OCC_MTU_LOAD_REQUEST
, -50},

130 {
OCC_MTU_LOAD
, -50},

132 {
OCC_MTU_LOAD_REQUEST
, 0},

133 {
OCC_MTU_LOAD
, 0},

134 {
OCC_MTU_LOAD_REQUEST
, 0},

135 {
OCC_MTU_LOAD
, 0},

136 {
OCC_MTU_LOAD_REQUEST
, 0},

137 {
OCC_MTU_LOAD
, 0},

139 {
OCC_MTU_REQUEST
, 0},

140 {
OCC_MTU_REQUEST
, 0},

141 {
OCC_MTU_REQUEST
, 0},

142 {
OCC_MTU_REQUEST
, 0},

143 {
OCC_MTU_REQUEST
, 0},

144 {
OCC_MTU_REQUEST
, 0},

145 {
OCC_MTU_REQUEST
, 0},

146 {
OCC_MTU_REQUEST
, 0},

147 {
OCC_MTU_REQUEST
, 0},

148 {
OCC_MTU_REQUEST
, 0},

154 
	$check_£nd_occ_ªq_dow‹k
 (
c⁄ãxt
 *
c
)

156 i‡(++
c
->
c2
.
occ_n_åõs
 >
OCC_N_TRIES
)

158 i‡(
c
->
›ti⁄s
.
˚
.
ªmŸe
)

163 
	`msg
 (
D_SHOW_OCC
,

166 
PACKAGE_NAME


168 
PACKAGE_NAME


169 " fromÑu¬ög (" 
cou¡î_f‹m©
 " bytesÑeceived fromÖeer, " counter_format

172 
c
->
c2
.
lök_ªad_byãs
,

173 
c
->
c2
.
lök_ªad_byãs_auth
);

174 
	`evít_timeout_˛ór
 (&
c
->
c2
.
occ_öãrvÆ
);

178 
c
->
c2
.
occ_›
 = 
OCC_REQUEST
;

184 
	`evít_timeout_ª£t
 (&
c
->
c2
.
occ_öãrvÆ
);

186 
	}
}

189 
	$check_£nd_occ_lﬂd_ã°_dow‹k
 (
c⁄ãxt
 *
c
)

191 i‡(
	`CONNECTION_ESTABLISHED
 (
c
))

193 c⁄° 
mtu_lﬂd_ã°
 *
íåy
;

195 i‡(!
c
->
c2
.
occ_mtu_lﬂd_n_åõs
)

196 
	`msg
 (
M_INFO
,

199 
íåy
 = &
mtu_lﬂd_ã°_£quí˚
[
c
->
c2
.
occ_mtu_lﬂd_n_åõs
++];

200 i‡(
íåy
->
›
 >= 0)

202 
c
->
c2
.
occ_›
 = 
íåy
->
›
;

203 
c
->
c2
.
occ_mtu_lﬂd_size
 =

204 
	`EXPANDED_SIZE
 (&
c
->
c2
.
‰ame
Ë+ 
íåy
->
dñè
;

208 
	`msg
 (
M_INFO
,

209 "NOTE: faûedÅÿempúiˇŒy mósuª MTU (ªquúe†" 
PACKAGE_NAME
 " 1.5 or higherát otherÉnd of connection).");

210 
	`evít_timeout_˛ór
 (&
c
->
c2
.
occ_mtu_lﬂd_ã°_öãrvÆ
);

211 
c
->
c2
.
occ_mtu_lﬂd_n_åõs
 = 0;

214 
	}
}

217 
	$check_£nd_occ_msg_dow‹k
 (
c⁄ãxt
 *
c
)

219 
boﬁ
 
doô
 = 
Ál£
;

221 
c
->
c2
.
buf
 = c->c2.
buf„rs
->
aux_buf
;

222 
	`ASSERT
 (
	`buf_öô
 (&
c
->
c2
.
buf
, 
	`FRAME_HEADROOM
 (&c->c2.
‰ame
)));

223 
	`ASSERT
 (
	`buf_ß„
 (&
c
->
c2
.
buf
, 
	`MAX_RW_SIZE_TUN
 (&c->c2.
‰ame
)));

224 
	`ASSERT
 (
	`buf_wrôe
 (&
c
->
c2
.
buf
, 
occ_magic
, 
OCC_STRING_SIZE
));

226 
c
->
c2
.
occ_›
)

228 
OCC_REQUEST
:

229 i‡(!
	`buf_wrôe_u8
 (&
c
->
c2
.
buf
, 
OCC_REQUEST
))

231 
	`dmsg
 (
D_PACKET_CONTENT
, "SENT OCC_REQUEST");

232 
doô
 = 
åue
;

235 
OCC_REPLY
:

236 i‡(!
c
->
c2
.
›ti⁄s_°rög_loˇl
)

238 i‡(!
	`buf_wrôe_u8
 (&
c
->
c2
.
buf
, 
OCC_REPLY
))

240 i‡(!
	`buf_wrôe
 (&
c
->
c2
.
buf
, c->c2.
›ti⁄s_°rög_loˇl
,

241 
	`°æí
 (
c
->
c2
.
›ti⁄s_°rög_loˇl
) + 1))

243 
	`dmsg
 (
D_PACKET_CONTENT
, "SENT OCC_REPLY");

244 
doô
 = 
åue
;

247 
OCC_MTU_REQUEST
:

248 i‡(!
	`buf_wrôe_u8
 (&
c
->
c2
.
buf
, 
OCC_MTU_REQUEST
))

250 
	`dmsg
 (
D_PACKET_CONTENT
, "SENT OCC_MTU_REQUEST");

251 
doô
 = 
åue
;

254 
OCC_MTU_REPLY
:

255 i‡(!
	`buf_wrôe_u8
 (&
c
->
c2
.
buf
, 
OCC_MTU_REPLY
))

257 i‡(!
	`buf_wrôe_u16
 (&
c
->
c2
.
buf
, c->c2.
max_ªcv_size_loˇl
))

259 i‡(!
	`buf_wrôe_u16
 (&
c
->
c2
.
buf
, c->c2.
max_£nd_size_loˇl
))

261 
	`dmsg
 (
D_PACKET_CONTENT
, "SENT OCC_MTU_REPLY");

262 
doô
 = 
åue
;

265 
OCC_MTU_LOAD_REQUEST
:

266 i‡(!
	`buf_wrôe_u8
 (&
c
->
c2
.
buf
, 
OCC_MTU_LOAD_REQUEST
))

268 i‡(!
	`buf_wrôe_u16
 (&
c
->
c2
.
buf
, c->c2.
occ_mtu_lﬂd_size
))

270 
	`dmsg
 (
D_PACKET_CONTENT
, "SENT OCC_MTU_LOAD_REQUEST");

271 
doô
 = 
åue
;

274 
OCC_MTU_LOAD
:

276 
√ed_to_add
;

278 i‡(!
	`buf_wrôe_u8
 (&
c
->
c2
.
buf
, 
OCC_MTU_LOAD
))

280 
√ed_to_add
 = 
	`mö_öt
 (
c
->
c2
.
occ_mtu_lﬂd_size
, 
	`EXPANDED_SIZE
 (&c->c2.
‰ame
))

281 - 
OCC_STRING_SIZE


282 -  (
uöt8_t
)

283 - 
	`EXTRA_FRAME
 (&
c
->
c2
.
‰ame
);

285 
√ed_to_add
 > 0)

290 i‡(!
	`buf_wrôe_u8
 (&
c
->
c2
.
buf
, 
	`gë_øndom
 () & 0xFF))

292 --
√ed_to_add
;

294 
	`dmsg
 (
D_PACKET_CONTENT
, "SENT OCC_MTU_LOAD min_int(%d-%d-%d-%d,%d) size=%d",

295 
c
->
c2
.
occ_mtu_lﬂd_size
,

296 
OCC_STRING_SIZE
,

297 (Ë (
uöt8_t
),

298 
	`EXTRA_FRAME
 (&
c
->
c2
.
‰ame
),

299 
	`MAX_RW_SIZE_TUN
 (&
c
->
c2
.
‰ame
),

300 
	`BLEN
 (&
c
->
c2
.
buf
));

301 
doô
 = 
åue
;

305 
OCC_EXIT
:

306 i‡(!
	`buf_wrôe_u8
 (&
c
->
c2
.
buf
, 
OCC_EXIT
))

308 
	`dmsg
 (
D_PACKET_CONTENT
, "SENT OCC_EXIT");

309 
doô
 = 
åue
;

313 i‡(
doô
)

319 
	`í¸y±_sign
 (
c
, 
åue
);

322 
c
->
c2
.
occ_›
 = -1;

323 
	}
}

326 
	$¥o˚ss_ª˚ived_occ_msg
 (
c⁄ãxt
 *
c
)

328 
	`ASSERT
 (
	`buf_adv™˚
 (&
c
->
c2
.
buf
, 
OCC_STRING_SIZE
));

329 
	`buf_ªad_u8
 (&
c
->
c2
.
buf
))

331 
OCC_REQUEST
:

332 
	`dmsg
 (
D_PACKET_CONTENT
, "RECEIVED OCC_REQUEST");

333 
c
->
c2
.
occ_›
 = 
OCC_REPLY
;

336 
OCC_MTU_REQUEST
:

337 
	`dmsg
 (
D_PACKET_CONTENT
, "RECEIVED OCC_MTU_REQUEST");

338 
c
->
c2
.
occ_›
 = 
OCC_MTU_REPLY
;

341 
OCC_MTU_LOAD_REQUEST
:

342 
	`dmsg
 (
D_PACKET_CONTENT
, "RECEIVED OCC_MTU_LOAD_REQUEST");

343 
c
->
c2
.
occ_mtu_lﬂd_size
 = 
	`buf_ªad_u16
 (&c->c2.
buf
);

344 i‡(
c
->
c2
.
occ_mtu_lﬂd_size
 >= 0)

345 
c
->
c2
.
occ_›
 = 
OCC_MTU_LOAD
;

348 
OCC_REPLY
:

349 
	`dmsg
 (
D_PACKET_CONTENT
, "RECEIVED OCC_REPLY");

350 i‡(
c
->
›ti⁄s
.
occ
 && !
	`TLS_MODE
 (cË&& c->
c2
.
›ti⁄s_°rög_ªmŸe
)

352 i‡(!
	`›ti⁄s_cmp_equÆ_ß„
 ((*Ë
	`BPTR
 (&
c
->
c2
.
buf
),

353 
c
->
c2
.
›ti⁄s_°rög_ªmŸe
,

354 
c
->
c2
.
buf
.
Àn
))

356 
	`›ti⁄s_w¨nög_ß„
 ((*Ë
	`BPTR
 (&
c
->
c2
.
buf
),

357 
c
->
c2
.
›ti⁄s_°rög_ªmŸe
,

358 
c
->
c2
.
buf
.
Àn
);

361 
	`evít_timeout_˛ór
 (&
c
->
c2
.
occ_öãrvÆ
);

364 
OCC_MTU_REPLY
:

365 
	`dmsg
 (
D_PACKET_CONTENT
, "RECEIVED OCC_MTU_REPLY");

366 
c
->
c2
.
max_ªcv_size_ªmŸe
 = 
	`buf_ªad_u16
 (&c->c2.
buf
);

367 
c
->
c2
.
max_£nd_size_ªmŸe
 = 
	`buf_ªad_u16
 (&c->c2.
buf
);

368 i‡(
c
->
›ti⁄s
.
mtu_ã°


369 && 
c
->
c2
.
max_ªcv_size_ªmŸe
 > 0

370 && 
c
->
c2
.
max_£nd_size_ªmŸe
 > 0)

372 
	`msg
 (
M_INFO
, "NOTE: Empirical MTUÅest completed [Tried,Actual]Üocal->remote=[%d,%d]Ñemote->local=[%d,%d]",

373 
c
->
c2
.
max_£nd_size_loˇl
,

374 
c
->
c2
.
max_ªcv_size_ªmŸe
,

375 
c
->
c2
.
max_£nd_size_ªmŸe
,

376 
c
->
c2
.
max_ªcv_size_loˇl
);

377 i‡(!
c
->
›ti⁄s
.
˚
.
‰agmít


378 && (
	`¥Ÿo_is_dgøm
(
c
->
›ti⁄s
.
˚
.
¥Ÿo
))

379 && 
c
->
c2
.
max_£nd_size_loˇl
 > 
TUN_MTU_MIN


380 && (
c
->
c2
.
max_ªcv_size_ªmŸe
 < c->c2.
max_£nd_size_loˇl


381 || 
c
->
c2
.
max_ªcv_size_loˇl
 < c->c2.
max_£nd_size_ªmŸe
))

382 
	`msg
 (
M_INFO
, "NOTE: This connection is unableÅoáccomodateá UDPÖacket size of %d. Consider using --fragment or --mssfix optionsásá workaround.",

383 
c
->
c2
.
max_£nd_size_loˇl
);

385 
	`evít_timeout_˛ór
 (&
c
->
c2
.
occ_mtu_lﬂd_ã°_öãrvÆ
);

388 
OCC_EXIT
:

389 
	`dmsg
 (
D_PACKET_CONTENT
, "RECEIVED OCC_EXIT");

390 
c
->
sig
->
sig«l_ª˚ived
 = 
SIGTERM
;

391 
c
->
sig
->
sig«l_ãxt
 = "remote-exit";

394 
c
->
c2
.
buf
.
Àn
 = 0;

395 
	}
}

398 
	$dummy
(Ë{
	}
}

	@src/openvpn/occ.h

25 #i‚de‡
OCC_H


26 
	#OCC_H


	)

28 #ifde‡
ENABLE_OCC


30 
	~"f‹w¨d.h
"

33 
	#OCC_STRING_SIZE
 16

	)

39 
	#OCC_REQUEST
 0

	)

40 
	#OCC_REPLY
 1

	)

49 
	#OCC_INTERVAL_SECONDS
 10

	)

50 
	#OCC_N_TRIES
 12

	)

55 
	#OCC_MTU_LOAD_REQUEST
 2

	)

56 
	#OCC_MTU_LOAD
 3

	)

57 
	#OCC_MTU_REQUEST
 4

	)

59 
	#OCC_MTU_REPLY
 5

	)

65 
	#OCC_MTU_LOAD_INTERVAL_SECONDS
 3

	)

70 
	#OCC_EXIT
 6

	)

76 
	smtu_lﬂd_ã°


78 
	m›
;

79 
	mdñè
;

84 c⁄° 
uöt8_t
 
occ_magic
[];

86 
ölöe
 
boﬁ


87 
	$is_occ_msg
 (c⁄° 
buf„r
* 
buf
)

89  
	`buf_°rög_m©ch_hód
 (
buf
, 
occ_magic
, 
OCC_STRING_SIZE
);

90 
	}
}

92 
¥o˚ss_ª˚ived_occ_msg
 (
c⁄ãxt
 *
c
);

	@src/openvpn/openvpn.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"öô.h
"

34 
	~"f‹w¨d.h
"

35 
	~"mu…i.h
"

36 
	~"wö32.h
"

38 
	~"memdbg.h
"

40 
	~"f‹w¨d-ölöe.h
"

42 
	#P2P_CHECK_SIG
(Ë
	`EVENT_LOOP_CHECK_SIGNAL
 (
c
, 
¥o˚ss_sig«l_p2p
, c);

	)

44 
boﬁ


45 
	$¥o˚ss_sig«l_p2p
 (
c⁄ãxt
 *
c
)

47 
	`ªm≠_sig«l
 (
c
);

48  
	`¥o˚ss_sig«l
 (
c
);

49 
	}
}

62 
	$tu¬ñ_poöt_to_poöt
 (
c⁄ãxt
 *
c
)

64 
	`c⁄ãxt_˛ór_2
 (
c
);

67 
c
->
mode
 = 
CM_P2P
;

70 
	`öô_ö°™˚_h™dÀ_sig«ls
 (
c
, c->
es
, 
CC_HARD_USR1_TO_HUP
);

71 i‡(
	`IS_SIG
 (
c
))

75 
åue
)

77 
	`≥rf_push
 (
PERF_EVENT_LOOP
);

80 
	`¥e_£À˘
 (
c
);

81 
	`P2P_CHECK_SIG
();

84 
	`io_waô
 (
c
, 
	`p2p_iow_Êags
 (c));

85 
	`P2P_CHECK_SIG
();

88 i‡(
c
->
c2
.
evít_£t_°©us
 =
ES_TIMEOUT
)

90 
	`≥rf_p›
 ();

95 
	`¥o˚ss_io
 (
c
);

96 
	`P2P_CHECK_SIG
();

98 
	`≥rf_p›
 ();

101 
	`unöô_m™agemít_ˇŒback
 ();

104 
	`˛o£_ö°™˚
 (
c
);

105 
	}
}

107 #unde‡
PROCESS_SIGNAL_P2P


132 
	$›ív≤_maö
 (
¨gc
, *
¨gv
[])

134 
c⁄ãxt
 
c
;

136 #i‡
PEDANTIC


137 
	`Ârötf
 (
°dîr
, "Sorry, I was built with --enable-pedanticánd Iám incapable of doingányÑeal work!\n");

141 #ifde‡
WIN32


142 
	`SëC⁄sﬁeOuçutCP
 (
CP_UTF8
);

145 
	`CLEAR
 (
c
);

149 
c
.
fú°_time
 = 
åue
;

152 i‡(
	`öô_°©ic
 ())

161 
	`¥e_öô_sig«l_ˇtch
 ();

164 
	`c⁄ãxt_˛ór_Æl_ex˚±_fú°_time
 (&
c
);

167 
	`CLEAR
 (
sigöfo_°©ic
);

168 
c
.
sig
 = &
sigöfo_°©ic
;

171 
	`gc_öô
 (&
c
.
gc
);

174 
c
.
es
 = 
	`ív_£t_¸óã
 (
NULL
);

175 #ifde‡
WIN32


176 
	`£t_wö_sys_∑th_vü_ív
 (
c
.
es
);

179 #ifde‡
ENABLE_MANAGEMENT


181 
	`öô_m™agemít
 (&
c
);

185 
	`öô_›ti⁄s
 (&
c
.
›ti⁄s
, 
åue
);

188 
	`∑r£_¨gv
 (&
c
.
›ti⁄s
, 
¨gc
, 
¨gv
, 
M_USAGE
, 
OPT_P_DEFAULT
, 
NULL
, c.
es
);

190 #ifde‡
ENABLE_PLUGIN


192 
	`öô_vîb_muã
 (&
c
, 
IVM_LEVEL_1
);

193 
	`öô_∂ugös
 (&
c
);

194 
	`›í_∂ugös
 (&
c
, 
åue
, 
OPENVPN_PLUGIN_INIT_PRE_CONFIG_PARSE
);

198 
	`öô_vîb_muã
 (&
c
, 
IVM_LEVEL_1
);

201 
	`öô_›ti⁄s_dev
 (&
c
.
›ti⁄s
);

204 i‡(
	`¥öt_›ís¶_öfo
 (&
c
.
›ti⁄s
))

208 i‡(
	`do_gíkey
 (&
c
.
›ti⁄s
))

212 i‡(
	`do_≥rsi°_tu¡≠
 (&
c
.
›ti⁄s
))

216 
	`›ti⁄s_po°¥o˚ss
 (&
c
.
›ti⁄s
);

219 
	`show_£âögs
 (&
c
.
›ti⁄s
);

222 
	`msg
 (
M_INFO
, "%s", 
tôÀ_°rög
);

223 
	`show_libøry_vîsi⁄s
(
M_INFO
);

226 
	`¥e_£tup
 (&
c
.
›ti⁄s
);

229 i‡(
	`do_ã°_¸y±o
 (&
c
.
›ti⁄s
))

232 #ifde‡
ENABLE_MANAGEMENT


234 i‡(!
	`›í_m™agemít
 (&
c
))

239 
	`£ãnv_£âögs
 (
c
.
es
, &c.
›ti⁄s
);

242 
	`c⁄ãxt_öô_1
 (&
c
);

247 
c
.
›ti⁄s
.
mode
)

249 
MODE_POINT_TO_POINT
:

250 
	`tu¬ñ_poöt_to_poöt
 (&
c
);

252 #i‡
P2MP_SERVER


253 
MODE_SERVER
:

254 
	`tu¬ñ_£rvî
 (&
c
);

258 
	`ASSERT
 (0);

262 
c
.
fú°_time
 = 
Ál£
;

265 i‡(
	`IS_SIG
 (&
c
))

266 
	`¥öt_sig«l
 (
c
.
sig
, 
NULL
, 
M_INFO
);

269 
	`sig«l_ª°¨t_°©us
 (
c
.
sig
);

271 
c
.
sig
->
sig«l_ª˚ived
 =
SIGUSR1
);

273 
	`unöô_›ti⁄s
 (&
c
.
›ti⁄s
);

274 
	`gc_ª£t
 (&
c
.
gc
);

276 
c
.
sig
->
sig«l_ª˚ived
 =
SIGHUP
);

279 
	`c⁄ãxt_gc_‰ì
 (&
c
);

281 
	`ív_£t_de°roy
 (
c
.
es
);

283 #ifde‡
ENABLE_MANAGEMENT


285 
	`˛o£_m™agemít
 ();

289 
	`unöô_°©ic
 ();

291 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_GOOD
);

293 
	}
}

295 #ifde‡
WIN32


297 
	$wmaö
 (
¨gc
, 
wch¨_t
 *
w¨gv
[]) {

298 **
¨gv
;

299 
ªt
;

300 
i
;

302 i‡((
¨gv
 = 
	`ˇŒoc
(
¨gc
+1, (*))Ë=
NULL
)

305 
i
 = 0; i < 
¨gc
; i++)

307 
n
 = 
	`WideCh¨ToMu…iByã
 (
CP_UTF8
, 0, 
w¨gv
[
i
], -1, 
NULL
, 0, NULL, NULL);

308 
¨gv
[
i
] = 
	`mÆloc
 (
n
);

309 
	`WideCh¨ToMu…iByã
 (
CP_UTF8
, 0, 
w¨gv
[
i
], -1, 
¨gv
[i], 
n
, 
NULL
, NULL);

312 
ªt
 = 
	`›ív≤_maö
(
¨gc
, 
¨gv
);

314 
i
=0; i < 
¨gc
; i++ )

316 
	`‰ì
 (
¨gv
[
i
]);

318 
	`‰ì
(
¨gv
);

320  
ªt
;

321 
	}
}

324 
	$maö
 (
¨gc
, *
¨gv
[]) {

325  
	`›ív≤_maö
(
¨gc
, 
¨gv
);

326 
	}
}

	@src/openvpn/openvpn.h

25 #i‚de‡
OPENVPN_H


26 
	#OPENVPN_H


	)

28 
	~"buf„r.h
"

29 
	~"›ti⁄s.h
"

30 
	~"sockë.h
"

31 
	~"¸y±o.h
"

32 
	~"s¶.h
"

33 
	~"∑ckë_id.h
"

34 
	~"lzo.h
"

35 
	~"tun.h
"

36 
	~"öãrvÆ.h
"

37 
	~"°©us.h
"

38 
	~"‰agmít.h
"

39 
	~"sh≠î.h
"

40 
	~"rouã.h
"

41 
	~"¥oxy.h
"

42 
	~"socks.h
"

43 
	~"sig.h
"

44 
	~"misc.h
"

45 
	~"mbuf.h
"

46 
	~"poﬁ.h
"

47 
	~"∂ugö.h
"

48 
	~"m™age.h
"

49 
	~"pf.h
"

56 
	skey_scheduÀ


58 #ifde‡
ENABLE_CRYPTO


60 
key_ty≥
 
	mkey_ty≥
;

63 
key_˘x_bi
 
	m°©ic_key
;

65 #ifde‡
ENABLE_SSL


67 
és_roŸ_˘x
 
	ms¶_˘x
;

70 
key_˘x_bi
 
	més_auth_key
;

74 
	mdummy
;

82 #i‚de‡
PACKET_ID_H


83 
	s∑ckë_id_≥rsi°


85 
	mdummy
;

87 
ölöe
 

88 
	$∑ckë_id_≥rsi°_öô
 (
∑ckë_id_≥rsi°
 *
p
)

90 
	}
}

96 
	sc⁄ãxt_buf„rs


99 
buf„r
 
	maux_buf
;

102 #ifde‡
ENABLE_CRYPTO


103 
buf„r
 
	mí¸y±_buf
;

104 
buf„r
 
	mde¸y±_buf
;

108 #ifde‡
ENABLE_LZO


109 
buf„r
 
	mlzo_com¥ess_buf
;

110 
buf„r
 
	mlzo_decom¥ess_buf
;

117 
buf„r
 
	mªad_lök_buf
;

118 
buf„r
 
	mªad_tun_buf
;

124 
	sc⁄ãxt_≥rsi°


126 
	mª°¨t_¶ìp_£c⁄ds
;

138 
	sc⁄ãxt_0


141 
pid_°©e
 
	mpid_°©e
;

144 
boﬁ
 
	muid_gid_•ecifõd
;

145 
boﬁ
 
	muid_gid_£t
;

146 
∂©f‹m_°©e_u£r
 
	m∂©f‹m_°©e_u£r
;

147 
∂©f‹m_°©e_group
 
	m∂©f‹m_°©e_group
;

160 
	sc⁄ãxt_1


162 
lök_sockë_addr
 
	mlök_sockë_addr
;

167 
key_scheduÀ
 
	mks
;

170 
∑ckë_id_≥rsi°
 
	mpid_≥rsi°
;

172 
tu¡≠
 *
	mtu¡≠
;

173 
boﬁ
 
	mtu¡≠_ow√d
;

177 
rouã_li°
 *
	mrouã_li°
;

182 
rouã_ùv6_li°
 *
	mrouã_ùv6_li°
;

185 
°©us_ouçut
 *
	m°©us_ouçut
;

186 
boﬁ
 
	m°©us_ouçut_ow√d
;

188 #ifde‡
ENABLE_HTTP_PROXY


190 
hâp_¥oxy_öfo
 *
	mhâp_¥oxy
;

191 
boﬁ
 
	mhâp_¥oxy_ow√d
;

194 #ifde‡
ENABLE_SOCKS


196 
socks_¥oxy_öfo
 *
	msocks_¥oxy
;

197 
boﬁ
 
	msocks_¥oxy_ow√d
;

200 #i‡
P2MP


202 #i‡
P2MP_SERVER


204 
ifc⁄fig_poﬁ_≥rsi°
 *
	mifc⁄fig_poﬁ_≥rsi°
;

205 
boﬁ
 
	mifc⁄fig_poﬁ_≥rsi°_ow√d
;

209 
md5_dige°
 
	mpuŒed_›ti⁄s_dige°_ßve
;

214 
u£r_∑ss
 *
	mauth_u£r_∑ss
;

229 
	sc⁄ãxt_2


231 
gc_¨ía
 
	mgc
;

236 
evít_£t
 *
	mevít_£t
;

237 
	mevít_£t_max
;

238 
boﬁ
 
	mevít_£t_ow√d
;

241 
	#SOCKET_READ
 (1<<0)

	)

242 
	#SOCKET_WRITE
 (1<<1)

	)

243 
	#TUN_READ
 (1<<2)

	)

244 
	#TUN_WRITE
 (1<<3)

	)

245 
	#ES_ERROR
 (1<<4)

	)

246 
	#ES_TIMEOUT
 (1<<5)

	)

247 #ifde‡
ENABLE_MANAGEMENT


248 
	#MANAGEMENT_READ
 (1<<6)

	)

249 
	#MANAGEMENT_WRITE
 (1<<7)

	)

252 
	mevít_£t_°©us
;

254 
lök_sockë
 *
	mlök_sockë
;

255 
boﬁ
 
	mlök_sockë_ow√d
;

256 
lök_sockë_öfo
 *
	mlök_sockë_öfo
;

257 c⁄° 
lök_sockë
 *
	mac˚±_‰om
;

259 
lök_sockë_a˘uÆ
 *
	mto_lök_addr
;

260 
lök_sockë_a˘uÆ
 
	m‰om
;

263 
‰ame
 
	m‰ame
;

265 #ifde‡
ENABLE_FRAGMENT


267 
‰agmít_ma°î
 *
	m‰agmít
;

268 
‰ame
 
	m‰ame_‰agmít
;

269 
‰ame
 
	m‰ame_‰agmít_omô
;

272 #ifde‡
ENABLE_FEATURE_SHAPER


276 
sh≠î
 
	msh≠î
;

282 
cou¡î_ty≥
 
	mtun_ªad_byãs
;

283 
cou¡î_ty≥
 
	mtun_wrôe_byãs
;

284 
cou¡î_ty≥
 
	mlök_ªad_byãs
;

285 
cou¡î_ty≥
 
	mlök_ªad_byãs_auth
;

286 
cou¡î_ty≥
 
	mlök_wrôe_byãs
;

287 #ifde‡
PACKET_TRUNCATION_CHECK


288 
cou¡î_ty≥
 
	mn_åunc_tun_ªad
;

289 
cou¡î_ty≥
 
	mn_åunc_tun_wrôe
;

290 
cou¡î_ty≥
 
	mn_åunc_¥e_í¸y±
;

291 
cou¡î_ty≥
 
	mn_åunc_po°_de¸y±
;

298 
evít_timeout
 
	mwaô_f‹_c⁄√˘
;

299 
evít_timeout
 
	mpög_£nd_öãrvÆ
;

300 
evít_timeout
 
	mpög_ªc_öãrvÆ
;

303 
evít_timeout
 
	möa˘ivôy_öãrvÆ
;

304 
	möa˘ivôy_byãs
;

306 #ifde‡
ENABLE_OCC


308 *
	m›ti⁄s_°rög_loˇl
;

309 *
	m›ti⁄s_°rög_ªmŸe
;

311 
	mocc_›
;

312 
	mocc_n_åõs
;

313 
evít_timeout
 
	mocc_öãrvÆ
;

320 
	m‹igöÆ_ªcv_size
;

321 
	mmax_ªcv_size_loˇl
;

322 
	mmax_ªcv_size_ªmŸe
;

323 
	mmax_£nd_size_loˇl
;

324 
	mmax_£nd_size_ªmŸe
;

326 #ifde‡
ENABLE_OCC


328 
	mocc_mtu_lﬂd_size
;

330 
evít_timeout
 
	mocc_mtu_lﬂd_ã°_öãrvÆ
;

331 
	mocc_mtu_lﬂd_n_åõs
;

334 #ifde‡
ENABLE_CRYPTO


339 #ifde‡
ENABLE_SSL


341 
és_mu…i
 *
	més_mu…i
;

344 
és_auth_°™dÆ⁄e
 *
	més_auth_°™dÆ⁄e
;

356 
öãrvÆ
 
	mtmp_öt
;

359 
	més_exô_sig«l
;

363 
¸y±o_›ti⁄s
 
	m¸y±o_›ti⁄s
;

370 
∑ckë_id
 
	m∑ckë_id
;

371 
evít_timeout
 
	m∑ckë_id_≥rsi°_öãrvÆ
;

375 #ifde‡
ENABLE_LZO


376 
lzo_com¥ess_w‹k•a˚
 
	mlzo_compw‹k
;

385 
c⁄ãxt_buf„rs
 *
	mbuf„rs
;

386 
boﬁ
 
	mbuf„rs_ow√d
;

393 
buf„r
 
	mbuf
;

394 
buf„r
 
	mto_tun
;

395 
buf„r
 
	mto_lök
;

400 
boﬁ
 
	mùv4_tun
;

403 
boﬁ
 
	mlog_rw
;

406 
evít_timeout
 
	mrouã_wakeup
;

407 
evít_timeout
 
	mrouã_wakeup_expúe
;

410 
boﬁ
 
	mdid_›í_tun
;

417 
timevÆ
 
	mtimevÆ
;

420 
time_t
 
	mcﬂr£_timî_wakeup
;

424 
time_t
 
	mupd©e_timeout_øndom_comp⁄ít
;

425 
timevÆ
 
	mtimeout_øndom_comp⁄ít
;

428 
boﬁ
 
	mdo_up_øn
;

430 #ifde‡
ENABLE_OCC


434 
time_t
 
	mex∂icô_exô_nŸifiˇti⁄_time_waô
;

435 
evít_timeout
 
	mex∂icô_exô_nŸifiˇti⁄_öãrvÆ
;

439 
ív_£t
 *
	mes
;

440 
boﬁ
 
	mes_ow√d
;

443 
boﬁ
 
	mÁ°_io
;

445 #i‡
P2MP


447 #i‡
P2MP_SERVER


449 
boﬁ
 
	mpush_ª∂y_de„ºed
;

450 
boﬁ
 
	mpush_ifc⁄fig_deföed
;

451 
time_t
 
	m£¡_push_ª∂y_expúy
;

452 
ö_addr_t
 
	mpush_ifc⁄fig_loˇl
;

453 
ö_addr_t
 
	mpush_ifc⁄fig_ªmŸe_√tmask
;

454 #ifde‡
ENABLE_CLIENT_NAT


455 
ö_addr_t
 
	mpush_ifc⁄fig_loˇl_Æüs
;

458 
boﬁ
 
	mpush_ifc⁄fig_ùv6_deföed
;

459 
ö6_addr
 
	mpush_ifc⁄fig_ùv6_loˇl
;

460 
	mpush_ifc⁄fig_ùv6_√tbôs
;

461 
ö6_addr
 
	mpush_ifc⁄fig_ùv6_ªmŸe
;

464 
	#CAS_SUCCEEDED
 0

	)

465 
	#CAS_PENDING
 1

	)

466 
	#CAS_FAILED
 2

	)

467 
	#CAS_PARTIAL
 3

	)

469 
	mc⁄ãxt_auth
;

472 
evít_timeout
 
	mpush_ªque°_öãrvÆ
;

473 
	mn_£¡_push_ªque°s
;

474 
boﬁ
 
	mdid_¥e_puŒ_ª°‹e
;

477 
boﬁ
 
	mpuŒed_›ti⁄s_md5_öô_d⁄e
;

478 
md5_°©e
 
	mpuŒed_›ti⁄s_°©e
;

479 
md5_dige°
 
	mpuŒed_›ti⁄s_dige°
;

481 
evít_timeout
 
	m£rvî_pﬁl_öãrvÆ
;

483 
evít_timeout
 
	mscheduÀd_exô
;

484 
	mscheduÀd_exô_sig«l
;

488 #ifde‡
ENABLE_PF


489 
pf_c⁄ãxt
 
	mpf
;

492 #ifde‡
MANAGEMENT_DEF_AUTH


493 
m™_def_auth_c⁄ãxt
 
	mmda_c⁄ãxt
;

509 
	sc⁄ãxt


511 
›ti⁄s
 
	m›ti⁄s
;

514 
boﬁ
 
	mfú°_time
;

518 
	#CM_P2P
 0

	)

519 
	#CM_TOP
 1

	)

520 
	#CM_TOP_CLONE
 2

	)

521 
	#CM_CHILD_UDP
 3

	)

522 
	#CM_CHILD_TCP
 4

	)

523 
	mmode
;

528 
gc_¨ía
 
	mgc
;

532 
ív_£t
 *
	mes
;

534 
sig«l_öfo
 *
	msig
;

536 
∂ugö_li°
 *
	m∂ugös
;

537 
boﬁ
 
	m∂ugös_ow√d
;

541 
boﬁ
 
	mdid_we_d´m⁄ize
;

544 
c⁄ãxt_≥rsi°
 
	m≥rsi°
;

546 
c⁄ãxt_0
 *
	mc0
;

547 
c⁄ãxt_1
 
	mc1
;

548 
c⁄ãxt_2
 
	mc2
;

554 
	#EVENT_LOOP_CHECK_SIGNAL
(
c
, 
func
, 
¨g
) \

555 i‡(
	`IS_SIG
 (
c
)) \

557 c⁄° 
brk
 = 
	`func
 (
¨g
); \

558 
	`≥rf_p›
 (); \

559 i‡(
brk
) \

563 }

	)

570 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

571 
	#TLS_MODE
(
c
Ë((c)->
c2
.
és_mu…i
 !
NULL
)

	)

572 
	#PROTO_DUMP_FLAGS
 (
	`check_debug_Àvñ
 (
D_LINK_RW_VERBOSE
Ë? (
PD_SHOW_DATA
|
PD_VERBOSE
Ë: 0)

	)

573 
	#PROTO_DUMP
(
buf
, 
gc
Ë
	`¥Ÿocﬁ_dump
((buf), \

574 
PROTO_DUMP_FLAGS
 | \

575 (
c
->
c2
.
és_mu…i
 ? 
PD_TLS
 : 0) | \

576 (
c
->
›ti⁄s
.
és_auth_fûe
 ? c->
c1
.
ks
.
key_ty≥
.
hmac_Àngth
 : 0), \

577 
gc
)

	)

579 
	#TLS_MODE
(
c
Ë(
Ál£
)

	)

580 
	#PROTO_DUMP
(
buf
, 
gc
Ë
	`f‹m©_hex
 (
	`BPTR
 (buf), 
	`BLEN
 (buf), 80, gc)

	)

583 #ifde‡
ENABLE_CRYPTO


584 
	#MD5SUM
(
buf
, 
Àn
, 
gc
Ë
	`md5sum
((buf), (Àn), 0, (gc))

	)

586 
	#MD5SUM
(
buf
, 
Àn
, 
gc
Ë"[u«vaûabÀ]"

	)

589 #ifde‡
ENABLE_CRYPTO


590 
	#CIPHER_ENABLED
(
c
Ë(c->
c1
.
ks
.
key_ty≥
.
cùhî
 !
NULL
)

	)

592 
	#CIPHER_ENABLED
(
c
Ë(
Ál£
)

	)

	@src/openvpn/options.c

31 #ifde‡
HAVE_CONFIG_H


32 
	~"c⁄fig.h
"

33 #ñi‡
deföed
(
_MSC_VER
)

34 
	~"c⁄fig-msvc.h
"

36 #ifde‡
HAVE_CONFIG_VERSION_H


37 
	~"c⁄fig-vîsi⁄.h
"

40 
	~"syshód.h
"

42 
	~"buf„r.h
"

43 
	~"îr‹.h
"

44 
	~"comm⁄.h
"

45 
	~"sh≠î.h
"

46 
	~"¸y±o.h
"

47 
	~"s¶.h
"

48 
	~"›ti⁄s.h
"

49 
	~"misc.h
"

50 
	~"sockë.h
"

51 
	~"∑ckë_id.h
"

52 
	~"pkcs11.h
"

53 
	~"wö32.h
"

54 
	~"push.h
"

55 
	~"poﬁ.h
"

56 
	~"hñ≥r.h
"

57 
	~"m™age.h
"

58 
	~"f‹w¨d.h
"

59 
	~<˘y≥.h
>

61 
	~"memdbg.h
"

63 c⁄° 
	gtôÀ_°rög
[] =

64 
PACKAGE_STRING


65 " " 
TARGET_ALIAS


66 #ifde‡
ENABLE_CRYPTO


67 #ifde‡
ENABLE_SSL


68 #i‡
deföed
(
ENABLE_CRYPTO_POLARSSL
)

70 #ñi‡
deföed
(
ENABLE_CRYPTO_OPENSSL
)

76 #i‡
deföed
(
ENABLE_CRYPTO_POLARSSL
)

78 #ñi‡
deföed
(
ENABLE_CRYPTO_OPENSSL
)

85 #ifde‡
ENABLE_LZO


86 #ifde‡
ENABLE_LZO_STUB


92 #i‡
EPOLL


95 #ifde‡
PRODUCT_TAP_DEBUG


98 #ifde‡
ENABLE_PKCS11


101 #i‡
ENABLE_IP_PKTINFO


105 " buûà⁄ " 
__DATE__


108 #i‚de‡
ENABLE_SMALL


110 c⁄° 
	gußge_mesßge
[] =

132 #ifde‡
ENABLE_HTTP_PROXY


149 #ifde‡
ENABLE_SOCKS


169 #ifde‡
ENABLE_HTTP_PROXY


172 #ifde‡
ENABLE_SOCKS


186 #ifde‡
ENABLE_IPROUTE


187 "--ùrouã cmd : U£Åhi†comm™d in°ód o‡deÁu… " 
IPROUTE_PATH
 ".\n"

229 " VPN. Add 'loˇl' fœg i‡bŸh " 
PACKAGE_NAME
 " serversáre directly\n"

237 #ifde‡
ENABLE_CLIENT_NAT


240 #ifde‡
ENABLE_PUSH_PEER_INFO


264 #i‡
ENABLE_IP_PKTINFO


273 #i‡
PASSTOS_CAPABILITY


287 #ifde‡
ENABLE_OCC


290 #ifde‡
ENABLE_FRAGMENT


299 #i‡
deföed
(
TARGET_LINUX
Ë&& 
HAVE_DECL_SO_MARK


304 #ifde‡
ENABLE_MEMSTATS


324 #ifde‡
ENABLE_SELINUX


356 #ifde‡
ENABLE_OCC


359 #ifde‡
ENABLE_DEBUG


362 #ifde‡
ENABLE_LZO


368 #ifde‡
ENABLE_MANAGEMENT


372 #i‡
UNIX_SOCK_SUPPORT


382 "--m™agemít-hﬁd : Sèπ " 
PACKAGE_NAME
 " iná hibernating state, untilá client\n"

390 #i‡
UNIX_SOCK_SUPPORT


396 #ifde‡
MANAGEMENT_DEF_AUTH


401 #ifde‡
MANAGEMENT_PF


406 #ifde‡
ENABLE_PLUGIN


410 #i‡
P2MP


411 #i‡
P2MP_SERVER


479 #i‡
PORT_SHARE


502 #ifde‡
ENABLE_OCC


506 #ifde‡
ENABLE_CRYPTO


525 #ifde‡
HAVE_EVP_CIPHER_CTX_SET_KEY_LENGTH


529 #i‚de‡
ENABLE_CRYPTO_POLARSSL


542 #ifde‡
ENABLE_PREDICTION_RESISTANCE


546 #ifde‡
ENABLE_SSL


556 #i‚de‡
ENABLE_CRYPTO_POLARSSL


558 #i‡
OPENSSL_VERSION_NUMBER
 >= 0x00907000L

576 #i‚de‡
ENABLE_CRYPTO_POLARSSL


580 #ifde‡
ENABLE_X509ALTUSERNAME


585 #ifde‡
WIN32


623 #ifde‡
ENABLE_X509_TRACK


627 #i‡
OPENSSL_VERSION_NUMBER
 >0x00907000L || 
ENABLE_CRYPTO_POLARSSL


639 #ifde‡
ENABLE_PKCS11


663 #ifde‡
ENABLE_SSL


666 #ifde‡
WIN32


709 "--£rvi˚Éx [0|1] : F‹ u£ whí " 
PACKAGE_NAME
 " is being instantiated byá\n"

712 " sig«Àd, wû»ˇu£ " 
PACKAGE_NAME
 "ÅoÉxit. A second\n"

714 "--show-√t-u∞ : Show " 
PACKAGE_NAME
 "'s view ofÑoutingÅableándÇetádapterÜist\n"

719 "--show-√à : Show " 
PACKAGE_NAME
 "'s view ofÑoutingÅableándÇetádapterÜist.\n"

721 "--Ælow-n⁄admö [TAP-ad≠ãr] : AŒow " 
PACKAGE_NAME
 "Ñunning withoutádminÖrivileges\n"

730 #ifde‡
ENABLE_FEATURE_TUN_PERSIST


740 #ifde‡
ENABLE_PKCS11


748 #ifde‡
ENABLE_DEBUG


761 
	$öô_›ti⁄s
 (
›ti⁄s
 *
o
, c⁄° 
boﬁ
 
öô_gc
)

763 
	`CLEAR
 (*
o
);

764 i‡(
öô_gc
)

766 
	`gc_öô
 (&
o
->
gc
);

767 
o
->
gc_ow√d
 = 
åue
;

769 
o
->
mode
 = 
MODE_POINT_TO_POINT
;

770 
o
->
t›ﬁogy
 = 
TOP_NET30
;

771 
o
->
˚
.
¥Ÿo
 = 
PROTO_UDPv4
;

772 
o
->
˚
.
c⁄√˘_ªåy_£c⁄ds
 = 5;

773 
o
->
˚
.
c⁄√˘_timeout
 = 10;

774 
o
->
˚
.
c⁄√˘_ªåy_max
 = 0;

775 
o
->
˚
.
loˇl_p‹t
 = o->˚.
ªmŸe_p‹t
 = 
OPENVPN_PORT
;

776 
o
->
vîbosôy
 = 1;

777 
o
->
°©us_fûe_upd©e_‰eq
 = 60;

778 
o
->
°©us_fûe_vîsi⁄
 = 1;

779 
o
->
˚
.
böd_loˇl
 = 
åue
;

780 
o
->
˚
.
tun_mtu
 = 
TUN_MTU_DEFAULT
;

781 
o
->
˚
.
lök_mtu
 = 
LINK_MTU_DEFAULT
;

782 
o
->
˚
.
mtu_discovî_ty≥
 = -1;

783 
o
->
˚
.
mssfix
 = 
MSSFIX_DEFAULT
;

784 
o
->
rouã_dñay_wödow
 = 30;

785 
o
->
max_rouãs
 = 
MAX_ROUTES_DEFAULT
;

786 
o
->
ªsﬁve_ªåy_£c⁄ds
 = 
RESOLV_RETRY_INFINITE
;

787 
o
->
¥Ÿo_f‹˚
 = -1;

788 #ifde‡
ENABLE_OCC


789 
o
->
occ
 = 
åue
;

791 #ifde‡
ENABLE_MANAGEMENT


792 
o
->
m™agemít_log_hi°‹y_ˇche
 = 250;

793 
o
->
m™agemít_echo_buf„r_size
 = 100;

794 
o
->
m™agemít_°©e_buf„r_size
 = 100;

796 #ifde‡
ENABLE_FEATURE_TUN_PERSIST


797 
o
->
≥rsi°_mode
 = 1;

799 #i‚de‡
WIN32


800 
o
->
rcvbuf
 = 65536;

801 
o
->
¢dbuf
 = 65536;

803 #ifde‡
TARGET_LINUX


804 
o
->
tu¡≠_›ti⁄s
.
txqueuñí
 = 100;

806 #ifde‡
WIN32


808 
o
->
tu¡≠_›ti⁄s
.
ù_wö32_ty≥
 = 
IPW32_SET_ADAPTIVE
;

810 
o
->
tu¡≠_›ti⁄s
.
ù_wö32_ty≥
 = 
IPW32_SET_DHCP_MASQ
;

812 
o
->
tu¡≠_›ti⁄s
.
dh˝_Àa£_time
 = 31536000;

813 
o
->
tu¡≠_›ti⁄s
.
dh˝_masq_off£t
 = 0;

814 
o
->
rouã_mëhod
 = 
ROUTE_METHOD_ADAPTIVE
;

816 #i‡
P2MP_SERVER


817 
o
->
ªÆ_hash_size
 = 256;

818 
o
->
vútuÆ_hash_size
 = 256;

819 
o
->
n_bˇ°_buf
 = 256;

820 
o
->
t˝_queue_limô
 = 64;

821 
o
->
max_˛õ¡s
 = 1024;

822 
o
->
max_rouãs_≥r_˛õ¡
 = 256;

823 
o
->
°Æe_rouãs_check_öãrvÆ
 = 0;

824 
o
->
ifc⁄fig_poﬁ_≥rsi°_ª‰esh_‰eq
 = 600;

826 #i‡
P2MP


827 
o
->
scheduÀd_exô_öãrvÆ
 = 5;

828 
o
->
£rvî_pﬁl_timeout
 = 0;

830 #ifde‡
ENABLE_CRYPTO


831 
o
->
cùhî«me
 = "BF-CBC";

832 
o
->
cùhî«me_deföed
 = 
åue
;

833 
o
->
auth«me
 = "SHA1";

834 
o
->
auth«me_deföed
 = 
åue
;

835 
o
->
¥ng_hash
 = "SHA1";

836 
o
->
¥ng_n⁄˚_£¸ë_Àn
 = 16;

837 
o
->
ª∂ay
 = 
åue
;

838 
o
->
ª∂ay_wödow
 = 
DEFAULT_SEQ_BACKTRACK
;

839 
o
->
ª∂ay_time
 = 
DEFAULT_TIME_BACKTRACK
;

840 
o
->
u£_iv
 = 
åue
;

841 
o
->
key_dúe˘i⁄
 = 
KEY_DIRECTION_BIDIRECTIONAL
;

842 #ifde‡
ENABLE_PREDICTION_RESISTANCE


843 
o
->
u£_¥edi˘i⁄_ªsi°™˚
 = 
Ál£
;

845 #ifde‡
ENABLE_SSL


846 
o
->
key_mëhod
 = 2;

847 
o
->
és_timeout
 = 2;

848 
o
->
ª√gŸüã_£c⁄ds
 = 3600;

849 
o
->
h™dshake_wödow
 = 60;

850 
o
->
å™sôi⁄_wödow
 = 3600;

851 #ifde‡
ENABLE_X509ALTUSERNAME


852 
o
->
x509_u£∫ame_fõld
 = 
X509_USERNAME_FIELD_DEFAULT
;

856 #ifde‡
ENABLE_PKCS11


857 
o
->
pkcs11_pö_ˇche_≥riod
 = -1;

861 #i‡
P2MP_SERVER


863 #ifde‡
WIN32


865 
o
->
tmp_dú
 = 
	`wö_gë_ãmpdú
();

868 
o
->
tmp_dú
 = 
	`gëív
("TMPDIR");

869 if–!
o
->
tmp_dú
 ) {

870 
o
->
tmp_dú
 = "/tmp";

874 
	}
}

877 
	$unöô_›ti⁄s
 (
›ti⁄s
 *
o
)

879 i‡(
o
->
gc_ow√d
)

881 
	`gc_‰ì
 (&
o
->
gc
);

883 
	}
}

885 #i‚de‡
ENABLE_SMALL


887 
	#SHOW_PARM
(
«me
, 
vÆue
, 
f‹m©
Ë
	`msg
(
D_SHOW_PARMS
, " " #«mê" = " f‹m©, (vÆue))

	)

888 
	#SHOW_STR
(
v¨
Ë
	`SHOW_PARM
(v¨, (
o
->v¨ ? o->v¨ : "[UNDEF]"), "'%s'")

	)

889 
	#SHOW_INT
(
v¨
Ë
	`SHOW_PARM
(v¨, 
o
->v¨, "%d")

	)

890 
	#SHOW_UINT
(
v¨
Ë
	`SHOW_PARM
(v¨, 
o
->v¨, "%u")

	)

891 
	#SHOW_UNSIGNED
(
v¨
Ë
	`SHOW_PARM
(v¨, 
o
->v¨, "0x%08x")

	)

892 
	#SHOW_BOOL
(
v¨
Ë
	`SHOW_PARM
(v¨, (
o
->v¨ ? "ENABLED" : "DISABLED"), "%s");

	)

897 
	$£ãnv_c⁄√˘i⁄_íåy
 (
ív_£t
 *
es
,

898 c⁄° 
c⁄√˘i⁄_íåy
 *
e
,

899 c⁄° 
i
)

901 
	`£ãnv_°r_i
 (
es
, "¥Ÿo", 
	`¥Ÿo2ascii
 (
e
->
¥Ÿo
, 
Ál£
), 
i
);

902 
	`£ãnv_°r_i
 (
es
, "loˇl", 
e
->
loˇl
, 
i
);

903 
	`£ãnv_öt_i
 (
es
, "loˇl_p‹t", 
e
->
loˇl_p‹t
, 
i
);

904 
	`£ãnv_°r_i
 (
es
, "ªmŸe", 
e
->
ªmŸe
, 
i
);

905 
	`£ãnv_öt_i
 (
es
, "ªmŸe_p‹t", 
e
->
ªmŸe_p‹t
, 
i
);

907 #ifde‡
ENABLE_HTTP_PROXY


908 i‡(
e
->
hâp_¥oxy_›ti⁄s
)

910 
	`£ãnv_°r_i
 (
es
, "hâp_¥oxy_£rvî", 
e
->
hâp_¥oxy_›ti⁄s
->
£rvî
, 
i
);

911 
	`£ãnv_öt_i
 (
es
, "hâp_¥oxy_p‹t", 
e
->
hâp_¥oxy_›ti⁄s
->
p‹t
, 
i
);

914 #ifde‡
ENABLE_SOCKS


915 i‡(
e
->
socks_¥oxy_£rvî
)

917 
	`£ãnv_°r_i
 (
es
, "socks_¥oxy_£rvî", 
e
->
socks_¥oxy_£rvî
, 
i
);

918 
	`£ãnv_öt_i
 (
es
, "socks_¥oxy_p‹t", 
e
->
socks_¥oxy_p‹t
, 
i
);

921 
	}
}

924 
	$£ãnv_£âögs
 (
ív_£t
 *
es
, c⁄° 
›ti⁄s
 *
o
)

926 
	`£ãnv_°r
 (
es
, "c⁄fig", 
o
->
c⁄fig
);

927 
	`£ãnv_öt
 (
es
, "vîb", 
o
->
vîbosôy
);

928 
	`£ãnv_öt
 (
es
, "d´m⁄", 
o
->
d´m⁄
);

929 
	`£ãnv_öt
 (
es
, "d´m⁄_log_ªdúe˘", 
o
->
log
);

930 
	`£ãnv_unsig√d
 (
es
, "d´m⁄_°¨t_time", 
	`time
(
NULL
));

931 
	`£ãnv_öt
 (
es
, "d´m⁄_pid", 
	`∂©f‹m_gëpid
());

933 i‡(
o
->
c⁄√˘i⁄_li°
)

935 
i
;

936 
i
 = 0; i < 
o
->
c⁄√˘i⁄_li°
->
Àn
; ++i)

937 
	`£ãnv_c⁄√˘i⁄_íåy
 (
es
, 
o
->
c⁄√˘i⁄_li°
->
¨øy
[
i
], i+1);

940 
	`£ãnv_c⁄√˘i⁄_íåy
 (
es
, &
o
->
˚
, 1);

941 
	}
}

943 
ö_addr_t


944 
	$gë_ù_addr
 (c⁄° *
ù_°rög
, 
msgÀvñ
, 
boﬁ
 *
îr‹
)

946 
Êags
 = 
GETADDR_HOST_ORDER
;

947 
boﬁ
 
suc˚eded
 = 
Ál£
;

948 
ö_addr_t
 
ªt
;

950 i‡(
msgÀvñ
 & 
M_FATAL
)

951 
Êags
 |
GETADDR_FATAL
;

953 
ªt
 = 
	`gëaddr
 (
Êags
, 
ù_°rög
, 0, &
suc˚eded
, 
NULL
);

954 i‡(!
suc˚eded
 && 
îr‹
)

955 *
îr‹
 = 
åue
;

956  
ªt
;

957 
	}
}

966 
boﬁ


967 
	$gë_ùv6_addr
–c⁄° * 
¥efix_°r
, 
ö6_addr
 *
√tw‹k
,

968 * 
√tbôs
, ** 
¥öèbÀ_ùv6
, 
msgÀvñ
 )

970 
rc
;

971 * 
£p
, * 
ídp
;

972 
bôs
;

973 
ö6_addr
 
t_√tw‹k
;

975 
£p
 = 
	`°rchr
–
¥efix_°r
, '/' );

976 i‡–
£p
 =
NULL
 )

978 
bôs
 = 64;

982 
bôs
 = 
	`°πﬁ
–
£p
+1, &
ídp
, 10 );

983 i‡–*
ídp
 !'\0' || 
bôs
 < 0 || bits > 128 )

985 
	`msg
 (
msgÀvñ
, "IPv6Öªfix '%s': invÆid '/bôs' s≥c", 
¥efix_°r
);

986  
Ál£
;

995 i‡–
£p
 !
NULL
 ) *sep = '\0';

997 
rc
 = 
	`öë_±⁄
–
AF_INET6
, 
¥efix_°r
, &
t_√tw‹k
 );

999 i‡–
rc
 =1 && 
¥öèbÀ_ùv6
 !
NULL
 )

1001 *
¥öèbÀ_ùv6
 = 
	`°rög_Æloc
–
¥efix_°r
, 
NULL
 );

1004 i‡–
£p
 !
NULL
 ) *sep = '/';

1006 i‡–
rc
 != 1 )

1008 
	`msg
 (
msgÀvñ
, "IPv6Öªfix '%s': invÆid IPv6áddªss", 
¥efix_°r
);

1009  
Ál£
;

1012 i‡–
√tbôs
 !
NULL
 )

1014 *
√tbôs
 = 
bôs
;

1016 i‡–
√tw‹k
 !
NULL
 )

1018 *
√tw‹k
 = 
t_√tw‹k
;

1020  
åue
;

1021 
	}
}

1023 
boﬁ
 
	$ùv6_addr_ß„_hex∂usbôs
–c⁄° * 
ùv6_¥efix_•ec
 )

1025 
ö6_addr
 
t_addr
;

1026 
t_bôs
;

1028  
	`gë_ùv6_addr
–
ùv6_¥efix_•ec
, &
t_addr
, &
t_bôs
, 
NULL
, 
M_WARN
 );

1029 
	}
}

1032 
	$°rög_sub°ôuã
 (c⁄° *
§c
, 
‰om
, 
to
, 
gc_¨ía
 *
gc
)

1034 *
ªt
 = (*Ë
	`gc_mÆloc
 (
	`°æí
 (
§c
Ë+ 1, 
åue
, 
gc
);

1035 *
de°
 = 
ªt
;

1036 
c
;

1040 
c
 = *
§c
++;

1041 i‡(
c
 =
‰om
)

1042 
c
 = 
to
;

1043 *
de°
++ = 
c
;

1045 
c
);

1046  
ªt
;

1047 
	}
}

1049 #ifde‡
ENABLE_SSL


1050 
uöt8_t
 *

1051 
	$∑r£_hash_fögî¥öt
(c⁄° *
°r
, 
nbyãs
, 
msgÀvñ
, 
gc_¨ía
 *
gc
)

1053 
i
;

1054 c⁄° *
˝
 = 
°r
;

1055 
uöt8_t
 *
ªt
 = (uöt8_à*Ë
	`gc_mÆloc
 (
nbyãs
, 
åue
, 
gc
);

1056 
ãrm
 = 1;

1057 
byã
;

1058 
bs
[3];

1060 
i
 = 0; i < 
nbyãs
; ++i)

1062 i‡(
	`°æí
(
˝
) < 2)

1063 
	`msg
 (
msgÀvñ
, "f‹m©Éº‹ i¿hash fögî¥öt: %s", 
°r
);

1064 
bs
[0] = *
˝
++;

1065 
bs
[1] = *
˝
++;

1066 
bs
[2] = 0;

1067 
byã
 = 0;

1068 i‡(
	`ssˇnf
(
bs
, "%x", &
byã
) != 1)

1069 
	`msg
 (
msgÀvñ
, "f‹m©Éº‹ i¿hash fögî¥öàhex byã: %s", 
°r
);

1070 
ªt
[
i
] = (
uöt8_t
)
byã
;

1071 
ãrm
 = *
˝
++;

1072 i‡(
ãrm
 != ':' &&Åerm != 0)

1073 
	`msg
 (
msgÀvñ
, "f‹m©Éº‹ i¿hash fögî¥öàdñimôî: %s", 
°r
);

1074 i‡(
ãrm
 == 0)

1077 i‡(
ãrm
 !0 || 
i
 !
nbyãs
-1)

1078 
	`msg
 (
msgÀvñ
, "hash fögî¥öài†dif„ª¡ÜígthÅh™Éx≥˘ed (%d byãs): %s", 
nbyãs
, 
°r
);

1079  
ªt
;

1080 
	}
}

1083 #ifde‡
WIN32


1085 #i‚de‡
ENABLE_SMALL


1088 
	$show_dh˝_›ti⁄_addrs
 (c⁄° *
«me
, c⁄° 
ö_addr_t
 *
¨øy
, 
Àn
)

1090 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1091 
i
;

1092 
i
 = 0; i < 
Àn
; ++i)

1094 
	`msg
 (
D_SHOW_PARMS
, " %s[%d] = %s",

1095 
«me
,

1096 
i
,

1097 
	`¥öt_ö_addr_t
 (
¨øy
[
i
], 0, &
gc
));

1099 
	`gc_‰ì
 (&
gc
);

1100 
	}
}

1103 
	$show_tu¡≠_›ti⁄s
 (c⁄° 
tu¡≠_›ti⁄s
 *
o
)

1105 
	`SHOW_BOOL
 (
ù_wö32_deföed
);

1106 
	`SHOW_INT
 (
ù_wö32_ty≥
);

1107 
	`SHOW_INT
 (
dh˝_masq_off£t
);

1108 
	`SHOW_INT
 (
dh˝_Àa£_time
);

1109 
	`SHOW_INT
 (
èp_¶ìp
);

1110 
	`SHOW_BOOL
 (
dh˝_›ti⁄s
);

1111 
	`SHOW_BOOL
 (
dh˝_ª√w
);

1112 
	`SHOW_BOOL
 (
dh˝_¥e_ªÀa£
);

1113 
	`SHOW_BOOL
 (
dh˝_ªÀa£
);

1114 
	`SHOW_STR
 (
domaö
);

1115 
	`SHOW_STR
 (
√tbios_sc›e
);

1116 
	`SHOW_INT
 (
√tbios_node_ty≥
);

1117 
	`SHOW_BOOL
 (
dißbÀ_nbt
);

1119 
	`show_dh˝_›ti⁄_addrs
 ("DNS", 
o
->
dns
, o->
dns_Àn
);

1120 
	`show_dh˝_›ti⁄_addrs
 ("WINS", 
o
->
wös
, o->
wös_Àn
);

1121 
	`show_dh˝_›ti⁄_addrs
 ("NTP", 
o
->
¡p
, o->
¡p_Àn
);

1122 
	`show_dh˝_›ti⁄_addrs
 ("NBDD", 
o
->
nbdd
, o->
nbdd_Àn
);

1123 
	}
}

1128 
	$dh˝_›ti⁄_addªss_∑r£
 (c⁄° *
«me
, c⁄° *
∑rm
, 
ö_addr_t
 *
¨øy
, *
Àn
, 
msgÀvñ
)

1130 i‡(*
Àn
 >
N_DHCP_ADDR
)

1132 
	`msg
 (
msgÀvñ
, "--dhcp-option %s: maximum of %d %s servers can be specified",

1133 
«me
,

1134 
N_DHCP_ADDR
,

1135 
«me
);

1139 i‡(
	`ù_addr_dŸãd_quad_ß„
 (
∑rm
))

1141 
boﬁ
 
îr‹
 = 
Ál£
;

1142 c⁄° 
ö_addr_t
 
addr
 = 
	`gë_ù_addr
 (
∑rm
, 
msgÀvñ
, &
îr‹
);

1143 i‡(!
îr‹
)

1144 
¨øy
[(*
Àn
)++] = 
addr
;

1148 
	`msg
 (
msgÀvñ
, "dh˝-›ti⁄Ö¨amëî %†'%s' mu° bê™ IPáddªss", 
«me
, 
∑rm
);

1151 
	}
}

1155 #i‡
P2MP


1157 #i‚de‡
ENABLE_SMALL


1160 
	$show_p2mp_∑rms
 (c⁄° 
›ti⁄s
 *
o
)

1162 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1164 #i‡
P2MP_SERVER


1165 
	`msg
 (
D_SHOW_PARMS
, " sîvî_√tw‹k = %s", 
	`¥öt_ö_addr_t
 (
o
->
£rvî_√tw‹k
, 0, &
gc
));

1166 
	`msg
 (
D_SHOW_PARMS
, " sîvî_√tmask = %s", 
	`¥öt_ö_addr_t
 (
o
->
£rvî_√tmask
, 0, &
gc
));

1167 
	`msg
 (
D_SHOW_PARMS
, " sîvî_√tw‹k_ùv6 = %s", 
	`¥öt_ö6_addr
 (
o
->
£rvî_√tw‹k_ùv6
, 0, &
gc
) );

1168 
	`SHOW_INT
 (
£rvî_√tbôs_ùv6
);

1169 
	`msg
 (
D_SHOW_PARMS
, " sîvî_bridge_ù = %s", 
	`¥öt_ö_addr_t
 (
o
->
£rvî_bridge_ù
, 0, &
gc
));

1170 
	`msg
 (
D_SHOW_PARMS
, " sîvî_bridge_√tmask = %s", 
	`¥öt_ö_addr_t
 (
o
->
£rvî_bridge_√tmask
, 0, &
gc
));

1171 
	`msg
 (
D_SHOW_PARMS
, " sîvî_bridge_poﬁ_°¨à%s", 
	`¥öt_ö_addr_t
 (
o
->
£rvî_bridge_poﬁ_°¨t
, 0, &
gc
));

1172 
	`msg
 (
D_SHOW_PARMS
, " sîvî_bridge_poﬁ_íd = %s", 
	`¥öt_ö_addr_t
 (
o
->
£rvî_bridge_poﬁ_íd
, 0, &
gc
));

1173 i‡(
o
->
push_li°
.
hód
)

1175 c⁄° 
push_íåy
 *
e
 = 
o
->
push_li°
.
hód
;

1176 
e
)

1178 i‡(
e
->
íabÀ
)

1179 
	`msg
 (
D_SHOW_PARMS
, "Öush_íåy = '%s'", 
e
->
›ti⁄
);

1180 
e
 =É->
√xt
;

1183 
	`SHOW_BOOL
 (
ifc⁄fig_poﬁ_deföed
);

1184 
	`msg
 (
D_SHOW_PARMS
, " ifc⁄fig_poﬁ_°¨à%s", 
	`¥öt_ö_addr_t
 (
o
->
ifc⁄fig_poﬁ_°¨t
, 0, &
gc
));

1185 
	`msg
 (
D_SHOW_PARMS
, " ifc⁄fig_poﬁ_íd = %s", 
	`¥öt_ö_addr_t
 (
o
->
ifc⁄fig_poﬁ_íd
, 0, &
gc
));

1186 
	`msg
 (
D_SHOW_PARMS
, " ifc⁄fig_poﬁ_√tmask = %s", 
	`¥öt_ö_addr_t
 (
o
->
ifc⁄fig_poﬁ_√tmask
, 0, &
gc
));

1187 
	`SHOW_STR
 (
ifc⁄fig_poﬁ_≥rsi°_fûíame
);

1188 
	`SHOW_INT
 (
ifc⁄fig_poﬁ_≥rsi°_ª‰esh_‰eq
);

1189 
	`SHOW_BOOL
 (
ifc⁄fig_ùv6_poﬁ_deföed
);

1190 
	`msg
 (
D_SHOW_PARMS
, " ifc⁄fig_ùv6_poﬁ_ba£ = %s", 
	`¥öt_ö6_addr
 (
o
->
ifc⁄fig_ùv6_poﬁ_ba£
, 0, &
gc
));

1191 
	`SHOW_INT
 (
ifc⁄fig_ùv6_poﬁ_√tbôs
);

1192 
	`SHOW_INT
 (
n_bˇ°_buf
);

1193 
	`SHOW_INT
 (
t˝_queue_limô
);

1194 
	`SHOW_INT
 (
ªÆ_hash_size
);

1195 
	`SHOW_INT
 (
vútuÆ_hash_size
);

1196 
	`SHOW_STR
 (
˛õ¡_c⁄√˘_s¸ùt
);

1197 
	`SHOW_STR
 (
À¨n_addªss_s¸ùt
);

1198 
	`SHOW_STR
 (
˛õ¡_disc⁄√˘_s¸ùt
);

1199 
	`SHOW_STR
 (
˛õ¡_c⁄fig_dú
);

1200 
	`SHOW_BOOL
 (
ccd_ex˛usive
);

1201 
	`SHOW_STR
 (
tmp_dú
);

1202 
	`SHOW_BOOL
 (
push_ifc⁄fig_deföed
);

1203 
	`msg
 (
D_SHOW_PARMS
, "Öush_ifc⁄fig_loˇ»%s", 
	`¥öt_ö_addr_t
 (
o
->
push_ifc⁄fig_loˇl
, 0, &
gc
));

1204 
	`msg
 (
D_SHOW_PARMS
, "Öush_ifc⁄fig_ªmŸe_√tmask = %s", 
	`¥öt_ö_addr_t
 (
o
->
push_ifc⁄fig_ªmŸe_√tmask
, 0, &
gc
));

1205 
	`SHOW_BOOL
 (
push_ifc⁄fig_ùv6_deföed
);

1206 
	`msg
 (
D_SHOW_PARMS
, "Öush_ifc⁄fig_ùv6_loˇ»%s/%d", 
	`¥öt_ö6_addr
 (
o
->
push_ifc⁄fig_ùv6_loˇl
, 0, &
gc
), o->
push_ifc⁄fig_ùv6_√tbôs
 );

1207 
	`msg
 (
D_SHOW_PARMS
, "Öush_ifc⁄fig_ùv6_ªmŸê%s", 
	`¥öt_ö6_addr
 (
o
->
push_ifc⁄fig_ùv6_ªmŸe
, 0, &
gc
));

1208 
	`SHOW_BOOL
 (
íabÀ_c2c
);

1209 
	`SHOW_BOOL
 (
du∂iˇã_˙
);

1210 
	`SHOW_INT
 (
cf_max
);

1211 
	`SHOW_INT
 (
cf_≥r
);

1212 
	`SHOW_INT
 (
max_˛õ¡s
);

1213 
	`SHOW_INT
 (
max_rouãs_≥r_˛õ¡
);

1214 
	`SHOW_STR
 (
auth_u£r_∑ss_vîify_s¸ùt
);

1215 
	`SHOW_BOOL
 (
auth_u£r_∑ss_vîify_s¸ùt_vü_fûe
);

1216 #i‡
PORT_SHARE


1217 
	`SHOW_STR
 (
p‹t_sh¨e_ho°
);

1218 
	`SHOW_INT
 (
p‹t_sh¨e_p‹t
);

1222 
	`SHOW_BOOL
 (
˛õ¡
);

1223 
	`SHOW_BOOL
 (
puŒ
);

1224 
	`SHOW_STR
 (
auth_u£r_∑ss_fûe
);

1226 
	`gc_‰ì
 (&
gc
);

1227 
	}
}

1231 #i‡
P2MP_SERVER


1234 
	$›ti⁄_úouã
 (
›ti⁄s
 *
o
,

1235 c⁄° *
√tw‹k_°r
,

1236 c⁄° *
√tmask_°r
,

1237 
msgÀvñ
)

1239 
úouã
 *
ú
;

1241 
	`ALLOC_OBJ_GC
 (
ú
, 
úouã
, &
o
->
gc
);

1242 
ú
->
√tw‹k
 = 
	`gëaddr
 (
GETADDR_HOST_ORDER
, 
√tw‹k_°r
, 0, 
NULL
, NULL);

1243 
ú
->
√tbôs
 = -1;

1245 i‡(
√tmask_°r
)

1247 c⁄° 
ö_addr_t
 
√tmask
 = 
	`gëaddr
 (
GETADDR_HOST_ORDER
, 
√tmask_°r
, 0, 
NULL
, NULL);

1248 i‡(!
	`√tmask_to_√tbôs
 (
ú
->
√tw‹k
, 
√tmask
, &ú->
√tbôs
))

1250 
	`msg
 (
msgÀvñ
, "in --iroute %s %s : BadÇetwork/subnet specification",

1251 
√tw‹k_°r
,

1252 
√tmask_°r
);

1257 
ú
->
√xt
 = 
o
->
úouãs
;

1258 
o
->
úouãs
 = 
ú
;

1259 
	}
}

1262 
	$›ti⁄_úouã_ùv6
 (
›ti⁄s
 *
o
,

1263 c⁄° *
¥efix_°r
,

1264 
msgÀvñ
)

1266 
úouã_ùv6
 *
ú
;

1268 
	`ALLOC_OBJ_GC
 (
ú
, 
úouã_ùv6
, &
o
->
gc
);

1270 i‡–
	`gë_ùv6_addr
 (
¥efix_°r
, &
ú
->
√tw‹k
, &ú->
√tbôs
, 
NULL
, 
msgÀvñ
 ) < 0 )

1272 
	`msg
 (
msgÀvñ
, "in --iroute-ipv6 %s: Bad IPv6Örefix specification",

1273 
¥efix_°r
);

1277 
ú
->
√xt
 = 
o
->
úouãs_ùv6
;

1278 
o
->
úouãs_ùv6
 = 
ú
;

1279 
	}
}

1283 #i‡
deföed
(
ENABLE_HTTP_PROXY
Ë&& !deföed(
ENABLE_SMALL
)

1285 
	$show_hâp_¥oxy_›ti⁄s
 (c⁄° 
hâp_¥oxy_›ti⁄s
 *
o
)

1287 
	`msg
 (
D_SHOW_PARMS
, "BEGIN http_proxy");

1288 
	`SHOW_STR
 (
£rvî
);

1289 
	`SHOW_INT
 (
p‹t
);

1290 
	`SHOW_STR
 (
auth_mëhod_°rög
);

1291 
	`SHOW_STR
 (
auth_fûe
);

1292 
	`SHOW_BOOL
 (
ªåy
);

1293 
	`SHOW_INT
 (
timeout
);

1294 
	`SHOW_STR
 (
hâp_vîsi⁄
);

1295 
	`SHOW_STR
 (
u£r_agít
);

1296 
	`msg
 (
D_SHOW_PARMS
, "END http_proxy");

1297 
	}
}

1301 
	$›ti⁄s_dëach
 (
›ti⁄s
 *
o
)

1303 
	`gc_dëach
 (&
o
->
gc
);

1304 
o
->
rouãs
 = 
NULL
;

1305 #ifde‡
ENABLE_CLIENT_NAT


1306 
o
->
˛õ¡_«t
 = 
NULL
;

1308 #i‡
P2MP_SERVER


1309 
	`˛⁄e_push_li°
(
o
);

1311 
	}
}

1314 
	$rﬁ_check_Æloc
 (
›ti⁄s
 *options)

1316 i‡(!
›ti⁄s
->
rouãs
)

1317 
›ti⁄s
->
rouãs
 = 
	`√w_rouã_›ti⁄_li°
 (›ti⁄s->
max_rouãs
, &›ti⁄s->
gc
);

1318 
	}
}

1321 
	$rﬁ6_check_Æloc
 (
›ti⁄s
 *options)

1323 i‡(!
›ti⁄s
->
rouãs_ùv6
)

1324 
›ti⁄s
->
rouãs_ùv6
 = 
	`√w_rouã_ùv6_›ti⁄_li°
 (›ti⁄s->
max_rouãs
, &›ti⁄s->
gc
);

1325 
	}
}

1327 #ifde‡
ENABLE_CLIENT_NAT


1329 
	$˙ﬁ_check_Æloc
 (
›ti⁄s
 *options)

1331 i‡(!
›ti⁄s
->
˛õ¡_«t
)

1332 
›ti⁄s
->
˛õ¡_«t
 = 
	`√w_˛õ¡_«t_li°
 (&›ti⁄s->
gc
);

1333 
	}
}

1336 #i‚de‡
ENABLE_SMALL


1338 
	$show_c⁄√˘i⁄_íåy
 (c⁄° 
c⁄√˘i⁄_íåy
 *
o
)

1340 
	`msg
 (
D_SHOW_PARMS
, "ÖrŸÿ%s", 
	`¥Ÿo2ascii
 (
o
->
¥Ÿo
, 
Ál£
));

1341 
	`SHOW_STR
 (
loˇl
);

1342 
	`SHOW_INT
 (
loˇl_p‹t
);

1343 
	`SHOW_STR
 (
ªmŸe
);

1344 
	`SHOW_INT
 (
ªmŸe_p‹t
);

1345 
	`SHOW_BOOL
 (
ªmŸe_Êﬂt
);

1346 
	`SHOW_BOOL
 (
böd_deföed
);

1347 
	`SHOW_BOOL
 (
böd_loˇl
);

1348 
	`SHOW_INT
 (
c⁄√˘_ªåy_£c⁄ds
);

1349 
	`SHOW_INT
 (
c⁄√˘_timeout
);

1350 
	`SHOW_INT
 (
c⁄√˘_ªåy_max
);

1352 #ifde‡
ENABLE_HTTP_PROXY


1353 i‡(
o
->
hâp_¥oxy_›ti⁄s
)

1354 
	`show_hâp_¥oxy_›ti⁄s
 (
o
->
hâp_¥oxy_›ti⁄s
);

1356 #ifde‡
ENABLE_SOCKS


1357 
	`SHOW_STR
 (
socks_¥oxy_£rvî
);

1358 
	`SHOW_INT
 (
socks_¥oxy_p‹t
);

1359 
	`SHOW_BOOL
 (
socks_¥oxy_ªåy
);

1361 
	`SHOW_INT
 (
tun_mtu
);

1362 
	`SHOW_BOOL
 (
tun_mtu_deföed
);

1363 
	`SHOW_INT
 (
lök_mtu
);

1364 
	`SHOW_BOOL
 (
lök_mtu_deföed
);

1365 
	`SHOW_INT
 (
tun_mtu_exåa
);

1366 
	`SHOW_BOOL
 (
tun_mtu_exåa_deföed
);

1368 
	`SHOW_INT
 (
mtu_discovî_ty≥
);

1370 #ifde‡
ENABLE_FRAGMENT


1371 
	`SHOW_INT
 (
‰agmít
);

1373 
	`SHOW_INT
 (
mssfix
);

1375 #ifde‡
ENABLE_OCC


1376 
	`SHOW_INT
 (
ex∂icô_exô_nŸifiˇti⁄
);

1378 
	}
}

1382 
	$show_c⁄√˘i⁄_íåõs
 (c⁄° 
›ti⁄s
 *
o
)

1384 
	`msg
 (
D_SHOW_PARMS
, "ConnectionÖrofiles [default]:");

1385 
	`show_c⁄√˘i⁄_íåy
 (&
o
->
˚
);

1386 i‡(
o
->
c⁄√˘i⁄_li°
)

1388 c⁄° 
c⁄√˘i⁄_li°
 *
l
 = 
o
->connection_list;

1389 
i
;

1390 
i
 = 0; i < 
l
->
Àn
; ++i)

1392 
	`msg
 (
D_SHOW_PARMS
, "C⁄√˘i⁄Örofûe†[%d]:", 
i
);

1393 
	`show_c⁄√˘i⁄_íåy
 (
l
->
¨øy
[
i
]);

1396 
	`msg
 (
D_SHOW_PARMS
, "ConnectionÖrofiles END");

1397 
	}
}

1402 
	$show_£âögs
 (c⁄° 
›ti⁄s
 *
o
)

1404 #i‚de‡
ENABLE_SMALL


1405 
	`msg
 (
D_SHOW_PARMS
, "Current Parameter Settings:");

1407 
	`SHOW_STR
 (
c⁄fig
);

1409 
	`SHOW_INT
 (
mode
);

1411 #ifde‡
ENABLE_FEATURE_TUN_PERSIST


1412 
	`SHOW_BOOL
 (
≥rsi°_c⁄fig
);

1413 
	`SHOW_INT
 (
≥rsi°_mode
);

1416 #ifde‡
ENABLE_CRYPTO


1417 
	`SHOW_BOOL
 (
show_cùhîs
);

1418 
	`SHOW_BOOL
 (
show_dige°s
);

1419 
	`SHOW_BOOL
 (
show_ígöes
);

1420 
	`SHOW_BOOL
 (
gíkey
);

1421 #ifde‡
ENABLE_SSL


1422 
	`SHOW_STR
 (
key_∑ss_fûe
);

1423 
	`SHOW_BOOL
 (
show_és_cùhîs
);

1427 
	`show_c⁄√˘i⁄_íåõs
 (
o
);

1429 
	`SHOW_BOOL
 (
ªmŸe_øndom
);

1431 
	`SHOW_STR
 (
ùch™ge
);

1432 
	`SHOW_STR
 (
dev
);

1433 
	`SHOW_STR
 (
dev_ty≥
);

1434 
	`SHOW_STR
 (
dev_node
);

1435 
	`SHOW_STR
 (
Œaddr
);

1436 
	`SHOW_INT
 (
t›ﬁogy
);

1437 
	`SHOW_BOOL
 (
tun_ùv6
);

1438 
	`SHOW_STR
 (
ifc⁄fig_loˇl
);

1439 
	`SHOW_STR
 (
ifc⁄fig_ªmŸe_√tmask
);

1440 
	`SHOW_BOOL
 (
ifc⁄fig_n€xec
);

1441 
	`SHOW_BOOL
 (
ifc⁄fig_now¨n
);

1442 
	`SHOW_STR
 (
ifc⁄fig_ùv6_loˇl
);

1443 
	`SHOW_INT
 (
ifc⁄fig_ùv6_√tbôs
);

1444 
	`SHOW_STR
 (
ifc⁄fig_ùv6_ªmŸe
);

1446 #ifde‡
ENABLE_FEATURE_SHAPER


1447 
	`SHOW_INT
 (
sh≠î
);

1449 #ifde‡
ENABLE_OCC


1450 
	`SHOW_INT
 (
mtu_ã°
);

1453 
	`SHOW_BOOL
 (
mlock
);

1455 
	`SHOW_INT
 (
kì∑live_pög
);

1456 
	`SHOW_INT
 (
kì∑live_timeout
);

1457 
	`SHOW_INT
 (
öa˘ivôy_timeout
);

1458 
	`SHOW_INT
 (
pög_£nd_timeout
);

1459 
	`SHOW_INT
 (
pög_ªc_timeout
);

1460 
	`SHOW_INT
 (
pög_ªc_timeout_a˘i⁄
);

1461 
	`SHOW_BOOL
 (
pög_timî_ªmŸe
);

1462 
	`SHOW_INT
 (
ªm≠_sigu§1
);

1463 
	`SHOW_BOOL
 (
≥rsi°_tun
);

1464 
	`SHOW_BOOL
 (
≥rsi°_loˇl_ù
);

1465 
	`SHOW_BOOL
 (
≥rsi°_ªmŸe_ù
);

1466 
	`SHOW_BOOL
 (
≥rsi°_key
);

1468 #i‡
PASSTOS_CAPABILITY


1469 
	`SHOW_BOOL
 (
∑s°os
);

1472 
	`SHOW_INT
 (
ªsﬁve_ªåy_£c⁄ds
);

1474 
	`SHOW_STR
 (
u£∫ame
);

1475 
	`SHOW_STR
 (
grou≤ame
);

1476 
	`SHOW_STR
 (
chroŸ_dú
);

1477 
	`SHOW_STR
 (
cd_dú
);

1478 #ifde‡
ENABLE_SELINUX


1479 
	`SHOW_STR
 (
£löux_c⁄ãxt
);

1481 
	`SHOW_STR
 (
wrôïid
);

1482 
	`SHOW_STR
 (
up_s¸ùt
);

1483 
	`SHOW_STR
 (
down_s¸ùt
);

1484 
	`SHOW_BOOL
 (
down_¥e
);

1485 
	`SHOW_BOOL
 (
up_ª°¨t
);

1486 
	`SHOW_BOOL
 (
up_dñay
);

1487 
	`SHOW_BOOL
 (
d´m⁄
);

1488 
	`SHOW_INT
 (
öëd
);

1489 
	`SHOW_BOOL
 (
log
);

1490 
	`SHOW_BOOL
 (
suµªss_time°amps
);

1491 
	`SHOW_INT
 (
ni˚
);

1492 
	`SHOW_INT
 (
vîbosôy
);

1493 
	`SHOW_INT
 (
muã
);

1494 #ifde‡
ENABLE_DEBUG


1495 
	`SHOW_INT
 (
gªmlö
);

1497 
	`SHOW_STR
 (
°©us_fûe
);

1498 
	`SHOW_INT
 (
°©us_fûe_vîsi⁄
);

1499 
	`SHOW_INT
 (
°©us_fûe_upd©e_‰eq
);

1501 #ifde‡
ENABLE_OCC


1502 
	`SHOW_BOOL
 (
occ
);

1504 
	`SHOW_INT
 (
rcvbuf
);

1505 
	`SHOW_INT
 (
¢dbuf
);

1506 #i‡
	`deföed
(
TARGET_LINUX
Ë&& 
HAVE_DECL_SO_MARK


1507 
	`SHOW_INT
 (
m¨k
);

1509 
	`SHOW_INT
 (
sockÊags
);

1511 
	`SHOW_BOOL
 (
Á°_io
);

1513 #ifde‡
ENABLE_LZO


1514 
	`SHOW_INT
 (
lzo
);

1517 
	`SHOW_STR
 (
rouã_s¸ùt
);

1518 
	`SHOW_STR
 (
rouã_deÁu…_g©eway
);

1519 
	`SHOW_INT
 (
rouã_deÁu…_mëric
);

1520 
	`SHOW_BOOL
 (
rouã_n€xec
);

1521 
	`SHOW_INT
 (
rouã_dñay
);

1522 
	`SHOW_INT
 (
rouã_dñay_wödow
);

1523 
	`SHOW_BOOL
 (
rouã_dñay_deföed
);

1524 
	`SHOW_BOOL
 (
rouã_n›uŒ
);

1525 
	`SHOW_BOOL
 (
rouã_g©eway_vü_dh˝
);

1526 
	`SHOW_INT
 (
max_rouãs
);

1527 
	`SHOW_BOOL
 (
Ælow_puŒ_fqdn
);

1528 i‡(
o
->
rouãs
)

1529 
	`¥öt_rouã_›ti⁄s
 (
o
->
rouãs
, 
D_SHOW_PARMS
);

1531 #ifde‡
ENABLE_CLIENT_NAT


1532 i‡(
o
->
˛õ¡_«t
)

1533 
	`¥öt_˛õ¡_«t_li°
(
o
->
˛õ¡_«t
, 
D_SHOW_PARMS
);

1536 #ifde‡
ENABLE_MANAGEMENT


1537 
	`SHOW_STR
 (
m™agemít_addr
);

1538 
	`SHOW_INT
 (
m™agemít_p‹t
);

1539 
	`SHOW_STR
 (
m™agemít_u£r_∑ss
);

1540 
	`SHOW_INT
 (
m™agemít_log_hi°‹y_ˇche
);

1541 
	`SHOW_INT
 (
m™agemít_echo_buf„r_size
);

1542 
	`SHOW_STR
 (
m™agemít_wrôe_≥î_öfo_fûe
);

1543 
	`SHOW_STR
 (
m™agemít_˛õ¡_u£r
);

1544 
	`SHOW_STR
 (
m™agemít_˛õ¡_group
);

1545 
	`SHOW_INT
 (
m™agemít_Êags
);

1547 #ifde‡
ENABLE_PLUGIN


1548 i‡(
o
->
∂ugö_li°
)

1549 
	`∂ugö_›ti⁄_li°_¥öt
 (
o
->
∂ugö_li°
, 
D_SHOW_PARMS
);

1552 #ifde‡
ENABLE_CRYPTO


1553 
	`SHOW_STR
 (
sh¨ed_£¸ë_fûe
);

1554 
	`SHOW_INT
 (
key_dúe˘i⁄
);

1555 
	`SHOW_BOOL
 (
cùhî«me_deföed
);

1556 
	`SHOW_STR
 (
cùhî«me
);

1557 
	`SHOW_BOOL
 (
auth«me_deföed
);

1558 
	`SHOW_STR
 (
auth«me
);

1559 
	`SHOW_STR
 (
¥ng_hash
);

1560 
	`SHOW_INT
 (
¥ng_n⁄˚_£¸ë_Àn
);

1561 
	`SHOW_INT
 (
keysize
);

1562 #i‚de‡
ENABLE_CRYPTO_POLARSSL


1563 
	`SHOW_BOOL
 (
ígöe
);

1565 
	`SHOW_BOOL
 (
ª∂ay
);

1566 
	`SHOW_BOOL
 (
muã_ª∂ay_w¨nögs
);

1567 
	`SHOW_INT
 (
ª∂ay_wödow
);

1568 
	`SHOW_INT
 (
ª∂ay_time
);

1569 
	`SHOW_STR
 (
∑ckë_id_fûe
);

1570 
	`SHOW_BOOL
 (
u£_iv
);

1571 
	`SHOW_BOOL
 (
ã°_¸y±o
);

1572 #ifde‡
ENABLE_PREDICTION_RESISTANCE


1573 
	`SHOW_BOOL
 (
u£_¥edi˘i⁄_ªsi°™˚
);

1576 #ifde‡
ENABLE_SSL


1577 
	`SHOW_BOOL
 (
és_£rvî
);

1578 
	`SHOW_BOOL
 (
és_˛õ¡
);

1579 
	`SHOW_INT
 (
key_mëhod
);

1580 
	`SHOW_STR
 (
ˇ_fûe
);

1581 
	`SHOW_STR
 (
ˇ_∑th
);

1582 
	`SHOW_STR
 (
dh_fûe
);

1583 
	`SHOW_STR
 (
˚π_fûe
);

1585 #ifde‡
MANAGMENT_EXTERNAL_KEY


1586 if((
o
->
m™agemít_Êags
 & 
MF_EXTERNAL_KEY
))

1587 
	`SHOW_PARM
 ("priv_key_file","EXTERNAL_PRIVATE_KEY","%s");

1590 
	`SHOW_STR
 (
¥iv_key_fûe
);

1591 #i‚de‡
ENABLE_CRYPTO_POLARSSL


1592 
	`SHOW_STR
 (
pkcs12_fûe
);

1594 #ifde‡
ENABLE_CRYPTOAPI


1595 
	`SHOW_STR
 (
¸y±ﬂpi_˚π
);

1597 
	`SHOW_STR
 (
cùhî_li°
);

1598 
	`SHOW_STR
 (
és_vîify
);

1599 
	`SHOW_STR
 (
és_exp‹t_˚π
);

1600 
	`SHOW_INT
 (
vîify_x509_ty≥
);

1601 
	`SHOW_STR
 (
vîify_x509_«me
);

1602 
	`SHOW_STR
 (
¸l_fûe
);

1603 
	`SHOW_INT
 (
ns_˚π_ty≥
);

1605 
i
;

1606 
i
=0;i<
MAX_PARMS
;i++)

1607 
	`SHOW_INT
 (
ªmŸe_˚π_ku
[
i
]);

1609 
	`SHOW_STR
 (
ªmŸe_˚π_eku
);

1610 
	`SHOW_INT
 (
s¶_Êags
);

1612 
	`SHOW_INT
 (
és_timeout
);

1614 
	`SHOW_INT
 (
ª√gŸüã_byãs
);

1615 
	`SHOW_INT
 (
ª√gŸüã_∑ckës
);

1616 
	`SHOW_INT
 (
ª√gŸüã_£c⁄ds
);

1618 
	`SHOW_INT
 (
h™dshake_wödow
);

1619 
	`SHOW_INT
 (
å™sôi⁄_wödow
);

1621 
	`SHOW_BOOL
 (
sögÀ_£ssi⁄
);

1622 #ifde‡
ENABLE_PUSH_PEER_INFO


1623 
	`SHOW_BOOL
 (
push_≥î_öfo
);

1625 
	`SHOW_BOOL
 (
és_exô
);

1627 
	`SHOW_STR
 (
és_auth_fûe
);

1631 #ifde‡
ENABLE_PKCS11


1633 
i
;

1634 
i
=0;i<
MAX_PARMS
 && 
o
->
pkcs11_¥ovidîs
[i] !
NULL
;i++)

1635 
	`SHOW_PARM
 (
pkcs11_¥ovidîs
, 
o
->pkcs11_¥ovidîs[
i
], "%s");

1638 
i
;

1639 
i
=0;i<
MAX_PARMS
;i++)

1640 
	`SHOW_PARM
 (
pkcs11_¥Ÿe˘ed_authítiˇti⁄
, 
o
->pkcs11_¥Ÿe˘ed_authítiˇti⁄[
i
] ? "ENABLED" : "DISABLED", "%s");

1643 
i
;

1644 
i
=0;i<
MAX_PARMS
;i++)

1645 
	`SHOW_PARM
 (
pkcs11_¥iv©e_mode
, 
o
->pkcs11_¥iv©e_mode[
i
], "%08x");

1648 
i
;

1649 
i
=0;i<
MAX_PARMS
;i++)

1650 
	`SHOW_PARM
 (
pkcs11_˚π_¥iv©e
, 
o
->pkcs11_˚π_¥iv©e[
i
] ? "ENABLED" : "DISABLED", "%s");

1652 
	`SHOW_INT
 (
pkcs11_pö_ˇche_≥riod
);

1653 
	`SHOW_STR
 (
pkcs11_id
);

1654 
	`SHOW_BOOL
 (
pkcs11_id_m™agemít
);

1657 #i‡
P2MP


1658 
	`show_p2mp_∑rms
 (
o
);

1661 #ifde‡
WIN32


1662 
	`SHOW_BOOL
 (
show_√t_up
);

1663 
	`SHOW_INT
 (
rouã_mëhod
);

1664 
	`show_tu¡≠_›ti⁄s
 (&
o
->
tu¡≠_›ti⁄s
);

1667 
	}
}

1669 #unde‡
SHOW_PARM


1670 #unde‡
SHOW_STR


1671 #unde‡
SHOW_INT


1672 #unde‡
SHOW_BOOL


1674 #i‡
HTTP_PROXY_OVERRIDE


1676 
hâp_¥oxy_›ti⁄s
 *

1677 
	$∑r£_hâp_¥oxy_ovîride
 (c⁄° *
£rvî
,

1678 c⁄° *
p‹t
,

1679 c⁄° *
Êags
,

1680 c⁄° 
msgÀvñ
,

1681 
gc_¨ía
 *
gc
)

1683 i‡(
£rvî
 && 
p‹t
)

1685 
hâp_¥oxy_›ti⁄s
 *
ho
;

1686 c⁄° 
öt_p‹t
 = 
	`©oi
(
p‹t
);

1688 i‡(!
	`ÀgÆ_ùv4_p‹t
 (
öt_p‹t
))

1690 
	`msg
 (
msgÀvñ
, "Bad hâp-¥oxyÖ‹ànumbî: %s", 
p‹t
);

1691  
NULL
;

1694 
	`ALLOC_OBJ_CLEAR_GC
 (
ho
, 
hâp_¥oxy_›ti⁄s
, 
gc
);

1695 
ho
->
£rvî
 = 
	`°rög_Æloc
(£rvî, 
gc
);

1696 
ho
->
p‹t
 = 
öt_p‹t
;

1697 
ho
->
ªåy
 = 
åue
;

1698 
ho
->
timeout
 = 5;

1699 i‡(
Êags
 && !
	`°rcmp
(flags, "nct"))

1700 
ho
->
auth_ªåy
 = 
PAR_NCT
;

1702 
ho
->
auth_ªåy
 = 
PAR_ALL
;

1703 
ho
->
hâp_vîsi⁄
 = "1.0";

1704 
ho
->
u£r_agít
 = "OpenVPN-Autoproxy/1.0";

1705  
ho
;

1708  
NULL
;

1709 
	}
}

1712 
	$›ti⁄s_po°¥o˚ss_hâp_¥oxy_ovîride
 (
›ti⁄s
 *
o
)

1714 c⁄° 
c⁄√˘i⁄_li°
 *
l
 = 
o
->connection_list;

1715 i‡(
l
)

1717 
i
;

1718 
boﬁ
 
suc˚ed
 = 
Ál£
;

1719 
i
 = 0; i < 
l
->
Àn
; ++i)

1721 
c⁄√˘i⁄_íåy
 *
˚
 = 
l
->
¨øy
[
i
];

1722 i‡(
˚
->
¥Ÿo
 =
PROTO_TCPv4_CLIENT
 || ce->¥Ÿÿ=
PROTO_TCPv4
)

1724 
˚
->
hâp_¥oxy_›ti⁄s
 = 
o
->
hâp_¥oxy_ovîride
;

1725 
suc˚ed
 = 
åue
;

1728 i‡(
suc˚ed
)

1730 
i
 = 0; i < 
l
->
Àn
; ++i)

1732 
c⁄√˘i⁄_íåy
 *
˚
 = 
l
->
¨øy
[
i
];

1733 i‡(
˚
->
¥Ÿo
 =
PROTO_UDPv4
)

1735 
˚
->
Êags
 |
CE_DISABLED
;

1740 
	`msg
 (
M_WARN
, "Note: option http-proxy-override ignored becauseÇo TCP-based connectionÖrofilesáre defined");

1742 
	}
}

1746 
c⁄√˘i⁄_li°
 *

1747 
	$Æloc_c⁄√˘i⁄_li°_if_undef
 (
›ti⁄s
 *options)

1749 i‡(!
›ti⁄s
->
c⁄√˘i⁄_li°
)

1750 
	`ALLOC_OBJ_CLEAR_GC
 (
›ti⁄s
->
c⁄√˘i⁄_li°
, c⁄√˘i⁄_li°, &›ti⁄s->
gc
);

1751  
›ti⁄s
->
c⁄√˘i⁄_li°
;

1752 
	}
}

1754 
c⁄√˘i⁄_íåy
 *

1755 
	$Æloc_c⁄√˘i⁄_íåy
 (
›ti⁄s
 *›ti⁄s, c⁄° 
msgÀvñ
)

1757 
c⁄√˘i⁄_li°
 *
l
 = 
	`Æloc_c⁄√˘i⁄_li°_if_undef
 (
›ti⁄s
);

1758 
c⁄√˘i⁄_íåy
 *
e
;

1760 i‡(
l
->
Àn
 >
CONNECTION_LIST_SIZE
)

1762 
	`msg
 (
msgÀvñ
, "MaximumÇumbî o‡'c⁄√˘i⁄' o±i⁄†(%dËex˚eded", 
CONNECTION_LIST_SIZE
);

1763  
NULL
;

1765 
	`ALLOC_OBJ_GC
 (
e
, 
c⁄√˘i⁄_íåy
, &
›ti⁄s
->
gc
);

1766 
l
->
¨øy
[l->
Àn
++] = 
e
;

1767  
e
;

1768 
	}
}

1770 
ªmŸe_li°
 *

1771 
	$Æloc_ªmŸe_li°_if_undef
 (
›ti⁄s
 *options)

1773 i‡(!
›ti⁄s
->
ªmŸe_li°
)

1774 
	`ALLOC_OBJ_CLEAR_GC
 (
›ti⁄s
->
ªmŸe_li°
, ªmŸe_li°, &›ti⁄s->
gc
);

1775  
›ti⁄s
->
ªmŸe_li°
;

1776 
	}
}

1778 
ªmŸe_íåy
 *

1779 
	$Æloc_ªmŸe_íåy
 (
›ti⁄s
 *›ti⁄s, c⁄° 
msgÀvñ
)

1781 
ªmŸe_li°
 *
l
 = 
	`Æloc_ªmŸe_li°_if_undef
 (
›ti⁄s
);

1782 
ªmŸe_íåy
 *
e
;

1784 i‡(
l
->
Àn
 >
CONNECTION_LIST_SIZE
)

1786 
	`msg
 (
msgÀvñ
, "MaximumÇumbî o‡'ªmŸe' o±i⁄†(%dËex˚eded", 
CONNECTION_LIST_SIZE
);

1787  
NULL
;

1789 
	`ALLOC_OBJ_GC
 (
e
, 
ªmŸe_íåy
, &
›ti⁄s
->
gc
);

1790 
l
->
¨øy
[l->
Àn
++] = 
e
;

1791  
e
;

1792 
	}
}

1795 
	$c⁄√˘i⁄_íåy_lﬂd_ª
 (
c⁄√˘i⁄_íåy
 *
˚
, c⁄° 
ªmŸe_íåy
 *
ª
)

1797 i‡(
ª
->
ªmŸe
)

1798 
˚
->
ªmŸe
 = 
ª
->remote;

1799 i‡(
ª
->
ªmŸe_p‹t
 >= 0)

1800 
˚
->
ªmŸe_p‹t
 = 
ª
->remote_port;

1801 i‡(
ª
->
¥Ÿo
 >= 0)

1802 
˚
->
¥Ÿo
 = 
ª
->proto;

1803 
	}
}

1806 
	$›ti⁄s_po°¥o˚ss_vîify_˚
 (c⁄° 
›ti⁄s
 *›ti⁄s, c⁄° 
c⁄√˘i⁄_íåy
 *
˚
)

1808 
›ti⁄s
 
deÁu…s
;

1809 
dev
 = 
DEV_TYPE_UNDEF
;

1810 
boﬁ
 
puŒ
 = 
Ál£
;

1812 
	`öô_›ti⁄s
 (&
deÁu…s
, 
åue
);

1814 #ifde‡
ENABLE_CRYPTO


1815 i‡(
›ti⁄s
->
ã°_¸y±o
)

1817 
	`nŸnuŒ
 (
›ti⁄s
->
sh¨ed_£¸ë_fûe
, "key file (--secret)");

1821 
	`nŸnuŒ
 (
›ti⁄s
->
dev
, "TUN/TAP device (--dev)");

1826 
dev
 = 
	`dev_ty≥_íum
 (
›ti⁄s
->dev, o±i⁄s->
dev_ty≥
);

1832 i‡(
˚
->
¥Ÿo
 =
PROTO_TCPv4
)

1833 
	`msg
 (
M_USAGE
, "--protoÅcp isámbiguous inÅhis context. Please specify --protoÅcp-server or --protoÅcp-client");

1834 i‡(
˚
->
¥Ÿo
 =
PROTO_TCPv6
)

1835 
	`msg
 (
M_USAGE
, "--protoÅcp6 isámbiguous inÅhis context. Please specify --protoÅcp6-server or --protoÅcp6-client");

1841 i‡(
›ti⁄s
->
d´m⁄
 && o±i⁄s->
öëd
)

1842 
	`msg
 (
M_USAGE
, "only one of --daemon or --inetd may be specified");

1844 i‡(
›ti⁄s
->
öëd
 && (
˚
->
loˇl
 || ce->
ªmŸe
))

1845 
	`msg
 (
M_USAGE
, "--local or --remote cannot be used with --inetd");

1847 i‡(
›ti⁄s
->
öëd
 && 
˚
->
¥Ÿo
 =
PROTO_TCPv4_CLIENT
)

1848 
	`msg
 (
M_USAGE
, "--protoÅcp-client cannot be used with --inetd");

1850 i‡(
›ti⁄s
->
öëd
 =
INETD_NOWAIT
 && 
˚
->
¥Ÿo
 !
PROTO_TCPv4_SERVER
)

1851 
	`msg
 (
M_USAGE
, "--inetdÇowait can only be used with --protoÅcp-server");

1853 i‡(
›ti⁄s
->
öëd
 =
INETD_NOWAIT


1854 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

1855 && !(
›ti⁄s
->
és_£rvî
 || o±i⁄s->
és_˛õ¡
)

1858 
	`msg
 (
M_USAGE
, "--inetdÇowait can only be used in TLS mode");

1860 i‡(
›ti⁄s
->
öëd
 =
INETD_NOWAIT
 && 
dev
 !
DEV_TYPE_TAP
)

1861 
	`msg
 (
M_USAGE
, "--inetdÇowait only makes sense in --devÅap mode");

1864 i‡(
›ti⁄s
->
Œaddr
 && 
dev
 !
DEV_TYPE_TAP
)

1865 
	`msg
 (
M_USAGE
, "--lladdr can only be used in --devÅap mode");

1871 i‡(
˚
->
c⁄√˘_ªåy_deföed
 && ce->
¥Ÿo
 !
PROTO_TCPv4_CLIENT


1872 && 
˚
->
¥Ÿo
 !
PROTO_TCPv6_CLIENT
)

1873 
	`msg
 (
M_USAGE
, "--connect-retry doesn't make sense unlessálso used with "

1876 i‡(
˚
->
c⁄√˘_timeout_deföed
 && ce->
¥Ÿo
 !
PROTO_TCPv4_CLIENT


1877 && 
˚
->
¥Ÿo
 !
PROTO_TCPv6_CLIENT
)

1878 
	`msg
 (
M_USAGE
, "--connect-timeout doesn't make sense unlessálso used with "

1884 i‡(
›ti⁄s
->
˚
.
tun_mtu_deföed
 && o±i⁄s->˚.
lök_mtu_deföed
)

1885 
	`msg
 (
M_USAGE
, "⁄ly o√ o‡--tun-mtu o∏--lök-mtu may bêdeföed (nŸêth© --ifc⁄fig im∂õ†--lök-mtu %d)", 
LINK_MTU_DEFAULT
);

1887 #ifde‡
ENABLE_OCC


1888 i‡(!
	`¥Ÿo_is_udp
(
˚
->
¥Ÿo
Ë&& 
›ti⁄s
->
mtu_ã°
)

1889 
	`msg
 (
M_USAGE
, "--mtu-test only makes sense with --proto udp");

1893 #i‡
P2MP


1894 
puŒ
 = 
›ti⁄s
->pull;

1901 i‡(
	`¥Ÿo_is_√t
(
˚
->
¥Ÿo
)

1902 && 
	`°rög_deföed_equÆ
 (
˚
->
loˇl
, ce->
ªmŸe
)

1903 && 
˚
->
loˇl_p‹t
 =˚->
ªmŸe_p‹t
)

1904 
	`msg
 (
M_USAGE
, "--remoteánd --localáddressesáreÅhe same");

1906 i‡(
	`°rög_deföed_equÆ
 (
˚
->
ªmŸe
, 
›ti⁄s
->
ifc⁄fig_loˇl
)

1907 || 
	`°rög_deföed_equÆ
 (
˚
->
ªmŸe
, 
›ti⁄s
->
ifc⁄fig_ªmŸe_√tmask
))

1908 
	`msg
 (
M_USAGE
, "--localánd --remoteáddresses must be distinct from --ifconfigáddresses");

1910 i‡(
	`°rög_deföed_equÆ
 (
˚
->
loˇl
, 
›ti⁄s
->
ifc⁄fig_loˇl
)

1911 || 
	`°rög_deföed_equÆ
 (
˚
->
loˇl
, 
›ti⁄s
->
ifc⁄fig_ªmŸe_√tmask
))

1912 
	`msg
 (
M_USAGE
, "--localáddresses must be distinct from --ifconfigáddresses");

1914 i‡(
	`°rög_deföed_equÆ
 (
›ti⁄s
->
ifc⁄fig_loˇl
, o±i⁄s->
ifc⁄fig_ªmŸe_√tmask
))

1915 
	`msg
 (
M_USAGE
, "localándÑemote/netmask --ifconfigáddresses must be different");

1917 i‡(
˚
->
böd_deföed
 && !˚->
böd_loˇl
)

1918 
	`msg
 (
M_USAGE
, "--bindánd --nobind can't be usedÅogether");

1920 i‡(
˚
->
loˇl
 && !˚->
böd_loˇl
)

1921 
	`msg
 (
M_USAGE
, "--localánd --nobind don't make sense when usedÅogether");

1923 i‡(
˚
->
loˇl_p‹t_deföed
 && !˚->
böd_loˇl
)

1924 
	`msg
 (
M_USAGE
, "--lportánd --nobind don't make sense when usedÅogether");

1926 i‡(!
˚
->
ªmŸe
 && !˚->
böd_loˇl
)

1927 
	`msg
 (
M_USAGE
, "--nobind doesn't make sense unless used with --remote");

1932 #ifde‡
ENABLE_MANAGEMENT


1933 i‡(!
›ti⁄s
->
m™agemít_addr
 &&

1934 (
›ti⁄s
->
m™agemít_Êags


1935 || 
›ti⁄s
->
m™agemít_wrôe_≥î_öfo_fûe


1936 || 
›ti⁄s
->
m™agemít_log_hi°‹y_ˇche
 !
deÁu…s
.management_log_history_cache))

1937 
	`msg
 (
M_USAGE
, "--management isÇot specified, however one or more options which modifyÅhe behavior of --management were specified");

1939 i‡((
›ti⁄s
->
m™agemít_˛õ¡_u£r
 || o±i⁄s->
m™agemít_˛õ¡_group
)

1940 && !(
›ti⁄s
->
m™agemít_Êags
 & 
MF_UNIX_SOCK
))

1941 
	`msg
 (
M_USAGE
, "--management-client-(user|group) can only be used on unix domain sockets");

1948 #ifde‡
WIN32


1949 i‡(
dev
 =
DEV_TYPE_TUN
 && !(
puŒ
 || (
›ti⁄s
->
ifc⁄fig_loˇl
 && o±i⁄s->
ifc⁄fig_ªmŸe_√tmask
)))

1950 
	`msg
 (
M_USAGE
, "On Windows, --ifconfig isÑequired when --devÅun is used");

1952 i‡((
›ti⁄s
->
tu¡≠_›ti⁄s
.
ù_wö32_deföed
)

1953 && !(
puŒ
 || (
›ti⁄s
->
ifc⁄fig_loˇl
 && o±i⁄s->
ifc⁄fig_ªmŸe_√tmask
)))

1954 
	`msg
 (
M_USAGE
, "On Windows, --ip-win32 doesn't make sense unless --ifconfig isálso used");

1956 i‡(
›ti⁄s
->
tu¡≠_›ti⁄s
.
dh˝_›ti⁄s


1957 && 
›ti⁄s
->
tu¡≠_›ti⁄s
.
ù_wö32_ty≥
 !
IPW32_SET_DHCP_MASQ


1958 && 
›ti⁄s
->
tu¡≠_›ti⁄s
.
ù_wö32_ty≥
 !
IPW32_SET_ADAPTIVE
)

1959 
	`msg
 (
M_USAGE
, "--dhcp-optionsÑequires --ip-win32 dynamic orádaptive");

1966 #ifde‡
ENABLE_FRAGMENT


1967 i‡(!
	`¥Ÿo_is_udp
(
˚
->
¥Ÿo
Ë&& ce->
‰agmít
)

1968 
	`msg
 (
M_USAGE
, "--fragment can only be used with --proto udp");

1971 #ifde‡
ENABLE_OCC


1972 i‡(!
	`¥Ÿo_is_udp
(
˚
->
¥Ÿo
Ë&& ce->
ex∂icô_exô_nŸifiˇti⁄
)

1973 
	`msg
 (
M_USAGE
, "--explicit-exit-notify can only be used with --proto udp");

1976 i‡(!
˚
->
ªmŸe
 && (˚->
¥Ÿo
 =
PROTO_TCPv4_CLIENT


1977 || 
˚
->
¥Ÿo
 =
PROTO_TCPv6_CLIENT
))

1978 
	`msg
 (
M_USAGE
, "--remote MUST be used in TCP Client mode");

1980 #ifde‡
ENABLE_HTTP_PROXY


1981 i‡((
˚
->
hâp_¥oxy_›ti⁄s
Ë&& ce->
¥Ÿo
 !
PROTO_TCPv4_CLIENT
)

1982 
	`msg
 (
M_USAGE
, "--http-proxy MUST be used in TCP Client mode (i.e. --protoÅcp-client)");

1983 i‡((
˚
->
hâp_¥oxy_›ti⁄s
Ë&& !˚->hâp_¥oxy_›ti⁄s->
£rvî
)

1984 
	`msg
 (
M_USAGE
, "--http-proxyÇot specified but other httpÖroxy optionsÖresent");

1987 #i‡
	`deföed
(
ENABLE_HTTP_PROXY
Ë&& deföed(
ENABLE_SOCKS
)

1988 i‡(
˚
->
hâp_¥oxy_›ti⁄s
 && ce->
socks_¥oxy_£rvî
)

1989 
	`msg
 (
M_USAGE
, "--http-proxy canÇot be usedÅogether with --socks-proxy");

1992 #ifde‡
ENABLE_SOCKS


1993 i‡(
˚
->
socks_¥oxy_£rvî
 && ce->
¥Ÿo
 =
PROTO_TCPv4_SERVER
)

1994 
	`msg
 (
M_USAGE
, "--socks-proxy canÇot be used in TCP Server mode");

1997 i‡((
˚
->
¥Ÿo
 =
PROTO_TCPv4_SERVER
 || ce->¥Ÿÿ=
PROTO_TCPv6_SERVER
)

1998 && 
	`c⁄√˘i⁄_li°_deföed
 (
›ti⁄s
))

1999 
	`msg
 (
M_USAGE
, "TCP server modeállowsát most one --remoteáddress");

2001 #i‡
P2MP_SERVER


2006 i‡(
›ti⁄s
->
mode
 =
MODE_SERVER
)

2008 i‡(!(
dev
 =
DEV_TYPE_TUN
 || dev =
DEV_TYPE_TAP
))

2009 
	`msg
 (
M_USAGE
, "--mode server only works with --devÅun or --devÅap");

2010 i‡(
›ti⁄s
->
puŒ
)

2011 
	`msg
 (
M_USAGE
, "--pull cannot be used with --mode server");

2012 i‡(!(
	`¥Ÿo_is_udp
(
˚
->
¥Ÿo
Ë|| ce->¥Ÿÿ=
PROTO_TCPv4_SERVER


2013 || 
˚
->
¥Ÿo
 =
PROTO_TCPv6_SERVER
))

2014 
	`msg
 (
M_USAGE
, "--mode server currently only supports "

2016 #i‡
PORT_SHARE


2017 i‡((
›ti⁄s
->
p‹t_sh¨e_ho°
 || o±i⁄s->
p‹t_sh¨e_p‹t
) &&

2018 (
˚
->
¥Ÿo
 !
PROTO_TCPv4_SERVER
 && ce->¥Ÿÿ!
PROTO_TCPv6_SERVER
))

2019 
	`msg
 (
M_USAGE
, "--port-share only works in TCP server mode "

2022 i‡(!
›ti⁄s
->
és_£rvî
)

2023 
	`msg
 (
M_USAGE
, "--mode serverÑequires --tls-server");

2024 i‡(
˚
->
ªmŸe
)

2025 
	`msg
 (
M_USAGE
, "--remote cannot be used with --mode server");

2026 i‡(!
˚
->
böd_loˇl
)

2027 
	`msg
 (
M_USAGE
, "--nobind cannot be used with --mode server");

2028 #ifde‡
ENABLE_HTTP_PROXY


2029 i‡(
˚
->
hâp_¥oxy_›ti⁄s
)

2030 
	`msg
 (
M_USAGE
, "--http-proxy cannot be used with --mode server");

2032 #ifde‡
ENABLE_SOCKS


2033 i‡(
˚
->
socks_¥oxy_£rvî
)

2034 
	`msg
 (
M_USAGE
, "--socks-proxy cannot be used with --mode server");

2036 i‡(
›ti⁄s
->
c⁄√˘i⁄_li°
)

2037 
	`msg
 (
M_USAGE
, "<connection> cannot be used with --mode server");

2039 i‡(
›ti⁄s
->
tun_ùv6
)

2040 
	`msg
 (
M_USAGE
, "--tun-ipv6 cannot be used with --mode server");

2042 i‡(
›ti⁄s
->
sh≠î
)

2043 
	`msg
 (
M_USAGE
, "--shaper cannot be used with --mode server");

2044 i‡(
›ti⁄s
->
öëd
)

2045 
	`msg
 (
M_USAGE
, "--inetd cannot be used with --mode server");

2046 i‡(
›ti⁄s
->
ùch™ge
)

2047 
	`msg
 (
M_USAGE
, "--ipchange cannot be used with --mode server (use --client-connect instead)");

2048 i‡(!(
	`¥Ÿo_is_dgøm
(
˚
->
¥Ÿo
Ë|| ce->¥Ÿÿ=
PROTO_TCPv4_SERVER


2049 || 
˚
->
¥Ÿo
 =
PROTO_TCPv6_SERVER
))

2050 
	`msg
 (
M_USAGE
, "--mode server currently only supports "

2052 i‡(!
	`¥Ÿo_is_udp
(
˚
->
¥Ÿo
Ë&& (
›ti⁄s
->
cf_max
 || o±i⁄s->
cf_≥r
))

2053 
	`msg
 (
M_USAGE
, "--connect-freq only works with --mode server --proto udp. Try --max-clients instead.");

2054 i‡(!(
dev
 =
DEV_TYPE_TAP
 || (dev =
DEV_TYPE_TUN
 && 
›ti⁄s
->
t›ﬁogy
 =
TOP_SUBNET
)Ë&& o±i⁄s->
ifc⁄fig_poﬁ_√tmask
)

2055 
	`msg
 (
M_USAGE
, "TheÅhirdÖarameterÅo --ifconfig-pool (netmask) is only valid in --devÅap mode");

2056 #ifde‡
ENABLE_OCC


2057 i‡(
˚
->
ex∂icô_exô_nŸifiˇti⁄
)

2058 
	`msg
 (
M_USAGE
, "--explicit-exit-notify cannot be used with --mode server");

2060 i‡(
›ti⁄s
->
rouãs
 && (›ti⁄s->rouãs->
Êags
 & 
RG_ENABLE
))

2061 
	`msg
 (
M_USAGE
, "--redirect-gateway cannot be used with --mode server (however --push \"redirect-gateway\" is fine)");

2062 i‡(
›ti⁄s
->
rouã_dñay_deföed
)

2063 
	`msg
 (
M_USAGE
, "--route-delay cannot be used with --mode server");

2064 i‡(
›ti⁄s
->
up_dñay
)

2065 
	`msg
 (
M_USAGE
, "--up-delay cannot be used with --mode server");

2066 i‡(!
›ti⁄s
->
ifc⁄fig_poﬁ_deföed
 && o±i⁄s->
ifc⁄fig_poﬁ_≥rsi°_fûíame
)

2067 
	`msg
 (
M_USAGE
, "--ifconfig-pool-persist must be used with --ifconfig-pool");

2068 i‡(
›ti⁄s
->
ifc⁄fig_ùv6_poﬁ_deföed
 && !›ti⁄s->
ifc⁄fig_ùv6_loˇl
 )

2069 
	`msg
 (
M_USAGE
, "--ifconfig-ipv6-poolÇeeds --ifconfig-ipv6");

2070 i‡(
›ti⁄s
->
ifc⁄fig_ùv6_loˇl
 && !›ti⁄s->
tun_ùv6
 )

2071 
	`msg
 (
M_INFO
, "Warning: --ifconfig-ipv6 without --tun-ipv6 willÇot do IPv6");

2073 i‡(
›ti⁄s
->
auth_u£r_∑ss_fûe
)

2074 
	`msg
 (
M_USAGE
, "--auth-user-pass cannot be used with --mode server (it should be used onÅhe client side only)");

2075 i‡(
›ti⁄s
->
ccd_ex˛usive
 && !›ti⁄s->
˛õ¡_c⁄fig_dú
)

2076 
	`msg
 (
M_USAGE
, "--ccd-exclusive must be used with --client-config-dir");

2077 i‡(
›ti⁄s
->
key_mëhod
 != 2)

2078 
	`msg
 (
M_USAGE
, "--mode serverÑequires --key-method 2");

2081 c⁄° 
boﬁ
 
c˙r
 = (
›ti⁄s
->
auth_u£r_∑ss_vîify_s¸ùt


2082 || 
	`PLUGIN_OPTION_LIST
 (
›ti⁄s
)

2083 || 
	`MAN_CLIENT_AUTH_ENABLED
 (
›ti⁄s
));

2084 c⁄° *
po°fix
 = "must be used with --management-client-auth,án --auth-user-pass-verify script, orÖlugin";

2085 i‡((
›ti⁄s
->
s¶_Êags
 & 
SSLF_CLIENT_CERT_NOT_REQUIRED
Ë&& !
c˙r
)

2086 
	`msg
 (
M_USAGE
, "--˛õ¡-˚π-nŸ-ªquúed %s", 
po°fix
);

2087 i‡((
›ti⁄s
->
s¶_Êags
 & 
SSLF_USERNAME_AS_COMMON_NAME
Ë&& !
c˙r
)

2088 
	`msg
 (
M_USAGE
, "--u£∫ame-as-comm⁄-«mê%s", 
po°fix
);

2089 i‡((
›ti⁄s
->
s¶_Êags
 & 
SSLF_AUTH_USER_PASS_OPTIONAL
Ë&& !
c˙r
)

2090 
	`msg
 (
M_USAGE
, "--auth-u£r-∑ss-›ti⁄Æ %s", 
po°fix
);

2099 i‡(
›ti⁄s
->
ifc⁄fig_poﬁ_deföed
 || o±i⁄s->
ifc⁄fig_poﬁ_≥rsi°_fûíame
)

2100 
	`msg
 (
M_USAGE
, "--ifconfig-pool/--ifconfig-pool-persistÑequires --mode server");

2101 i‡(
›ti⁄s
->
ifc⁄fig_ùv6_poﬁ_deföed
)

2102 
	`msg
 (
M_USAGE
, "--ifconfig-ipv6-poolÑequires --mode server");

2103 i‡(
›ti⁄s
->
ªÆ_hash_size
 !
deÁu…s
.real_hash_size

2104 || 
›ti⁄s
->
vútuÆ_hash_size
 !
deÁu…s
.virtual_hash_size)

2105 
	`msg
 (
M_USAGE
, "--hash-sizeÑequires --mode server");

2106 i‡(
›ti⁄s
->
À¨n_addªss_s¸ùt
)

2107 
	`msg
 (
M_USAGE
, "--learn-addressÑequires --mode server");

2108 i‡(
›ti⁄s
->
˛õ¡_c⁄√˘_s¸ùt
)

2109 
	`msg
 (
M_USAGE
, "--client-connectÑequires --mode server");

2110 i‡(
›ti⁄s
->
˛õ¡_disc⁄√˘_s¸ùt
)

2111 
	`msg
 (
M_USAGE
, "--client-disconnectÑequires --mode server");

2112 i‡(
›ti⁄s
->
˛õ¡_c⁄fig_dú
 || o±i⁄s->
ccd_ex˛usive
)

2113 
	`msg
 (
M_USAGE
, "--client-config-dir/--ccd-exclusiveÑequires --mode server");

2114 i‡(
›ti⁄s
->
íabÀ_c2c
)

2115 
	`msg
 (
M_USAGE
, "--client-to-clientÑequires --mode server");

2116 i‡(
›ti⁄s
->
du∂iˇã_˙
)

2117 
	`msg
 (
M_USAGE
, "--duplicate-cnÑequires --mode server");

2118 i‡(
›ti⁄s
->
cf_max
 || o±i⁄s->
cf_≥r
)

2119 
	`msg
 (
M_USAGE
, "--connect-freqÑequires --mode server");

2120 i‡(
›ti⁄s
->
s¶_Êags
 & 
SSLF_CLIENT_CERT_NOT_REQUIRED
)

2121 
	`msg
 (
M_USAGE
, "--client-cert-not-requiredÑequires --mode server");

2122 i‡(
›ti⁄s
->
s¶_Êags
 & 
SSLF_USERNAME_AS_COMMON_NAME
)

2123 
	`msg
 (
M_USAGE
, "--username-as-common-nameÑequires --mode server");

2124 i‡(
›ti⁄s
->
s¶_Êags
 & 
SSLF_AUTH_USER_PASS_OPTIONAL
)

2125 
	`msg
 (
M_USAGE
, "--auth-user-pass-optionalÑequires --mode server");

2126 i‡(
›ti⁄s
->
s¶_Êags
 & 
SSLF_OPT_VERIFY
)

2127 
	`msg
 (
M_USAGE
, "--opt-verifyÑequires --mode server");

2128 i‡(
›ti⁄s
->
£rvî_Êags
 & 
SF_TCP_NODELAY_HELPER
)

2129 
	`msg
 (
M_USAGE
, "--tcp-nodelayÑequires --mode server");

2130 i‡(
›ti⁄s
->
auth_u£r_∑ss_vîify_s¸ùt
)

2131 
	`msg
 (
M_USAGE
, "--auth-user-pass-verifyÑequires --mode server");

2132 #i‡
PORT_SHARE


2133 i‡(
›ti⁄s
->
p‹t_sh¨e_ho°
 || o±i⁄s->
p‹t_sh¨e_p‹t
)

2134 
	`msg
 (
M_USAGE
, "--port-shareÑequires TCP server mode (--mode server --protoÅcp-server)");

2137 i‡(
›ti⁄s
->
°Æe_rouãs_check_öãrvÆ
)

2138 
	`msg
 (
M_USAGE
, "--stale-routes-checkÑequires --mode server");

2139 i‡(
	`com∑t_Êag
 (
COMPAT_FLAG_QUERY
 | 
COMPAT_NO_NAME_REMAPPING
))

2140 
	`msg
 (
M_USAGE
, "--compat-x509-namesÇo-remappingÑequires --mode server");

2144 #ifde‡
ENABLE_CRYPTO


2149 i‡((!
	`¥Ÿo_is_udp
(
˚
->
¥Ÿo
))

2150 && (
›ti⁄s
->
ª∂ay_wödow
 !
deÁu…s
.replay_window

2151 || 
›ti⁄s
->
ª∂ay_time
 !
deÁu…s
.replay_time))

2152 
	`msg
 (
M_USAGE
, "--replay-window only makes sense with --proto udp");

2154 i‡(!
›ti⁄s
->
ª∂ay


2155 && (
›ti⁄s
->
ª∂ay_wödow
 !
deÁu…s
.replay_window

2156 || 
›ti⁄s
->
ª∂ay_time
 !
deÁu…s
.replay_time))

2157 
	`msg
 (
M_USAGE
, "--replay-window doesn't make sense whenÑeplayÖrotection is disabled with --no-replay");

2163 #ifde‡
ENABLE_SSL


2164 i‡(
›ti⁄s
->
és_£rvî
 + o±i⁄s->
és_˛õ¡
 +

2165 (
›ti⁄s
->
sh¨ed_£¸ë_fûe
 !
NULL
) > 1)

2166 
	`msg
 (
M_USAGE
, "specify only one of --tls-server, --tls-client, or --secret");

2168 i‡(
›ti⁄s
->
és_£rvî
)

2170 
	`nŸnuŒ
 (
›ti⁄s
->
dh_fûe
, "DH file (--dh)");

2172 i‡(
›ti⁄s
->
és_£rvî
 || o±i⁄s->
és_˛õ¡
)

2174 #ifde‡
ENABLE_PKCS11


2175 i‡(
›ti⁄s
->
pkcs11_¥ovidîs
[0])

2177 
	`nŸnuŒ
 (
›ti⁄s
->
ˇ_fûe
, "CA file (--ca)");

2179 i‡(
›ti⁄s
->
pkcs11_id_m™agemít
 && o±i⁄s->
pkcs11_id
 !
NULL
)

2180 
	`msg
(
M_USAGE
, "Parameter --pkcs11-id cannot be used when --pkcs11-id-management isálso specified.");

2181 i‡(!
›ti⁄s
->
pkcs11_id_m™agemít
 && o±i⁄s->
pkcs11_id
 =
NULL
)

2182 
	`msg
(
M_USAGE
, "Parameter --pkcs11-id or --pkcs11-id-management should be specified.");

2183 i‡(
›ti⁄s
->
˚π_fûe
)

2184 
	`msg
(
M_USAGE
, "Parameter --cert cannot be used when --pkcs11-provider isálso specified.");

2185 i‡(
›ti⁄s
->
¥iv_key_fûe
)

2186 
	`msg
(
M_USAGE
, "Parameter --key cannot be used when --pkcs11-provider isálso specified.");

2187 #ifde‡
MANAGMENT_EXTERNAL_KEY


2188 i‡(
›ti⁄s
->
m™agemít_Êags
 & 
MF_EXTERNAL_KEY
)

2189 
	`msg
(
M_USAGE
, "Parameter --management-external-key cannot be used when --pkcs11-provider isálso specified.");

2191 i‡(
›ti⁄s
->
pkcs12_fûe
)

2192 
	`msg
(
M_USAGE
, "Parameter --pkcs12 cannot be used when --pkcs11-provider isálso specified.");

2193 #ifde‡
ENABLE_CRYPTOAPI


2194 i‡(
›ti⁄s
->
¸y±ﬂpi_˚π
)

2195 
	`msg
(
M_USAGE
, "Parameter --cryptoapicert cannot be used when --pkcs11-provider isálso specified.");

2200 #ifde‡
MANAGMENT_EXTERNAL_KEY


2201 if((
›ti⁄s
->
m™agemít_Êags
 & 
MF_EXTERNAL_KEY
Ë&& o±i⁄s->
¥iv_key_fûe
)

2203 
	`msg
 (
M_USAGE
, "--keyánd --management-external-keyáre mutuallyÉxclusive");

2207 #ifde‡
ENABLE_CRYPTOAPI


2208 i‡(
›ti⁄s
->
¸y±ﬂpi_˚π
)

2210 i‡((!(
›ti⁄s
->
ˇ_fûe
)Ë&& (!(›ti⁄s->
ˇ_∑th
)))

2211 
	`msg
(
M_USAGE
, "You must define CA file (--ca) or CAÖath (--capath)");

2212 i‡(
›ti⁄s
->
˚π_fûe
)

2213 
	`msg
(
M_USAGE
, "Parameter --cert cannot be used when --cryptoapicert isálso specified.");

2214 i‡(
›ti⁄s
->
¥iv_key_fûe
)

2215 
	`msg
(
M_USAGE
, "Parameter --key cannot be used when --cryptoapicert isálso specified.");

2216 i‡(
›ti⁄s
->
pkcs12_fûe
)

2217 
	`msg
(
M_USAGE
, "Parameter --pkcs12 cannot be used when --cryptoapicert isálso specified.");

2218 #ifde‡
MANAGMENT_EXTERNAL_KEY


2219 i‡(
›ti⁄s
->
m™agemít_Êags
 & 
MF_EXTERNAL_KEY
)

2220 
	`msg
(
M_USAGE
, "Parameter --management-external-key cannot be used when --cryptoapicert isálso specified.");

2225 i‡(
›ti⁄s
->
pkcs12_fûe
)

2227 #ifde‡
ENABLE_CRYPTO_POLARSSL


2228 
	`msg
(
M_USAGE
, "Parameter --pkcs12 cannot be used withÅhe PolarSSL version version of OpenVPN.");

2230 i‡(
›ti⁄s
->
ˇ_∑th
)

2231 
	`msg
(
M_USAGE
, "Parameter --capath cannot be used when --pkcs12 isálso specified.");

2232 i‡(
›ti⁄s
->
˚π_fûe
)

2233 
	`msg
(
M_USAGE
, "Parameter --cert cannot be used when --pkcs12 isálso specified.");

2234 i‡(
›ti⁄s
->
¥iv_key_fûe
)

2235 
	`msg
(
M_USAGE
, "Parameter --key cannot be used when --pkcs12 isálso specified.");

2236 #ifde‡
MANAGMENT_EXTERNAL_KEY


2237 i‡(
›ti⁄s
->
m™agemít_Êags
 & 
MF_EXTERNAL_KEY
)

2238 
	`msg
(
M_USAGE
, "Parameter --external-management-key cannot be used when --pkcs12 isálso specified.");

2244 #ifde‡
ENABLE_CRYPTO_POLARSSL


2245 i‡(!(
›ti⁄s
->
ˇ_fûe
))

2246 
	`msg
(
M_USAGE
, "You must define CA file (--ca)");

2247 i‡(
›ti⁄s
->
ˇ_∑th
)

2248 
	`msg
(
M_USAGE
, "Parameter --capath cannot be used withÅhe PolarSSL version version of OpenVPN.");

2250 i‡((!(
›ti⁄s
->
ˇ_fûe
)Ë&& (!(›ti⁄s->
ˇ_∑th
)))

2251 
	`msg
(
M_USAGE
, "You must define CA file (--ca) or CAÖath (--capath)");

2253 i‡(
puŒ
)

2256 c⁄° 
sum
 = (
›ti⁄s
->
˚π_fûe
 !
NULL
) +

2257 #ifde‡
MANAGMENT_EXTERNAL_KEY


2258 ((
›ti⁄s
->
¥iv_key_fûe
 !
NULL
Ë|| (›ti⁄s->
m™agemít_Êags
 & 
MF_EXTERNAL_KEY
));

2260 (
›ti⁄s
->
¥iv_key_fûe
 !
NULL
);

2264 i‡(
sum
 == 0)

2266 #i‡
P2MP


2267 i‡(!
›ti⁄s
->
auth_u£r_∑ss_fûe
)

2269 
	`msg
 (
M_USAGE
, "No client-sideáuthentication method is specified. You must useÉither --cert/--key, --pkcs12, or --auth-user-pass");

2271 i‡(
sum
 == 2)

2275 
	`msg
 (
M_USAGE
, "If you use one of --cert or --key, you must useÅhem both");

2280 
	`nŸnuŒ
 (
›ti⁄s
->
˚π_fûe
, "certificate file (--cert) or PKCS#12 file (--pkcs12)");

2281 #ifde‡
MANAGMENT_EXTERNAL_KEY


2282 i‡(!(
›ti⁄s
->
m™agemít_Êags
 & 
MF_EXTERNAL_KEY
))

2284 
	`nŸnuŒ
 (
›ti⁄s
->
¥iv_key_fûe
, "private key file (--key) or PKCS#12 file (--pkcs12)");

2295 
	#MUST_BE_UNDEF
(
∑rm
Ëi‡(
›ti⁄s
->∑rm !
deÁu…s
.∑rmË
	`msg
 (
M_USAGE
, 
îr
, #∑rm);

	)

2297 c⁄° 
îr
[] = "Parameter %s can only be specified in TLS-mode, i.e. where --tls-server or --tls-client isálso specified.";

2299 
	`MUST_BE_UNDEF
 (
ˇ_fûe
);

2300 
	`MUST_BE_UNDEF
 (
ˇ_∑th
);

2301 
	`MUST_BE_UNDEF
 (
dh_fûe
);

2302 
	`MUST_BE_UNDEF
 (
˚π_fûe
);

2303 
	`MUST_BE_UNDEF
 (
¥iv_key_fûe
);

2304 #i‚de‡
ENABLE_CRYPTO_POLARSSL


2305 
	`MUST_BE_UNDEF
 (
pkcs12_fûe
);

2307 
	`MUST_BE_UNDEF
 (
cùhî_li°
);

2308 
	`MUST_BE_UNDEF
 (
és_vîify
);

2309 
	`MUST_BE_UNDEF
 (
és_exp‹t_˚π
);

2310 
	`MUST_BE_UNDEF
 (
vîify_x509_«me
);

2311 
	`MUST_BE_UNDEF
 (
és_timeout
);

2312 
	`MUST_BE_UNDEF
 (
ª√gŸüã_byãs
);

2313 
	`MUST_BE_UNDEF
 (
ª√gŸüã_∑ckës
);

2314 
	`MUST_BE_UNDEF
 (
ª√gŸüã_£c⁄ds
);

2315 
	`MUST_BE_UNDEF
 (
h™dshake_wödow
);

2316 
	`MUST_BE_UNDEF
 (
å™sôi⁄_wödow
);

2317 
	`MUST_BE_UNDEF
 (
és_auth_fûe
);

2318 
	`MUST_BE_UNDEF
 (
sögÀ_£ssi⁄
);

2319 #ifde‡
ENABLE_PUSH_PEER_INFO


2320 
	`MUST_BE_UNDEF
 (
push_≥î_öfo
);

2322 
	`MUST_BE_UNDEF
 (
és_exô
);

2323 
	`MUST_BE_UNDEF
 (
¸l_fûe
);

2324 
	`MUST_BE_UNDEF
 (
key_mëhod
);

2325 
	`MUST_BE_UNDEF
 (
ns_˚π_ty≥
);

2326 
	`MUST_BE_UNDEF
 (
ªmŸe_˚π_ku
[0]);

2327 
	`MUST_BE_UNDEF
 (
ªmŸe_˚π_eku
);

2328 #ifde‡
ENABLE_PKCS11


2329 
	`MUST_BE_UNDEF
 (
pkcs11_¥ovidîs
[0]);

2330 
	`MUST_BE_UNDEF
 (
pkcs11_¥iv©e_mode
[0]);

2331 
	`MUST_BE_UNDEF
 (
pkcs11_id
);

2332 
	`MUST_BE_UNDEF
 (
pkcs11_id_m™agemít
);

2335 i‡(
puŒ
)

2336 
	`msg
 (
M_USAGE
, 
îr
, "--pull");

2338 #unde‡
MUST_BE_UNDEF


2342 #i‡
P2MP


2343 i‡(
›ti⁄s
->
auth_u£r_∑ss_fûe
 && !›ti⁄s->
puŒ
)

2344 
	`msg
 (
M_USAGE
, "--auth-user-passÑequires --pull");

2347 
	`unöô_›ti⁄s
 (&
deÁu…s
);

2348 
	}
}

2351 
	$›ti⁄s_po°¥o˚ss_muèã_˚
 (
›ti⁄s
 *
o
, 
c⁄√˘i⁄_íåy
 *
˚
)

2353 c⁄° 
dev
 = 
	`dev_ty≥_íum
 (
o
->dev, o->
dev_ty≥
);

2355 #i‡
P2MP_SERVER


2356 i‡(
o
->
£rvî_deföed
 || o->
£rvî_bridge_deföed
 || o->
£rvî_bridge_¥oxy_dh˝
)

2358 i‡(
˚
->
¥Ÿo
 =
PROTO_TCPv4
)

2359 
˚
->
¥Ÿo
 = 
PROTO_TCPv4_SERVER
;

2360 i‡(
˚
->
¥Ÿo
 =
PROTO_TCPv6
)

2361 
˚
->
¥Ÿo
 = 
PROTO_TCPv6_SERVER
;

2364 #i‡
P2MP


2365 i‡(
o
->
˛õ¡
)

2367 i‡(
˚
->
¥Ÿo
 =
PROTO_TCPv4
)

2368 
˚
->
¥Ÿo
 = 
PROTO_TCPv4_CLIENT
;

2369 i‡(
˚
->
¥Ÿo
 =
PROTO_TCPv6
)

2370 
˚
->
¥Ÿo
 = 
PROTO_TCPv6_CLIENT
;

2374 i‡(
˚
->
¥Ÿo
 =
PROTO_TCPv4_CLIENT
 && !˚->
loˇl
 && !˚->
loˇl_p‹t_deföed
 && !˚->
böd_deföed
)

2375 
˚
->
böd_loˇl
 = 
Ál£
;

2377 #ifde‡
ENABLE_SOCKS


2378 i‡(
˚
->
¥Ÿo
 =
PROTO_UDPv4
 && ce->
socks_¥oxy_£rvî
 && !˚->
loˇl
 && !˚->
loˇl_p‹t_deföed
 && !˚->
böd_deföed
)

2379 
˚
->
böd_loˇl
 = 
Ál£
;

2382 i‡(!
˚
->
böd_loˇl
)

2383 
˚
->
loˇl_p‹t
 = 0;

2386 i‡(
o
->
¥Ÿo_f‹˚
 >0 && 
	`¥Ÿo_is_t˝
(o->¥Ÿo_f‹˚Ë!¥Ÿo_is_t˝(
˚
->
¥Ÿo
))

2387 
˚
->
Êags
 |
CE_DISABLED
;

2393 i‡(
o
->
˚
.
mssfix_deÁu…
)

2395 #ifde‡
ENABLE_FRAGMENT


2396 i‡(
˚
->
‰agmít
)

2397 
o
->
˚
.
mssfix
 = ce->
‰agmít
;

2399 
	`msg
 (
M_USAGE
, "--mssfix must specifyáÖarameter");

2407 i‡(!
˚
->
tun_mtu_deföed
 && !˚->
lök_mtu_deföed
)

2409 
˚
->
tun_mtu_deföed
 = 
åue
;

2411 i‡((
dev
 =
DEV_TYPE_TAP
Ë&& !
˚
->
tun_mtu_exåa_deföed
)

2413 
˚
->
tun_mtu_exåa_deföed
 = 
åue
;

2414 
˚
->
tun_mtu_exåa
 = 
TAP_MTU_EXTRA_DEFAULT
;

2418 
	}
}

2421 
	$›ti⁄s_po°¥o˚ss_muèã_öv¨ü¡
 (
›ti⁄s
 *options)

2423 c⁄° 
dev
 = 
	`dev_ty≥_íum
 (
›ti⁄s
->dev, o±i⁄s->
dev_ty≥
);

2429 i‡(
›ti⁄s
->
öëd
 =
INETD_NOWAIT
)

2430 
›ti⁄s
->
ifc⁄fig_n€xec
 = 
åue
;

2432 #ifde‡
WIN32


2433 i‡((
dev
 =
DEV_TYPE_TUN
 || dev =
DEV_TYPE_TAP
Ë&& !
›ti⁄s
->
rouã_dñay_deföed
)

2435 i‡(
›ti⁄s
->
mode
 =
MODE_POINT_TO_POINT
)

2437 
›ti⁄s
->
rouã_dñay_deföed
 = 
åue
;

2438 
›ti⁄s
->
rouã_dñay
 = 5;

2442 i‡(
›ti⁄s
->
ifc⁄fig_n€xec
)

2444 
›ti⁄s
->
tu¡≠_›ti⁄s
.
ù_wö32_ty≥
 = 
IPW32_SET_MANUAL
;

2445 
›ti⁄s
->
ifc⁄fig_n€xec
 = 
Ál£
;

2449 #i‡
P2MP_SERVER


2453 i‡(
›ti⁄s
->
mode
 =
MODE_SERVER
)

2455 #ifde‡
WIN32


2460 
›ti⁄s
->
tu¡≠_›ti⁄s
.
èp_¶ìp
 = 10;

2461 i‡(
›ti⁄s
->
rouã_dñay_deföed
 && o±i⁄s->
rouã_dñay
)

2462 
›ti⁄s
->
tu¡≠_›ti⁄s
.
èp_¶ìp
 = o±i⁄s->
rouã_dñay
;

2463 
›ti⁄s
->
rouã_dñay_deföed
 = 
Ál£
;

2467 
	}
}

2470 
	$›ti⁄s_po°¥o˚ss_vîify
 (c⁄° 
›ti⁄s
 *
o
)

2472 i‡(
o
->
c⁄√˘i⁄_li°
)

2474 
i
;

2475 
i
 = 0; i < 
o
->
c⁄√˘i⁄_li°
->
Àn
; ++i)

2476 
	`›ti⁄s_po°¥o˚ss_vîify_˚
 (
o
, o->
c⁄√˘i⁄_li°
->
¨øy
[
i
]);

2479 
	`›ti⁄s_po°¥o˚ss_vîify_˚
 (
o
, &o->
˚
);

2480 
	}
}

2483 
	$›ti⁄s_po°¥o˚ss_muèã
 (
›ti⁄s
 *
o
)

2489 
	`hñ≥r_˛õ¡_£rvî
 (
o
);

2490 
	`hñ≥r_kì∑live
 (
o
);

2491 
	`hñ≥r_t˝_nodñay
 (
o
);

2493 
	`›ti⁄s_po°¥o˚ss_muèã_öv¨ü¡
 (
o
);

2495 i‡(
o
->
ªmŸe_li°
 && !o->
c⁄√˘i⁄_li°
)

2501 i‡(
o
->
ªmŸe_li°
->
Àn
 > 1 || o->
f‹˚_c⁄√˘i⁄_li°
)

2503 c⁄° 
ªmŸe_li°
 *
æ
 = 
o
->remote_list;

2504 
i
;

2505 
i
 = 0; i < 
æ
->
Àn
; ++i)

2507 c⁄° 
ªmŸe_íåy
 *
ª
 = 
æ
->
¨øy
[
i
];

2508 
c⁄√˘i⁄_íåy
 
˚
 = 
o
->ce;

2509 
c⁄√˘i⁄_íåy
 *
a˚
;

2511 
	`ASSERT
 (
ª
->
ªmŸe
);

2512 
	`c⁄√˘i⁄_íåy_lﬂd_ª
 (&
˚
, 
ª
);

2513 
a˚
 = 
	`Æloc_c⁄√˘i⁄_íåy
 (
o
, 
M_USAGE
);

2514 
	`ASSERT
 (
a˚
);

2515 *
a˚
 = 
˚
;

2518 i‡(
o
->
ªmŸe_li°
->
Àn
 == 1)

2520 
	`c⁄√˘i⁄_íåy_lﬂd_ª
 (&
o
->
˚
, o->
ªmŸe_li°
->
¨øy
[0]);

2524 
	`ASSERT
 (0);

2527 i‡(
o
->
c⁄√˘i⁄_li°
)

2529 
i
;

2530 
i
 = 0; i < 
o
->
c⁄√˘i⁄_li°
->
Àn
; ++i)

2531 
	`›ti⁄s_po°¥o˚ss_muèã_˚
 (
o
, o->
c⁄√˘i⁄_li°
->
¨øy
[
i
]);

2533 #i‡
HTTP_PROXY_OVERRIDE


2534 i‡(
o
->
hâp_¥oxy_ovîride
)

2535 
	`›ti⁄s_po°¥o˚ss_hâp_¥oxy_ovîride
(
o
);

2539 
	`›ti⁄s_po°¥o˚ss_muèã_˚
 (
o
, &o->
˚
);

2541 #i‡
P2MP


2545 
	`¥e_puŒ_ßve
 (
o
);

2547 
	}
}

2553 #i‚de‡
ENABLE_SMALL


2555 
	#CHKACC_FILE
 (1<<0Ë

	)

2556 
	#CHKACC_DIRPATH
 (1<<1Ë

	)

2557 
	#CHKACC_FILEXSTWR
 (1<<2Ë

	)

2558 
	#CHKACC_INLINE
 (1<<3Ë

	)

2559 
	#CHKACC_ACPTSTDIN
 (1<<4Ë

	)

2561 
boﬁ


2562 
	$check_fûe_ac˚ss
(c⁄° 
ty≥
, c⁄° *
fûe
, c⁄° 
mode
, c⁄° *
›t
)

2564 
îrcode
 = 0;

2567 i‡(!
fûe
)

2568  
Ál£
;

2571 i‡((
ty≥
 & 
CHKACC_INLINE
Ë&& 
	`°ªq
(
fûe
, 
INLINE_FILE_TAG
) )

2572  
Ál£
;

2577 if–(
ty≥
 & 
CHKACC_ACPTSTDIN
Ë&& 
	`°ªq
(
fûe
, "stdin") )

2578  
Ál£
;

2581 i‡(
ty≥
 & 
CHKACC_DIRPATH
)

2583 *
fuŒ∑th
 = 
	`°rdup
(
fûe
);

2584 *
dú∑th
 = 
	`dú«me
(
fuŒ∑th
);

2586 i‡(
	`∂©f‹m_ac˚ss
 (
dú∑th
, 
mode
|
X_OK
) != 0)

2587 
îrcode
 = 
î∫o
;

2588 
	`‰ì
(
fuŒ∑th
);

2592 i‡(!
îrcode
 && (
ty≥
 & 
CHKACC_FILE
Ë&& (
	`∂©f‹m_ac˚ss
 (
fûe
, 
mode
) != 0) )

2593 
îrcode
 = 
î∫o
;

2596 i‡(!
îrcode
 && (
ty≥
 & 
CHKACC_FILEXSTWR
Ë&& (
	`∂©f‹m_ac˚ss
 (
fûe
, 
F_OK
) == 0) )

2597 i‡(
	`∂©f‹m_ac˚ss
 (
fûe
, 
W_OK
) != 0)

2598 
îrcode
 = 
î∫o
;

2601 if–
îrcode
 > 0 )

2602 
	`msg
 (
M_NOPREFIX
|
M_OPTERR
, "%s fails with '%s': %s",

2603 
›t
, 
fûe
, 
	`°ªº‹
(
î∫o
));

2606  (
îrcode
 !0 ? 
åue
 : 
Ál£
);

2607 
	}
}

2613 
boﬁ


2614 
	$check_fûe_ac˚ss_chroŸ
(c⁄° *
chroŸ
, c⁄° 
ty≥
, c⁄° *
fûe
, c⁄° 
mode
, c⁄° *
›t
)

2616 
boﬁ
 
ªt
 = 
Ál£
;

2619 i‡(!
fûe
)

2620  
Ál£
;

2623 if–
chroŸ
 )

2625 
gc_¨ía
 
gc
 = 
	`gc_√w
();

2626 
buf„r
 
chroŸ_fûe
;

2627 
Àn
 = 0;

2630 
Àn
 = 
	`°æí
(
chroŸ
Ë+ såÀn(
PATH_SEPARATOR_STR
Ë+ såÀn(
fûe
) + 1;

2631 
chroŸ_fûe
 = 
	`Æloc_buf_gc
(
Àn
, &
gc
);

2632 
	`buf_¥ötf
(&
chroŸ_fûe
, "%s%s%s", 
chroŸ
, 
PATH_SEPARATOR_STR
, 
fûe
);

2633 
	`ASSERT
 (
chroŸ_fûe
.
Àn
 > 0);

2635 
ªt
 = 
	`check_fûe_ac˚ss
(
ty≥
, 
	`BSTR
(&
chroŸ_fûe
), 
mode
, 
›t
);

2636 
	`gc_‰ì
(&
gc
);

2641 
ªt
 = 
	`check_fûe_ac˚ss
(
ty≥
, 
fûe
, 
mode
, 
›t
);

2643  
ªt
;

2644 
	}
}

2663 
boﬁ


2664 
	$check_cmd_ac˚ss
(c⁄° *
comm™d
, c⁄° *
›t
, c⁄° *
chroŸ
)

2666 
¨gv
árgv;

2667 
boﬁ
 
ªtu∫_code
;

2670 i‡(! 
comm™d
)

2671  
Ál£
;

2674 
¨gv
 = 
	`¨gv_√w
 ();

2675 
	`¨gv_¥ötf
 (&
¨gv
, "%sc", 
comm™d
);

2678 i‡(
¨gv
.argv[0])

2683 
ªtu∫_code
 = 
	`check_fûe_ac˚ss_chroŸ
(
chroŸ
, 
CHKACC_FILE
, 
¨gv
.¨gv[0], 
X_OK
, 
›t
);

2686 
	`msg
 (
M_NOPREFIX
|
M_OPTERR
, "%s fails with '%s': NoÖathÅoÉxecutable.",

2687 
›t
, 
comm™d
);

2688 
ªtu∫_code
 = 
åue
;

2691 
	`¨gv_ª£t
 (&
¨gv
);

2693  
ªtu∫_code
;

2694 
	}
}

2701 
	$›ti⁄s_po°¥o˚ss_fûechecks
 (
›ti⁄s
 *options)

2703 
boﬁ
 
îrs
 = 
Ál£
;

2706 #ifde‡
ENABLE_SSL


2707 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_FILE
|
CHKACC_INLINE
, 
›ti⁄s
->
dh_fûe
, 
R_OK
, "--dh");

2708 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_FILE
|
CHKACC_INLINE
, 
›ti⁄s
->
ˇ_fûe
, 
R_OK
, "--ca");

2709 
îrs
 |
	`check_fûe_ac˚ss_chroŸ
 (
›ti⁄s
->
chroŸ_dú
, 
CHKACC_FILE
, o±i⁄s->
ˇ_∑th
, 
R_OK
, "--capath");

2710 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_FILE
|
CHKACC_INLINE
, 
›ti⁄s
->
˚π_fûe
, 
R_OK
, "--cert");

2711 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_FILE
|
CHKACC_INLINE
, 
›ti⁄s
->
exåa_˚πs_fûe
, 
R_OK
,

2713 #ifde‡
MANAGMENT_EXTERNAL_KEY


2714 if(!(
›ti⁄s
->
m™agemít_Êags
 & 
MF_EXTERNAL_KEY
))

2716 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_FILE
|
CHKACC_INLINE
, 
›ti⁄s
->
¥iv_key_fûe
, 
R_OK
,

2718 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_FILE
|
CHKACC_INLINE
, 
›ti⁄s
->
pkcs12_fûe
, 
R_OK
,

2721 i‡(
›ti⁄s
->
s¶_Êags
 & 
SSLF_CRL_VERIFY_DIR
)

2722 
îrs
 |
	`check_fûe_ac˚ss_chroŸ
 (
›ti⁄s
->
chroŸ_dú
, 
CHKACC_FILE
, o±i⁄s->
¸l_fûe
, 
R_OK
|
X_OK
,

2725 
îrs
 |
	`check_fûe_ac˚ss_chroŸ
 (
›ti⁄s
->
chroŸ_dú
, 
CHKACC_FILE
, o±i⁄s->
¸l_fûe
, 
R_OK
,

2728 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_FILE
|
CHKACC_INLINE
, 
›ti⁄s
->
és_auth_fûe
, 
R_OK
,

2731 #ifde‡
ENABLE_CRYPTO


2732 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_FILE
|
CHKACC_INLINE
, 
›ti⁄s
->
sh¨ed_£¸ë_fûe
, 
R_OK
,

2734 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_DIRPATH
|
CHKACC_FILEXSTWR
,

2735 
›ti⁄s
->
∑ckë_id_fûe
, 
R_OK
|
W_OK
, "--replay-persist");

2740 #ifde‡
ENABLE_SSL


2741 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_FILE
, 
›ti⁄s
->
key_∑ss_fûe
, 
R_OK
,

2744 #ifde‡
ENABLE_MANAGEMENT


2745 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_FILE
|
CHKACC_ACPTSTDIN
,

2746 
›ti⁄s
->
m™agemít_u£r_∑ss
, 
R_OK
,

2749 #i‡
P2MP


2750 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_FILE
|
CHKACC_ACPTSTDIN
,

2751 
›ti⁄s
->
auth_u£r_∑ss_fûe
, 
R_OK
,

2756 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_FILE
, 
›ti⁄s
->
chroŸ_dú
,

2757 
R_OK
|
X_OK
, "--chroot directory");

2758 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_DIRPATH
|
CHKACC_FILEXSTWR
, 
›ti⁄s
->
wrôïid
,

2759 
R_OK
|
W_OK
, "--writepid");

2762 
îrs
 |
	`check_fûe_ac˚ss
 (
CHKACC_DIRPATH
|
CHKACC_FILEXSTWR
, 
›ti⁄s
->
°©us_fûe
,

2763 
R_OK
|
W_OK
, "--status");

2766 #ifde‡
ENABLE_SSL


2767 
îrs
 |
	`check_fûe_ac˚ss_chroŸ
 (
›ti⁄s
->
chroŸ_dú
, 
CHKACC_FILE
, o±i⁄s->
és_exp‹t_˚π
,

2768 
R_OK
|
W_OK
|
X_OK
, "--tls-export-cert");

2770 #i‡
P2MP_SERVER


2771 
îrs
 |
	`check_fûe_ac˚ss_chroŸ
 (
›ti⁄s
->
chroŸ_dú
, 
CHKACC_FILE
, o±i⁄s->
˛õ¡_c⁄fig_dú
,

2772 
R_OK
|
X_OK
, "--client-config-dir");

2773 
îrs
 |
	`check_fûe_ac˚ss_chroŸ
 (
›ti⁄s
->
chroŸ_dú
, 
CHKACC_FILE
, o±i⁄s->
tmp_dú
,

2774 
R_OK
|
W_OK
|
X_OK
, "Temporary directory (--tmp-dir)");

2778 i‡(
îrs
)

2779 
	`msg
 (
M_USAGE
, "Please correctÅheseÉrrors.");

2780 
	}
}

2789 
	$›ti⁄s_po°¥o˚ss
 (
›ti⁄s
 *options)

2791 
	`›ti⁄s_po°¥o˚ss_muèã
 (
›ti⁄s
);

2792 
	`›ti⁄s_po°¥o˚ss_vîify
 (
›ti⁄s
);

2793 #i‚de‡
ENABLE_SMALL


2794 
	`›ti⁄s_po°¥o˚ss_fûechecks
 (
›ti⁄s
);

2796 
	}
}

2798 #i‡
P2MP


2805 
	$¥e_puŒ_ßve
 (
›ti⁄s
 *
o
)

2807 i‡(
o
->
puŒ
)

2809 
	`ALLOC_OBJ_CLEAR_GC
 (
o
->
¥e_puŒ
, 
›ti⁄s_¥e_puŒ
, &o->
gc
);

2810 
o
->
¥e_puŒ
->
tu¡≠_›ti⁄s
 = o->tuntap_options;

2811 
o
->
¥e_puŒ
->
tu¡≠_›ti⁄s_deföed
 = 
åue
;

2812 
o
->
¥e_puŒ
->
f‹eign_›ti⁄_ödex
 = o->foreign_option_index;

2813 i‡(
o
->
rouãs
)

2815 
o
->
¥e_puŒ
->
rouãs
 = 
	`˛⁄e_rouã_›ti⁄_li°
(o->rouãs, &o->
gc
);

2816 
o
->
¥e_puŒ
->
rouãs_deföed
 = 
åue
;

2818 i‡(
o
->
rouãs_ùv6
)

2820 
o
->
¥e_puŒ
->
rouãs_ùv6
 = 
	`˛⁄e_rouã_ùv6_›ti⁄_li°
(o->rouãs_ùv6, &o->
gc
);

2821 
o
->
¥e_puŒ
->
rouãs_ùv6_deföed
 = 
åue
;

2823 #ifde‡
ENABLE_CLIENT_NAT


2824 i‡(
o
->
˛õ¡_«t
)

2826 
o
->
¥e_puŒ
->
˛õ¡_«t
 = 
	`˛⁄e_˛õ¡_«t_›ti⁄_li°
(o->˛õ¡_«t, &o->
gc
);

2827 
o
->
¥e_puŒ
->
˛õ¡_«t_deföed
 = 
åue
;

2831 
	}
}

2834 
	$¥e_puŒ_ª°‹e
 (
›ti⁄s
 *
o
)

2836 c⁄° 
›ti⁄s_¥e_puŒ
 *
µ
 = 
o
->
¥e_puŒ
;

2837 i‡(
µ
)

2839 
	`CLEAR
 (
o
->
tu¡≠_›ti⁄s
);

2840 i‡(
µ
->
tu¡≠_›ti⁄s_deföed
)

2841 
o
->
tu¡≠_›ti⁄s
 = 
µ
->tuntap_options;

2843 i‡(
µ
->
rouãs_deföed
)

2845 
	`rﬁ_check_Æloc
 (
o
);

2846 
	`c›y_rouã_›ti⁄_li°
 (
o
->
rouãs
, 
µ
->routes);

2849 
o
->
rouãs
 = 
NULL
;

2851 i‡(
µ
->
rouãs_ùv6_deföed
)

2853 
	`rﬁ6_check_Æloc
 (
o
);

2854 
	`c›y_rouã_ùv6_›ti⁄_li°
 (
o
->
rouãs_ùv6
, 
µ
->routes_ipv6);

2857 
o
->
rouãs_ùv6
 = 
NULL
;

2859 #ifde‡
ENABLE_CLIENT_NAT


2860 i‡(
µ
->
˛õ¡_«t_deföed
)

2862 
	`˙ﬁ_check_Æloc
 (
o
);

2863 
	`c›y_˛õ¡_«t_›ti⁄_li°
 (
o
->
˛õ¡_«t
, 
µ
->client_nat);

2866 
o
->
˛õ¡_«t
 = 
NULL
;

2869 
o
->
f‹eign_›ti⁄_ödex
 = 
µ
->foreign_option_index;

2872 
o
->
push_c⁄töu©i⁄
 = 0;

2873 
o
->
push_›ti⁄_ty≥s_found
 = 0;

2874 
	}
}

2878 #ifde‡
ENABLE_OCC


2925 
	$›ti⁄s_°rög
 (c⁄° 
›ti⁄s
 *
o
,

2926 c⁄° 
‰ame
 *frame,

2927 
tu¡≠
 *
â
,

2928 
boﬁ
 
ªmŸe
,

2929 
gc_¨ía
 *
gc
)

2931 
buf„r
 
out
 = 
	`Æloc_buf
 (
OPTION_LINE_SIZE
);

2932 
boﬁ
 
â_loˇl
 = 
Ál£
;

2934 
	`buf_¥ötf
 (&
out
, "V4");

2940 
	`buf_¥ötf
 (&
out
, ",dev-ty≥ %s", 
	`dev_ty≥_°rög
 (
o
->
dev
, o->
dev_ty≥
));

2941 
	`buf_¥ötf
 (&
out
, ",lök-mtu %d", 
	`EXPANDED_SIZE
 (
‰ame
));

2942 
	`buf_¥ötf
 (&
out
, ",tun-mtu %d", 
	`PAYLOAD_SIZE
 (
‰ame
));

2943 
	`buf_¥ötf
 (&
out
, ",¥Ÿÿ%s", 
	`¥Ÿo2ascii
 (
	`¥Ÿo_ªmŸe
 (
o
->
˚
.
¥Ÿo
, 
ªmŸe
), 
åue
));

2948 i‡(
o
->
tun_ùv6
 && o->
mode
 =
MODE_POINT_TO_POINT
 && !
	`PULL_DEFINED
(o))

2949 
	`buf_¥ötf
 (&
out
, ",tun-ipv6");

2955 i‡(!
â
)

2957 
â
 = 
	`öô_tun
 (
o
->
dev
,

2958 
o
->
dev_ty≥
,

2959 
o
->
t›ﬁogy
,

2960 
o
->
ifc⁄fig_loˇl
,

2961 
o
->
ifc⁄fig_ªmŸe_√tmask
,

2962 
o
->
ifc⁄fig_ùv6_loˇl
,

2963 
o
->
ifc⁄fig_ùv6_√tbôs
,

2964 
o
->
ifc⁄fig_ùv6_ªmŸe
,

2965 (
ö_addr_t
)0,

2966 (
ö_addr_t
)0,

2967 
Ál£
,

2968 
NULL
);

2969 i‡(
â
)

2970 
â_loˇl
 = 
åue
;

2973 i‡(
â
 && 
o
->
mode
 =
MODE_POINT_TO_POINT
 && !
	`PULL_DEFINED
(o))

2975 c⁄° *
ios
 = 
	`ifc⁄fig_›ti⁄s_°rög
 (
â
, 
ªmŸe
, 
o
->
ifc⁄fig_now¨n
, 
gc
);

2976 i‡(
ios
 && 
	`°æí
 (ios))

2977 
	`buf_¥ötf
 (&
out
, ",ifc⁄fig %s", 
ios
);

2979 i‡(
â_loˇl
)

2981 
	`‰ì
 (
â
);

2982 
â
 = 
NULL
;

2985 #ifde‡
ENABLE_LZO


2986 i‡(
o
->
lzo
 & 
LZO_SELECTED
)

2987 
	`buf_¥ötf
 (&
out
, ",comp-lzo");

2990 #ifde‡
ENABLE_FRAGMENT


2991 i‡(
o
->
˚
.
‰agmít
)

2992 
	`buf_¥ötf
 (&
out
, ",mtu-dynamic");

2995 #ifde‡
ENABLE_CRYPTO


2997 #ifde‡
ENABLE_SSL


2998 
	#TLS_CLIENT
 (
o
->
és_˛õ¡
)

	)

2999 
	#TLS_SERVER
 (
o
->
és_£rvî
)

	)

3001 
	#TLS_CLIENT
 (
Ál£
)

	)

3002 
	#TLS_SERVER
 (
Ál£
)

	)

3009 c⁄° *
kd
 = 
	`keydúe˘i⁄2ascii
 (
o
->
key_dúe˘i⁄
, 
ªmŸe
);

3010 i‡(
kd
)

3011 
	`buf_¥ötf
 (&
out
, ",keydú %s", 
kd
);

3017 i‡(
o
->
sh¨ed_£¸ë_fûe
 || 
TLS_CLIENT
 || 
TLS_SERVER
)

3019 
key_ty≥
 
kt
;

3021 
	`ASSERT
 ((
o
->
sh¨ed_£¸ë_fûe
 !
NULL
)

3022 + (
TLS_CLIENT
 =
åue
)

3023 + (
TLS_SERVER
 =
åue
)

3026 
	`öô_key_ty≥
 (&
kt
, 
o
->
cùhî«me
, o->
cùhî«me_deföed
,

3027 
o
->
auth«me
, o->
auth«me_deföed
,

3028 
o
->
keysize
, 
åue
, 
Ál£
);

3030 
	`buf_¥ötf
 (&
out
, ",cùhî %s", 
	`cùhî_kt_«me
 (
kt
.
cùhî
));

3031 
	`buf_¥ötf
 (&
out
, ",auth %s", 
	`md_kt_«me
 (
kt
.
dige°
));

3032 
	`buf_¥ötf
 (&
out
, ",keysizê%d", 
kt
.
cùhî_Àngth
 * 8);

3033 i‡(
o
->
sh¨ed_£¸ë_fûe
)

3034 
	`buf_¥ötf
 (&
out
, ",secret");

3035 i‡(!
o
->
ª∂ay
)

3036 
	`buf_¥ötf
 (&
out
, ",no-replay");

3037 i‡(!
o
->
u£_iv
)

3038 
	`buf_¥ötf
 (&
out
, ",no-iv");

3040 #ifde‡
ENABLE_PREDICTION_RESISTANCE


3041 i‡(
o
->
u£_¥edi˘i⁄_ªsi°™˚
)

3042 
	`buf_¥ötf
 (&
out
, ",use-prediction-resistance");

3046 #ifde‡
ENABLE_SSL


3051 i‡(
TLS_CLIENT
 || 
TLS_SERVER
)

3053 i‡(
o
->
és_auth_fûe
)

3054 
	`buf_¥ötf
 (&
out
, ",tls-auth");

3056 i‡(
o
->
key_mëhod
 > 1)

3057 
	`buf_¥ötf
 (&
out
, ",key-mëhod %d", 
o
->
key_mëhod
);

3060 i‡(
ªmŸe
)

3062 i‡(
TLS_CLIENT
)

3063 
	`buf_¥ötf
 (&
out
, ",tls-server");

3064 i‡(
TLS_SERVER
)

3065 
	`buf_¥ötf
 (&
out
, ",tls-client");

3069 i‡(
TLS_CLIENT
)

3070 
	`buf_¥ötf
 (&
out
, ",tls-client");

3071 i‡(
TLS_SERVER
)

3072 
	`buf_¥ötf
 (&
out
, ",tls-server");

3077 #unde‡
TLS_CLIENT


3078 #unde‡
TLS_SERVER


3082  
	`BSTR
 (&
out
);

3083 
	}
}

3092 
boﬁ


3093 
	$›ti⁄s_cmp_equÆ
 (*
a˘uÆ
, c⁄° *
ex≥˘ed
)

3095  
	`›ti⁄s_cmp_equÆ_ß„
 (
a˘uÆ
, 
ex≥˘ed
, 
	`°æí
 (actual) + 1);

3096 
	}
}

3099 
	$›ti⁄s_w¨nög
 (*
a˘uÆ
, c⁄° *
ex≥˘ed
)

3101 
	`›ti⁄s_w¨nög_ß„
 (
a˘uÆ
, 
ex≥˘ed
, 
	`°æí
 (actual) + 1);

3102 
	}
}

3105 
	$›ti⁄s_w¨nög_exåa˘_∑rm1
 (c⁄° *
›ti⁄_°rög
,

3106 
gc_¨ía
 *
gc_ªt
)

3108 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3109 
buf„r
 
b
 = 
	`°rög_Æloc_buf
 (
›ti⁄_°rög
, &
gc
);

3110 *
p
 = 
	`gc_mÆloc
 (
OPTION_PARM_SIZE
, 
Ál£
, &
gc
);

3111 c⁄° *
ªt
;

3113 
	`buf_∑r£
 (&
b
, ' ', 
p
, 
OPTION_PARM_SIZE
);

3114 
ªt
 = 
	`°rög_Æloc
 (
p
, 
gc_ªt
);

3115 
	`gc_‰ì
 (&
gc
);

3116  
ªt
;

3117 
	}
}

3120 
	$›ti⁄s_w¨nög_ß„_sˇn2
 (c⁄° 
msgÀvñ
,

3121 c⁄° 
dñim
,

3122 c⁄° 
boﬁ
 
ªp‹t_öc⁄si°ít
,

3123 c⁄° *
p1
,

3124 c⁄° 
buf„r
 *
b2_§c
,

3125 c⁄° *
b1_«me
,

3126 c⁄° *
b2_«me
)

3132 i‡(
	`°∫cmp
(
p1
, "proto ", 6) == 0 )

3137 i‡(
	`°æí
 (
p1
) > 0)

3139 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3140 
buf„r
 
b2
 = *
b2_§c
;

3141 c⁄° *
p1_¥efix
 = 
	`›ti⁄s_w¨nög_exåa˘_∑rm1
 (
p1
, &
gc
);

3142 *
p2
 = 
	`gc_mÆloc
 (
OPTION_PARM_SIZE
, 
Ál£
, &
gc
);

3144 
	`buf_∑r£
 (&
b2
, 
dñim
, 
p2
, 
OPTION_PARM_SIZE
))

3146 i‡(
	`°æí
 (
p2
))

3148 c⁄° *
p2_¥efix
 = 
	`›ti⁄s_w¨nög_exåa˘_∑rm1
 (
p2
, &
gc
);

3150 i‡(!
	`°rcmp
 (
p1
, 
p2
))

3151 
d⁄e
;

3152 i‡(!
	`°rcmp
 (
p1_¥efix
, 
p2_¥efix
))

3154 i‡(
ªp‹t_öc⁄si°ít
)

3155 
	`msg
 (
msgÀvñ
, "WARNING: '%s' is used inconsistently, %s='%s', %s='%s'",

3156 
	`ß„_¥öt
 (
p1_¥efix
, &
gc
),

3157 
b1_«me
,

3158 
	`ß„_¥öt
 (
p1
, &
gc
),

3159 
b2_«me
,

3160 
	`ß„_¥öt
 (
p2
, &
gc
));

3161 
d⁄e
;

3166 
	`msg
 (
msgÀvñ
, "WARNING: '%s' isÖresent in %s config but missing in %s config, %s='%s'",

3167 
	`ß„_¥öt
 (
p1_¥efix
, &
gc
),

3168 
b1_«me
,

3169 
b2_«me
,

3170 
b1_«me
,

3171 
	`ß„_¥öt
 (
p1
, &
gc
));

3173 
d⁄e
:

3174 
	`gc_‰ì
 (&
gc
);

3176 
	}
}

3179 
	$›ti⁄s_w¨nög_ß„_sˇn1
 (c⁄° 
msgÀvñ
,

3180 c⁄° 
dñim
,

3181 c⁄° 
boﬁ
 
ªp‹t_öc⁄si°ít
,

3182 c⁄° 
buf„r
 *
b1_§c
,

3183 c⁄° 
buf„r
 *
b2_§c
,

3184 c⁄° *
b1_«me
,

3185 c⁄° *
b2_«me
)

3187 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3188 
buf„r
 
b
 = *
b1_§c
;

3189 *
p
 = 
	`gc_mÆloc
 (
OPTION_PARM_SIZE
, 
åue
, &
gc
);

3191 
	`buf_∑r£
 (&
b
, 
dñim
, 
p
, 
OPTION_PARM_SIZE
))

3192 
	`›ti⁄s_w¨nög_ß„_sˇn2
 (
msgÀvñ
, 
dñim
, 
ªp‹t_öc⁄si°ít
, 
p
, 
b2_§c
, 
b1_«me
, 
b2_«me
);

3194 
	`gc_‰ì
 (&
gc
);

3195 
	}
}

3198 
	$›ti⁄s_w¨nög_ß„_ml
 (c⁄° 
msgÀvñ
, *
a˘uÆ
, c⁄° *
ex≥˘ed
, 
size_t
 
a˘uÆ_n
)

3200 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3202 i‡(
a˘uÆ_n
 > 0)

3204 
buf„r
 
loˇl
 = 
	`Æloc_buf_gc
 (
OPTION_PARM_SIZE
 + 16, &
gc
);

3205 
buf„r
 
ªmŸe
 = 
	`Æloc_buf_gc
 (
OPTION_PARM_SIZE
 + 16, &
gc
);

3206 
a˘uÆ
[
a˘uÆ_n
 - 1] = 0;

3208 
	`buf_¥ötf
 (&
loˇl
, "vîsi⁄ %s", 
ex≥˘ed
);

3209 
	`buf_¥ötf
 (&
ªmŸe
, "vîsi⁄ %s", 
a˘uÆ
);

3211 
	`›ti⁄s_w¨nög_ß„_sˇn1
 (
msgÀvñ
, ',', 
åue
,

3212 &
loˇl
, &
ªmŸe
,

3215 
	`›ti⁄s_w¨nög_ß„_sˇn1
 (
msgÀvñ
, ',', 
Ál£
,

3216 &
ªmŸe
, &
loˇl
,

3220 
	`gc_‰ì
 (&
gc
);

3221 
	}
}

3223 
boﬁ


3224 
	$›ti⁄s_cmp_equÆ_ß„
 (*
a˘uÆ
, c⁄° *
ex≥˘ed
, 
size_t
 
a˘uÆ_n
)

3226 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3227 
boﬁ
 
ªt
 = 
åue
;

3229 i‡(
a˘uÆ_n
 > 0)

3231 
a˘uÆ
[
a˘uÆ_n
 - 1] = 0;

3232 #i‚de‡
ENABLE_STRICT_OPTIONS_CHECK


3233 i‡(
	`°∫cmp
 (
a˘uÆ
, 
ex≥˘ed
, 2))

3235 
	`msg
 (
D_SHOW_OCC
, "NOTE: Options consistency check may be skewed by version differences");

3236 
	`›ti⁄s_w¨nög_ß„_ml
 (
D_SHOW_OCC
, 
a˘uÆ
, 
ex≥˘ed
, 
a˘uÆ_n
);

3240 
ªt
 = !
	`°rcmp
 (
a˘uÆ
, 
ex≥˘ed
);

3242 
	`gc_‰ì
 (&
gc
);

3243  
ªt
;

3244 
	}
}

3247 
	$›ti⁄s_w¨nög_ß„
 (*
a˘uÆ
, c⁄° *
ex≥˘ed
, 
size_t
 
a˘uÆ_n
)

3249 
	`›ti⁄s_w¨nög_ß„_ml
 (
M_WARN
, 
a˘uÆ
, 
ex≥˘ed
, 
a˘uÆ_n
);

3250 
	}
}

3253 
	$›ti⁄s_°rög_vîsi⁄
 (c⁄° * 
s
, 
gc_¨ía
 *
gc
)

3255 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (4, 
gc
);

3256 
	`°∫˝y¡
 ((*Ë
	`BPTR
 (&
out
), 
s
, 3);

3257  
	`BSTR
 (&
out
);

3258 
	}
}

3263 
	$f‹eign_›ti⁄
 (
›ti⁄s
 *
o
, *
¨gv
[], 
Àn
, 
ív_£t
 *
es
)

3265 i‡(
Àn
 > 0)

3267 
gc_¨ía
 
gc
 = 
	`gc_√w
();

3268 
buf„r
 
«me
 = 
	`Æloc_buf_gc
 (
OPTION_PARM_SIZE
, &
gc
);

3269 
buf„r
 
vÆue
 = 
	`Æloc_buf_gc
 (
OPTION_PARM_SIZE
, &
gc
);

3270 
i
;

3271 
boﬁ
 
fú°
 = 
åue
;

3272 
boﬁ
 
good
 = 
åue
;

3274 
good
 &
	`buf_¥ötf
 (&
«me
, "f‹eign_›ti⁄_%d", 
o
->
f‹eign_›ti⁄_ödex
 + 1);

3275 ++
o
->
f‹eign_›ti⁄_ödex
;

3276 
i
 = 0; i < 
Àn
; ++i)

3278 i‡(
¨gv
[
i
])

3280 i‡(!
fú°
)

3281 
good
 &
	`buf_¥ötf
 (&
vÆue
, " ");

3282 
good
 &
	`buf_¥ötf
 (&
vÆue
, "%s", 
¨gv
[
i
]);

3283 
fú°
 = 
Ál£
;

3286 i‡(
good
)

3287 
	`£ãnv_°r
 (
es
, 
	`BSTR
(&
«me
), BSTR(&
vÆue
));

3289 
	`msg
 (
M_WARN
, "foreign_option:Çame/value overflow");

3290 
	`gc_‰ì
 (&
gc
);

3292 
	}
}

3299 
	$∑r£_t›ﬁogy
 (c⁄° *
°r
, c⁄° 
msgÀvñ
)

3301 i‡(
	`°ªq
 (
°r
, "net30"))

3302  
TOP_NET30
;

3303 i‡(
	`°ªq
 (
°r
, "p2p"))

3304  
TOP_P2P
;

3305 i‡(
	`°ªq
 (
°r
, "subnet"))

3306  
TOP_SUBNET
;

3309 
	`msg
 (
msgÀvñ
, "--topology must beÇet30,Ö2p, or subnet");

3310  
TOP_UNDEF
;

3312 
	}
}

3315 
	$¥öt_t›ﬁogy
 (c⁄° 
t›ﬁogy
)

3317 
t›ﬁogy
)

3319 
TOP_UNDEF
:

3321 
TOP_NET30
:

3323 
TOP_P2P
:

3325 
TOP_SUBNET
:

3330 
	}
}

3332 #i‡
P2MP


3338 
	gglobÆ_auth_ªåy
;

3341 
	$auth_ªåy_gë
 ()

3343  
globÆ_auth_ªåy
;

3344 
	}
}

3346 
boﬁ


3347 
	$auth_ªåy_£t
 (c⁄° 
msgÀvñ
, c⁄° *
›ti⁄
)

3349 i‡(
	`°ªq
 (
›ti⁄
, "interact"))

3350 
globÆ_auth_ªåy
 = 
AR_INTERACT
;

3351 i‡(
	`°ªq
 (
›ti⁄
, "nointeract"))

3352 
globÆ_auth_ªåy
 = 
AR_NOINTERACT
;

3353 i‡(
	`°ªq
 (
›ti⁄
, "none"))

3354 
globÆ_auth_ªåy
 = 
AR_NONE
;

3357 
	`msg
 (
msgÀvñ
, "--auth-retry method must be 'interact', 'nointeract', or 'none'");

3358  
Ál£
;

3360  
åue
;

3361 
	}
}

3364 
	$auth_ªåy_¥öt
 ()

3366 
globÆ_auth_ªåy
)

3368 
AR_NONE
:

3370 
AR_NOINTERACT
:

3372 
AR_INTERACT
:

3377 
	}
}

3385 
	$ußge
 ()

3387 
FILE
 *
Â
 = 
	`msg_Â
(0);

3389 #ifde‡
ENABLE_SMALL


3391 
	`Ârötf
 (
Â
, "Usage messageÇotávailable\n");

3395 
›ti⁄s
 
o
;

3396 
	`öô_›ti⁄s
 (&
o
, 
åue
);

3398 #i‡
	`deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

3399 
	`Ârötf
 (
Â
, 
ußge_mesßge
,

3400 
tôÀ_°rög
,

3401 
o
.
˚
.
c⁄√˘_ªåy_£c⁄ds
,

3402 
o
.
˚
.
loˇl_p‹t
, o.˚.
ªmŸe_p‹t
,

3403 
TUN_MTU_DEFAULT
, 
TAP_MTU_EXTRA_DEFAULT
,

3404 
o
.
vîbosôy
,

3405 
o
.
auth«me
, o.
cùhî«me
,

3406 
o
.
ª∂ay_wödow
, o.
ª∂ay_time
,

3407 
o
.
és_timeout
, o.
ª√gŸüã_£c⁄ds
,

3408 
o
.
h™dshake_wödow
, o.
å™sôi⁄_wödow
);

3409 #ñi‡
	`deföed
(
ENABLE_CRYPTO
)

3410 
	`Ârötf
 (
Â
, 
ußge_mesßge
,

3411 
tôÀ_°rög
,

3412 
o
.
˚
.
c⁄√˘_ªåy_£c⁄ds
,

3413 
o
.
˚
.
loˇl_p‹t
, o.˚.
ªmŸe_p‹t
,

3414 
TUN_MTU_DEFAULT
, 
TAP_MTU_EXTRA_DEFAULT
,

3415 
o
.
vîbosôy
,

3416 
o
.
auth«me
, o.
cùhî«me
,

3417 
o
.
ª∂ay_wödow
, o.
ª∂ay_time
);

3419 
	`Ârötf
 (
Â
, 
ußge_mesßge
,

3420 
tôÀ_°rög
,

3421 
o
.
˚
.
c⁄√˘_ªåy_£c⁄ds
,

3422 
o
.
˚
.
loˇl_p‹t
, o.˚.
ªmŸe_p‹t
,

3423 
TUN_MTU_DEFAULT
, 
TAP_MTU_EXTRA_DEFAULT
,

3424 
o
.
vîbosôy
);

3426 
	`fÊush
(
Â
);

3430 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_USAGE
);

3431 
	}
}

3434 
	$ußge_smÆl
 ()

3436 
	`msg
 (
M_WARN
|
M_NOPREFIX
, "Use --help for more information.");

3437 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_USAGE
);

3438 
	}
}

3441 
	$show_libøry_vîsi⁄s
(c⁄° 
Êags
)

3443 #ifde‡
ENABLE_SSL


3444 
	#SSL_LIB_VER_STR
 
	`gë_s¶_libøry_vîsi⁄
()

	)

3446 
	#SSL_LIB_VER_STR
 ""

	)

3448 #ifde‡
ENABLE_LZO


3449 
	#LZO_LIB_VER_STR
 ", LZO ", 
	`lzo_vîsi⁄_°rög
()

	)

3451 
	#LZO_LIB_VER_STR
 "", ""

	)

3454 
	`msg
 (
Êags
, "libøry vîsi⁄s: %s%s%s", 
SSL_LIB_VER_STR
, 
LZO_LIB_VER_STR
);

3456 #unde‡
SSL_LIB_VER_STR


3457 #unde‡
LZO_LIB_VER_STR


3458 
	}
}

3461 
	$ußge_vîsi⁄
 ()

3463 
	`msg
 (
M_INFO
|
M_NOPREFIX
, "%s", 
tôÀ_°rög
);

3464 
	`show_libøry_vîsi⁄s
–
M_INFO
|
M_NOPREFIX
 );

3465 
	`msg
 (
M_INFO
|
M_NOPREFIX
, "Originally developed by James Yonan");

3466 
	`msg
 (
M_INFO
|
M_NOPREFIX
, "Copyright (C) 2002-2010 OpenVPN Technologies, Inc. <sales@openvpn.net>");

3467 #i‚de‡
ENABLE_SMALL


3468 #ifde‡
CONFIGURE_DEFINES


3469 
	`msg
 (
M_INFO
|
M_NOPREFIX
, "Compûêtimêdeföes: %s", 
CONFIGURE_DEFINES
);

3471 #ifde‡
CONFIGURE_SPECIAL_BUILD


3472 
	`msg
 (
M_INFO
|
M_NOPREFIX
, "•ecü»buûd: %s", 
CONFIGURE_SPECIAL_BUILD
);

3474 #ifde‡
CONFIGURE_GIT_REVISION


3475 
	`msg
 (
M_INFO
|
M_NOPREFIX
, "gôÑevisi⁄: %s", 
CONFIGURE_GIT_REVISION
);

3478 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_USAGE
);

3479 
	}
}

3482 
	$nŸnuŒ
 (c⁄° *
¨g
, c⁄° *
des¸ùti⁄
)

3484 i‡(!
¨g
)

3485 
	`msg
 (
M_USAGE
, "You mu° deföê%s", 
des¸ùti⁄
);

3486 
	}
}

3488 
boﬁ


3489 
	$°rög_deföed_equÆ
 (c⁄° *
s1
, c⁄° *
s2
)

3491 i‡(
s1
 && 
s2
)

3492  !
	`°rcmp
 (
s1
, 
s2
);

3494  
Ál£
;

3495 
	}
}

3499 
	$pög_ªc_îr
 (
msgÀvñ
)

3501 
	`msg
 (
msgÀvñ
, "only one of --ping-exit or --ping-restart options may be specified");

3502 
	}
}

3506 
	$posôive_©oi
 (c⁄° *
°r
)

3508 c⁄° 
i
 = 
	`©oi
 (
°r
);

3509  
i
 < 0 ? 0 : i;

3510 
	}
}

3512 #ifde‡
WIN32


3514 
	$©ou
 (c⁄° *
°r
)

3516 
vÆ
 = 0;

3517 
	`ssˇnf
 (
°r
, "%u", &
vÆ
);

3518  
vÆ
;

3519 
	}
}

3522 
ölöe
 
boﬁ


3523 
	$•a˚
 (
c
)

3525  
c
 ='\0' || 
	`is•a˚
 (c);

3526 
	}
}

3529 
	$∑r£_löe
 (c⁄° *
löe
,

3530 *
p
[],

3531 c⁄° 
n
,

3532 c⁄° *
fûe
,

3533 c⁄° 
löe_num
,

3534 
msgÀvñ
,

3535 
gc_¨ía
 *
gc
)

3537 c⁄° 
STATE_INITIAL
 = 0;

3538 c⁄° 
STATE_READING_QUOTED_PARM
 = 1;

3539 c⁄° 
STATE_READING_UNQUOTED_PARM
 = 2;

3540 c⁄° 
STATE_DONE
 = 3;

3541 c⁄° 
STATE_READING_SQUOTED_PARM
 = 4;

3543 c⁄° *
îr‹_¥efix
 = "";

3545 
ªt
 = 0;

3546 c⁄° *
c
 = 
löe
;

3547 
°©e
 = 
STATE_INITIAL
;

3548 
boﬁ
 
back¶ash
 = 
Ál£
;

3549 
ö
, 
out
;

3551 
∑rm
[
OPTION_PARM_SIZE
];

3552 
∑rm_Àn
 = 0;

3554 
msgÀvñ
 &~
M_OPTERR
;

3556 i‡(
msgÀvñ
 & 
M_MSG_VIRT_OUT
)

3557 
îr‹_¥efix
 = "ERROR: ";

3561 
ö
 = *
c
;

3562 
out
 = 0;

3564 i‡(!
back¶ash
 && 
ö
 ='\\' && 
°©e
 !
STATE_READING_SQUOTED_PARM
)

3566 
back¶ash
 = 
åue
;

3570 i‡(
°©e
 =
STATE_INITIAL
)

3572 i‡(!
	`•a˚
 (
ö
))

3574 i‡(
ö
 == ';' || in == '#')

3576 i‡(!
back¶ash
 && 
ö
 == '\"')

3577 
°©e
 = 
STATE_READING_QUOTED_PARM
;

3578 i‡(!
back¶ash
 && 
ö
 == '\'')

3579 
°©e
 = 
STATE_READING_SQUOTED_PARM
;

3582 
out
 = 
ö
;

3583 
°©e
 = 
STATE_READING_UNQUOTED_PARM
;

3587 i‡(
°©e
 =
STATE_READING_UNQUOTED_PARM
)

3589 i‡(!
back¶ash
 && 
	`•a˚
 (
ö
))

3590 
°©e
 = 
STATE_DONE
;

3592 
out
 = 
ö
;

3594 i‡(
°©e
 =
STATE_READING_QUOTED_PARM
)

3596 i‡(!
back¶ash
 && 
ö
 == '\"')

3597 
°©e
 = 
STATE_DONE
;

3599 
out
 = 
ö
;

3601 i‡(
°©e
 =
STATE_READING_SQUOTED_PARM
)

3603 i‡(
ö
 == '\'')

3604 
°©e
 = 
STATE_DONE
;

3606 
out
 = 
ö
;

3608 i‡(
°©e
 =
STATE_DONE
)

3611 
p
[
ªt
] = 
	`gc_mÆloc
 (
∑rm_Àn
 + 1, 
åue
, 
gc
);

3612 
	`mem˝y
 (
p
[
ªt
], 
∑rm
, 
∑rm_Àn
);

3613 
p
[
ªt
][
∑rm_Àn
] = '\0';

3614 
°©e
 = 
STATE_INITIAL
;

3615 
∑rm_Àn
 = 0;

3616 ++
ªt
;

3619 i‡(
back¶ash
 && 
out
)

3621 i‡(!(
out
 ='\\' || ouà='\"' || 
	`•a˚
 (out)))

3623 #ifde‡
ENABLE_SMALL


3624 
	`msg
 (
msgÀvñ
, "%sO±i⁄†w¨nög: Bad back¶ash ('\\'Ëußgêö %s:%d", 
îr‹_¥efix
, 
fûe
, 
löe_num
);

3626 
	`msg
 (
msgÀvñ
, "%sO±i⁄†w¨nög: Bad back¶ash ('\\'Ëußgêö %s:%d:ÑemembîÅh© back¶ashe†¨êåóãdá†shñl-esˇ≥†™d i‡youÇìdÅÿ∑s†back¶ash ch¨a˘î†a†∑π o‡®Wödow†fûíame, you should u£ doubÀ back¶ashe†suchá†\"c:\\\\" 
PACKAGE
 "\\\\°©ic.key\"", 
îr‹_¥efix
, 
fûe
, 
löe_num
);

3631 
back¶ash
 = 
Ál£
;

3635 i‡(
out
)

3637 i‡(
∑rm_Àn
 >
	`SIZE
 (
∑rm
))

3639 
∑rm
[
	`SIZE
 (parm) - 1] = 0;

3640 
	`msg
 (
msgÀvñ
, "%sOptionsÉrror: Parameterát %s:%d isÅooÜong (%d chars max): %s",

3641 
îr‹_¥efix
, 
fûe
, 
löe_num
, (Ë
	`SIZE
 (
∑rm
),Öarm);

3644 
∑rm
[
∑rm_Àn
++] = 
out
;

3648 i‡(
ªt
 >
n
)

3651 } *
c
++ != '\0');

3653 i‡(
°©e
 =
STATE_READING_QUOTED_PARM
)

3655 
	`msg
 (
msgÀvñ
, "%sO±i⁄†îr‹: Nÿ˛osög quŸ©i⁄ (\"Ëö %s:%d", 
îr‹_¥efix
, 
fûe
, 
löe_num
);

3658 i‡(
°©e
 =
STATE_READING_SQUOTED_PARM
)

3660 
	`msg
 (
msgÀvñ
, "%sO±i⁄†îr‹: Nÿ˛osög sögÀ quŸ©i⁄ (\'Ëö %s:%d", 
îr‹_¥efix
, 
fûe
, 
löe_num
);

3663 i‡(
°©e
 !
STATE_INITIAL
)

3665 
	`msg
 (
msgÀvñ
, "%sO±i⁄†îr‹: ResiduÆÖ¨£ sèã (%dËö %s:%d", 
îr‹_¥efix
, 
°©e
, 
fûe
, 
löe_num
);

3670 
i
;

3671 
i
 = 0; i < 
ªt
; ++i)

3673 
	`msg
 (
M_INFO
|
M_NOPREFIX
, "%s:%d ARG[%d] '%s'", 
fûe
, 
löe_num
, 
i
, 
p
[i]);

3677  
ªt
;

3678 
	}
}

3681 
	$by∑ss_doubÀdash
 (**
p
)

3683 i‡(
	`°æí
 (*
p
Ë>3 && !
	`°∫cmp
 (*p, "--", 2))

3684 *
p
 += 2;

3685 
	}
}

3687 
	sö_§c
 {

3688 
	#IS_TYPE_FP
 1

	)

3689 
	#IS_TYPE_BUF
 2

	)

3690 
	mty≥
;

3692 
FILE
 *
	mÂ
;

3693 
buf„r
 *
	mmu…ûöe
;

3694 } 
	mu
;

3697 
boﬁ


3698 
	$ö_§c_gë
 (c⁄° 
ö_§c
 *
is
, *
löe
, c⁄° 
size
)

3700 i‡(
is
->
ty≥
 =
IS_TYPE_FP
)

3702  
	`BOOL_CAST
 (
	`fgës
 (
löe
, 
size
, 
is
->
u
.
Â
));

3704 i‡(
is
->
ty≥
 =
IS_TYPE_BUF
)

3706 
boﬁ
 
°©us
 = 
	`buf_∑r£
 (
is
->
u
.
mu…ûöe
, '\n', 
löe
, 
size
);

3707 i‡((Ë
	`°æí
 (
löe
Ë+ 1 < 
size
)

3708 
	`°rˇt
 (
löe
, "\n");

3709  
°©us
;

3713 
	`ASSERT
 (0);

3714  
Ál£
;

3716 
	}
}

3719 
	$ªad_ölöe_fûe
 (
ö_§c
 *
is
, c⁄° *
˛o£_èg
, 
gc_¨ía
 *
gc
)

3721 
löe
[
OPTION_LINE_SIZE
];

3722 
buf„r
 
buf
 = 
	`Æloc_buf
 (10000);

3723 *
ªt
;

3724 
	`ö_§c_gë
 (
is
, 
löe
,  (line)))

3726 i‡(!
	`°∫cmp
 (
löe
, 
˛o£_èg
, 
	`°æí
 (close_tag)))

3728 
	`buf_¥ötf
 (&
buf
, "%s", 
löe
);

3730 
ªt
 = 
	`°rög_Æloc
 (
	`BSTR
 (&
buf
), 
gc
);

3731 
	`buf_˛ór
 (&
buf
);

3732 
	`‰ì_buf
 (&
buf
);

3733 
	`CLEAR
 (
löe
);

3734  
ªt
;

3735 
	}
}

3737 
boﬁ


3738 
	$check_ölöe_fûe
 (
ö_§c
 *
is
, *
p
[], 
gc_¨ía
 *
gc
)

3740 
boﬁ
 
ªt
 = 
Ál£
;

3741 i‡(
p
[0] && !p[1])

3743 *
¨g
 = 
p
[0];

3744 i‡(
¨g
[0] ='<' &&árg[
	`°æí
(arg)-1] == '>')

3746 
buf„r
 
˛o£_èg
;

3747 
¨g
[
	`°æí
(arg)-1] = '\0';

3748 
p
[0] = 
	`°rög_Æloc
 (
¨g
+1, 
gc
);

3749 
p
[1] = 
	`°rög_Æloc
 (
INLINE_FILE_TAG
, 
gc
);

3750 
˛o£_èg
 = 
	`Æloc_buf
 (
	`°æí
(
p
[0]) + 4);

3751 
	`buf_¥ötf
 (&
˛o£_èg
, "</%s>", 
p
[0]);

3752 
p
[2] = 
	`ªad_ölöe_fûe
 (
is
, 
	`BSTR
 (&
˛o£_èg
), 
gc
);

3753 
p
[3] = 
NULL
;

3754 
	`‰ì_buf
 (&
˛o£_èg
);

3755 
ªt
 = 
åue
;

3758  
ªt
;

3759 
	}
}

3761 
boﬁ


3762 
	$check_ölöe_fûe_vü_Â
 (
FILE
 *
Â
, *
p
[], 
gc_¨ía
 *
gc
)

3764 
ö_§c
 
is
;

3765 
is
.
ty≥
 = 
IS_TYPE_FP
;

3766 
is
.
u
.
Â
 = fp;

3767  
	`check_ölöe_fûe
 (&
is
, 
p
, 
gc
);

3768 
	}
}

3770 
boﬁ


3771 
	$check_ölöe_fûe_vü_buf
 (
buf„r
 *
mu…ûöe
, *
p
[], 
gc_¨ía
 *
gc
)

3773 
ö_§c
 
is
;

3774 
is
.
ty≥
 = 
IS_TYPE_BUF
;

3775 
is
.
u
.
mu…ûöe
 = multiline;

3776  
	`check_ölöe_fûe
 (&
is
, 
p
, 
gc
);

3777 
	}
}

3780 
add_›ti⁄
 (
›ti⁄s
 *options,

3781 *
p
[],

3782 c⁄° *
fûe
,

3783 
löe
,

3784 c⁄° 
Àvñ
,

3785 c⁄° 
msgÀvñ
,

3786 c⁄° 
≥rmissi⁄_mask
,

3787 *
›ti⁄_ty≥s_found
,

3788 
ív_£t
 *
es
);

3791 
	$ªad_c⁄fig_fûe
 (
›ti⁄s
 *options,

3792 c⁄° *
fûe
,

3793 
Àvñ
,

3794 c⁄° *
t›_fûe
,

3795 c⁄° 
t›_löe
,

3796 c⁄° 
msgÀvñ
,

3797 c⁄° 
≥rmissi⁄_mask
,

3798 *
›ti⁄_ty≥s_found
,

3799 
ív_£t
 *
es
)

3801 c⁄° 
max_ªcursive_Àvñs
 = 10;

3802 
FILE
 *
Â
;

3803 
löe_num
;

3804 
löe
[
OPTION_LINE_SIZE
];

3805 *
p
[
MAX_PARMS
];

3807 ++
Àvñ
;

3808 i‡(
Àvñ
 <
max_ªcursive_Àvñs
)

3810 i‡(
	`°ªq
 (
fûe
, "stdin"))

3811 
Â
 = 
°dö
;

3813 
Â
 = 
	`∂©f‹m_f›í
 (
fûe
, "r");

3814 i‡(
Â
)

3816 
löe_num
 = 0;

3817 
	`fgës
(
löe
,  (löe), 
Â
))

3819 
off£t
 = 0;

3820 
	`CLEAR
 (
p
);

3821 ++
löe_num
;

3823 i‡(
löe_num
 =1 && 
	`°∫cmp
 (
löe
, "\xEF\xBB\xBF", 3) == 0)

3824 
off£t
 = 3;

3825 i‡(
	`∑r£_löe
 (
löe
 + 
off£t
, 
p
, 
	`SIZE
 (p), 
fûe
, 
löe_num
, 
msgÀvñ
, &
›ti⁄s
->
gc
))

3827 
	`by∑ss_doubÀdash
 (&
p
[0]);

3828 
	`check_ölöe_fûe_vü_Â
 (
Â
, 
p
, &
›ti⁄s
->
gc
);

3829 
	`add_›ti⁄
 (
›ti⁄s
, 
p
, 
fûe
, 
löe_num
, 
Àvñ
, 
msgÀvñ
, 
≥rmissi⁄_mask
, 
›ti⁄_ty≥s_found
, 
es
);

3832 i‡(
Â
 !
°dö
)

3833 
	`f˛o£
 (
Â
);

3837 
	`msg
 (
msgÀvñ
, "I¿%s:%d: Eº‹ o≥nög c⁄figuøti⁄ fûe: %s", 
t›_fûe
, 
t›_löe
, 
fûe
);

3842 
	`msg
 (
msgÀvñ
, "I¿%s:%d: MaximumÑecursivêö˛udêÀvñ†ex˚eded i¿ö˛udê©ãm± o‡fûê%†--Örobably you havê®c⁄figuøti⁄ fûêth©Årõ†tÿö˛udêô£lf.", 
t›_fûe
, 
t›_löe
, 
fûe
);

3844 
	`CLEAR
 (
löe
);

3845 
	`CLEAR
 (
p
);

3846 
	}
}

3849 
	$ªad_c⁄fig_°rög
 (c⁄° *
¥efix
,

3850 
›ti⁄s
 *options,

3851 c⁄° *
c⁄fig
,

3852 c⁄° 
msgÀvñ
,

3853 c⁄° 
≥rmissi⁄_mask
,

3854 *
›ti⁄_ty≥s_found
,

3855 
ív_£t
 *
es
)

3857 
löe
[
OPTION_LINE_SIZE
];

3858 
buf„r
 
mu…ûöe
;

3859 
löe_num
 = 0;

3861 
	`buf_£t_ªad
 (&
mu…ûöe
, (
uöt8_t
*)
c⁄fig
, 
	`°æí
 (config));

3863 
	`buf_∑r£
 (&
mu…ûöe
, '\n', 
löe
,  (line)))

3865 *
p
[
MAX_PARMS
];

3866 
	`CLEAR
 (
p
);

3867 ++
löe_num
;

3868 i‡(
	`∑r£_löe
 (
löe
, 
p
, 
	`SIZE
 (p), 
¥efix
, 
löe_num
, 
msgÀvñ
, &
›ti⁄s
->
gc
))

3870 
	`by∑ss_doubÀdash
 (&
p
[0]);

3871 
	`check_ölöe_fûe_vü_buf
 (&
mu…ûöe
, 
p
, &
›ti⁄s
->
gc
);

3872 
	`add_›ti⁄
 (
›ti⁄s
, 
p
, 
¥efix
, 
löe_num
, 0, 
msgÀvñ
, 
≥rmissi⁄_mask
, 
›ti⁄_ty≥s_found
, 
es
);

3874 
	`CLEAR
 (
p
);

3876 
	`CLEAR
 (
löe
);

3877 
	}
}

3880 
	$∑r£_¨gv
 (
›ti⁄s
 *options,

3881 c⁄° 
¨gc
,

3882 *
¨gv
[],

3883 c⁄° 
msgÀvñ
,

3884 c⁄° 
≥rmissi⁄_mask
,

3885 *
›ti⁄_ty≥s_found
,

3886 
ív_£t
 *
es
)

3888 
i
, 
j
;

3891 i‡(
¨gc
 <= 1)

3892 
	`ußge
 ();

3895 i‡(
¨gc
 =2 && 
	`°∫cmp
 (
¨gv
[1], "--", 2))

3897 *
p
[
MAX_PARMS
];

3898 
	`CLEAR
 (
p
);

3899 
p
[0] = "config";

3900 
p
[1] = 
¨gv
[1];

3901 
	`add_›ti⁄
 (
›ti⁄s
, 
p
, 
NULL
, 0, 0, 
msgÀvñ
, 
≥rmissi⁄_mask
, 
›ti⁄_ty≥s_found
, 
es
);

3906 
i
 = 1; i < 
¨gc
; ++i)

3908 *
p
[
MAX_PARMS
];

3909 
	`CLEAR
 (
p
);

3910 
p
[0] = 
¨gv
[
i
];

3911 i‡(
	`°∫cmp
(
p
[0], "--", 2))

3913 
	`msg
 (
msgÀvñ
, "I'mÅryögÅÿ∑r£ \"%s\"á†™ --›ti⁄Ö¨amëî buàI d⁄'à£ê®Àadög '--'", 
p
[0]);

3916 
p
[0] += 2;

3918 
j
 = 1; j < 
MAX_PARMS
; ++j)

3920 i‡(
i
 + 
j
 < 
¨gc
)

3922 *
¨g
 = 
¨gv
[
i
 + 
j
];

3923 i‡(
	`°∫cmp
 (
¨g
, "--", 2))

3924 
p
[
j
] = 
¨g
;

3929 
	`add_›ti⁄
 (
›ti⁄s
, 
p
, 
NULL
, 0, 0, 
msgÀvñ
, 
≥rmissi⁄_mask
, 
›ti⁄_ty≥s_found
, 
es
);

3930 
i
 +
j
 - 1;

3933 
	}
}

3935 
boﬁ


3936 
	$≠∂y_push_›ti⁄s
 (
›ti⁄s
 *options,

3937 
buf„r
 *
buf
,

3938 
≥rmissi⁄_mask
,

3939 *
›ti⁄_ty≥s_found
,

3940 
ív_£t
 *
es
)

3942 
löe
[
OPTION_PARM_SIZE
];

3943 
löe_num
 = 0;

3944 c⁄° *
fûe
 = "[PUSH-OPTIONS]";

3945 c⁄° 
msgÀvñ
 = 
D_PUSH_ERRORS
|
M_OPTERR
;

3947 
	`buf_∑r£
 (
buf
, ',', 
löe
,  (line)))

3949 *
p
[
MAX_PARMS
];

3950 
	`CLEAR
 (
p
);

3951 ++
löe_num
;

3952 i‡(
	`∑r£_löe
 (
löe
, 
p
, 
	`SIZE
 (p), 
fûe
, 
löe_num
, 
msgÀvñ
, &
›ti⁄s
->
gc
))

3954 
	`add_›ti⁄
 (
›ti⁄s
, 
p
, 
fûe
, 
löe_num
, 0, 
msgÀvñ
, 
≥rmissi⁄_mask
, 
›ti⁄_ty≥s_found
, 
es
);

3957  
åue
;

3958 
	}
}

3961 
	$›ti⁄s_£rvî_imp‹t
 (
›ti⁄s
 *
o
,

3962 c⁄° *
fûíame
,

3963 
msgÀvñ
,

3964 
≥rmissi⁄_mask
,

3965 *
›ti⁄_ty≥s_found
,

3966 
ív_£t
 *
es
)

3968 
	`msg
 (
D_PUSH
, "OPTIONS IMPORT:Ñódög clõ¡ s≥cifi¯›ti⁄†‰om: %s", 
fûíame
);

3969 
	`ªad_c⁄fig_fûe
 (
o
,

3970 
fûíame
,

3972 
fûíame
,

3974 
msgÀvñ
,

3975 
≥rmissi⁄_mask
,

3976 
›ti⁄_ty≥s_found
,

3977 
es
);

3978 
	}
}

3980 
	$›ti⁄s_°rög_imp‹t
 (
›ti⁄s
 *options,

3981 c⁄° *
c⁄fig
,

3982 c⁄° 
msgÀvñ
,

3983 c⁄° 
≥rmissi⁄_mask
,

3984 *
›ti⁄_ty≥s_found
,

3985 
ív_£t
 *
es
)

3987 
	`ªad_c⁄fig_°rög
 ("[CONFIG-STRING]", 
›ti⁄s
, 
c⁄fig
, 
msgÀvñ
, 
≥rmissi⁄_mask
, 
›ti⁄_ty≥s_found
, 
es
);

3988 
	}
}

3990 #i‡
P2MP


3992 
	#VERIFY_PERMISSION
(
mask
Ë{ i‡(!
	`vîify_≥rmissi⁄
(
p
[0], 
fûe
, 
löe
, (mask), 
≥rmissi⁄_mask
, 
›ti⁄_ty≥s_found
, 
msgÀvñ
, 
›ti⁄s
)Ë
îr
; }

	)

3994 
boﬁ


3995 
	$vîify_≥rmissi⁄
 (c⁄° *
«me
,

3996 c⁄° * 
fûe
,

3997 
löe
,

3998 c⁄° 
ty≥
,

3999 c⁄° 
Ælowed
,

4000 *
found
,

4001 c⁄° 
msgÀvñ
,

4002 
›ti⁄s
* options)

4004 i‡(!(
ty≥
 & 
Ælowed
))

4006 
	`msg
 (
msgÀvñ
, "›ti⁄ '%s' c™nŸ bêu£d i¿thi†c⁄ãxà(%s)", 
«me
, 
fûe
);

4007  
Ál£
;

4010 i‡(
found
)

4011 *
found
 |
ty≥
;

4013 #i‚de‡
ENABLE_SMALL


4020 i‡((
ty≥
 & 
OPT_P_CONNECTION
Ë&& 
›ti⁄s
->
c⁄√˘i⁄_li°
)

4022 i‡(
fûe
)

4023 
	`msg
 (
M_WARN
, "O±i⁄ '%s' i¿%s:%d i†ign‹ed byÖªviou†<c⁄√˘i⁄> block†", 
«me
, 
fûe
, 
löe
);

4025 
	`msg
 (
M_WARN
, "O±i⁄ '%s' i†ign‹ed byÖªviou†<c⁄√˘i⁄> blocks", 
«me
);

4028  
åue
;

4029 
	}
}

4033 
	#VERIFY_PERMISSION
(
mask
)

	)

4042 
	#NM_QUOTE_HINT
 (1<<0)

	)

4044 
boﬁ


4045 
	$no_m‹e_th™_n_¨gs
 (c⁄° 
msgÀvñ
,

4046 *
p
[],

4047 c⁄° 
max
,

4048 c⁄° 
Êags
)

4050 c⁄° 
Àn
 = 
	`°rög_¨øy_Àn
 ((c⁄° **)
p
);

4052 i‡(!
Àn
)

4053  
Ál£
;

4055 i‡(
Àn
 > 
max
)

4057 
	`msg
 (
msgÀvñ
, "the --%s directive should haveát most %dÖarameter%s.%s",

4058 
p
[0],

4059 
max
 - 1,

4060 
max
 >= 3 ? "s" : "",

4061 (
Êags
 & 
NM_QUOTE_HINT
) ? " ToÖassáÜist ofárgumentsás one ofÅheÖarameters,ÅryÉnclosingÅhem in double quotes (\"\")." : "");

4062  
Ál£
;

4065  
åue
;

4066 
	}
}

4068 
ölöe
 

4069 
	$msgÀvñ_f‹w¨d_com∑tibÀ
 (
›ti⁄s
 *›ti⁄s, c⁄° 
msgÀvñ
)

4071  
›ti⁄s
->
f‹w¨d_com∑tibÀ
 ? 
M_WARN
 : 
msgÀvñ
;

4072 
	}
}

4075 
	$£t_u£r_s¸ùt
 (
›ti⁄s
 *options,

4076 c⁄° **
s¸ùt
,

4077 c⁄° *
√w_s¸ùt
,

4078 c⁄° *
ty≥
,

4079 
boﬁ
 
ö_chroŸ
)

4081 i‡(*
s¸ùt
) {

4082 
	`msg
 (
M_WARN
, "Multiple --%s scripts defined. "

4083 "Thê¥eviou¶y c⁄figuªd s¸ùài†ovîriddí.", 
ty≥
);

4085 *
s¸ùt
 = 
√w_s¸ùt
;

4086 
›ti⁄s
->
u£r_s¸ùt_u£d
 = 
åue
;

4088 #i‚de‡
ENABLE_SMALL


4090 
s¸ùt_«me
[100];

4091 
	`›ív≤_¢¥ötf
 (
s¸ùt_«me
, (script_name),

4092 "--%†s¸ùt", 
ty≥
);

4094 i‡(
	`check_cmd_ac˚ss
 (*
s¸ùt
, 
s¸ùt_«me
, (
ö_chroŸ
 ? 
›ti⁄s
->
chroŸ_dú
 : 
NULL
)))

4095 
	`msg
 (
M_USAGE
, "Please correctÅhisÉrror.");

4099 
	}
}

4103 
	$add_›ti⁄
 (
›ti⁄s
 *options,

4104 *
p
[],

4105 c⁄° *
fûe
,

4106 
löe
,

4107 c⁄° 
Àvñ
,

4108 c⁄° 
msgÀvñ
,

4109 c⁄° 
≥rmissi⁄_mask
,

4110 *
›ti⁄_ty≥s_found
,

4111 
ív_£t
 *
es
)

4113 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

4114 c⁄° 
boﬁ
 
puŒ_mode
 = 
	`BOOL_CAST
 (
≥rmissi⁄_mask
 & 
OPT_P_PULL_MODE
);

4115 
msgÀvñ_fc
 = 
	`msgÀvñ_f‹w¨d_com∑tibÀ
 (
›ti⁄s
, 
msgÀvñ
);

4117 
	`ASSERT
 (
MAX_PARMS
 >= 7);

4123 i‡(
	`°ªq
 (
p
[0], "£ãnv"Ë&&Ö[1] && såeq (p[1], "›t"Ë&& !(
≥rmissi⁄_mask
 & 
OPT_P_PULL_MODE
))

4125 
p
 += 2;

4126 
msgÀvñ_fc
 = 
M_WARN
;

4129 i‡(!
fûe
)

4131 
fûe
 = "[CMD-LINE]";

4132 
löe
 = 1;

4134 i‡(
	`°ªq
 (
p
[0], "help"))

4136 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4137 
	`ußge
 ();

4139 i‡(
	`°ªq
 (
p
[0], "version"))

4141 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4142 
	`ußge_vîsi⁄
 ();

4144 i‡(
	`°ªq
 (
p
[0], "config") &&Ö[1])

4146 
	`VERIFY_PERMISSION
 (
OPT_P_CONFIG
);

4149 i‡(!
›ti⁄s
->
c⁄fig
)

4150 
›ti⁄s
->
c⁄fig
 = 
p
[1];

4152 
	`ªad_c⁄fig_fûe
 (
›ti⁄s
, 
p
[1], 
Àvñ
, 
fûe
, 
löe
, 
msgÀvñ
, 
≥rmissi⁄_mask
, 
›ti⁄_ty≥s_found
, 
es
);

4154 #i‡
	`deföed
(
ENABLE_DEBUG
Ë&& !deföed(
ENABLE_SMALL
)

4155 i‡(
	`°ªq
 (
p
[0], "show-gateway"))

4157 
rouã_g©eway_öfo
 
rgi
;

4158 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4159 
	`gë_deÁu…_g©eway
(&
rgi
);

4160 
	`¥öt_deÁu…_g©eway
(
M_INFO
, &
rgi
);

4161 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_GOOD
);

4165 i‡(
	`°ªq
 (
p
[0], "foreign-option") &&Ö[1])

4167 
	`VERIFY_PERMISSION
 (
OPT_P_IPWIN32
);

4168 
	`f‹eign_›ti⁄
 (
›ti⁄s
, 
p
, 3, 
es
);

4171 i‡(
	`°ªq
 (
p
[0], "echo") || streq (p[0], "parameter"))

4173 
buf„r
 
°rög
 = 
	`Æloc_buf_gc
 (
OPTION_PARM_SIZE
, &
gc
);

4174 
j
;

4175 
boﬁ
 
good
 = 
åue
;

4177 
	`VERIFY_PERMISSION
 (
OPT_P_ECHO
);

4179 
j
 = 1; j < 
MAX_PARMS
; ++j)

4181 i‡(!
p
[
j
])

4183 i‡(
j
 > 1)

4184 
good
 &
	`buf_¥ötf
 (&
°rög
, " ");

4185 
good
 &
	`buf_¥ötf
 (&
°rög
, "%s", 
p
[
j
]);

4187 i‡(
good
)

4192 
	`msg
 (
M_INFO
, "%s:%s",

4193 
puŒ_mode
 ? "ECHO-PULL" : "ECHO",

4194 
	`BSTR
 (&
°rög
));

4196 #ifde‡
ENABLE_MANAGEMENT


4197 i‡(
m™agemít
)

4198 
	`m™agemít_echo
 (
m™agemít
, 
	`BSTR
 (&
°rög
), 
puŒ_mode
);

4202 
	`msg
 (
M_WARN
, "echo/parameter option overflow");

4204 #ifde‡
ENABLE_MANAGEMENT


4205 i‡(
	`°ªq
 (
p
[0], "management") &&Ö[1] &&Ö[2])

4207 
p‹t
 = 0;

4209 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4210 i‡(
	`°ªq
 (
p
[2], "unix"))

4212 #i‡
UNIX_SOCK_SUPPORT


4213 
›ti⁄s
->
m™agemít_Êags
 |
MF_UNIX_SOCK
;

4215 
	`msg
 (
msgÀvñ
, "MANAGEMENT:ÅhisÖlatform doesÇot support unix domain sockets");

4216 
îr
;

4221 
p‹t
 = 
	`©oi
 (
p
[2]);

4222 i‡(!
	`ÀgÆ_ùv4_p‹t
 (
p‹t
))

4224 
	`msg
 (
msgÀvñ
, "portÇumberássociated with --management directive is out ofÑange");

4225 
îr
;

4229 
›ti⁄s
->
m™agemít_addr
 = 
p
[1];

4230 
›ti⁄s
->
m™agemít_p‹t
 = 
p‹t
;

4231 i‡(
p
[3])

4233 
›ti⁄s
->
m™agemít_u£r_∑ss
 = 
p
[3];

4236 i‡(
	`°ªq
 (
p
[0], "management-client-user") &&Ö[1])

4238 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4239 
›ti⁄s
->
m™agemít_˛õ¡_u£r
 = 
p
[1];

4241 i‡(
	`°ªq
 (
p
[0], "management-client-group") &&Ö[1])

4243 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4244 
›ti⁄s
->
m™agemít_˛õ¡_group
 = 
p
[1];

4246 i‡(
	`°ªq
 (
p
[0], "management-query-passwords"))

4248 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4249 
›ti⁄s
->
m™agemít_Êags
 |
MF_QUERY_PASSWORDS
;

4251 i‡(
	`°ªq
 (
p
[0], "management-query-remote"))

4253 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4254 
›ti⁄s
->
m™agemít_Êags
 |
MF_QUERY_REMOTE
;

4256 i‡(
	`°ªq
 (
p
[0], "management-query-proxy"))

4258 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4259 
›ti⁄s
->
m™agemít_Êags
 |
MF_QUERY_PROXY
;

4260 
›ti⁄s
->
f‹˚_c⁄√˘i⁄_li°
 = 
åue
;

4262 i‡(
	`°ªq
 (
p
[0], "management-hold"))

4264 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4265 
›ti⁄s
->
m™agemít_Êags
 |
MF_HOLD
;

4267 i‡(
	`°ªq
 (
p
[0], "management-signal"))

4269 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4270 
›ti⁄s
->
m™agemít_Êags
 |
MF_SIGNAL
;

4272 i‡(
	`°ªq
 (
p
[0], "management-forget-disconnect"))

4274 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4275 
›ti⁄s
->
m™agemít_Êags
 |
MF_FORGET_DISCONNECT
;

4277 i‡(
	`°ªq
 (
p
[0], "management-up-down"))

4279 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4280 
›ti⁄s
->
m™agemít_Êags
 |
MF_UP_DOWN
;

4282 i‡(
	`°ªq
 (
p
[0], "management-client"))

4284 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4285 
›ti⁄s
->
m™agemít_Êags
 |
MF_CONNECT_AS_CLIENT
;

4286 
›ti⁄s
->
m™agemít_wrôe_≥î_öfo_fûe
 = 
p
[1];

4288 #ifde‡
MANAGMENT_EXTERNAL_KEY


4289 i‡(
	`°ªq
 (
p
[0], "management-external-key"))

4291 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4292 
›ti⁄s
->
m™agemít_Êags
 |
MF_EXTERNAL_KEY
;

4295 #ifde‡
MANAGEMENT_DEF_AUTH


4296 i‡(
	`°ªq
 (
p
[0], "management-client-auth"))

4298 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4299 
›ti⁄s
->
m™agemít_Êags
 |
MF_CLIENT_AUTH
;

4302 #ifde‡
ENABLE_X509_TRACK


4303 i‡(
	`°ªq
 (
p
[0], "x509-track") &&Ö[1])

4305 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4306 
	`x509_åack_add
 (&
›ti⁄s
->
x509_åack
, 
p
[1], 
msgÀvñ
, &›ti⁄s->
gc
);

4309 #ifde‡
MANAGEMENT_PF


4310 i‡(
	`°ªq
 (
p
[0], "management-client-pf"))

4312 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4313 
›ti⁄s
->
m™agemít_Êags
 |(
MF_CLIENT_PF
 | 
MF_CLIENT_AUTH
);

4316 i‡(
	`°ªq
 (
p
[0], "management-log-cache") &&Ö[1])

4318 
ˇche
;

4320 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4321 
ˇche
 = 
	`©oi
 (
p
[1]);

4322 i‡(
ˇche
 < 1)

4324 
	`msg
 (
msgÀvñ
, "--management-log-cacheÖarameter is out ofÑange");

4325 
îr
;

4327 
›ti⁄s
->
m™agemít_log_hi°‹y_ˇche
 = 
ˇche
;

4330 #ifde‡
ENABLE_PLUGIN


4331 i‡(
	`°ªq
 (
p
[0], "plugin") &&Ö[1])

4333 
	`VERIFY_PERMISSION
 (
OPT_P_PLUGIN
);

4334 i‡(!
›ti⁄s
->
∂ugö_li°
)

4335 
›ti⁄s
->
∂ugö_li°
 = 
	`∂ugö_›ti⁄_li°_√w
 (&›ti⁄s->
gc
);

4336 i‡(!
	`∂ugö_›ti⁄_li°_add
 (
›ti⁄s
->
∂ugö_li°
, &
p
[1], &›ti⁄s->
gc
))

4338 
	`msg
 (
msgÀvñ
, "∂ugöádd faûed: %s", 
p
[1]);

4339 
îr
;

4343 i‡(
	`°ªq
 (
p
[0], "mode") &&Ö[1])

4345 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4346 i‡(
	`°ªq
 (
p
[1], "p2p"))

4347 
›ti⁄s
->
mode
 = 
MODE_POINT_TO_POINT
;

4348 #i‡
P2MP_SERVER


4349 i‡(
	`°ªq
 (
p
[1], "server"))

4350 
›ti⁄s
->
mode
 = 
MODE_SERVER
;

4354 
	`msg
 (
msgÀvñ
, "Bad --modê∑ømëî: %s", 
p
[1]);

4355 
îr
;

4358 i‡(
	`°ªq
 (
p
[0], "dev") &&Ö[1])

4360 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4361 
›ti⁄s
->
dev
 = 
p
[1];

4363 i‡(
	`°ªq
 (
p
[0], "dev-type") &&Ö[1])

4365 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4366 
›ti⁄s
->
dev_ty≥
 = 
p
[1];

4368 i‡(
	`°ªq
 (
p
[0], "dev-node") &&Ö[1])

4370 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4371 
›ti⁄s
->
dev_node
 = 
p
[1];

4373 i‡(
	`°ªq
 (
p
[0], "lladdr") &&Ö[1])

4375 
	`VERIFY_PERMISSION
 (
OPT_P_UP
);

4376 i‡(
	`mac_addr_ß„
 (
p
[1]))

4377 
›ti⁄s
->
Œaddr
 = 
p
[1];

4380 
	`msg
 (
msgÀvñ
, "Œadd∏∑rm '%s' mu° bê®MACáddªss", 
p
[1]);

4381 
îr
;

4384 i‡(
	`°ªq
 (
p
[0], "topology") &&Ö[1])

4386 
	`VERIFY_PERMISSION
 (
OPT_P_UP
);

4387 
›ti⁄s
->
t›ﬁogy
 = 
	`∑r£_t›ﬁogy
 (
p
[1], 
msgÀvñ
);

4389 i‡(
	`°ªq
 (
p
[0], "tun-ipv6"))

4391 
	`VERIFY_PERMISSION
 (
OPT_P_UP
);

4392 
›ti⁄s
->
tun_ùv6
 = 
åue
;

4394 #ifde‡
ENABLE_IPROUTE


4395 i‡(
	`°ªq
 (
p
[0], "iproute") &&Ö[1])

4397 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4398 
ùrouã_∑th
 = 
p
[1];

4401 i‡(
	`°ªq
 (
p
[0], "ifconfig") &&Ö[1] &&Ö[2])

4403 
	`VERIFY_PERMISSION
 (
OPT_P_UP
);

4404 i‡(
	`ù_‹_dns_addr_ß„
 (
p
[1], 
›ti⁄s
->
Ælow_puŒ_fqdn
) && ip_or_dns_addr_safe (p[2], options->allow_pull_fqdn))

4406 
›ti⁄s
->
ifc⁄fig_loˇl
 = 
p
[1];

4407 
›ti⁄s
->
ifc⁄fig_ªmŸe_√tmask
 = 
p
[2];

4411 
	`msg
 (
msgÀvñ
, "ifc⁄figÖ¨m†'%s'ánd '%s' mu° bêvÆidáddªs£s", 
p
[1],Ö[2]);

4412 
îr
;

4415 i‡(
	`°ªq
 (
p
[0], "ifconfig-ipv6") &&Ö[1] &&Ö[2] )

4417 
√tbôs
;

4418 * 
ùv6_loˇl
;

4420 
	`VERIFY_PERMISSION
 (
OPT_P_UP
);

4421 i‡–
	`gë_ùv6_addr
–
p
[1], 
NULL
, &
√tbôs
, &
ùv6_loˇl
, 
msgÀvñ
 ) &&

4422 
	`ùv6_addr_ß„
–
p
[2] ) )

4424 i‡–
√tbôs
 < 64 ||Çetbits > 124 )

4426 
	`msg
–
msgÀvñ
, "ifc⁄fig-ùv6: /√tbô†mu° bêbëwì¿64ánd 124,ÇŸ '/%d'", 
√tbôs
 );

4427 
îr
;

4430 i‡(
›ti⁄s
->
ifc⁄fig_ùv6_loˇl
)

4432 
	`‰ì
 ((*Ë
›ti⁄s
->
ifc⁄fig_ùv6_loˇl
);

4434 
›ti⁄s
->
ifc⁄fig_ùv6_loˇl
 = 
ùv6_loˇl
;

4435 
›ti⁄s
->
ifc⁄fig_ùv6_√tbôs
 = 
√tbôs
;

4436 
›ti⁄s
->
ifc⁄fig_ùv6_ªmŸe
 = 
p
[2];

4440 
	`msg
 (
msgÀvñ
, "ifc⁄fig-ùv6Ö¨m†'%s'ánd '%s' mu° bêvÆidáddªs£s", 
p
[1],Ö[2]);

4441 
îr
;

4444 i‡(
	`°ªq
 (
p
[0], "ifconfig-noexec"))

4446 
	`VERIFY_PERMISSION
 (
OPT_P_UP
);

4447 
›ti⁄s
->
ifc⁄fig_n€xec
 = 
åue
;

4449 i‡(
	`°ªq
 (
p
[0], "ifconfig-nowarn"))

4451 
	`VERIFY_PERMISSION
 (
OPT_P_UP
);

4452 
›ti⁄s
->
ifc⁄fig_now¨n
 = 
åue
;

4454 i‡(
	`°ªq
 (
p
[0], "local") &&Ö[1])

4456 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

4457 
›ti⁄s
->
˚
.
loˇl
 = 
p
[1];

4459 i‡(
	`°ªq
 (
p
[0], "remote-random"))

4461 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4462 
›ti⁄s
->
ªmŸe_øndom
 = 
åue
;

4464 i‡(
	`°ªq
 (
p
[0], "connection") &&Ö[1])

4466 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4467 i‡(
	`°ªq
 (
p
[1], 
INLINE_FILE_TAG
) &&Ö[2])

4469 
›ti⁄s
 
sub
;

4470 
c⁄√˘i⁄_íåy
 *
e
;

4472 
	`öô_›ti⁄s
 (&
sub
, 
åue
);

4473 
sub
.
˚
 = 
›ti⁄s
->ce;

4474 
	`ªad_c⁄fig_°rög
 ("[CONNECTION-OPTIONS]", &
sub
, 
p
[2], 
msgÀvñ
, 
OPT_P_CONNECTION
, 
›ti⁄_ty≥s_found
, 
es
);

4475 i‡(!
sub
.
˚
.
ªmŸe
)

4477 
	`msg
 (
msgÀvñ
, "Each 'connection' block must containÉxactly one 'remote' directive");

4478 
îr
;

4481 
e
 = 
	`Æloc_c⁄√˘i⁄_íåy
 (
›ti⁄s
, 
msgÀvñ
);

4482 i‡(!
e
)

4483 
îr
;

4484 *
e
 = 
sub
.
˚
;

4485 
	`gc_å™s„r
 (&
›ti⁄s
->
gc
, &
sub
.gc);

4486 
	`unöô_›ti⁄s
 (&
sub
);

4489 i‡(
	`°ªq
 (
p
[0], "ignore-unknown-option") &&Ö[1])

4491 
i
;

4492 
j
;

4493 
numign‹ed
=0;

4494 c⁄° **
ign‹e
;

4496 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4498 
i
=1;
p
[i];i++)

4499 
numign‹ed
++;

4502 
i
=0;
›ti⁄s
->
ign‹e_unknown_›ti⁄
 &&

4503 
›ti⁄s
->
ign‹e_unknown_›ti⁄
[
i
]; i++)

4504 
numign‹ed
++;

4507 
	`ALLOC_ARRAY_GC
 (
ign‹e
, c⁄° *, 
numign‹ed
+1, &
›ti⁄s
->
gc
);

4508 
i
=0;
›ti⁄s
->
ign‹e_unknown_›ti⁄
 &&

4509 
›ti⁄s
->
ign‹e_unknown_›ti⁄
[
i
]; i++)

4510 
ign‹e
[
i
]=
›ti⁄s
->
ign‹e_unknown_›ti⁄
[i];

4512 
›ti⁄s
->
ign‹e_unknown_›ti⁄
=
ign‹e
;

4514 
j
=1;
p
[j];j++)

4517 i‡(
p
[
j
][0]=='-' &&Ö[j][1]=='-')

4518 
›ti⁄s
->
ign‹e_unknown_›ti⁄
[
i
] = (
p
[
j
]+2);

4520 
›ti⁄s
->
ign‹e_unknown_›ti⁄
[
i
] = 
p
[
j
];

4521 
i
++;

4524 
›ti⁄s
->
ign‹e_unknown_›ti⁄
[
i
] = 
NULL
;

4526 i‡(
	`°ªq
 (
p
[0], "remote-ip-hint") &&Ö[1])

4528 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4529 
›ti⁄s
->
ªmŸe_ù_höt
 = 
p
[1];

4531 #i‡
HTTP_PROXY_OVERRIDE


4532 i‡(
	`°ªq
 (
p
[0], "http-proxy-override") &&Ö[1] &&Ö[2])

4534 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4535 
›ti⁄s
->
hâp_¥oxy_ovîride
 = 
	`∑r£_hâp_¥oxy_ovîride
(
p
[1],Ö[2],Ö[3], 
msgÀvñ
, &›ti⁄s->
gc
);

4536 i‡(!
›ti⁄s
->
hâp_¥oxy_ovîride
)

4537 
îr
;

4538 
›ti⁄s
->
f‹˚_c⁄√˘i⁄_li°
 = 
åue
;

4541 i‡(
	`°ªq
 (
p
[0], "remote") &&Ö[1])

4543 
ªmŸe_íåy
 
ª
;

4544 
ª
.
ªmŸe
 = 
NULL
;

4545 
ª
.
ªmŸe_p‹t
 =Ñe.
¥Ÿo
 = -1;

4547 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

4548 
ª
.
ªmŸe
 = 
p
[1];

4549 i‡(
p
[2])

4551 c⁄° 
p‹t
 = 
	`©oi
 (
p
[2]);

4552 i‡(!
	`ÀgÆ_ùv4_p‹t
 (
p‹t
))

4554 
	`msg
 (
msgÀvñ
, "ªmŸe:Ö‹ànumbîássocüãd wôh ho° %†i†ouào‡ønge", 
p
[1]);

4555 
îr
;

4557 
ª
.
ªmŸe_p‹t
 = 
p‹t
;

4558 i‡(
p
[3])

4560 c⁄° 
¥Ÿo
 = 
	`ascii2¥Ÿo
 (
p
[3]);

4561 i‡(
¥Ÿo
 < 0)

4563 
	`msg
 (
msgÀvñ
, "ªmŸe: badÖrŸocﬁássocüãd wôh ho° %s: '%s'", 
p
[1],Ö[3]);

4564 
îr
;

4566 
ª
.
¥Ÿo
 =Öroto;

4569 i‡(
≥rmissi⁄_mask
 & 
OPT_P_GENERAL
)

4571 
ªmŸe_íåy
 *
e
 = 
	`Æloc_ªmŸe_íåy
 (
›ti⁄s
, 
msgÀvñ
);

4572 i‡(!
e
)

4573 
îr
;

4574 *
e
 = 
ª
;

4576 i‡(
≥rmissi⁄_mask
 & 
OPT_P_CONNECTION
)

4578 
	`c⁄√˘i⁄_íåy_lﬂd_ª
 (&
›ti⁄s
->
˚
, &
ª
);

4581 i‡(
	`°ªq
 (
p
[0], "resolv-retry") &&Ö[1])

4583 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4584 i‡(
	`°ªq
 (
p
[1], "infinite"))

4585 
›ti⁄s
->
ªsﬁve_ªåy_£c⁄ds
 = 
RESOLV_RETRY_INFINITE
;

4587 
›ti⁄s
->
ªsﬁve_ªåy_£c⁄ds
 = 
	`posôive_©oi
 (
p
[1]);

4589 i‡(
	`°ªq
 (
p
[0], "connect-retry") &&Ö[1])

4591 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

4592 
›ti⁄s
->
˚
.
c⁄√˘_ªåy_£c⁄ds
 = 
	`posôive_©oi
 (
p
[1]);

4593 
›ti⁄s
->
˚
.
c⁄√˘_ªåy_deföed
 = 
åue
;

4595 i‡(
	`°ªq
 (
p
[0], "connect-timeout") &&Ö[1])

4597 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

4598 
›ti⁄s
->
˚
.
c⁄√˘_timeout
 = 
	`posôive_©oi
 (
p
[1]);

4599 
›ti⁄s
->
˚
.
c⁄√˘_timeout_deföed
 = 
åue
;

4601 i‡(
	`°ªq
 (
p
[0], "connect-retry-max") &&Ö[1])

4603 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

4604 
›ti⁄s
->
˚
.
c⁄√˘_ªåy_max
 = 
	`posôive_©oi
 (
p
[1]);

4606 i‡(
	`°ªq
 (
p
[0], "ipchange") &&Ö[1])

4608 
	`VERIFY_PERMISSION
 (
OPT_P_SCRIPT
);

4609 i‡(!
	`no_m‹e_th™_n_¨gs
 (
msgÀvñ
, 
p
, 2, 
NM_QUOTE_HINT
))

4610 
îr
;

4611 
	`£t_u£r_s¸ùt
 (
›ti⁄s
,

4612 &
›ti⁄s
->
ùch™ge
,

4613 
	`°rög_sub°ôuã
 (
p
[1], ',', ' ', &
›ti⁄s
->
gc
),

4614 "ùch™ge", 
åue
);

4616 i‡(
	`°ªq
 (
p
[0], "float"))

4618 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

4619 
›ti⁄s
->
˚
.
ªmŸe_Êﬂt
 = 
åue
;

4621 #ifde‡
ENABLE_DEBUG


4622 i‡(
	`°ªq
 (
p
[0], "gremlin") &&Ö[1])

4624 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4625 
›ti⁄s
->
gªmlö
 = 
	`posôive_©oi
 (
p
[1]);

4628 i‡(
	`°ªq
 (
p
[0], "chroot") &&Ö[1])

4630 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4631 
›ti⁄s
->
chroŸ_dú
 = 
p
[1];

4633 i‡(
	`°ªq
 (
p
[0], "cd") &&Ö[1])

4635 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4636 i‡(
	`∂©f‹m_chdú
 (
p
[1]))

4638 
	`msg
 (
M_ERR
, "cdÅÿ'%s' faûed", 
p
[1]);

4639 
îr
;

4641 
›ti⁄s
->
cd_dú
 = 
p
[1];

4643 #ifde‡
ENABLE_SELINUX


4644 i‡(
	`°ªq
 (
p
[0], "setcon") &&Ö[1])

4646 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4647 
›ti⁄s
->
£löux_c⁄ãxt
 = 
p
[1];

4650 i‡(
	`°ªq
 (
p
[0], "writepid") &&Ö[1])

4652 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4653 
›ti⁄s
->
wrôïid
 = 
p
[1];

4655 i‡(
	`°ªq
 (
p
[0], "up") &&Ö[1])

4657 
	`VERIFY_PERMISSION
 (
OPT_P_SCRIPT
);

4658 i‡(!
	`no_m‹e_th™_n_¨gs
 (
msgÀvñ
, 
p
, 2, 
NM_QUOTE_HINT
))

4659 
îr
;

4660 
	`£t_u£r_s¸ùt
 (
›ti⁄s
, &›ti⁄s->
up_s¸ùt
, 
p
[1], "up", 
Ál£
);

4662 i‡(
	`°ªq
 (
p
[0], "down") &&Ö[1])

4664 
	`VERIFY_PERMISSION
 (
OPT_P_SCRIPT
);

4665 i‡(!
	`no_m‹e_th™_n_¨gs
 (
msgÀvñ
, 
p
, 2, 
NM_QUOTE_HINT
))

4666 
îr
;

4667 
	`£t_u£r_s¸ùt
 (
›ti⁄s
, &›ti⁄s->
down_s¸ùt
, 
p
[1], "down", 
åue
);

4669 i‡(
	`°ªq
 (
p
[0], "down-pre"))

4671 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4672 
›ti⁄s
->
down_¥e
 = 
åue
;

4674 i‡(
	`°ªq
 (
p
[0], "up-delay"))

4676 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4677 
›ti⁄s
->
up_dñay
 = 
åue
;

4679 i‡(
	`°ªq
 (
p
[0], "up-restart"))

4681 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4682 
›ti⁄s
->
up_ª°¨t
 = 
åue
;

4684 i‡(
	`°ªq
 (
p
[0], "syslog"))

4686 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4687 
	`›í_sy¶og
 (
p
[1], 
Ál£
);

4689 i‡(
	`°ªq
 (
p
[0], "daemon"))

4691 
boﬁ
 
didô
 = 
Ál£
;

4692 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4693 i‡(!
›ti⁄s
->
d´m⁄
)

4695 
›ti⁄s
->
d´m⁄
 = 
didô
 = 
åue
;

4696 
	`›í_sy¶og
 (
p
[1], 
Ál£
);

4698 i‡(
p
[1])

4700 i‡(!
didô
)

4702 
	`msg
 (
M_WARN
, "WARNING: Mu…ùÀ --d´m⁄ dúe˘ive†•ecifõd, ign‹ög --d´m⁄ %s. (NŸêth© inôs¸ùt†somëime†addÅheú ow¿--d´m⁄ dúe˘ive.)", 
p
[1]);

4703 
îr
;

4707 i‡(
	`°ªq
 (
p
[0], "inetd"))

4709 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4710 i‡(!
›ti⁄s
->
öëd
)

4712 
z
;

4713 c⁄° *
«me
 = 
NULL
;

4714 c⁄° *
›ãº
 = "when --inetd is used withÅwoÖarameters, one ofÅhem must be 'wait' or 'nowait'ándÅhe other must beá daemonÇameÅo use for systemÜogging";

4716 
›ti⁄s
->
öëd
 = -1;

4718 
z
 = 1; z <= 2; ++z)

4720 i‡(
p
[
z
])

4722 i‡(
	`°ªq
 (
p
[
z
], "wait"))

4724 i‡(
›ti⁄s
->
öëd
 != -1)

4726 
	`msg
 (
msgÀvñ
, "%s", 
›ãº
);

4727 
îr
;

4730 
›ti⁄s
->
öëd
 = 
INETD_WAIT
;

4732 i‡(
	`°ªq
 (
p
[
z
], "nowait"))

4734 i‡(
›ti⁄s
->
öëd
 != -1)

4736 
	`msg
 (
msgÀvñ
, "%s", 
›ãº
);

4737 
îr
;

4740 
›ti⁄s
->
öëd
 = 
INETD_NOWAIT
;

4744 i‡(
«me
 !
NULL
)

4746 
	`msg
 (
msgÀvñ
, "%s", 
›ãº
);

4747 
îr
;

4749 
«me
 = 
p
[
z
];

4755 i‡(
›ti⁄s
->
öëd
 == -1)

4756 
›ti⁄s
->
öëd
 = 
INETD_WAIT
;

4758 
	`ßve_öëd_sockë_des¸ùt‹
 ();

4759 
	`›í_sy¶og
 (
«me
, 
åue
);

4762 i‡(
	`°ªq
 (
p
[0], "log") &&Ö[1])

4764 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4765 
›ti⁄s
->
log
 = 
åue
;

4766 
	`ªdúe˘_°dout_°dîr
 (
p
[1], 
Ál£
);

4768 i‡(
	`°ªq
 (
p
[0], "suppress-timestamps"))

4770 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4771 
›ti⁄s
->
suµªss_time°amps
 = 
åue
;

4772 
	`£t_suµªss_time°amps
(
åue
);

4774 i‡(
	`°ªq
 (
p
[0], "log-append") &&Ö[1])

4776 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4777 
›ti⁄s
->
log
 = 
åue
;

4778 
	`ªdúe˘_°dout_°dîr
 (
p
[1], 
åue
);

4780 #ifde‡
ENABLE_MEMSTATS


4781 i‡(
	`°ªq
 (
p
[0], "memstats") &&Ö[1])

4783 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4784 
›ti⁄s
->
mem°©s_‚
 = 
p
[1];

4787 i‡(
	`°ªq
 (
p
[0], "mlock"))

4789 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4790 
›ti⁄s
->
mlock
 = 
åue
;

4792 #i‡
ENABLE_IP_PKTINFO


4793 i‡(
	`°ªq
 (
p
[0], "multihome"))

4795 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4796 
›ti⁄s
->
sockÊags
 |
SF_USE_IP_PKTINFO
;

4799 i‡(
	`°ªq
 (
p
[0], "verb") &&Ö[1])

4801 
	`VERIFY_PERMISSION
 (
OPT_P_MESSAGES
);

4802 
›ti⁄s
->
vîbosôy
 = 
	`posôive_©oi
 (
p
[1]);

4803 #i‡!
	`deföed
(
ENABLE_DEBUG
Ë&& !deföed(
ENABLE_SMALL
)

4805 i‡(
›ti⁄s
->
vîbosôy
 >= 7)

4806 
	`msg
 (
M_WARN
, "NOTE: debug verbosity (--verb %d) isÉnabled butÅhis buildÜacks debug support.",

4807 
›ti⁄s
->
vîbosôy
);

4810 i‡(
	`°ªq
 (
p
[0], "mute") &&Ö[1])

4812 
	`VERIFY_PERMISSION
 (
OPT_P_MESSAGES
);

4813 
›ti⁄s
->
muã
 = 
	`posôive_©oi
 (
p
[1]);

4815 i‡(
	`°ªq
 (
p
[0], "errors-to-stderr"))

4817 
	`VERIFY_PERMISSION
 (
OPT_P_MESSAGES
);

4818 
	`îr‹s_to_°dîr
();

4820 i‡(
	`°ªq
 (
p
[0], "status") &&Ö[1])

4822 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4823 
›ti⁄s
->
°©us_fûe
 = 
p
[1];

4824 i‡(
p
[2])

4826 
›ti⁄s
->
°©us_fûe_upd©e_‰eq
 = 
	`posôive_©oi
 (
p
[2]);

4829 i‡(
	`°ªq
 (
p
[0], "status-version") &&Ö[1])

4831 
vîsi⁄
;

4833 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4834 
vîsi⁄
 = 
	`©oi
 (
p
[1]);

4835 i‡(
vîsi⁄
 < 1 || version > 3)

4837 
	`msg
 (
msgÀvñ
, "--status-version must be 1Åo 3");

4838 
îr
;

4840 
›ti⁄s
->
°©us_fûe_vîsi⁄
 = 
vîsi⁄
;

4842 i‡(
	`°ªq
 (
p
[0], "remap-usr1") &&Ö[1])

4844 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4845 i‡(
	`°ªq
 (
p
[1], "SIGHUP"))

4846 
›ti⁄s
->
ªm≠_sigu§1
 = 
SIGHUP
;

4847 i‡(
	`°ªq
 (
p
[1], "SIGTERM"))

4848 
›ti⁄s
->
ªm≠_sigu§1
 = 
SIGTERM
;

4851 
	`msg
 (
msgÀvñ
, "--remap-usr1Öarm must be 'SIGHUP' or 'SIGTERM'");

4852 
îr
;

4855 i‡((
	`°ªq
 (
p
[0], "link-mtu") || streq (p[0], "udp-mtu")) &&Ö[1])

4857 
	`VERIFY_PERMISSION
 (
OPT_P_MTU
|
OPT_P_CONNECTION
);

4858 
›ti⁄s
->
˚
.
lök_mtu
 = 
	`posôive_©oi
 (
p
[1]);

4859 
›ti⁄s
->
˚
.
lök_mtu_deföed
 = 
åue
;

4861 i‡(
	`°ªq
 (
p
[0], "tun-mtu") &&Ö[1])

4863 
	`VERIFY_PERMISSION
 (
OPT_P_MTU
|
OPT_P_CONNECTION
);

4864 
›ti⁄s
->
˚
.
tun_mtu
 = 
	`posôive_©oi
 (
p
[1]);

4865 
›ti⁄s
->
˚
.
tun_mtu_deföed
 = 
åue
;

4867 i‡(
	`°ªq
 (
p
[0], "tun-mtu-extra") &&Ö[1])

4869 
	`VERIFY_PERMISSION
 (
OPT_P_MTU
|
OPT_P_CONNECTION
);

4870 
›ti⁄s
->
˚
.
tun_mtu_exåa
 = 
	`posôive_©oi
 (
p
[1]);

4871 
›ti⁄s
->
˚
.
tun_mtu_exåa_deföed
 = 
åue
;

4873 #ifde‡
ENABLE_FRAGMENT


4874 i‡(
	`°ªq
 (
p
[0], "mtu-dynamic"))

4876 
	`VERIFY_PERMISSION
 (
OPT_P_MTU
|
OPT_P_CONNECTION
);

4877 
	`msg
 (
msgÀvñ
, "--mtu-dynamic has beenÑeplaced by --fragment");

4878 
îr
;

4880 i‡(
	`°ªq
 (
p
[0], "fragment") &&Ö[1])

4883 
	`VERIFY_PERMISSION
 (
OPT_P_MTU
|
OPT_P_CONNECTION
);

4884 
›ti⁄s
->
˚
.
‰agmít
 = 
	`posôive_©oi
 (
p
[1]);

4887 i‡(
	`°ªq
 (
p
[0], "mtu-disc") &&Ö[1])

4889 
	`VERIFY_PERMISSION
 (
OPT_P_MTU
|
OPT_P_CONNECTION
);

4890 
›ti⁄s
->
˚
.
mtu_discovî_ty≥
 = 
	`å™¶©e_mtu_discovî_ty≥_«me
 (
p
[1]);

4892 #ifde‡
ENABLE_OCC


4893 i‡(
	`°ªq
 (
p
[0], "mtu-test"))

4895 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4896 
›ti⁄s
->
mtu_ã°
 = 
åue
;

4899 i‡(
	`°ªq
 (
p
[0], "nice") &&Ö[1])

4901 
	`VERIFY_PERMISSION
 (
OPT_P_NICE
);

4902 
›ti⁄s
->
ni˚
 = 
	`©oi
 (
p
[1]);

4904 i‡(
	`°ªq
 (
p
[0], "rcvbuf") &&Ö[1])

4906 
	`VERIFY_PERMISSION
 (
OPT_P_SOCKBUF
);

4907 
›ti⁄s
->
rcvbuf
 = 
	`posôive_©oi
 (
p
[1]);

4909 i‡(
	`°ªq
 (
p
[0], "sndbuf") &&Ö[1])

4911 
	`VERIFY_PERMISSION
 (
OPT_P_SOCKBUF
);

4912 
›ti⁄s
->
¢dbuf
 = 
	`posôive_©oi
 (
p
[1]);

4914 i‡(
	`°ªq
 (
p
[0], "mark") &&Ö[1])

4916 #i‡
	`deföed
(
TARGET_LINUX
Ë&& 
HAVE_DECL_SO_MARK


4917 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4918 
›ti⁄s
->
m¨k
 = 
	`©oi
(
p
[1]);

4921 i‡(
	`°ªq
 (
p
[0], "socket-flags"))

4923 
j
;

4924 
	`VERIFY_PERMISSION
 (
OPT_P_SOCKFLAGS
);

4925 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j]; ++j)

4927 i‡(
	`°ªq
 (
p
[
j
], "TCP_NODELAY"))

4928 
›ti⁄s
->
sockÊags
 |
SF_TCP_NODELAY
;

4930 
	`msg
 (
msgÀvñ
, "unknow¿sockë fœg: %s", 
p
[
j
]);

4933 i‡(
	`°ªq
 (
p
[0], "txqueuelen") &&Ö[1])

4935 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4936 #ifde‡
TARGET_LINUX


4937 
›ti⁄s
->
tu¡≠_›ti⁄s
.
txqueuñí
 = 
	`posôive_©oi
 (
p
[1]);

4939 
	`msg
 (
msgÀvñ
, "--txqueuelenÇot supported onÅhis OS");

4940 
îr
;

4943 i‡(
	`°ªq
 (
p
[0], "shaper") &&Ö[1])

4945 #ifde‡
ENABLE_FEATURE_SHAPER


4946 
sh≠î
;

4948 
	`VERIFY_PERMISSION
 (
OPT_P_SHAPER
);

4949 
sh≠î
 = 
	`©oi
 (
p
[1]);

4950 i‡(
sh≠î
 < 
SHAPER_MIN
 || sh≠î > 
SHAPER_MAX
)

4952 
	`msg
 (
msgÀvñ
, "Bad shaper value, must be between %dánd %d",

4953 
SHAPER_MIN
, 
SHAPER_MAX
);

4954 
îr
;

4956 
›ti⁄s
->
sh≠î
 = shaper;

4958 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

4959 
	`msg
 (
msgÀvñ
, "--shaperÑequiresÅhe gettimeofday() function which is missing");

4960 
îr
;

4963 i‡(
	`°ªq
 (
p
[0], "port") &&Ö[1])

4965 
p‹t
;

4967 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

4968 
p‹t
 = 
	`©oi
 (
p
[1]);

4969 i‡(!
	`ÀgÆ_ùv4_p‹t
 (
p‹t
))

4971 
	`msg
 (
msgÀvñ
, "BadÖ‹ànumbî: %s", 
p
[1]);

4972 
îr
;

4974 
›ti⁄s
->
˚
.
loˇl_p‹t
 = o±i⁄s->˚.
ªmŸe_p‹t
 = 
p‹t
;

4976 i‡(
	`°ªq
 (
p
[0], "lport") &&Ö[1])

4978 
p‹t
;

4980 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

4981 
p‹t
 = 
	`©oi
 (
p
[1]);

4982 i‡((
p‹t
 !0Ë&& !
	`ÀgÆ_ùv4_p‹t
 (port))

4984 
	`msg
 (
msgÀvñ
, "BadÜoˇ»p‹ànumbî: %s", 
p
[1]);

4985 
îr
;

4987 
›ti⁄s
->
˚
.
loˇl_p‹t_deföed
 = 
åue
;

4988 
›ti⁄s
->
˚
.
loˇl_p‹t
 = 
p‹t
;

4990 i‡(
	`°ªq
 (
p
[0], "rport") &&Ö[1])

4992 
p‹t
;

4994 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

4995 
p‹t
 = 
	`©oi
 (
p
[1]);

4996 i‡(!
	`ÀgÆ_ùv4_p‹t
 (
p‹t
))

4998 
	`msg
 (
msgÀvñ
, "BadÑemŸêp‹ànumbî: %s", 
p
[1]);

4999 
îr
;

5001 
›ti⁄s
->
˚
.
ªmŸe_p‹t
 = 
p‹t
;

5003 i‡(
	`°ªq
 (
p
[0], "bind"))

5005 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5006 
›ti⁄s
->
˚
.
böd_deföed
 = 
åue
;

5008 i‡(
	`°ªq
 (
p
[0], "nobind"))

5010 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5011 
›ti⁄s
->
˚
.
böd_loˇl
 = 
Ál£
;

5013 i‡(
	`°ªq
 (
p
[0], "fast-io"))

5015 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5016 
›ti⁄s
->
Á°_io
 = 
åue
;

5018 i‡(
	`°ªq
 (
p
[0], "inactive") &&Ö[1])

5020 
	`VERIFY_PERMISSION
 (
OPT_P_TIMER
);

5021 
›ti⁄s
->
öa˘ivôy_timeout
 = 
	`posôive_©oi
 (
p
[1]);

5022 i‡(
p
[2])

5023 
›ti⁄s
->
öa˘ivôy_möimum_byãs
 = 
	`posôive_©oi
 (
p
[2]);

5025 i‡(
	`°ªq
 (
p
[0], "proto") &&Ö[1])

5027 
¥Ÿo
;

5028 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5029 
¥Ÿo
 = 
	`ascii2¥Ÿo
 (
p
[1]);

5030 i‡(
¥Ÿo
 < 0)

5032 
	`msg
 (
msgÀvñ
, "BadÖrotocol: '%s'. AllowedÖrotocols with --proto option: %s",

5033 
p
[1],

5034 
	`¥Ÿo2ascii_Æl
 (&
gc
));

5035 
îr
;

5037 
›ti⁄s
->
˚
.
¥Ÿo
 =Öroto;

5039 i‡(
	`°ªq
 (
p
[0], "proto-force") &&Ö[1])

5041 
¥Ÿo_f‹˚
;

5042 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5043 
¥Ÿo_f‹˚
 = 
	`ascii2¥Ÿo
 (
p
[1]);

5044 i‡(
¥Ÿo_f‹˚
 < 0)

5046 
	`msg
 (
msgÀvñ
, "Bad --¥Ÿo-f‹˚ÖrŸocﬁ: '%s'", 
p
[1]);

5047 
îr
;

5049 
›ti⁄s
->
¥Ÿo_f‹˚
 =Öroto_force;

5050 
›ti⁄s
->
f‹˚_c⁄√˘i⁄_li°
 = 
åue
;

5052 #ifde‡
ENABLE_HTTP_PROXY


5053 i‡(
	`°ªq
 (
p
[0], "http-proxy") &&Ö[1])

5055 
hâp_¥oxy_›ti⁄s
 *
ho
;

5057 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5060 
p‹t
;

5061 i‡(!
p
[2])

5063 
	`msg
 (
msgÀvñ
, "http-proxyÖortÇumberÇot defined");

5064 
îr
;

5066 
p‹t
 = 
	`©oi
 (
p
[2]);

5067 i‡(!
	`ÀgÆ_ùv4_p‹t
 (
p‹t
))

5069 
	`msg
 (
msgÀvñ
, "Bad hâp-¥oxyÖ‹ànumbî: %s", 
p
[2]);

5070 
îr
;

5073 
ho
 = 
	`öô_hâp_¥oxy_›ti⁄s_⁄˚
 (&
›ti⁄s
->
˚
.
hâp_¥oxy_›ti⁄s
, &›ti⁄s->
gc
);

5075 
ho
->
£rvî
 = 
p
[1];

5076 
ho
->
p‹t
 =Öort;

5079 i‡(
p
[3])

5084 i‡(
	`°ªq
 (
p
[3], "auto"))

5085 
ho
->
auth_ªåy
 = 
PAR_ALL
;

5086 i‡(
	`°ªq
 (
p
[3], "auto-nct"))

5087 
ho
->
auth_ªåy
 = 
PAR_NCT
;

5090 
ho
->
auth_mëhod_°rög
 = "basic";

5091 
ho
->
auth_fûe
 = 
p
[3];

5093 i‡(
p
[4])

5095 
ho
->
auth_mëhod_°rög
 = 
p
[4];

5101 
ho
->
auth_mëhod_°rög
 = "none";

5104 i‡(
	`°ªq
 (
p
[0], "http-proxy-retry"))

5106 
hâp_¥oxy_›ti⁄s
 *
ho
;

5107 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5108 
ho
 = 
	`öô_hâp_¥oxy_›ti⁄s_⁄˚
 (&
›ti⁄s
->
˚
.
hâp_¥oxy_›ti⁄s
, &›ti⁄s->
gc
);

5109 
ho
->
ªåy
 = 
åue
;

5111 i‡(
	`°ªq
 (
p
[0], "http-proxy-timeout") &&Ö[1])

5113 
hâp_¥oxy_›ti⁄s
 *
ho
;

5115 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5116 
ho
 = 
	`öô_hâp_¥oxy_›ti⁄s_⁄˚
 (&
›ti⁄s
->
˚
.
hâp_¥oxy_›ti⁄s
, &›ti⁄s->
gc
);

5117 
ho
->
timeout
 = 
	`posôive_©oi
 (
p
[1]);

5119 i‡(
	`°ªq
 (
p
[0], "http-proxy-option") &&Ö[1])

5121 
hâp_¥oxy_›ti⁄s
 *
ho
;

5123 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5124 
ho
 = 
	`öô_hâp_¥oxy_›ti⁄s_⁄˚
 (&
›ti⁄s
->
˚
.
hâp_¥oxy_›ti⁄s
, &›ti⁄s->
gc
);

5126 i‡(
	`°ªq
 (
p
[1], "VERSION") &&Ö[2])

5128 
ho
->
hâp_vîsi⁄
 = 
p
[2];

5130 i‡(
	`°ªq
 (
p
[1], "AGENT") &&Ö[2])

5132 
ho
->
u£r_agít
 = 
p
[2];

5136 
	`msg
 (
msgÀvñ
, "Bad hâp-¥oxy-›ti⁄ o∏missögÖ¨amëî: '%s'", 
p
[1]);

5140 #ifde‡
ENABLE_SOCKS


5141 i‡(
	`°ªq
 (
p
[0], "socks-proxy") &&Ö[1])

5143 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5145 i‡(
p
[2])

5147 
p‹t
;

5148 
p‹t
 = 
	`©oi
 (
p
[2]);

5149 i‡(!
	`ÀgÆ_ùv4_p‹t
 (
p‹t
))

5151 
	`msg
 (
msgÀvñ
, "Bad socks-¥oxyÖ‹ànumbî: %s", 
p
[2]);

5152 
îr
;

5154 
›ti⁄s
->
˚
.
socks_¥oxy_p‹t
 = 
p‹t
;

5158 
›ti⁄s
->
˚
.
socks_¥oxy_p‹t
 = 1080;

5160 
›ti⁄s
->
˚
.
socks_¥oxy_£rvî
 = 
p
[1];

5161 
›ti⁄s
->
˚
.
socks_¥oxy_authfûe
 = 
p
[3];

5163 i‡(
	`°ªq
 (
p
[0], "socks-proxy-retry"))

5165 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5166 
›ti⁄s
->
˚
.
socks_¥oxy_ªåy
 = 
åue
;

5169 i‡(
	`°ªq
 (
p
[0], "keepalive") &&Ö[1] &&Ö[2])

5171 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5172 
›ti⁄s
->
kì∑live_pög
 = 
	`©oi
 (
p
[1]);

5173 
›ti⁄s
->
kì∑live_timeout
 = 
	`©oi
 (
p
[2]);

5175 i‡(
	`°ªq
 (
p
[0], "ping") &&Ö[1])

5177 
	`VERIFY_PERMISSION
 (
OPT_P_TIMER
);

5178 
›ti⁄s
->
pög_£nd_timeout
 = 
	`posôive_©oi
 (
p
[1]);

5180 i‡(
	`°ªq
 (
p
[0], "ping-exit") &&Ö[1])

5182 
	`VERIFY_PERMISSION
 (
OPT_P_TIMER
);

5183 
›ti⁄s
->
pög_ªc_timeout
 = 
	`posôive_©oi
 (
p
[1]);

5184 
›ti⁄s
->
pög_ªc_timeout_a˘i⁄
 = 
PING_EXIT
;

5186 i‡(
	`°ªq
 (
p
[0], "ping-restart") &&Ö[1])

5188 
	`VERIFY_PERMISSION
 (
OPT_P_TIMER
);

5189 
›ti⁄s
->
pög_ªc_timeout
 = 
	`posôive_©oi
 (
p
[1]);

5190 
›ti⁄s
->
pög_ªc_timeout_a˘i⁄
 = 
PING_RESTART
;

5192 i‡(
	`°ªq
 (
p
[0], "ping-timer-rem"))

5194 
	`VERIFY_PERMISSION
 (
OPT_P_TIMER
);

5195 
›ti⁄s
->
pög_timî_ªmŸe
 = 
åue
;

5197 #ifde‡
ENABLE_OCC


5198 i‡(
	`°ªq
 (
p
[0], "explicit-exit-notify"))

5200 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
|
OPT_P_EXPLICIT_NOTIFY
);

5201 i‡(
p
[1])

5203 
›ti⁄s
->
˚
.
ex∂icô_exô_nŸifiˇti⁄
 = 
	`posôive_©oi
 (
p
[1]);

5207 
›ti⁄s
->
˚
.
ex∂icô_exô_nŸifiˇti⁄
 = 1;

5211 i‡(
	`°ªq
 (
p
[0], "persist-tun"))

5213 
	`VERIFY_PERMISSION
 (
OPT_P_PERSIST
);

5214 
›ti⁄s
->
≥rsi°_tun
 = 
åue
;

5216 i‡(
	`°ªq
 (
p
[0], "persist-key"))

5218 
	`VERIFY_PERMISSION
 (
OPT_P_PERSIST
);

5219 
›ti⁄s
->
≥rsi°_key
 = 
åue
;

5221 i‡(
	`°ªq
 (
p
[0], "persist-local-ip"))

5223 
	`VERIFY_PERMISSION
 (
OPT_P_PERSIST_IP
);

5224 
›ti⁄s
->
≥rsi°_loˇl_ù
 = 
åue
;

5226 i‡(
	`°ªq
 (
p
[0], "persist-remote-ip"))

5228 
	`VERIFY_PERMISSION
 (
OPT_P_PERSIST_IP
);

5229 
›ti⁄s
->
≥rsi°_ªmŸe_ù
 = 
åue
;

5231 #ifde‡
ENABLE_CLIENT_NAT


5232 i‡(
	`°ªq
 (
p
[0], "client-nat") &&Ö[1] &&Ö[2] &&Ö[3] &&Ö[4])

5234 
	`VERIFY_PERMISSION
 (
OPT_P_ROUTE
);

5235 
	`˙ﬁ_check_Æloc
 (
›ti⁄s
);

5236 
	`add_˛õ¡_«t_to_›ti⁄_li°
(
›ti⁄s
->
˛õ¡_«t
, 
p
[1],Ö[2],Ö[3],Ö[4], 
msgÀvñ
);

5239 i‡(
	`°ªq
 (
p
[0], "route") &&Ö[1])

5241 
	`VERIFY_PERMISSION
 (
OPT_P_ROUTE
);

5242 
	`rﬁ_check_Æloc
 (
›ti⁄s
);

5243 i‡(
puŒ_mode
)

5245 i‡(!
	`ù_‹_dns_addr_ß„
 (
p
[1], 
›ti⁄s
->
Ælow_puŒ_fqdn
Ë&& !
	`is_•ecül_addr
 (p[1]))

5247 
	`msg
 (
msgÀvñ
, "rouãÖ¨amëîÇëw‹k/IP '%s' mu° bê®vÆidáddªss", 
p
[1]);

5248 
îr
;

5250 i‡(
p
[2] && !
	`ù_addr_dŸãd_quad_ß„
 (p[2]))

5252 
	`msg
 (
msgÀvñ
, "rouãÖ¨amëîÇëmask '%s' mu° bê™ IPáddªss", 
p
[2]);

5253 
îr
;

5255 i‡(
p
[3] && !
	`ù_‹_dns_addr_ß„
 (p[3], 
›ti⁄s
->
Ælow_puŒ_fqdn
Ë&& !
	`is_•ecül_addr
 (p[3]))

5257 
	`msg
 (
msgÀvñ
, "rouãÖ¨amëî g©eway '%s' mu° bê®vÆidáddªss", 
p
[3]);

5258 
îr
;

5261 
	`add_rouã_to_›ti⁄_li°
 (
›ti⁄s
->
rouãs
, 
p
[1],Ö[2],Ö[3],Ö[4]);

5263 i‡(
	`°ªq
 (
p
[0], "route-ipv6") &&Ö[1])

5265 
	`VERIFY_PERMISSION
 (
OPT_P_ROUTE
);

5266 
	`rﬁ6_check_Æloc
 (
›ti⁄s
);

5267 i‡(
puŒ_mode
)

5269 i‡(!
	`ùv6_addr_ß„_hex∂usbôs
 (
p
[1]))

5271 
	`msg
 (
msgÀvñ
, "rouã-ùv6Ö¨amëîÇëw‹k/IP '%s' mu° bê®vÆidáddªss", 
p
[1]);

5272 
îr
;

5274 i‡(
p
[2] && !
	`ùv6_addr_ß„
 (p[2]))

5276 
	`msg
 (
msgÀvñ
, "rouã-ùv6Ö¨amëî g©eway '%s' mu° bê®vÆidáddªss", 
p
[2]);

5277 
îr
;

5281 
	`add_rouã_ùv6_to_›ti⁄_li°
 (
›ti⁄s
->
rouãs_ùv6
, 
p
[1],Ö[2],Ö[3]);

5283 i‡(
	`°ªq
 (
p
[0], "max-routes") &&Ö[1])

5285 
max_rouãs
;

5287 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5288 
max_rouãs
 = 
	`©oi
 (
p
[1]);

5289 i‡(
max_rouãs
 < 0 || max_routes > 100000000)

5291 
	`msg
 (
msgÀvñ
, "--max-routesÖarameter is out ofÑange");

5292 
îr
;

5294 i‡(
›ti⁄s
->
rouãs
 || o±i⁄s->
rouãs_ùv6
)

5296 
	`msg
 (
msgÀvñ
, "--max-routes mustÅo be specifed beforeányÑoute/route-ipv6/redirect-gateway option");

5297 
îr
;

5299 
›ti⁄s
->
max_rouãs
 = max_routes;

5301 i‡(
	`°ªq
 (
p
[0], "route-gateway") &&Ö[1])

5303 
	`VERIFY_PERMISSION
 (
OPT_P_ROUTE_EXTRAS
);

5304 i‡(
	`°ªq
 (
p
[1], "dhcp"))

5306 
›ti⁄s
->
rouã_g©eway_vü_dh˝
 = 
åue
;

5310 i‡(
	`ù_‹_dns_addr_ß„
 (
p
[1], 
›ti⁄s
->
Ælow_puŒ_fqdn
Ë|| 
	`is_•ecül_addr
 (p[1]))

5312 
›ti⁄s
->
rouã_deÁu…_g©eway
 = 
p
[1];

5316 
	`msg
 (
msgÀvñ
, "rouã-g©ewayÖ¨m '%s' mu° bê®vÆidáddªss", 
p
[1]);

5317 
îr
;

5321 i‡(
	`°ªq
 (
p
[0], "route-metric") &&Ö[1])

5323 
	`VERIFY_PERMISSION
 (
OPT_P_ROUTE
);

5324 
›ti⁄s
->
rouã_deÁu…_mëric
 = 
	`posôive_©oi
 (
p
[1]);

5326 i‡(
	`°ªq
 (
p
[0], "route-delay"))

5328 
	`VERIFY_PERMISSION
 (
OPT_P_ROUTE_EXTRAS
);

5329 
›ti⁄s
->
rouã_dñay_deföed
 = 
åue
;

5330 i‡(
p
[1])

5332 
›ti⁄s
->
rouã_dñay
 = 
	`posôive_©oi
 (
p
[1]);

5333 i‡(
p
[2])

5335 
›ti⁄s
->
rouã_dñay_wödow
 = 
	`posôive_©oi
 (
p
[2]);

5340 
›ti⁄s
->
rouã_dñay
 = 0;

5343 i‡(
	`°ªq
 (
p
[0], "route-up") &&Ö[1])

5345 
	`VERIFY_PERMISSION
 (
OPT_P_SCRIPT
);

5346 i‡(!
	`no_m‹e_th™_n_¨gs
 (
msgÀvñ
, 
p
, 2, 
NM_QUOTE_HINT
))

5347 
îr
;

5348 
	`£t_u£r_s¸ùt
 (
›ti⁄s
, &›ti⁄s->
rouã_s¸ùt
, 
p
[1], "rouã-up", 
Ál£
);

5350 i‡(
	`°ªq
 (
p
[0], "route-pre-down") &&Ö[1])

5352 
	`VERIFY_PERMISSION
 (
OPT_P_SCRIPT
);

5353 i‡(!
	`no_m‹e_th™_n_¨gs
 (
msgÀvñ
, 
p
, 2, 
NM_QUOTE_HINT
))

5354 
îr
;

5355 
	`£t_u£r_s¸ùt
 (
›ti⁄s
,

5356 &
›ti⁄s
->
rouã_¥edown_s¸ùt
,

5357 
p
[1],

5358 "rouã-¥e-down", 
åue
);

5360 i‡(
	`°ªq
 (
p
[0], "route-noexec"))

5362 
	`VERIFY_PERMISSION
 (
OPT_P_SCRIPT
);

5363 
›ti⁄s
->
rouã_n€xec
 = 
åue
;

5365 i‡(
	`°ªq
 (
p
[0], "route-nopull"))

5367 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5368 
›ti⁄s
->
rouã_n›uŒ
 = 
åue
;

5370 i‡(
	`°ªq
 (
p
[0], "allow-pull-fqdn"))

5372 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5373 
›ti⁄s
->
Ælow_puŒ_fqdn
 = 
åue
;

5375 i‡(
	`°ªq
 (
p
[0], "redirect-gateway") || streq (p[0], "redirect-private"))

5377 
j
;

5378 
	`VERIFY_PERMISSION
 (
OPT_P_ROUTE
);

5379 
	`rﬁ_check_Æloc
 (
›ti⁄s
);

5380 i‡(
	`°ªq
 (
p
[0], "redirect-gateway"))

5381 
›ti⁄s
->
rouãs
->
Êags
 |
RG_REROUTE_GW
;

5382 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j] !
NULL
; ++j)

5384 i‡(
	`°ªq
 (
p
[
j
], "local"))

5385 
›ti⁄s
->
rouãs
->
Êags
 |
RG_LOCAL
;

5386 i‡(
	`°ªq
 (
p
[
j
], "autolocal"))

5387 
›ti⁄s
->
rouãs
->
Êags
 |
RG_AUTO_LOCAL
;

5388 i‡(
	`°ªq
 (
p
[
j
], "def1"))

5389 
›ti⁄s
->
rouãs
->
Êags
 |
RG_DEF1
;

5390 i‡(
	`°ªq
 (
p
[
j
], "bypass-dhcp"))

5391 
›ti⁄s
->
rouãs
->
Êags
 |
RG_BYPASS_DHCP
;

5392 i‡(
	`°ªq
 (
p
[
j
], "bypass-dns"))

5393 
›ti⁄s
->
rouãs
->
Êags
 |
RG_BYPASS_DNS
;

5394 i‡(
	`°ªq
 (
p
[
j
], "block-local"))

5395 
›ti⁄s
->
rouãs
->
Êags
 |
RG_BLOCK_LOCAL
;

5398 
	`msg
 (
msgÀvñ
, "unknow¿--%†Êag: %s", 
p
[0],Ö[
j
]);

5399 
îr
;

5402 
›ti⁄s
->
rouãs
->
Êags
 |
RG_ENABLE
;

5404 i‡(
	`°ªq
 (
p
[0], "remote-random-hostname"))

5406 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5407 
›ti⁄s
->
sockÊags
 |
SF_HOST_RANDOMIZE
;

5409 i‡(
	`°ªq
 (
p
[0], "setenv") &&Ö[1])

5411 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5412 i‡(
	`°ªq
 (
p
[1], "REMOTE_RANDOM_HOSTNAME"))

5414 
›ti⁄s
->
sockÊags
 |
SF_HOST_RANDOMIZE
;

5416 i‡(
	`°ªq
 (
p
[1], "GENERIC_CONFIG"))

5418 
	`msg
 (
msgÀvñ
, "this isá generic configurationánd cannot directly be used");

5419 
îr
;

5421 #ifde‡
ENABLE_PUSH_PEER_INFO


5422 i‡(
	`°ªq
 (
p
[1], "PUSH_PEER_INFO"))

5424 
›ti⁄s
->
push_≥î_öfo
 = 
åue
;

5427 #i‡
P2MP


5428 i‡(
	`°ªq
 (
p
[1], "SERVER_POLL_TIMEOUT") &&Ö[2])

5430 
›ti⁄s
->
£rvî_pﬁl_timeout
 = 
	`posôive_©oi
(
p
[2]);

5435 i‡(
	`°ªq
 (
p
[1], "FORWARD_COMPATIBLE") &&Ö[2] && streq (p[2], "1"))

5437 
›ti⁄s
->
f‹w¨d_com∑tibÀ
 = 
åue
;

5438 
msgÀvñ_fc
 = 
	`msgÀvñ_f‹w¨d_com∑tibÀ
 (
›ti⁄s
, 
msgÀvñ
);

5440 
	`£ãnv_°r
 (
es
, 
p
[1],Ö[2] ?Ö[2] : "");

5443 i‡(
	`°ªq
 (
p
[0], "setenv-safe") &&Ö[1])

5445 
	`VERIFY_PERMISSION
 (
OPT_P_SETENV
);

5446 
	`£ãnv_°r_ß„
 (
es
, 
p
[1],Ö[2] ?Ö[2] : "");

5448 i‡(
	`°ªq
 (
p
[0], "script-security") &&Ö[1])

5450 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5451 
s¸ùt_£curôy
 = 
	`©oi
 (
p
[1]);

5453 i‡(
	`°ªq
 (
p
[0], "mssfix"))

5455 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5456 i‡(
p
[1])

5458 
›ti⁄s
->
˚
.
mssfix
 = 
	`posôive_©oi
 (
p
[1]);

5461 
›ti⁄s
->
˚
.
mssfix_deÁu…
 = 
åue
;

5464 #ifde‡
ENABLE_OCC


5465 i‡(
	`°ªq
 (
p
[0], "disable-occ"))

5467 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5468 
›ti⁄s
->
occ
 = 
Ál£
;

5471 #i‡
P2MP


5472 #i‡
P2MP_SERVER


5473 i‡(
	`°ªq
 (
p
[0], "server") &&Ö[1] &&Ö[2])

5475 c⁄° 
Àv
 = 
M_WARN
;

5476 
boﬁ
 
îr‹
 = 
Ál£
;

5477 
ö_addr_t
 
√tw‹k
, 
√tmask
;

5479 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5480 
√tw‹k
 = 
	`gë_ù_addr
 (
p
[1], 
Àv
, &
îr‹
);

5481 
√tmask
 = 
	`gë_ù_addr
 (
p
[2], 
Àv
, &
îr‹
);

5482 i‡(
îr‹
 || !
√tw‹k
 || !
√tmask
)

5484 
	`msg
 (
msgÀvñ
, "errorÖarsing --serverÖarameters");

5485 
îr
;

5487 
›ti⁄s
->
£rvî_deföed
 = 
åue
;

5488 
›ti⁄s
->
£rvî_√tw‹k
 = 
√tw‹k
;

5489 
›ti⁄s
->
£rvî_√tmask
 = 
√tmask
;

5491 i‡(
p
[3])

5493 i‡(
	`°ªq
 (
p
[3], "nopool"))

5494 
›ti⁄s
->
£rvî_Êags
 |
SF_NOPOOL
;

5497 
	`msg
 (
msgÀvñ
, "îr‹Ö¨sög --£rvî: %†i†nŸáÑecognized fœg", 
p
[3]);

5498 
îr
;

5502 i‡(
	`°ªq
 (
p
[0], "server-ipv6") &&Ö[1] )

5504 c⁄° 
Àv
 = 
M_WARN
;

5505 
ö6_addr
 
√tw‹k
;

5506 
√tbôs
 = 0;

5508 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5509 i‡–! 
	`gë_ùv6_addr
 (
p
[1], &
√tw‹k
, &
√tbôs
, 
NULL
, 
Àv
) )

5511 
	`msg
 (
msgÀvñ
, "errorÖarsing --server-ipv6Öarameter");

5512 
îr
;

5514 i‡–
√tbôs
 < 64 ||Çetbits > 112 )

5516 
	`msg
–
msgÀvñ
, "--£rvî-ùv6 sëtögs: o∆y /64../112 suµ‹ãdÑighànow (nŸ /%d)", 
√tbôs
 );

5517 
îr
;

5519 
›ti⁄s
->
£rvî_ùv6_deföed
 = 
åue
;

5520 
›ti⁄s
->
£rvî_√tw‹k_ùv6
 = 
√tw‹k
;

5521 
›ti⁄s
->
£rvî_√tbôs_ùv6
 = 
√tbôs
;

5523 i‡(
p
[2])

5525 
	`msg
 (
msgÀvñ
, "îr‹Ö¨sög --£rvî-ùv6: %†i†nŸáÑecognized fœg", 
p
[3]);

5526 
îr
;

5529 i‡(
	`°ªq
 (
p
[0], "server-bridge") &&Ö[1] &&Ö[2] &&Ö[3] &&Ö[4])

5531 c⁄° 
Àv
 = 
M_WARN
;

5532 
boﬁ
 
îr‹
 = 
Ál£
;

5533 
ö_addr_t
 
ù
, 
√tmask
, 
poﬁ_°¨t
, 
poﬁ_íd
;

5535 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5536 
ù
 = 
	`gë_ù_addr
 (
p
[1], 
Àv
, &
îr‹
);

5537 
√tmask
 = 
	`gë_ù_addr
 (
p
[2], 
Àv
, &
îr‹
);

5538 
poﬁ_°¨t
 = 
	`gë_ù_addr
 (
p
[3], 
Àv
, &
îr‹
);

5539 
poﬁ_íd
 = 
	`gë_ù_addr
 (
p
[4], 
Àv
, &
îr‹
);

5540 i‡(
îr‹
 || !
ù
 || !
√tmask
 || !
poﬁ_°¨t
 || !
poﬁ_íd
)

5542 
	`msg
 (
msgÀvñ
, "errorÖarsing --server-bridgeÖarameters");

5543 
îr
;

5545 
›ti⁄s
->
£rvî_bridge_deföed
 = 
åue
;

5546 
›ti⁄s
->
£rvî_bridge_ù
 = 
ù
;

5547 
›ti⁄s
->
£rvî_bridge_√tmask
 = 
√tmask
;

5548 
›ti⁄s
->
£rvî_bridge_poﬁ_°¨t
 = 
poﬁ_°¨t
;

5549 
›ti⁄s
->
£rvî_bridge_poﬁ_íd
 = 
poﬁ_íd
;

5551 i‡(
	`°ªq
 (
p
[0], "server-bridge") &&Ö[1] && streq (p[1], "nogw"))

5553 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5554 
›ti⁄s
->
£rvî_bridge_¥oxy_dh˝
 = 
åue
;

5555 
›ti⁄s
->
£rvî_Êags
 |
SF_NO_PUSH_ROUTE_GATEWAY
;

5557 i‡(
	`°ªq
 (
p
[0], "server-bridge") && !p[1])

5559 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5560 
›ti⁄s
->
£rvî_bridge_¥oxy_dh˝
 = 
åue
;

5562 i‡(
	`°ªq
 (
p
[0], "push") &&Ö[1])

5564 
	`VERIFY_PERMISSION
 (
OPT_P_PUSH
);

5565 
	`push_›ti⁄s
 (
›ti⁄s
, &
p
[1], 
msgÀvñ
, &›ti⁄s->
gc
);

5567 i‡(
	`°ªq
 (
p
[0], "push-reset"))

5569 
	`VERIFY_PERMISSION
 (
OPT_P_INSTANCE
);

5570 
	`push_ª£t
 (
›ti⁄s
);

5572 i‡(
	`°ªq
 (
p
[0], "ifconfig-pool") &&Ö[1] &&Ö[2])

5574 c⁄° 
Àv
 = 
M_WARN
;

5575 
boﬁ
 
îr‹
 = 
Ál£
;

5576 
ö_addr_t
 
°¨t
, 
íd
, 
√tmask
=0;

5578 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5579 
°¨t
 = 
	`gë_ù_addr
 (
p
[1], 
Àv
, &
îr‹
);

5580 
íd
 = 
	`gë_ù_addr
 (
p
[2], 
Àv
, &
îr‹
);

5581 i‡(
p
[3])

5583 
√tmask
 = 
	`gë_ù_addr
 (
p
[3], 
Àv
, &
îr‹
);

5585 i‡(
îr‹
)

5587 
	`msg
 (
msgÀvñ
, "errorÖarsing --ifconfig-poolÖarameters");

5588 
îr
;

5590 i‡(!
	`ifc⁄fig_poﬁ_vîify_ønge
 (
msgÀvñ
, 
°¨t
, 
íd
))

5591 
îr
;

5593 
›ti⁄s
->
ifc⁄fig_poﬁ_deföed
 = 
åue
;

5594 
›ti⁄s
->
ifc⁄fig_poﬁ_°¨t
 = 
°¨t
;

5595 
›ti⁄s
->
ifc⁄fig_poﬁ_íd
 = 
íd
;

5596 i‡(
√tmask
)

5597 
›ti⁄s
->
ifc⁄fig_poﬁ_√tmask
 = 
√tmask
;

5599 i‡(
	`°ªq
 (
p
[0], "ifconfig-pool-persist") &&Ö[1])

5601 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5602 
›ti⁄s
->
ifc⁄fig_poﬁ_≥rsi°_fûíame
 = 
p
[1];

5603 i‡(
p
[2])

5605 
›ti⁄s
->
ifc⁄fig_poﬁ_≥rsi°_ª‰esh_‰eq
 = 
	`posôive_©oi
 (
p
[2]);

5608 i‡(
	`°ªq
 (
p
[0], "ifconfig-pool-linear"))

5610 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5611 
›ti⁄s
->
t›ﬁogy
 = 
TOP_P2P
;

5613 i‡(
	`°ªq
 (
p
[0], "ifconfig-ipv6-pool") &&Ö[1] )

5615 c⁄° 
Àv
 = 
M_WARN
;

5616 
ö6_addr
 
√tw‹k
;

5617 
√tbôs
 = 0;

5619 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5620 i‡–! 
	`gë_ùv6_addr
 (
p
[1], &
√tw‹k
, &
√tbôs
, 
NULL
, 
Àv
 ) )

5622 
	`msg
 (
msgÀvñ
, "errorÖarsing --ifconfig-ipv6-poolÖarameters");

5623 
îr
;

5625 i‡–
√tbôs
 < 64 ||Çetbits > 112 )

5627 
	`msg
–
msgÀvñ
, "--ifc⁄fig-ùv6-poﬁ sëtögs: o∆y /64../112 suµ‹ãdÑighànow (nŸ /%d)", 
√tbôs
 );

5628 
îr
;

5631 
›ti⁄s
->
ifc⁄fig_ùv6_poﬁ_deföed
 = 
åue
;

5632 
›ti⁄s
->
ifc⁄fig_ùv6_poﬁ_ba£
 = 
√tw‹k
;

5633 
›ti⁄s
->
ifc⁄fig_ùv6_poﬁ_√tbôs
 = 
√tbôs
;

5635 i‡(
	`°ªq
 (
p
[0], "hash-size") &&Ö[1] &&Ö[2])

5637 
ªÆ
, 
vútuÆ
;

5639 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5640 
ªÆ
 = 
	`©oi
 (
p
[1]);

5641 
vútuÆ
 = 
	`©oi
 (
p
[2]);

5642 i‡(
ªÆ
 < 1 || 
vútuÆ
 < 1)

5644 
	`msg
 (
msgÀvñ
, "--hash-size sizes must be >= 1 (preferablyáÖower of 2)");

5645 
îr
;

5647 
›ti⁄s
->
ªÆ_hash_size
 = 
ªÆ
;

5648 
›ti⁄s
->
vútuÆ_hash_size
 = 
ªÆ
;

5650 i‡(
	`°ªq
 (
p
[0], "connect-freq") &&Ö[1] &&Ö[2])

5652 
cf_max
, 
cf_≥r
;

5654 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5655 
cf_max
 = 
	`©oi
 (
p
[1]);

5656 
cf_≥r
 = 
	`©oi
 (
p
[2]);

5657 i‡(
cf_max
 < 0 || 
cf_≥r
 < 0)

5659 
	`msg
 (
msgÀvñ
, "--connect-freqÖarms must be > 0");

5660 
îr
;

5662 
›ti⁄s
->
cf_max
 = cf_max;

5663 
›ti⁄s
->
cf_≥r
 = cf_per;

5665 i‡(
	`°ªq
 (
p
[0], "max-clients") &&Ö[1])

5667 
max_˛õ¡s
;

5669 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5670 
max_˛õ¡s
 = 
	`©oi
 (
p
[1]);

5671 i‡(
max_˛õ¡s
 < 0)

5673 
	`msg
 (
msgÀvñ
, "--max-clients must beátÜeast 1");

5674 
îr
;

5676 
›ti⁄s
->
max_˛õ¡s
 = max_clients;

5678 i‡(
	`°ªq
 (
p
[0], "max-routes-per-client") &&Ö[1])

5680 
	`VERIFY_PERMISSION
 (
OPT_P_INHERIT
);

5681 
›ti⁄s
->
max_rouãs_≥r_˛õ¡
 = 
	`max_öt
 (
	`©oi
 (
p
[1]), 1);

5683 i‡(
	`°ªq
 (
p
[0], "client-cert-not-required"))

5685 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5686 
›ti⁄s
->
s¶_Êags
 |
SSLF_CLIENT_CERT_NOT_REQUIRED
;

5688 i‡(
	`°ªq
 (
p
[0], "username-as-common-name"))

5690 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5691 
›ti⁄s
->
s¶_Êags
 |
SSLF_USERNAME_AS_COMMON_NAME
;

5693 i‡(
	`°ªq
 (
p
[0], "auth-user-pass-optional"))

5695 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5696 
›ti⁄s
->
s¶_Êags
 |
SSLF_AUTH_USER_PASS_OPTIONAL
;

5698 i‡(
	`°ªq
 (
p
[0], "opt-verify"))

5700 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5701 
›ti⁄s
->
s¶_Êags
 |
SSLF_OPT_VERIFY
;

5703 i‡(
	`°ªq
 (
p
[0], "auth-user-pass-verify") &&Ö[1])

5705 
	`VERIFY_PERMISSION
 (
OPT_P_SCRIPT
);

5706 i‡(!
	`no_m‹e_th™_n_¨gs
 (
msgÀvñ
, 
p
, 3, 
NM_QUOTE_HINT
))

5707 
îr
;

5708 i‡(
p
[2])

5710 i‡(
	`°ªq
 (
p
[2], "via-env"))

5711 
›ti⁄s
->
auth_u£r_∑ss_vîify_s¸ùt_vü_fûe
 = 
Ál£
;

5712 i‡(
	`°ªq
 (
p
[2], "via-file"))

5713 
›ti⁄s
->
auth_u£r_∑ss_vîify_s¸ùt_vü_fûe
 = 
åue
;

5716 
	`msg
 (
msgÀvñ
, "secondÖarmÅo --auth-user-pass-verify must be 'via-env' or 'via-file'");

5717 
îr
;

5722 
	`msg
 (
msgÀvñ
, "--auth-user-pass-verifyÑequiresá secondÖarameter ('via-env' or 'via-file')");

5723 
îr
;

5725 
	`£t_u£r_s¸ùt
 (
›ti⁄s
,

5726 &
›ti⁄s
->
auth_u£r_∑ss_vîify_s¸ùt
,

5727 
p
[1], "auth-u£r-∑ss-vîify", 
åue
);

5729 i‡(
	`°ªq
 (
p
[0], "client-connect") &&Ö[1])

5731 
	`VERIFY_PERMISSION
 (
OPT_P_SCRIPT
);

5732 i‡(!
	`no_m‹e_th™_n_¨gs
 (
msgÀvñ
, 
p
, 2, 
NM_QUOTE_HINT
))

5733 
îr
;

5734 
	`£t_u£r_s¸ùt
 (
›ti⁄s
, &›ti⁄s->
˛õ¡_c⁄√˘_s¸ùt
,

5735 
p
[1], "˛õ¡-c⁄√˘", 
åue
);

5737 i‡(
	`°ªq
 (
p
[0], "client-disconnect") &&Ö[1])

5739 
	`VERIFY_PERMISSION
 (
OPT_P_SCRIPT
);

5740 i‡(!
	`no_m‹e_th™_n_¨gs
 (
msgÀvñ
, 
p
, 2, 
NM_QUOTE_HINT
))

5741 
îr
;

5742 
	`£t_u£r_s¸ùt
 (
›ti⁄s
, &›ti⁄s->
˛õ¡_disc⁄√˘_s¸ùt
,

5743 
p
[1], "˛õ¡-disc⁄√˘", 
åue
);

5745 i‡(
	`°ªq
 (
p
[0], "learn-address") &&Ö[1])

5747 
	`VERIFY_PERMISSION
 (
OPT_P_SCRIPT
);

5748 i‡(!
	`no_m‹e_th™_n_¨gs
 (
msgÀvñ
, 
p
, 2, 
NM_QUOTE_HINT
))

5749 
îr
;

5750 
	`£t_u£r_s¸ùt
 (
›ti⁄s
, &›ti⁄s->
À¨n_addªss_s¸ùt
,

5751 
p
[1], "À¨n-addªss", 
åue
);

5753 i‡(
	`°ªq
 (
p
[0], "tmp-dir") &&Ö[1])

5755 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5756 
›ti⁄s
->
tmp_dú
 = 
p
[1];

5758 i‡(
	`°ªq
 (
p
[0], "client-config-dir") &&Ö[1])

5760 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5761 
›ti⁄s
->
˛õ¡_c⁄fig_dú
 = 
p
[1];

5763 i‡(
	`°ªq
 (
p
[0], "ccd-exclusive"))

5765 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5766 
›ti⁄s
->
ccd_ex˛usive
 = 
åue
;

5768 i‡(
	`°ªq
 (
p
[0], "bcast-buffers") &&Ö[1])

5770 
n_bˇ°_buf
;

5772 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5773 
n_bˇ°_buf
 = 
	`©oi
 (
p
[1]);

5774 i‡(
n_bˇ°_buf
 < 1)

5775 
	`msg
 (
msgÀvñ
, "--bcast-buffersÖarameter must be > 0");

5776 
›ti⁄s
->
n_bˇ°_buf
 =Ç_bcast_buf;

5778 i‡(
	`°ªq
 (
p
[0], "tcp-queue-limit") &&Ö[1])

5780 
t˝_queue_limô
;

5782 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5783 
t˝_queue_limô
 = 
	`©oi
 (
p
[1]);

5784 i‡(
t˝_queue_limô
 < 1)

5785 
	`msg
 (
msgÀvñ
, "--tcp-queue-limitÖarameter must be > 0");

5786 
›ti⁄s
->
t˝_queue_limô
 =Åcp_queue_limit;

5788 #i‡
PORT_SHARE


5789 i‡(
	`°ªq
 (
p
[0], "port-share") &&Ö[1] &&Ö[2])

5791 
p‹t
;

5793 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5794 
p‹t
 = 
	`©oi
 (
p
[2]);

5795 i‡(!
	`ÀgÆ_ùv4_p‹t
 (
p‹t
))

5797 
	`msg
 (
msgÀvñ
, "portÇumberássociated with --port-share directive is out ofÑange");

5798 
îr
;

5801 
›ti⁄s
->
p‹t_sh¨e_ho°
 = 
p
[1];

5802 
›ti⁄s
->
p‹t_sh¨e_p‹t
 = 
p‹t
;

5803 
›ti⁄s
->
p‹t_sh¨e_jou∫Æ_dú
 = 
p
[3];

5806 i‡(
	`°ªq
 (
p
[0], "client-to-client"))

5808 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5809 
›ti⁄s
->
íabÀ_c2c
 = 
åue
;

5811 i‡(
	`°ªq
 (
p
[0], "duplicate-cn"))

5813 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5814 
›ti⁄s
->
du∂iˇã_˙
 = 
åue
;

5816 i‡(
	`°ªq
 (
p
[0], "iroute") &&Ö[1])

5818 c⁄° *
√tmask
 = 
NULL
;

5820 
	`VERIFY_PERMISSION
 (
OPT_P_INSTANCE
);

5821 i‡(
p
[2])

5823 
√tmask
 = 
p
[2];

5825 
	`›ti⁄_úouã
 (
›ti⁄s
, 
p
[1], 
√tmask
, 
msgÀvñ
);

5827 i‡(
	`°ªq
 (
p
[0], "iroute-ipv6") &&Ö[1])

5829 
	`VERIFY_PERMISSION
 (
OPT_P_INSTANCE
);

5830 
	`›ti⁄_úouã_ùv6
 (
›ti⁄s
, 
p
[1], 
msgÀvñ
);

5832 i‡(
	`°ªq
 (
p
[0], "ifconfig-push") &&Ö[1] &&Ö[2])

5834 
ö_addr_t
 
loˇl
, 
ªmŸe_√tmask
;

5836 
	`VERIFY_PERMISSION
 (
OPT_P_INSTANCE
);

5837 
loˇl
 = 
	`gëaddr
 (
GETADDR_HOST_ORDER
|
GETADDR_RESOLVE
, 
p
[1], 0, 
NULL
, NULL);

5838 
ªmŸe_√tmask
 = 
	`gëaddr
 (
GETADDR_HOST_ORDER
|
GETADDR_RESOLVE
, 
p
[2], 0, 
NULL
, NULL);

5839 i‡(
loˇl
 && 
ªmŸe_√tmask
)

5841 
›ti⁄s
->
push_ifc⁄fig_deföed
 = 
åue
;

5842 
›ti⁄s
->
push_ifc⁄fig_loˇl
 = 
loˇl
;

5843 
›ti⁄s
->
push_ifc⁄fig_ªmŸe_√tmask
 = 
ªmŸe_√tmask
;

5844 #ifde‡
ENABLE_CLIENT_NAT


5845 i‡(
p
[3])

5846 
›ti⁄s
->
push_ifc⁄fig_loˇl_Æüs
 = 
	`gëaddr
 (
GETADDR_HOST_ORDER
|
GETADDR_RESOLVE
, 
p
[3], 0, 
NULL
, NULL);

5851 
	`msg
 (
msgÀvñ
, "cannotÖarse --ifconfig-pusháddresses");

5852 
îr
;

5855 i‡(
	`°ªq
 (
p
[0], "ifconfig-push-constraint") &&Ö[1] &&Ö[2])

5857 
ö_addr_t
 
√tw‹k
, 
√tmask
;

5859 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5860 
√tw‹k
 = 
	`gëaddr
 (
GETADDR_HOST_ORDER
|
GETADDR_RESOLVE
, 
p
[1], 0, 
NULL
, NULL);

5861 
√tmask
 = 
	`gëaddr
 (
GETADDR_HOST_ORDER
, 
p
[2], 0, 
NULL
, NULL);

5862 i‡(
√tw‹k
 && 
√tmask
)

5864 
›ti⁄s
->
push_ifc⁄fig_c⁄°øöt_deföed
 = 
åue
;

5865 
›ti⁄s
->
push_ifc⁄fig_c⁄°øöt_√tw‹k
 = 
√tw‹k
;

5866 
›ti⁄s
->
push_ifc⁄fig_c⁄°øöt_√tmask
 = 
√tmask
;

5870 
	`msg
 (
msgÀvñ
, "cannotÖarse --ifconfig-push-constraintáddresses");

5871 
îr
;

5874 i‡(
	`°ªq
 (
p
[0], "ifconfig-ipv6-push") &&Ö[1] )

5876 
ö6_addr
 
loˇl
, 
ªmŸe
;

5877 
√tbôs
;

5879 
	`VERIFY_PERMISSION
 (
OPT_P_INSTANCE
);

5881 i‡–! 
	`gë_ùv6_addr
–
p
[1], &
loˇl
, &
√tbôs
, 
NULL
, 
msgÀvñ
 ) )

5883 
	`msg
 (
msgÀvñ
, "cannotÖarse --ifconfig-ipv6-pusháddresses");

5884 
îr
;

5887 i‡–
p
[2] )

5889 i‡–!
	`gë_ùv6_addr
–
p
[2], &
ªmŸe
, 
NULL
, NULL, 
msgÀvñ
 ) )

5891 
	`msg
–
msgÀvñ
, "cannotÖarse --ifconfig-ipv6-pusháddresses");

5892 
îr
;

5897 i‡–! 
›ti⁄s
->
ifc⁄fig_ùv6_loˇl
 ||

5898 ! 
	`gë_ùv6_addr
–
›ti⁄s
->
ifc⁄fig_ùv6_loˇl
, &
ªmŸe
,

5899 
NULL
, NULL, 
msgÀvñ
 ) )

5901 
	`msg
–
msgÀvñ
, "secondárgumentÅo --ifconfig-ipv6-push missingándÇo global --ifconfig-ipv6áddress set");

5902 
îr
;

5906 
›ti⁄s
->
push_ifc⁄fig_ùv6_deföed
 = 
åue
;

5907 
›ti⁄s
->
push_ifc⁄fig_ùv6_loˇl
 = 
loˇl
;

5908 
›ti⁄s
->
push_ifc⁄fig_ùv6_√tbôs
 = 
√tbôs
;

5909 
›ti⁄s
->
push_ifc⁄fig_ùv6_ªmŸe
 = 
ªmŸe
;

5911 i‡(
	`°ªq
 (
p
[0], "disable"))

5913 
	`VERIFY_PERMISSION
 (
OPT_P_INSTANCE
);

5914 
›ti⁄s
->
dißbÀ
 = 
åue
;

5916 i‡(
	`°ªq
 (
p
[0], "tcp-nodelay"))

5918 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5919 
›ti⁄s
->
£rvî_Êags
 |
SF_TCP_NODELAY_HELPER
;

5921 i‡(
	`°ªq
 (
p
[0], "stale-routes-check") &&Ö[1])

5923 
ageög_time
, 
check_öãrvÆ
;

5925 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5926 
ageög_time
 = 
	`©oi
 (
p
[1]);

5927 i‡(
p
[2])

5928 
check_öãrvÆ
 = 
	`©oi
 (
p
[2]);

5930 
check_öãrvÆ
 = 
ageög_time
;

5932 i‡(
ageög_time
 < 1 || 
check_öãrvÆ
 < 1)

5934 
	`msg
 (
msgÀvñ
, "--stale-routes-checkágingÅimeánd check interval must be >= 1");

5935 
îr
;

5937 
›ti⁄s
->
°Æe_rouãs_ageög_time
 = 
ageög_time
;

5938 
›ti⁄s
->
°Æe_rouãs_check_öãrvÆ
 = 
check_öãrvÆ
;

5942 i‡(
	`°ªq
 (
p
[0], "client"))

5944 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5945 
›ti⁄s
->
˛õ¡
 = 
åue
;

5947 i‡(
	`°ªq
 (
p
[0], "pull"))

5949 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5950 
›ti⁄s
->
puŒ
 = 
åue
;

5952 i‡(
	`°ªq
 (
p
[0], "push-continuation") &&Ö[1])

5954 
	`VERIFY_PERMISSION
 (
OPT_P_PULL_MODE
);

5955 
›ti⁄s
->
push_c⁄töu©i⁄
 = 
	`©oi
(
p
[1]);

5957 i‡(
	`°ªq
 (
p
[0], "server-poll-timeout") &&Ö[1])

5959 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5960 
›ti⁄s
->
£rvî_pﬁl_timeout
 = 
	`posôive_©oi
(
p
[1]);

5962 i‡(
	`°ªq
 (
p
[0], "auth-user-pass"))

5964 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5965 i‡(
p
[1])

5967 
›ti⁄s
->
auth_u£r_∑ss_fûe
 = 
p
[1];

5970 
›ti⁄s
->
auth_u£r_∑ss_fûe
 = "stdin";

5972 i‡(
	`°ªq
 (
p
[0], "auth-retry") &&Ö[1])

5974 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5975 
	`auth_ªåy_£t
 (
msgÀvñ
, 
p
[1]);

5977 #ifde‡
ENABLE_CLIENT_CR


5978 i‡(
	`°ªq
 (
p
[0], "static-challenge") &&Ö[1] &&Ö[2])

5980 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5981 
›ti⁄s
->
sc_öfo
.
chÆÀnge_ãxt
 = 
p
[1];

5982 i‡(
	`©oi
(
p
[2]))

5983 
›ti⁄s
->
sc_öfo
.
Êags
 |
SC_ECHO
;

5987 #ifde‡
WIN32


5988 i‡(
	`°ªq
 (
p
[0], "win-sys") &&Ö[1])

5990 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

5991 i‡(
	`°ªq
 (
p
[1], "env"))

5992 
	`msg
 (
M_INFO
, "NOTE: --win-sysÉnv is default from OpenVPN v2.3. "

5996 
	`£t_wö_sys_∑th
 (
p
[1], 
es
);

5998 i‡(
	`°ªq
 (
p
[0], "route-method") &&Ö[1])

6000 
	`VERIFY_PERMISSION
 (
OPT_P_ROUTE_EXTRAS
);

6001 i‡(
	`°ªq
 (
p
[1], "adaptive"))

6002 
›ti⁄s
->
rouã_mëhod
 = 
ROUTE_METHOD_ADAPTIVE
;

6003 i‡(
	`°ªq
 (
p
[1], "ipapi"))

6004 
›ti⁄s
->
rouã_mëhod
 = 
ROUTE_METHOD_IPAPI
;

6005 i‡(
	`°ªq
 (
p
[1], "exe"))

6006 
›ti⁄s
->
rouã_mëhod
 = 
ROUTE_METHOD_EXE
;

6009 
	`msg
 (
msgÀvñ
, "--route method must be 'adaptive', 'ipapi', or 'exe'");

6010 
îr
;

6013 i‡(
	`°ªq
 (
p
[0], "ip-win32") &&Ö[1])

6015 c⁄° 
ödex
 = 
	`ascii2ù£t
 (
p
[1]);

6016 
tu¡≠_›ti⁄s
 *
to
 = &
›ti⁄s
->tuntap_options;

6018 
	`VERIFY_PERMISSION
 (
OPT_P_IPWIN32
);

6020 i‡(
ödex
 < 0)

6022 
	`msg
 (
msgÀvñ
,

6024 
p
[1],

6025 
	`ù£t2ascii_Æl
 (&
gc
));

6026 
îr
;

6029 i‡(
ödex
 =
IPW32_SET_ADAPTIVE
)

6030 
›ti⁄s
->
rouã_dñay_wödow
 = 
IPW32_SET_ADAPTIVE_DELAY_WINDOW
;

6032 i‡(
ödex
 =
IPW32_SET_DHCP_MASQ
)

6034 i‡(
p
[2])

6036 i‡(!
	`°ªq
 (
p
[2], "default"))

6038 
off£t
 = 
	`©oi
 (
p
[2]);

6040 i‡(!(
off£t
 > -256 && offset < 256))

6042 
	`msg
 (
msgÀvñ
, "--ù-wö32 dy«mi¯[off£t] [Àa£-time]: off£à(%dËmu° bê> -256ánd < 256", 
off£t
);

6043 
îr
;

6046 
to
->
dh˝_masq_cu°om_off£t
 = 
åue
;

6047 
to
->
dh˝_masq_off£t
 = 
off£t
;

6050 i‡(
p
[3])

6052 c⁄° 
mö_Àa£
 = 30;

6053 
Àa£_time
;

6054 
Àa£_time
 = 
	`©oi
 (
p
[3]);

6055 i‡(
Àa£_time
 < 
mö_Àa£
)

6057 
	`msg
 (
msgÀvñ
, "--ù-wö32 dy«mi¯[off£t] [Àa£-time]:Üó£Åimê∑ømëî (%dËmu° bê©Üó° %d sec⁄ds", 
Àa£_time
, 
mö_Àa£
);

6058 
îr
;

6060 
to
->
dh˝_Àa£_time
 = 
Àa£_time
;

6064 
to
->
ù_wö32_ty≥
 = 
ödex
;

6065 
to
->
ù_wö32_deföed
 = 
åue
;

6067 i‡(
	`°ªq
 (
p
[0], "dhcp-option") &&Ö[1])

6069 
tu¡≠_›ti⁄s
 *
o
 = &
›ti⁄s
->tuntap_options;

6070 
	`VERIFY_PERMISSION
 (
OPT_P_IPWIN32
);

6072 i‡(
	`°ªq
 (
p
[1], "DOMAIN") &&Ö[2])

6074 
o
->
domaö
 = 
p
[2];

6076 i‡(
	`°ªq
 (
p
[1], "NBS") &&Ö[2])

6078 
o
->
√tbios_sc›e
 = 
p
[2];

6080 i‡(
	`°ªq
 (
p
[1], "NBT") &&Ö[2])

6082 
t
;

6083 
t
 = 
	`©oi
 (
p
[2]);

6084 i‡(!(
t
 == 1 ||Å == 2 ||Å == 4 ||Å == 8))

6086 
	`msg
 (
msgÀvñ
, "--dh˝-›ti⁄ NBT:Ö¨amëî (%dËmu° bê1, 2, 4, o∏8", 
t
);

6087 
îr
;

6089 
o
->
√tbios_node_ty≥
 = 
t
;

6091 i‡(
	`°ªq
 (
p
[1], "DNS") &&Ö[2])

6093 
	`dh˝_›ti⁄_addªss_∑r£
 ("DNS", 
p
[2], 
o
->
dns
, &o->
dns_Àn
, 
msgÀvñ
);

6095 i‡(
	`°ªq
 (
p
[1], "WINS") &&Ö[2])

6097 
	`dh˝_›ti⁄_addªss_∑r£
 ("WINS", 
p
[2], 
o
->
wös
, &o->
wös_Àn
, 
msgÀvñ
);

6099 i‡(
	`°ªq
 (
p
[1], "NTP") &&Ö[2])

6101 
	`dh˝_›ti⁄_addªss_∑r£
 ("NTP", 
p
[2], 
o
->
¡p
, &o->
¡p_Àn
, 
msgÀvñ
);

6103 i‡(
	`°ªq
 (
p
[1], "NBDD") &&Ö[2])

6105 
	`dh˝_›ti⁄_addªss_∑r£
 ("NBDD", 
p
[2], 
o
->
nbdd
, &o->
nbdd_Àn
, 
msgÀvñ
);

6107 i‡(
	`°ªq
 (
p
[1], "DISABLE-NBT"))

6109 
o
->
dißbÀ_nbt
 = 1;

6113 
	`msg
 (
msgÀvñ
, "--dh˝-›ti⁄: unknow¿›ti⁄Åy≥ '%s' o∏missögÖ¨amëî", 
p
[1]);

6114 
îr
;

6116 
o
->
dh˝_›ti⁄s
 = 
åue
;

6118 i‡(
	`°ªq
 (
p
[0], "show-adapters"))

6120 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6121 
	`show_èp_wö_ad≠ãrs
 (
M_INFO
|
M_NOPREFIX
, 
M_WARN
|M_NOPREFIX);

6122 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_GOOD
);

6124 i‡(
	`°ªq
 (
p
[0], "show-net"))

6126 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6127 
	`show_rouãs
 (
M_INFO
|
M_NOPREFIX
);

6128 
	`show_ad≠ãrs
 (
M_INFO
|
M_NOPREFIX
);

6129 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_GOOD
);

6131 i‡(
	`°ªq
 (
p
[0], "show-net-up"))

6133 
	`VERIFY_PERMISSION
 (
OPT_P_UP
);

6134 
›ti⁄s
->
show_√t_up
 = 
åue
;

6136 i‡(
	`°ªq
 (
p
[0], "tap-sleep") &&Ö[1])

6138 
s
;

6139 
	`VERIFY_PERMISSION
 (
OPT_P_IPWIN32
);

6140 
s
 = 
	`©oi
 (
p
[1]);

6141 i‡(
s
 < 0 || s >= 256)

6143 
	`msg
 (
msgÀvñ
, "--tap-sleepÖarameter must be between 0ánd 255");

6144 
îr
;

6146 
›ti⁄s
->
tu¡≠_›ti⁄s
.
èp_¶ìp
 = 
s
;

6148 i‡(
	`°ªq
 (
p
[0], "dhcp-renew"))

6150 
	`VERIFY_PERMISSION
 (
OPT_P_IPWIN32
);

6151 
›ti⁄s
->
tu¡≠_›ti⁄s
.
dh˝_ª√w
 = 
åue
;

6153 i‡(
	`°ªq
 (
p
[0], "dhcp-pre-release"))

6155 
	`VERIFY_PERMISSION
 (
OPT_P_IPWIN32
);

6156 
›ti⁄s
->
tu¡≠_›ti⁄s
.
dh˝_¥e_ªÀa£
 = 
åue
;

6158 i‡(
	`°ªq
 (
p
[0], "dhcp-release"))

6160 
	`VERIFY_PERMISSION
 (
OPT_P_IPWIN32
);

6161 
›ti⁄s
->
tu¡≠_›ti⁄s
.
dh˝_ªÀa£
 = 
åue
;

6163 i‡(
	`°ªq
 (
p
[0], "dhcp-internal") &&Ö[1])

6165 
ad≠ãr_ödex
;

6166 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6167 
	`£t_debug_Àvñ
 (
›ti⁄s
->
vîbosôy
, 
SDL_CONSTRAIN
);

6168 
ad≠ãr_ödex
 = 
	`©ou
 (
p
[1]);

6169 
	`¶ìp
 (
›ti⁄s
->
tu¡≠_›ti⁄s
.
èp_¶ìp
);

6170 i‡(
›ti⁄s
->
tu¡≠_›ti⁄s
.
dh˝_¥e_ªÀa£
)

6171 
	`dh˝_ªÀa£_by_ad≠ãr_ödex
 (
ad≠ãr_ödex
);

6172 i‡(
›ti⁄s
->
tu¡≠_›ti⁄s
.
dh˝_ª√w
)

6173 
	`dh˝_ª√w_by_ad≠ãr_ödex
 (
ad≠ãr_ödex
);

6174 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_GOOD
);

6176 i‡(
	`°ªq
 (
p
[0], "register-dns"))

6178 
	`VERIFY_PERMISSION
 (
OPT_P_IPWIN32
);

6179 
›ti⁄s
->
tu¡≠_›ti⁄s
.
ªgi°î_dns
 = 
åue
;

6181 i‡(
	`°ªq
 (
p
[0], "rdns-internal"))

6189 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6190 
	`£t_debug_Àvñ
 (
›ti⁄s
->
vîbosôy
, 
SDL_CONSTRAIN
);

6191 i‡(
›ti⁄s
->
tu¡≠_›ti⁄s
.
ªgi°î_dns
)

6192 
	`ùc⁄fig_ªgi°î_dns
 (
NULL
);

6193 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_GOOD
);

6195 i‡(
	`°ªq
 (
p
[0], "show-valid-subnets"))

6197 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6198 
	`show_vÆid_wö32_tun_sub√ts
 ();

6199 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_GOOD
);

6201 i‡(
	`°ªq
 (
p
[0], "pause-exit"))

6203 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6204 
	`£t_∑u£_exô_wö32
 ();

6206 i‡(
	`°ªq
 (
p
[0], "service") &&Ö[1])

6208 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6209 
›ti⁄s
->
exô_evít_«me
 = 
p
[1];

6210 i‡(
p
[2])

6212 
›ti⁄s
->
exô_evít_öôül_°©e
 = (
	`©oi
(
p
[2]) != 0);

6215 i‡(
	`°ªq
 (
p
[0], "allow-nonadmin"))

6217 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6218 
	`èp_Ælow_n⁄admö_ac˚ss
 (
p
[1]);

6219 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_GOOD
);

6221 i‡(
	`°ªq
 (
p
[0], "user") &&Ö[1])

6223 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6224 
	`msg
 (
M_WARN
, "NOTE: --user option isÇot implemented on Windows");

6226 i‡(
	`°ªq
 (
p
[0], "group") &&Ö[1])

6228 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6229 
	`msg
 (
M_WARN
, "NOTE: --group option isÇot implemented on Windows");

6232 i‡(
	`°ªq
 (
p
[0], "user") &&Ö[1])

6234 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6235 
›ti⁄s
->
u£∫ame
 = 
p
[1];

6237 i‡(
	`°ªq
 (
p
[0], "group") &&Ö[1])

6239 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6240 
›ti⁄s
->
grou≤ame
 = 
p
[1];

6242 i‡(
	`°ªq
 (
p
[0], "dhcp-option") &&Ö[1])

6244 
	`VERIFY_PERMISSION
 (
OPT_P_IPWIN32
);

6245 
	`f‹eign_›ti⁄
 (
›ti⁄s
, 
p
, 3, 
es
);

6247 i‡(
	`°ªq
 (
p
[0], "route-method") &&Ö[1])

6249 
	`VERIFY_PERMISSION
 (
OPT_P_ROUTE_EXTRAS
);

6252 #i‡
PASSTOS_CAPABILITY


6253 i‡(
	`°ªq
 (
p
[0], "passtos"))

6255 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6256 
›ti⁄s
->
∑s°os
 = 
åue
;

6259 #ifde‡
ENABLE_LZO


6260 i‡(
	`°ªq
 (
p
[0], "comp-lzo"))

6262 
	`VERIFY_PERMISSION
 (
OPT_P_COMP
);

6263 i‡(
p
[1])

6265 i‡(
	`°ªq
 (
p
[1], "yes"))

6266 
›ti⁄s
->
lzo
 = 
LZO_SELECTED
|
LZO_ON
;

6267 i‡(
	`°ªq
 (
p
[1], "no"))

6268 
›ti⁄s
->
lzo
 = 
LZO_SELECTED
;

6269 i‡(
	`°ªq
 (
p
[1], "adaptive"))

6270 
›ti⁄s
->
lzo
 = 
LZO_SELECTED
|
LZO_ON
|
LZO_ADAPTIVE
;

6273 
	`msg
 (
msgÀvñ
, "bad comp-lzÿ›ti⁄: %†-- mu° bê'yes', 'no', o∏'ad≠tive'", 
p
[1]);

6274 
îr
;

6278 
›ti⁄s
->
lzo
 = 
LZO_SELECTED
|
LZO_ON
|
LZO_ADAPTIVE
;

6280 i‡(
	`°ªq
 (
p
[0], "comp-noadapt"))

6282 
	`VERIFY_PERMISSION
 (
OPT_P_COMP
);

6283 
›ti⁄s
->
lzo
 &~
LZO_ADAPTIVE
;

6286 #ifde‡
ENABLE_CRYPTO


6287 i‡(
	`°ªq
 (
p
[0], "show-ciphers"))

6289 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6290 
›ti⁄s
->
show_cùhîs
 = 
åue
;

6292 i‡(
	`°ªq
 (
p
[0], "show-digests"))

6294 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6295 
›ti⁄s
->
show_dige°s
 = 
åue
;

6297 i‡(
	`°ªq
 (
p
[0], "show-engines"))

6299 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6300 
›ti⁄s
->
show_ígöes
 = 
åue
;

6302 i‡(
	`°ªq
 (
p
[0], "key-direction") &&Ö[1])

6304 
key_dúe˘i⁄
;

6306 
key_dúe˘i⁄
 = 
	`ascii2keydúe˘i⁄
 (
msgÀvñ
, 
p
[1]);

6307 i‡(
key_dúe˘i⁄
 >= 0)

6308 
›ti⁄s
->
key_dúe˘i⁄
 = key_direction;

6310 
îr
;

6312 i‡(
	`°ªq
 (
p
[0], "secret") &&Ö[1])

6314 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6315 i‡(
	`°ªq
 (
p
[1], 
INLINE_FILE_TAG
) &&Ö[2])

6317 
›ti⁄s
->
sh¨ed_£¸ë_fûe_ölöe
 = 
p
[2];

6320 i‡(
p
[2])

6322 
key_dúe˘i⁄
;

6324 
key_dúe˘i⁄
 = 
	`ascii2keydúe˘i⁄
 (
msgÀvñ
, 
p
[2]);

6325 i‡(
key_dúe˘i⁄
 >= 0)

6326 
›ti⁄s
->
key_dúe˘i⁄
 = key_direction;

6328 
îr
;

6330 
›ti⁄s
->
sh¨ed_£¸ë_fûe
 = 
p
[1];

6332 i‡(
	`°ªq
 (
p
[0], "genkey"))

6334 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6335 
›ti⁄s
->
gíkey
 = 
åue
;

6337 i‡(
	`°ªq
 (
p
[0], "auth") &&Ö[1])

6339 
	`VERIFY_PERMISSION
 (
OPT_P_CRYPTO
);

6340 
›ti⁄s
->
auth«me_deföed
 = 
åue
;

6341 
›ti⁄s
->
auth«me
 = 
p
[1];

6342 i‡(
	`°ªq
 (
›ti⁄s
->
auth«me
, "none"))

6344 
›ti⁄s
->
auth«me_deföed
 = 
Ál£
;

6345 
›ti⁄s
->
auth«me
 = 
NULL
;

6348 i‡(
	`°ªq
 (
p
[0], "auth"))

6350 
	`VERIFY_PERMISSION
 (
OPT_P_CRYPTO
);

6351 
›ti⁄s
->
auth«me_deföed
 = 
åue
;

6353 i‡(
	`°ªq
 (
p
[0], "cipher") &&Ö[1])

6355 
	`VERIFY_PERMISSION
 (
OPT_P_CRYPTO
);

6356 
›ti⁄s
->
cùhî«me_deföed
 = 
åue
;

6357 
›ti⁄s
->
cùhî«me
 = 
p
[1];

6358 i‡(
	`°ªq
 (
›ti⁄s
->
cùhî«me
, "none"))

6360 
›ti⁄s
->
cùhî«me_deföed
 = 
Ál£
;

6361 
›ti⁄s
->
cùhî«me
 = 
NULL
;

6364 i‡(
	`°ªq
 (
p
[0], "cipher"))

6366 
	`VERIFY_PERMISSION
 (
OPT_P_CRYPTO
);

6367 
›ti⁄s
->
cùhî«me_deföed
 = 
åue
;

6369 i‡(
	`°ªq
 (
p
[0], "prng") &&Ö[1])

6371 
	`VERIFY_PERMISSION
 (
OPT_P_CRYPTO
);

6372 i‡(
	`°ªq
 (
p
[1], "none"))

6373 
›ti⁄s
->
¥ng_hash
 = 
NULL
;

6375 
›ti⁄s
->
¥ng_hash
 = 
p
[1];

6376 i‡(
p
[2])

6378 c⁄° 
¶
 = 
	`©oi
 (
p
[2]);

6379 i‡(
¶
 >
NONCE_SECRET_LEN_MIN
 && s»<
NONCE_SECRET_LEN_MAX
)

6381 
›ti⁄s
->
¥ng_n⁄˚_£¸ë_Àn
 = 
¶
;

6385 
	`msg
 (
msgÀvñ
, "prngÖarameterÇonce_secret_len must be between %dánd %d",

6386 
NONCE_SECRET_LEN_MIN
, 
NONCE_SECRET_LEN_MAX
);

6387 
îr
;

6391 i‡(
	`°ªq
 (
p
[0], "no-replay"))

6393 
	`VERIFY_PERMISSION
 (
OPT_P_CRYPTO
);

6394 
›ti⁄s
->
ª∂ay
 = 
Ál£
;

6396 i‡(
	`°ªq
 (
p
[0], "replay-window"))

6398 
	`VERIFY_PERMISSION
 (
OPT_P_CRYPTO
);

6399 i‡(
p
[1])

6401 
ª∂ay_wödow
;

6403 
ª∂ay_wödow
 = 
	`©oi
 (
p
[1]);

6404 i‡(!(
MIN_SEQ_BACKTRACK
 <
ª∂ay_wödow
 &&Ñïœy_wödow <
MAX_SEQ_BACKTRACK
))

6406 
	`msg
 (
msgÀvñ
, "replay-window window sizeÖarameter (%d) must be between %dánd %d",

6407 
ª∂ay_wödow
,

6408 
MIN_SEQ_BACKTRACK
,

6409 
MAX_SEQ_BACKTRACK
);

6410 
îr
;

6412 
›ti⁄s
->
ª∂ay_wödow
 =Ñeplay_window;

6414 i‡(
p
[2])

6416 
ª∂ay_time
;

6418 
ª∂ay_time
 = 
	`©oi
 (
p
[2]);

6419 i‡(!(
MIN_TIME_BACKTRACK
 <
ª∂ay_time
 &&Ñïœy_timê<
MAX_TIME_BACKTRACK
))

6421 
	`msg
 (
msgÀvñ
, "replay-windowÅime windowÖarameter (%d) must be between %dánd %d",

6422 
ª∂ay_time
,

6423 
MIN_TIME_BACKTRACK
,

6424 
MAX_TIME_BACKTRACK
);

6425 
îr
;

6427 
›ti⁄s
->
ª∂ay_time
 =Ñeplay_time;

6432 
	`msg
 (
msgÀvñ
, "replay-window option is missing window sizeÖarameter");

6433 
îr
;

6436 i‡(
	`°ªq
 (
p
[0], "mute-replay-warnings"))

6438 
	`VERIFY_PERMISSION
 (
OPT_P_CRYPTO
);

6439 
›ti⁄s
->
muã_ª∂ay_w¨nögs
 = 
åue
;

6441 i‡(
	`°ªq
 (
p
[0], "no-iv"))

6443 
	`VERIFY_PERMISSION
 (
OPT_P_CRYPTO
);

6444 
›ti⁄s
->
u£_iv
 = 
Ál£
;

6446 i‡(
	`°ªq
 (
p
[0], "replay-persist") &&Ö[1])

6448 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6449 
›ti⁄s
->
∑ckë_id_fûe
 = 
p
[1];

6451 i‡(
	`°ªq
 (
p
[0], "test-crypto"))

6453 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6454 
›ti⁄s
->
ã°_¸y±o
 = 
åue
;

6456 #i‚de‡
ENABLE_CRYPTO_POLARSSL


6457 i‡(
	`°ªq
 (
p
[0], "engine"))

6459 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6460 i‡(
p
[1])

6462 
›ti⁄s
->
ígöe
 = 
p
[1];

6465 
›ti⁄s
->
ígöe
 = "auto";

6468 #ifde‡
HAVE_EVP_CIPHER_CTX_SET_KEY_LENGTH


6469 i‡(
	`°ªq
 (
p
[0], "keysize") &&Ö[1])

6471 
keysize
;

6473 
	`VERIFY_PERMISSION
 (
OPT_P_CRYPTO
);

6474 
keysize
 = 
	`©oi
 (
p
[1]) / 8;

6475 i‡(
keysize
 < 0 || keysizê> 
MAX_CIPHER_KEY_LENGTH
)

6477 
	`msg
 (
msgÀvñ
, "Bad keysize: %s", 
p
[1]);

6478 
îr
;

6480 
›ti⁄s
->
keysize
 = keysize;

6483 #ifde‡
ENABLE_PREDICTION_RESISTANCE


6484 i‡(
	`°ªq
 (
p
[0], "use-prediction-resistance"))

6486 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6487 
›ti⁄s
->
u£_¥edi˘i⁄_ªsi°™˚
 = 
åue
;

6490 #ifde‡
ENABLE_SSL


6491 i‡(
	`°ªq
 (
p
[0], "show-tls"))

6493 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6494 
›ti⁄s
->
show_és_cùhîs
 = 
åue
;

6496 i‡(
	`°ªq
 (
p
[0], "tls-server"))

6498 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6499 
›ti⁄s
->
és_£rvî
 = 
åue
;

6501 i‡(
	`°ªq
 (
p
[0], "tls-client"))

6503 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6504 
›ti⁄s
->
és_˛õ¡
 = 
åue
;

6506 i‡(
	`°ªq
 (
p
[0], "ca") &&Ö[1])

6508 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6509 
›ti⁄s
->
ˇ_fûe
 = 
p
[1];

6510 i‡(
	`°ªq
 (
p
[1], 
INLINE_FILE_TAG
) &&Ö[2])

6512 
›ti⁄s
->
ˇ_fûe_ölöe
 = 
p
[2];

6515 #i‚de‡
ENABLE_CRYPTO_POLARSSL


6516 i‡(
	`°ªq
 (
p
[0], "capath") &&Ö[1])

6518 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6519 
›ti⁄s
->
ˇ_∑th
 = 
p
[1];

6522 i‡(
	`°ªq
 (
p
[0], "dh") &&Ö[1])

6524 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6525 
›ti⁄s
->
dh_fûe
 = 
p
[1];

6526 i‡(
	`°ªq
 (
p
[1], 
INLINE_FILE_TAG
) &&Ö[2])

6528 
›ti⁄s
->
dh_fûe_ölöe
 = 
p
[2];

6531 i‡(
	`°ªq
 (
p
[0], "cert") &&Ö[1])

6533 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6534 
›ti⁄s
->
˚π_fûe
 = 
p
[1];

6535 i‡(
	`°ªq
 (
p
[1], 
INLINE_FILE_TAG
) &&Ö[2])

6537 
›ti⁄s
->
˚π_fûe_ölöe
 = 
p
[2];

6540 i‡(
	`°ªq
 (
p
[0], "extra-certs") &&Ö[1])

6542 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6543 
›ti⁄s
->
exåa_˚πs_fûe
 = 
p
[1];

6544 i‡(
	`°ªq
 (
p
[1], 
INLINE_FILE_TAG
) &&Ö[2])

6546 
›ti⁄s
->
exåa_˚πs_fûe_ölöe
 = 
p
[2];

6549 i‡(
	`°ªq
 (
p
[0], "verify-hash") &&Ö[1])

6551 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6552 
›ti⁄s
->
vîify_hash
 = 
	`∑r£_hash_fögî¥öt
(
p
[1], 
SHA_DIGEST_LENGTH
, 
msgÀvñ
, &›ti⁄s->
gc
);

6554 #ifde‡
ENABLE_CRYPTOAPI


6555 i‡(
	`°ªq
 (
p
[0], "cryptoapicert") &&Ö[1])

6557 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6558 
›ti⁄s
->
¸y±ﬂpi_˚π
 = 
p
[1];

6561 i‡(
	`°ªq
 (
p
[0], "key") &&Ö[1])

6563 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6564 
›ti⁄s
->
¥iv_key_fûe
 = 
p
[1];

6565 i‡(
	`°ªq
 (
p
[1], 
INLINE_FILE_TAG
) &&Ö[2])

6567 
›ti⁄s
->
¥iv_key_fûe_ölöe
 = 
p
[2];

6570 i‡(
	`°ªq
 (
p
[0], "tls-version-min") &&Ö[1])

6572 
vî
;

6573 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6574 
vî
 = 
	`és_vîsi⁄_∑r£
(
p
[1],Ö[2]);

6575 i‡(
vî
 =
TLS_VER_BAD
)

6577 
	`msg
 (
msgÀvñ
, "unknow¿és-vîsi⁄-möÖ¨amëî: %s", 
p
[1]);

6578 
îr
;

6580 
›ti⁄s
->
s¶_Êags
 &=

6581 ~(
SSLF_TLS_VERSION_MIN_MASK
 << 
SSLF_TLS_VERSION_MIN_SHIFT
);

6582 
›ti⁄s
->
s¶_Êags
 |(
vî
 << 
SSLF_TLS_VERSION_MIN_SHIFT
);

6584 i‡(
	`°ªq
 (
p
[0], "tls-version-max") &&Ö[1])

6586 
vî
;

6587 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6588 
vî
 = 
	`és_vîsi⁄_∑r£
(
p
[1], 
NULL
);

6589 i‡(
vî
 =
TLS_VER_BAD
)

6591 
	`msg
 (
msgÀvñ
, "unknow¿és-vîsi⁄-maxÖ¨amëî: %s", 
p
[1]);

6592 
îr
;

6594 
›ti⁄s
->
s¶_Êags
 &=

6595 ~(
SSLF_TLS_VERSION_MAX_MASK
 << 
SSLF_TLS_VERSION_MAX_SHIFT
);

6596 
›ti⁄s
->
s¶_Êags
 |(
vî
 << 
SSLF_TLS_VERSION_MAX_SHIFT
);

6598 #i‚de‡
ENABLE_CRYPTO_POLARSSL


6599 i‡(
	`°ªq
 (
p
[0], "pkcs12") &&Ö[1])

6601 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6602 
›ti⁄s
->
pkcs12_fûe
 = 
p
[1];

6603 i‡(
	`°ªq
 (
p
[1], 
INLINE_FILE_TAG
) &&Ö[2])

6605 
›ti⁄s
->
pkcs12_fûe_ölöe
 = 
p
[2];

6609 i‡(
	`°ªq
 (
p
[0], "askpass"))

6611 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6612 i‡(
p
[1])

6614 
›ti⁄s
->
key_∑ss_fûe
 = 
p
[1];

6617 
›ti⁄s
->
key_∑ss_fûe
 = "stdin";

6619 i‡(
	`°ªq
 (
p
[0], "auth-nocache"))

6621 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6622 
	`s¶_£t_auth_noˇche
 ();

6624 i‡(
	`°ªq
 (
p
[0], "auth-token") &&Ö[1])

6626 
	`VERIFY_PERMISSION
 (
OPT_P_ECHO
);

6627 
	`s¶_£t_auth_tokí
(
p
[1]);

6628 #ifde‡
ENABLE_MANAGEMENT


6629 i‡(
m™agemít
)

6630 
	`m™agemít_auth_tokí
 (
m™agemít
, 
p
[1]);

6633 i‡(
	`°ªq
 (
p
[0], "single-session"))

6635 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6636 
›ti⁄s
->
sögÀ_£ssi⁄
 = 
åue
;

6638 #ifde‡
ENABLE_PUSH_PEER_INFO


6639 i‡(
	`°ªq
 (
p
[0], "push-peer-info"))

6641 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6642 
›ti⁄s
->
push_≥î_öfo
 = 
åue
;

6645 i‡(
	`°ªq
 (
p
[0], "tls-exit"))

6647 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6648 
›ti⁄s
->
és_exô
 = 
åue
;

6650 i‡(
	`°ªq
 (
p
[0], "tls-cipher") &&Ö[1])

6652 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6653 
›ti⁄s
->
cùhî_li°
 = 
p
[1];

6655 i‡(
	`°ªq
 (
p
[0], "crl-verify") &&Ö[1])

6657 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6658 i‡(
p
[2] && 
	`°ªq
(p[2], "dir"))

6659 
›ti⁄s
->
s¶_Êags
 |
SSLF_CRL_VERIFY_DIR
;

6660 
›ti⁄s
->
¸l_fûe
 = 
p
[1];

6662 i‡(
	`°ªq
 (
p
[0], "tls-verify") &&Ö[1])

6664 
	`VERIFY_PERMISSION
 (
OPT_P_SCRIPT
);

6665 i‡(!
	`no_m‹e_th™_n_¨gs
 (
msgÀvñ
, 
p
, 2, 
NM_QUOTE_HINT
))

6666 
îr
;

6667 
	`£t_u£r_s¸ùt
 (
›ti⁄s
, &›ti⁄s->
és_vîify
,

6668 
	`°rög_sub°ôuã
 (
p
[1], ',', ' ', &
›ti⁄s
->
gc
),

6669 "és-vîify", 
åue
);

6671 #i‚de‡
ENABLE_CRYPTO_POLARSSL


6672 i‡(
	`°ªq
 (
p
[0], "tls-export-cert") &&Ö[1])

6674 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6675 
›ti⁄s
->
és_exp‹t_˚π
 = 
p
[1];

6678 i‡(
	`°ªq
 (
p
[0], "compat-names"))

6680 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6681 i‡(
›ti⁄s
->
vîify_x509_ty≥
 !
VERIFY_X509_NONE
 &&

6682 
›ti⁄s
->
vîify_x509_ty≥
 !
TLS_REMOTE_SUBJECT_DN
 &&

6683 
›ti⁄s
->
vîify_x509_ty≥
 !
TLS_REMOTE_SUBJECT_RDN_PREFIX
)

6685 
	`msg
 (
msgÀvñ
, "you cannot use --compat-names with --verify-x509-name");

6686 
îr
;

6688 
	`msg
 (
M_WARN
, "DEPRECATED OPTION: --compat-names,Ölease update your configuration");

6689 
	`com∑t_Êag
 (
COMPAT_FLAG_SET
 | 
COMPAT_NAMES
);

6690 #i‡
P2MP_SERVER


6691 i‡(
p
[1] && 
	`°ªq
 (p[1], "no-remapping"))

6692 
	`com∑t_Êag
 (
COMPAT_FLAG_SET
 | 
COMPAT_NO_NAME_REMAPPING
);

6694 i‡(
	`°ªq
 (
p
[0], "no-name-remapping"))

6696 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6697 i‡(
›ti⁄s
->
vîify_x509_ty≥
 !
VERIFY_X509_NONE
 &&

6698 
›ti⁄s
->
vîify_x509_ty≥
 !
TLS_REMOTE_SUBJECT_DN
 &&

6699 
›ti⁄s
->
vîify_x509_ty≥
 !
TLS_REMOTE_SUBJECT_RDN_PREFIX
)

6701 
	`msg
 (
msgÀvñ
, "you cannot use --no-name-remapping with --verify-x509-name");

6702 
îr
;

6704 
	`msg
 (
M_WARN
, "DEPRECATED OPTION: --no-name-remapping,Ölease update your configuration");

6705 
	`com∑t_Êag
 (
COMPAT_FLAG_SET
 | 
COMPAT_NAMES
);

6706 
	`com∑t_Êag
 (
COMPAT_FLAG_SET
 | 
COMPAT_NO_NAME_REMAPPING
);

6709 i‡(
	`°ªq
 (
p
[0], "tls-remote") &&Ö[1])

6711 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6713 i‡(
›ti⁄s
->
vîify_x509_ty≥
 !
VERIFY_X509_NONE
 &&

6714 
›ti⁄s
->
vîify_x509_ty≥
 !
TLS_REMOTE_SUBJECT_DN
 &&

6715 
›ti⁄s
->
vîify_x509_ty≥
 !
TLS_REMOTE_SUBJECT_RDN_PREFIX
)

6717 
	`msg
 (
msgÀvñ
, "you cannot use --tls-remote with --verify-x509-name");

6718 
îr
;

6720 
	`msg
 (
M_WARN
, "DEPRECATED OPTION: --tls-remote,Ölease update your configuration");

6722 i‡(
	`°æí
 (
p
[1]))

6724 
is_u£∫ame
 = (!
	`°rchr
 (
p
[1], '='Ë|| !
	`°r°r
 (p[1], ", "));

6725 
ty≥
 = 
TLS_REMOTE_SUBJECT_DN
;

6726 i‡(
p
[1][0] !'/' && 
is_u£∫ame
)

6727 
ty≥
 = 
TLS_REMOTE_SUBJECT_RDN_PREFIX
;

6733 i‡(
p
[1][0] ='/' || 
is_u£∫ame
)

6734 
	`com∑t_Êag
 (
COMPAT_FLAG_SET
 | 
COMPAT_NAMES
);

6736 
›ti⁄s
->
vîify_x509_ty≥
 = 
ty≥
;

6737 
›ti⁄s
->
vîify_x509_«me
 = 
p
[1];

6740 i‡(
	`°ªq
 (
p
[0], "vîify-x509-«me"Ë&&Ö[1] && 
	`°æí
 (p[1]))

6742 
ty≥
 = 
VERIFY_X509_SUBJECT_DN
;

6743 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6744 i‡(
›ti⁄s
->
vîify_x509_ty≥
 =
TLS_REMOTE_SUBJECT_DN
 ||

6745 
›ti⁄s
->
vîify_x509_ty≥
 =
TLS_REMOTE_SUBJECT_RDN_PREFIX
)

6747 
	`msg
 (
msgÀvñ
, "you cannot use --verify-x509-name with --tls-remote");

6748 
îr
;

6750 i‡(
	`com∑t_Êag
 (
COMPAT_FLAG_QUERY
 | 
COMPAT_NAMES
))

6752 
	`msg
 (
msgÀvñ
, "you cannot use --verify-x509-name with "

6754 
îr
;

6756 i‡(
p
[2])

6758 i‡(
	`°ªq
 (
p
[2], "subject"))

6759 
ty≥
 = 
VERIFY_X509_SUBJECT_DN
;

6760 i‡(
	`°ªq
 (
p
[2], "name"))

6761 
ty≥
 = 
VERIFY_X509_SUBJECT_RDN
;

6762 i‡(
	`°ªq
 (
p
[2], "name-prefix"))

6763 
ty≥
 = 
VERIFY_X509_SUBJECT_RDN_PREFIX
;

6766 
	`msg
 (
msgÀvñ
, "unknow¿X.509Çamêty≥: %s", 
p
[2]);

6767 
îr
;

6770 
›ti⁄s
->
vîify_x509_ty≥
 = 
ty≥
;

6771 
›ti⁄s
->
vîify_x509_«me
 = 
p
[1];

6773 i‡(
	`°ªq
 (
p
[0], "ns-cert-type") &&Ö[1])

6775 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6776 i‡(
	`°ªq
 (
p
[1], "server"))

6777 
›ti⁄s
->
ns_˚π_ty≥
 = 
NS_CERT_CHECK_SERVER
;

6778 i‡(
	`°ªq
 (
p
[1], "client"))

6779 
›ti⁄s
->
ns_˚π_ty≥
 = 
NS_CERT_CHECK_CLIENT
;

6782 
	`msg
 (
msgÀvñ
, "--ns-cert-type must be 'client' or 'server'");

6783 
îr
;

6786 #i‡
OPENSSL_VERSION_NUMBER
 >0x00907000L || 
ENABLE_CRYPTO_POLARSSL


6787 i‡(
	`°ªq
 (
p
[0], "remote-cert-ku"))

6789 
j
;

6791 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6793 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j] !
NULL
; ++j)

6794 
	`ssˇnf
 (
p
[
j
], "%x", &(
›ti⁄s
->
ªmŸe_˚π_ku
[j-1]));

6796 i‡(
	`°ªq
 (
p
[0], "remote-cert-eku") &&Ö[1])

6798 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6799 
›ti⁄s
->
ªmŸe_˚π_eku
 = 
p
[1];

6801 i‡(
	`°ªq
 (
p
[0], "remote-cert-tls") &&Ö[1])

6803 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6805 i‡(
	`°ªq
 (
p
[1], "server"))

6807 
›ti⁄s
->
ªmŸe_˚π_ku
[0] = 0xa0;

6808 
›ti⁄s
->
ªmŸe_˚π_ku
[1] = 0x88;

6809 
›ti⁄s
->
ªmŸe_˚π_eku
 = "TLS Web Server Authentication";

6811 i‡(
	`°ªq
 (
p
[1], "client"))

6813 
›ti⁄s
->
ªmŸe_˚π_ku
[0] = 0x80;

6814 
›ti⁄s
->
ªmŸe_˚π_ku
[1] = 0x08;

6815 
›ti⁄s
->
ªmŸe_˚π_ku
[2] = 0x88;

6816 
›ti⁄s
->
ªmŸe_˚π_eku
 = "TLS Web Client Authentication";

6820 
	`msg
 (
msgÀvñ
, "--remote-cert-tls must be 'client' or 'server'");

6821 
îr
;

6825 i‡(
	`°ªq
 (
p
[0], "tls-timeout") &&Ö[1])

6827 
	`VERIFY_PERMISSION
 (
OPT_P_TLS_PARMS
);

6828 
›ti⁄s
->
és_timeout
 = 
	`posôive_©oi
 (
p
[1]);

6830 i‡(
	`°ªq
 (
p
[0], "reneg-bytes") &&Ö[1])

6832 
	`VERIFY_PERMISSION
 (
OPT_P_TLS_PARMS
);

6833 
›ti⁄s
->
ª√gŸüã_byãs
 = 
	`posôive_©oi
 (
p
[1]);

6835 i‡(
	`°ªq
 (
p
[0], "reneg-pkts") &&Ö[1])

6837 
	`VERIFY_PERMISSION
 (
OPT_P_TLS_PARMS
);

6838 
›ti⁄s
->
ª√gŸüã_∑ckës
 = 
	`posôive_©oi
 (
p
[1]);

6840 i‡(
	`°ªq
 (
p
[0], "reneg-sec") &&Ö[1])

6842 
	`VERIFY_PERMISSION
 (
OPT_P_TLS_PARMS
);

6843 
›ti⁄s
->
ª√gŸüã_£c⁄ds
 = 
	`posôive_©oi
 (
p
[1]);

6845 i‡(
	`°ªq
 (
p
[0], "hand-window") &&Ö[1])

6847 
	`VERIFY_PERMISSION
 (
OPT_P_TLS_PARMS
);

6848 
›ti⁄s
->
h™dshake_wödow
 = 
	`posôive_©oi
 (
p
[1]);

6850 i‡(
	`°ªq
 (
p
[0], "tran-window") &&Ö[1])

6852 
	`VERIFY_PERMISSION
 (
OPT_P_TLS_PARMS
);

6853 
›ti⁄s
->
å™sôi⁄_wödow
 = 
	`posôive_©oi
 (
p
[1]);

6855 i‡(
	`°ªq
 (
p
[0], "tls-auth") &&Ö[1])

6857 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6858 i‡(
	`°ªq
 (
p
[1], 
INLINE_FILE_TAG
) &&Ö[2])

6860 
›ti⁄s
->
és_auth_fûe_ölöe
 = 
p
[2];

6863 i‡(
p
[2])

6865 
key_dúe˘i⁄
;

6867 
key_dúe˘i⁄
 = 
	`ascii2keydúe˘i⁄
 (
msgÀvñ
, 
p
[2]);

6868 i‡(
key_dúe˘i⁄
 >= 0)

6869 
›ti⁄s
->
key_dúe˘i⁄
 = key_direction;

6871 
îr
;

6873 
›ti⁄s
->
és_auth_fûe
 = 
p
[1];

6875 i‡(
	`°ªq
 (
p
[0], "key-method") &&Ö[1])

6877 
key_mëhod
;

6879 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6880 
key_mëhod
 = 
	`©oi
 (
p
[1]);

6881 i‡(
key_mëhod
 < 
KEY_METHOD_MIN
 || key_mëhod > 
KEY_METHOD_MAX
)

6883 
	`msg
 (
msgÀvñ
, "key_methodÖarameter (%d) must be >= %dánd <= %d",

6884 
key_mëhod
,

6885 
KEY_METHOD_MIN
,

6886 
KEY_METHOD_MAX
);

6887 
îr
;

6889 
›ti⁄s
->
key_mëhod
 = key_method;

6891 #ifde‡
ENABLE_X509ALTUSERNAME


6892 i‡(
	`°ªq
 (
p
[0], "x509-username-field") &&Ö[1])

6901 *
s
 = 
p
[1];

6903 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6904 i‡(
	`°∫cmp
("ext:", 
s
, 4) != 0)

6906 
size_t
 
i
 = 0;

6907 
s
[
i
] && !
	`isuµî
(s[i])) i++;

6908 i‡(
	`°æí
(
s
Ë=
i
)

6910 (*
s
 = 
	`touµî
(*s)) != '\0') s++;

6911 
	`msg
(
M_WARN
, "DEPRECATED FEATURE:áutomatically upcasedÅhe "

6913 "c⁄figuøti⁄", 
p
[1]);

6916 
›ti⁄s
->
x509_u£∫ame_fõld
 = 
p
[1];

6921 #ifde‡
ENABLE_PKCS11


6922 i‡(
	`°ªq
 (
p
[0], "show-pkcs11-ids") &&Ö[1])

6924 *
¥ovidî
 = 
p
[1];

6925 
boﬁ
 
˚π_¥iv©e
 = (
p
[2] =
NULL
 ? 
Ál£
 : ( 
	`©oi
 (p[2]) != 0 ));

6927 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6929 
	`£t_debug_Àvñ
 (
›ti⁄s
->
vîbosôy
, 
SDL_CONSTRAIN
);

6930 
	`show_pkcs11_ids
 (
¥ovidî
, 
˚π_¥iv©e
);

6931 
	`›ív≤_exô
 (
OPENVPN_EXIT_STATUS_GOOD
);

6933 i‡(
	`°ªq
 (
p
[0], "pkcs11-providers") &&Ö[1])

6935 
j
;

6937 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6939 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j] !
NULL
; ++j)

6940 
›ti⁄s
->
pkcs11_¥ovidîs
[
j
-1] = 
p
[j];

6942 i‡(
	`°ªq
 (
p
[0], "pkcs11-protected-authentication"))

6944 
j
;

6946 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6948 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j] !
NULL
; ++j)

6949 
›ti⁄s
->
pkcs11_¥Ÿe˘ed_authítiˇti⁄
[
j
-1] = 
	`©oi
 (
p
[j]) != 0 ? 1 : 0;

6951 i‡(
	`°ªq
 (
p
[0], "pkcs11-private-mode") &&Ö[1])

6953 
j
;

6955 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6957 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j] !
NULL
; ++j)

6958 
	`ssˇnf
 (
p
[
j
], "%x", &(
›ti⁄s
->
pkcs11_¥iv©e_mode
[j-1]));

6960 i‡(
	`°ªq
 (
p
[0], "pkcs11-cert-private"))

6962 
j
;

6964 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6966 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j] !
NULL
; ++j)

6967 
›ti⁄s
->
pkcs11_˚π_¥iv©e
[
j
-1] = 
	`©oi
 (
p
[j]) != 0 ? 1 : 0;

6969 i‡(
	`°ªq
 (
p
[0], "pkcs11-pin-cache") &&Ö[1])

6971 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6972 
›ti⁄s
->
pkcs11_pö_ˇche_≥riod
 = 
	`©oi
 (
p
[1]);

6974 i‡(
	`°ªq
 (
p
[0], "pkcs11-id") &&Ö[1])

6976 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6977 
›ti⁄s
->
pkcs11_id
 = 
p
[1];

6979 i‡(
	`°ªq
 (
p
[0], "pkcs11-id-management"))

6981 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6982 
›ti⁄s
->
pkcs11_id_m™agemít
 = 
åue
;

6985 #ifde‡
ENABLE_FEATURE_TUN_PERSIST


6986 i‡(
	`°ªq
 (
p
[0], "rmtun"))

6988 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6989 
›ti⁄s
->
≥rsi°_c⁄fig
 = 
åue
;

6990 
›ti⁄s
->
≥rsi°_mode
 = 0;

6992 i‡(
	`°ªq
 (
p
[0], "mktun"))

6994 
	`VERIFY_PERMISSION
 (
OPT_P_GENERAL
);

6995 
›ti⁄s
->
≥rsi°_c⁄fig
 = 
åue
;

6996 
›ti⁄s
->
≥rsi°_mode
 = 1;

6999 i‡(
	`°ªq
 (
p
[0], "peer-id"))

7001 
	`VERIFY_PERMISSION
 (
OPT_P_PEER_ID
);

7002 
›ti⁄s
->
u£_≥î_id
 = 
åue
;

7003 
›ti⁄s
->
≥î_id
 = 
	`©oi
(
p
[1]);

7007 
i
;

7008 
msgÀvñ

msgÀvñ_fc
;

7011 
i
=0; 
›ti⁄s
->
ign‹e_unknown_›ti⁄
 && options->ignore_unknown_option[i]; i++)

7013 i‡(
	`°ªq
(
p
[0], 
›ti⁄s
->
ign‹e_unknown_›ti⁄
[
i
]))

7015 
msgÀvñ
 = 
M_WARN
;

7019 i‡(
fûe
)

7020 
	`msg
 (
msgÀvñ
, "Uƒecognized o±i⁄ o∏missögÖ¨amëî(sËö %s:%d: %†(%s)", 
fûe
, 
löe
, 
p
[0], 
PACKAGE_VERSION
);

7022 
	`msg
 (
msgÀvñ
, "Uƒecognized o±i⁄ o∏missögÖ¨amëî(s): --%†(%s)", 
p
[0], 
PACKAGE_VERSION
);

7024 
îr
:

7025 
	`gc_‰ì
 (&
gc
);

7026 
	}
}

	@src/openvpn/options.h

30 #i‚de‡
OPTIONS_H


31 
	#OPTIONS_H


	)

33 
	~"basic.h
"

34 
	~"comm⁄.h
"

35 
	~"mtu.h
"

36 
	~"rouã.h
"

37 
	~"tun.h
"

38 
	~"sockë.h
"

39 
	~"∂ugö.h
"

40 
	~"m™age.h
"

41 
	~"¥oxy.h
"

42 
	~"lzo.h
"

43 
	~"pushli°.h
"

44 
	~"˛ö©.h
"

50 
	#MAX_PARMS
 16

	)

55 
	#OPTION_PARM_SIZE
 256

	)

56 
	#OPTION_LINE_SIZE
 256

	)

58 c⁄° 
tôÀ_°rög
[];

60 #i‡
P2MP


63 
	s›ti⁄s_¥e_puŒ


65 
boﬁ
 
	mtu¡≠_›ti⁄s_deföed
;

66 
tu¡≠_›ti⁄s
 
	mtu¡≠_›ti⁄s
;

68 
boﬁ
 
	mrouãs_deföed
;

69 
rouã_›ti⁄_li°
 *
	mrouãs
;

71 
boﬁ
 
	mrouãs_ùv6_deföed
;

72 
rouã_ùv6_›ti⁄_li°
 *
	mrouãs_ùv6
;

74 #ifde‡
ENABLE_CLIENT_NAT


75 
boﬁ
 
	m˛õ¡_«t_deföed
;

76 
˛õ¡_«t_›ti⁄_li°
 *
	m˛õ¡_«t
;

79 
	mf‹eign_›ti⁄_ödex
;

83 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& !deföed(
ENABLE_CRYPTO_OPENSSL
Ë&& !deföed(
ENABLE_CRYPTO_POLARSSL
)

87 
	sc⁄√˘i⁄_íåy


89 
	m¥Ÿo
;

90 
	mloˇl_p‹t
;

91 
boﬁ
 
	mloˇl_p‹t_deföed
;

92 
	mªmŸe_p‹t
;

93 c⁄° *
	mloˇl
;

94 c⁄° *
	mªmŸe
;

95 
boﬁ
 
	mªmŸe_Êﬂt
;

96 
boﬁ
 
	mböd_deföed
;

97 
boﬁ
 
	mböd_loˇl
;

98 
	mc⁄√˘_ªåy_£c⁄ds
;

99 
boﬁ
 
	mc⁄√˘_ªåy_deföed
;

100 
	mc⁄√˘_ªåy_max
;

101 
	mc⁄√˘_timeout
;

102 
boﬁ
 
	mc⁄√˘_timeout_deföed
;

103 #ifde‡
ENABLE_HTTP_PROXY


104 
hâp_¥oxy_›ti⁄s
 *
	mhâp_¥oxy_›ti⁄s
;

106 #ifde‡
ENABLE_SOCKS


107 c⁄° *
	msocks_¥oxy_£rvî
;

108 
	msocks_¥oxy_p‹t
;

109 c⁄° *
	msocks_¥oxy_authfûe
;

110 
boﬁ
 
	msocks_¥oxy_ªåy
;

113 
	mtun_mtu
;

114 
boﬁ
 
	mtun_mtu_deföed
;

115 
	mtun_mtu_exåa
;

116 
boﬁ
 
	mtun_mtu_exåa_deföed
;

117 
	mlök_mtu
;

118 
boﬁ
 
	mlök_mtu_deföed
;

121 
	mmtu_discovî_ty≥
;

123 
	m‰agmít
;

124 
	mmssfix
;

125 
boﬁ
 
	mmssfix_deÁu…
;

127 #ifde‡
ENABLE_OCC


128 
	mex∂icô_exô_nŸifiˇti⁄
;

131 
	#CE_DISABLED
 (1<<0)

	)

132 
	#CE_MAN_QUERY_PROXY
 (1<<1)

	)

133 
	#CE_MAN_QUERY_REMOTE_UNDEF
 0

	)

134 
	#CE_MAN_QUERY_REMOTE_QUERY
 1

	)

135 
	#CE_MAN_QUERY_REMOTE_ACCEPT
 2

	)

136 
	#CE_MAN_QUERY_REMOTE_MOD
 3

	)

137 
	#CE_MAN_QUERY_REMOTE_SKIP
 4

	)

138 
	#CE_MAN_QUERY_REMOTE_MASK
 (0x07)

	)

139 
	#CE_MAN_QUERY_REMOTE_SHIFT
 (2)

	)

140 
	mÊags
;

143 
	sªmŸe_íåy


145 c⁄° *
	mªmŸe
;

146 
	mªmŸe_p‹t
;

147 
	m¥Ÿo
;

150 
	#CONNECTION_LIST_SIZE
 64

	)

152 
	sc⁄√˘i⁄_li°


154 
	mÀn
;

155 
	mcuºít
;

156 
	mn_cy˛es
;

157 
boﬁ
 
	mno_adv™˚
;

158 
c⁄√˘i⁄_íåy
 *
	m¨øy
[
CONNECTION_LIST_SIZE
];

161 
	sªmŸe_li°


163 
	mÀn
;

164 
ªmŸe_íåy
 *
	m¨øy
[
CONNECTION_LIST_SIZE
];

167 
	sªmŸe_ho°_°‹e


169 
	#RH_HOST_LEN
 80

	)

170 
	mho°
[
RH_HOST_LEN
];

174 
	s›ti⁄s


176 
gc_¨ía
 
	mgc
;

177 
boﬁ
 
	mgc_ow√d
;

180 c⁄° *
	mc⁄fig
;

183 
	#MODE_POINT_TO_POINT
 0

	)

184 
	#MODE_SERVER
 1

	)

185 
	mmode
;

188 
boﬁ
 
	mf‹w¨d_com∑tibÀ
;

190 c⁄° ** 
	mign‹e_unknown_›ti⁄
;

193 
boﬁ
 
	m≥rsi°_c⁄fig
;

194 
	m≥rsi°_mode
;

196 #ifde‡
ENABLE_CRYPTO


197 c⁄° *
	mkey_∑ss_fûe
;

198 
boﬁ
 
	mshow_cùhîs
;

199 
boﬁ
 
	mshow_dige°s
;

200 
boﬁ
 
	mshow_ígöes
;

201 #ifde‡
ENABLE_SSL


202 
boﬁ
 
	mshow_és_cùhîs
;

204 
boﬁ
 
	mgíkey
;

208 
c⁄√˘i⁄_íåy
 
	m˚
;

209 *
	mªmŸe_ù_höt
;

210 
c⁄√˘i⁄_li°
 *
	mc⁄√˘i⁄_li°
;

211 
ªmŸe_li°
 *
	mªmŸe_li°
;

212 
boﬁ
 
	mf‹˚_c⁄√˘i⁄_li°
;

214 #i‡
HTTP_PROXY_OVERRIDE


215 
hâp_¥oxy_›ti⁄s
 *
	mhâp_¥oxy_ovîride
;

218 
ªmŸe_ho°_°‹e
 *
	mrh_°‹e
;

220 
boﬁ
 
	mªmŸe_øndom
;

221 c⁄° *
	mùch™ge
;

222 c⁄° *
	mdev
;

223 c⁄° *
	mdev_ty≥
;

224 c⁄° *
	mdev_node
;

225 c⁄° *
	mŒaddr
;

226 
	mt›ﬁogy
;

227 c⁄° *
	mifc⁄fig_loˇl
;

228 c⁄° *
	mifc⁄fig_ªmŸe_√tmask
;

229 c⁄° *
	mifc⁄fig_ùv6_loˇl
;

230 
	mifc⁄fig_ùv6_√tbôs
;

231 c⁄° *
	mifc⁄fig_ùv6_ªmŸe
;

232 
boﬁ
 
	mifc⁄fig_n€xec
;

233 
boﬁ
 
	mifc⁄fig_now¨n
;

234 #ifde‡
ENABLE_FEATURE_SHAPER


235 
	msh≠î
;

238 
	m¥Ÿo_f‹˚
;

240 #ifde‡
ENABLE_OCC


241 
boﬁ
 
	mmtu_ã°
;

244 #ifde‡
ENABLE_MEMSTATS


245 *
	mmem°©s_‚
;

248 
boﬁ
 
	mmlock
;

250 
	mkì∑live_pög
;

251 
	mkì∑live_timeout
;

253 
	möa˘ivôy_timeout
;

254 
	möa˘ivôy_möimum_byãs
;

256 
	mpög_£nd_timeout
;

257 
	mpög_ªc_timeout
;

258 
boﬁ
 
	mpög_timî_ªmŸe
;

259 
boﬁ
 
	mtun_ùv6
;

261 
	#PING_UNDEF
 0

	)

262 
	#PING_EXIT
 1

	)

263 
	#PING_RESTART
 2

	)

264 
	mpög_ªc_timeout_a˘i⁄
;

266 
boﬁ
 
	m≥rsi°_tun
;

267 
boﬁ
 
	m≥rsi°_loˇl_ù
;

268 
boﬁ
 
	m≥rsi°_ªmŸe_ù
;

269 
boﬁ
 
	m≥rsi°_key
;

271 #i‡
PASSTOS_CAPABILITY


272 
boﬁ
 
	m∑s°os
;

275 
	mªsﬁve_ªåy_£c⁄ds
;

277 
tu¡≠_›ti⁄s
 
	mtu¡≠_›ti⁄s
;

280 c⁄° *
	mu£∫ame
;

281 c⁄° *
	mgrou≤ame
;

282 c⁄° *
	mchroŸ_dú
;

283 c⁄° *
	mcd_dú
;

284 #ifde‡
ENABLE_SELINUX


285 *
	m£löux_c⁄ãxt
;

287 c⁄° *
	mwrôïid
;

288 c⁄° *
	mup_s¸ùt
;

289 c⁄° *
	mdown_s¸ùt
;

290 
boﬁ
 
	mu£r_s¸ùt_u£d
;

291 
boﬁ
 
	mdown_¥e
;

292 
boﬁ
 
	mup_dñay
;

293 
boﬁ
 
	mup_ª°¨t
;

294 
boﬁ
 
	md´m⁄
;

296 
	mªm≠_sigu§1
;

299 
	möëd
;

301 
boﬁ
 
	mlog
;

302 
boﬁ
 
	msuµªss_time°amps
;

303 
	mni˚
;

304 
	mvîbosôy
;

305 
	mmuã
;

307 #ifde‡
ENABLE_DEBUG


308 
	mgªmlö
;

311 c⁄° *
	m°©us_fûe
;

312 
	m°©us_fûe_vîsi⁄
;

313 
	m°©us_fûe_upd©e_‰eq
;

316 
boﬁ
 
	mÁ°_io
;

318 #ifde‡
ENABLE_LZO


320 
	mlzo
;

324 
	mrcvbuf
;

325 
	m¢dbuf
;

328 
	mm¨k
;

331 
	msockÊags
;

334 c⁄° *
	mrouã_s¸ùt
;

335 c⁄° *
	mrouã_¥edown_s¸ùt
;

336 c⁄° *
	mrouã_deÁu…_g©eway
;

337 
	mrouã_deÁu…_mëric
;

338 
boﬁ
 
	mrouã_n€xec
;

339 
	mrouã_dñay
;

340 
	mrouã_dñay_wödow
;

341 
boﬁ
 
	mrouã_dñay_deföed
;

342 
	mmax_rouãs
;

343 
rouã_›ti⁄_li°
 *
	mrouãs
;

344 
rouã_ùv6_›ti⁄_li°
 *
	mrouãs_ùv6
;

345 
boﬁ
 
	mrouã_n›uŒ
;

346 
boﬁ
 
	mrouã_g©eway_vü_dh˝
;

347 
boﬁ
 
	mÆlow_puŒ_fqdn
;

349 #ifde‡
ENABLE_CLIENT_NAT


350 
˛õ¡_«t_›ti⁄_li°
 *
	m˛õ¡_«t
;

353 #ifde‡
ENABLE_OCC


355 
boﬁ
 
	mocc
;

358 #ifde‡
ENABLE_MANAGEMENT


359 c⁄° *
	mm™agemít_addr
;

360 
	mm™agemít_p‹t
;

361 c⁄° *
	mm™agemít_u£r_∑ss
;

362 
	mm™agemít_log_hi°‹y_ˇche
;

363 
	mm™agemít_echo_buf„r_size
;

364 
	mm™agemít_°©e_buf„r_size
;

365 c⁄° *
	mm™agemít_wrôe_≥î_öfo_fûe
;

367 c⁄° *
	mm™agemít_˛õ¡_u£r
;

368 c⁄° *
	mm™agemít_˛õ¡_group
;

371 
	mm™agemít_Êags
;

374 #ifde‡
ENABLE_PLUGIN


375 
∂ugö_›ti⁄_li°
 *
	m∂ugö_li°
;

380 #i‡
P2MP


382 #i‡
P2MP_SERVER


384 c⁄° *
	mtmp_dú
;

385 
boﬁ
 
	m£rvî_deföed
;

386 
ö_addr_t
 
	m£rvî_√tw‹k
;

387 
ö_addr_t
 
	m£rvî_√tmask
;

388 
boﬁ
 
	m£rvî_ùv6_deföed
;

389 
ö6_addr
 
	m£rvî_√tw‹k_ùv6
;

390 
	m£rvî_√tbôs_ùv6
;

392 
	#SF_NOPOOL
 (1<<0)

	)

393 
	#SF_TCP_NODELAY_HELPER
 (1<<1)

	)

394 
	#SF_NO_PUSH_ROUTE_GATEWAY
 (1<<2)

	)

395 
	m£rvî_Êags
;

397 
boﬁ
 
	m£rvî_bridge_¥oxy_dh˝
;

399 
boﬁ
 
	m£rvî_bridge_deföed
;

400 
ö_addr_t
 
	m£rvî_bridge_ù
;

401 
ö_addr_t
 
	m£rvî_bridge_√tmask
;

402 
ö_addr_t
 
	m£rvî_bridge_poﬁ_°¨t
;

403 
ö_addr_t
 
	m£rvî_bridge_poﬁ_íd
;

405 
push_li°
 
	mpush_li°
;

406 
boﬁ
 
	mifc⁄fig_poﬁ_deföed
;

407 
ö_addr_t
 
	mifc⁄fig_poﬁ_°¨t
;

408 
ö_addr_t
 
	mifc⁄fig_poﬁ_íd
;

409 
ö_addr_t
 
	mifc⁄fig_poﬁ_√tmask
;

410 c⁄° *
	mifc⁄fig_poﬁ_≥rsi°_fûíame
;

411 
	mifc⁄fig_poﬁ_≥rsi°_ª‰esh_‰eq
;

413 
boﬁ
 
	mifc⁄fig_ùv6_poﬁ_deföed
;

414 
ö6_addr
 
	mifc⁄fig_ùv6_poﬁ_ba£
;

415 
	mifc⁄fig_ùv6_poﬁ_√tbôs
;

417 
	mªÆ_hash_size
;

418 
	mvútuÆ_hash_size
;

419 c⁄° *
	m˛õ¡_c⁄√˘_s¸ùt
;

420 c⁄° *
	m˛õ¡_disc⁄√˘_s¸ùt
;

421 c⁄° *
	mÀ¨n_addªss_s¸ùt
;

422 c⁄° *
	m˛õ¡_c⁄fig_dú
;

423 
boﬁ
 
	mccd_ex˛usive
;

424 
boﬁ
 
	mdißbÀ
;

425 
	mn_bˇ°_buf
;

426 
	mt˝_queue_limô
;

427 
úouã
 *
	múouãs
;

428 
úouã_ùv6
 *
	múouãs_ùv6
;

429 
boﬁ
 
	mpush_ifc⁄fig_deföed
;

430 
ö_addr_t
 
	mpush_ifc⁄fig_loˇl
;

431 
ö_addr_t
 
	mpush_ifc⁄fig_ªmŸe_√tmask
;

432 #ifde‡
ENABLE_CLIENT_NAT


433 
ö_addr_t
 
	mpush_ifc⁄fig_loˇl_Æüs
;

435 
boﬁ
 
	mpush_ifc⁄fig_c⁄°øöt_deföed
;

436 
ö_addr_t
 
	mpush_ifc⁄fig_c⁄°øöt_√tw‹k
;

437 
ö_addr_t
 
	mpush_ifc⁄fig_c⁄°øöt_√tmask
;

438 
boﬁ
 
	mpush_ifc⁄fig_ùv6_deföed
;

439 
ö6_addr
 
	mpush_ifc⁄fig_ùv6_loˇl
;

440 
	mpush_ifc⁄fig_ùv6_√tbôs
;

441 
ö6_addr
 
	mpush_ifc⁄fig_ùv6_ªmŸe
;

442 
boﬁ
 
	míabÀ_c2c
;

443 
boﬁ
 
	mdu∂iˇã_˙
;

444 
	mcf_max
;

445 
	mcf_≥r
;

446 
	mmax_˛õ¡s
;

447 
	mmax_rouãs_≥r_˛õ¡
;

448 
	m°Æe_rouãs_check_öãrvÆ
;

449 
	m°Æe_rouãs_ageög_time
;

451 c⁄° *
	mauth_u£r_∑ss_vîify_s¸ùt
;

452 
boﬁ
 
	mauth_u£r_∑ss_vîify_s¸ùt_vü_fûe
;

453 #i‡
PORT_SHARE


454 *
	mp‹t_sh¨e_ho°
;

455 
	mp‹t_sh¨e_p‹t
;

456 c⁄° *
	mp‹t_sh¨e_jou∫Æ_dú
;

460 
boﬁ
 
	m˛õ¡
;

461 
boﬁ
 
	mpuŒ
;

462 
	mpush_c⁄töu©i⁄
;

463 
	mpush_›ti⁄_ty≥s_found
;

464 c⁄° *
	mauth_u£r_∑ss_fûe
;

465 
›ti⁄s_¥e_puŒ
 *
	m¥e_puŒ
;

467 
	m£rvî_pﬁl_timeout
;

469 
	mscheduÀd_exô_öãrvÆ
;

471 #ifde‡
ENABLE_CLIENT_CR


472 
°©ic_chÆÀnge_öfo
 
	msc_öfo
;

476 #ifde‡
ENABLE_CRYPTO


478 c⁄° *
	msh¨ed_£¸ë_fûe
;

479 c⁄° *
	msh¨ed_£¸ë_fûe_ölöe
;

480 
	mkey_dúe˘i⁄
;

481 
boﬁ
 
	mcùhî«me_deföed
;

482 c⁄° *
	mcùhî«me
;

483 
boﬁ
 
	mauth«me_deföed
;

484 c⁄° *
	mauth«me
;

485 
	mkeysize
;

486 c⁄° *
	m¥ng_hash
;

487 
	m¥ng_n⁄˚_£¸ë_Àn
;

488 c⁄° *
	mígöe
;

489 
boﬁ
 
	mª∂ay
;

490 
boﬁ
 
	mmuã_ª∂ay_w¨nögs
;

491 
	mª∂ay_wödow
;

492 
	mª∂ay_time
;

493 c⁄° *
	m∑ckë_id_fûe
;

494 
boﬁ
 
	mu£_iv
;

495 
boﬁ
 
	mã°_¸y±o
;

496 #ifde‡
ENABLE_PREDICTION_RESISTANCE


497 
boﬁ
 
	mu£_¥edi˘i⁄_ªsi°™˚
;

500 #ifde‡
ENABLE_SSL


502 
boﬁ
 
	més_£rvî
;

503 
boﬁ
 
	més_˛õ¡
;

504 c⁄° *
	mˇ_fûe
;

505 c⁄° *
	mˇ_∑th
;

506 c⁄° *
	mdh_fûe
;

507 c⁄° *
	m˚π_fûe
;

508 c⁄° *
	mexåa_˚πs_fûe
;

509 c⁄° *
	m¥iv_key_fûe
;

510 c⁄° *
	mpkcs12_fûe
;

511 c⁄° *
	mcùhî_li°
;

512 c⁄° *
	més_vîify
;

513 
	mvîify_x509_ty≥
;

514 c⁄° *
	mvîify_x509_«me
;

515 c⁄° *
	més_exp‹t_˚π
;

516 c⁄° *
	m¸l_fûe
;

518 c⁄° *
	mˇ_fûe_ölöe
;

519 c⁄° *
	m˚π_fûe_ölöe
;

520 c⁄° *
	mexåa_˚πs_fûe_ölöe
;

521 *
	m¥iv_key_fûe_ölöe
;

522 c⁄° *
	mdh_fûe_ölöe
;

523 c⁄° *
	mpkcs12_fûe_ölöe
;

525 
	mns_˚π_ty≥
;

526 
	mªmŸe_˚π_ku
[
MAX_PARMS
];

527 c⁄° *
	mªmŸe_˚π_eku
;

528 
uöt8_t
 *
	mvîify_hash
;

529 
	ms¶_Êags
;

531 #ifde‡
ENABLE_PKCS11


532 c⁄° *
	mpkcs11_¥ovidîs
[
MAX_PARMS
];

533 
	mpkcs11_¥iv©e_mode
[
MAX_PARMS
];

534 
boﬁ
 
	mpkcs11_¥Ÿe˘ed_authítiˇti⁄
[
MAX_PARMS
];

535 
boﬁ
 
	mpkcs11_˚π_¥iv©e
[
MAX_PARMS
];

536 
	mpkcs11_pö_ˇche_≥riod
;

537 c⁄° *
	mpkcs11_id
;

538 
boﬁ
 
	mpkcs11_id_m™agemít
;

541 #ifde‡
ENABLE_CRYPTOAPI


542 c⁄° *
	m¸y±ﬂpi_˚π
;

546 
	mkey_mëhod
;

549 
	més_timeout
;

552 
	mª√gŸüã_byãs
;

553 
	mª√gŸüã_∑ckës
;

554 
	mª√gŸüã_£c⁄ds
;

558 
	mh™dshake_wödow
;

560 #ifde‡
ENABLE_X509ALTUSERNAME


562 *
	mx509_u£∫ame_fõld
;

566 
	må™sôi⁄_wödow
;

569 c⁄° *
	més_auth_fûe
;

570 c⁄° *
	més_auth_fûe_ölöe
;

573 
boﬁ
 
	msögÀ_£ssi⁄
;

575 #ifde‡
ENABLE_PUSH_PEER_INFO


576 
boﬁ
 
	mpush_≥î_öfo
;

579 
boﬁ
 
	més_exô
;

584 #ifde‡
ENABLE_X509_TRACK


585 c⁄° 
x509_åack
 *
	mx509_åack
;

589 
	mf‹eign_›ti⁄_ödex
;

591 #ifde‡
WIN32


592 c⁄° *
	mexô_evít_«me
;

593 
boﬁ
 
	mexô_evít_öôül_°©e
;

594 
boﬁ
 
	mshow_√t_up
;

595 
	mrouã_mëhod
;

598 
boﬁ
 
	mu£_≥î_id
;

599 
uöt32_t
 
	m≥î_id
;

602 
	#°ªq
(
x
, 
y
Ë(!
	`°rcmp
((x), (y)))

	)

607 
	#OPT_P_GENERAL
 (1<<0)

	)

608 
	#OPT_P_UP
 (1<<1)

	)

609 
	#OPT_P_ROUTE
 (1<<2)

	)

610 
	#OPT_P_IPWIN32
 (1<<3)

	)

611 
	#OPT_P_SCRIPT
 (1<<4)

	)

612 
	#OPT_P_SETENV
 (1<<5)

	)

613 
	#OPT_P_SHAPER
 (1<<6)

	)

614 
	#OPT_P_TIMER
 (1<<7)

	)

615 
	#OPT_P_PERSIST
 (1<<8)

	)

616 
	#OPT_P_PERSIST_IP
 (1<<9)

	)

617 
	#OPT_P_COMP
 (1<<10Ë

	)

618 
	#OPT_P_MESSAGES
 (1<<11)

	)

619 
	#OPT_P_CRYPTO
 (1<<12Ë

	)

620 
	#OPT_P_TLS_PARMS
 (1<<13Ë

	)

621 
	#OPT_P_MTU
 (1<<14Ë

	)

622 
	#OPT_P_NICE
 (1<<15)

	)

623 
	#OPT_P_PUSH
 (1<<16)

	)

624 
	#OPT_P_INSTANCE
 (1<<17)

	)

625 
	#OPT_P_CONFIG
 (1<<18)

	)

626 
	#OPT_P_EXPLICIT_NOTIFY
 (1<<19)

	)

627 
	#OPT_P_ECHO
 (1<<20)

	)

628 
	#OPT_P_INHERIT
 (1<<21)

	)

629 
	#OPT_P_ROUTE_EXTRAS
 (1<<22)

	)

630 
	#OPT_P_PULL_MODE
 (1<<23)

	)

631 
	#OPT_P_PLUGIN
 (1<<24)

	)

632 
	#OPT_P_SOCKBUF
 (1<<25)

	)

633 
	#OPT_P_SOCKFLAGS
 (1<<26)

	)

634 
	#OPT_P_CONNECTION
 (1<<27)

	)

635 
	#OPT_P_PEER_ID
 (1<<28)

	)

637 
	#OPT_P_DEFAULT
 (~(
OPT_P_INSTANCE
|
OPT_P_PULL_MODE
))

	)

639 #i‡
P2MP


640 
	#PULL_DEFINED
(
›t
Ë((›t)->
puŒ
)

	)

641 #i‡
P2MP_SERVER


642 
	#PUSH_DEFINED
(
›t
Ë((›t)->
push_li°
)

	)

646 #i‚de‡
PULL_DEFINED


647 
	#PULL_DEFINED
(
›t
Ë(
Ál£
)

	)

650 #i‚de‡
PUSH_DEFINED


651 
	#PUSH_DEFINED
(
›t
Ë(
Ál£
)

	)

654 #ifde‡
WIN32


655 
	#ROUTE_OPTION_FLAGS
(
o
Ë((o)->
rouã_mëhod
 & 
ROUTE_METHOD_MASK
)

	)

657 
	#ROUTE_OPTION_FLAGS
(
o
Ë(0)

	)

660 #ifde‡
ENABLE_FEATURE_SHAPER


661 
	#SHAPER_DEFINED
(
›t
Ë((›t)->
sh≠î
)

	)

663 
	#SHAPER_DEFINED
(
›t
Ë(
Ál£
)

	)

666 #ifde‡
ENABLE_PLUGIN


667 
	#PLUGIN_OPTION_LIST
(
›t
Ë((›t)->
∂ugö_li°
)

	)

669 
	#PLUGIN_OPTION_LIST
(
›t
Ë(
NULL
)

	)

672 #ifde‡
MANAGEMENT_DEF_AUTH


673 
	#MAN_CLIENT_AUTH_ENABLED
(
›t
Ë((›t)->
m™agemít_Êags
 & 
MF_CLIENT_AUTH
)

	)

675 
	#MAN_CLIENT_AUTH_ENABLED
(
›t
Ë(
Ál£
)

	)

678 
∑r£_¨gv
 (
›ti⁄s
 *options,

679 c⁄° 
¨gc
,

680 *
¨gv
[],

681 c⁄° 
msgÀvñ
,

682 c⁄° 
≥rmissi⁄_mask
,

683 *
›ti⁄_ty≥s_found
,

684 
ív_£t
 *
es
);

686 
nŸnuŒ
 (c⁄° *
¨g
, c⁄° *
des¸ùti⁄
);

688 
ußge_smÆl
 ();

690 
show_libøry_vîsi⁄s
(c⁄° 
Êags
);

692 
öô_›ti⁄s
 (
›ti⁄s
 *
o
, c⁄° 
boﬁ
 
öô_gc
);

693 
unöô_›ti⁄s
 (
›ti⁄s
 *
o
);

695 
£ãnv_£âögs
 (
ív_£t
 *
es
, c⁄° 
›ti⁄s
 *
o
);

696 
show_£âögs
 (c⁄° 
›ti⁄s
 *
o
);

698 
boﬁ
 
°rög_deföed_equÆ
 (c⁄° *
s1
, c⁄° *
s2
);

700 #ifde‡
ENABLE_OCC


702 c⁄° *
›ti⁄s_°rög_vîsi⁄
 (c⁄° * 
s
, 
gc_¨ía
 *
gc
);

704 *
›ti⁄s_°rög
 (c⁄° 
›ti⁄s
 *
o
,

705 c⁄° 
‰ame
 *frame,

706 
tu¡≠
 *
â
,

707 
boﬁ
 
ªmŸe
,

708 
gc_¨ía
 *
gc
);

710 
boﬁ
 
›ti⁄s_cmp_equÆ_ß„
 (*
a˘uÆ
, c⁄° *
ex≥˘ed
, 
size_t
 
a˘uÆ_n
);

711 
›ti⁄s_w¨nög_ß„
 (*
a˘uÆ
, c⁄° *
ex≥˘ed
, 
size_t
 
a˘uÆ_n
);

712 
boﬁ
 
›ti⁄s_cmp_equÆ
 (*
a˘uÆ
, c⁄° *
ex≥˘ed
);

713 
›ti⁄s_w¨nög
 (*
a˘uÆ
, c⁄° *
ex≥˘ed
);

717 
›ti⁄s_po°¥o˚ss
 (
›ti⁄s
 *options);

719 
¥e_puŒ_ßve
 (
›ti⁄s
 *
o
);

720 
¥e_puŒ_ª°‹e
 (
›ti⁄s
 *
o
);

722 
boﬁ
 
≠∂y_push_›ti⁄s
 (
›ti⁄s
 *options,

723 
buf„r
 *
buf
,

724 
≥rmissi⁄_mask
,

725 *
›ti⁄_ty≥s_found
,

726 
ív_£t
 *
es
);

728 
›ti⁄s_dëach
 (
›ti⁄s
 *
o
);

730 
›ti⁄s_£rvî_imp‹t
 (
›ti⁄s
 *
o
,

731 c⁄° *
fûíame
,

732 
msgÀvñ
,

733 
≥rmissi⁄_mask
,

734 *
›ti⁄_ty≥s_found
,

735 
ív_£t
 *
es
);

737 
¥e_puŒ_deÁu…
 (
›ti⁄s
 *
o
);

739 
rﬁ_check_Æloc
 (
›ti⁄s
 *options);

741 
∑r£_löe
 (c⁄° *
löe
,

742 *
p
[],

743 c⁄° 
n
,

744 c⁄° *
fûe
,

745 c⁄° 
löe_num
,

746 
msgÀvñ
,

747 
gc_¨ía
 *
gc
);

753 
∑r£_t›ﬁogy
 (c⁄° *
°r
, c⁄° 
msgÀvñ
);

754 c⁄° *
¥öt_t›ﬁogy
 (c⁄° 
t›ﬁogy
);

760 #i‡
P2MP


762 
	#AR_NONE
 0

	)

763 
	#AR_INTERACT
 1

	)

764 
	#AR_NOINTERACT
 2

	)

766 
auth_ªåy_gë
 ();

767 
boﬁ
 
auth_ªåy_£t
 (c⁄° 
msgÀvñ
, c⁄° *
›ti⁄
);

768 c⁄° *
auth_ªåy_¥öt
 ();

772 
›ti⁄s_°rög_imp‹t
 (
›ti⁄s
 *options,

773 c⁄° *
c⁄fig
,

774 c⁄° 
msgÀvñ
,

775 c⁄° 
≥rmissi⁄_mask
,

776 *
›ti⁄_ty≥s_found
,

777 
ív_£t
 *
es
);

779 
boﬁ
 
gë_ùv6_addr
–c⁄° * 
¥efix_°r
, 
ö6_addr
 *
√tw‹k
,

780 * 
√tbôs
, ** 
¥öèbÀ_ùv6
,

781 
msgÀvñ
 );

786 
ölöe
 
boﬁ


787 
	$c⁄√˘i⁄_li°_deföed
 (c⁄° 
›ti⁄s
 *
o
)

789  
o
->
c⁄√˘i⁄_li°
 !
NULL
;

790 
	}
}

792 
ölöe
 

793 
	$c⁄√˘i⁄_li°_£t_no_adv™˚
 (
›ti⁄s
 *
o
)

795 i‡(
o
->
c⁄√˘i⁄_li°
)

796 
o
->
c⁄√˘i⁄_li°
->
no_adv™˚
 = 
åue
;

797 
	}
}

	@src/openvpn/otime.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"Ÿime.h
"

35 
	~"memdbg.h
"

37 
time_t
 
	gnow
 = 0;

39 #i‡
TIME_BACKTRACK_PROTECTION


41 
time_t
 
	gnow_adj
 = 0;

42 
time_t
 
	gnow_u£c
 = 0;

50 
	$upd©e_now
 (c⁄° 
time_t
 
sy°em_time
)

52 c⁄° 
f‹w¨d_thªshﬁd
 = 86400;

53 c⁄° 
backw¨d_åiggî
 = 10;

54 
time_t
 
ªÆ_time
 = 
sy°em_time
 + 
now_adj
;

56 i‡(
ªÆ_time
 > 
now
)

58 c⁄° 
time_t
 
ovîshoŸ
 = 
ªÆ_time
 - 
now
 - 1;

59 i‡(
ovîshoŸ
 > 
f‹w¨d_thªshﬁd
 && 
now_adj
 >= overshoot)

61 
now_adj
 -
ovîshoŸ
;

62 
ªÆ_time
 -
ovîshoŸ
;

64 
now
 = 
ªÆ_time
;

66 i‡(
ªÆ_time
 < 
now
 - 
backw¨d_åiggî
)

67 
now_adj
 +(
now
 - 
ªÆ_time
);

68 
	}
}

71 
	$upd©e_now_u£c
 (
timevÆ
 *
tv
)

73 c⁄° 
time_t
 
œ°
 = 
now
;

74 
	`upd©e_now
 (
tv
->
tv_£c
);

75 i‡(
now
 > 
œ°
 || (now =œ° && 
tv
->
tv_u£c
 > 
now_u£c
))

76 
now_u£c
 = 
tv
->
tv_u£c
;

77 
	}
}

85 
	$tv_°rög
 (c⁄° 
timevÆ
 *
tv
, 
gc_¨ía
 *
gc
)

87 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (64, 
gc
);

88 
	`buf_¥ötf
 (&
out
, "[%d/%d]",

89 (Ë
tv
->
tv_£c
,

90 ()
tv
->
tv_u£c
);

91  
	`BSTR
 (&
out
);

92 
	}
}

100 
	$tv_°rög_abs
 (c⁄° 
timevÆ
 *
tv
, 
gc_¨ía
 *
gc
)

102  
	`time_°rög
 ((
time_t
Ë
tv
->
tv_£c
,

103 (Ë
tv
->
tv_u£c
,

104 
åue
,

105 
gc
);

106 
	}
}

111 
	$time_°rög
 (
time_t
 
t
, 
u£c
, 
boﬁ
 
show_u£c
, 
gc_¨ía
 *
gc
)

113 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (64, 
gc
);

114 
timevÆ
 
tv
;

116 i‡(
t
)

118 
tv
.
tv_£c
 = 
t
;

119 
tv
.
tv_u£c
 = 
u£c
;

123 
	`gëtimeofday
 (&
tv
, 
NULL
);

126 
t
 = 
tv
.
tv_£c
;

127 
	`buf_¥ötf
 (&
out
, "%s", 
	`˘ime
(&
t
));

128 
	`buf_rmèû
 (&
out
, '\n');

130 i‡(
show_u£c
 && 
tv
.
tv_u£c
)

131 
	`buf_¥ötf
 (&
out
, " us=%d", ()
tv
.
tv_u£c
);

133  
	`BSTR
 (&
out
);

134 
	}
}

143 
‰equícy_limô
 *

144 
	$‰equícy_limô_öô
 (
max
, 
≥r
)

146 
‰equícy_limô
 *
f
;

148 
	`ASSERT
 (
max
 >0 && 
≥r
 >= 0);

150 
	`ALLOC_OBJ
 (
f
, 
‰equícy_limô
);

151 
f
->
max
 = max;

152 
f
->
≥r
 =Öer;

153 
f
->
n
 = 0;

154 
f
->
ª£t
 = 0;

155  
f
;

156 
	}
}

159 
	$‰equícy_limô_‰ì
 (
‰equícy_limô
 *
f
)

161 
	`‰ì
 (
f
);

162 
	}
}

164 
boﬁ


165 
	$‰equícy_limô_evít_Ælowed
 (
‰equícy_limô
 *
f
)

167 i‡(
f
->
≥r
)

169 
boﬁ
 
ªt
;

170 i‡(
now
 >
f
->
ª£t
 + f->
≥r
)

172 
f
->
ª£t
 = 
now
;

173 
f
->
n
 = 0;

175 
ªt
 = (++
f
->
n
 <f->
max
);

176  
ªt
;

179  
åue
;

180 
	}
}

182 #ifde‡
TIME_TEST


184 
	$time_ã°
 ()

186 
timevÆ
 
tv
;

187 
time_t
 
t
;

188 
i
;

189 
i
 = 0; i < 10000; ++i)

191 
t
 = 
	`time
(
NULL
);

192 
	`gëtimeofday
 (&
tv
, 
NULL
);

194 
	`msg
 (
M_INFO
, "t=%u s=%u us=%u",

195 ()
t
,

196 ()
tv
.
tv_£c
,

197 ()
tv
.
tv_u£c
);

200 
	}
}

	@src/openvpn/otime.h

25 #i‚de‡
OTIME_H


26 
	#OTIME_H


	)

28 
	~"comm⁄.h
"

29 
	~"öãgî.h
"

30 
	~"buf„r.h
"

32 
	s‰equícy_limô


34 
	mmax
;

35 
	m≥r
;

36 
	mn
;

37 
time_t
 
	mª£t
;

40 
‰equícy_limô
 *
‰equícy_limô_öô
 (
max
, 
≥r
);

41 
‰equícy_limô_‰ì
 (
‰equícy_limô
 *
f
);

42 
boﬁ
 
‰equícy_limô_evít_Ælowed
 (
‰equícy_limô
 *
f
);

45 c⁄° * 
time_°rög
 (
time_t
 
t
, 
u£c
, 
boﬁ
 
show_u£c
, 
gc_¨ía
 *
gc
);

49 c⁄° *
tv_°rög
 (c⁄° 
timevÆ
 *
tv
, 
gc_¨ía
 *
gc
);

50 c⁄° *
tv_°rög_abs
 (c⁄° 
timevÆ
 *
tv
, 
gc_¨ía
 *
gc
);

52 
time_t
 
now
;

54 
time_ã°
 ();

56 #i‡
TIME_BACKTRACK_PROTECTION


58 
upd©e_now
 (c⁄° 
time_t
 
sy°em_time
);

60 
time_t
 
now_u£c
;

61 
upd©e_now_u£c
 (
timevÆ
 *
tv
);

63 
ölöe
 

64 
	$›ív≤_gëtimeofday
 (
timevÆ
 *
tv
, *
tz
)

66 c⁄° 
°©us
 = 
	`gëtimeofday
 (
tv
, 
tz
);

67 i‡(!
°©us
)

69 
	`upd©e_now_u£c
 (
tv
);

70 
tv
->
tv_£c
 = 
now
;

71 
tv
->
tv_u£c
 = 
now_u£c
;

73  
°©us
;

74 
	}
}

76 
ölöe
 

77 
	$upd©e_time
 ()

79 #ifde‡
WIN32


81 
timevÆ
 
tv
;

82 
	`›ív≤_gëtimeofday
 (&
tv
, 
NULL
);

84 
	`upd©e_now
 (
	`time
 (
NULL
));

86 
	}
}

90 
ölöe
 

91 
	$upd©e_time
 ()

93 #i‡
	`deföed
(
WIN32
)

95 
timevÆ
 
tv
;

96 i‡(!
	`gëtimeofday
 (&
tv
, 
NULL
))

98 i‡(
tv
.
tv_£c
 !
now
)

99 
now
 = 
tv
.
tv_£c
;

102 c⁄° 
time_t
 
ªÆ_time
 = 
	`time
 (
NULL
);

103 i‡(
ªÆ_time
 !
now
)

104 
now
 = 
ªÆ_time
;

106 
	}
}

108 
ölöe
 

109 
	$›ív≤_gëtimeofday
 (
timevÆ
 *
tv
, *
tz
)

111  
	`gëtimeofday
 (
tv
, 
tz
);

112 
	}
}

116 
ölöe
 
time_t


117 
	$›ív≤_time
 (
time_t
 *
t
)

119 
	`upd©e_time
 ();

120 i‡(
t
)

121 *
t
 = 
now
;

122  
now
;

123 
	}
}

125 
ölöe
 

126 
	$tv_˛ór
 (
timevÆ
 *
tv
)

128 
tv
->
tv_£c
 = 0;

129 
tv
->
tv_u£c
 = 0;

130 
	}
}

132 
ölöe
 
boﬁ


133 
	$tv_deföed
 (c⁄° 
timevÆ
 *
tv
)

135  
tv
->
tv_£c
 > 0 &&Åv->
tv_u£c
 > 0;

136 
	}
}

139 
ölöe
 

140 
	$tv_subåa˘
 (c⁄° 
timevÆ
 *
tv1
, c⁄° timevÆ *
tv2
, c⁄° 
max_£c⁄ds
)

142 c⁄° 
max_u£c
 = 
max_£c⁄ds
 * 1000000;

143 c⁄° 
£c_diff
 = 
tv1
->
tv_£c
 - 
tv2
->tv_sec;

145 i‡(
£c_diff
 > (()
max_£c⁄ds
 + 10))

146  
max_u£c
;

147 i‡(
£c_diff
 < -(()
max_£c⁄ds
 + 10))

148  -
max_u£c
;

149  
	`c⁄°øö_öt
 (
£c_diff
 * 1000000 + (
tv1
->
tv_u£c
 - 
tv2
->tv_u£c), -
max_u£c
, max_usec);

150 
	}
}

152 
ölöe
 

153 
	$tv_add
 (
timevÆ
 *
de°
, c⁄° timevÆ *
§c
)

155 
de°
->
tv_£c
 +
§c
->tv_sec;

156 
de°
->
tv_u£c
 +
§c
->tv_usec;

157 
de°
->
tv_£c
 +(de°->
tv_u£c
 >> 20);

158 
de°
->
tv_u£c
 &= 0x000FFFFF;

159 i‡(
de°
->
tv_u£c
 >= 1000000)

161 
de°
->
tv_u£c
 -= 1000000;

162 
de°
->
tv_£c
 += 1;

164 
	}
}

166 
ölöe
 
boﬁ


167 
	$tv_…
 (c⁄° 
timevÆ
 *
t1
, c⁄° timevÆ *
t2
)

169 i‡(
t1
->
tv_£c
 < 
t2
->tv_sec)

170  
åue
;

171 i‡(
t1
->
tv_£c
 > 
t2
->tv_sec)

172  
Ál£
;

174  
t1
->
tv_u£c
 < 
t2
->tv_usec;

175 
	}
}

177 
ölöe
 
boﬁ


178 
	$tv_À
 (c⁄° 
timevÆ
 *
t1
, c⁄° timevÆ *
t2
)

180 i‡(
t1
->
tv_£c
 < 
t2
->tv_sec)

181  
åue
;

182 i‡(
t1
->
tv_£c
 > 
t2
->tv_sec)

183  
Ál£
;

185  
t1
->
tv_u£c
 <
t2
->tv_usec;

186 
	}
}

188 
ölöe
 
boﬁ


189 
	$tv_ge
 (c⁄° 
timevÆ
 *
t1
, c⁄° timevÆ *
t2
)

191 i‡(
t1
->
tv_£c
 > 
t2
->tv_sec)

192  
åue
;

193 i‡(
t1
->
tv_£c
 < 
t2
->tv_sec)

194  
Ál£
;

196  
t1
->
tv_u£c
 >
t2
->tv_usec;

197 
	}
}

199 
ölöe
 
boﬁ


200 
	$tv_gt
 (c⁄° 
timevÆ
 *
t1
, c⁄° timevÆ *
t2
)

202 i‡(
t1
->
tv_£c
 > 
t2
->tv_sec)

203  
åue
;

204 i‡(
t1
->
tv_£c
 < 
t2
->tv_sec)

205  
Ál£
;

207  
t1
->
tv_u£c
 > 
t2
->tv_usec;

208 
	}
}

210 
ölöe
 
boﬁ


211 
	$tv_eq
 (c⁄° 
timevÆ
 *
t1
, c⁄° timevÆ *
t2
)

213  
t1
->
tv_£c
 =
t2
->tv_£¯&&Å1->
tv_u£c
 ==Å2->tv_usec;

214 
	}
}

216 
ölöe
 

217 
	$tv_dñè
 (
timevÆ
 *
de°
, c⁄° timevÆ *
t1
, c⁄° timevÆ *
t2
)

219 
£c
 = 
t2
->
tv_£c
 - 
t1
->tv_sec;

220 
u£c
 = 
t2
->
tv_u£c
 - 
t1
->tv_usec;

222 
u£c
 < 0)

224 
u£c
 += 1000000;

225 
£c
 -= 1;

228 i‡(
£c
 < 0)

229 
u£c
 = 
£c
 = 0;

231 
de°
->
tv_£c
 = 
£c
;

232 
de°
->
tv_u£c
 = 
u£c
;

233 
	}
}

235 
	#TV_WITHIN_SIGMA_MAX_SEC
 600

	)

236 
	#TV_WITHIN_SIGMA_MAX_USEC
 (
TV_WITHIN_SIGMA_MAX_SEC
 * 1000000)

	)

241 
ölöe
 
boﬁ


242 
	$tv_wôhö_sigma
 (c⁄° 
timevÆ
 *
t1
, c⁄° timevÆ *
t2
, 
sigma
)

244 c⁄° 
dñè
 = 
	`tv_subåa˘
 (
t1
, 
t2
, 
TV_WITHIN_SIGMA_MAX_SEC
);

245  -()
sigma
 <
dñè
 && delta <= ()sigma;

246 
	}
}

252 
ölöe
 

253 
	$öãrvÆ_óæõ°_wakeup
 (
öãrvÆ_t
 *
wakeup
, 
time_t
 
©
,Åime_à
cuºít
) {

254 i‡(
©
 > 
cuºít
)

256 c⁄° 
öãrvÆ_t
 
dñè
 = (öãrvÆ_tË(
©
 - 
cuºít
);

257 i‡(
dñè
 < *
wakeup
)

258 *
wakeup
 = 
dñè
;

259 i‡(*
wakeup
 < 0)

260 *
wakeup
 = 0;

262 
	}
}

	@src/openvpn/packet_id.c

34 #ifde‡
HAVE_CONFIG_H


35 
	~"c⁄fig.h
"

36 #ñi‡
deföed
(
_MSC_VER
)

37 
	~"c⁄fig-msvc.h
"

40 
	~"syshód.h
"

42 #ifde‡
ENABLE_CRYPTO


44 
	~"∑ckë_id.h
"

45 
	~"misc.h
"

46 
	~"öãgî.h
"

48 
	~"memdbg.h
"

56 
	#SEQ_UNSEEN
 ((
time_t
)0)

	)

57 
	#SEQ_EXPIRED
 ((
time_t
)1)

	)

59 
∑ckë_id_debug_¥öt
 (
msgÀvñ
,

60 c⁄° 
∑ckë_id_ªc
 *
p
,

61 c⁄° 
∑ckë_id_√t
 *
pö
,

62 c⁄° *
mesßge
,

63 
vÆue
);

65 
ölöe
 

66 
	$∑ckë_id_debug
 (
msgÀvñ
,

67 c⁄° 
∑ckë_id_ªc
 *
p
,

68 c⁄° 
∑ckë_id_√t
 *
pö
,

69 c⁄° *
mesßge
,

70 
vÆue
)

72 #ifde‡
ENABLE_DEBUG


73 i‡(
	`u∆ikñy
(
	`check_debug_Àvñ
(
msgÀvñ
)))

74 
	`∑ckë_id_debug_¥öt
 (
msgÀvñ
, 
p
, 
pö
, 
mesßge
, 
vÆue
);

76 
	}
}

79 
	$∑ckë_id_öô
 (
∑ckë_id
 *
p
, 
boﬁ
 
t˝_mode
, 
£q_backåack
, 
time_backåack
, c⁄° *
«me
, 
unô
)

81 
	`dmsg
 (
D_PID_DEBUG
, "PIDÖacket_id_initÅcp_mode=%d seq_backtrack=%dÅime_backtrack=%d",

82 
t˝_mode
,

83 
£q_backåack
,

84 
time_backåack
);

86 
	`ASSERT
 (
p
);

87 
	`CLEAR
 (*
p
);

89 
p
->
ªc
.
«me
 =Çame;

90 
p
->
ªc
.
unô
 = unit;

91 i‡(
£q_backåack
 && !
t˝_mode
)

93 
	`ASSERT
 (
MIN_SEQ_BACKTRACK
 <
£q_backåack
 && seq_backåack <
MAX_SEQ_BACKTRACK
);

94 
	`ASSERT
 (
MIN_TIME_BACKTRACK
 <
time_backåack
 &&Åime_backåack <
MAX_TIME_BACKTRACK
);

95 
	`CIRC_LIST_ALLOC
 (
p
->
ªc
.
£q_li°
, £q_li°, 
£q_backåack
);

96 
p
->
ªc
.
£q_backåack
 = seq_backtrack;

97 
p
->
ªc
.
time_backåack
 =Åime_backtrack;

99 
p
->
ªc
.
öôülized
 = 
åue
;

100 
	}
}

103 
	$∑ckë_id_‰ì
 (
∑ckë_id
 *
p
)

105 i‡(
p
)

107 
	`dmsg
 (
D_PID_DEBUG
, "PIDÖacket_id_free");

108 i‡(
p
->
ªc
.
£q_li°
)

109 
	`‰ì
 (
p
->
ªc
.
£q_li°
);

110 
	`CLEAR
 (*
p
);

112 
	}
}

115 
	$∑ckë_id_add
 (
∑ckë_id_ªc
 *
p
, c⁄° 
∑ckë_id_√t
 *
pö
)

117 c⁄° 
time_t
 
loˇl_now
 = 
now
;

118 i‡(
p
->
£q_li°
)

120 
∑ckë_id_ty≥
 
diff
;

126 i‡(!
	`CIRC_LIST_SIZE
 (
p
->
£q_li°
)

127 || 
pö
->
time
 > 
p
->time

128 || (
pö
->
id
 >(
∑ckë_id_ty≥
)
p
->
£q_backåack


129 && 
pö
->
id
 - (
∑ckë_id_ty≥
)
p
->
£q_backåack
 >Ö->id))

131 
p
->
time
 = 
pö
->time;

132 
p
->
id
 = 0;

133 i‡(
pö
->
id
 > (
∑ckë_id_ty≥
)
p
->
£q_backåack
)

134 
p
->
id
 = 
pö
->id - (
∑ckë_id_ty≥
Ì->
£q_backåack
;

135 
	`CIRC_LIST_RESET
 (
p
->
£q_li°
);

138 
p
->
id
 < 
pö
->id

139 #ifde‡
PID_SIMULATE_BACKTRACK


140 || (
	`gë_øndom
() % 64) < 31

144 
	`CIRC_LIST_PUSH
 (
p
->
£q_li°
, 
SEQ_UNSEEN
);

145 ++
p
->
id
;

148 
diff
 = 
p
->
id
 - 
pö
->id;

149 i‡(
diff
 < (
∑ckë_id_ty≥
Ë
	`CIRC_LIST_SIZE
 (
p
->
£q_li°
)

150 && 
loˇl_now
 > 
SEQ_EXPIRED
)

151 
	`CIRC_LIST_ITEM
 (
p
->
£q_li°
, 
diff
Ë
loˇl_now
;

155 
p
->
time
 = 
pö
->time;

156 
p
->
id
 = 
pö
->id;

158 
	}
}

166 
	$∑ckë_id_ª≠
 (
∑ckë_id_ªc
 *
p
)

168 c⁄° 
time_t
 
loˇl_now
 = 
now
;

169 i‡(
p
->
time_backåack
)

171 
i
;

172 
boﬁ
 
expúe
 = 
Ál£
;

173 
i
 = 0; i < 
	`CIRC_LIST_SIZE
 (
p
->
£q_li°
); ++i)

175 c⁄° 
time_t
 
t
 = 
	`CIRC_LIST_ITEM
 (
p
->
£q_li°
, 
i
);

176 i‡(
t
 =
SEQ_EXPIRED
)

178 i‡(!
expúe
 && 
t
 &&Å + 
p
->
time_backåack
 < 
loˇl_now
)

179 
expúe
 = 
åue
;

180 i‡(
expúe
)

181 
	`CIRC_LIST_ITEM
 (
p
->
£q_li°
, 
i
Ë
SEQ_EXPIRED
;

184 
p
->
œ°_ª≠
 = 
loˇl_now
;

185 
	}
}

191 
boﬁ


192 
	$∑ckë_id_ã°
 (
∑ckë_id_ªc
 *
p
,

193 c⁄° 
∑ckë_id_√t
 *
pö
)

195 
∑ckë_id_ty≥
 
diff
;

197 
	`∑ckë_id_debug
 (
D_PID_DEBUG
, 
p
, 
pö
, "PID_TEST", 0);

199 
	`ASSERT
 (
p
->
öôülized
);

201 i‡(!
pö
->
id
)

202  
Ál£
;

204 i‡(
p
->
£q_backåack
)

212 i‡(
pö
->
time
 =
p
->time)

215 i‡(
pö
->
id
 > 
p
->id)

216  
åue
;

219 
diff
 = 
p
->
id
 - 
pö
->id;

222 i‡(()
diff
 > 
p
->
max_backåack_°©
)

224 
p
->
max_backåack_°©
 = ()
diff
;

225 
	`∑ckë_id_debug
 (
D_PID_DEBUG_LOW
, 
p
, 
pö
, "PID_ERRÑïœy-wödow backåack occuºed",Ö->
max_backåack_°©
);

228 i‡(
diff
 >(
∑ckë_id_ty≥
Ë
	`CIRC_LIST_SIZE
 (
p
->
£q_li°
))

230 
	`∑ckë_id_debug
 (
D_PID_DEBUG_LOW
, 
p
, 
pö
, "PID_ERRÜ¨gêdiff", 
diff
);

231  
Ál£
;

235 c⁄° 
time_t
 
v
 = 
	`CIRC_LIST_ITEM
 (
p
->
£q_li°
, 
diff
);

236 i‡(
v
 == 0)

237  
åue
;

241 
	`∑ckë_id_debug
 (
D_PID_DEBUG_MEDIUM
, 
p
, 
pö
, "PID_ERRÑïœy", 
diff
);

242  
Ál£
;

246 i‡(
pö
->
time
 < 
p
->time)

248 
	`∑ckë_id_debug
 (
D_PID_DEBUG_LOW
, 
p
, 
pö
, "PID_ERRÅime backtrack", 0);

249  
Ál£
;

252  
åue
;

262 i‡(
pö
->
time
 =
p
->time)

263  !
p
->
id
 || 
pö
->id ==Ö->id + 1;

264 i‡(
pö
->
time
 < 
p
->time)

265  
Ál£
;

267  
pö
->
id
 == 1;

269 
	}
}

276 
boﬁ


277 
	$∑ckë_id_ªad
 (
∑ckë_id_√t
 *
pö
, 
buf„r
 *
buf
, 
boﬁ
 
l⁄g_f‹m
)

279 
∑ckë_id_ty≥
 
√t_id
;

280 
√t_time_t
 
√t_time
;

282 
pö
->
id
 = 0;

283 
pö
->
time
 = 0;

285 i‡(!
	`buf_ªad
 (
buf
, &
√t_id
,  (net_id)))

286  
Ál£
;

287 
pö
->
id
 = 
	`¡ohpid
 (
√t_id
);

288 i‡(
l⁄g_f‹m
)

290 i‡(!
	`buf_ªad
 (
buf
, &
√t_time
,  (net_time)))

291  
Ál£
;

292 
pö
->
time
 = 
	`¡ohtime
 (
√t_time
);

294  
åue
;

295 
	}
}

297 
boﬁ


298 
	$∑ckë_id_wrôe
 (c⁄° 
∑ckë_id_√t
 *
pö
, 
buf„r
 *
buf
, 
boﬁ
 
l⁄g_f‹m
, boﬁ 
¥ïíd
)

300 
∑ckë_id_ty≥
 
√t_id
 = 
	`ht⁄pid
 (
pö
->
id
);

301 
√t_time_t
 
√t_time
 = 
	`ht⁄time
 (
pö
->
time
);

303 i‡(
¥ïíd
)

305 i‡(
l⁄g_f‹m
)

307 i‡(!
	`buf_wrôe_¥ïíd
 (
buf
, &
√t_time
,  (net_time)))

308  
Ál£
;

310 i‡(!
	`buf_wrôe_¥ïíd
 (
buf
, &
√t_id
,  (net_id)))

311  
Ál£
;

315 i‡(!
	`buf_wrôe
 (
buf
, &
√t_id
,  (net_id)))

316  
Ál£
;

317 i‡(
l⁄g_f‹m
)

319 i‡(!
	`buf_wrôe
 (
buf
, &
√t_time
,  (net_time)))

320  
Ál£
;

323  
åue
;

324 
	}
}

327 
	$∑ckë_id_√t_¥öt
 (c⁄° 
∑ckë_id_√t
 *
pö
, 
boﬁ
 
¥öt_time°amp
, 
gc_¨ía
 *
gc
)

329 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

331 
	`buf_¥ötf
 (&
out
, "[ #" 
∑ckë_id_f‹m©
, (
∑ckë_id_¥öt_ty≥
)
pö
->
id
);

332 i‡(
¥öt_time°amp
 && 
pö
->
time
)

333 
	`buf_¥ötf
 (&
out
, " /Åimê(" 
∑ckë_id_f‹m©
 ") %s",

334 (
∑ckë_id_¥öt_ty≥
)
pö
->
time
,

335 
	`time_°rög
 (
pö
->
time
, 0, 
Ál£
, 
gc
));

337 
	`buf_¥ötf
 (&
out
, " ]");

338  
	`BSTR
 (&
out
);

339 
	}
}

343 
	$∑ckë_id_≥rsi°_öô
 (
∑ckë_id_≥rsi°
 *
p
)

345 
p
->
fûíame
 = 
NULL
;

346 
p
->
fd
 = -1;

347 
p
->
time
 =Ö->
time_œ°_wrôãn
 = 0;

348 
p
->
id
 =Ö->
id_œ°_wrôãn
 = 0;

349 
	}
}

353 
	$∑ckë_id_≥rsi°_˛o£
 (
∑ckë_id_≥rsi°
 *
p
)

355 i‡(
	`∑ckë_id_≥rsi°_íabÀd
 (
p
))

357 i‡(
	`˛o£
 (
p
->
fd
))

358 
	`msg
 (
D_PID_PERSIST
 | 
M_ERRNO
, "Clo£Éº‹ o¿--ª∂ay-≥rsi° fûê%s", 
p
->
fûíame
);

359 
	`∑ckë_id_≥rsi°_öô
 (
p
);

361 
	}
}

365 
	$∑ckë_id_≥rsi°_lﬂd
 (
∑ckë_id_≥rsi°
 *
p
, c⁄° *
fûíame
)

367 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

368 i‡(!
	`∑ckë_id_≥rsi°_íabÀd
 (
p
))

371 
p
->
fd
 = 
	`∂©f‹m_›í
 (
fûíame
,

372 
O_CREAT
 | 
O_RDWR
 | 
O_BINARY
,

373 
S_IRUSR
 | 
S_IWUSR
);

374 i‡(
p
->
fd
 == -1)

376 
	`msg
 (
D_PID_PERSIST
 | 
M_ERRNO
,

378 
fûíame
);

382 
∑ckë_id_≥rsi°_fûe_image
 
image
;

383 
ssize_t
 
n
;

385 #i‡
	`deföed
(
HAVE_FLOCK
Ë&& deföed(
LOCK_EX
Ë&& deföed(
LOCK_NB
)

386 i‡(
	`Êock
 (
p
->
fd
, 
LOCK_EX
 | 
LOCK_NB
))

387 
	`msg
 (
M_ERR
, "C™nŸ obèöÉx˛usivêlock o¿--ª∂ay-≥rsi° fûê%s", 
fûíame
);

390 
p
->
fûíame
 = filename;

391 
n
 = 
	`ªad
 (
p
->
fd
, &
image
, (image));

392 i‡(
n
 =(
image
))

394 
p
->
time
 =Ö->
time_œ°_wrôãn
 = 
image
.time;

395 
p
->
id
 =Ö->
id_œ°_wrôãn
 = 
image
.id;

396 
	`dmsg
 (
D_PID_PERSIST_DEBUG
, "PID Persist Read from %s: %s",

397 
p
->
fûíame
, 
	`∑ckë_id_≥rsi°_¥öt
 (p, &
gc
));

399 i‡(
n
 == -1)

401 
	`msg
 (
D_PID_PERSIST
 | 
M_ERRNO
,

403 
p
->
fûíame
);

407 
	`gc_‰ì
 (&
gc
);

408 
	}
}

412 
	$∑ckë_id_≥rsi°_ßve
 (
∑ckë_id_≥rsi°
 *
p
)

414 i‡(
	`∑ckë_id_≥rsi°_íabÀd
 (
p
Ë&&Ö->
time
 && (p->timê!p->
time_œ°_wrôãn
 ||

415 
p
->
id
 !p->
id_œ°_wrôãn
))

417 
∑ckë_id_≥rsi°_fûe_image
 
image
;

418 
ssize_t
 
n
;

419 
off_t
 
£ek_ªt
;

420 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

422 
image
.
time
 = 
p
->time;

423 
image
.
id
 = 
p
->id;

424 
£ek_ªt
 = 
	`l£ek
(
p
->
fd
, (
off_t
)0, 
SEEK_SET
);

425 i‡(
£ek_ªt
 =(
off_t
)0)

427 
n
 = 
	`wrôe
(
p
->
fd
, &
image
, (image));

428 i‡(
n
 =(
image
))

430 
p
->
time_œ°_wrôãn
 =Ö->
time
;

431 
p
->
id_œ°_wrôãn
 =Ö->
id
;

432 
	`dmsg
 (
D_PID_PERSIST_DEBUG
, "PID Persist WriteÅo %s: %s",

433 
p
->
fûíame
, 
	`∑ckë_id_≥rsi°_¥öt
 (p, &
gc
));

437 
	`msg
 (
D_PID_PERSIST
 | 
M_ERRNO
,

439 
p
->
fûíame
);

444 
	`msg
 (
D_PID_PERSIST
 | 
M_ERRNO
,

446 
p
->
fûíame
);

448 
	`gc_‰ì
 (&
gc
);

450 
	}
}

454 
	$∑ckë_id_≥rsi°_lﬂd_obj
 (c⁄° 
∑ckë_id_≥rsi°
 *
p
, 
∑ckë_id
 *
pid
)

456 i‡(
p
 && 
pid
 && 
	`∑ckë_id_≥rsi°_íabÀd
 (pË&&Ö->
time
)

458 
pid
->
ªc
.
time
 = 
p
->time;

459 
pid
->
ªc
.
id
 = 
p
->id;

461 
	}
}

464 
	$∑ckë_id_≥rsi°_¥öt
 (c⁄° 
∑ckë_id_≥rsi°
 *
p
, 
gc_¨ía
 *
gc
)

466 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

468 
	`buf_¥ötf
 (&
out
, "[");

470 i‡(
	`∑ckë_id_≥rsi°_íabÀd
 (
p
))

472 
	`buf_¥ötf
 (&
out
, " #" 
∑ckë_id_f‹m©
, (
∑ckë_id_¥öt_ty≥
)
p
->
id
);

473 i‡(
p
->
time
)

474 
	`buf_¥ötf
 (&
out
, " /Åimê(" 
∑ckë_id_f‹m©
 ") %s",

475 (
∑ckë_id_¥öt_ty≥
)
p
->
time
,

476 
	`time_°rög
 (
p
->
time
, 0, 
Ál£
, 
gc
));

479 
	`buf_¥ötf
 (&
out
, " ]");

480  (*)
out
.
d©a
;

481 
	}
}

483 #ifde‡
ENABLE_DEBUG


486 
	$∑ckë_id_debug_¥öt
 (
msgÀvñ
,

487 c⁄° 
∑ckë_id_ªc
 *
p
,

488 c⁄° 
∑ckë_id_√t
 *
pö
,

489 c⁄° *
mesßge
,

490 
vÆue
)

492 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

493 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, &
gc
);

494 
timevÆ
 
tv
;

495 c⁄° 
time_t
 
¥ev_now
 = 
now
;

496 c⁄° 
£q_li°
 *
¶
 = 
p
->seq_list;

497 
i
;

499 
	`CLEAR
 (
tv
);

500 
	`gëtimeofday
 (&
tv
, 
NULL
);

502 
	`buf_¥ötf
 (&
out
, "%†[%d]", 
mesßge
, 
vÆue
);

503 
	`buf_¥ötf
 (&
out
, " [%s-%d] [", 
p
->
«me
,Ö->
unô
);

504 
i
 = 0; 
¶
 !
NULL
 && i < sl->
x_size
; ++i)

506 
c
;

507 
time_t
 
v
;

508 
diff
;

510 
v
 = 
	`CIRC_LIST_ITEM
(
¶
, 
i
);

511 i‡(
v
 =
SEQ_UNSEEN
)

512 
c
 = '_';

513 i‡(
v
 =
SEQ_EXPIRED
)

514 
c
 = 'E';

517 
diff
 = (Ë
¥ev_now
 - 
v
;

518 i‡(
diff
 < 0)

519 
c
 = 'N';

520 i‡(
diff
 < 10)

521 
c
 = '0' + 
diff
;

523 
c
 = '>';

525 
	`buf_¥ötf
(&
out
, "%c", 
c
);

527 
	`buf_¥ötf
 (&
out
, "] " 
time_f‹m©
 ":" 
∑ckë_id_f‹m©
, (
time_ty≥
)
p
->
time
, (
∑ckë_id_¥öt_ty≥
Ì->
id
);

528 i‡(
pö
)

529 
	`buf_¥ötf
 (&
out
, " " 
time_f‹m©
 ":" 
∑ckë_id_f‹m©
, (
time_ty≥
)
pö
->
time
, (
∑ckë_id_¥öt_ty≥
Ìö->
id
);

531 
	`buf_¥ötf
 (&
out
, "Å=" 
time_f‹m©
 "[%d]",

532 (
time_ty≥
)
¥ev_now
,

533 ()(
¥ev_now
 - 
tv
.
tv_£c
));

535 
	`buf_¥ötf
 (&
out
, "Ñ=[%d,%d,%d,%d,%d]",

536 ()(
p
->
œ°_ª≠
 - 
tv
.
tv_£c
),

537 
p
->
£q_backåack
,

538 
p
->
time_backåack
,

539 
p
->
max_backåack_°©
,

540 ()
p
->
öôülized
);

541 i‡(
¶
 !
NULL
)

543 
	`buf_¥ötf
 (&
out
, " sl=[%d,%d,%d,%d]",

544 
¶
->
x_hód
,

545 
¶
->
x_size
,

546 
¶
->
x_ˇp
,

547 
¶
->
x_sizeof
);

551 
	`msg
 (
msgÀvñ
, "%s", 
	`BSTR
(&
out
));

552 
	`gc_‰ì
 (&
gc
);

553 
	}
}

557 #ifde‡
PID_TEST


560 
	$∑ckë_id_öãø˘ive_ã°
 ()

562 
∑ckë_id
 
pid
;

563 
∑ckë_id_√t
 
pö
;

564 
boﬁ
 
l⁄g_f‹m
;

565 
boﬁ
 
cou¡
 = 0;

566 
boﬁ
 
ã°
;

568 c⁄° 
£q_backåack
 = 10;

569 c⁄° 
time_backåack
 = 10;

571 
	`∑ckë_id_öô
 (&
pid
, 
£q_backåack
, 
time_backåack
);

573 
åue
) {

574 
buf
[80];

575 i‡(!
	`fgës
(
buf
, (buf), 
°dö
))

577 
	`upd©e_time
 ();

578 i‡(
	`ssˇnf
 (
buf
, "%lu,%u", &
pö
.
time
, &pö.
id
) == 2)

580 
	`∑ckë_id_ª≠_ã°
 (&
pid
.
ªc
);

581 
ã°
 = 
	`∑ckë_id_ã°
 (&
pid
.
ªc
, &
pö
);

582 
	`¥ötf
 ("∑ckë_id_ã° (" 
time_f‹m©
 ", " 
∑ckë_id_f‹m©
 ")Ñeturned %d\n",

583 (
time_ty≥
)
pö
.
time
,

584 (
∑ckë_id_¥öt_ty≥
)
pö
.
id
,

585 
ã°
);

586 i‡(
ã°
)

587 
	`∑ckë_id_add
 (&
pid
.
ªc
, &
pö
);

591 
l⁄g_f‹m
 = (
cou¡
 < 20);

592 
	`∑ckë_id_Æloc_outgoög
 (&
pid
.
£nd
, &
pö
, 
l⁄g_f‹m
);

593 
	`¥ötf
 ("(" 
time_f‹m©
 "(" 
∑ckë_id_f‹m©
 "), %d)\n",

594 (
time_ty≥
)
pö
.
time
,

595 (
∑ckë_id_¥öt_ty≥
)
pö
.
id
,

596 
l⁄g_f‹m
);

597 i‡(
pid
.
£nd
.
id
 == 10)

598 
pid
.
£nd
.
id
 = 0xFFFFFFF8;

599 ++
cou¡
;

602 
	`∑ckë_id_‰ì
 (&
pid
);

603 
	}
}

	@src/openvpn/packet_id.h

31 #ifde‡
ENABLE_CRYPTO


33 #i‚de‡
PACKET_ID_H


34 
	#PACKET_ID_H


	)

36 
	~"cúc_li°.h
"

37 
	~"buf„r.h
"

38 
	~"îr‹.h
"

39 
	~"Ÿime.h
"

52 
uöt32_t
 
	t∑ckë_id_ty≥
;

53 
uöt32_t
 
	t√t_time_t
;

60 
	#PACKET_ID_WRAP_TRIGGER
 0xFF000000

	)

63 
	#ht⁄pid
(
x
Ë
	`ht⁄l
(x)

	)

66 
	#¡ohpid
(
x
Ë
	`¡ohl
(x)

	)

69 
	#ht⁄time
(
x
Ë
	`ht⁄l
((
√t_time_t
)x)

	)

72 
	#¡ohtime
(
x
Ë((
time_t
)
	`¡ohl
(x))

	)

82 
uöt8_t
 
	t∑ckë_id_ty≥
;

83 
uöt16_t
 
	t√t_time_t
;

85 
	#PACKET_ID_WRAP_TRIGGER
 0x80

	)

87 
	#ht⁄pid
(
x
Ë(x)

	)

88 
	#¡ohpid
(
x
Ë(x)

	)

89 
	#ht⁄time
(
x
Ë
	`ht⁄s
((
√t_time_t
)x)

	)

90 
	#¡ohtime
(
x
Ë((
time_t
)
	`¡ohs
(x))

	)

97 
	#∑ckë_id_f‹m©
 "%u"

	)

98 
	t∑ckë_id_¥öt_ty≥
;

105 
	#MIN_SEQ_BACKTRACK
 0

	)

106 
	#MAX_SEQ_BACKTRACK
 65536

	)

107 
	#DEFAULT_SEQ_BACKTRACK
 64

	)

114 
	#MIN_TIME_BACKTRACK
 0

	)

115 
	#MAX_TIME_BACKTRACK
 600

	)

116 
	#DEFAULT_TIME_BACKTRACK
 15

	)

125 
	#SEQ_REAP_INTERVAL
 5

	)

127 
CIRC_LIST
 (
£q_li°
, 
time_t
);

134 
	s∑ckë_id_ªc


136 
time_t
 
	mœ°_ª≠
;

137 
time_t
 
	mtime
;

138 
∑ckë_id_ty≥
 
	mid
;

139 
	m£q_backåack
;

140 
	mtime_backåack
;

141 
	mmax_backåack_°©
;

142 
boﬁ
 
	möôülized
;

143 
£q_li°
 *
	m£q_li°
;

144 c⁄° *
	m«me
;

145 
	munô
;

152 
	s∑ckë_id_≥rsi°


154 c⁄° *
	mfûíame
;

155 
	mfd
;

156 
time_t
 
	mtime
;

157 
∑ckë_id_ty≥
 
	mid
;

158 
time_t
 
	mtime_œ°_wrôãn
;

159 
∑ckë_id_ty≥
 
	mid_œ°_wrôãn
;

162 
	s∑ckë_id_≥rsi°_fûe_image


164 
time_t
 
	mtime
;

165 
∑ckë_id_ty≥
 
	mid
;

172 
	s∑ckë_id_£nd


174 
∑ckë_id_ty≥
 
	mid
;

175 
time_t
 
	mtime
;

201 
	s∑ckë_id_√t


203 
∑ckë_id_ty≥
 
	mid
;

204 
time_t
 
	mtime
;

207 
	s∑ckë_id


209 
∑ckë_id_£nd
 
	m£nd
;

210 
∑ckë_id_ªc
 
	mªc
;

213 
∑ckë_id_öô
 (
∑ckë_id
 *
p
, 
boﬁ
 
t˝_mode
, 
£q_backåack
, 
time_backåack
, c⁄° *
«me
, 
unô
);

214 
∑ckë_id_‰ì
 (
∑ckë_id
 *
p
);

217 
boﬁ
 
∑ckë_id_ã°
 (
∑ckë_id_ªc
 *
p
,

218 c⁄° 
∑ckë_id_√t
 *
pö
);

221 
∑ckë_id_add
 (
∑ckë_id_ªc
 *
p
,

222 c⁄° 
∑ckë_id_√t
 *
pö
);

225 
∑ckë_id_ª≠
 (
∑ckë_id_ªc
 *
p
);

232 
∑ckë_id_≥rsi°_öô
 (
∑ckë_id_≥rsi°
 *
p
);

235 
∑ckë_id_≥rsi°_˛o£
 (
∑ckë_id_≥rsi°
 *
p
);

238 
∑ckë_id_≥rsi°_lﬂd
 (
∑ckë_id_≥rsi°
 *
p
, c⁄° *
fûíame
);

241 
∑ckë_id_≥rsi°_ßve
 (
∑ckë_id_≥rsi°
 *
p
);

244 
∑ckë_id_≥rsi°_lﬂd_obj
 (c⁄° 
∑ckë_id_≥rsi°
 *
p
, 
∑ckë_id
* 
pid
);

247 c⁄° *
∑ckë_id_≥rsi°_¥öt
 (c⁄° 
∑ckë_id_≥rsi°
 *
p
, 
gc_¨ía
 *
gc
);

254 
boﬁ
 
∑ckë_id_ªad
 (
∑ckë_id_√t
 *
pö
, 
buf„r
 *
buf
, boﬁ 
l⁄g_f‹m
);

255 
boﬁ
 
∑ckë_id_wrôe
 (c⁄° 
∑ckë_id_√t
 *
pö
, 
buf„r
 *
buf
, boﬁ 
l⁄g_f‹m
, boﬁ 
¥ïíd
);

262 
ölöe
 
boﬁ


263 
	$∑ckë_id_≥rsi°_íabÀd
 (c⁄° 
∑ckë_id_≥rsi°
 *
p
)

265  
p
->
fd
 >= 0;

266 
	}
}

269 
ölöe
 

270 
	$∑ckë_id_≥rsi°_ßve_obj
 (
∑ckë_id_≥rsi°
 *
p
, c⁄° 
∑ckë_id
* 
pid
)

272 i‡(
	`∑ckë_id_≥rsi°_íabÀd
 (
p
Ë&& 
pid
->
ªc
.
time
)

274 
p
->
time
 = 
pid
->
ªc
.time;

275 
p
->
id
 = 
pid
->
ªc
.id;

277 
	}
}

279 c⁄° * 
∑ckë_id_√t_¥öt
(c⁄° 
∑ckë_id_√t
 *
pö
, 
boﬁ
 
¥öt_time°amp
, 
gc_¨ía
 *
gc
);

281 #ifde‡
PID_TEST


282 
∑ckë_id_öãø˘ive_ã°
();

285 
ölöe
 

286 
	$∑ckë_id_size
 (
boﬁ
 
l⁄g_f‹m
)

288   (
∑ckë_id_ty≥
Ë+ (
l⁄g_f‹m
 ?  (
√t_time_t
) : 0);

289 
	}
}

291 
ölöe
 
boﬁ


292 
	$∑ckë_id_˛o£_to_wøµög
 (c⁄° 
∑ckë_id_£nd
 *
p
)

294  
p
->
id
 >
PACKET_ID_WRAP_TRIGGER
;

295 
	}
}

302 
ölöe
 

303 
	$∑ckë_id_Æloc_outgoög
 (
∑ckë_id_£nd
 *
p
, 
∑ckë_id_√t
 *
pö
, 
boﬁ
 
l⁄g_f‹m
)

305 i‡(!
p
->
time
)

306 
p
->
time
 = 
now
;

307 
pö
->
id
 = ++
p
->id;

308 i‡(!
pö
->
id
)

310 
	`ASSERT
 (
l⁄g_f‹m
);

311 
p
->
time
 = 
now
;

312 
pö
->
id
 = 
p
->id = 1;

314 
pö
->
time
 = 
p
->time;

315 
	}
}

317 
ölöe
 
boﬁ


318 
	$check_time°amp_dñè
 (
time_t
 
ªmŸe
, 
max_dñè
)

320 
abs
;

321 c⁄° 
time_t
 
loˇl_now
 = 
now
;

323 i‡(
loˇl_now
 >
ªmŸe
)

324 
abs
 = 
loˇl_now
 - 
ªmŸe
;

326 
abs
 = 
ªmŸe
 - 
loˇl_now
;

327  
abs
 <
max_dñè
;

328 
	}
}

330 
ölöe
 

331 
	$∑ckë_id_ª≠_ã°
 (
∑ckë_id_ªc
 *
p
)

333 i‡(
p
->
œ°_ª≠
 + 
SEQ_REAP_INTERVAL
 <
now
)

334 
	`∑ckë_id_ª≠
 (
p
);

335 
	}
}

	@src/openvpn/perf.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"≥rf.h
"

35 #ifde‡
ENABLE_PERFORMANCE_METRICS


37 
	~"îr‹.h
"

38 
	~"Ÿime.h
"

40 
	~"memdbg.h
"

42 c⁄° *
	gmëric_«mes
[] = {

65 
	s≥rf


67 
	#PS_INITIAL
 0

	)

68 
	#PS_METER_RUNNING
 1

	)

69 
	#PS_METER_INTERRUPTED
 2

	)

70 
	m°©e
;

72 
timevÆ
 
	m°¨t
;

73 
	msoÁr
;

74 
	msum
;

75 
	mmax
;

76 
	mcou¡
;

79 
	s≥rf_£t


81 
	m°ack_Àn
;

82 
	m°ack
[
STACK_N
];

83 
≥rf
 
	m≥rf
[
PERF_N
];

86 
≥rf_£t
 
	g≥rf_£t
;

88 
≥rf_¥öt_°©e
 (
Àv
);

90 
ölöe
 

91 
	$gë_°ack_ödex
 (
sdñè
)

93 c⁄° 
södex
 = 
≥rf_£t
.
°ack_Àn
 + 
sdñè
;

94 i‡(
södex
 >0 && södex < 
STACK_N
)

95  
södex
;

98 
	}
}

101 
	$gë_≥rf_ödex
 (
sdñè
)

103 c⁄° 
södex
 = 
	`gë_°ack_ödex
 (
sdñè
);

104 i‡(
södex
 >= 0)

106 c⁄° 
pödex
 = 
≥rf_£t
.
°ack
[
södex
];

107 i‡(
pödex
 >0 &&Öödex < 
PERF_N
)

108  
pödex
;

114 
	}
}

116 
≥rf
 *

117 
	$gë_≥rf
 (
sdñè
)

119 c⁄° 
pödex
 = 
	`gë_≥rf_ödex
 (
sdñè
);

120 i‡(
pödex
 >= 0)

121  &
≥rf_£t
.
≥rf
[
pödex
];

123  
NULL
;

124 
	}
}

127 
	$push_≥rf_ödex
 (
pödex
)

129 c⁄° 
södex
 = 
	`gë_°ack_ödex
 (0);

130 c⁄° 
√wÀn
 = 
	`gë_°ack_ödex
 (1);

131 i‡(
södex
 >0 && 
√wÀn
 >= 0

132 && 
pödex
 >0 &&Öödex < 
PERF_N
)

134 
i
;

135 
i
 = 0; i < 
södex
; ++i)

136 i‡(
≥rf_£t
.
°ack
[
i
] =
pödex
)

138 
	`≥rf_¥öt_°©e
 (
M_INFO
);

139 
	`msg
 (
M_FATAL
, "PERF:Öush_perf_index %s failed",

140 
mëric_«mes
 [
pödex
]);

143 
≥rf_£t
.
°ack
[
södex
] = 
pödex
;

144 
≥rf_£t
.
°ack_Àn
 = 
√wÀn
;

147 
	`msg
 (
M_FATAL
, "PERF:Öush_perf_index: stackÖushÉrror");

148 
	}
}

151 
	$p›_≥rf_ödex
 ()

153 c⁄° 
√wÀn
 = 
	`gë_°ack_ödex
 (-1);

154 i‡(
√wÀn
 >= 0)

156 
≥rf_£t
.
°ack_Àn
 = 
√wÀn
;

159 
	`msg
 (
M_FATAL
, "PERF:Öop_perf_index: stackÖopÉrror");

160 
	}
}

163 
	$°©e_mu°_be
 (c⁄° 
≥rf
 *
p
, c⁄° 
w™ãd
)

165 i‡(
p
->
°©e
 !
w™ãd
)

166 
	`msg
 (
M_FATAL
, "PERF: bad stateáctual=%d wanted=%d",

167 
p
->
°©e
,

168 
w™ãd
);

169 
	}
}

172 
	$upd©e_soÁr
 (
≥rf
 *
p
)

174 
timevÆ
 
cuºít
;

175 
	`ASSERT
 (!
	`gëtimeofday
 (&
cuºít
, 
NULL
));

176 
p
->
soÁr
 +(Ë
	`tv_subåa˘
 (&
cuºít
, &p->
°¨t
, 600) / 1000000.0;

177 
	`tv_˛ór
 (&
p
->
°¨t
);

178 
	}
}

181 
	$≥rf_°¨t
 (
≥rf
 *
p
)

183 
	`°©e_mu°_be
 (
p
, 
PS_INITIAL
);

184 
	`ASSERT
 (!
	`gëtimeofday
 (&
p
->
°¨t
, 
NULL
));

185 
p
->
soÁr
 = 0.0;

186 
p
->
°©e
 = 
PS_METER_RUNNING
;

187 
	}
}

190 
	$≥rf_°›
 (
≥rf
 *
p
)

192 
	`°©e_mu°_be
 (
p
, 
PS_METER_RUNNING
);

193 
	`upd©e_soÁr
 (
p
);

194 
p
->
sum
 +p->
soÁr
;

195 i‡(
p
->
soÁr
 >Ö->
max
)

196 
p
->
max
 =Ö->
soÁr
;

197 
p
->
cou¡
 += 1.0;

198 
p
->
soÁr
 = 0.0;

199 
p
->
°©e
 = 
PS_INITIAL
;

200 
	}
}

203 
	$≥rf_öãºu±
 (
≥rf
 *
p
)

205 
	`°©e_mu°_be
 (
p
, 
PS_METER_RUNNING
);

206 
	`upd©e_soÁr
 (
p
);

207 
p
->
°©e
 = 
PS_METER_INTERRUPTED
;

208 
	}
}

211 
	$≥rf_ªsume
 (
≥rf
 *
p
)

213 
	`°©e_mu°_be
 (
p
, 
PS_METER_INTERRUPTED
);

214 
	`ASSERT
 (!
	`gëtimeofday
 (&
p
->
°¨t
, 
NULL
));

215 
p
->
°©e
 = 
PS_METER_RUNNING
;

216 
	}
}

219 
	$≥rf_push
 (
ty≥
)

221 
≥rf
 *
¥ev
;

222 
≥rf
 *
cur
;

224 
	`ASSERT
 (
	`SIZE
(
mëric_«mes
Ë=
PERF_N
);

225 
	`push_≥rf_ödex
 (
ty≥
);

227 
¥ev
 = 
	`gë_≥rf
 (-2);

228 
cur
 = 
	`gë_≥rf
 (-1);

230 
	`ASSERT
 (
cur
);

232 i‡(
¥ev
)

233 
	`≥rf_öãºu±
 (
¥ev
);

234 
	`≥rf_°¨t
 (
cur
);

235 
	}
}

238 
	$≥rf_p›
 ()

240 
≥rf
 *
¥ev
;

241 
≥rf
 *
cur
;

243 
¥ev
 = 
	`gë_≥rf
 (-2);

244 
cur
 = 
	`gë_≥rf
 (-1);

246 
	`ASSERT
 (
cur
);

247 
	`≥rf_°›
 (
cur
);

249 i‡(
¥ev
)

250 
	`≥rf_ªsume
 (
¥ev
);

252 
	`p›_≥rf_ödex
 ();

253 
	}
}

256 
	$≥rf_ouçut_ªsu…s
 ()

258 
i
;

259 
	`msg
 (
M_INFO
, "LATENCY PROFILE (meanánd maxáre in milliseconds)");

260 
i
 = 0; i < 
PERF_N
; ++i)

262 
≥rf
 *
p
 = &
≥rf_£t
.≥rf[
i
];

263 i‡(
p
->
cou¡
 > 0.0)

265 c⁄° 
món
 = 
p
->
sum
 /Ö->
cou¡
;

266 
	`msg
 (
M_INFO
, "%†n=%.0‡món=%.3‡max=%.3f", 
mëric_«mes
[
i
], 
p
->
cou¡
, 
món
*1000.0,Ö->
max
*1000.0);

269 
	}
}

272 
	$≥rf_¥öt_°©e
 (
Àv
)

274 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

275 
i
;

276 
	`msg
 (
Àv
, "PERF STATE");

277 
	`msg
 (
Àv
, "Stack:");

278 
i
 = 0; i < 
≥rf_£t
.
°ack_Àn
; ++i)

280 c⁄° 
j
 = 
≥rf_£t
.
°ack
[
i
];

281 c⁄° 
≥rf
 *
p
 = &
≥rf_£t
.≥rf[
j
];

282 
	`msg
 (
Àv
, "[%d] %s state=%d start=%s sofar=%f sum=%f max=%f count=%f",

283 
i
,

284 
mëric_«mes
[
j
],

285 
p
->
°©e
,

286 
	`tv_°rög
 (&
p
->
°¨t
, &
gc
),

287 
p
->
soÁr
,

288 
p
->
sum
,

289 
p
->
max
,

290 
p
->
cou¡
);

292 
	`gc_‰ì
 (&
gc
);

293 
	}
}

296 #ifde‡
_MSC_VER


297 
	$dummy
(Ë{
	}
}

	@src/openvpn/perf.h

31 #i‚de‡
PERF_H


32 
	#PERF_H


	)

39 
	#PERF_BIO_READ_PLAINTEXT
 0

	)

40 
	#PERF_BIO_WRITE_PLAINTEXT
 1

	)

41 
	#PERF_BIO_READ_CIPHERTEXT
 2

	)

42 
	#PERF_BIO_WRITE_CIPHERTEXT
 3

	)

43 
	#PERF_TLS_MULTI_PROCESS
 4

	)

44 
	#PERF_IO_WAIT
 5

	)

45 
	#PERF_EVENT_LOOP
 6

	)

46 
	#PERF_MULTI_CREATE_INSTANCE
 7

	)

47 
	#PERF_MULTI_CLOSE_INSTANCE
 8

	)

48 
	#PERF_MULTI_SHOW_STATS
 9

	)

49 
	#PERF_MULTI_BCAST
 10

	)

50 
	#PERF_MULTI_MCAST
 11

	)

51 
	#PERF_SCRIPT
 12

	)

52 
	#PERF_READ_IN_LINK
 13

	)

53 
	#PERF_PROC_IN_LINK
 14

	)

54 
	#PERF_READ_IN_TUN
 15

	)

55 
	#PERF_PROC_IN_TUN
 16

	)

56 
	#PERF_PROC_OUT_LINK
 17

	)

57 
	#PERF_PROC_OUT_TUN
 18

	)

58 
	#PERF_PROC_OUT_TUN_MTCP
 19

	)

59 
	#PERF_N
 20

	)

61 #ifde‡
ENABLE_PERFORMANCE_METRICS


63 
	~"basic.h
"

68 
	#STACK_N
 64

	)

70 
≥rf_push
 (
ty≥
);

71 
≥rf_p›
 ();

72 
≥rf_ouçut_ªsu…s
 ();

76 
ölöe
 
	$≥rf_push
 (
ty≥
Ë{
	}
}

77 
ölöe
 
	$≥rf_p›
 (Ë{
	}
}

78 
ölöe
 
	$≥rf_ouçut_ªsu…s
 (Ë{
	}
}

	@src/openvpn/pf-inline.h

25 #i‡
deföed
(
ENABLE_PF
Ë&& !deföed(
PF_INLINE_H
)

26 
	#PF_INLINE_H


	)

32 
	#PCT_SRC
 1

	)

33 
	#PCT_DEST
 2

	)

34 
ölöe
 
boﬁ


35 
	$pf_c2c_ã°
 (c⁄° 
c⁄ãxt
 *
§c
, c⁄° c⁄ãxà*
de°
, c⁄° *
¥efix
)

37 
boﬁ
 
	`pf_˙_ã°
 (
pf_£t
 *
pfs
, c⁄° 
és_mu…i
 *
tm
, c⁄° 
ty≥
, c⁄° *
¥efix
);

38  (!
§c
->
c2
.
pf
.
íabÀd
 || 
	`pf_˙_ã°
 (§c->c2.pf.
pfs
, 
de°
->c2.
és_mu…i
, 
PCT_DEST
, 
¥efix
))

39 && (!
de°
->
c2
.
pf
.
íabÀd
 || 
	`pf_˙_ã°
 (de°->c2.pf.
pfs
, 
§c
->c2.
és_mu…i
, 
PCT_SRC
, 
¥efix
));

40 
	}
}

42 
ölöe
 
boﬁ


43 
	$pf_addr_ã°
 (c⁄° 
c⁄ãxt
 *
§c
, c⁄° 
mrouã_addr
 *
de°
, c⁄° *
¥efix
)

45 
boﬁ
 
	`pf_addr_ã°_dow‹k
 (c⁄° 
c⁄ãxt
 *
§c
, c⁄° 
mrouã_addr
 *
de°
, c⁄° *
¥efix
);

47 i‡(
§c
->
c2
.
pf
.
íabÀd
)

48  
	`pf_addr_ã°_dow‹k
 (
§c
, 
de°
, 
¥efix
);

50  
åue
;

51 
	}
}

53 
ölöe
 
boﬁ


54 
	$pf_kûl_ã°
 (c⁄° 
pf_£t
 *
pfs
)

56  
pfs
->
kûl
;

57 
	}
}

	@src/openvpn/pf.c

27 #ifde‡
HAVE_CONFIG_H


28 
	~"c⁄fig.h
"

29 #ñi‡
deföed
(
_MSC_VER
)

30 
	~"c⁄fig-msvc.h
"

33 
	~"syshód.h
"

35 #i‡
deföed
(
ENABLE_PF
)

37 
	~"öô.h
"

39 
	~"memdbg.h
"

41 
	~"pf-ölöe.h
"

44 
	$pf_de°roy
 (
pf_£t
 *
pfs
)

46 i‡(
pfs
)

48 i‡(
pfs
->
˙s
.
hash_èbÀ
)

49 
	`hash_‰ì
 (
pfs
->
˙s
.
hash_èbÀ
);

52 
pf_˙_ñem
 *
l
 = 
pfs
->
˙s
.
li°
;

53 
l
)

55 
pf_˙_ñem
 *
√xt
 = 
l
->next;

56 
	`‰ì
 (
l
->
ruÀ
.
˙
);

57 
	`‰ì
 (
l
);

58 
l
 = 
√xt
;

62 
pf_sub√t
 *
l
 = 
pfs
->
¢s
.
li°
;

63 
l
)

65 
pf_sub√t
 *
√xt
 = 
l
->next;

66 
	`‰ì
 (
l
);

67 
l
 = 
√xt
;

70 
	`‰ì
 (
pfs
);

72 
	}
}

74 
boﬁ


75 
	$add_˛õ¡
 (c⁄° *
löe
, c⁄° *
¥efix
, c⁄° 
löe_num
, 
pf_˙_ñem
 ***
√xt
, c⁄° 
boﬁ
 
ex˛ude
)

77 
pf_˙_ñem
 *
e
;

78 
	`ALLOC_OBJ_CLEAR
 (
e
, 
pf_˙_ñem
);

79 
e
->
ruÀ
.
ex˛ude
 =Éxclude;

80 
e
->
ruÀ
.
˙
 = 
	`°rög_Æloc
 (
löe
, 
NULL
);

81 **
√xt
 = 
e
;

82 *
√xt
 = &
e
->next;

83  
åue
;

84 
	}
}

86 
boﬁ


87 
	$add_sub√t
 (c⁄° *
löe
, c⁄° *
¥efix
, c⁄° 
löe_num
, 
pf_sub√t
 ***
√xt
, c⁄° 
boﬁ
 
ex˛ude
)

89 
ö_addr
 
√tw‹k
;

90 
ö_addr_t
 
√tmask
 = 0;

92 i‡(
	`°rcmp
 (
löe
, "unknown"))

94 
√tbôs
 = 32;

95 *
div
 = 
	`°rchr
 (
löe
, '/');

97 i‡(
div
)

99 *
div
++ = '\0';

100 i‡(
	`ssˇnf
 (
div
, "%d", &
√tbôs
) != 1)

102 
	`msg
 (
D_PF_INFO
, "PF: %s/%d: bad '/n' sub√à•ecifõr: '%s'", 
¥efix
, 
löe_num
, 
div
);

103  
Ál£
;

105 i‡(
√tbôs
 < 0 ||Çetbits > 32)

107 
	`msg
 (
D_PF_INFO
, "PF: %s/%d: bad '/n' sub√à•ecifõr: mu° bêbëwì¿0ánd 32: '%s'", 
¥efix
, 
löe_num
, 
div
);

108  
Ál£
;

112 i‡(
	`›ív≤_öë_©⁄
 (
löe
, &
√tw‹k
Ë!
OIA_IP
)

114 
	`msg
 (
D_PF_INFO
, "PF: %s/%d: badÇëw‹káddªss: '%s'", 
¥efix
, 
löe_num
, 
löe
);

115  
Ál£
;

117 
√tmask
 = 
	`√tbôs_to_√tmask
 (
√tbôs
);

118 i‡((
√tw‹k
.
s_addr
 & 
	`ht⁄l
 (
√tmask
)) !=Çetwork.s_addr)

120 
√tw‹k
.
s_addr
 &
	`ht⁄l
 (
√tmask
);

121 
	`msg
 (
M_WARN
, "WARNING: PF: %s/%d: inc‹ª˘ sub√à%s/%d ch™gedÅÿ%s/%d", 
¥efix
, 
löe_num
, 
löe
, 
√tbôs
, 
	`öë_¡ﬂ
 (
√tw‹k
),Çetbits);

127 
√tw‹k
.
s_addr
 = 
	`ht⁄l
(0);

128 
√tmask
 = 
IPV4_NETMASK_HOST
;

132 
pf_sub√t
 *
e
;

133 
	`ALLOC_OBJ_CLEAR
 (
e
, 
pf_sub√t
);

134 
e
->
ruÀ
.
ex˛ude
 =Éxclude;

135 
e
->
ruÀ
.
√tw‹k
 = 
	`¡ohl
 (√tw‹k.
s_addr
);

136 
e
->
ruÀ
.
√tmask
 =Çetmask;

137 **
√xt
 = 
e
;

138 *
√xt
 = &
e
->next;

139  
åue
;

141 
	}
}

143 
uöt32_t


144 
	$˙_hash_fun˘i⁄
 (c⁄° *
key
, 
uöt32_t
 
iv
)

146  
	`hash_func
 ((
uöt8_t
 *)
key
, 
	`°æí
 ((*)keyË+ 1, 
iv
);

147 
	}
}

149 
boﬁ


150 
	$˙_com∑ª_fun˘i⁄
 (c⁄° *
key1
, c⁄° *
key2
)

152  !
	`°rcmp
((c⁄° *)
key1
, (c⁄° *)
key2
);

153 
	}
}

155 
boﬁ


156 
	$gíhash
 (
pf_˙_£t
 *
˙s
, c⁄° *
¥efix
, c⁄° 
n_˛õ¡s
)

158 
pf_˙_ñem
 *
e
;

159 
boﬁ
 
°©us
 = 
åue
;

160 
n_buckës
 = 
n_˛õ¡s
;

162 i‡(
n_buckës
 < 16)

163 
n_buckës
 = 16;

164 
˙s
->
hash_èbÀ
 = 
	`hash_öô
 (
n_buckës
, 0, 
˙_hash_fun˘i⁄
, 
˙_com∑ª_fun˘i⁄
);

165 
e
 = 
˙s
->
li°
;É !
NULL
;É =É->
√xt
)

167 i‡(!
	`hash_add
 (
˙s
->
hash_èbÀ
, 
e
->
ruÀ
.
˙
, &e->ruÀ, 
Ál£
))

169 
	`msg
 (
D_PF_INFO
, "PF: %s: du∂iˇã comm⁄Çamêö [˛õ¡s] se˘i⁄: '%s'", 
¥efix
, 
e
->
ruÀ
.
˙
);

170 
°©us
 = 
Ál£
;

174  
°©us
;

175 
	}
}

177 
pf_£t
 *

178 
	$pf_öô
 (c⁄° 
buf„r_li°
 *
bl
, c⁄° *
¥efix
, c⁄° 
boﬁ
 
Ælow_kûl
)

180 
	#MODE_UNDEF
 0

	)

181 
	#MODE_CLIENTS
 1

	)

182 
	#MODE_SUBNETS
 2

	)

183 
mode
 = 
MODE_UNDEF
;

184 
löe_num
 = 0;

185 
n_˛õ¡s
 = 0;

186 
n_sub√ts
 = 0;

187 
n_îr‹s
 = 0;

188 
pf_£t
 *
pfs
 = 
NULL
;

189 
löe
[
PF_MAX_LINE_LEN
];

191 
	`ALLOC_OBJ_CLEAR
 (
pfs
, 
pf_£t
);

192 i‡(
bl
)

194 
pf_˙_ñem
 **
˛
 = &
pfs
->
˙s
.
li°
;

195 
pf_sub√t
 **
¶
 = &
pfs
->
¢s
.
li°
;

196 
buf„r_íåy
 *
be
;

198 
be
 = 
bl
->
hód
; bê!
NULL
; bêbe->
√xt
)

200 ++
löe_num
;

201 
	`°∫˝y¡
 (
löe
, 
	`BSTR
(&
be
->
buf
), (line));

202 
	`rm_åaûög_ch¨s
 (
löe
, "\r\n\t ");

203 i‡(
löe
[0] == '\0' ||Üine[0] == '#')

205 i‡(
löe
[0] == '+' ||Üine[0] == '-')

207 
boﬁ
 
ex˛ude
 = (
löe
[0] == '-');

209 i‡(
löe
[1] =='\0')

211 
	`msg
 (
D_PF_INFO
, "PF: %s/%d:Çÿd©®a·î +/-: '%s'", 
¥efix
, 
löe_num
, 
löe
);

212 ++
n_îr‹s
;

214 i‡(
mode
 =
MODE_CLIENTS
)

216 i‡(
	`add_˛õ¡
 (&
löe
[1], 
¥efix
, 
löe_num
, &
˛
, 
ex˛ude
))

217 ++
n_˛õ¡s
;

219 ++
n_îr‹s
;

221 i‡(
mode
 =
MODE_SUBNETS
)

223 i‡(
	`add_sub√t
 (&
löe
[1], 
¥efix
, 
löe_num
, &
¶
, 
ex˛ude
))

224 ++
n_sub√ts
;

226 ++
n_îr‹s
;

228 i‡(
mode
 =
MODE_UNDEF
)

232 
	`ASSERT
 (0);

235 i‡(
löe
[0] == '[')

237 i‡(!
	`°rˇ£cmp
 (
löe
, "[clientsáccept]"))

239 
mode
 = 
MODE_CLIENTS
;

240 
pfs
->
˙s
.
deÁu…_Ælow
 = 
åue
;

242 i‡(!
	`°rˇ£cmp
 (
löe
, "[clients drop]"))

244 
mode
 = 
MODE_CLIENTS
;

245 
pfs
->
˙s
.
deÁu…_Ælow
 = 
Ál£
;

247 i‡(!
	`°rˇ£cmp
 (
löe
, "[subnetsáccept]"))

249 
mode
 = 
MODE_SUBNETS
;

250 
pfs
->
¢s
.
deÁu…_Ælow
 = 
åue
;

252 i‡(!
	`°rˇ£cmp
 (
löe
, "[subnets drop]"))

254 
mode
 = 
MODE_SUBNETS
;

255 
pfs
->
¢s
.
deÁu…_Ælow
 = 
Ál£
;

257 i‡(!
	`°rˇ£cmp
 (
löe
, "[end]"))

258 
d⁄e
;

259 i‡(
Ælow_kûl
 && !
	`°rˇ£cmp
 (
löe
, "[kill]"))

260 
kûl
;

263 
mode
 = 
MODE_UNDEF
;

264 
	`msg
 (
D_PF_INFO
, "PF: %s/%d unknow¿èg: '%s'", 
¥efix
, 
löe_num
, 
löe
);

265 ++
n_îr‹s
;

270 
	`msg
 (
D_PF_INFO
, "PF: %s/%dÜöêmu° begö wôh '+', '-', o∏'[' : '%s'", 
¥efix
, 
löe_num
, 
löe
);

271 ++
n_îr‹s
;

274 ++
n_îr‹s
;

275 
	`msg
 (
D_PF_INFO
, "PF: %s: missög [íd]", 
¥efix
);

279 
	`msg
 (
D_PF_INFO
, "PF: %s: c™nŸ o≥n", 
¥efix
);

280 ++
n_îr‹s
;

283 
d⁄e
:

284 i‡(
bl
)

286 i‡(!
n_îr‹s
)

288 i‡(!
	`gíhash
 (&
pfs
->
˙s
, 
¥efix
, 
n_˛õ¡s
))

289 ++
n_îr‹s
;

291 i‡(
n_îr‹s
)

292 
	`msg
 (
D_PF_INFO
, "PF: %†ªje˘ed duêtÿ%dÉº‹(s)", 
¥efix
, 
n_îr‹s
);

294 i‡(
n_îr‹s
)

296 
	`pf_de°roy
 (
pfs
);

297 
pfs
 = 
NULL
;

299  
pfs
;

301 
kûl
:

302 
	`pf_de°roy
 (
pfs
);

303 
	`ALLOC_OBJ_CLEAR
 (
pfs
, 
pf_£t
);

304 
pfs
->
kûl
 = 
åue
;

305  
pfs
;

306 
	}
}

308 #ifde‡
PLUGIN_PF


309 
pf_£t
 *

310 
	$pf_öô_‰om_fûe
 (c⁄° *
‚
)

312 
buf„r_li°
 *
bl
 = 
	`buf„r_li°_fûe
 (
‚
, 
PF_MAX_LINE_LEN
);

313 i‡(
bl
)

315 
pf_£t
 *
pfs
 = 
	`pf_öô
 (
bl
, 
‚
, 
åue
);

316 
	`buf„r_li°_‰ì
 (
bl
);

317  
pfs
;

321 
	`msg
 (
D_PF_INFO
|
M_ERRNO
, "PF: %s: c™nŸ o≥n", 
‚
);

322  
NULL
;

324 
	}
}

327 #ifde‡
ENABLE_DEBUG


330 
	$dr›_ac˚±
 (c⁄° 
boﬁ
 
ac˚±
)

332  
ac˚±
 ? "ACCEPT" : "DROP";

333 
	}
}

336 
	$p˘_«me
 (c⁄° 
ty≥
)

338 
ty≥
)

340 
PCT_SRC
:

342 
PCT_DEST
:

347 
	}
}

350 
	$pf_˙_ã°_¥öt
 (c⁄° *
¥efix
,

351 c⁄° 
ty≥
,

352 c⁄° *
¥efix2
,

353 c⁄° *
˙
,

354 c⁄° 
boﬁ
 
Ælow
,

355 c⁄° 
pf_˙
 *
ruÀ
)

357 i‡(
ruÀ
)

359 
	`dmsg
 (
D_PF_DEBUG
, "PF: %s/%s/%s %s %sÑule=[%s %s]",

360 
¥efix
, 
¥efix2
, 
	`p˘_«me
 (
ty≥
),

361 
˙
, 
	`dr›_ac˚±
 (
Ælow
),

362 
ruÀ
->
˙
, 
	`dr›_ac˚±
 (!ruÀ->
ex˛ude
));

366 
	`dmsg
 (
D_PF_DEBUG
, "PF: %s/%s/%s %s %s",

367 
¥efix
, 
¥efix2
, 
	`p˘_«me
 (
ty≥
),

368 
˙
, 
	`dr›_ac˚±
 (
Ælow
));

370 
	}
}

373 
	$pf_addr_ã°_¥öt
 (c⁄° *
¥efix
,

374 c⁄° *
¥efix2
,

375 c⁄° 
c⁄ãxt
 *
§c
,

376 c⁄° 
mrouã_addr
 *
de°
,

377 c⁄° 
boﬁ
 
Ælow
,

378 c⁄° 
ùv4_sub√t
 *
ruÀ
)

380 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

381 i‡(
ruÀ
)

383 
	`dmsg
 (
D_PF_DEBUG
, "PF: %s/%s %s %s %sÑule=[%s/%s %s]",

384 
¥efix
,

385 
¥efix2
,

386 
	`és_comm⁄_«me
 (
§c
->
c2
.
és_mu…i
, 
Ál£
),

387 
	`mrouã_addr_¥öt_ex
 (
de°
, 
MAPF_SHOW_ARP
, &
gc
),

388 
	`dr›_ac˚±
 (
Ælow
),

389 
	`¥öt_ö_addr_t
 (
ruÀ
->
√tw‹k
, 0, &
gc
),

390 
	`¥öt_ö_addr_t
 (
ruÀ
->
√tmask
, 0, &
gc
),

391 
	`dr›_ac˚±
 (!
ruÀ
->
ex˛ude
));

395 
	`dmsg
 (
D_PF_DEBUG
, "PF: %s/%s %s %s %s",

396 
¥efix
,

397 
¥efix2
,

398 
	`és_comm⁄_«me
 (
§c
->
c2
.
és_mu…i
, 
Ál£
),

399 
	`mrouã_addr_¥öt_ex
 (
de°
, 
MAPF_SHOW_ARP
, &
gc
),

400 
	`dr›_ac˚±
 (
Ælow
));

402 
	`gc_‰ì
 (&
gc
);

403 
	}
}

407 
ölöe
 
pf_˙
 *

408 
	$lookup_˙_ruÀ
 (
hash
 *
h
, c⁄° *
˙
, c⁄° 
uöt32_t
 
˙_hash
)

410 
hash_ñemít
 *
he
 = 
	`hash_lookup_Á°
 (
h
, 
	`hash_buckë
 (h, 
˙_hash
), 
˙
, cn_hash);

411 i‡(
he
)

412  (
pf_˙
 *Ë
he
->
vÆue
;

414  
NULL
;

415 
	}
}

417 
boﬁ


418 
	$pf_˙_ã°
 (
pf_£t
 *
pfs
, c⁄° 
és_mu…i
 *
tm
, c⁄° 
ty≥
, c⁄° *
¥efix
)

420 i‡(
pfs
 && !pfs->
kûl
)

422 c⁄° *
˙
;

423 
uöt32_t
 
˙_hash
;

424 i‡(
	`és_comm⁄_«me_hash
 (
tm
, &
˙
, &
˙_hash
))

426 c⁄° 
pf_˙
 *
ruÀ
 = 
	`lookup_˙_ruÀ
 (
pfs
->
˙s
.
hash_èbÀ
, 
˙
, 
˙_hash
);

427 i‡(
ruÀ
)

429 #ifde‡
ENABLE_DEBUG


430 i‡(
	`check_debug_Àvñ
 (
D_PF_DEBUG
))

431 
	`pf_˙_ã°_¥öt
 ("PF_CN_MATCH", 
ty≥
, 
¥efix
, 
˙
, !
ruÀ
->
ex˛ude
,Ñule);

433 i‡(!
ruÀ
->
ex˛ude
)

434  
åue
;

436  
Ál£
;

440 #ifde‡
ENABLE_DEBUG


441 i‡(
	`check_debug_Àvñ
 (
D_PF_DEBUG
))

442 
	`pf_˙_ã°_¥öt
 ("PF_CN_DEFAULT", 
ty≥
, 
¥efix
, 
˙
, 
pfs
->
˙s
.
deÁu…_Ælow
, 
NULL
);

444 i‡(
pfs
->
˙s
.
deÁu…_Ælow
)

445  
åue
;

447  
Ál£
;

451 #ifde‡
ENABLE_DEBUG


452 i‡(
	`check_debug_Àvñ
 (
D_PF_DEBUG
))

453 
	`pf_˙_ã°_¥öt
 ("PF_CN_FAULT", 
ty≥
, 
¥efix
, 
	`és_comm⁄_«me
 (
tm
, 
Ál£
), fÆ£, 
NULL
);

455  
Ál£
;

456 
	}
}

458 
boﬁ


459 
	$pf_addr_ã°_dow‹k
 (c⁄° 
c⁄ãxt
 *
§c
, c⁄° 
mrouã_addr
 *
de°
, c⁄° *
¥efix
)

461 
pf_£t
 *
pfs
 = 
§c
->
c2
.
pf
.pfs;

462 i‡(
pfs
 && !pfs->
kûl
)

464 c⁄° 
ö_addr_t
 
addr
 = 
	`ö_addr_t_‰om_mrouã_addr
 (
de°
);

465 c⁄° 
pf_sub√t
 *
£
 = 
pfs
->
¢s
.
li°
;

466 
£
)

468 i‡((
addr
 & 
£
->
ruÀ
.
√tmask
Ë=£->ruÀ.
√tw‹k
)

470 #ifde‡
ENABLE_DEBUG


471 i‡(
	`check_debug_Àvñ
 (
D_PF_DEBUG
))

472 
	`pf_addr_ã°_¥öt
 ("PF_ADDR_MATCH", 
¥efix
, 
§c
, 
de°
, !
£
->
ruÀ
.
ex˛ude
, &se->rule);

474  !
£
->
ruÀ
.
ex˛ude
;

476 
£
 = se->
√xt
;

478 #ifde‡
ENABLE_DEBUG


479 i‡(
	`check_debug_Àvñ
 (
D_PF_DEBUG
))

480 
	`pf_addr_ã°_¥öt
 ("PF_ADDR_DEFAULT", 
¥efix
, 
§c
, 
de°
, 
pfs
->
¢s
.
deÁu…_Ælow
, 
NULL
);

482  
pfs
->
¢s
.
deÁu…_Ælow
;

486 #ifde‡
ENABLE_DEBUG


487 i‡(
	`check_debug_Àvñ
 (
D_PF_DEBUG
))

488 
	`pf_addr_ã°_¥öt
 ("PF_ADDR_FAULT", 
¥efix
, 
§c
, 
de°
, 
Ál£
, 
NULL
);

490  
Ál£
;

492 
	}
}

494 #ifde‡
PLUGIN_PF


496 
	$pf_check_ªlﬂd
 (
c⁄ãxt
 *
c
)

498 c⁄° 
¶ow_wakeup
 = 15;

499 c⁄° 
Á°_wakeup
 = 1;

500 c⁄° 
wakeup_å™sôi⁄
 = 60;

501 
boﬁ
 
ªlﬂded
 = 
Ál£
;

503 i‡(
c
->
c2
.
pf
.
íabÀd


504 && 
c
->
c2
.
pf
.
fûíame


505 && 
	`evít_timeout_åiggî
 (&
c
->
c2
.
pf
.
ªlﬂd
, &c->c2.
timevÆ
, 
ETT_DEFAULT
))

507 
∂©f‹m_°©_t
 
s
;

508 i‡(!
	`∂©f‹m_°©
 (
c
->
c2
.
pf
.
fûíame
, &
s
))

510 i‡(
s
.
°_mtime
 > 
c
->
c2
.
pf
.
fûe_œ°_mod
)

512 
pf_£t
 *
pfs
 = 
	`pf_öô_‰om_fûe
 (
c
->
c2
.
pf
.
fûíame
);

513 i‡(
pfs
)

515 i‡(
c
->
c2
.
pf
.
pfs
)

516 
	`pf_de°roy
 (
c
->
c2
.
pf
.
pfs
);

517 
c
->
c2
.
pf
.
pfs
 =Öfs;

518 
ªlﬂded
 = 
åue
;

519 i‡(
	`pf_kûl_ã°
 (
pfs
))

521 
c
->
sig
->
sig«l_ª˚ived
 = 
SIGTERM
;

522 
c
->
sig
->
sig«l_ãxt
 = "pf-kill";

525 
c
->
c2
.
pf
.
fûe_œ°_mod
 = 
s
.
°_mtime
;

529 
wakeup
 = 
¶ow_wakeup
;

530 i‡(!
c
->
c2
.
pf
.
pfs
 && c->c2.pf.
n_check_ªlﬂd
 < 
wakeup_å™sôi⁄
)

531 
wakeup
 = 
Á°_wakeup
;

532 
	`evít_timeout_öô
 (&
c
->
c2
.
pf
.
ªlﬂd
, 
wakeup
, 
now
);

533 
	`ª£t_cﬂr£_timîs
 (
c
);

534 
c
->
c2
.
pf
.
n_check_ªlﬂd
++;

537 #ifde‡
ENABLE_DEBUG


538 i‡(
ªlﬂded
 && 
	`check_debug_Àvñ
 (
D_PF_DEBUG
))

539 
	`pf_c⁄ãxt_¥öt
 (&
c
->
c2
.
pf
, "pf_check_ªlﬂd", 
D_PF_DEBUG
);

541 
	}
}

544 #ifde‡
MANAGEMENT_PF


545 
boﬁ


546 
	$pf_lﬂd_‰om_buf„r_li°
 (
c⁄ãxt
 *
c
, c⁄° 
buf„r_li°
 *
c⁄fig
)

548 
pf_£t
 *
pfs
 = 
	`pf_öô
 (
c⁄fig
, "[SERVER-PF]", 
Ál£
);

549 i‡(
pfs
)

551 i‡(
c
->
c2
.
pf
.
pfs
)

552 
	`pf_de°roy
 (
c
->
c2
.
pf
.
pfs
);

553 
c
->
c2
.
pf
.
pfs
 =Öfs;

554  
åue
;

557  
Ál£
;

558 
	}
}

562 
	$pf_öô_c⁄ãxt
 (
c⁄ãxt
 *
c
)

564 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

565 #ifde‡
PLUGIN_PF


566 i‡(
	`∂ugö_deföed
 (
c
->
∂ugös
, 
OPENVPN_PLUGIN_ENABLE_PF
))

568 c⁄° *
pf_fûe
 = 
	`¸óã_ãmp_fûe
 (
c
->
›ti⁄s
.
tmp_dú
, "pf", &
gc
);

569 if–
pf_fûe
 ) {

570 
	`£ãnv_°r
 (
c
->
c2
.
es
, "pf_fûe", 
pf_fûe
);

572 i‡(
	`∂ugö_ˇŒ
 (
c
->
∂ugös
, 
OPENVPN_PLUGIN_ENABLE_PF
, 
NULL
, NULL, c->
c2
.
es
Ë=
OPENVPN_PLUGIN_FUNC_SUCCESS
)

574 
	`evít_timeout_öô
 (&
c
->
c2
.
pf
.
ªlﬂd
, 1, 
now
);

575 
c
->
c2
.
pf
.
fûíame
 = 
	`°rög_Æloc
 (
pf_fûe
, &c->c2.
gc
);

576 
c
->
c2
.
pf
.
íabÀd
 = 
åue
;

577 #ifde‡
ENABLE_DEBUG


578 i‡(
	`check_debug_Àvñ
 (
D_PF_DEBUG
))

579 
	`pf_c⁄ãxt_¥öt
 (&
c
->
c2
.
pf
, "pf_öô_c⁄ãxt#1", 
D_PF_DEBUG
);

584 
	`msg
 (
M_WARN
, "WARNING: OPENVPN_PLUGIN_ENABLE_PF disabled");

589 #ifde‡
MANAGEMENT_PF


590 i‡(!
c
->
c2
.
pf
.
íabÀd
 && 
	`m™agemít_íabÀ_pf
 (
m™agemít
))

592 
c
->
c2
.
pf
.
íabÀd
 = 
åue
;

593 #ifde‡
ENABLE_DEBUG


594 i‡(
	`check_debug_Àvñ
 (
D_PF_DEBUG
))

595 
	`pf_c⁄ãxt_¥öt
 (&
c
->
c2
.
pf
, "pf_öô_c⁄ãxt#2", 
D_PF_DEBUG
);

599 
	`gc_‰ì
 (&
gc
);

600 
	}
}

603 
	$pf_de°roy_c⁄ãxt
 (
pf_c⁄ãxt
 *
pfc
)

605 #ifde‡
PLUGIN_PF


606 i‡(
pfc
->
fûíame
)

608 
	`∂©f‹m_u∆ök
 (
pfc
->
fûíame
);

611 i‡(
pfc
->
pfs
)

612 
	`pf_de°roy
 (
pfc
->
pfs
);

613 
	}
}

615 #ifde‡
ENABLE_DEBUG


618 
	$pf_sub√t_£t_¥öt
 (c⁄° 
pf_sub√t_£t
 *
s
, c⁄° 
Àv
)

620 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

621 i‡(
s
)

623 
pf_sub√t
 *
e
;

625 
	`msg
 (
Àv
, " ----- structÖf_subnet_set -----");

626 
	`msg
 (
Àv
, " deÁu…_Ælow=%s", 
	`dr›_ac˚±
 (
s
->
deÁu…_Ælow
));

628 
e
 = 
s
->
li°
;É !
NULL
;É =É->
√xt
)

630 
	`msg
 (
Àv
, " %s/%s %s",

631 
	`¥öt_ö_addr_t
 (
e
->
ruÀ
.
√tw‹k
, 0, &
gc
),

632 
	`¥öt_ö_addr_t
 (
e
->
ruÀ
.
√tmask
, 0, &
gc
),

633 
	`dr›_ac˚±
 (!
e
->
ruÀ
.
ex˛ude
));

636 
	`gc_‰ì
 (&
gc
);

637 
	}
}

640 
	$pf_˙_£t_¥öt
 (c⁄° 
pf_˙_£t
 *
s
, c⁄° 
Àv
)

642 i‡(
s
)

644 
hash_ôî©‹
 
hi
;

645 
hash_ñemít
 *
he
;

647 
	`msg
 (
Àv
, " ----- structÖf_cn_set -----");

648 
	`msg
 (
Àv
, " deÁu…_Ælow=%s", 
	`dr›_ac˚±
 (
s
->
deÁu…_Ælow
));

650 i‡(
s
->
hash_èbÀ
)

652 
	`hash_ôî©‹_öô
 (
s
->
hash_èbÀ
, &
hi
);

653 (
he
 = 
	`hash_ôî©‹_√xt
 (&
hi
)))

655 
pf_˙
 *
e
 = (pf_˙ *)
he
->
vÆue
;

656 
	`msg
 (
Àv
, " %s %s",

657 
e
->
˙
,

658 
	`dr›_ac˚±
 (!
e
->
ex˛ude
));

661 
	`msg
 (
Àv
, " ----------");

664 
pf_˙_ñem
 *
˚
;

665 
˚
 = 
s
->
li°
; cê!
NULL
; cê˚->
√xt
)

667 
pf_˙
 *
e
 = 
	`lookup_˙_ruÀ
 (
s
->
hash_èbÀ
, 
˚
->
ruÀ
.
˙
, 
	`˙_hash_fun˘i⁄
 (ce->rule.cn, 0));

668 i‡(
e
)

670 
	`msg
 (
Àv
, " %s %s",

671 
e
->
˙
,

672 
	`dr›_ac˚±
 (!
e
->
ex˛ude
));

676 
	`msg
 (
Àv
, " %†LOOKUP FAILED", 
˚
->
ruÀ
.
˙
);

682 
	}
}

685 
	$pf_£t_¥öt
 (c⁄° 
pf_£t
 *
pfs
, c⁄° 
Àv
)

687 i‡(
pfs
)

689 
	`msg
 (
Àv
, " ----- structÖf_set -----");

690 
	`msg
 (
Àv
, " kûl=%d", 
pfs
->
kûl
);

691 
	`pf_sub√t_£t_¥öt
 (&
pfs
->
¢s
, 
Àv
);

692 
	`pf_˙_£t_¥öt
 (&
pfs
->
˙s
, 
Àv
);

694 
	}
}

697 
	$pf_c⁄ãxt_¥öt
 (c⁄° 
pf_c⁄ãxt
 *
pfc
, c⁄° *
¥efix
, c⁄° 
Àv
)

699 
	`msg
 (
Àv
, "----- %†: såu˘Öf_c⁄ãxà-----", 
¥efix
);

700 i‡(
pfc
)

702 
	`msg
 (
Àv
, "íabÀd=%d", 
pfc
->
íabÀd
);

703 #ifde‡
PLUGIN_PF


704 
	`msg
 (
Àv
, "fûíame='%s'", 
	`≈
(
pfc
->
fûíame
));

705 
	`msg
 (
Àv
, "fûe_œ°_mod=%u", ()
pfc
->
fûe_œ°_mod
);

706 
	`msg
 (
Àv
, "n_check_ªlﬂd=%u", 
pfc
->
n_check_ªlﬂd
);

707 
	`msg
 (
Àv
, "ªlﬂd=[%d,%u,%u]", 
pfc
->
ªlﬂd
.
deföed
,Öfc->ªlﬂd.
n
, (Ìfc->ªlﬂd.
œ°
);

709 
	`pf_£t_¥öt
 (
pfc
->
pfs
, 
Àv
);

711 
	`msg
 (
Àv
, "--------------------");

712 
	}
}

	@src/openvpn/pf.h

27 #i‡
deföed
(
ENABLE_PF
Ë&& !deföed(
OPENVPN_PF_H
)

28 
	#OPENVPN_PF_H


	)

30 
	~"li°.h
"

31 
	~"mrouã.h
"

33 
	#PF_MAX_LINE_LEN
 256

	)

35 
	gc⁄ãxt
;

37 
	sùv4_sub√t
 {

38 
boﬁ
 
	mex˛ude
;

39 
ö_addr_t
 
	m√tw‹k
;

40 
ö_addr_t
 
	m√tmask
;

43 
	spf_sub√t
 {

44 
pf_sub√t
 *
	m√xt
;

45 
ùv4_sub√t
 
	mruÀ
;

48 
	spf_sub√t_£t
 {

49 
boﬁ
 
	mdeÁu…_Ælow
;

50 
pf_sub√t
 *
	mli°
;

53 
	spf_˙
 {

54 
boﬁ
 
	mex˛ude
;

55 *
	m˙
;

58 
	spf_˙_ñem
 {

59 
pf_˙_ñem
 *
	m√xt
;

60 
pf_˙
 
	mruÀ
;

63 
	spf_˙_£t
 {

64 
boﬁ
 
	mdeÁu…_Ælow
;

65 
pf_˙_ñem
 *
	mli°
;

66 
hash
 *
	mhash_èbÀ
;

69 
	spf_£t
 {

70 
boﬁ
 
	mkûl
;

71 
pf_sub√t_£t
 
	m¢s
;

72 
pf_˙_£t
 
	m˙s
;

75 
	spf_c⁄ãxt
 {

76 
boﬁ
 
	míabÀd
;

77 
pf_£t
 *
	mpfs
;

78 #ifde‡
PLUGIN_PF


79 *
	mfûíame
;

80 
time_t
 
	mfûe_œ°_mod
;

81 
	mn_check_ªlﬂd
;

82 
evít_timeout
 
	mªlﬂd
;

86 
pf_öô_c⁄ãxt
 (
c⁄ãxt
 *
c
);

88 
pf_de°roy_c⁄ãxt
 (
pf_c⁄ãxt
 *
pfc
);

90 #ifde‡
PLUGIN_PF


91 
pf_check_ªlﬂd
 (
c⁄ãxt
 *
c
);

94 #ifde‡
MANAGEMENT_PF


95 
boﬁ
 
pf_lﬂd_‰om_buf„r_li°
 (
c⁄ãxt
 *
c
, c⁄° 
buf„r_li°
 *
c⁄fig
);

98 #ifde‡
ENABLE_DEBUG


99 
pf_c⁄ãxt_¥öt
 (c⁄° 
pf_c⁄ãxt
 *
pfc
, c⁄° *
¥efix
, c⁄° 
Àv
);

	@src/openvpn/ping-inline.h

25 #i‚de‡
PING_INLINE_H


26 
	#PING_INLINE_H


	)

32 
ölöe
 

33 
	$check_pög_ª°¨t
 (
c⁄ãxt
 *
c
)

35 
	`check_pög_ª°¨t_dow‹k
 (
c⁄ãxt
 *
c
);

36 i‡(
c
->
›ti⁄s
.
pög_ªc_timeout


37 && 
	`evít_timeout_åiggî
 (&
c
->
c2
.
pög_ªc_öãrvÆ
,

38 &
c
->
c2
.
timevÆ
,

39 (!
c
->
›ti⁄s
.
pög_timî_ªmŸe


40 || 
	`lök_sockë_a˘uÆ_deföed
 (&
c
->
c1
.
lök_sockë_addr
.
a˘uÆ
))

41 ? 
ETT_DEFAULT
 : 15))

42 
	`check_pög_ª°¨t_dow‹k
 (
c
);

43 
	}
}

48 
ölöe
 

49 
	$check_pög_£nd
 (
c⁄ãxt
 *
c
)

51 
	`check_pög_£nd_dow‹k
 (
c⁄ãxt
 *
c
);

52 i‡(
c
->
›ti⁄s
.
pög_£nd_timeout


53 && 
	`evít_timeout_åiggî
 (&
c
->
c2
.
pög_£nd_öãrvÆ
,

54 &
c
->
c2
.
timevÆ
,

55 !
	`TO_LINK_DEF
(
c
Ë? 
ETT_DEFAULT
 : 1))

56 
	`check_pög_£nd_dow‹k
 (
c
);

57 
	}
}

	@src/openvpn/ping.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"pög.h
"

35 
	~"memdbg.h
"

37 
	~"pög-ölöe.h
"

46 c⁄° 
uöt8_t
 
	gpög_°rög
[] = {

56 
	$check_pög_ª°¨t_dow‹k
 (
c⁄ãxt
 *
c
)

58 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

59 
c
->
›ti⁄s
.
pög_ªc_timeout_a˘i⁄
)

61 
PING_EXIT
:

62 
	`msg
 (
M_INFO
, "%sInactivityÅimeout (--ping-exit),Éxiting",

63 
	`f‹m©_comm⁄_«me
 (
c
, &
gc
));

64 
c
->
sig
->
sig«l_ª˚ived
 = 
SIGTERM
;

65 
c
->
sig
->
sig«l_ãxt
 = "ping-exit";

67 
PING_RESTART
:

68 
	`msg
 (
M_INFO
, "%sInactivityÅimeout (--ping-restart),Ñestarting",

69 
	`f‹m©_comm⁄_«me
 (
c
, &
gc
));

70 
c
->
sig
->
sig«l_ª˚ived
 = 
SIGUSR1
;

71 
c
->
sig
->
sig«l_ãxt
 = "ping-restart";

74 
	`ASSERT
 (0);

76 
	`gc_‰ì
 (&
gc
);

77 
	}
}

83 
	$check_pög_£nd_dow‹k
 (
c⁄ãxt
 *
c
)

85 
c
->
c2
.
buf
 = c->c2.
buf„rs
->
aux_buf
;

86 
	`ASSERT
 (
	`buf_öô
 (&
c
->
c2
.
buf
, 
	`FRAME_HEADROOM
 (&c->c2.
‰ame
)));

87 
	`ASSERT
 (
	`buf_ß„
 (&
c
->
c2
.
buf
, 
	`MAX_RW_SIZE_TUN
 (&c->c2.
‰ame
)));

88 
	`ASSERT
 (
	`buf_wrôe
 (&
c
->
c2
.
buf
, 
pög_°rög
,  (ping_string)));

94 
	`í¸y±_sign
 (
c
, 
åue
);

96 
c
->
c2
.
buf
.
Àn
 = 0;

97 
	`dmsg
 (
D_PING
, "SENT PING");

98 
	}
}

	@src/openvpn/ping.h

25 #i‚de‡
PING_H


26 
	#PING_H


	)

28 
	~"öô.h
"

29 
	~"f‹w¨d.h
"

34 
	#PRE_PULL_INITIAL_PING_RESTART
 120

	)

36 c⁄° 
uöt8_t
 
pög_°rög
[];

39 
	#PING_STRING_SIZE
 16

	)

41 
ölöe
 
boﬁ


42 
	$is_pög_msg
 (c⁄° 
buf„r
* 
buf
)

44  
	`buf_°rög_m©ch
 (
buf
, 
pög_°rög
, 
PING_STRING_SIZE
);

45 
	}
}

	@src/openvpn/pkcs11.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #i‡
deföed
(
ENABLE_PKCS11
)

35 
	~<pkcs11-hñ≥r-1.0/pkcs11h-˚πifiˇã.h
>

36 
	~"basic.h
"

37 
	~"îr‹.h
"

38 
	~"m™age.h
"

39 
	~"ba£64.h
"

40 
	~"pkcs11.h
"

41 
	~"misc.h
"

42 
	~"Ÿime.h
"

43 
	~"c⁄sﬁe.h
"

44 
	~"pkcs11_backíd.h
"

47 
time_t


48 
	$__mytime
 () {

49  
	`›ív≤_time
 (
NULL
);

50 
	}
}

52 #i‡!
deföed
(
_WIN32
)

55 
	$__mygëtimeofday
 (
timevÆ
 *
tv
) {

56  
	`gëtimeofday
 (
tv
, 
NULL
);

57 
	}
}

62 
	$__my¶ìp
 (c⁄° 
u£c
) {

63 #i‡
	`deföed
(
_WIN32
)

64 
	`SÀï
 (
u£c
/1000);

66 
	`u¶ìp
 (
u£c
);

68 
	}
}

71 
pkcs11h_ígöe_sy°em_t
 
	gs_pkcs11h_sys_ígöe
 = {

72 
mÆloc
,

73 
‰ì
,

74 
__mytime
,

75 
__my¶ìp
,

76 #i‡
deföed
(
_WIN32
)

77 
NULL


79 
__mygëtimeofday


85 
	$_pkcs11_msg_pkcs112›ív≤
 (

86 c⁄° 
Êags


88 
›ív≤_Êags
;

90 
Êags
) {

91 
PKCS11H_LOG_DEBUG2
:

92 
›ív≤_Êags
 = 
D_PKCS11_DEBUG
;

94 
PKCS11H_LOG_DEBUG1
:

95 
›ív≤_Êags
 = 
D_SHOW_PKCS11
;

97 
PKCS11H_LOG_INFO
:

98 
›ív≤_Êags
 = 
M_INFO
;

100 
PKCS11H_LOG_WARN
:

101 
›ív≤_Êags
 = 
M_WARN
;

103 
PKCS11H_LOG_ERROR
:

104 
›ív≤_Êags
 = 
M_FATAL
;

107 
›ív≤_Êags
 = 
M_FATAL
;

111 #i‡
	`deföed
(
ENABLE_PKCS11_FORCE_DEBUG
)

112 
›ív≤_Êags
=
M_INFO
;

115  
›ív≤_Êags
;

116 
	}
}

120 
	$_pkcs11_msg_›ív≤2pkcs11
 (

121 c⁄° 
Êags


123 
pkcs11_Êags
;

125 i‡((
Êags
 & 
D_PKCS11_DEBUG
) != 0) {

126 
pkcs11_Êags
 = 
PKCS11H_LOG_DEBUG2
;

128 i‡((
Êags
 & 
D_SHOW_PKCS11
) != 0) {

129 
pkcs11_Êags
 = 
PKCS11H_LOG_DEBUG1
;

131 i‡((
Êags
 & 
M_INFO
) != 0) {

132 
pkcs11_Êags
 = 
PKCS11H_LOG_INFO
;

134 i‡((
Êags
 & 
M_WARN
) != 0) {

135 
pkcs11_Êags
 = 
PKCS11H_LOG_WARN
;

137 i‡((
Êags
 & 
M_FATAL
) != 0) {

138 
pkcs11_Êags
 = 
PKCS11H_LOG_ERROR
;

141 
pkcs11_Êags
 = 
PKCS11H_LOG_ERROR
;

144 #i‡
	`deföed
(
ENABLE_PKCS11_FORCE_DEBUG
)

145 
pkcs11_Êags
 = 
PKCS11H_LOG_DEBUG2
;

148  
pkcs11_Êags
;

149 
	}
}

153 
	$_pkcs11_›ív≤_log
 (

154 * c⁄° 
globÆ_d©a
,

155 
Êags
,

156 c⁄° * c⁄° 
szF‹m©
,

157 
va_li°
 
¨gs


159 
Buf„r
[10*1024];

161 ()
globÆ_d©a
;

163 
	`v¢¥ötf
 (
Buf„r
,  (Buf„r), 
szF‹m©
, 
¨gs
);

164 
Buf„r
[ (Buffer)-1] = 0;

166 
	`msg
 (
	`_pkcs11_msg_pkcs112›ív≤
 (
Êags
), "%s", 
Buf„r
);

167 
	}
}

170 
PKCS11H_BOOL


171 
	$_pkcs11_›ív≤_tokí_¥om±
 (

172 * c⁄° 
globÆ_d©a
,

173 * c⁄° 
u£r_d©a
,

174 c⁄° 
pkcs11h_tokí_id_t
 
tokí
,

175 c⁄° 
ªåy


177 
u£r_∑ss
 
tokí_ª•
;

179 ()
globÆ_d©a
;

180 ()
u£r_d©a
;

181 ()
ªåy
;

183 
	`ASSERT
 (
tokí
!=
NULL
);

185 
	`CLEAR
 (
tokí_ª•
);

186 
tokí_ª•
.
deföed
 = 
Ál£
;

187 
tokí_ª•
.
noˇche
 = 
åue
;

188 
	`›ív≤_¢¥ötf
 (

189 
tokí_ª•
.
u£∫ame
,

190  (
tokí_ª•
.
u£∫ame
),

192 
tokí
->
œbñ


196 !
	`gë_u£r_∑ss
 (

197 &
tokí_ª•
,

198 
NULL
,

200 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_NEED_OK
|
GET_USER_PASS_NOFATAL


203  
Ál£
;

206  
	`°rcmp
 (
tokí_ª•
.
∑ssw‹d
, "ok") == 0;

208 
	}
}

211 
PKCS11H_BOOL


212 
	$_pkcs11_›ív≤_pö_¥om±
 (

213 * c⁄° 
globÆ_d©a
,

214 * c⁄° 
u£r_d©a
,

215 c⁄° 
pkcs11h_tokí_id_t
 
tokí
,

216 c⁄° 
ªåy
,

217 * c⁄° 
pö
,

218 c⁄° 
size_t
 
pö_max


220 
u£r_∑ss
 
tokí_∑ss
;

221 
¥om±
[1024];

223 ()
globÆ_d©a
;

224 ()
u£r_d©a
;

225 ()
ªåy
;

227 
	`ASSERT
 (
tokí
!=
NULL
);

229 
	`›ív≤_¢¥ötf
 (
¥om±
,  (¥om±), "%†tokí", 
tokí
->
œbñ
);

231 
tokí_∑ss
.
deföed
 = 
Ál£
;

232 
tokí_∑ss
.
noˇche
 = 
åue
;

235 !
	`gë_u£r_∑ss
 (

236 &
tokí_∑ss
,

237 
NULL
,

238 
¥om±
,

239 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_PASSWORD_ONLY
|
GET_USER_PASS_NOFATAL


242  
Ál£
;

245 
	`°∫˝y¡
 (
pö
, 
tokí_∑ss
.
∑ssw‹d
, 
pö_max
);

246 
	`purge_u£r_∑ss
 (&
tokí_∑ss
, 
åue
);

248 i‡(
	`°æí
 (
pö
) == 0) {

249  
Ál£
;

252  
åue
;

255 
	}
}

257 
boﬁ


258 
	$pkcs11_öôülize
 (

259 c⁄° 
boﬁ
 
¥Ÿe˘ed_auth
,

260 c⁄° 
nPINCachePîiod


262 
CK_RV
 
rv
 = 
CKR_FUNCTION_FAILED
;

264 
	`dmsg
 (

265 
D_PKCS11_DEBUG
,

269 i‡((
rv
 = 
	`pkcs11h_ígöe_£tSy°em
 (&
s_pkcs11h_sys_ígöe
)Ë!
CKR_OK
) {

270 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ inôülizêsy°emÉngöê%ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

271 
˛ónup
;

274 i‡((
rv
 = 
	`pkcs11h_öôülize
 ()Ë!
CKR_OK
) {

275 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ inôülizê%ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

276 
˛ónup
;

279 i‡((
rv
 = 
	`pkcs11h_£tLogHook
 (
_pkcs11_›ív≤_log
, 
NULL
)Ë!
CKR_OK
) {

280 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ së hook†%ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

281 
˛ónup
;

284 
	`pkcs11h_£tLogLevñ
 (
	`_pkcs11_msg_›ív≤2pkcs11
 (
	`gë_debug_Àvñ
 ()));

286 i‡((
rv
 = 
	`pkcs11h_£tF‹kMode
 (
TRUE
)Ë!
CKR_OK
) {

287 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ së f‹k modê%ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

288 
˛ónup
;

291 i‡((
rv
 = 
	`pkcs11h_£tTokíProm±Hook
 (
_pkcs11_›ív≤_tokí_¥om±
, 
NULL
)Ë!
CKR_OK
) {

292 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ së hook†%ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

293 
˛ónup
;

296 i‡((
rv
 = 
	`pkcs11h_£tPINProm±Hook
 (
_pkcs11_›ív≤_pö_¥om±
, 
NULL
)Ë!
CKR_OK
) {

297 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ së hook†%ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

298 
˛ónup
;

301 i‡((
rv
 = 
	`pkcs11h_£tPrŸe˘edAuthítiˇti⁄
 (
¥Ÿe˘ed_auth
)Ë!
CKR_OK
) {

302 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ sëÖrŸe˘edáuthítiˇti⁄ modê%ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

303 
˛ónup
;

306 i‡((
rv
 = 
	`pkcs11h_£tPINCachePîiod
 (
nPINCachePîiod
)Ë!
CKR_OK
) {

307 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ së Pˇchê≥riod %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

308 
˛ónup
;

311 
rv
 = 
CKR_OK
;

313 
˛ónup
:

314 
	`dmsg
 (

315 
D_PKCS11_DEBUG
,

317 
rv
,

318 
	`pkcs11h_gëMesßge
 (
rv
)

321  
rv
 =
CKR_OK
;

322 
	}
}

325 
	$pkcs11_ãrmö©e
 () {

326 
	`dmsg
 (

327 
D_PKCS11_DEBUG
,

331 
	`pkcs11h_ãrmö©e
 ();

333 
	`dmsg
 (

334 
D_PKCS11_DEBUG
,

337 
	}
}

340 
	$pkcs11_f‹kFixup
 () {

341 
	`pkcs11h_f‹kFixup
 ();

342 
	}
}

344 
boﬁ


345 
	$pkcs11_addProvidî
 (

346 c⁄° * c⁄° 
¥ovidî
,

347 c⁄° 
boﬁ
 
¥Ÿe˘ed_auth
,

348 c⁄° 
¥iv©e_mode
,

349 c⁄° 
boﬁ
 
˚π_¥iv©e


351 
CK_RV
 
rv
 = 
CKR_OK
;

353 
	`ASSERT
 (
¥ovidî
!=
NULL
);

355 
	`dmsg
 (

356 
D_PKCS11_DEBUG
,

358 
¥ovidî
,

359 
¥iv©e_mode


362 
	`msg
 (

363 
M_INFO
,

365 
¥ovidî


369 (
rv
 = 
	`pkcs11h_addProvidî
 (

370 
¥ovidî
,

371 
¥ovidî
,

372 
¥Ÿe˘ed_auth
,

373 
¥iv©e_mode
,

374 
PKCS11H_SLOTEVENT_METHOD_AUTO
,

376 
˚π_¥iv©e


377 )Ë!
CKR_OK


379 
	`msg
 (
M_WARN
, "PKCS#11: C™nŸ inôülizê¥ovidî '%s' %ld-'%s'", 
¥ovidî
, 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

382 
	`dmsg
 (

383 
D_PKCS11_DEBUG
,

385 
rv
,

386 
	`pkcs11h_gëMesßge
 (
rv
)

389  
rv
 =
CKR_OK
;

390 
	}
}

393 
	$pkcs11_logout
() {

394  
	`pkcs11h_logout
 (Ë=
CKR_OK
;

395 
	}
}

398 
	$pkcs11_m™agemít_id_cou¡
 () {

399 
pkcs11h_˚πifiˇã_id_li°_t
 
id_li°
 = 
NULL
;

400 
pkcs11h_˚πifiˇã_id_li°_t
 
t
 = 
NULL
;

401 
CK_RV
 
rv
 = 
CKR_OK
;

402 
cou¡
 = 0;

404 
	`dmsg
 (

405 
D_PKCS11_DEBUG
,

410 (
rv
 = 
	`pkcs11h_˚πifiˇã_íumCîtifiˇãIds
 (

411 
PKCS11H_ENUM_METHOD_CACHE_EXIST
,

412 
NULL
,

413 
PKCS11H_PROMPT_MASK_ALLOW_ALL
,

414 
NULL
,

415 &
id_li°


416 )Ë!
CKR_OK


418 
	`msg
 (
M_WARN
, "PKCS#11: C™nŸ gë cîtifiˇãÜi° %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

419 
˛ónup
;

422 
cou¡
 = 0, 
t
 = 
id_li°
;Å !
NULL
;Å =Å->
√xt
) {

423 
cou¡
++;

426 
˛ónup
:

428 i‡(
id_li°
 !
NULL
) {

429 
	`pkcs11h_˚πifiˇã_‰ìCîtifiˇãIdLi°
 (
id_li°
);

430 
id_li°
 = 
NULL
;

433 
	`dmsg
 (

434 
D_PKCS11_DEBUG
,

436 
cou¡


439  
cou¡
;

440 
	}
}

442 
boﬁ


443 
	$pkcs11_m™agemít_id_gë
 (

444 c⁄° 
ödex
,

445 ** 
id
,

446 **
ba£64


448 
pkcs11h_˚πifiˇã_id_li°_t
 
id_li°
 = 
NULL
;

449 
pkcs11h_˚πifiˇã_id_li°_t
 
íåy
 = 
NULL
;

451 
pkcs11h_˚πifiˇã_id_t
 
˚πifiˇã_id
 = 
NULL
;

453 
pkcs11h_˚πifiˇã_t
 
˚πifiˇã
 = 
NULL
;

454 
CK_RV
 
rv
 = 
CKR_OK
;

455 *
˚πifiˇã_blob
 = 
NULL
;

456 
size_t
 
˚πifiˇã_blob_size
 = 0;

457 
size_t
 
max
;

458 *
öã∫Æ_id
 = 
NULL
;

459 *
öã∫Æ_ba£64
 = 
NULL
;

460 
cou¡
 = 0;

461 
boﬁ
 
suc˚ss
 = 
Ál£
;

463 
	`ASSERT
 (
id
!=
NULL
);

464 
	`ASSERT
 (
ba£64
!=
NULL
);

466 
	`dmsg
 (

467 
D_PKCS11_DEBUG
,

469 
ödex


472 *
id
 = 
NULL
;

473 *
ba£64
 = 
NULL
;

476 (
rv
 = 
	`pkcs11h_˚πifiˇã_íumCîtifiˇãIds
 (

477 
PKCS11H_ENUM_METHOD_CACHE_EXIST
,

478 
NULL
,

479 
PKCS11H_PROMPT_MASK_ALLOW_ALL
,

480 
NULL
,

481 &
id_li°


482 )Ë!
CKR_OK


484 
	`msg
 (
M_WARN
, "PKCS#11: C™nŸ gë cîtifiˇãÜi° %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

485 
˛ónup
;

488 
íåy
 = 
id_li°
;

489 
cou¡
 = 0;

490 
íåy
 !
NULL
 && 
cou¡
 !
ödex
) {

491 
cou¡
++;

492 
íåy
 =É¡ry->
√xt
;

495 i‡(
íåy
 =
NULL
) {

496 
	`dmsg
 (

497 
D_PKCS11_DEBUG
,

499 
ödex


501 
˛ónup
;

505 (
rv
 = 
	`pkcs11h_˚πifiˇã_£rülizeCîtifiˇãId
 (

506 
NULL
,

507 &
max
,

508 
íåy
->
˚πifiˇã_id


509 )Ë!
CKR_OK


511 
	`msg
 (
M_WARN
, "PKCS#11: C™nŸ sîülizê˚πifiˇã id %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

512 
˛ónup
;

515 i‡((
öã∫Æ_id
 = (*)
	`mÆloc
 (
max
)Ë=
NULL
) {

516 
	`msg
 (
M_FATAL
, "PKCS#11: Cannotállocate memory");

517 
˛ónup
;

521 (
rv
 = 
	`pkcs11h_˚πifiˇã_£rülizeCîtifiˇãId
 (

522 
öã∫Æ_id
,

523 &
max
,

524 
íåy
->
˚πifiˇã_id


525 )Ë!
CKR_OK


527 
	`msg
 (
M_WARN
, "PKCS#11: C™nŸ sîülizê˚πifiˇã id %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

528 
˛ónup
;

532 (
rv
 = 
	`pkcs11h_˚πifiˇã_¸óã
 (

533 
íåy
->
˚πifiˇã_id
,

534 
NULL
,

535 
PKCS11H_PROMPT_MASK_ALLOW_ALL
,

536 
PKCS11H_PIN_CACHE_INFINITE
,

537 &
˚πifiˇã


538 )Ë!
CKR_OK


540 
	`msg
 (
M_WARN
, "PKCS#11: C™nŸ gë cîtifiˇã %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

541 
˛ónup
;

545 (
rv
 = 
	`pkcs11h_˚πifiˇã_gëCîtifiˇãBlob
 (

546 
˚πifiˇã
,

547 
NULL
,

548 &
˚πifiˇã_blob_size


549 )Ë!
CKR_OK


551 
	`msg
 (
M_WARN
, "PKCS#11: C™nŸ gë cîtifiˇã blob %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

552 
˛ónup
;

555 i‡((
˚πifiˇã_blob
 = (*)
	`mÆloc
 (
˚πifiˇã_blob_size
)Ë=
NULL
) {

556 
	`msg
 (
M_FATAL
, "PKCS#11: Cannotállocate memory");

557 
˛ónup
;

561 (
rv
 = 
	`pkcs11h_˚πifiˇã_gëCîtifiˇãBlob
 (

562 
˚πifiˇã
,

563 
˚πifiˇã_blob
,

564 &
˚πifiˇã_blob_size


565 )Ë!
CKR_OK


567 
	`msg
 (
M_WARN
, "PKCS#11: C™nŸ gë cîtifiˇã blob %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

568 
˛ónup
;

571 i‡(
	`›ív≤_ba£64_ícode
 (
˚πifiˇã_blob
, 
˚πifiˇã_blob_size
, &
öã∫Æ_ba£64
) == -1) {

572 
	`msg
 (
M_WARN
, "PKCS#11: CannotÉncode certificate");

573 
˛ónup
;

576 *
id
 = 
öã∫Æ_id
;

577 
öã∫Æ_id
 = 
NULL
;

578 *
ba£64
 = 
öã∫Æ_ba£64
;

579 
öã∫Æ_ba£64
 = 
NULL
;

580 
suc˚ss
 = 
åue
;

582 
˛ónup
:

584 i‡(
id_li°
 !
NULL
) {

585 
	`pkcs11h_˚πifiˇã_‰ìCîtifiˇãIdLi°
 (
id_li°
);

586 
id_li°
 = 
NULL
;

589 i‡(
öã∫Æ_id
 !
NULL
) {

590 
	`‰ì
 (
öã∫Æ_id
);

591 
öã∫Æ_id
 = 
NULL
;

594 i‡(
öã∫Æ_ba£64
 !
NULL
) {

595 
	`‰ì
 (
öã∫Æ_ba£64
);

596 
öã∫Æ_ba£64
 = 
NULL
;

599 i‡(
˚πifiˇã_blob
 !
NULL
) {

600 
	`‰ì
 (
˚πifiˇã_blob
);

601 
˚πifiˇã_blob
 = 
NULL
;

604 
	`dmsg
 (

605 
D_PKCS11_DEBUG
,

607 
suc˚ss
 ? 1 : 0,

608 *
id


611  
suc˚ss
;

612 
	}
}

615 
	$és_˘x_u£_pkcs11
 (

616 
és_roŸ_˘x
 * c⁄° 
s¶_˘x
,

617 
boﬁ
 
pkcs11_id_m™agemít
,

618 c⁄° * c⁄° 
pkcs11_id


620 
pkcs11h_˚πifiˇã_id_t
 
˚πifiˇã_id
 = 
NULL
;

621 
pkcs11h_˚πifiˇã_t
 
˚πifiˇã
 = 
NULL
;

622 
CK_RV
 
rv
 = 
CKR_OK
;

624 
boﬁ
 
ok
 = 
Ál£
;

626 
	`ASSERT
 (
s¶_˘x
!=
NULL
);

627 
	`ASSERT
 (
pkcs11_id_m™agemít
 || 
pkcs11_id
!=
NULL
);

629 
	`dmsg
 (

630 
D_PKCS11_DEBUG
,

632 (*)
s¶_˘x
,

633 
pkcs11_id_m™agemít
 ? 1 : 0,

634 
pkcs11_id


637 i‡(
pkcs11_id_m™agemít
) {

638 
u£r_∑ss
 
id_ª•
;

640 
	`CLEAR
 (
id_ª•
);

642 
id_ª•
.
deföed
 = 
Ál£
;

643 
id_ª•
.
noˇche
 = 
åue
;

644 
	`›ív≤_¢¥ötf
 (

645 
id_ª•
.
u£∫ame
,

646  (
id_ª•
.
u£∫ame
),

651 !
	`gë_u£r_∑ss
 (

652 &
id_ª•
,

653 
NULL
,

655 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_NEED_STR
|
GET_USER_PASS_NOFATAL


658 
˛ónup
;

662 (
rv
 = 
	`pkcs11h_˚πifiˇã_de£rülizeCîtifiˇãId
 (

663 &
˚πifiˇã_id
,

664 
id_ª•
.
∑ssw‹d


665 )Ë!
CKR_OK


667 
	`msg
 (
M_WARN
, "PKCS#11: C™nŸ de£rülizêid %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

668 
˛ónup
;

673 (
rv
 = 
	`pkcs11h_˚πifiˇã_de£rülizeCîtifiˇãId
 (

674 &
˚πifiˇã_id
,

675 
pkcs11_id


676 )Ë!
CKR_OK


678 
	`msg
 (
M_WARN
, "PKCS#11: C™nŸ de£rülizêid %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

679 
˛ónup
;

684 (
rv
 = 
	`pkcs11h_˚πifiˇã_¸óã
 (

685 
˚πifiˇã_id
,

686 
NULL
,

687 
PKCS11H_PROMPT_MASK_ALLOW_ALL
,

688 
PKCS11H_PIN_CACHE_INFINITE
,

689 &
˚πifiˇã


690 )Ë!
CKR_OK


692 
	`msg
 (
M_WARN
, "PKCS#11: C™nŸ gë cîtifiˇã %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

693 
˛ónup
;

697 (
	`pkcs11_öô_és_£ssi⁄
 (

698 
˚πifiˇã
,

699 
s¶_˘x


703 
˚πifiˇã
 = 
NULL
;

704 
˛ónup
;

708 
˚πifiˇã
 = 
NULL
;

709 
ok
 = 
åue
;

711 
˛ónup
:

712 i‡(
˚πifiˇã
 !
NULL
) {

713 
	`pkcs11h_˚πifiˇã_‰ìCîtifiˇã
 (
˚πifiˇã
);

714 
˚πifiˇã
 = 
NULL
;

717 i‡(
˚πifiˇã_id
 !
NULL
) {

718 
	`pkcs11h_˚πifiˇã_‰ìCîtifiˇãId
 (
˚πifiˇã_id
);

719 
˚πifiˇã_id
 = 
NULL
;

722 
	`dmsg
 (

723 
D_PKCS11_DEBUG
,

725 
ok
 ? 1 : 0,

726 
rv


729  
ok
 ? 1 : 0;

730 
	}
}

733 
PKCS11H_BOOL


734 
	$_pkcs11_›ív≤_show_pkcs11_ids_pö_¥om±
 (

735 * c⁄° 
globÆ_d©a
,

736 * c⁄° 
u£r_d©a
,

737 c⁄° 
pkcs11h_tokí_id_t
 
tokí
,

738 c⁄° 
ªåy
,

739 * c⁄° 
pö
,

740 c⁄° 
size_t
 
pö_max


742 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

743 
buf„r
 
∑ss_¥om±
 = 
	`Æloc_buf_gc
 (128, &
gc
);

745 ()
globÆ_d©a
;

746 ()
u£r_d©a
;

747 ()
ªåy
;

749 
	`ASSERT
 (
tokí
!=
NULL
);

751 
	`buf_¥ötf
 (&
∑ss_¥om±
, "PÀa£É¡î '%s'Åokí PIN o∏'ˇn˚l': ", 
tokí
->
di•œy
);

753 i‡(!
	`gë_c⁄sﬁe_öput
 (
	`BSTR
 (&
∑ss_¥om±
), 
Ál£
, 
pö
, 
pö_max
)) {

754 
	`msg
 (
M_FATAL
, "CannotÑeadÖassword from stdin");

757 
	`gc_‰ì
 (&
gc
);

759 i‡(!
	`°rcmp
 (
pö
, "cancel")) {

760  
FALSE
;

763  
TRUE
;

765 
	}
}

768 
	$show_pkcs11_ids
 (

769 c⁄° * c⁄° 
¥ovidî
,

770 
boﬁ
 
˚π_¥iv©e


772 
gc_¨ía
 
gc
 = 
	`gc_√w
();

773 
pkcs11h_˚πifiˇã_id_li°_t
 
u£r_˚πifiˇãs
 = 
NULL
;

774 
pkcs11h_˚πifiˇã_id_li°_t
 
cuºít
 = 
NULL
;

775 
CK_RV
 
rv
 = 
CKR_FUNCTION_FAILED
;

777 i‡((
rv
 = 
	`pkcs11h_öôülize
 ()Ë!
CKR_OK
) {

778 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ inôülizê%ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

779 
˛ónup
;

782 i‡((
rv
 = 
	`pkcs11h_£tLogHook
 (
_pkcs11_›ív≤_log
, 
NULL
)Ë!
CKR_OK
) {

783 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ së hook†%ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

784 
˛ónup
;

787 
	`pkcs11h_£tLogLevñ
 (
	`_pkcs11_msg_›ív≤2pkcs11
 (
	`gë_debug_Àvñ
 ()));

789 i‡((
rv
 = 
	`pkcs11h_£tPrŸe˘edAuthítiˇti⁄
 (
TRUE
)Ë!
CKR_OK
) {

790 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ sëÖrŸe˘edáuthítiˇti⁄ %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

791 
˛ónup
;

794 i‡((
rv
 = 
	`pkcs11h_£tPINProm±Hook
 (
_pkcs11_›ív≤_show_pkcs11_ids_pö_¥om±
, 
NULL
)Ë!
CKR_OK
) {

795 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ së PIN hook %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

796 
˛ónup
;

800 (
rv
 = 
	`pkcs11h_addProvidî
 (

801 
¥ovidî
,

802 
¥ovidî
,

803 
TRUE
,

805 
FALSE
,

807 
˚π_¥iv©e
 ? 
TRUE
 : 
FALSE


808 )Ë!
CKR_OK


810 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸáddÖrovidî '%s' %ld-'%s'", 
¥ovidî
, 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

811 
˛ónup
;

815 (
rv
 = 
	`pkcs11h_˚πifiˇã_íumCîtifiˇãIds
 (

816 
PKCS11H_ENUM_METHOD_CACHE_EXIST
,

817 
NULL
,

818 
PKCS11H_PROMPT_MASK_ALLOW_ALL
,

819 
NULL
,

820 &
u£r_˚πifiˇãs


821 )Ë!
CKR_OK


823 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸÉnumî©ê˚πifiˇã†%ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

824 
˛ónup
;

827 
	`msg
 (

828 
M_INFO
|
M_NOPREFIX
|
M_NOLF
,

836 
cuºít
 = 
u£r_˚πifiˇãs
;cuºíà!
NULL
; cuºíàcuºít->
√xt
) {

837 
pkcs11h_˚πifiˇã_t
 
˚πifiˇã
 = 
NULL
;

838 *
dn
 = 
NULL
;

839 
£rül
[1024] = {0};

840 *
£r
 = 
NULL
;

841 
size_t
 
£r_Àn
 = 0;

844 (
rv
 = 
	`pkcs11h_˚πifiˇã_£rülizeCîtifiˇãId
 (

845 
NULL
,

846 &
£r_Àn
,

847 
cuºít
->
˚πifiˇã_id


848 )Ë!
CKR_OK


850 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ sîülizê˚πifiˇã %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

851 
˛ónup1
;

855 
rv
 =
CKR_OK
 &&

856 (
£r
 = (*)
	`mÆloc
 (
£r_Àn
)Ë=
NULL


858 
	`msg
 (
M_FATAL
, "PKCS#11: Cannotállocate memory");

859 
˛ónup1
;

863 (
rv
 = 
	`pkcs11h_˚πifiˇã_£rülizeCîtifiˇãId
 (

864 
£r
,

865 &
£r_Àn
,

866 
cuºít
->
˚πifiˇã_id


867 )Ë!
CKR_OK


869 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ sîülizê˚πifiˇã %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

870 
˛ónup1
;

874 (
rv
 = 
	`pkcs11h_˚πifiˇã_¸óã
 (

875 
cuºít
->
˚πifiˇã_id
,

876 
NULL
,

877 
PKCS11H_PROMPT_MASK_ALLOW_ALL
,

878 
PKCS11H_PIN_CACHE_INFINITE
,

879 &
˚πifiˇã


882 
	`msg
 (
M_FATAL
, "PKCS#11: C™nŸ cª©ê˚πifiˇã %ld-'%s'", 
rv
, 
	`pkcs11h_gëMesßge
 (rv));

883 
˛ónup1
;

887 (
dn
 = 
	`pkcs11_˚πifiˇã_dn
 (

888 
˚πifiˇã
,

889 &
gc


890 )Ë=
NULL


892 
˛ónup1
;

896 (
	`pkcs11_˚πifiˇã_£rül
 (

897 
˚πifiˇã
,

898 
£rül
,

899 (
£rül
)

902 
˛ónup1
;

905 
	`msg
 (

906 
M_INFO
|
M_NOPREFIX
|
M_NOLF
,

914 
dn
,

915 
£rül
,

916 
£r


919 
˛ónup1
:

921 i‡(
˚πifiˇã
 !
NULL
) {

922 
	`pkcs11h_˚πifiˇã_‰ìCîtifiˇã
 (
˚πifiˇã
);

923 
˚πifiˇã
 = 
NULL
;

926 i‡(
£r
 !
NULL
) {

927 
	`‰ì
 (
£r
);

928 
£r
 = 
NULL
;

932 
˛ónup
:

933 i‡(
u£r_˚πifiˇãs
 !
NULL
) {

934 
	`pkcs11h_˚πifiˇã_‰ìCîtifiˇãIdLi°
 (
u£r_˚πifiˇãs
);

935 
u£r_˚πifiˇãs
 = 
NULL
;

938 
	`pkcs11h_ãrmö©e
 ();

939 
	`gc_‰ì
 (&
gc
);

940 
	}
}

943 #ifde‡
_MSC_VER


944 
	$dummy
 (Ë{
	}
}

	@src/openvpn/pkcs11.h

25 #i‚de‡
OPENVPN_PKCS11_H


26 
	#OPENVPN_PKCS11_H


	)

28 #i‡
deföed
(
ENABLE_PKCS11
)

30 
	~"s¶_comm⁄.h
"

32 
boﬁ


33 
pkcs11_öôülize
 (

34 c⁄° 
boﬁ
 
fPrŸe˘edAuthítiˇti⁄
,

35 c⁄° 
nPINCachePîiod


39 
pkcs11_ãrmö©e
 ();

42 
pkcs11_f‹kFixup
 ();

44 
boﬁ


45 
pkcs11_addProvidî
 (

46 c⁄° * c⁄° 
¥ovidî
,

47 c⁄° 
boﬁ
 
fPrŸe˘edAuthítiˇti⁄
,

48 c⁄° 
¥iv©e_mode
,

49 c⁄° 
boﬁ
 
fCîtIsPriv©e


53 
pkcs11_logout
();

56 
pkcs11_m™agemít_id_cou¡
 ();

58 
boﬁ


59 
pkcs11_m™agemít_id_gë
 (

60 c⁄° 
ödex
,

61 ** 
id
,

62 **
ba£64


66 
és_˘x_u£_pkcs11
 (

67 
és_roŸ_˘x
 * c⁄° 
s¶_˘x
,

68 
boﬁ
 
pkcs11_id_m™agemít
,

69 c⁄° * c⁄° 
pkcs11_id


73 
show_pkcs11_ids
 (

74 c⁄° * c⁄° 
¥ovidî
,

75 
boﬁ
 
˚π_¥iv©e


	@src/openvpn/pkcs11_backend.h

30 #i‚de‡
PKCS11_BACKEND_H_


31 
	#PKCS11_BACKEND_H_


	)

33 
	~"syshód.h
"

35 #i‡
deföed
(
ENABLE_PKCS11
)

37 
	~"s¶_comm⁄.h
"

39 
	~<pkcs11-hñ≥r-1.0/pkcs11h-˚πifiˇã.h
>

49 * 
pkcs11_˚πifiˇã_dn
 (
pkcs11h_˚πifiˇã_t
 
˚πifiˇã
, 
gc_¨ía
 *
gc
);

60 
pkcs11_˚πifiˇã_£rül
 (
pkcs11h_˚πifiˇã_t
 
˚πifiˇã
, *
£rül
,

61 
size_t
 
£rül_Àn
);

71 
pkcs11_öô_és_£ssi⁄
(
pkcs11h_˚πifiˇã_t
 
˚πifiˇã
,

72 
és_roŸ_˘x
 * c⁄° 
s¶_˘x
);

	@src/openvpn/pkcs11_openssl.c

30 #ifde‡
HAVE_CONFIG_H


31 
	~"c⁄fig.h
"

32 #ñi‡
deföed
(
_MSC_VER
)

33 
	~"c⁄fig-msvc.h
"

36 
	~"syshód.h
"

38 #i‡
deföed
(
ENABLE_PKCS11
Ë&& deföed(
ENABLE_CRYPTO_OPENSSL
)

40 
	~"îæevñ.h
"

41 
	~"pkcs11_backíd.h
"

42 
	~"s¶_vîify.h
"

43 
	~<pkcs11-hñ≥r-1.0/pkcs11h-›ís¶.h
>

46 
	$pkcs11_öô_és_£ssi⁄
(
pkcs11h_˚πifiˇã_t
 
˚πifiˇã
,

47 
és_roŸ_˘x
 * c⁄° 
s¶_˘x
)

49 
ªt
 = 1;

51 
X509
 *
x509
 = 
NULL
;

52 
EVP_PKEY
 *
evp
 = 
NULL
;

53 
pkcs11h_›ís¶_£ssi⁄_t
 
›ís¶_£ssi⁄
 = 
NULL
;

55 i‡((
›ís¶_£ssi⁄
 = 
	`pkcs11h_›ís¶_¸óãSessi⁄
 (
˚πifiˇã
)Ë=
NULL
)

57 
	`msg
 (
M_WARN
, "PKCS#11: Cannot initialize openssl session");

58 
˛ónup
;

64 
˚πifiˇã
 = 
NULL
;

66 i‡((
evp
 = 
	`pkcs11h_›ís¶_£ssi⁄_gëEVP
 (
›ís¶_£ssi⁄
)Ë=
NULL
)

68 
	`msg
 (
M_WARN
, "PKCS#11: Unable getÉvp object");

69 
˛ónup
;

72 i‡((
x509
 = 
	`pkcs11h_›ís¶_£ssi⁄_gëX509
 (
›ís¶_£ssi⁄
)Ë=
NULL
)

74 
	`msg
 (
M_WARN
, "PKCS#11: Unable get certificate object");

75 
˛ónup
;

78 i‡(!
	`SSL_CTX_u£_Priv©eKey
 (
s¶_˘x
->
˘x
, 
evp
))

80 
	`msg
 (
M_WARN
, "PKCS#11: Cannot setÖrivate key for openssl");

81 
˛ónup
;

84 i‡(!
	`SSL_CTX_u£_˚πifiˇã
 (
s¶_˘x
->
˘x
, 
x509
))

86 
	`msg
 (
M_WARN
, "PKCS#11: Cannot set certificate for openssl");

87 
˛ónup
;

89 
ªt
 = 0;

91 
˛ónup
:

96 i‡(
˚πifiˇã
 !
NULL
) {

97 
	`pkcs11h_˚πifiˇã_‰ìCîtifiˇã
 (
˚πifiˇã
);

98 
˚πifiˇã
 = 
NULL
;

105 i‡(
x509
 !
NULL
)

107 
	`X509_‰ì
 (
x509
);

108 
x509
 = 
NULL
;

111 i‡(
evp
 !
NULL
)

113 
	`EVP_PKEY_‰ì
 (
evp
);

114 
evp
 = 
NULL
;

117 i‡(
›ís¶_£ssi⁄
 !
NULL
)

119 
	`pkcs11h_›ís¶_‰ìSessi⁄
 (
›ís¶_£ssi⁄
);

120 
›ís¶_£ssi⁄
 = 
NULL
;

122  
ªt
;

123 
	}
}

126 
	$pkcs11_˚πifiˇã_dn
 (
pkcs11h_˚πifiˇã_t
 
˚πifiˇã
, 
gc_¨ía
 *
gc
)

128 
X509
 *
x509
 = 
NULL
;

130 *
dn
 = 
NULL
;

132 i‡((
x509
 = 
	`pkcs11h_›ís¶_gëX509
 (
˚πifiˇã
)Ë=
NULL
)

134 
	`msg
 (
M_FATAL
, "PKCS#11: Cannot get X509");

135 
˛ónup
;

138 
dn
 = 
	`x509_gë_subje˘
 (
x509
, 
gc
);

140 
˛ónup
:

141 i‡(
x509
 !
NULL
)

143 
	`X509_‰ì
 (
x509
);

144 
x509
 = 
NULL
;

147  
dn
;

148 
	}
}

151 
	$pkcs11_˚πifiˇã_£rül
 (
pkcs11h_˚πifiˇã_t
 
˚πifiˇã
, *
£rül
,

152 
size_t
 
£rül_Àn
)

154 
X509
 *
x509
 = 
NULL
;

155 
BIO
 *
bio
 = 
NULL
;

156 
ªt
 = 1;

157 
n
;

159 i‡((
x509
 = 
	`pkcs11h_›ís¶_gëX509
 (
˚πifiˇã
)Ë=
NULL
)

161 
	`msg
 (
M_FATAL
, "PKCS#11: Cannot get X509");

162 
˛ónup
;

165 i‡((
bio
 = 
	`BIO_√w
 (
	`BIO_s_mem
 ())Ë=
NULL
)

167 
	`msg
 (
M_FATAL
, "PKCS#11: Cannot create BIO");

168 
˛ónup
;

171 
	`i2a_ASN1_INTEGER
(
bio
, 
	`X509_gë_£rülNumbî
 (
x509
));

172 
n
 = 
	`BIO_ªad
 (
bio
, 
£rül
, 
£rül_Àn
-1);

174 i‡(
n
<0) {

175 
£rül
[0] = '\x0';

178 
£rül
[
n
] = 0;

181 
ªt
 = 0;

183 
˛ónup
:

185 i‡(
x509
 !
NULL
)

187 
	`X509_‰ì
 (
x509
);

188 
x509
 = 
NULL
;

190  
ªt
;

191 
	}
}

	@src/openvpn/pkcs11_polarssl.c

30 #ifde‡
HAVE_CONFIG_H


31 
	~"c⁄fig.h
"

32 #ñi‡
deföed
(
_MSC_VER
)

33 
	~"c⁄fig-msvc.h
"

36 
	~"syshód.h
"

38 #i‡
deföed
(
ENABLE_PKCS11
Ë&& deföed(
ENABLE_CRYPTO_POLARSSL
)

40 
	~"îæevñ.h
"

41 
	~"pkcs11_backíd.h
"

42 
	~<pﬁ¨s¶/pkcs11.h
>

45 
	$pkcs11_öô_és_£ssi⁄
(
pkcs11h_˚πifiˇã_t
 
˚πifiˇã
,

46 
és_roŸ_˘x
 * c⁄° 
s¶_˘x
)

48 
ªt
 = 1;

50 
	`ASSERT
 (
NULL
 !
s¶_˘x
);

52 i‡(
	`pkcs11_x509_˚π_öô
(
s¶_˘x
->
¸t_chaö
, 
˚πifiˇã
)) {

53 
	`msg
 (
M_FATAL
, "PKCS#11: CannotÑetrieve PolarSSL certificate object");

54 
˛ónup
;

57 
s¶_˘x
->
¥iv_key_pkcs11
 = 
	`mÆloc
((
pkcs11_c⁄ãxt
));

59 i‡(
s¶_˘x
->
¥iv_key_pkcs11
 =
NULL
) {

60 
	`msg
 (
M_FATAL
, "PKCS#11: Cannotállocate PolarSSLÖrivate key object");

61 
˛ónup
;

64 i‡(
	`pkcs11_¥iv_key_öô
(
s¶_˘x
->
¥iv_key_pkcs11
, 
˚πifiˇã
)) {

65 
	`msg
 (
M_FATAL
, "PKCS#11: Cannot initialize PolarSSLÖrivate key object");

66 
˛ónup
;

69 
ªt
 = 0;

71 
˛ónup
:

72  
ªt
;

73 
	}
}

76 
	$pkcs11_˚πifiˇã_dn
 (
pkcs11h_˚πifiˇã_t
 
˚π
, 
gc_¨ía
 *
gc
)

78 *
ªt
 = 
NULL
;

79 
dn
[1024] = {0};

81 
x509_˚π
 
pﬁ¨_˚π
 = {0};

83 i‡(
	`pkcs11_x509_˚π_öô
(&
pﬁ¨_˚π
, 
˚π
)) {

84 
	`msg
 (
M_FATAL
, "PKCS#11: CannotÑetrieve PolarSSL certificate object");

85 
˛ónup
;

88 i‡(-1 =
	`x509∑r£_dn_gës
 (
dn
, (dn), &
pﬁ¨_˚π
.
subje˘
)) {

89 
	`msg
 (
M_FATAL
, "PKCS#11: PolarSSL cannotÖarse subject");

90 
˛ónup
;

93 
ªt
 = 
	`°rög_Æloc
(
dn
, 
gc
);

95 
˛ónup
:

96 
	`x509_‰ì
(&
pﬁ¨_˚π
);

98  
ªt
;

99 
	}
}

102 
	$pkcs11_˚πifiˇã_£rül
 (
pkcs11h_˚πifiˇã_t
 
˚π
, *
£rül
,

103 
size_t
 
£rül_Àn
)

105 
ªt
 = 1;

107 
x509_˚π
 
pﬁ¨_˚π
 = {0};

109 i‡(
	`pkcs11_x509_˚π_öô
(&
pﬁ¨_˚π
, 
˚π
)) {

110 
	`msg
 (
M_FATAL
, "PKCS#11: CannotÑetrieve PolarSSL certificate object");

111 
˛ónup
;

114 i‡(-1 =
	`x509∑r£_£rül_gës
 (
£rül
, 
£rül_Àn
, &
pﬁ¨_˚π
.serial)) {

115 
	`msg
 (
M_FATAL
, "PKCS#11: PolarSSL cannotÖarse serial");

116 
˛ónup
;

119 
ªt
 = 0;

121 
˛ónup
:

122 
	`x509_‰ì
(&
pﬁ¨_˚π
);

124  
ªt
;

125 
	}
}

	@src/openvpn/platform.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"buf„r.h
"

34 
	~"îr‹.h
"

35 
	~"wö32.h
"

37 
	~"memdbg.h
"

39 
	~"∂©f‹m.h
"

44 
	$∂©f‹m_chroŸ
 (c⁄° *
∑th
)

46 i‡(
∑th
)

48 #ifde‡
HAVE_CHROOT


49 c⁄° *
t›
 = "/";

50 i‡(
	`chroŸ
 (
∑th
))

51 
	`msg
 (
M_ERR
, "chroŸÅÿ'%s' faûed", 
∑th
);

52 i‡(
	`∂©f‹m_chdú
 (
t›
))

53 
	`msg
 (
M_ERR
, "cdÅÿ'%s' faûed", 
t›
);

54 
	`msg
 (
M_INFO
, "chroŸÅÿ'%s'ánd cdÅÿ'%s' suc˚eded", 
∑th
, 
t›
);

56 
	`msg
 (
M_FATAL
, "S‹ry buàI c™'àchroŸÅÿ'%s' beˇu£Åhi†›î©ög sy°em d€¢'à≠≥¨Åÿsuµ‹àthêchroŸ(Ësy°em cÆl", 
∑th
);

59 
	}
}

63 
boﬁ


64 
	$∂©f‹m_u£r_gë
 (c⁄° *
u£∫ame
, 
∂©f‹m_°©e_u£r
 *
°©e
)

66 
boﬁ
 
ªt
 = 
Ál£
;

67 
	`CLEAR
 (*
°©e
);

68 i‡(
u£∫ame
)

70 #i‡
	`deföed
(
HAVE_GETPWNAM
Ë&& deföed(
HAVE_SETUID
)

71 
°©e
->
pw
 = 
	`gëpw«m
 (
u£∫ame
);

72 i‡(!
°©e
->
pw
)

73 
	`msg
 (
M_ERR
, "ÁûedÅÿföd UID f‹ u£∏%s", 
u£∫ame
);

74 
°©e
->
u£∫ame
 = username;

75 
ªt
 = 
åue
;

77 
	`msg
 (
M_FATAL
, "ˇ¬Ÿ gë UID f‹ u£∏%†--Öœtf‹mÜack†gëpw«me(Ë‹ sëuid(Ësy°em cÆls", 
u£∫ame
);

80  
ªt
;

81 
	}
}

84 
	$∂©f‹m_u£r_£t
 (c⁄° 
∂©f‹m_°©e_u£r
 *
°©e
)

86 #i‡
	`deföed
(
HAVE_GETPWNAM
Ë&& deföed(
HAVE_SETUID
)

87 i‡(
°©e
->
u£∫ame
 && sèã->
pw
)

89 i‡(
	`£tuid
 (
°©e
->
pw
->
pw_uid
))

90 
	`msg
 (
M_ERR
, "£tuid('%s'ËÁûed", 
°©e
->
u£∫ame
);

91 
	`msg
 (
M_INFO
, "UID sëÅÿ%s", 
°©e
->
u£∫ame
);

94 
	}
}

98 
boﬁ


99 
	$∂©f‹m_group_gë
 (c⁄° *
grou≤ame
, 
∂©f‹m_°©e_group
 *
°©e
)

101 
boﬁ
 
ªt
 = 
Ál£
;

102 
	`CLEAR
 (*
°©e
);

103 i‡(
grou≤ame
)

105 #i‡
	`deföed
(
HAVE_GETGRNAM
Ë&& deföed(
HAVE_SETGID
)

106 
°©e
->
gr
 = 
	`gëg∫am
 (
grou≤ame
);

107 i‡(!
°©e
->
gr
)

108 
	`msg
 (
M_ERR
, "ÁûedÅÿföd GID f‹ grou∞%s", 
grou≤ame
);

109 
°©e
->
grou≤ame
 = groupname;

110 
ªt
 = 
åue
;

112 
	`msg
 (
M_FATAL
, "ˇ¬Ÿ gë GID f‹ grou∞%†--Öœtf‹mÜack†gëg∫am(Ë‹ sëgid(Ësy°em cÆls", 
grou≤ame
);

115  
ªt
;

116 
	}
}

119 
	$∂©f‹m_group_£t
 (c⁄° 
∂©f‹m_°©e_group
 *
°©e
)

121 #i‡
	`deföed
(
HAVE_GETGRNAM
Ë&& deföed(
HAVE_SETGID
)

122 i‡(
°©e
->
grou≤ame
 && sèã->
gr
)

124 i‡(
	`£tgid
 (
°©e
->
gr
->
gr_gid
))

125 
	`msg
 (
M_ERR
, "£tgid('%s'ËÁûed", 
°©e
->
grou≤ame
);

126 
	`msg
 (
M_INFO
, "GID sëÅÿ%s", 
°©e
->
grou≤ame
);

127 #ifde‡
HAVE_SETGROUPS


129 
gid_t
 
gr_li°
[1];

130 
gr_li°
[0] = 
°©e
->
gr
->
gr_gid
;

131 i‡(
	`£tgroups
 (1, 
gr_li°
))

132 
	`msg
 (
M_ERR
, "£tgroups('%s'ËÁûed", 
°©e
->
grou≤ame
);

137 
	}
}

141 
	$∂©f‹m_ni˚
 (
ni˚vÆ
)

143 i‡(
ni˚vÆ
)

145 #ifde‡
HAVE_NICE


146 
î∫o
 = 0;

147 i‡(
	`ni˚
 (
ni˚vÆ
Ë< 0 && 
î∫o
 != 0)

148 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "WARNING:Çi˚ %d faûed: %s", 
ni˚vÆ
, 
	`°ªº‹
(
î∫o
));

150 
	`msg
 (
M_INFO
, "ni˚ %d suc˚eded", 
ni˚vÆ
);

152 
	`msg
 (
M_WARN
, "WARNING:Çi˚ %d faûed (fun˘i⁄ÇŸ im∂emíãd)", 
ni˚vÆ
);

155 
	}
}

159 
	$∂©f‹m_gëpid
 ()

161 #ifde‡
WIN32


162  (Ë
	`GëCuºítPro˚ssId
 ();

164 #ifde‡
HAVE_GETPID


165  (Ë
	`gëpid
 ();

170 
	}
}

174 
	$∂©f‹m_mlockÆl
(
boﬁ
 
¥öt_msg
)

176 #ifde‡
HAVE_MLOCKALL


177 i‡(
	`mlockÆl
 (
MCL_CURRENT
 | 
MCL_FUTURE
))

178 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "WARNING: mlockall call failed");

179 i‡(
¥öt_msg
)

180 
	`msg
 (
M_INFO
, "mlockall call succeeded");

182 
	`msg
 (
M_WARN
, "WARNING: mlockall call failed (functionÇot implemented)");

184 
	}
}

190 
	$∂©f‹m_chdú
 (c⁄° * 
dú
)

192 #ifde‡
HAVE_CHDIR


193 #ifde‡
WIN32


194 
ªs
;

195 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

196 
ªs
 = 
	`_wchdú
 (
	`wide_°rög
 (
dú
, &
gc
));

197 
	`gc_‰ì
 (&
gc
);

198  
ªs
;

200  
	`chdú
 (
dú
);

205 
	}
}

210 
boﬁ


211 
	$∂©f‹m_sy°em_ok
 (
°©
)

213 #ifde‡
WIN32


214  
°©
 == 0;

216  
°©
 !-1 && 
	`WIFEXITED
 (°©Ë&& 
	`WEXITSTATUS
 (stat) == 0;

218 
	}
}

221 
	$∂©f‹m_ac˚ss
 (c⁄° *
∑th
, 
mode
)

223 #ifde‡
WIN32


224 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

225 
ªt
 = 
	`_wac˚ss
 (
	`wide_°rög
 (
∑th
, &
gc
), 
mode
 & ~
X_OK
);

226 
	`gc_‰ì
 (&
gc
);

227  
ªt
;

229  
	`ac˚ss
 (
∑th
, 
mode
);

231 
	}
}

237 
	$∂©f‹m_¶ìp_mûli£c⁄ds
 (
n
)

239 #ifde‡
WIN32


240 
	`SÀï
 (
n
);

242 
timevÆ
 
tv
;

243 
tv
.
tv_£c
 = 
n
 / 1000;

244 
tv
.
tv_u£c
 = (
n
 % 1000) * 1000;

245 
	`£À˘
 (0, 
NULL
, NULL, NULL, &
tv
);

247 
	}
}

253 
	$∂©f‹m_¶ìp_u¡û_sig«l
 ()

255 #ifde‡
WIN32


256 
	`ASSERT
 (0);

258 
	`£À˘
 (0, 
NULL
, NULL, NULL, NULL);

260 
	}
}

263 
boﬁ


264 
	$∂©f‹m_u∆ök
 (c⁄° *
fûíame
)

266 #i‡
	`deföed
(
WIN32
)

267 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

268 
BOOL
 
ªt
 = 
	`DñëeFûeW
 (
	`wide_°rög
 (
fûíame
, &
gc
));

269 
	`gc_‰ì
 (&
gc
);

270  (
ªt
 != 0);

271 #ñi‡
	`deföed
(
HAVE_UNLINK
)

272  (
	`u∆ök
 (
fûíame
) == 0);

274  
Ál£
;

276 
	}
}

278 
FILE
 *

279 
	$∂©f‹m_f›í
 (c⁄° *
∑th
, c⁄° *
mode
)

281 #ifde‡
WIN32


282 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

283 
FILE
 *
f
 = 
	`_wf›í
 (
	`wide_°rög
 (
∑th
, &
gc
), wide_°rög (
mode
, &gc));

284 
	`gc_‰ì
 (&
gc
);

285  
f
;

287  
	`f›í
(
∑th
, 
mode
);

289 
	}
}

292 
	$∂©f‹m_›í
 (c⁄° *
∑th
, 
Êags
, 
mode
)

294 #ifde‡
WIN32


295 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

296 
fd
 = 
	`_w›í
 (
	`wide_°rög
 (
∑th
, &
gc
), 
Êags
, 
mode
);

297 
	`gc_‰ì
 (&
gc
);

298  
fd
;

300  
	`›í
(
∑th
, 
Êags
, 
mode
);

302 
	}
}

305 
	$∂©f‹m_°©
 (c⁄° *
∑th
, 
∂©f‹m_°©_t
 *
buf
)

307 #ifde‡
WIN32


308 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

309 
ªs
 = 
	`_w°©
 (
	`wide_°rög
 (
∑th
, &
gc
), 
buf
);

310 
	`gc_‰ì
 (&
gc
);

311  
ªs
;

313  
	`°©
(
∑th
, 
buf
);

315 
	}
}

	@src/openvpn/platform.h

25 #i‚de‡
PLATFORM_H


26 
	#PLATFORM_H


	)

28 #ifde‡
HAVE_SYS_TYPES_H


29 
	~<sys/ty≥s.h
>

32 #ifde‡
HAVE_SYS_STAT_H


33 
	~<sys/°©.h
>

36 #ifde‡
HAVE_UNISTD_H


37 
	~<uni°d.h
>

40 #ifde‡
HAVE_PWD_H


41 
	~<pwd.h
>

44 #ifde‡
HAVE_GRP_H


45 
	~<gΩ.h
>

48 #ifde‡
HAVE_STDIO_H


49 
	~<°dio.h
>

52 
	~"basic.h
"

56 
	s∂©f‹m_°©e_u£r
 {

57 #i‡
deföed
(
HAVE_GETPWNAM
Ë&& deföed(
HAVE_SETUID
)

58 c⁄° *
	mu£∫ame
;

59 
∑sswd
 *
	mpw
;

61 
	mdummy
;

67 
	s∂©f‹m_°©e_group
 {

68 #i‡
deföed
(
HAVE_GETGRNAM
Ë&& deföed(
HAVE_SETGID
)

69 c⁄° *
	mgrou≤ame
;

70 
group
 *
	mgr
;

72 
	mdummy
;

76 
boﬁ
 
∂©f‹m_u£r_gë
 (c⁄° *
u£∫ame
, 
∂©f‹m_°©e_u£r
 *
°©e
);

77 
∂©f‹m_u£r_£t
 (c⁄° 
∂©f‹m_°©e_u£r
 *
°©e
);

79 
boﬁ
 
∂©f‹m_group_gë
 (c⁄° *
grou≤ame
, 
∂©f‹m_°©e_group
 *
°©e
);

80 
∂©f‹m_group_£t
 (c⁄° 
∂©f‹m_°©e_group
 *
°©e
);

86 
ölöe
 

87 
	$∂©f‹m_°©e_u£r_uid
 (c⁄° 
∂©f‹m_°©e_u£r
 *
s
)

89 #i‡
	`deföed
(
HAVE_GETPWNAM
Ë&& deföed(
HAVE_SETUID
)

90 i‡(
s
->
pw
)

91  
s
->
pw
->
pw_uid
;

94 
	}
}

96 
ölöe
 

97 
	$∂©f‹m_°©e_group_gid
 (c⁄° 
∂©f‹m_°©e_group
 *
s
)

99 #i‡
	`deföed
(
HAVE_GETGRNAM
Ë&& deföed(
HAVE_SETGID
)

100 i‡(
s
->
gr
)

101  
s
->
gr
->
gr_gid
;

104 
	}
}

106 
∂©f‹m_chroŸ
 (c⁄° *
∑th
);

108 
∂©f‹m_ni˚
 (
ni˚vÆ
);

110 
∂©f‹m_gëpid
 ();

112 
∂©f‹m_mlockÆl
 (
boﬁ
 
¥öt_msg
);

114 
∂©f‹m_chdú
 (c⁄° * 
dú
);

117 
boﬁ
 
∂©f‹m_sy°em_ok
 (
°©
);

119 
∂©f‹m_ac˚ss
 (c⁄° *
∑th
, 
mode
);

121 
∂©f‹m_¶ìp_mûli£c⁄ds
 (
n
);

123 
∂©f‹m_¶ìp_u¡û_sig«l
 ();

126 
boﬁ
 
∂©f‹m_u∆ök
 (c⁄° *
fûíame
);

128 
∂©f‹m_puãnv
 (*
°rög
);

130 
FILE
 *
∂©f‹m_f›í
 (c⁄° *
∑th
, c⁄° *
mode
);

131 
∂©f‹m_›í
 (c⁄° *
∑th
, 
Êags
, 
mode
);

133 #ifde‡
WIN32


134 
_°©
 
	t∂©f‹m_°©_t
;

136 
°©
 
	t∂©f‹m_°©_t
;

138 
∂©f‹m_°©
 (c⁄° *
∑th
, 
∂©f‹m_°©_t
 *
buf
);

	@src/openvpn/plugin.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #ifde‡
ENABLE_PLUGIN


35 #ifde‡
HAVE_DLFCN_H


36 
	~<dlf˙.h
>

39 
	~"buf„r.h
"

40 
	~"îr‹.h
"

41 
	~"misc.h
"

42 
	~"∂ugö.h
"

43 
	~"s¶_backíd.h
"

44 
	~"wö32.h
"

45 
	~"memdbg.h
"

47 
	#PLUGIN_SYMBOL_REQUIRED
 (1<<0)

	)

50 
∂ugö_comm⁄
 *
	g°©ic_∂ugö_comm⁄
 = 
NULL
;

53 
	$∂ugö_show_°rög_¨øy
 (
msgÀvñ
, c⁄° *
«me
, c⁄° *
¨øy
[])

55 
i
;

56 
i
 = 0; 
¨øy
[i]; ++i)

58 i‡(
	`ív_ß„_to_¥öt
 (
¨øy
[
i
]))

59 
	`msg
 (
msgÀvñ
, "%s[%d] = '%s'", 
«me
, 
i
, 
¨øy
[i]);

61 
	}
}

64 
	$∂ugö_show_¨gs_ív
 (
msgÀvñ
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

66 i‡(
	`check_debug_Àvñ
 (
msgÀvñ
))

68 
	`∂ugö_show_°rög_¨øy
 (
msgÀvñ
, "ARGV", 
¨gv
);

69 
	`∂ugö_show_°rög_¨øy
 (
msgÀvñ
, "ENVP", 
ívp
);

71 
	}
}

74 
	$∂ugö_ty≥_«me
 (c⁄° 
ty≥
)

76 
ty≥
)

78 
OPENVPN_PLUGIN_UP
:

80 
OPENVPN_PLUGIN_DOWN
:

82 
OPENVPN_PLUGIN_ROUTE_UP
:

84 
OPENVPN_PLUGIN_IPCHANGE
:

86 
OPENVPN_PLUGIN_TLS_VERIFY
:

88 
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
:

90 
OPENVPN_PLUGIN_CLIENT_CONNECT
:

92 
OPENVPN_PLUGIN_CLIENT_CONNECT_V2
:

94 
OPENVPN_PLUGIN_CLIENT_DISCONNECT
:

96 
OPENVPN_PLUGIN_LEARN_ADDRESS
:

98 
OPENVPN_PLUGIN_TLS_FINAL
:

100 
OPENVPN_PLUGIN_ENABLE_PF
:

102 
OPENVPN_PLUGIN_ROUTE_PREDOWN
:

107 
	}
}

110 
	$∂ugö_mask_°rög
 (c⁄° 
ty≥_mask
, 
gc_¨ía
 *
gc
)

112 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

113 
boﬁ
 
fú°
 = 
åue
;

114 
i
;

116 
i
 = 0; i < 
OPENVPN_PLUGIN_N
; ++i)

118 i‡(
	`OPENVPN_PLUGIN_MASK
 (
i
Ë& 
ty≥_mask
)

120 i‡(!
fú°
)

121 
	`buf_¥ötf
 (&
out
, "|");

122 
	`buf_¥ötf
 (&
out
, "%s", 
	`∂ugö_ty≥_«me
 (
i
));

123 
fú°
 = 
Ál£
;

126  
	`BSTR
 (&
out
);

127 
	}
}

129 
ölöe
 

130 
	$∂ugö_suµ‹ãd_ty≥s
 ()

132  ((1<<
OPENVPN_PLUGIN_N
)-1);

133 
	}
}

135 
∂ugö_›ti⁄_li°
 *

136 
	$∂ugö_›ti⁄_li°_√w
 (
gc_¨ía
 *
gc
)

138 
∂ugö_›ti⁄_li°
 *
ªt
;

139 
	`ALLOC_OBJ_CLEAR_GC
 (
ªt
, 
∂ugö_›ti⁄_li°
, 
gc
);

140  
ªt
;

141 
	}
}

143 
boﬁ


144 
	$∂ugö_›ti⁄_li°_add
 (
∂ugö_›ti⁄_li°
 *
li°
, **
p
, 
gc_¨ía
 *
gc
)

146 i‡(
li°
->
n
 < 
MAX_PLUGINS
)

148 
∂ugö_›ti⁄
 *
o
 = &
li°
->
∂ugös
[li°->
n
++];

149 
o
->
¨gv
 = 
	`make_exãnded_¨g_¨øy
 (
p
, 
gc
);

150 i‡(
o
->
¨gv
[0])

151 
o
->
so_∑th«me
 = o->
¨gv
[0];

152  
åue
;

155  
Ál£
;

156 
	}
}

158 #i‚de‡
ENABLE_SMALL


160 
	$∂ugö_›ti⁄_li°_¥öt
 (c⁄° 
∂ugö_›ti⁄_li°
 *
li°
, 
msgÀvñ
)

162 
i
;

163 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

165 
i
 = 0; i < 
li°
->
n
; ++i)

167 c⁄° 
∂ugö_›ti⁄
 *
o
 = &
li°
->
∂ugös
[
i
];

168 
	`msg
 (
msgÀvñ
, "Ölugö[%d] %†'%s'", 
i
, 
o
->
so_∑th«me
, 
	`¥öt_¨gv
 (o->
¨gv
, &
gc
, 
PA_BRACKET
));

171 
	`gc_‰ì
 (&
gc
);

172 
	}
}

175 #i‚de‡
WIN32


178 
	$libdl_ªsﬁve_symbﬁ
 (*
h™dÀ
, **
de°
, c⁄° *
symbﬁ
, c⁄° *
∂ugö_«me
, c⁄° 
Êags
)

180 *
de°
 = 
	`dlsym
 (
h™dÀ
, 
symbﬁ
);

181 i‡((
Êags
 & 
PLUGIN_SYMBOL_REQUIRED
Ë&& !*
de°
)

182 
	`msg
 (
M_FATAL
, "PLUGIN: couldÇŸ födÑequúed symbﬁ '%s' i¿∂ugö sh¨ed obje˘ %s: %s", 
symbﬁ
, 
∂ugö_«me
, 
	`dÀº‹
());

183 
	}
}

188 
	$dŒ_ªsﬁve_symbﬁ
 (
HMODULE
 
moduÀ
, **
de°
, c⁄° *
symbﬁ
, c⁄° *
∂ugö_«me
, c⁄° 
Êags
)

190 *
de°
 = 
	`GëProcAddªss
 (
moduÀ
, 
symbﬁ
);

191 i‡((
Êags
 & 
PLUGIN_SYMBOL_REQUIRED
Ë&& !*
de°
)

192 
	`msg
 (
M_FATAL
, "PLUGIN: couldÇŸ födÑequúed symbﬁ '%s' i¿∂ugö DLL %s", 
symbﬁ
, 
∂ugö_«me
);

193 
	}
}

198 
	$∂ugö_öô_ôem
 (
∂ugö
 *
p
, c⁄° 
∂ugö_›ti⁄
 *
o
)

200 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

201 
boﬁ
 
ªl
 = 
Ál£
;

203 
p
->
so_∑th«me
 = 
o
->so_pathname;

204 
p
->
∂ugö_ty≥_mask
 = 
	`∂ugö_suµ‹ãd_ty≥s
 ();

206 #i‚de‡
WIN32


208 
p
->
h™dÀ
 = 
NULL
;

209 #i‡
	`deföed
(
PLUGIN_LIBDIR
)

210 i‡(!
	`absﬁuã_∑th«me
 (
p
->
so_∑th«me
))

212 
fuŒ
[
PATH_MAX
];

214 
	`›ív≤_¢¥ötf
 (
fuŒ
, (fuŒ), "%s/%s", 
PLUGIN_LIBDIR
, 
p
->
so_∑th«me
);

215 
p
->
h™dÀ
 = 
	`dl›í
 (
fuŒ
, 
RTLD_NOW
);

216 #i‡
	`deföed
(
ENABLE_PLUGIN_SEARCH
)

217 i‡(!
p
->
h™dÀ
)

219 
ªl
 = 
åue
;

220 
p
->
h™dÀ
 = 
	`dl›í
 (p->
so_∑th«me
, 
RTLD_NOW
);

227 
ªl
 = !
	`absﬁuã_∑th«me
 (
p
->
so_∑th«me
);

228 
p
->
h™dÀ
 = 
	`dl›í
 (p->
so_∑th«me
, 
RTLD_NOW
);

230 i‡(!
p
->
h™dÀ
)

231 
	`msg
 (
M_ERR
, "PLUGIN_INIT: couldÇŸÜﬂdÖlugö sh¨ed obje˘ %s: %s", 
p
->
so_∑th«me
, 
	`dÀº‹
());

233 
	#PLUGIN_SYM
(
v¨
, 
«me
, 
Êags
Ë
	`libdl_ªsﬁve_symbﬁ
 (
p
->
h™dÀ
, (*)&p->v¨,Çame,Ö->
so_∑th«me
, fœgs)

	)

237 
ªl
 = !
	`absﬁuã_∑th«me
 (
p
->
so_∑th«me
);

238 
p
->
moduÀ
 = 
	`LﬂdLibøryW
 (
	`wide_°rög
 (p->
so_∑th«me
, &
gc
));

239 i‡(!
p
->
moduÀ
)

240 
	`msg
 (
M_ERR
, "PLUGIN_INIT: couldÇŸÜﬂdÖlugö DLL: %s", 
p
->
so_∑th«me
);

242 
	#PLUGIN_SYM
(
v¨
, 
«me
, 
Êags
Ë
	`dŒ_ªsﬁve_symbﬁ
 (
p
->
moduÀ
, (*)&p->v¨,Çame,Ö->
so_∑th«me
, fœgs)

	)

246 
	`PLUGIN_SYM
 (
›í1
, "openvpn_plugin_open_v1", 0);

247 
	`PLUGIN_SYM
 (
›í2
, "openvpn_plugin_open_v2", 0);

248 
	`PLUGIN_SYM
 (
›í3
, "openvpn_plugin_open_v3", 0);

249 
	`PLUGIN_SYM
 (
func1
, "openvpn_plugin_func_v1", 0);

250 
	`PLUGIN_SYM
 (
func2
, "openvpn_plugin_func_v2", 0);

251 
	`PLUGIN_SYM
 (
func3
, "openvpn_plugin_func_v3", 0);

252 
	`PLUGIN_SYM
 (
˛o£
, "›ív≤_∂ugö_˛o£_v1", 
PLUGIN_SYMBOL_REQUIRED
);

253 
	`PLUGIN_SYM
 (
ab‹t
, "openvpn_plugin_abort_v1", 0);

254 
	`PLUGIN_SYM
 (
˛õ¡_c⁄°ru˘‹
, "openvpn_plugin_client_constructor_v1", 0);

255 
	`PLUGIN_SYM
 (
˛õ¡_de°ru˘‹
, "openvpn_plugin_client_destructor_v1", 0);

256 
	`PLUGIN_SYM
 (
mö_vîsi⁄_ªquúed
, "openvpn_plugin_min_version_required_v1", 0);

257 
	`PLUGIN_SYM
 (
öôüliz©i⁄_poöt
, "openvpn_plugin_select_initialization_point_v1", 0);

259 i‡(!
p
->
›í1
 && !p->
›í2
 && !p->
›í3
)

260 
	`msg
 (
M_FATAL
, "PLUGIN: symbﬁ o≥nv≤_∂ugö_›í_vX i†undeföed i¿∂ugö: %s", 
p
->
so_∑th«me
);

262 i‡(!
p
->
func1
 && !p->
func2
 && !p->
func3
)

263 
	`msg
 (
M_FATAL
, "PLUGIN: symbﬁ o≥nv≤_∂ugö_func_vX i†undeföed i¿∂ugö: %s", 
p
->
so_∑th«me
);

268 i‡(
p
->
mö_vîsi⁄_ªquúed
)

270 c⁄° 
∂ugö_√eds_vîsi⁄
 = (*
p
->
mö_vîsi⁄_ªquúed
)();

271 i‡(
∂ugö_√eds_vîsi⁄
 > 
OPENVPN_PLUGIN_VERSION
)

272 
	`msg
 (
M_FATAL
, "PLUGIN_INIT:ÖluginÇeeds interface version %d, butÅhis version of OpenVPN only supports version %d: %s",

273 
∂ugö_√eds_vîsi⁄
,

274 
OPENVPN_PLUGIN_VERSION
,

275 
p
->
so_∑th«me
);

278 i‡(
p
->
öôüliz©i⁄_poöt
)

279 
p
->
ªque°ed_öôüliz©i⁄_poöt
 = (*p->
öôüliz©i⁄_poöt
)();

281 
p
->
ªque°ed_öôüliz©i⁄_poöt
 = 
OPENVPN_PLUGIN_INIT_PRE_DAEMON
;

283 i‡(
ªl
)

284 
	`msg
 (
M_WARN
, "WARNING:Ölugö '%s' s≥cifõd byáÑñ©ivê∑th«mê-- usögá¿absﬁuãÖ©h«mêwould bêm‹ê£cuª", 
p
->
so_∑th«me
);

286 
p
->
öôülized
 = 
åue
;

288 
	`gc_‰ì
 (&
gc
);

289 
	}
}

292 
	$∂ugö_vlog
 (
›ív≤_∂ugö_log_Êags_t
 
Êags
, c⁄° *
«me
, c⁄° *
f‹m©
, 
va_li°
 
¨gli°
)

294 
msg_Êags
;

296 i‡(!
f‹m©
)

299 i‡(!
«me
 ||Çame[0] == '\0')

301 
	`msg
 (
D_PLUGIN_DEBUG
, "PLUGIN: suppressedÜog message fromÖlugin with unknownÇame");

305 i‡(
Êags
 & 
PLOG_ERR
)

306 
msg_Êags
 = 
M_INFO
 | 
M_NONFATAL
;

307 i‡(
Êags
 & 
PLOG_WARN
)

308 
msg_Êags
 = 
M_INFO
 | 
M_WARN
;

309 i‡(
Êags
 & 
PLOG_NOTE
)

310 
msg_Êags
 = 
M_INFO
;

311 i‡(
Êags
 & 
PLOG_DEBUG
)

312 
msg_Êags
 = 
D_PLUGIN_DEBUG
;

314 i‡(
Êags
 & 
PLOG_ERRNO
)

315 
msg_Êags
 |
M_ERRNO
;

316 i‡(
Êags
 & 
PLOG_NOMUTE
)

317 
msg_Êags
 |
M_NOMUTE
;

319 i‡(
	`MSG_TEST
 (
msg_Êags
))

321 
gc_¨ía
 
gc
;

322 * 
msg_fmt
;

325 
msg_Êags
 |
M_NOIPREFIX
;

327 
	`gc_öô
 (&
gc
);

328 
msg_fmt
 = 
	`gc_mÆloc
 (
ERR_BUF_SIZE
, 
Ál£
, &
gc
);

329 
	`›ív≤_¢¥ötf
 (
msg_fmt
, 
ERR_BUF_SIZE
, "PLUGIN %s: %s", 
«me
, 
f‹m©
);

330 
	`x_msg_va
 (
msg_Êags
, 
msg_fmt
, 
¨gli°
);

332 
	`gc_‰ì
 (&
gc
);

334 
	}
}

337 
	$∂ugö_log
 (
›ív≤_∂ugö_log_Êags_t
 
Êags
, c⁄° *
«me
, c⁄° *
f‹m©
, ...)

339 
va_li°
 
¨gli°
;

340 
	`va_°¨t
 (
¨gli°
, 
f‹m©
);

341 
	`∂ugö_vlog
 (
Êags
, 
«me
, 
f‹m©
, 
¨gli°
);

342 
	`va_íd
 (
¨gli°
);

343 
	}
}

345 
›ív≤_∂ugö_ˇŒbacks
 
	gˇŒbacks
 = {

346 
∂ugö_log
,

347 
∂ugö_vlog


351 
	$∂ugö_›í_ôem
 (
∂ugö
 *
p
,

352 c⁄° 
∂ugö_›ti⁄
 *
o
,

353 
›ív≤_∂ugö_°rög_li°
 **
ªéi°
,

354 c⁄° **
ívp
,

355 c⁄° 
öô_poöt
)

357 
	`ASSERT
 (
p
->
öôülized
);

360 i‡(
ªéi°
)

361 *
ªéi°
 = 
NULL
;

363 i‡(!
p
->
∂ugö_h™dÀ
 && 
öô_poöt
 =p->
ªque°ed_öôüliz©i⁄_poöt
)

365 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

367 
	`dmsg
 (
D_PLUGIN_DEBUG
, "PLUGIN_INIT: PRE");

368 
	`∂ugö_show_¨gs_ív
 (
D_PLUGIN_DEBUG
, 
o
->
¨gv
, 
ívp
);

373 i‡(
p
->
›í3
) {

374 
›ív≤_∂ugö_¨gs_›í_ö
 
¨gs
 = { 
p
->
∂ugö_ty≥_mask
,

375 (c⁄° ** c⁄°Ë
o
->
¨gv
,

376 (c⁄° ** c⁄°Ë
ívp
,

377 &
ˇŒbacks
,

378 
SSLAPI
 };

379 
›ív≤_∂ugö_¨gs_›í_ªtu∫
 
ªèrgs
;

381 
	`CLEAR
(
ªèrgs
);

382 
ªèrgs
.
ªtu∫_li°
 = 
ªéi°
;

383 i‡((*
p
->
›í3
)(
OPENVPN_PLUGINv3_STRUCTVER
, &
¨gs
, &
ªèrgs
Ë=
OPENVPN_PLUGIN_FUNC_SUCCESS
) {

384 
p
->
∂ugö_ty≥_mask
 = 
ªèrgs
.
ty≥_mask
;

385 
p
->
∂ugö_h™dÀ
 = 
ªèrgs
.
h™dÀ
;

387 
p
->
∂ugö_h™dÀ
 = 
NULL
;

389 } i‡(
p
->
›í2
)

390 
p
->
∂ugö_h™dÀ
 = (*p->
›í2
)(&p->
∂ugö_ty≥_mask
, 
o
->
¨gv
, 
ívp
, 
ªéi°
);

391 i‡(
p
->
›í1
)

392 
p
->
∂ugö_h™dÀ
 = (*p->
›í1
)(&p->
∂ugö_ty≥_mask
, 
o
->
¨gv
, 
ívp
);

394 
	`ASSERT
 (0);

396 
	`msg
 (
D_PLUGIN
, "PLUGIN_INIT: POST %s '%s' intercepted=%s %s",

397 
p
->
so_∑th«me
,

398 
	`¥öt_¨gv
 (
o
->
¨gv
, &
gc
, 
PA_BRACKET
),

399 
	`∂ugö_mask_°rög
 (
p
->
∂ugö_ty≥_mask
, &
gc
),

400 (
ªéi°
 && *retlist) ? "[RETLIST]" : "");

402 i‡((
p
->
∂ugö_ty≥_mask
 | 
	`∂ugö_suµ‹ãd_ty≥s
()) !=Ölugin_supported_types())

403 
	`msg
 (
M_FATAL
, "PLUGIN_INIT:Ölugin %sÉxpressed interest in unsupportedÖluginÅypes: [want=0x%08x, have=0x%08x]",

404 
p
->
so_∑th«me
,

405 
p
->
∂ugö_ty≥_mask
,

406 
	`∂ugö_suµ‹ãd_ty≥s
());

408 i‡(
p
->
∂ugö_h™dÀ
 =
NULL
)

409 
	`msg
 (
M_FATAL
, "PLUGIN_INIT:Ölugin initialization function failed: %s",

410 
p
->
so_∑th«me
);

412 
	`gc_‰ì
 (&
gc
);

414 
	}
}

417 
∂ugö_ˇŒ_ôem
 (c⁄° 
∂ugö
 *
p
,

418 *
≥r_˛õ¡_c⁄ãxt
,

419 c⁄° 
ty≥
,

420 c⁄° 
¨gv
 *
av
,

421 
›ív≤_∂ugö_°rög_li°
 **
ªéi°
,

422 c⁄° **
ívp


423 #ifde‡
ENABLE_SSL


424 , 
˚πdïth
,

425 
›ív≤_x509_˚π_t
 *
cuºít_˚π


429 
	g°©us
 = 
OPENVPN_PLUGIN_FUNC_SUCCESS
;

432 i‡(
	gªéi°
)

433 *
	gªéi°
 = 
NULL
;

435 i‡(
	gp
->
	g∂ugö_h™dÀ
 && (p->
	g∂ugö_ty≥_mask
 & 
OPENVPN_PLUGIN_MASK
 (
ty≥
)))

437 
gc_¨ía
 
	ggc
 = 
gc_√w
 ();

438 
¨gv
 
	ga
 = 
¨gv_ö£π_hód
 (
av
, 
p
->
so_∑th«me
);

440 
dmsg
 (
D_PLUGIN_DEBUG
, "PLUGIN_CALL: PREÅy≥=%s", 
∂ugö_ty≥_«me
 (
ty≥
));

441 
∂ugö_show_¨gs_ív
 (
D_PLUGIN_DEBUG
, (c⁄° **)
a
.
¨gv
, 
ívp
);

446 i‡(
	gp
->
	gfunc3
) {

447 
›ív≤_∂ugö_¨gs_func_ö
 
	g¨gs
 = { 
ty≥
,

448 (c⁄° ** c⁄°Ë
a
.
¨gv
,

449 (c⁄° ** c⁄°Ë
ívp
,

450 
p
->
∂ugö_h™dÀ
,

451 
≥r_˛õ¡_c⁄ãxt
,

452 #ifde‡
ENABLE_SSL


453 (
cuºít_˚π
 ? 
˚πdïth
 : -1),

454 
cuºít_˚π


457 
NULL


461 
›ív≤_∂ugö_¨gs_func_ªtu∫
 
	gªèrgs
;

463 
CLEAR
(
ªèrgs
);

464 
	gªèrgs
.
	gªtu∫_li°
 = 
ªéi°
;

465 
	g°©us
 = (*
p
->
func3
)(
OPENVPN_PLUGINv3_STRUCTVER
, &
	g¨gs
, &
	gªèrgs
);

466 } i‡(
	gp
->
	gfunc2
)

467 
	g°©us
 = (*
p
->
func2
)’->
∂ugö_h™dÀ
, 
	gty≥
, (c⁄° **)
	ga
.
	g¨gv
, 
	gívp
, 
	g≥r_˛õ¡_c⁄ãxt
, 
	gªéi°
);

468 i‡(
	gp
->
	gfunc1
)

469 
	g°©us
 = (*
p
->
func1
)’->
∂ugö_h™dÀ
, 
	gty≥
, (c⁄° **)
	ga
.
	g¨gv
, 
	gívp
);

471 
ASSERT
 (0);

473 
msg
 (
D_PLUGIN
, "PLUGIN_CALL: POST %s/%s status=%d",

474 
p
->
so_∑th«me
,

475 
∂ugö_ty≥_«me
 (
ty≥
),

476 
°©us
);

478 i‡(
	g°©us
 =
OPENVPN_PLUGIN_FUNC_ERROR
)

479 
msg
 (
M_WARN
, "PLUGIN_CALL:Ölugin function %s failed with status %d: %s",

480 
∂ugö_ty≥_«me
 (
ty≥
),

481 
°©us
,

482 
p
->
so_∑th«me
);

484 
¨gv_ª£t
 (&
a
);

485 
gc_‰ì
 (&
gc
);

487  
	g°©us
;

491 
	$∂ugö_˛o£_ôem
 (
∂ugö
 *
p
)

493 i‡(
p
->
öôülized
)

495 
	`msg
 (
D_PLUGIN
, "PLUGIN_CLOSE: %s", 
p
->
so_∑th«me
);

500 i‡(
p
->
∂ugö_h™dÀ
)

501 (*
p
->
˛o£
)’->
∂ugö_h™dÀ
);

503 #i‚de‡
WIN32


504 i‡(
	`dl˛o£
 (
p
->
h™dÀ
))

505 
	`msg
 (
M_WARN
, "PLUGIN_CLOSE: dl˛o£(ËÁûed o¿∂ugö: %s", 
p
->
so_∑th«me
);

506 #ñi‡
	`deföed
(
WIN32
)

507 i‡(!
	`FªeLibøry
 (
p
->
moduÀ
))

508 
	`msg
 (
M_WARN
, "PLUGIN_CLOSE: FªeLibøry(ËÁûed o¿∂ugö: %s", 
p
->
so_∑th«me
);

511 
p
->
öôülized
 = 
Ál£
;

513 
	}
}

516 
	$∂ugö_ab‹t_ôem
 (c⁄° 
∂ugö
 *
p
)

521 i‡(
p
->
ab‹t
)

522 (*
p
->
ab‹t
)’->
∂ugö_h™dÀ
);

523 
	}
}

526 
	$∂ugö_≥r_˛õ¡_öô
 (c⁄° 
∂ugö_comm⁄
 *
pc
,

527 
∂ugö_≥r_˛õ¡
 *
˛i
,

528 c⁄° 
öô_poöt
)

530 c⁄° 
n
 = 
pc
->n;

531 
i
;

533 
i
 = 0; i < 
n
; ++i)

535 c⁄° 
∂ugö
 *
p
 = &
pc
->
∂ugös
[
i
];

536 i‡(
p
->
∂ugö_h™dÀ


537 && (
öô_poöt
 < 0 || inô_poöà=
p
->
ªque°ed_öôüliz©i⁄_poöt
)

538 && 
p
->
˛õ¡_c⁄°ru˘‹
)

539 
˛i
->
≥r_˛õ¡_c⁄ãxt
[
i
] = (*
p
->
˛õ¡_c⁄°ru˘‹
)’->
∂ugö_h™dÀ
);

541 
	}
}

544 
	$∂ugö_≥r_˛õ¡_de°roy
 (c⁄° 
∂ugö_comm⁄
 *
pc
, 
∂ugö_≥r_˛õ¡
 *
˛i
)

546 c⁄° 
n
 = 
pc
->n;

547 
i
;

549 
i
 = 0; i < 
n
; ++i)

551 c⁄° 
∂ugö
 *
p
 = &
pc
->
∂ugös
[
i
];

552 *
cc
 = 
˛i
->
≥r_˛õ¡_c⁄ãxt
[
i
];

554 i‡(
p
->
˛õ¡_de°ru˘‹
 && 
cc
)

555 (*
p
->
˛õ¡_de°ru˘‹
)’->
∂ugö_h™dÀ
, 
cc
);

557 
	`CLEAR
 (*
˛i
);

558 
	}
}

560 
∂ugö_li°
 *

561 
	$∂ugö_li°_öhîô
 (c⁄° 
∂ugö_li°
 *
§c
)

563 
∂ugö_li°
 *
∂
;

564 
	`ALLOC_OBJ_CLEAR
 (
∂
, 
∂ugö_li°
);

565 
∂
->
comm⁄
 = 
§c
->common;

566 
	`ASSERT
 (
∂
->
comm⁄
);

567 
	`∂ugö_≥r_˛õ¡_öô
 (
∂
->
comm⁄
, &∂->
≥r_˛õ¡
, -1);

568  
∂
;

569 
	}
}

571 
∂ugö_comm⁄
 *

572 
	$∂ugö_comm⁄_öô
 (c⁄° 
∂ugö_›ti⁄_li°
 *
li°
)

574 
i
;

575 
∂ugö_comm⁄
 *
pc
;

577 
	`ALLOC_OBJ_CLEAR
 (
pc
, 
∂ugö_comm⁄
);

579 
i
 = 0; i < 
li°
->
n
; ++i)

581 
	`∂ugö_öô_ôem
 (&
pc
->
∂ugös
[
i
],

582 &
li°
->
∂ugös
[
i
]);

583 
pc
->
n
 = 
i
 + 1;

586 
°©ic_∂ugö_comm⁄
 = 
pc
;

587  
pc
;

588 
	}
}

591 
	$∂ugö_comm⁄_›í
 (
∂ugö_comm⁄
 *
pc
,

592 c⁄° 
∂ugö_›ti⁄_li°
 *
li°
,

593 
∂ugö_ªtu∫
 *
¥
,

594 c⁄° 
ív_£t
 *
es
,

595 c⁄° 
öô_poöt
)

597 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

598 
i
;

599 c⁄° **
ívp
;

601 
ívp
 = 
	`make_ív_¨øy
 (
es
, 
Ál£
, &
gc
);

603 i‡(
¥
)

604 
	`∂ugö_ªtu∫_öô
 (
¥
);

606 
i
 = 0; i < 
pc
->
n
; ++i)

608 
	`∂ugö_›í_ôem
 (&
pc
->
∂ugös
[
i
],

609 &
li°
->
∂ugös
[
i
],

610 
¥
 ? &¥->
li°
[
i
] : 
NULL
,

611 
ívp
,

612 
öô_poöt
);

615 i‡(
¥
)

616 
¥
->
n
 = 
i
;

618 
	`gc_‰ì
 (&
gc
);

619 
	}
}

622 
	$∂ugö_comm⁄_˛o£
 (
∂ugö_comm⁄
 *
pc
)

624 
°©ic_∂ugö_comm⁄
 = 
NULL
;

625 i‡(
pc
)

627 
i
;

629 
i
 = 0; i < 
pc
->
n
; ++i)

630 
	`∂ugö_˛o£_ôem
 (&
pc
->
∂ugös
[
i
]);

631 
	`‰ì
 (
pc
);

633 
	}
}

635 
∂ugö_li°
 *

636 
	$∂ugö_li°_öô
 (c⁄° 
∂ugö_›ti⁄_li°
 *
li°
)

638 
∂ugö_li°
 *
∂
;

639 
	`ALLOC_OBJ_CLEAR
 (
∂
, 
∂ugö_li°
);

640 
∂
->
comm⁄
 = 
	`∂ugö_comm⁄_öô
 (
li°
);

641 
∂
->
comm⁄_ow√d
 = 
åue
;

642  
∂
;

643 
	}
}

646 
	$∂ugö_li°_›í
 (
∂ugö_li°
 *
∂
,

647 c⁄° 
∂ugö_›ti⁄_li°
 *
li°
,

648 
∂ugö_ªtu∫
 *
¥
,

649 c⁄° 
ív_£t
 *
es
,

650 c⁄° 
öô_poöt
)

652 
	`∂ugö_comm⁄_›í
 (
∂
->
comm⁄
, 
li°
, 
¥
, 
es
, 
öô_poöt
);

653 
	`∂ugö_≥r_˛õ¡_öô
 (
∂
->
comm⁄
, &∂->
≥r_˛õ¡
, 
öô_poöt
);

654 
	}
}

657 
∂ugö_ˇŒ_s¶
 (c⁄° 
∂ugö_li°
 *
∂
,

658 c⁄° 
ty≥
,

659 c⁄° 
¨gv
 *
av
,

660 
∂ugö_ªtu∫
 *
¥
,

661 
ív_£t
 *
es


662 #ifde‡
ENABLE_SSL


663 , 
˚πdïth
,

664 
›ív≤_x509_˚π_t
 *
cuºít_˚π


668 i‡(
	g¥
)

669 
∂ugö_ªtu∫_öô
 (
¥
);

671 i‡(
∂ugö_deföed
 (
∂
, 
ty≥
))

673 
gc_¨ía
 
	ggc
 = 
gc_√w
 ();

674 
	gi
;

675 c⁄° **
	gívp
;

676 c⁄° 
	gn
 = 
∂ugö_n
 (
∂
);

677 
boﬁ
 
	gsuc˚ss
 = 
Ál£
;

678 
boﬁ
 
	gîr‹
 = 
Ál£
;

679 
boﬁ
 
	gde„ºed
 = 
Ál£
;

681 
£ãnv_dñ
 (
es
, "script_type");

682 
	gívp
 = 
make_ív_¨øy
 (
es
, 
Ál£
, &
gc
);

684 
	gi
 = 0; i < 
	gn
; ++i)

686 c⁄° 
	g°©us
 = 
∂ugö_ˇŒ_ôem
 (&
∂
->
comm⁄
->
∂ugös
[
i
],

687 
∂
->
≥r_˛õ¡
.
≥r_˛õ¡_c⁄ãxt
[
i
],

688 
ty≥
,

689 
av
,

690 
¥
 ? &¥->
li°
[
i
] : 
NULL
,

691 
ívp


692 #ifde‡
ENABLE_SSL


693 ,
˚πdïth
,

694 
cuºít_˚π


697 
	g°©us
)

699 
	gOPENVPN_PLUGIN_FUNC_SUCCESS
:

700 
suc˚ss
 = 
åue
;

702 
	gOPENVPN_PLUGIN_FUNC_DEFERRED
:

703 
de„ºed
 = 
åue
;

706 
îr‹
 = 
åue
;

711 i‡(
	g¥
)

712 
	g¥
->
	gn
 = 
i
;

714 
gc_‰ì
 (&
gc
);

716 i‡(
	gty≥
 =
OPENVPN_PLUGIN_ENABLE_PF
 && 
suc˚ss
)

717  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

718 i‡(
	gîr‹
)

719  
	gOPENVPN_PLUGIN_FUNC_ERROR
;

720 i‡(
	gde„ºed
)

721  
	gOPENVPN_PLUGIN_FUNC_DEFERRED
;

724  
	gOPENVPN_PLUGIN_FUNC_SUCCESS
;

728 
	$∂ugö_li°_˛o£
 (
∂ugö_li°
 *
∂
)

730 i‡(
∂
)

732 i‡(
∂
->
comm⁄
)

734 
	`∂ugö_≥r_˛õ¡_de°roy
 (
∂
->
comm⁄
, &∂->
≥r_˛õ¡
);

736 i‡(
∂
->
comm⁄_ow√d
)

737 
	`∂ugö_comm⁄_˛o£
 (
∂
->
comm⁄
);

740 
	`‰ì
 (
∂
);

742 
	}
}

745 
	$∂ugö_ab‹t
 ()

747 
∂ugö_comm⁄
 *
pc
 = 
°©ic_∂ugö_comm⁄
;

748 
°©ic_∂ugö_comm⁄
 = 
NULL
;

749 i‡(
pc
)

751 
i
;

753 
i
 = 0; i < 
pc
->
n
; ++i)

754 
	`∂ugö_ab‹t_ôem
 (&
pc
->
∂ugös
[
i
]);

756 
	}
}

758 
boﬁ


759 
	$∂ugö_deföed
 (c⁄° 
∂ugö_li°
 *
∂
, c⁄° 
ty≥
)

761 
boﬁ
 
ªt
 = 
Ál£
;

763 i‡(
∂
)

765 c⁄° 
∂ugö_comm⁄
 *
pc
 = 
∂
->
comm⁄
;

767 i‡(
pc
)

769 
i
;

770 c⁄° 
mask
 = 
	`OPENVPN_PLUGIN_MASK
 (
ty≥
);

771 
i
 = 0; i < 
pc
->
n
; ++i)

773 i‡(
pc
->
∂ugös
[
i
].
∂ugö_ty≥_mask
 & 
mask
)

775 
ªt
 = 
åue
;

781  
ªt
;

782 
	}
}

789 
	$›ív≤_∂ugö_°rög_li°_ôem_‰ì
 (
›ív≤_∂ugö_°rög_li°
 *
l
)

791 i‡(
l
)

793 
	`‰ì
 (
l
->
«me
);

794 
	`°rög_˛ór
 (
l
->
vÆue
);

795 
	`‰ì
 (
l
->
vÆue
);

796 
	`‰ì
 (
l
);

798 
	}
}

801 
	$›ív≤_∂ugö_°rög_li°_‰ì
 (
›ív≤_∂ugö_°rög_li°
 *
l
)

803 
›ív≤_∂ugö_°rög_li°
 *
√xt
;

804 
l
)

806 
√xt
 = 
l
->next;

807 
	`›ív≤_∂ugö_°rög_li°_ôem_‰ì
 (
l
);

808 
l
 = 
√xt
;

810 
	}
}

812 
›ív≤_∂ugö_°rög_li°
 *

813 
	$›ív≤_∂ugö_°rög_li°_föd
 (
›ív≤_∂ugö_°rög_li°
 *
l
, c⁄° *
«me
)

815 
l
)

817 i‡(!
	`°rcmp
 (
l
->
«me
,Çame))

818  
l
;

819 
l
 =Ü->
√xt
;

821  
NULL
;

822 
	}
}

825 
	$∂ugö_ªtu∫_gë_cﬁumn
 (c⁄° 
∂ugö_ªtu∫
 *
§c
,

826 
∂ugö_ªtu∫
 *
de°
,

827 c⁄° *
cﬁ«me
)

829 
i
;

831 
de°
->
n
 = 0;

832 
i
 = 0; i < 
§c
->
n
; ++i)

833 
de°
->
li°
[
i
] = 
	`›ív≤_∂ugö_°rög_li°_föd
 (
§c
->li°[i], 
cﬁ«me
);

834 
de°
->
n
 = 
i
;

835 
	}
}

838 
	$∂ugö_ªtu∫_‰ì
 (
∂ugö_ªtu∫
 *
¥
)

840 
i
;

841 
i
 = 0; i < 
¥
->
n
; ++i)

842 
	`›ív≤_∂ugö_°rög_li°_‰ì
 (
¥
->
li°
[
i
]);

843 
¥
->
n
 = 0;

844 
	}
}

846 #ifde‡
ENABLE_DEBUG


848 
	$∂ugö_ªtu∫_¥öt
 (c⁄° 
msgÀvñ
, c⁄° *
¥efix
, c⁄° 
∂ugö_ªtu∫
 *
¥
)

850 
i
;

851 
	`msg
 (
msgÀvñ
, "PLUGIN_RETURN_PRINT %s", 
¥efix
);

852 
i
 = 0; i < 
¥
->
n
; ++i)

854 
›ív≤_∂ugö_°rög_li°
 *
l
 = 
¥
->
li°
[
i
];

855 
cou¡
 = 0;

857 
	`msg
 (
msgÀvñ
, "PLUGIN #%d (%s)", 
i
, 
¥efix
);

858 
l
)

860 
	`msg
 (
msgÀvñ
, "[%d] '%s' -> '%s'\n",

861 ++
cou¡
,

862 
l
->
«me
,

863 
l
->
vÆue
);

864 
l
 =Ü->
√xt
;

867 
	}
}

871 
	$dummy
(Ë{
	}
}

	@src/openvpn/plugin.h

29 #i‚de‡
OPENVPN_PLUGIN_H


30 
	#OPENVPN_PLUGIN_H


	)

32 #ifde‡
ENABLE_CRYPTO_OPENSSL


33 
	~"s¶_vîify_›ís¶.h
"

35 #ifde‡
ENABLE_CRYPTO_POLARSSL


36 
	~"s¶_vîify_pﬁ¨s¶.h
"

38 
	~"›ív≤-∂ugö.h
"

40 #ifde‡
ENABLE_PLUGIN


42 
	~"misc.h
"

44 
	#MAX_PLUGINS
 16

	)

46 
	s∂ugö_›ti⁄
 {

47 c⁄° *
	mso_∑th«me
;

48 c⁄° **
	m¨gv
;

51 
	s∂ugö_›ti⁄_li°
 {

52 
	mn
;

53 
∂ugö_›ti⁄
 
	m∂ugös
[
MAX_PLUGINS
];

56 
	s∂ugö
 {

57 
boﬁ
 
	möôülized
;

58 c⁄° *
	mso_∑th«me
;

59 
	m∂ugö_ty≥_mask
;

60 
	mªque°ed_öôüliz©i⁄_poöt
;

62 #i‚de‡
WIN32


63 *
	mh™dÀ
;

65 
HMODULE
 
	mmoduÀ
;

68 
›ív≤_∂ugö_›í_v1
 
	m›í1
;

69 
›ív≤_∂ugö_›í_v2
 
	m›í2
;

70 
›ív≤_∂ugö_›í_v3
 
	m›í3
;

71 
›ív≤_∂ugö_func_v1
 
	mfunc1
;

72 
›ív≤_∂ugö_func_v2
 
	mfunc2
;

73 
›ív≤_∂ugö_func_v3
 
	mfunc3
;

74 
›ív≤_∂ugö_˛o£_v1
 
	m˛o£
;

75 
›ív≤_∂ugö_ab‹t_v1
 
	mab‹t
;

76 
›ív≤_∂ugö_˛õ¡_c⁄°ru˘‹_v1
 
	m˛õ¡_c⁄°ru˘‹
;

77 
›ív≤_∂ugö_˛õ¡_de°ru˘‹_v1
 
	m˛õ¡_de°ru˘‹
;

78 
›ív≤_∂ugö_mö_vîsi⁄_ªquúed_v1
 
	mmö_vîsi⁄_ªquúed
;

79 
›ív≤_∂ugö_£À˘_öôüliz©i⁄_poöt_v1
 
	möôüliz©i⁄_poöt
;

81 
›ív≤_∂ugö_h™dÀ_t
 
	m∂ugö_h™dÀ
;

84 
	s∂ugö_≥r_˛õ¡


86 *
	m≥r_˛õ¡_c⁄ãxt
[
MAX_PLUGINS
];

89 
	s∂ugö_comm⁄


91 
	mn
;

92 
∂ugö
 
	m∂ugös
[
MAX_PLUGINS
];

95 
	s∂ugö_li°


97 
∂ugö_≥r_˛õ¡
 
	m≥r_˛õ¡
;

98 
∂ugö_comm⁄
 *
	mcomm⁄
;

99 
boﬁ
 
	mcomm⁄_ow√d
;

102 
	s∂ugö_ªtu∫


104 
	mn
;

105 
›ív≤_∂ugö_°rög_li°
 *
	mli°
[
MAX_PLUGINS
];

108 
∂ugö_›ti⁄_li°
 *
∂ugö_›ti⁄_li°_√w
 (
gc_¨ía
 *
gc
);

109 
boﬁ
 
∂ugö_›ti⁄_li°_add
 (
∂ugö_›ti⁄_li°
 *
li°
, **
p
, 
gc_¨ía
 *
gc
);

111 #i‚de‡
ENABLE_SMALL


112 
∂ugö_›ti⁄_li°_¥öt
 (c⁄° 
∂ugö_›ti⁄_li°
 *
li°
, 
msgÀvñ
);

115 
∂ugö_li°
 *
∂ugö_li°_öô
 (c⁄° 
∂ugö_›ti⁄_li°
 *
li°
);

117 
∂ugö_li°_›í
 (
∂ugö_li°
 *
∂
,

118 c⁄° 
∂ugö_›ti⁄_li°
 *
li°
,

119 
∂ugö_ªtu∫
 *
¥
,

120 c⁄° 
ív_£t
 *
es
,

121 c⁄° 
öô_poöt
);

123 
∂ugö_li°
 *
∂ugö_li°_öhîô
 (c⁄° ∂ugö_li° *
§c
);

125 
∂ugö_ˇŒ_s¶
 (c⁄° 
∂ugö_li°
 *
∂
,

126 c⁄° 
ty≥
,

127 c⁄° 
¨gv
 *
av
,

128 
∂ugö_ªtu∫
 *
¥
,

129 
ív_£t
 *
es


130 #ifde‡
ENABLE_SSL


131 , 
cuºít_˚π_dïth
,

132 
›ív≤_x509_˚π_t
 *
cuºít_˚π


136 
∂ugö_li°_˛o£
 (
∂ugö_li°
 *
∂
);

137 
boﬁ
 
∂ugö_deföed
 (c⁄° 
∂ugö_li°
 *
∂
, c⁄° 
ty≥
);

139 
∂ugö_ªtu∫_gë_cﬁumn
 (c⁄° 
∂ugö_ªtu∫
 *
§c
,

140 
∂ugö_ªtu∫
 *
de°
,

141 c⁄° *
cﬁ«me
);

143 
∂ugö_ªtu∫_‰ì
 (
∂ugö_ªtu∫
 *
¥
);

145 #ifde‡
ENABLE_DEBUG


146 
∂ugö_ªtu∫_¥öt
 (c⁄° 
msgÀvñ
, c⁄° *
¥efix
, c⁄° 
∂ugö_ªtu∫
 *
¥
);

149 
ölöe
 

150 
	$∂ugö_n
 (c⁄° 
∂ugö_li°
 *
∂
)

152 i‡(
∂
 &&Öl->
comm⁄
)

153  
∂
->
comm⁄
->
n
;

156 
	}
}

158 
ölöe
 
boﬁ


159 
	$∂ugö_ªtu∫_deföed
 (c⁄° 
∂ugö_ªtu∫
 *
¥
)

161  
¥
->
n
 >= 0;

162 
	}
}

164 
ölöe
 

165 
	$∂ugö_ªtu∫_öô
 (
∂ugö_ªtu∫
 *
¥
)

167 
¥
->
n
 = 0;

168 
	}
}

171 
	s∂ugö_li°
 { 
	mdummy
; };

172 
	s∂ugö_ªtu∫
 { 
	mdummy
; };

174 
ölöe
 
boﬁ


175 
	$∂ugö_deföed
 (c⁄° 
∂ugö_li°
 *
∂
, c⁄° 
ty≥
)

177  
Ál£
;

178 
	}
}

180 
ölöe
 

181 
∂ugö_ˇŒ_s¶
 (c⁄° 
∂ugö_li°
 *
∂
,

182 c⁄° 
ty≥
,

183 c⁄° 
¨gv
 *
av
,

184 
∂ugö_ªtu∫
 *
¥
,

185 
ív_£t
 *
es


186 #ifde‡
ENABLE_SSL


187 , 
cuºít_˚π_dïth
,

188 
›ív≤_x509_˚π_t
 *
cuºít_˚π


197 
ölöe
 

198 
	$∂ugö_ˇŒ
(c⁄° 
∂ugö_li°
 *
∂
,

199 c⁄° 
ty≥
,

200 c⁄° 
¨gv
 *
av
,

201 
∂ugö_ªtu∫
 *
¥
,

202 
ív_£t
 *
es
)

204  
	`∂ugö_ˇŒ_s¶
(
∂
, 
ty≥
, 
av
, 
¥
, 
es


205 #ifde‡
ENABLE_SSL


206 , -1, 
NULL


209 
	}
}

	@src/openvpn/pool.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"poﬁ.h
"

34 
	~"buf„r.h
"

35 
	~"îr‹.h
"

36 
	~"sockë.h
"

37 
	~"Ÿime.h
"

39 
	~"memdbg.h
"

41 #i‡
P2MP


44 
	$ifc⁄fig_poﬁ_íåy_‰ì
 (
ifc⁄fig_poﬁ_íåy
 *
ùe
, 
boﬁ
 
h¨d
)

46 
ùe
->
ö_u£
 = 
Ál£
;

47 i‡(
h¨d
 && 
ùe
->
comm⁄_«me
)

49 
	`‰ì
 (
ùe
->
comm⁄_«me
);

50 
ùe
->
comm⁄_«me
 = 
NULL
;

52 i‡(
h¨d
)

53 
ùe
->
œ°_ªÀa£
 = 0;

55 
ùe
->
œ°_ªÀa£
 = 
now
;

56 
	}
}

59 
	$ifc⁄fig_poﬁ_föd
 (
ifc⁄fig_poﬁ
 *
poﬁ
, c⁄° *
comm⁄_«me
)

61 
i
;

62 
time_t
 
óæõ°_ªÀa£
 = 0;

63 
¥evious_ußge
 = -1;

64 
√w_ußge
 = -1;

66 
i
 = 0; i < 
poﬁ
->
size
; ++i)

68 
ifc⁄fig_poﬁ_íåy
 *
ùe
 = &
poﬁ
->
li°
[
i
];

69 i‡(!
ùe
->
ö_u£
)

74 i‡(
poﬁ
->
du∂iˇã_˙
)

76 
√w_ußge
 = 
i
;

84 i‡((
√w_ußge
 =-1 || 
ùe
->
œ°_ªÀa£
 < 
óæõ°_ªÀa£
Ë&& !ùe->
fixed
)

86 
óæõ°_ªÀa£
 = 
ùe
->
œ°_ªÀa£
;

87 
√w_ußge
 = 
i
;

94 i‡(
¥evious_ußge
 < 0

95 && 
comm⁄_«me


96 && 
ùe
->
comm⁄_«me


97 && !
	`°rcmp
 (
comm⁄_«me
, 
ùe
->common_name))

98 
¥evious_ußge
 = 
i
;

103 i‡(
¥evious_ußge
 >= 0)

104  
¥evious_ußge
;

106 i‡(
√w_ußge
 >= 0)

107  
√w_ußge
;

110 
	}
}

115 
boﬁ


116 
	$ifc⁄fig_poﬁ_vîify_ønge
 (c⁄° 
msgÀvñ
, c⁄° 
ö_addr_t
 
°¨t
, c⁄° in_addr_à
íd
)

118 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

119 
boﬁ
 
ªt
 = 
åue
;

121 i‡(
°¨t
 > 
íd
)

123 
	`msg
 (
msgÀvñ
, "--ifconfig-pool start IP [%s] is greaterÅhanÉnd IP [%s]",

124 
	`¥öt_ö_addr_t
 (
°¨t
, 0, &
gc
),

125 
	`¥öt_ö_addr_t
 (
íd
, 0, &
gc
));

126 
ªt
 = 
Ál£
;

128 i‡(
íd
 - 
°¨t
 >
IFCONFIG_POOL_MAX
)

130 
	`msg
 (
msgÀvñ
, "--ifconfig-pooláddressÑange isÅooÜarge [%s -> %s]. Current maximum is %dáddresses,ás defined by IFCONFIG_POOL_MAX variable.",

131 
	`¥öt_ö_addr_t
 (
°¨t
, 0, &
gc
),

132 
	`¥öt_ö_addr_t
 (
íd
, 0, &
gc
),

133 
IFCONFIG_POOL_MAX
);

134 
ªt
 = 
Ál£
;

136 
	`gc_‰ì
 (&
gc
);

137  
ªt
;

138 
	}
}

140 
ifc⁄fig_poﬁ
 *

141 
	$ifc⁄fig_poﬁ_öô
 (
ty≥
, 
ö_addr_t
 
°¨t
, in_addr_à
íd
,

142 c⁄° 
boﬁ
 
du∂iˇã_˙
,

143 c⁄° 
boﬁ
 
ùv6_poﬁ
, c⁄° 
ö6_addr
 
ùv6_ba£
,

144 c⁄° 
ùv6_√tbôs
 )

146 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

147 
ifc⁄fig_poﬁ
 *
poﬁ
 = 
NULL
;

149 
	`ASSERT
 (
°¨t
 <
íd
 &&Énd - sèπ < 
IFCONFIG_POOL_MAX
);

150 
	`ALLOC_OBJ_CLEAR
 (
poﬁ
, 
ifc⁄fig_poﬁ
);

152 
poﬁ
->
ty≥
 =Åype;

153 
poﬁ
->
du∂iˇã_˙
 = duplicate_cn;

155 
ty≥
)

157 
IFCONFIG_POOL_30NET
:

158 
poﬁ
->
ba£
 = 
°¨t
 & ~3;

159 
poﬁ
->
size
 = (((
íd
 | 3Ë+ 1Ë-Öoﬁ->
ba£
) >> 2;

161 
IFCONFIG_POOL_INDIV
:

162 
poﬁ
->
ba£
 = 
°¨t
;

163 
poﬁ
->
size
 = 
íd
 - 
°¨t
 + 1;

166 
	`ASSERT
 (0);

170 
poﬁ
->
ùv6
 = 
ùv6_poﬁ
;

172 i‡–
poﬁ
->
ùv6
 )

174 
poﬁ
->
ba£_ùv6
 = 
ùv6_ba£
;

175 
poﬁ
->
size_ùv6
 = 
ùv6_√tbôs
>96? ( 1<<(128-ipv6_netbits) )

176 : 
IFCONFIG_POOL_MAX
;

178 
	`msg
–
D_IFCONFIG_POOL
, "IFCONFIG POOL IPv6: (IPv4) size=%d, size_ipv6=%d,Çetbits=%d, base_ipv6=%s",

179 
poﬁ
->
size
,Öoﬁ->
size_ùv6
, 
ùv6_√tbôs
,

180 
	`¥öt_ö6_addr
–
poﬁ
->
ba£_ùv6
, 0, &
gc
 ));

186 
	`ASSERT
–
poﬁ
->
size
 <Öoﬁ->
size_ùv6
 );

189 
	`ALLOC_ARRAY_CLEAR
 (
poﬁ
->
li°
, 
ifc⁄fig_poﬁ_íåy
,Öoﬁ->
size
);

191 
	`msg
 (
D_IFCONFIG_POOL
, "IFCONFIG POOL: base=%s size=%d, ipv6=%d",

192 
	`¥öt_ö_addr_t
 (
poﬁ
->
ba£
, 0, &
gc
),

193 
poﬁ
->
size
,Öoﬁ->
ùv6
 );

195 
	`gc_‰ì
 (&
gc
);

196  
poﬁ
;

197 
	}
}

200 
	$ifc⁄fig_poﬁ_‰ì
 (
ifc⁄fig_poﬁ
 *
poﬁ
)

202 i‡(
poﬁ
)

204 
i
;

205 
i
 = 0; i < 
poﬁ
->
size
; ++i)

206 
	`ifc⁄fig_poﬁ_íåy_‰ì
 (&
poﬁ
->
li°
[
i
], 
åue
);

207 
	`‰ì
 (
poﬁ
->
li°
);

208 
	`‰ì
 (
poﬁ
);

210 
	}
}

212 
ifc⁄fig_poﬁ_h™dÀ


213 
	$ifc⁄fig_poﬁ_acquúe
 (
ifc⁄fig_poﬁ
 *
poﬁ
, 
ö_addr_t
 *
loˇl
, in_addr_à*
ªmŸe
, 
ö6_addr
 *
ªmŸe_ùv6
, c⁄° *
comm⁄_«me
)

215 
i
;

217 
i
 = 
	`ifc⁄fig_poﬁ_föd
 (
poﬁ
, 
comm⁄_«me
);

218 i‡(
i
 >= 0)

220 
ifc⁄fig_poﬁ_íåy
 *
ùe
 = &
poﬁ
->
li°
[
i
];

221 
	`ASSERT
 (!
ùe
->
ö_u£
);

222 
	`ifc⁄fig_poﬁ_íåy_‰ì
 (
ùe
, 
åue
);

223 
ùe
->
ö_u£
 = 
åue
;

224 i‡(
comm⁄_«me
)

225 
ùe
->
comm⁄_«me
 = 
	`°rög_Æloc
 (comm⁄_«me, 
NULL
);

227 
poﬁ
->
ty≥
)

229 
IFCONFIG_POOL_30NET
:

231 
ö_addr_t
 
b
 = 
poﬁ
->
ba£
 + (
i
 << 2);

232 *
loˇl
 = 
b
 + 1;

233 *
ªmŸe
 = 
b
 + 2;

236 
IFCONFIG_POOL_INDIV
:

238 
ö_addr_t
 
b
 = 
poﬁ
->
ba£
 + 
i
;

239 *
loˇl
 = 0;

240 *
ªmŸe
 = 
b
;

244 
	`ASSERT
 (0);

248 i‡–
poﬁ
->
ùv6
 && 
ªmŸe_ùv6
 )

250 *
ªmŸe_ùv6
 = 
	`add_ö6_addr
–
poﬁ
->
ba£_ùv6
, 
i
 );

253  
i
;

254 
	}
}

256 
boﬁ


257 
	$ifc⁄fig_poﬁ_ªÀa£
 (
ifc⁄fig_poﬁ
* 
poﬁ
, 
ifc⁄fig_poﬁ_h™dÀ
 
h™d
, c⁄° 
boﬁ
 
h¨d
)

259 
boﬁ
 
ªt
 = 
Ál£
;

260 i‡(
poﬁ
 && 
h™d
 >0 && h™d <Öoﬁ->
size
)

262 
	`ifc⁄fig_poﬁ_íåy_‰ì
 (&
poﬁ
->
li°
[
h™d
], 
h¨d
);

263 
ªt
 = 
åue
;

265  
ªt
;

266 
	}
}

272 
ifc⁄fig_poﬁ_h™dÀ


273 
	$ifc⁄fig_poﬁ_ù_ba£_to_h™dÀ
 (c⁄° 
ifc⁄fig_poﬁ
* 
poﬁ
, c⁄° 
ö_addr_t
 
addr
)

275 
ifc⁄fig_poﬁ_h™dÀ
 
ªt
 = -1;

277 
poﬁ
->
ty≥
)

279 
IFCONFIG_POOL_30NET
:

281 
ªt
 = (
addr
 - 
poﬁ
->
ba£
) >> 2;

284 
IFCONFIG_POOL_INDIV
:

286 
ªt
 = (
addr
 - 
poﬁ
->
ba£
);

290 
	`ASSERT
 (0);

293 i‡(
ªt
 < 0 ||Ñë >
poﬁ
->
size
)

294 
ªt
 = -1;

296  
ªt
;

297 
	}
}

299 
ö_addr_t


300 
	$ifc⁄fig_poﬁ_h™dÀ_to_ù_ba£
 (c⁄° 
ifc⁄fig_poﬁ
* 
poﬁ
, 
ifc⁄fig_poﬁ_h™dÀ
 
h™d
)

302 
ö_addr_t
 
ªt
 = 0;

304 i‡(
h™d
 >0 && h™d < 
poﬁ
->
size
)

306 
poﬁ
->
ty≥
)

308 
IFCONFIG_POOL_30NET
:

310 
ªt
 = 
poﬁ
->
ba£
 + (
h™d
 << 2);;

313 
IFCONFIG_POOL_INDIV
:

315 
ªt
 = 
poﬁ
->
ba£
 + 
h™d
;

319 
	`ASSERT
 (0);

323  
ªt
;

324 
	}
}

326 
ö6_addr


327 
	$ifc⁄fig_poﬁ_h™dÀ_to_ùv6_ba£
 (c⁄° 
ifc⁄fig_poﬁ
* 
poﬁ
, 
ifc⁄fig_poﬁ_h™dÀ
 
h™d
)

329 
ö6_addr
 
ªt
 = 
ö6addr_™y
;

332 i‡(
h™d
 >0 && h™d < 
poﬁ
->
size_ùv6
 )

334 
ªt
 = 
	`add_ö6_addr
–
poﬁ
->
ba£_ùv6
, 
h™d
 );

336  
ªt
;

337 
	}
}

340 
	$ifc⁄fig_poﬁ_£t
 (
ifc⁄fig_poﬁ
* 
poﬁ
, c⁄° *
˙
, c⁄° 
ö_addr_t
 
addr
, c⁄° 
boﬁ
 
fixed
)

342 
ifc⁄fig_poﬁ_h™dÀ
 
h
 = 
	`ifc⁄fig_poﬁ_ù_ba£_to_h™dÀ
 (
poﬁ
, 
addr
);

343 i‡(
h
 >= 0)

345 
ifc⁄fig_poﬁ_íåy
 *
e
 = &
poﬁ
->
li°
[
h
];

346 
	`ifc⁄fig_poﬁ_íåy_‰ì
 (
e
, 
åue
);

347 
e
->
ö_u£
 = 
Ál£
;

348 
e
->
comm⁄_«me
 = 
	`°rög_Æloc
 (
˙
, 
NULL
);

349 
e
->
œ°_ªÀa£
 = 
now
;

350 
e
->
fixed
 = fixed;

352 
	}
}

355 
	$ifc⁄fig_poﬁ_li°
 (c⁄° 
ifc⁄fig_poﬁ
* 
poﬁ
, 
°©us_ouçut
 *
out
)

357 i‡(
poﬁ
 && 
out
)

359 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

360 
i
;

362 
i
 = 0; i < 
poﬁ
->
size
; ++i)

364 c⁄° 
ifc⁄fig_poﬁ_íåy
 *
e
 = &
poﬁ
->
li°
[
i
];

365 i‡(
e
->
comm⁄_«me
)

367 c⁄° 
ö_addr_t
 
ù
 = 
	`ifc⁄fig_poﬁ_h™dÀ_to_ù_ba£
 (
poﬁ
, 
i
);

368 i‡–
poﬁ
->
ùv6
 )

370 
ö6_addr
 
ù6
 = 
	`ifc⁄fig_poﬁ_h™dÀ_to_ùv6_ba£
 (
poﬁ
, 
i
);

371 
	`°©us_¥ötf
 (
out
, "%s,%s,%s",

372 
e
->
comm⁄_«me
,

373 
	`¥öt_ö_addr_t
 (
ù
, 0, &
gc
),

374 
	`¥öt_ö6_addr
 (
ù6
, 0, &
gc
));

378 
	`°©us_¥ötf
 (
out
, "%s,%s",

379 
e
->
comm⁄_«me
,

380 
	`¥öt_ö_addr_t
 (
ù
, 0, &
gc
));

384 
	`gc_‰ì
 (&
gc
);

386 
	}
}

389 
	$ifc⁄fig_poﬁ_msg
 (c⁄° 
ifc⁄fig_poﬁ
* 
poﬁ
, 
msgÀvñ
)

391 
°©us_ouçut
 *
so
 = 
	`°©us_›í
 (
NULL
, 0, 
msgÀvñ
, NULL, 0);

392 
	`ASSERT
 (
so
);

393 
	`°©us_¥ötf
 (
so
, "IFCONFIG POOL LIST");

394 
	`ifc⁄fig_poﬁ_li°
 (
poﬁ
, 
so
);

395 
	`°©us_˛o£
 (
so
);

396 
	}
}

402 
ifc⁄fig_poﬁ_≥rsi°
 *

403 
	$ifc⁄fig_poﬁ_≥rsi°_öô
 (c⁄° *
fûíame
, 
ª‰esh_‰eq
)

405 
ifc⁄fig_poﬁ_≥rsi°
 *
ªt
;

407 
	`ASSERT
 (
fûíame
);

409 
	`ALLOC_OBJ_CLEAR
 (
ªt
, 
ifc⁄fig_poﬁ_≥rsi°
);

410 i‡(
ª‰esh_‰eq
 > 0)

412 
ªt
->
fixed
 = 
Ál£
;

413 
ªt
->
fûe
 = 
	`°©us_›í
 (
fûíame
, 
ª‰esh_‰eq
, -1, 
NULL
, 
STATUS_OUTPUT_READ
|
STATUS_OUTPUT_WRITE
);

417 
ªt
->
fixed
 = 
åue
;

418 
ªt
->
fûe
 = 
	`°©us_›í
 (
fûíame
, 0, -1, 
NULL
, 
STATUS_OUTPUT_READ
);

420  
ªt
;

421 
	}
}

424 
	$ifc⁄fig_poﬁ_≥rsi°_˛o£
 (
ifc⁄fig_poﬁ_≥rsi°
 *
≥rsi°
)

426 i‡(
≥rsi°
)

428 i‡(
≥rsi°
->
fûe
)

429 
	`°©us_˛o£
 (
≥rsi°
->
fûe
);

430 
	`‰ì
 (
≥rsi°
);

432 
	}
}

434 
boﬁ


435 
	$ifc⁄fig_poﬁ_wrôe_åiggî
 (
ifc⁄fig_poﬁ_≥rsi°
 *
≥rsi°
)

437 i‡(
≥rsi°
->
fûe
)

438  
	`°©us_åiggî
 (
≥rsi°
->
fûe
);

440  
Ál£
;

441 
	}
}

444 
	$ifc⁄fig_poﬁ_ªad
 (
ifc⁄fig_poﬁ_≥rsi°
 *
≥rsi°
, 
ifc⁄fig_poﬁ
 *
poﬁ
)

446 c⁄° 
buf_size
 = 128;

448 
	`upd©e_time
 ();

449 i‡(
≥rsi°
 &&Öîsi°->
fûe
 && 
poﬁ
)

451 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

452 
buf„r
 
ö
 = 
	`Æloc_buf_gc
 (256, &
gc
);

453 *
˙_buf
;

454 *
ù_buf
;

455 
löe
 = 0;

457 
	`ALLOC_ARRAY_CLEAR_GC
 (
˙_buf
, , 
buf_size
, &
gc
);

458 
	`ALLOC_ARRAY_CLEAR_GC
 (
ù_buf
, , 
buf_size
, &
gc
);

460 
åue
)

462 
	`ASSERT
 (
	`buf_öô
 (&
ö
, 0));

463 i‡(!
	`°©us_ªad
 (
≥rsi°
->
fûe
, &
ö
))

465 ++
löe
;

466 i‡(
	`BLEN
 (&
ö
))

468 
c
 = *
	`BSTR
(&
ö
);

469 i‡(
c
 == '#' || c == ';')

471 
	`msg
–
M_INFO
, "ifconfig_pool_read(), in='%s', TODO: IPv6",

472 
	`BSTR
(&
ö
) );

474 i‡(
	`buf_∑r£
 (&
ö
, ',', 
˙_buf
, 
buf_size
)

475 && 
	`buf_∑r£
 (&
ö
, ',', 
ù_buf
, 
buf_size
))

477 
boﬁ
 
suc˚eded
;

478 c⁄° 
ö_addr_t
 
addr
 = 
	`gëaddr
 (
GETADDR_HOST_ORDER
, 
ù_buf
, 0, &
suc˚eded
, 
NULL
);

479 i‡(
suc˚eded
)

481 
	`msg
–
M_INFO
, "succeeded -> ifconfig_pool_set()");

482 
	`ifc⁄fig_poﬁ_£t
 (
poﬁ
, 
˙_buf
, 
addr
, 
≥rsi°
->
fixed
);

488 
	`ifc⁄fig_poﬁ_msg
 (
poﬁ
, 
D_IFCONFIG_POOL
);

490 
	`gc_‰ì
 (&
gc
);

492 
	}
}

495 
	$ifc⁄fig_poﬁ_wrôe
 (
ifc⁄fig_poﬁ_≥rsi°
 *
≥rsi°
, c⁄° 
ifc⁄fig_poﬁ
 *
poﬁ
)

497 i‡(
≥rsi°
 &&Öîsi°->
fûe
 && (
	`°©us_rw_Êags
 (≥rsi°->fûeË& 
STATUS_OUTPUT_WRITE
Ë&& 
poﬁ
)

499 
	`°©us_ª£t
 (
≥rsi°
->
fûe
);

500 
	`ifc⁄fig_poﬁ_li°
 (
poﬁ
, 
≥rsi°
->
fûe
);

501 
	`°©us_Êush
 (
≥rsi°
->
fûe
);

503 
	}
}

509 #ifde‡
IFCONFIG_POOL_TEST


511 
	#DUP_CN


	)

514 
	$ifc⁄fig_poﬁ_ã°
 (
ö_addr_t
 
°¨t
, in_addr_à
íd
)

516 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

517 
ifc⁄fig_poﬁ
 *
p
 = 
	`ifc⁄fig_poﬁ_öô
 (
IFCONFIG_POOL_30NET
, 
°¨t
, 
íd
);

519 
ifc⁄fig_poﬁ_h™dÀ
 
¨øy
[256];

520 
i
;

522 
	`CLEAR
 (
¨øy
);

524 
	`msg
 (
M_INFO
 | 
M_NOPREFIX
, "************ 1");

525 
i
 = 0; i < (Ë
	`SIZE
 (
¨øy
); ++i)

527 *
˙
;

528 
ifc⁄fig_poﬁ_h™dÀ
 
h
;

529 
ö_addr_t
 
loˇl
, 
ªmŸe
;

530 
buf
[256];

531 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "comm⁄-«me-%d", 
i
);

532 #ifde‡
DUP_CN


533 
˙
 = 
NULL
;

535 
˙
 = 
buf
;

537 
h
 = 
	`ifc⁄fig_poﬁ_acquúe
 (
p
, &
loˇl
, &
ªmŸe
, 
NULL
, 
˙
);

538 i‡(
h
 < 0)

540 
	`msg
 (
M_INFO
 | 
M_NOPREFIX
, "IFCONFIG_POOL TESTÖass 1:Ü=%sÑ=%s cn=%s",

541 
	`¥öt_ö_addr_t
 (
loˇl
, 0, &
gc
),

542 
	`¥öt_ö_addr_t
 (
ªmŸe
, 0, &
gc
),

543 
˙
);

544 
¨øy
[
i
] = 
h
;

548 
	`msg
 (
M_INFO
 | 
M_NOPREFIX
, "************* 2");

549 
i
 = (Ë
	`SIZE
 (
¨øy
) / 16; i < () SIZE (array) / 8; ++i)

551 
	`msg
 (
M_INFO
, "Aâem±ÅÿªÀa£ %d cn=%s", 
¨øy
[
i
], 
p
->
li°
[i].
comm⁄_«me
);

552 i‡(!
	`ifc⁄fig_poﬁ_ªÀa£
 (
p
, 
¨øy
[
i
]))

554 
	`msg
 (
M_INFO
, "Succeeded");

557 
	`CLEAR
 (
¨øy
);

559 
	`msg
 (
M_INFO
 | 
M_NOPREFIX
, "**************** 3");

560 
i
 = 0; i < (Ë
	`SIZE
 (
¨øy
); ++i)

562 *
˙
;

563 
ifc⁄fig_poﬁ_h™dÀ
 
h
;

564 
ö_addr_t
 
loˇl
, 
ªmŸe
;

565 
buf
[256];

566 
	`¢¥ötf
 (
buf
, (buf), "comm⁄-«me-%d", 
i
+24);

567 #ifde‡
DUP_CN


568 
˙
 = 
NULL
;

570 
˙
 = 
buf
;

572 
h
 = 
	`ifc⁄fig_poﬁ_acquúe
 (
p
, &
loˇl
, &
ªmŸe
, 
NULL
, 
˙
);

573 i‡(
h
 < 0)

575 
	`msg
 (
M_INFO
 | 
M_NOPREFIX
, "IFCONFIG_POOL TESTÖass 3:Ü=%sÑ=%s cn=%s",

576 
	`¥öt_ö_addr_t
 (
loˇl
, 0, &
gc
),

577 
	`¥öt_ö_addr_t
 (
ªmŸe
, 0, &
gc
),

578 
˙
);

579 
¨øy
[
i
] = 
h
;

583 
	`ifc⁄fig_poﬁ_‰ì
 (
p
);

584 
	`gc_‰ì
 (&
gc
);

585 
	}
}

	@src/openvpn/pool.h

25 #i‚de‡
POOL_H


26 
	#POOL_H


	)

28 #i‡
P2MP


32 
	~"basic.h
"

33 
	~"°©us.h
"

35 
	#IFCONFIG_POOL_MAX
 65536

	)

36 
	#IFCONFIG_POOL_MIN_NETBITS
 16

	)

38 
	#IFCONFIG_POOL_30NET
 0

	)

39 
	#IFCONFIG_POOL_INDIV
 1

	)

41 
	sifc⁄fig_poﬁ_íåy


43 
boﬁ
 
	mö_u£
;

44 *
	mcomm⁄_«me
;

45 
time_t
 
	mœ°_ªÀa£
;

46 
boﬁ
 
	mfixed
;

49 
	sifc⁄fig_poﬁ


51 
ö_addr_t
 
	mba£
;

52 
	msize
;

53 
	mty≥
;

54 
boﬁ
 
	mdu∂iˇã_˙
;

55 
boﬁ
 
	mùv6
;

56 
ö6_addr
 
	mba£_ùv6
;

57 
	msize_ùv6
;

58 
ifc⁄fig_poﬁ_íåy
 *
	mli°
;

61 
	sifc⁄fig_poﬁ_≥rsi°


63 
°©us_ouçut
 *
	mfûe
;

64 
boﬁ
 
	mfixed
;

67 
	tifc⁄fig_poﬁ_h™dÀ
;

69 
ifc⁄fig_poﬁ
 *
ifc⁄fig_poﬁ_öô
 (
ty≥
, 
ö_addr_t
 
°¨t
, in_addr_à
íd
, c⁄° 
boﬁ
 
du∂iˇã_˙
, c⁄° boﬁ 
ùv6_poﬁ
, c⁄° 
ö6_addr
 
ùv6_ba£
, c⁄° 
ùv6_√tbôs
 );

71 
ifc⁄fig_poﬁ_‰ì
 (
ifc⁄fig_poﬁ
 *
poﬁ
);

73 
boﬁ
 
ifc⁄fig_poﬁ_vîify_ønge
 (c⁄° 
msgÀvñ
, c⁄° 
ö_addr_t
 
°¨t
, c⁄° in_addr_à
íd
);

75 
ifc⁄fig_poﬁ_h™dÀ
 
ifc⁄fig_poﬁ_acquúe
 (
ifc⁄fig_poﬁ
 *
poﬁ
, 
ö_addr_t
 *
loˇl
, in_addr_à*
ªmŸe
, 
ö6_addr
 *
ªmŸe_ùv6
, c⁄° *
comm⁄_«me
);

77 
boﬁ
 
ifc⁄fig_poﬁ_ªÀa£
 (
ifc⁄fig_poﬁ
* 
poﬁ
, 
ifc⁄fig_poﬁ_h™dÀ
 
h™d
, c⁄° boﬁ 
h¨d
);

79 
ifc⁄fig_poﬁ_≥rsi°
 *
ifc⁄fig_poﬁ_≥rsi°_öô
 (c⁄° *
fûíame
, 
ª‰esh_‰eq
);

80 
ifc⁄fig_poﬁ_≥rsi°_˛o£
 (
ifc⁄fig_poﬁ_≥rsi°
 *
≥rsi°
);

81 
boﬁ
 
ifc⁄fig_poﬁ_wrôe_åiggî
 (
ifc⁄fig_poﬁ_≥rsi°
 *
≥rsi°
);

83 
ifc⁄fig_poﬁ_ªad
 (
ifc⁄fig_poﬁ_≥rsi°
 *
≥rsi°
, 
ifc⁄fig_poﬁ
 *
poﬁ
);

84 
ifc⁄fig_poﬁ_wrôe
 (
ifc⁄fig_poﬁ_≥rsi°
 *
≥rsi°
, c⁄° 
ifc⁄fig_poﬁ
 *
poﬁ
);

86 #ifde‡
IFCONFIG_POOL_TEST


87 
ifc⁄fig_poﬁ_ã°
 (
ö_addr_t
 
°¨t
, in_addr_à
íd
);

	@src/openvpn/proto.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"¥Ÿo.h
"

34 
	~"îr‹.h
"

36 
	~"memdbg.h
"

43 
boﬁ


44 
	$is_ùv_X
 ( 
tu¬ñ_ty≥
, 
buf„r
 *
buf
, 
ù_vî
 )

46 
off£t
;

47 c⁄° 
›ív≤_ùhdr
 *
ih
;

49 
	`vîify_Æign_4
 (
buf
);

50 i‡(
tu¬ñ_ty≥
 =
DEV_TYPE_TUN
)

52 i‡(
	`BLEN
 (
buf
Ë< (Ë (
›ív≤_ùhdr
))

53  
Ál£
;

54 
off£t
 = 0;

56 i‡(
tu¬ñ_ty≥
 =
DEV_TYPE_TAP
)

58 c⁄° 
›ív≤_ëhhdr
 *
eh
;

59 i‡(
	`BLEN
 (
buf
Ë< ()( (
›ív≤_ëhhdr
)

60 +  (
›ív≤_ùhdr
)))

61  
Ál£
;

62 
eh
 = (c⁄° 
›ív≤_ëhhdr
 *Ë
	`BPTR
 (
buf
);

63 i‡(
	`¡ohs
 (
eh
->
¥Ÿo
Ë!(
ù_vî
 =6 ? 
OPENVPN_ETH_P_IPV6
 : 
OPENVPN_ETH_P_IPV4
))

64  
Ál£
;

65 
off£t
 =  (
›ív≤_ëhhdr
);

68  
Ál£
;

70 
ih
 = (c⁄° 
›ív≤_ùhdr
 *Ë(
	`BPTR
 (
buf
Ë+ 
off£t
);

73 i‡(
	`OPENVPN_IPH_GET_VER
 (
ih
->
vîsi⁄_Àn
Ë=
ù_vî
)

74  
	`buf_adv™˚
 (
buf
, 
off£t
);

76  
Ál£
;

77 
	}
}

79 
boﬁ


80 
	$is_ùv4
 (
tu¬ñ_ty≥
, 
buf„r
 *
buf
)

82  
	`is_ùv_X
–
tu¬ñ_ty≥
, 
buf
, 4 );

83 
	}
}

84 
boﬁ


85 
	$is_ùv6
 (
tu¬ñ_ty≥
, 
buf„r
 *
buf
)

87  
	`is_ùv_X
–
tu¬ñ_ty≥
, 
buf
, 6 );

88 
	}
}

90 #ifde‡
PACKET_TRUNCATION_CHECK


93 
	$ùv4_∑ckë_size_vîify
 (c⁄° 
uöt8_t
 *
d©a
,

94 c⁄° 
size
,

95 c⁄° 
tu¬ñ_ty≥
,

96 c⁄° *
¥efix
,

97 
cou¡î_ty≥
 *
îr‹s
)

99 i‡(
size
 > 0)

101 
buf„r
 
buf
;

103 
	`buf_£t_ªad
 (&
buf
, 
d©a
, 
size
);

105 i‡(
	`is_ùv4
 (
tu¬ñ_ty≥
, &
buf
))

107 c⁄° 
›ív≤_ùhdr
 *
pù
;

108 
hÀn
;

109 
tŸÀn
;

110 c⁄° *
msg°r
 = "PACKET SIZE INFO";

111 
msgÀvñ
 = 
D_PACKET_TRUNC_DEBUG
;

113 i‡(
	`BLEN
 (&
buf
Ë< (Ë (
›ív≤_ùhdr
))

116 
	`vîify_Æign_4
 (&
buf
);

117 
pù
 = (
›ív≤_ùhdr
 *Ë
	`BPTR
 (&
buf
);

119 
hÀn
 = 
	`OPENVPN_IPH_GET_LEN
 (
pù
->
vîsi⁄_Àn
);

120 
tŸÀn
 = 
	`¡ohs
 (
pù
->
tŸ_Àn
);

122 i‡(
	`BLEN
 (&
buf
Ë!
tŸÀn
)

124 
msg°r
 = "PACKET TRUNCATION ERROR";

125 
msgÀvñ
 = 
D_PACKET_TRUNC_ERR
;

126 i‡(
îr‹s
)

127 ++(*
îr‹s
);

130 
	`msg
 (
msgÀvñ
, "%†%s: size=%dÅŸÀn=%d hÀn=%dÉºcou¡=" 
cou¡î_f‹m©
,

131 
msg°r
,

132 
¥efix
,

133 
	`BLEN
 (&
buf
),

134 
tŸÀn
,

135 
hÀn
,

136 
îr‹s
 ? *îr‹†: (
cou¡î_ty≥
)0);

139 
	}
}

	@src/openvpn/proto.h

25 #i‚de‡
PROTO_H


26 
	#PROTO_H


	)

28 
	~"comm⁄.h
"

29 
	~"buf„r.h
"

31 #¥agm®
∑ck
(1)

36 
	#DEV_TYPE_UNDEF
 0

	)

37 
	#DEV_TYPE_NULL
 1

	)

38 
	#DEV_TYPE_TUN
 2

	)

39 
	#DEV_TYPE_TAP
 3

	)

43 
	#TOP_UNDEF
 0

	)

44 
	#TOP_NET30
 1

	)

45 
	#TOP_P2P
 2

	)

46 
	#TOP_SUBNET
 3

	)

55 
	#OPENVPN_ETH_ALEN
 6

	)

56 
	s›ív≤_ëhhdr


58 
uöt8_t
 
	mde°
[
OPENVPN_ETH_ALEN
];

59 
uöt8_t
 
	msour˚
[
OPENVPN_ETH_ALEN
];

61 
	#OPENVPN_ETH_P_IPV4
 0x0800

	)

62 
	#OPENVPN_ETH_P_IPV6
 0x86DD

	)

63 
	#OPENVPN_ETH_P_ARP
 0x0806

	)

64 
uöt16_t
 
	m¥Ÿo
;

67 
	s›ív≤_¨p
 {

68 
	#ARP_MAC_ADDR_TYPE
 0x0001

	)

69 
uöt16_t
 
	mmac_addr_ty≥
;

71 
uöt16_t
 
	m¥Ÿo_addr_ty≥
;

72 
uöt8_t
 
	mmac_addr_size
;

73 
uöt8_t
 
	m¥Ÿo_addr_size
;

75 
	#ARP_REQUEST
 0x0001

	)

76 
	#ARP_REPLY
 0x0002

	)

77 
uöt16_t
 
	m¨p_comm™d
;

79 
uöt8_t
 
	mmac_§c
[
OPENVPN_ETH_ALEN
];

80 
ö_addr_t
 
	mù_§c
;

81 
uöt8_t
 
	mmac_de°
[
OPENVPN_ETH_ALEN
];

82 
ö_addr_t
 
	mù_de°
;

85 
	s›ív≤_ùhdr
 {

86 
	#OPENVPN_IPH_GET_VER
(
v
Ë(((vË>> 4Ë& 0x0F)

	)

87 
	#OPENVPN_IPH_GET_LEN
(
v
Ë(((vË& 0x0FË<< 2)

	)

88 
uöt8_t
 
	mvîsi⁄_Àn
;

90 
uöt8_t
 
	mtos
;

91 
uöt16_t
 
	mtŸ_Àn
;

92 
uöt16_t
 
	mid
;

94 
	#OPENVPN_IP_OFFMASK
 0x1fff

	)

95 
uöt16_t
 
	m‰ag_off
;

97 
uöt8_t
 
	mâl
;

99 
	#OPENVPN_IPPROTO_IGMP
 2

	)

100 
	#OPENVPN_IPPROTO_TCP
 6

	)

101 
	#OPENVPN_IPPROTO_UDP
 17

	)

102 
uöt8_t
 
	m¥Ÿocﬁ
;

104 
uöt16_t
 
	mcheck
;

105 
uöt32_t
 
	mßddr
;

106 
uöt32_t
 
	mdaddr
;

113 
	s›ív≤_ùv6hdr
 {

114 
uöt8_t
 
	mvîsi⁄_¥io
;

115 
uöt8_t
 
	mÊow_lbl
[3];

116 
uöt16_t
 
	m∑ylﬂd_Àn
;

117 
uöt8_t
 
	m√xthdr
;

118 
uöt8_t
 
	mh›_limô
;

120 
ö6_addr
 
	mßddr
;

121 
ö6_addr
 
	mdaddr
;

128 
	s›ív≤_udphdr
 {

129 
uöt16_t
 
	msour˚
;

130 
uöt16_t
 
	mde°
;

131 
uöt16_t
 
	mÀn
;

132 
uöt16_t
 
	mcheck
;

138 
	s›ív≤_t˝hdr
 {

139 
uöt16_t
 
	msour˚
;

140 
uöt16_t
 
	mde°
;

141 
uöt32_t
 
	m£q
;

142 
uöt32_t
 
	mack_£q
;

144 
	#OPENVPN_TCPH_GET_DOFF
(
d
Ë(((dË& 0xF0Ë>> 2)

	)

145 
uöt8_t
 
	mdoff_ªs
;

147 
	#OPENVPN_TCPH_FIN_MASK
 (1<<0)

	)

148 
	#OPENVPN_TCPH_SYN_MASK
 (1<<1)

	)

149 
	#OPENVPN_TCPH_RST_MASK
 (1<<2)

	)

150 
	#OPENVPN_TCPH_PSH_MASK
 (1<<3)

	)

151 
	#OPENVPN_TCPH_ACK_MASK
 (1<<4)

	)

152 
	#OPENVPN_TCPH_URG_MASK
 (1<<5)

	)

153 
	#OPENVPN_TCPH_ECE_MASK
 (1<<6)

	)

154 
	#OPENVPN_TCPH_CWR_MASK
 (1<<7)

	)

155 
uöt8_t
 
	mÊags
;

157 
uöt16_t
 
	mwödow
;

158 
uöt16_t
 
	mcheck
;

159 
uöt16_t
 
	murg_±r
;

162 
	#OPENVPN_TCPOPT_EOL
 0

	)

163 
	#OPENVPN_TCPOPT_NOP
 1

	)

164 
	#OPENVPN_TCPOPT_MAXSEG
 2

	)

165 
	#OPENVPN_TCPOLEN_MAXSEG
 4

	)

167 
	sù_t˝_udp_hdr
 {

168 
›ív≤_ùhdr
 
	mù
;

170 
›ív≤_t˝hdr
 
	mt˝
;

171 
›ív≤_udphdr
 
	mudp
;

172 } 
	mu
;

175 #¥agm®
∑ck
()

185 
	#ADJUST_CHECKSUM
(
acc
, 
cksum
) { \

186 
_acc
 = 
acc
; \

187 
_acc
 +(
cksum
); \

188 i‡(
_acc
 < 0) { \

189 
_acc
 = -_acc; \

190 
_acc
 = (_acc >> 16) + (_acc & 0xffff); \

191 
_acc
 += _acc >> 16; \

192 (
cksum
Ë(
uöt16_t
Ë~
_acc
; \

194 
_acc
 = (_acc >> 16) + (_acc & 0xffff); \

195 
_acc
 += _acc >> 16; \

196 (
cksum
Ë(
uöt16_t
Ë
_acc
; \

198 }

	)

200 
	#ADD_CHECKSUM_32
(
acc
, 
u32
) { \

201 
acc
 +(
u32
) & 0xffff; \

202 
acc
 +(
u32
) >> 16; \

203 }

	)

205 
	#SUB_CHECKSUM_32
(
acc
, 
u32
) { \

206 
acc
 -(
u32
) & 0xffff; \

207 
acc
 -(
u32
) >> 16; \

208 }

	)

218 
	#MTU_TO_MSS
(
mtu
Ë(mtu - (
›ív≤_ùhdr
) \

219 - (
›ív≤_t˝hdr
))

	)

225 
boﬁ
 
is_ùv4
 (
tu¬ñ_ty≥
, 
buf„r
 *
buf
);

226 
boﬁ
 
is_ùv6
 (
tu¬ñ_ty≥
, 
buf„r
 *
buf
);

228 #ifde‡
PACKET_TRUNCATION_CHECK


229 
ùv4_∑ckë_size_vîify
 (c⁄° 
uöt8_t
 *
d©a
,

230 c⁄° 
size
,

231 c⁄° 
tu¬ñ_ty≥
,

233 *
¥efix
,

234 
cou¡î_ty≥
 *
îr‹s
);

	@src/openvpn/proxy.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"comm⁄.h
"

34 
	~"misc.h
"

35 
	~"¸y±o.h
"

36 
	~"wö32.h
"

37 
	~"sockë.h
"

38 
	~"fdmisc.h
"

39 
	~"¥oxy.h
"

40 
	~"ba£64.h
"

41 
	~"hâpdige°.h
"

42 
	~"¡lm.h
"

43 
	~"memdbg.h
"

45 #ifde‡
ENABLE_HTTP_PROXY


47 
	#UP_TYPE_PROXY
 "HTTP Proxy"

	)

49 
hâp_¥oxy_›ti⁄s
 *

50 
	$öô_hâp_¥oxy_›ti⁄s_⁄˚
 (
hâp_¥oxy_›ti⁄s
 **
hpo
,

51 
gc_¨ía
 *
gc
)

53 i‡(!*
hpo
)

55 
	`ALLOC_OBJ_CLEAR_GC
 (*
hpo
, 
hâp_¥oxy_›ti⁄s
, 
gc
);

57 (*
hpo
)->
timeout
 = 5;

58 (*
hpo
)->
hâp_vîsi⁄
 = "1.0";

60  *
hpo
;

61 
	}
}

65 
u£r_∑ss
 
	g°©ic_¥oxy_u£r_∑ss
;

67 
boﬁ


68 
	$ªcv_löe
 (
sockë_des¸ùt‹_t
 
sd
,

69 *
buf
,

70 
Àn
,

71 c⁄° 
timeout_£c
,

72 c⁄° 
boﬁ
 
vîbo£
,

73 
buf„r
 *
lookahód
,

74 vﬁ©ûê*
sig«l_ª˚ived
)

76 
buf„r
 
œ
;

77 
œ°c
 = 0;

79 
	`CLEAR
 (
œ
);

80 i‡(
lookahód
)

81 
œ
 = *
lookahód
;

83 
åue
)

85 
°©us
;

86 
ssize_t
 
size
;

87 
fd_£t
 
ªads
;

88 
timevÆ
 
tv
;

89 
uöt8_t
 
c
;

91 i‡(
	`buf_deföed
 (&
œ
))

93 
	`ASSERT
 (
	`buf_öô
 (&
œ
, 0));

96 
	`FD_ZERO
 (&
ªads
);

97 
	`FD_SET
 (
sd
, &
ªads
);

98 
tv
.
tv_£c
 = 
timeout_£c
;

99 
tv
.
tv_u£c
 = 0;

101 
°©us
 = 
	`£À˘
 (
sd
 + 1, &
ªads
, 
NULL
, NULL, &
tv
);

103 
	`gë_sig«l
 (
sig«l_ª˚ived
);

104 i‡(*
sig«l_ª˚ived
)

105 
îr‹
;

108 i‡(
°©us
 == 0)

110 i‡(
vîbo£
)

111 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "recv_line: TCPÖortÑeadÅimeoutÉxpired");

112 
îr‹
;

116 i‡(
°©us
 < 0)

118 i‡(
vîbo£
)

119 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "recv_line: TCPÖortÑead failed on select()");

120 
îr‹
;

124 
size
 = 
	`ªcv
 (
sd
, &
c
, 1, 
MSG_NOSIGNAL
);

127 i‡(
size
 != 1)

129 i‡(
vîbo£
)

130 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "recv_line: TCPÖortÑead failed onÑecv()");

131 
îr‹
;

135 i‡(
	`i•röt
(
c
))

136 
	`msg
 (
M_INFO
, "PROXY:Ñód '%c' (%d)", 
c
, ()c);

138 
	`msg
 (
M_INFO
, "PROXY:Ñód (%d)", ()
c
);

142 i‡(
Àn
 > 1)

144 *
buf
++ = 
c
;

145 --
Àn
;

149 i‡(
	`buf_deföed
 (&
œ
))

151 
	`buf_wrôe_u8
 (&
œ
, 
c
);

152 i‡(!
	`i•röt
(
c
Ë&& !
	`is•a˚
(c))

154 i‡(
vîbo£
)

155 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "ªcv_löe: N⁄-ASCII ch¨a˘î (%dËªad o¿ªcv()", ()
c
);

156 *
lookahód
 = 
œ
;

157  
Ál£
;

162 i‡(
œ°c
 ='\r' && 
c
 == '\n')

165 
œ°c
 = 
c
;

169 i‡(
Àn
 > 0)

170 *
buf
++ = '\0';

172  
åue
;

174 
îr‹
:

175  
Ál£
;

176 
	}
}

178 
boﬁ


179 
	$£nd_löe
 (
sockë_des¸ùt‹_t
 
sd
,

180 c⁄° *
buf
)

182 c⁄° 
ssize_t
 
size
 = 
	`£nd
 (
sd
, 
buf
, 
	`°æí
 (buf), 
MSG_NOSIGNAL
);

183 i‡(
size
 !(
ssize_t
Ë
	`°æí
 (
buf
))

185 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "send_line: TCPÖort write failed on send()");

186  
Ál£
;

188  
åue
;

189 
	}
}

191 
boﬁ


192 
	$£nd_löe_¸lf
 (
sockë_des¸ùt‹_t
 
sd
,

193 c⁄° *
§c
)

195 
boﬁ
 
ªt
;

197 
buf„r
 
buf
 = 
	`Æloc_buf
 (
	`°æí
 (
§c
) + 3);

198 
	`ASSERT
 (
	`buf_wrôe
 (&
buf
, 
§c
, 
	`°æí
 (src)));

199 
	`ASSERT
 (
	`buf_wrôe
 (&
buf
, "\r\n", 3));

200 
ªt
 = 
	`£nd_löe
 (
sd
, 
	`BSTR
 (&
buf
));

201 
	`‰ì_buf
 (&
buf
);

202  
ªt
;

203 
	}
}

205 
boﬁ


206 
	$£nd_¸lf
 (
sockë_des¸ùt‹_t
 
sd
)

208  
	`£nd_löe_¸lf
 (
sd
, "");

209 
	}
}

211 
uöt8_t
 *

212 
	$make_ba£64_°rög2
 (c⁄° 
uöt8_t
 *
°r
, 
§c_Àn
, 
gc_¨ía
 *
gc
)

214 
uöt8_t
 *
ªt
 = 
NULL
;

215 *
b64out
 = 
NULL
;

216 
	`ASSERT
 (
	`›ív≤_ba£64_ícode
 ((c⁄° *)
°r
, 
§c_Àn
, &
b64out
) >= 0);

217 
ªt
 = (
uöt8_t
 *Ë
	`°rög_Æloc
 (
b64out
, 
gc
);

218 
	`‰ì
 (
b64out
);

219  
ªt
;

220 
	}
}

222 
uöt8_t
 *

223 
	$make_ba£64_°rög
 (c⁄° 
uöt8_t
 *
°r
, 
gc_¨ía
 *
gc
)

225  
	`make_ba£64_°rög2
 (
°r
, 
	`°æí
 ((c⁄° *)°r), 
gc
);

226 
	}
}

229 
	$u£∫ame_∑ssw‹d_as_ba£64
 (c⁄° 
hâp_¥oxy_öfo
 *
p
,

230 
gc_¨ía
 *
gc
)

232 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (
	`°æí
 (
p
->
up
.
u£∫ame
Ë+ såÀ¿’->up.
∑ssw‹d
Ë+ 2, 
gc
);

233 
	`ASSERT
 (
	`°æí
 (
p
->
up
.
u£∫ame
) > 0);

234 
	`buf_¥ötf
 (&
out
, "%s:%s", 
p
->
up
.
u£∫ame
,Ö->up.
∑ssw‹d
);

235  (c⁄° *)
	`make_ba£64_°rög
 ((c⁄° 
uöt8_t
*)
	`BSTR
 (&
out
), 
gc
);

236 
	}
}

239 
	$gë_u£r_∑ss_hâp
 (
hâp_¥oxy_öfo
 *
p
, c⁄° 
boﬁ
 
f‹˚
)

241 i‡(!
°©ic_¥oxy_u£r_∑ss
.
deföed
 || 
f‹˚
)

243 
Êags
 = 
GET_USER_PASS_MANAGEMENT
;

244 i‡(
p
->
quîõd_¸eds
)

245 
Êags
 |
GET_USER_PASS_PREVIOUS_CREDS_FAILED
;

246 
	`gë_u£r_∑ss
 (&
°©ic_¥oxy_u£r_∑ss
,

247 
p
->
›ti⁄s
.
auth_fûe
,

248 
UP_TYPE_PROXY
,

249 
Êags
);

250 
p
->
quîõd_¸eds
 = 
åue
;

251 
p
->
up
 = 
°©ic_¥oxy_u£r_∑ss
;

253 
	}
}

255 
	$˛ór_u£r_∑ss_hâp
 ()

257 
	`purge_u£r_∑ss
 (&
°©ic_¥oxy_u£r_∑ss
, 
åue
);

258 
	}
}

261 
	$dump_ªsiduÆ
 (
sockë_des¸ùt‹_t
 
sd
,

262 
timeout
,

263 vﬁ©ûê*
sig«l_ª˚ived
)

265 
buf
[256];

266 
åue
)

268 i‡(!
	`ªcv_löe
 (
sd
, 
buf
,  (buf), 
timeout
, 
åue
, 
NULL
, 
sig«l_ª˚ived
))

270 
	`chomp
 (
buf
);

271 
	`msg
 (
D_PROXY
, "PROXY HEADER: '%s'", 
buf
);

273 
	}
}

280 
	$gë_¥oxy_authítiˇã
 (
sockë_des¸ùt‹_t
 
sd
,

281 
timeout
,

282 **
d©a
,

283 
gc_¨ía
 *
gc
,

284 vﬁ©ûê*
sig«l_ª˚ived
)

286 
buf
[256];

287 
ªt
 = 
HTTP_AUTH_NONE
;

288 
åue
)

290 i‡(!
	`ªcv_löe
 (
sd
, 
buf
,  (buf), 
timeout
, 
åue
, 
NULL
, 
sig«l_ª˚ived
))

292 *
d©a
 = 
NULL
;

293  
HTTP_AUTH_NONE
;

295 
	`chomp
 (
buf
);

296 i‡(!
	`°æí
(
buf
))

297  
ªt
;

298 i‡(
ªt
 =
HTTP_AUTH_NONE
 && !
	`°∫cmp
(
buf
, "Proxy-Authenticate: ", 20))

300 i‡(!
	`°∫cmp
(
buf
+20, "Basic ", 6))

302 
	`msg
 (
D_PROXY
, "PROXY AUTH BASIC: '%s'", 
buf
);

303 *
d©a
 = 
	`°rög_Æloc
(
buf
+26, 
gc
);

304 
ªt
 = 
HTTP_AUTH_BASIC
;

306 #i‡
PROXY_DIGEST_AUTH


307 i‡(!
	`°∫cmp
(
buf
+20, "Digest ", 7))

309 
	`msg
 (
D_PROXY
, "PROXY AUTH DIGEST: '%s'", 
buf
);

310 *
d©a
 = 
	`°rög_Æloc
(
buf
+27, 
gc
);

311 
ªt
 = 
HTTP_AUTH_DIGEST
;

314 #i‡
NTLM


315 i‡(!
	`°∫cmp
(
buf
+20, "NTLM", 4))

317 
	`msg
 (
D_PROXY
, "PROXY AUTH HTLM: '%s'", 
buf
);

318 *
d©a
 = 
NULL
;

319 
ªt
 = 
HTTP_AUTH_NTLM
;

324 
	}
}

327 
	$°‹e_¥oxy_authítiˇã
 (
hâp_¥oxy_öfo
 *
p
, *
d©a
)

329 i‡(
p
->
¥oxy_authítiˇã
)

330 
	`‰ì
 (
p
->
¥oxy_authítiˇã
);

331 
p
->
¥oxy_authítiˇã
 = 
d©a
;

332 
	}
}

338 
boﬁ


339 
	$gë_key_vÆue
(c⁄° *
°r
,

340 *
key
,

341 *
vÆue
,

342 
max_key_Àn
,

343 
max_vÆue_Àn
,

344 c⁄° **
íd±r
)

346 
c
;

347 
boﬁ
 
°¨ts_wôh_quŸe
 = 
Ál£
;

348 
boﬁ
 
esˇ≥
 = 
Ál£
;

350 
c
 = 
max_key_Àn
-1; (*
°r
 && (*str != '=') && c--); )

351 *
key
++ = *
°r
++;

352 *
key
 = '\0';

354 if('=' !*
°r
++)

356  
Ál£
;

358 if('\"' =*
°r
)

361 
°r
++;

362 
°¨ts_wôh_quŸe
 = 
åue
;

365 
c
 = 
max_vÆue_Àn
-1; *
°r
 && c--; str++)

367 *
°r
)

370 i‡(!
esˇ≥
)

373 
esˇ≥
 = 
åue
;

374 *
vÆue
++ = '\\';

380 i‡(!
°¨ts_wôh_quŸe
)

384 
c
=0;

391 
c
=0;

394 i‡(!
esˇ≥
 && 
°¨ts_wôh_quŸe
)

397 
c
=0;

402 
esˇ≥
 = 
Ál£
;

403 *
vÆue
++ = *
°r
;

405 *
vÆue
 = '\0';

407 *
íd±r
 = 
°r
;

409  
åue
;

410 
	}
}

413 
	$gë_∑_v¨
 (c⁄° *
key
, c⁄° *
∑
, 
gc_¨ía
 *
gc
)

415 
k
[64];

416 
v
[256];

417 c⁄° *
c⁄ã¡
 = 
∑
;

419 
åue
)

421 c⁄° 
°©us
 = 
	`gë_key_vÆue
(
c⁄ã¡
, 
k
, 
v
, (k), (v), &content);

422 i‡(
°©us
)

424 i‡(!
	`°rcmp
(
key
, 
k
))

425  
	`°rög_Æloc
(
v
, 
gc
);

428  
NULL
;

431 i‡(*
c⁄ã¡
 == ',')

432 ++
c⁄ã¡
;

433 *
c⁄ã¡
 && 
	`is•a˚
(*content))

434 ++
c⁄ã¡
;

436 
	}
}

438 
hâp_¥oxy_öfo
 *

439 
	$hâp_¥oxy_√w
 (c⁄° 
hâp_¥oxy_›ti⁄s
 *
o
)

441 
hâp_¥oxy_öfo
 *
p
;

442 
hâp_¥oxy_›ti⁄s
 
›t
;

444 i‡(!
o
 || !o->
£rvî
)

445 
	`msg
 (
M_FATAL
, "HTTP_PROXY: serverÇot specified");

447 
	`ASSERT
 (
	`ÀgÆ_ùv4_p‹t
 (
o
->
p‹t
));

449 
	`ALLOC_OBJ_CLEAR
 (
p
, 
hâp_¥oxy_öfo
);

450 
p
->
›ti⁄s
 = *
o
;

453 
p
->
auth_mëhod
 = 
HTTP_AUTH_NONE
;

454 i‡(
o
->
auth_mëhod_°rög
)

456 i‡(!
	`°rcmp
 (
o
->
auth_mëhod_°rög
, "none"))

457 
p
->
auth_mëhod
 = 
HTTP_AUTH_NONE
;

458 i‡(!
	`°rcmp
 (
o
->
auth_mëhod_°rög
, "basic"))

459 
p
->
auth_mëhod
 = 
HTTP_AUTH_BASIC
;

460 #i‡
NTLM


461 i‡(!
	`°rcmp
 (
o
->
auth_mëhod_°rög
, "ntlm"))

462 
p
->
auth_mëhod
 = 
HTTP_AUTH_NTLM
;

463 i‡(!
	`°rcmp
 (
o
->
auth_mëhod_°rög
, "ntlm2"))

464 
p
->
auth_mëhod
 = 
HTTP_AUTH_NTLM2
;

467 
	`msg
 (
M_FATAL
, "ERROR: unknown HTTPáuthentication method: '%s'",

468 
o
->
auth_mëhod_°rög
);

472 i‡(
p
->
auth_mëhod
 =
HTTP_AUTH_BASIC
 ||Ö->auth_mëhod =
HTTP_AUTH_NTLM
 ||Ö->auth_mëhod =
HTTP_AUTH_NTLM2
)

474 
	`gë_u£r_∑ss_hâp
 (
p
, 
åue
);

477 #i‡!
NTLM


478 i‡(
p
->
auth_mëhod
 =
HTTP_AUTH_NTLM
 ||Ö->auth_mëhod =
HTTP_AUTH_NTLM2
)

479 
	`msg
 (
M_FATAL
, "S‹ry,Åhi†vîsi⁄ o‡" 
PACKAGE_NAME
 " was built without NTLM Proxy support.");

482 
p
->
deföed
 = 
åue
;

483  
p
;

484 
	}
}

487 
	$hâp_¥oxy_˛o£
 (
hâp_¥oxy_öfo
 *
hp
)

489 
	`‰ì
 (
hp
);

490 
	}
}

492 
boﬁ


493 
	$e°ablish_hâp_¥oxy_∑s°hru
 (
hâp_¥oxy_öfo
 *
p
,

494 
sockë_des¸ùt‹_t
 
sd
,

495 c⁄° *
ho°
,

496 c⁄° 
p‹t
,

497 
buf„r
 *
lookahód
,

498 vﬁ©ûê*
sig«l_ª˚ived
)

500 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

501 
buf
[512];

502 
buf2
[129];

503 
gë
[80];

504 
°©us
;

505 
≈¨ms
;

506 
boﬁ
 
ªt
 = 
Ál£
;

507 
boﬁ
 
¥o˚s£d
 = 
Ál£
;

510 i‡(
p
->
auth_mëhod
 =
HTTP_AUTH_BASIC


511 || 
p
->
auth_mëhod
 =
HTTP_AUTH_DIGEST


512 || 
p
->
auth_mëhod
 =
HTTP_AUTH_NTLM
)

513 
	`gë_u£r_∑ss_hâp
 (
p
, 
Ál£
);

516 i‡(
p
->
auth_mëhod
 =
HTTP_AUTH_DIGEST
 &&Ö->
¥oxy_authítiˇã
)

518 
≈¨ms
 = 1;

519 
°©us
 = 407;

524 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "CONNECT %s:%d HTTP/%s",

525 
ho°
,

526 
p‹t
,

527 
p
->
›ti⁄s
.
hâp_vîsi⁄
);

529 
	`msg
 (
D_PROXY
, "SídÅÿHTTPÖroxy: '%s'", 
buf
);

532 i‡(!
	`£nd_löe_¸lf
 (
sd
, 
buf
))

533 
îr‹
;

535 
	`›ív≤_¢¥ötf
(
buf
, (buf), "Ho°: %s", 
ho°
);

536 i‡(!
	`£nd_löe_¸lf
(
sd
, 
buf
))

537 
îr‹
;

540 i‡(
p
->
›ti⁄s
.
u£r_agít
)

542 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "User-Agent: %s",

543 
p
->
›ti⁄s
.
u£r_agít
);

544 i‡(!
	`£nd_löe_¸lf
 (
sd
, 
buf
))

545 
îr‹
;

549 
p
->
auth_mëhod
)

551 
HTTP_AUTH_NONE
:

554 
HTTP_AUTH_BASIC
:

555 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "Proxy-Authorization: Basic %s",

556 
	`u£∫ame_∑ssw‹d_as_ba£64
 (
p
, &
gc
));

557 
	`msg
 (
D_PROXY
, "Attempting Basic Proxy-Authorization");

558 
	`dmsg
 (
D_SHOW_KEYS
, "SídÅÿHTTPÖroxy: '%s'", 
buf
);

559 i‡(!
	`£nd_löe_¸lf
 (
sd
, 
buf
))

560 
îr‹
;

563 #i‡
NTLM


564 
HTTP_AUTH_NTLM
:

565 
HTTP_AUTH_NTLM2
:

567 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "Proxy-Connection: Keep-Alive");

568 i‡(!
	`£nd_löe_¸lf
 (
sd
, 
buf
))

569 
îr‹
;

571 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "Proxy-Authorization: NTLM %s",

572 
	`¡lm_pha£_1
 (
p
, &
gc
));

573 
	`msg
 (
D_PROXY
, "Attempting NTLM Proxy-AuthorizationÖhase 1");

574 
	`dmsg
 (
D_SHOW_KEYS
, "SídÅÿHTTPÖroxy: '%s'", 
buf
);

575 i‡(!
	`£nd_löe_¸lf
 (
sd
, 
buf
))

576 
îr‹
;

581 
	`ASSERT
 (0);

585 i‡(!
	`£nd_¸lf
 (
sd
))

586 
îr‹
;

589 i‡(!
	`ªcv_löe
 (
sd
, 
buf
, (buf), 
p
->
›ti⁄s
.
timeout
, 
åue
, 
NULL
, 
sig«l_ª˚ived
))

590 
îr‹
;

593 
	`chomp
 (
buf
);

595 
	`msg
 (
D_PROXY
, "HTTPÖroxyÑëu∫ed: '%s'", 
buf
);

598 
≈¨ms
 = 
	`ssˇnf
 (
buf
, "%*†%d", &
°©us
);

603 
≈¨ms
 >1 && 
°©us
 == 407)

605 
	`msg
 (
D_PROXY
, "ProxyÑequiresáuthentication");

607 i‡(
p
->
auth_mëhod
 =
HTTP_AUTH_BASIC
 && !
¥o˚s£d
)

609 
¥o˚s£d
 = 
åue
;

611 i‡((
p
->
auth_mëhod
 =
HTTP_AUTH_NTLM
 ||Ö->auth_mëhod =
HTTP_AUTH_NTLM2
Ë&& !
¥o˚s£d
)

613 #i‡
NTLM


616 
åue
)

618 i‡(!
	`ªcv_löe
 (
sd
, 
buf
, (buf), 
p
->
›ti⁄s
.
timeout
, 
åue
, 
NULL
, 
sig«l_ª˚ived
))

619 
îr‹
;

620 
	`chomp
 (
buf
);

621 
	`msg
 (
D_PROXY
, "HTTPÖroxyÑëu∫ed: '%s'", 
buf
);

623 
	`›ív≤_¢¥ötf
 (
gë
,  gë, "%%*†NTLM %%%ds", (Ë (
buf2
) - 1);

624 
≈¨ms
 = 
	`ssˇnf
 (
buf
, 
gë
, 
buf2
);

625 
buf2
[128] = 0;

628 i‡(
≈¨ms
 == 1)

631 
	`msg
 (
D_PROXY
, "auth såög: '%s'", 
buf2
);

636 
	`msg
 (
D_PROXY
, "Received NTLM Proxy-AuthorizationÖhase 2Ñesponse");

639 
	`ªcv_löe
 (
sd
, 
NULL
, 0, 2, 
åue
, NULL, 
sig«l_ª˚ived
))

645 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "CONNECT %s:%d HTTP/%s",

646 
ho°
,

647 
p‹t
,

648 
p
->
›ti⁄s
.
hâp_vîsi⁄
);

650 
	`msg
 (
D_PROXY
, "SídÅÿHTTPÖroxy: '%s'", 
buf
);

653 i‡(!
	`£nd_löe_¸lf
 (
sd
, 
buf
))

654 
îr‹
;

657 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "Proxy-Connection: Keep-Alive");

658 i‡(!
	`£nd_löe_¸lf
 (
sd
, 
buf
))

659 
îr‹
;

663 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "Ho°: %s", 
ho°
);

664 
	`msg
 (
D_PROXY
, "SídÅÿHTTPÖroxy: '%s'", 
buf
);

665 i‡(!
	`£nd_löe_¸lf
 (
sd
, 
buf
))

666 
îr‹
;

668 
	`msg
 (
D_PROXY
, "Attempting NTLM Proxy-AuthorizationÖhase 3");

670 c⁄° *
≈3
 = 
	`¡lm_pha£_3
 (
p
, 
buf2
, &
gc
);

671 i‡(!
≈3
)

673 
	`msg
 (
D_PROXY
, "NTLM Proxy-AuthorizationÖhase 3 failed:Ñeceived corrupted data fromÖroxy server");

674 
îr‹
;

676 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "Proxy-Auth‹iz©i⁄: NTLM %s", 
≈3
);

679 
	`msg
 (
D_PROXY
, "SídÅÿHTTPÖroxy: '%s'", 
buf
);

680 i‡(!
	`£nd_löe_¸lf
 (
sd
, 
buf
))

681 
îr‹
;

684 i‡(!
	`£nd_¸lf
 (
sd
))

685 
îr‹
;

688 i‡(!
	`ªcv_löe
 (
sd
, 
buf
, (buf), 
p
->
›ti⁄s
.
timeout
, 
åue
, 
NULL
, 
sig«l_ª˚ived
))

689 
îr‹
;

692 
	`chomp
 (
buf
);

694 
	`msg
 (
D_PROXY
, "HTTPÖroxyÑëu∫ed: '%s'", 
buf
);

697 
≈¨ms
 = 
	`ssˇnf
 (
buf
, "%*†%d", &
°©us
);

698 
¥o˚s£d
 = 
åue
;

701 #i‡
PROXY_DIGEST_AUTH


702 i‡(
p
->
auth_mëhod
 =
HTTP_AUTH_DIGEST
 && !
¥o˚s£d
)

704 *
∑
 = 
p
->
¥oxy_authítiˇã
;

705 c⁄° 
mëhod
 = 
p
->
auth_mëhod
;

706 
	`ASSERT
(
∑
);

708 i‡(
mëhod
 =
HTTP_AUTH_DIGEST
)

710 c⁄° *
hâp_mëhod
 = "CONNECT";

711 c⁄° *
n⁄˚_cou¡
 = "00000001";

712 c⁄° *
q›
 = "auth";

713 c⁄° *
u£∫ame
 = 
p
->
up
.username;

714 c⁄° *
∑ssw‹d
 = 
p
->
up
.password;

715 *
›aque_kv
 = "";

716 
uri
[128];

717 
uöt8_t
 
˙⁄˚_øw
[8];

718 
uöt8_t
 *
˙⁄˚
;

719 
HASHHEX
 
£ssi⁄_key
;

720 
HASHHEX
 
ª•⁄£
;

722 c⁄° *
ªÆm
 = 
	`gë_∑_v¨
("ªÆm", 
∑
, &
gc
);

723 c⁄° *
n⁄˚
 = 
	`gë_∑_v¨
("n⁄˚", 
∑
, &
gc
);

724 c⁄° *
Æg‹
 = 
	`gë_∑_v¨
("Æg‹ôhm", 
∑
, &
gc
);

725 c⁄° *
›aque
 = 
	`gë_∑_v¨
("›aque", 
∑
, &
gc
);

728 
	`ASSERT
(
	`ønd_byãs
(
˙⁄˚_øw
, (cnonce_raw)));

729 
˙⁄˚
 = 
	`make_ba£64_°rög2
(
˙⁄˚_øw
, (˙⁄˚_øw), &
gc
);

733 
	`›ív≤_¢¥ötf
 (
uri
, (uri), "%s:%d",

734 
ho°
,

735 
p‹t
);

737 i‡(
›aque
)

739 c⁄° 
Àn
 = 
	`°æí
(
›aque
)+16;

740 
›aque_kv
 = 
	`gc_mÆloc
(
Àn
, 
Ál£
, &
gc
);

741 
	`›ív≤_¢¥ötf
 (
›aque_kv
, 
Àn
, ", o∑que=\"%s\"", 
›aque
);

744 
	`Dige°CÆcHA1
(
Æg‹
,

745 
u£∫ame
,

746 
ªÆm
,

747 
∑ssw‹d
,

748 
n⁄˚
,

749 (*)
˙⁄˚
,

750 
£ssi⁄_key
);

751 
	`Dige°CÆcRe•⁄£
(
£ssi⁄_key
,

752 
n⁄˚
,

753 
n⁄˚_cou¡
,

754 (*)
˙⁄˚
,

755 
q›
,

756 
hâp_mëhod
,

757 
uri
,

758 
NULL
,

759 
ª•⁄£
);

762 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "%s %s HTTP/%s",

763 
hâp_mëhod
,

764 
uri
,

765 
p
->
›ti⁄s
.
hâp_vîsi⁄
);

767 
	`msg
 (
D_PROXY
, "SídÅÿHTTPÖroxy: '%s'", 
buf
);

770 i‡(!
	`£nd_löe_¸lf
 (
sd
, 
buf
))

771 
îr‹
;

774 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "Ho°: %s", 
ho°
);

775 
	`msg
 (
D_PROXY
, "SídÅÿHTTPÖroxy: '%s'", 
buf
);

776 i‡(!
	`£nd_löe_¸lf
 (
sd
, 
buf
))

777 
îr‹
;

780 
	`›ív≤_¢¥ötf
 (
buf
, (buf), "Proxy-Authorization: Digest username=\"%s\",Ñealm=\"%s\",Çonce=\"%s\", uri=\"%s\", qop=%s,Çc=%s, cnonce=\"%s\",Ñesponse=\"%s\"%s",

781 
u£∫ame
,

782 
ªÆm
,

783 
n⁄˚
,

784 
uri
,

785 
q›
,

786 
n⁄˚_cou¡
,

787 
˙⁄˚
,

788 
ª•⁄£
,

789 
›aque_kv


791 
	`msg
 (
D_PROXY
, "SídÅÿHTTPÖroxy: '%s'", 
buf
);

792 i‡(!
	`£nd_löe_¸lf
 (
sd
, 
buf
))

793 
îr‹
;

794 i‡(!
	`£nd_¸lf
 (
sd
))

795 
îr‹
;

798 i‡(!
	`ªcv_löe
 (
sd
, 
buf
, (buf), 
p
->
›ti⁄s
.
timeout
, 
åue
, 
NULL
, 
sig«l_ª˚ived
))

799 
îr‹
;

802 
	`chomp
 (
buf
);

804 
	`msg
 (
D_PROXY
, "HTTPÖroxyÑëu∫ed: '%s'", 
buf
);

807 
≈¨ms
 = 
	`ssˇnf
 (
buf
, "%*†%d", &
°©us
);

808 
¥o˚s£d
 = 
åue
;

812 
	`msg
 (
D_PROXY
, "HTTPÖroxy: digest methodÇot supported");

813 
îr‹
;

817 i‡(
p
->
›ti⁄s
.
auth_ªåy
)

820 *
∑
 = 
NULL
;

821 c⁄° 
mëhod
 = 
	`gë_¥oxy_authítiˇã
(
sd
,

822 
p
->
›ti⁄s
.
timeout
,

823 &
∑
,

824 
NULL
,

825 
sig«l_ª˚ived
);

826 i‡(
mëhod
 !
HTTP_AUTH_NONE
)

828 i‡(
∑
)

829 
	`msg
 (
D_PROXY
, "HTTPÖroxyáuthítiˇã '%s'", 
∑
);

830 i‡(
p
->
›ti⁄s
.
auth_ªåy
 =
PAR_NCT
 && 
mëhod
 =
HTTP_AUTH_BASIC
)

832 
	`msg
 (
D_PROXY
, "HTTPÖroxy: support for basicáuthánd other cleartextÖroxyáuth methods is disabled");

833 
îr‹
;

835 
p
->
auth_mëhod
 = 
mëhod
;

836 
	`°‹e_¥oxy_authítiˇã
(
p
, 
∑
);

837 
ªt
 = 
åue
;

838 
d⁄e
;

842 
	`msg
 (
D_PROXY
, "HTTPÖroxy: doÇotÑecognizeÅheáuthentication methodÑequired byÖroxy");

843 
	`‰ì
 (
∑
);

844 
îr‹
;

849 i‡(!
¥o˚s£d
)

850 
	`msg
 (
D_PROXY
, "HTTPÖroxy:Ço support forÖroxyáuthentication method");

851 
îr‹
;

855 i‡(
p
->
›ti⁄s
.
auth_ªåy
)

856 
	`˛ór_u£r_∑ss_hâp
();

857 
	`°‹e_¥oxy_authítiˇã
(
p
, 
NULL
);

861 i‡(
≈¨ms
 < 1 || 
°©us
 != 200)

863 
	`msg
 (
D_LINK_ERRORS
, "HTTPÖroxyÑeturned bad status");

866 
	`dump_ªsiduÆ
(
sd
, 
p
->
›ti⁄s
.
timeout
, 
sig«l_ª˚ived
);

868 
îr‹
;

874 i‡(!
	`ªcv_löe
 (
sd
, 
NULL
, 0, 
p
->
›ti⁄s
.
timeout
, 
åue
, NULL, 
sig«l_ª˚ived
))

875 
îr‹
;

881 
	`ªcv_löe
 (
sd
, 
NULL
, 0, 2, 
Ál£
, 
lookahód
, 
sig«l_ª˚ived
))

885 
p
->
quîõd_¸eds
 = 
Ál£
;

888 i‡(
lookahód
 && 
	`BLEN
 (lookahead))

889 
	`msg
 (
M_INFO
, "HTTP PROXY:Üookahód: %s", 
	`f‹m©_hex
 (
	`BPTR
 (
lookahód
), 
	`BLEN
 (lookahead), 0));

892 
d⁄e
:

893 
	`gc_‰ì
 (&
gc
);

894  
ªt
;

896 
îr‹
:

898 i‡(!*
sig«l_ª˚ived
)

899 *
sig«l_ª˚ived
 = (
p
->
›ti⁄s
.
ªåy
 ? 
SIGUSR1
 : 
SIGTERM
);

900 
	`gc_‰ì
 (&
gc
);

901  
ªt
;

902 
	}
}

905 
	$dummy
(Ë{
	}
}

	@src/openvpn/proxy.h

25 #i‚de‡
PROXY_H


26 
	#PROXY_H


	)

28 
	~"buf„r.h
"

29 
	~"misc.h
"

31 #ifde‡
ENABLE_HTTP_PROXY


34 
	#HTTP_AUTH_NONE
 0

	)

35 
	#HTTP_AUTH_BASIC
 1

	)

36 
	#HTTP_AUTH_DIGEST
 2

	)

37 
	#HTTP_AUTH_NTLM
 3

	)

38 
	#HTTP_AUTH_NTLM2
 4

	)

39 
	#HTTP_AUTH_N
 5

	)

41 
	shâp_¥oxy_›ti⁄s
 {

42 c⁄° *
	m£rvî
;

43 
	mp‹t
;

44 
boﬁ
 
	mªåy
;

45 
	mtimeout
;

47 
	#PAR_NO
 0

	)

48 
	#PAR_ALL
 1

	)

49 
	#PAR_NCT
 2

	)

50 
	mauth_ªåy
;

52 c⁄° *
	mauth_mëhod_°rög
;

53 c⁄° *
	mauth_fûe
;

54 c⁄° *
	mhâp_vîsi⁄
;

55 c⁄° *
	mu£r_agít
;

58 
	shâp_¥oxy_›ti⁄s_sim∂e
 {

59 c⁄° *
	m£rvî
;

60 
	mp‹t
;

61 
	mauth_ªåy
;

64 
	shâp_¥oxy_öfo
 {

65 
boﬁ
 
	mdeföed
;

66 
	mauth_mëhod
;

67 
hâp_¥oxy_›ti⁄s
 
	m›ti⁄s
;

68 
u£r_∑ss
 
	mup
;

69 *
	m¥oxy_authítiˇã
;

70 
boﬁ
 
	mquîõd_¸eds
;

73 
hâp_¥oxy_›ti⁄s
 *
öô_hâp_¥oxy_›ti⁄s_⁄˚
 (hâp_¥oxy_›ti⁄†**
hpo
,

74 
gc_¨ía
 *
gc
);

76 
hâp_¥oxy_öfo
 *
hâp_¥oxy_√w
 (c⁄° 
hâp_¥oxy_›ti⁄s
 *
o
);

78 
hâp_¥oxy_˛o£
 (
hâp_¥oxy_öfo
 *
hp
);

80 
boﬁ
 
e°ablish_hâp_¥oxy_∑s°hru
 (
hâp_¥oxy_öfo
 *
p
,

81 
sockë_des¸ùt‹_t
 
sd
,

82 c⁄° *
ho°
,

83 c⁄° 
p‹t
,

84 
buf„r
 *
lookahód
,

85 vﬁ©ûê*
sig«l_ª˚ived
);

87 
uöt8_t
 *
make_ba£64_°rög2
 (c⁄° uöt8_à*
°r
, 
°r_Àn
, 
gc_¨ía
 *
gc
);

88 
uöt8_t
 *
make_ba£64_°rög
 (c⁄° uöt8_à*
°r
, 
gc_¨ía
 *
gc
);

	@src/openvpn/ps.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #i‡
PORT_SHARE


35 
	~"evít.h
"

36 
	~"sockë.h
"

37 
	~"fdmisc.h
"

38 
	~"¸y±o.h
"

39 
	~"ps.h
"

41 
	~"memdbg.h
"

43 
p‹t_sh¨e
 *
	gp‹t_sh¨e
 = 
NULL
;

46 
	#PROXY_CONNECTION_BUFFER_SIZE
 1500

	)

49 
	#COMMAND_REDIRECT
 10

	)

50 
	#COMMAND_EXIT
 11

	)

53 
	#RESPONSE_INIT_SUCCEEDED
 20

	)

54 
	#RESPONSE_INIT_FAILED
 21

	)

60 
	#IOSTAT_EAGAIN_ON_READ
 0

	)

61 
	#IOSTAT_EAGAIN_ON_WRITE
 1

	)

62 
	#IOSTAT_READ_ERROR
 2

	)

63 
	#IOSTAT_WRITE_ERROR
 3

	)

64 
	#IOSTAT_GOOD
 4

	)

70 
	s¥oxy_c⁄√˘i⁄
 {

71 
boﬁ
 
	mdeföed
;

72 
¥oxy_c⁄√˘i⁄
 *
	m√xt
;

73 
¥oxy_c⁄√˘i⁄
 *
	mcou¡î∑π
;

74 
buf„r
 
	mbuf
;

75 
boﬁ
 
	mbuf„r_öôül
;

76 
	mrwÊags
;

77 
	msd
;

78 *
	mj‚
;

83 
	$hódc
 (c⁄° 
buf„r
 *
buf
)

85 
foo
[16];

86 
	`°∫˝y
 (
foo
, 
	`BSTR
(
buf
), 15);

87 
foo
[15] = 0;

88  
foo
;

89 
	}
}

92 
ölöe
 

93 
	$˛o£_sockë_if_deföed
 (c⁄° 
sockë_des¸ùt‹_t
 
sd
)

95 i‡(
	`sockë_deföed
 (
sd
))

96 
	`›ív≤_˛o£_sockë
 (
sd
);

97 
	}
}

110 
	$˛o£_fds_ex˚±
 (
kìp
)

112 
sockë_des¸ùt‹_t
 
i
;

113 
	`˛o£log
 ();

114 
i
 = 3; i <= 100; ++i)

116 i‡(
i
 !
kìp
)

117 
	`›ív≤_˛o£_sockë
 (
i
);

119 
	}
}

126 
	$£t_sig«ls
 ()

128 
	`sig«l
 (
SIGTERM
, 
SIG_DFL
);

130 
	`sig«l
 (
SIGINT
, 
SIG_IGN
);

131 
	`sig«l
 (
SIGHUP
, 
SIG_IGN
);

132 
	`sig«l
 (
SIGUSR1
, 
SIG_IGN
);

133 
	`sig«l
 (
SIGUSR2
, 
SIG_IGN
);

134 
	`sig«l
 (
SIGPIPE
, 
SIG_IGN
);

135 
	}
}

142 
	$ªcv_c⁄åﬁ
 (c⁄° 
sockë_des¸ùt‹_t
 
fd
)

144 
c
;

145 c⁄° 
ssize_t
 
size
 = 
	`ªad
 (
fd
, &
c
,  (c));

146 i‡(
size
 = (
c
))

147  
c
;

152 
	}
}

155 
	$£nd_c⁄åﬁ
 (c⁄° 
sockë_des¸ùt‹_t
 
fd
, 
code
)

157 
c
 = (Ë
code
;

158 c⁄° 
ssize_t
 
size
 = 
	`wrôe
 (
fd
, &
c
,  (c));

159 i‡(
size
 = (
c
))

160  (Ë
size
;

163 
	}
}

166 
	$cmsg_size
 ()

168  
	`CMSG_SPACE
((
sockë_des¸ùt‹_t
));

169 
	}
}

179 
	$p‹t_sh¨e_£ndmsg
 (c⁄° 
sockë_des¸ùt‹_t
 
sd
,

180 c⁄° 
comm™d
,

181 c⁄° 
buf„r
 *
hód
,

182 c⁄° 
sockë_des¸ùt‹_t
 
sd_£nd
)

184 i‡(
	`sockë_deföed
 (
sd
))

186 
msghdr
 
mesg
;

187 
cmsghdr
* 
h
;

188 
iovec
 
iov
[2];

189 
sockë_des¸ùt‹_t
 
sd_nuŒ
[2] = { 
SOCKET_UNDEFINED
, SOCKET_UNDEFINED };

190 
cmd
;

191 
ssize_t
 
°©us
;

193 
	`dmsg
 (
D_PS_PROXY_DEBUG
, "PORT SHARE: sendmsg sd=%dÜen=%d",

194 ()
sd_£nd
,

195 
hód
 ? 
	`BLEN
(head) : -1);

197 
	`CLEAR
 (
mesg
);

199 
cmd
 = 
comm™d
;

201 
iov
[0].
iov_ba£
 = &
cmd
;

202 
iov
[0].
iov_Àn
 =  (
cmd
);

203 
mesg
.
msg_iovÀn
 = 1;

205 i‡(
hód
)

207 
iov
[1].
iov_ba£
 = 
	`BPTR
 (
hód
);

208 
iov
[1].
iov_Àn
 = 
	`BLEN
 (
hód
);

209 
mesg
.
msg_iovÀn
 = 2;

212 
mesg
.
msg_iov
 = 
iov
;

214 
mesg
.
msg_c⁄åﬁÀn
 = 
	`cmsg_size
 ();

215 
mesg
.
msg_c⁄åﬁ
 = (*Ë
	`mÆloc
 (mesg.
msg_c⁄åﬁÀn
);

216 
	`check_mÆloc_ªtu∫
 (
mesg
.
msg_c⁄åﬁ
);

217 
mesg
.
msg_Êags
 = 0;

219 
h
 = 
	`CMSG_FIRSTHDR
(&
mesg
);

220 
h
->
cmsg_Àvñ
 = 
SOL_SOCKET
;

221 
h
->
cmsg_ty≥
 = 
SCM_RIGHTS
;

222 
h
->
cmsg_Àn
 = 
	`CMSG_LEN
((
sockë_des¸ùt‹_t
));

224 i‡(
	`sockë_deföed
 (
sd_£nd
))

226 *((
sockë_des¸ùt‹_t
*)
	`CMSG_DATA
(
h
)Ë
sd_£nd
;

230 
	`sockë∑ú
 (
PF_UNIX
, 
SOCK_DGRAM
, 0, 
sd_nuŒ
);

231 *((
sockë_des¸ùt‹_t
*)
	`CMSG_DATA
(
h
)Ë
sd_nuŒ
[0];

234 
°©us
 = 
	`£ndmsg
 (
sd
, &
mesg
, 
MSG_NOSIGNAL
);

235 i‡(
°©us
 == -1)

236 
	`msg
 (
M_WARN
|
M_ERRNO
, "PORT SHARE: sendmsg failed -- unableÅo communicate with backgroundÖrocess (%d,%d,%d,%d)",

237 
sd
, 
sd_£nd
, 
sd_nuŒ
[0], sd_null[1]

240 
	`˛o£_sockë_if_deföed
 (
sd_nuŒ
[0]);

241 
	`˛o£_sockë_if_deföed
 (
sd_nuŒ
[1]);

242 
	`‰ì
 (
mesg
.
msg_c⁄åﬁ
);

244 
	}
}

247 
	$¥oxy_íåy_˛o£_sd
 (
¥oxy_c⁄√˘i⁄
 *
pc
, 
evít_£t
 *
es
)

249 i‡(
pc
->
deföed
 && 
	`sockë_deföed
 (pc->
sd
))

251 
	`dmsg
 (
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: dñëêsd=%d", ()
pc
->
sd
);

252 i‡(
es
)

253 
	`evít_dñ
 (
es
, 
pc
->
sd
);

254 
	`›ív≤_˛o£_sockë
 (
pc
->
sd
);

255 
pc
->
sd
 = 
SOCKET_UNDEFINED
;

257 
	}
}

263 
	$¥oxy_íåy_m¨k_f‹_˛o£
 (
¥oxy_c⁄√˘i⁄
 *
pc
, 
evít_£t
 *
es
)

265 i‡(
pc
->
deföed
)

267 
¥oxy_c⁄√˘i⁄
 *
˝
 = 
pc
->
cou¡î∑π
;

268 
	`¥oxy_íåy_˛o£_sd
 (
pc
, 
es
);

269 
	`‰ì_buf
 (&
pc
->
buf
);

270 
pc
->
buf„r_öôül
 = 
Ál£
;

271 
pc
->
rwÊags
 = 0;

272 
pc
->
deföed
 = 
Ál£
;

273 i‡(
pc
->
j‚
)

275 
	`u∆ök
 (
pc
->
j‚
);

276 
	`‰ì
 (
pc
->
j‚
);

277 
pc
->
j‚
 = 
NULL
;

279 i‡(
˝
 && cp->
deföed
 && cp->
cou¡î∑π
 =
pc
)

280 
	`¥oxy_íåy_m¨k_f‹_˛o£
 (
˝
, 
es
);

282 
	}
}

289 
	$¥oxy_li°_hou£kìpög
 (
¥oxy_c⁄√˘i⁄
 **
li°
)

291 i‡(
li°
)

293 
¥oxy_c⁄√˘i⁄
 *
¥ev
 = 
NULL
;

294 
¥oxy_c⁄√˘i⁄
 *
pc
 = *
li°
;

296 
pc
)

298 
¥oxy_c⁄√˘i⁄
 *
√xt
 = 
pc
->next;

299 i‡(!
pc
->
deföed
)

301 
	`‰ì
 (
pc
);

302 i‡(
¥ev
)

303 
¥ev
->
√xt
 =Çext;

305 *
li°
 = 
√xt
;

308 
¥ev
 = 
pc
;

309 
pc
 = 
√xt
;

312 
	}
}

319 
	$jou∫Æ_add
 (c⁄° *
jou∫Æ_dú
, 
¥oxy_c⁄√˘i⁄
 *
pc
, ¥oxy_c⁄√˘i⁄ *
˝
)

321 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

322 
›ív≤_sockaddr
 
‰om
, 
to
;

323 
sockÀn_t
 
¶í
, 
dÀn
;

324 
‚Àn
;

325 *
j‚
;

326 
fd
;

328 
¶í
 = (
‰om
.
addr
.
ß
);

329 
dÀn
 = (
to
.
addr
.
ß
);

330 i‡(!
	`gë≥î«me
 (
pc
->
sd
, (
sockaddr
 *Ë&
‰om
.
addr
.
ß
, &
¶í
)

331 && !
	`gësock«me
 (
˝
->
sd
, (
sockaddr
 *Ë&
to
.
addr
.
ß
, &
dÀn
))

333 c⁄° *
f
 = 
	`¥öt_sockaddr_ex
 (&
‰om
, ":", 
PS_SHOW_PORT
, &
gc
);

334 c⁄° *
t
 = 
	`¥öt_sockaddr_ex
 (&
to
, ":", 
PS_SHOW_PORT
, &
gc
);

335 
‚Àn
 = 
	`°æí
(
jou∫Æ_dú
Ë+ såÀn(
t
) + 2;

336 
j‚
 = (*Ë
	`mÆloc
(
‚Àn
);

337 
	`check_mÆloc_ªtu∫
 (
j‚
);

338 
	`›ív≤_¢¥ötf
 (
j‚
, 
‚Àn
, "%s/%s", 
jou∫Æ_dú
, 
t
);

339 
	`dmsg
 (
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: clõ¡ origö %†-> %s", 
j‚
, 
f
);

340 
fd
 = 
	`∂©f‹m_›í
 (
j‚
, 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
, 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
);

341 i‡(
fd
 != -1)

343 
	`wrôe
(
fd
, 
f
, 
	`°æí
(f));

344 
	`˛o£
 (
fd
);

345 
˝
->
j‚
 = jfn;

349 
	`msg
 (
M_WARN
|
M_ERRNO
, "PORT SHARE: u«bÀÅÿwrôêjou∫Æ fûêö %s", 
j‚
);

350 
	`‰ì
 (
j‚
);

353 
	`gc_‰ì
 (&
gc
);

354 
	}
}

360 
	$¥oxy_li°_˛o£
 (
¥oxy_c⁄√˘i⁄
 **
li°
)

362 i‡(
li°
)

364 
¥oxy_c⁄√˘i⁄
 *
pc
 = *
li°
;

365 
pc
)

367 
	`¥oxy_íåy_m¨k_f‹_˛o£
 (
pc
, 
NULL
);

368 
pc
 =Öc->
√xt
;

370 
	`¥oxy_li°_hou£kìpög
 (
li°
);

372 
	}
}

375 
	$sock_addr_£t
 (
›ív≤_sockaddr
 *
oßddr
,

376 c⁄° 
ö_addr_t
 
addr
,

377 c⁄° 
p‹t
)

379 
	`CLEAR
 (*
oßddr
);

380 
oßddr
->
addr
.
ö4
.
sö_Ámûy
 = 
AF_INET
;

381 
oßddr
->
addr
.
ö4
.
sö_addr
.
s_addr
 = 
	`ht⁄l
 (addr);

382 
oßddr
->
addr
.
ö4
.
sö_p‹t
 = 
	`ht⁄s
 (
p‹t
);

383 
	}
}

385 
ölöe
 

386 
	$¥oxy_c⁄√˘i⁄_io_ªqueue
 (
¥oxy_c⁄√˘i⁄
 *
pc
, c⁄° 
rwÊags_√w
, 
evít_£t
 *
es
)

388 i‡(
	`sockë_deföed
 (
pc
->
sd
Ë&&Öc->
rwÊags
 !
rwÊags_√w
)

391 
	`evít_˘l
 (
es
, 
pc
->
sd
, 
rwÊags_√w
, (*)pc);

392 
pc
->
rwÊags
 = 
rwÊags_√w
;

394 
	}
}

403 
boﬁ


404 
	$¥oxy_íåy_√w
 (
¥oxy_c⁄√˘i⁄
 **
li°
,

405 
evít_£t
 *
es
,

406 c⁄° 
ö_addr_t
 
£rvî_addr
,

407 c⁄° 
£rvî_p‹t
,

408 c⁄° 
sockë_des¸ùt‹_t
 
sd_˛õ¡
,

409 
buf„r
 *
öôül_d©a
,

410 c⁄° *
jou∫Æ_dú
)

412 
›ív≤_sockaddr
 
oßddr
;

413 
sockë_des¸ùt‹_t
 
sd_£rvî
;

414 
°©us
;

415 
¥oxy_c⁄√˘i⁄
 *
pc
;

416 
¥oxy_c⁄√˘i⁄
 *
˝
;

419 
	`sock_addr_£t
 (&
oßddr
, 
£rvî_addr
, 
£rvî_p‹t
);

420 i‡((
sd_£rvî
 = 
	`sockë
 (
PF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
)) < 0)

422 
	`msg
 (
M_WARN
|
M_ERRNO
, "PORT SHARE PROXY: cannot create socket");

423  
Ál£
;

425 
°©us
 = 
	`›ív≤_c⁄√˘
 (
sd_£rvî
, &
oßddr
, 5, 
NULL
);

426 i‡(
°©us
)

428 
	`msg
 (
M_WARN
, "PORT SHARE PROXY: connectÅoÖort-share server failed");

429 
	`›ív≤_˛o£_sockë
 (
sd_£rvî
);

430  
Ál£
;

432 
	`dmsg
 (
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: connectÅoÖort-share server succeeded");

434 
	`£t_n⁄block
 (
sd_˛õ¡
);

435 
	`£t_n⁄block
 (
sd_£rvî
);

438 
	`ALLOC_OBJ_CLEAR
 (
pc
, 
¥oxy_c⁄√˘i⁄
);

439 
	`ALLOC_OBJ_CLEAR
 (
˝
, 
¥oxy_c⁄√˘i⁄
);

442 
pc
->
deföed
 = 
åue
;

443 
pc
->
√xt
 = 
˝
;

444 
pc
->
cou¡î∑π
 = 
˝
;

445 
pc
->
buf
 = *
öôül_d©a
;

446 
pc
->
buf„r_öôül
 = 
åue
;

447 
pc
->
rwÊags
 = 
EVENT_UNDEF
;

448 
pc
->
sd
 = 
sd_˛õ¡
;

451 
˝
->
deföed
 = 
åue
;

452 
˝
->
√xt
 = *
li°
;

453 
˝
->
cou¡î∑π
 = 
pc
;

454 
˝
->
buf
 = 
	`Æloc_buf
 (
PROXY_CONNECTION_BUFFER_SIZE
);

455 
˝
->
buf„r_öôül
 = 
Ál£
;

456 
˝
->
rwÊags
 = 
EVENT_UNDEF
;

457 
˝
->
sd
 = 
sd_£rvî
;

460 *
li°
 = 
pc
;

463 i‡(
jou∫Æ_dú
)

464 
	`jou∫Æ_add
 (
jou∫Æ_dú
, 
pc
, 
˝
);

466 
	`dmsg
 (
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: NEW CONNECTION [c=%d s=%d]", ()
sd_˛õ¡
, ()
sd_£rvî
);

469 
	`¥oxy_c⁄√˘i⁄_io_ªqueue
 (
pc
, 
EVENT_READ
, 
es
);

470 
	`¥oxy_c⁄√˘i⁄_io_ªqueue
 (
˝
, 
EVENT_READ
|
EVENT_WRITE
, 
es
);

472  
åue
;

473 
	}
}

481 
boﬁ


482 
	$c⁄åﬁ_mesßge_‰om_∑ª¡
 (c⁄° 
sockë_des¸ùt‹_t
 
sd_c⁄åﬁ
,

483 
¥oxy_c⁄√˘i⁄
 **
li°
,

484 
evít_£t
 *
es
,

485 c⁄° 
ö_addr_t
 
£rvî_addr
,

486 c⁄° 
£rvî_p‹t
,

487 c⁄° 
max_öôül_buf
,

488 c⁄° *
jou∫Æ_dú
)

492 
buf„r
 
buf
 = 
	`Æloc_buf
 (
max_öôül_buf
);

494 
msghdr
 
mesg
;

495 
cmsghdr
* 
h
;

496 
iovec
 
iov
[2];

497 
comm™d
 = 0;

498 
ssize_t
 
°©us
;

499 
ªt
 = 
åue
;

501 
	`CLEAR
 (
mesg
);

503 
iov
[0].
iov_ba£
 = &
comm™d
;

504 
iov
[0].
iov_Àn
 =  (
comm™d
);

505 
iov
[1].
iov_ba£
 = 
	`BPTR
 (&
buf
);

506 
iov
[1].
iov_Àn
 = 
	`BCAP
 (&
buf
);

507 
mesg
.
msg_iov
 = 
iov
;

508 
mesg
.
msg_iovÀn
 = 2;

510 
mesg
.
msg_c⁄åﬁÀn
 = 
	`cmsg_size
 ();

511 
mesg
.
msg_c⁄åﬁ
 = (*Ë
	`mÆloc
 (mesg.
msg_c⁄åﬁÀn
);

512 
	`check_mÆloc_ªtu∫
 (
mesg
.
msg_c⁄åﬁ
);

513 
mesg
.
msg_Êags
 = 0;

515 
h
 = 
	`CMSG_FIRSTHDR
(&
mesg
);

516 
h
->
cmsg_Àn
 = 
	`CMSG_LEN
((
sockë_des¸ùt‹_t
));

517 
h
->
cmsg_Àvñ
 = 
SOL_SOCKET
;

518 
h
->
cmsg_ty≥
 = 
SCM_RIGHTS
;

519 *((
sockë_des¸ùt‹_t
*)
	`CMSG_DATA
(
h
)Ë
SOCKET_UNDEFINED
;

521 
°©us
 = 
	`ªcvmsg
 (
sd_c⁄åﬁ
, &
mesg
, 
MSG_NOSIGNAL
);

522 i‡(
°©us
 != -1)

524 i‡–
h
 =
NULL


525 || 
h
->
cmsg_Àn
 !
	`CMSG_LEN
((
sockë_des¸ùt‹_t
))

526 || 
h
->
cmsg_Àvñ
 !
SOL_SOCKET


527 || 
h
->
cmsg_ty≥
 !
SCM_RIGHTS
 )

529 
	`msg
 (
M_WARN
, "PORT SHARE PROXY:Ñeceived unknown message");

533 c⁄° 
sockë_des¸ùt‹_t
 
ª˚ived_fd
 = *((sockë_des¸ùt‹_t*)
	`CMSG_DATA
(
h
));

534 
	`dmsg
 (
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: RECEIVED sd=%d", ()
ª˚ived_fd
);

536 i‡(
°©us
 >2 && 
comm™d
 =
COMMAND_REDIRECT
)

538 
buf
.
Àn
 = 
°©us
 - 1;

539 i‡(
	`¥oxy_íåy_√w
 (
li°
,

540 
es
,

541 
£rvî_addr
,

542 
£rvî_p‹t
,

543 
ª˚ived_fd
,

544 &
buf
,

545 
jou∫Æ_dú
))

547 
	`CLEAR
 (
buf
);

551 
	`›ív≤_˛o£_sockë
 (
ª˚ived_fd
);

554 i‡(
°©us
 >1 && 
comm™d
 =
COMMAND_EXIT
)

556 
	`dmsg
 (
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: RECEIVED COMMAND_EXIT");

557 
	`›ív≤_˛o£_sockë
 (
ª˚ived_fd
);

558 
ªt
 = 
Ál£
;

562 
	`‰ì
 (
mesg
.
msg_c⁄åﬁ
);

563 
	`‰ì_buf
 (&
buf
);

564  
ªt
;

565 
	}
}

568 
	$¥oxy_c⁄√˘i⁄_io_ªcv
 (
¥oxy_c⁄√˘i⁄
 *
pc
)

571 c⁄° 
°©us
 = 
	`ªcv
 (
pc
->
sd
, 
	`BPTR
(&pc->
buf
), 
	`BCAP
(&pc->buf), 
MSG_NOSIGNAL
);

572 i‡(
°©us
 < 0)

574  (
î∫o
 =
EAGAIN
Ë? 
IOSTAT_EAGAIN_ON_READ
 : 
IOSTAT_READ_ERROR
;

578 i‡(!
°©us
)

579  
IOSTAT_READ_ERROR
;

580 
	`dmsg
 (
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY:Ñód[%d] %d", ()
pc
->
sd
, 
°©us
);

581 
pc
->
buf
.
Àn
 = 
°©us
;

583  
IOSTAT_GOOD
;

584 
	}
}

587 
	$¥oxy_c⁄√˘i⁄_io_£nd
 (
¥oxy_c⁄√˘i⁄
 *
pc
, *
byãs_£¡
)

589 c⁄° 
sockë_des¸ùt‹_t
 
sd
 = 
pc
->
cou¡î∑π
->sd;

590 c⁄° 
°©us
 = 
	`£nd
 (
sd
, 
	`BPTR
(&
pc
->
buf
), 
	`BLEN
(&pc->buf), 
MSG_NOSIGNAL
);

592 i‡(
°©us
 < 0)

594 c⁄° 
e
 = 
î∫o
;

595  (
e
 =
EAGAIN
Ë? 
IOSTAT_EAGAIN_ON_WRITE
 : 
IOSTAT_WRITE_ERROR
;

599 *
byãs_£¡
 +
°©us
;

600 i‡(
°©us
 !
pc
->
buf
.
Àn
)

602 
	`dmsg
 (
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY:Ö¨tü»wrôe[%d],Årõd=%d gŸ=%d", ()
sd
, 
pc
->
buf
.
Àn
, 
°©us
);

603 
	`buf_adv™˚
 (&
pc
->
buf
, 
°©us
);

604  
IOSTAT_EAGAIN_ON_WRITE
;

608 
	`dmsg
 (
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: wrŸe[%d] %d", ()
sd
, 
°©us
);

609 
pc
->
buf
.
Àn
 = 0;

610 
pc
->
buf
.
off£t
 = 0;

615 i‡(
pc
->
buf„r_öôül
)

617 
	`‰ì_buf
 (&
pc
->
buf
);

618 
pc
->
buf
 = 
	`Æloc_buf
 (
PROXY_CONNECTION_BUFFER_SIZE
);

619 
pc
->
buf„r_öôül
 = 
Ál£
;

621  
IOSTAT_GOOD
;

622 
	}
}

629 
	$¥oxy_c⁄√˘i⁄_io_x„r
 (
¥oxy_c⁄√˘i⁄
 *
pc
, c⁄° 
max_å™s„r
)

631 
å™s„ºed
 = 0;

632 
å™s„ºed
 < 
max_å™s„r
)

634 i‡(!
	`BLEN
 (&
pc
->
buf
))

636 c⁄° 
°©us
 = 
	`¥oxy_c⁄√˘i⁄_io_ªcv
 (
pc
);

637 i‡(
°©us
 !
IOSTAT_GOOD
)

638  
°©us
;

641 i‡(
	`BLEN
 (&
pc
->
buf
))

643 c⁄° 
°©us
 = 
	`¥oxy_c⁄√˘i⁄_io_£nd
 (
pc
, &
å™s„ºed
);

644 i‡(
°©us
 !
IOSTAT_GOOD
)

645  
°©us
;

648  
IOSTAT_EAGAIN_ON_READ
;

649 
	}
}

654 
boﬁ


655 
	$¥oxy_c⁄√˘i⁄_io_°©us
 (c⁄° 
°©us
, *
rwÊags_pc
, *
rwÊags_˝
)

657 
°©us
)

659 
IOSTAT_EAGAIN_ON_READ
:

660 *
rwÊags_pc
 |
EVENT_READ
;

661 *
rwÊags_˝
 &~
EVENT_WRITE
;

662  
åue
;

663 
IOSTAT_EAGAIN_ON_WRITE
:

664 *
rwÊags_pc
 &~
EVENT_READ
;

665 *
rwÊags_˝
 |
EVENT_WRITE
;

666  
åue
;

667 
IOSTAT_READ_ERROR
:

668  
Ál£
;

669 
IOSTAT_WRITE_ERROR
:

670  
Ál£
;

672 
	`msg
 (
M_FATAL
, "PORT SHARE PROXY: u√x≥˘ed sètus=%d", 
°©us
);

674  
Ál£
;

675 
	}
}

682 
	$¥oxy_c⁄√˘i⁄_io_di•©ch
 (
¥oxy_c⁄√˘i⁄
 *
pc
,

683 c⁄° 
rwÊags
,

684 
evít_£t
 *
es
)

686 c⁄° 
max_å™s„r_≥r_ôî©i⁄
 = 10000;

687 
¥oxy_c⁄√˘i⁄
 *
˝
 = 
pc
->
cou¡î∑π
;

688 
rwÊags_pc
 = 
pc
->
rwÊags
;

689 
rwÊags_˝
 = 
˝
->
rwÊags
;

691 
	`ASSERT
(
pc
->
deföed
 && 
˝
->deföed && cp->
cou¡î∑π
 ==Öc);

693 i‡(
rwÊags
 & 
EVENT_READ
)

695 c⁄° 
°©us
 = 
	`¥oxy_c⁄√˘i⁄_io_x„r
 (
pc
, 
max_å™s„r_≥r_ôî©i⁄
);

696 i‡(!
	`¥oxy_c⁄√˘i⁄_io_°©us
 (
°©us
, &
rwÊags_pc
, &
rwÊags_˝
))

697 
bad
;

699 i‡(
rwÊags
 & 
EVENT_WRITE
)

701 c⁄° 
°©us
 = 
	`¥oxy_c⁄√˘i⁄_io_x„r
 (
˝
, 
max_å™s„r_≥r_ôî©i⁄
);

702 i‡(!
	`¥oxy_c⁄√˘i⁄_io_°©us
 (
°©us
, &
rwÊags_˝
, &
rwÊags_pc
))

703 
bad
;

705 
	`¥oxy_c⁄√˘i⁄_io_ªqueue
 (
pc
, 
rwÊags_pc
, 
es
);

706 
	`¥oxy_c⁄√˘i⁄_io_ªqueue
 (
˝
, 
rwÊags_˝
, 
es
);

708  
åue
;

710 
bad
:

711 
	`¥oxy_íåy_m¨k_f‹_˛o£
 (
pc
, 
es
);

712  
Ál£
;

713 
	}
}

719 
	$p‹t_sh¨e_¥oxy
 (c⁄° 
ö_addr_t
 
ho°addr
,

720 c⁄° 
p‹t
,

721 c⁄° 
sockë_des¸ùt‹_t
 
sd_c⁄åﬁ
,

722 c⁄° 
max_öôül_buf
,

723 c⁄° *
jou∫Æ_dú
)

725 i‡(
	`£nd_c⁄åﬁ
 (
sd_c⁄åﬁ
, 
RESPONSE_INIT_SUCCEEDED
) >= 0)

727 *
sd_c⁄åﬁ_m¨kî
 = (*)1;

728 
maxevíts
 = 256;

729 
evít_£t
 *
es
;

730 
evít_£t_ªtu∫
 
e§
[64];

731 
¥oxy_c⁄√˘i⁄
 *
li°
 = 
NULL
;

732 
time_t
 
œ°_hou£kìpög
 = 0;

734 
	`msg
 (
D_PS_PROXY
, "PORT SHARE PROXY:Öroxy starting");

736 
es
 = 
	`evít_£t_öô
 (&
maxevíts
, 0);

737 
	`evít_˘l
 (
es
, 
sd_c⁄åﬁ
, 
EVENT_READ
, 
sd_c⁄åﬁ_m¨kî
);

738 
åue
)

740 
n_evíts
;

741 
timevÆ
 
tv
;

742 
time_t
 
cuºít
;

744 
tv
.
tv_£c
 = 10;

745 
tv
.
tv_u£c
 = 0;

746 
n_evíts
 = 
	`evít_waô
 (
es
, &
tv
, 
e§
, 
	`SIZE
(esr));

748 
cuºít
 = 
	`time
(
NULL
);

749 i‡(
n_evíts
 > 0)

751 
i
;

752 
i
 = 0; i < 
n_evíts
; ++i)

754 c⁄° 
evít_£t_ªtu∫
 *
e
 = &
e§
[
i
];

755 i‡(
e
->
¨g
 =
sd_c⁄åﬁ_m¨kî
)

757 i‡(!
	`c⁄åﬁ_mesßge_‰om_∑ª¡
 (
sd_c⁄åﬁ
, &
li°
, 
es
, 
ho°addr
, 
p‹t
, 
max_öôül_buf
, 
jou∫Æ_dú
))

758 
d⁄e
;

762 
¥oxy_c⁄√˘i⁄
 *
pc
 = (¥oxy_c⁄√˘i⁄ *)
e
->
¨g
;

763 i‡(
pc
->
deföed
)

764 
	`¥oxy_c⁄√˘i⁄_io_di•©ch
 (
pc
, 
e
->
rwÊags
, 
es
);

768 i‡(
n_evíts
 < 0)

770 
	`dmsg
 (
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY:Évent_wait failed");

772 i‡(
cuºít
 > 
œ°_hou£kìpög
)

774 
	`¥oxy_li°_hou£kìpög
 (&
li°
);

775 
œ°_hou£kìpög
 = 
cuºít
;

779 
d⁄e
:

780 
	`¥oxy_li°_˛o£
 (&
li°
);

781 
	`evít_‰ì
 (
es
);

783 
	`msg
 (
M_INFO
, "PORT SHARE PROXY:ÖroxyÉxiting");

784 
	}
}

790 
p‹t_sh¨e
 *

791 
	$p‹t_sh¨e_›í
 (c⁄° *
ho°
,

792 c⁄° 
p‹t
,

793 c⁄° 
max_öôül_buf
,

794 c⁄° *
jou∫Æ_dú
)

796 
pid_t
 
pid
;

797 
sockë_des¸ùt‹_t
 
fd
[2];

798 
ö_addr_t
 
ho°addr
;

799 
p‹t_sh¨e
 *
ps
;

801 
	`ALLOC_OBJ_CLEAR
 (
ps
, 
p‹t_sh¨e
);

802 
ps
->
f‹eground_fd
 = -1;

803 
ps
->
background_pid
 = -1;

808 
ho°addr
 = 
	`gëaddr
 (
GETADDR_RESOLVE
|
GETADDR_HOST_ORDER
|
GETADDR_FATAL
, 
ho°
, 0, 
NULL
, NULL);

814 i‡(
	`sockë∑ú
 (
PF_UNIX
, 
SOCK_DGRAM
, 0, 
fd
) == -1)

816 
	`msg
 (
M_WARN
, "PORT SHARE: socketpair call failed");

817 
îr‹
;

823 
pid
 = 
	`f‹k
 ();

825 i‡(
pid
)

827 
°©us
;

833 
ps
->
background_pid
 = 
pid
;

836 
	`›ív≤_˛o£_sockë
 (
fd
[1]);

839 
	`£t_˛€xec
 (
fd
[0]);

842 
°©us
 = 
	`ªcv_c⁄åﬁ
 (
fd
[0]);

843 i‡(
°©us
 =
RESPONSE_INIT_SUCCEEDED
)

847 
	`£t_n⁄block
 (
fd
[0]);

849 
ps
->
f‹eground_fd
 = 
fd
[0];

850  
ps
;

854 
	`msg
 (
M_ERR
, "PORT SHARE: u√x≥˘ed inôÑecv_c⁄åﬁ sètus=%d", 
°©us
);

864 
	`£t_sig«ls
 ();

867 
	`msg_f‹ked
 ();

869 #ifde‡
ENABLE_MANAGEMENT


871 
m™agemít
 = 
NULL
;

875 
	`˛o£_fds_ex˚±
 (
fd
[1]);

878 
	`£t_n⁄block
 (
fd
[1]);

881 
	`¥ng_öô
 (
NULL
, 0);

884 
	`p‹t_sh¨e_¥oxy
 (
ho°addr
, 
p‹t
, 
fd
[1], 
max_öôül_buf
, 
jou∫Æ_dú
);

886 
	`›ív≤_˛o£_sockë
 (
fd
[1]);

888 
	`exô
 (0);

892 
îr‹
:

893 
	`p‹t_sh¨e_˛o£
 (
ps
);

894  
NULL
;

895 
	}
}

898 
	$p‹t_sh¨e_˛o£
 (
p‹t_sh¨e
 *
ps
)

900 i‡(
ps
)

902 i‡(
ps
->
f‹eground_fd
 >= 0)

905 
	`p‹t_sh¨e_£ndmsg
 (
ps
->
f‹eground_fd
, 
COMMAND_EXIT
, 
NULL
, 
SOCKET_UNDEFINED
);

908 
	`dmsg
 (
D_PS_PROXY_DEBUG
, "PORT SHARE: waiting for backgroundÖrocessÅoÉxit");

909 i‡(
ps
->
background_pid
 > 0)

910 
	`waôpid
 (
ps
->
background_pid
, 
NULL
, 0);

911 
	`dmsg
 (
D_PS_PROXY_DEBUG
, "PORT SHARE: backgroundÖrocessÉxited");

913 
	`›ív≤_˛o£_sockë
 (
ps
->
f‹eground_fd
);

914 
ps
->
f‹eground_fd
 = -1;

917 
	`‰ì
 (
ps
);

919 
	}
}

922 
	$p‹t_sh¨e_ab‹t
 (
p‹t_sh¨e
 *
ps
)

924 i‡(
ps
)

927 i‡(
ps
->
f‹eground_fd
 >= 0)

929 
	`£nd_c⁄åﬁ
 (
ps
->
f‹eground_fd
, 
COMMAND_EXIT
);

930 
	`›ív≤_˛o£_sockë
 (
ps
->
f‹eground_fd
);

931 
ps
->
f‹eground_fd
 = -1;

934 
	}
}

941 
boﬁ


942 
	$is_›ív≤_¥Ÿocﬁ
 (c⁄° 
buf„r
 *
buf
)

944 c⁄° *
p
 = (c⁄° *Ë
	`BSTR
 (
buf
);

945 c⁄° 
Àn
 = 
	`BLEN
 (
buf
);

946 i‡(
Àn
 >= 3)

948  
p
[0] == 0

949 && 
p
[1] >= 14

950 && 
p
[2] =(
P_CONTROL_HARD_RESET_CLIENT_V2
<<
P_OPCODE_SHIFT
);

952 i‡(
Àn
 >= 2)

954  
p
[0] == 0 &&Ö[1] >= 14;

957  
åue
;

958 
	}
}

966 
	$p‹t_sh¨e_ªdúe˘
 (
p‹t_sh¨e
 *
ps
, c⁄° 
buf„r
 *
hód
, 
sockë_des¸ùt‹_t
 
sd
)

968 i‡(
ps
)

970 
	`p‹t_sh¨e_£ndmsg
 (
ps
->
f‹eground_fd
, 
COMMAND_REDIRECT
, 
hód
, 
sd
);

972 
	}
}

	@src/openvpn/ps.h

25 #i‚de‡
PS_H


26 
	#PS_H


	)

28 #i‡
PORT_SHARE


30 
	~"basic.h
"

31 
	~"buf„r.h
"

32 
	~"s¶.h
"

34 (*
	tpo°_f‹k_˛ónup_func_t
)(*
	t¨g
);

36 
	sp‹t_sh¨e
 {

38 
sockë_des¸ùt‹_t
 
f‹eground_fd
;

41 
pid_t
 
background_pid
;

44 
p‹t_sh¨e
 *port_share;

46 
p‹t_sh¨e
 *
	`p‹t_sh¨e_›í
 (c⁄° *
ho°
,

47 c⁄° 
p‹t
,

48 c⁄° 
max_öôül_buf
,

49 c⁄° *
jou∫Æ_dú
);

51 
	`p‹t_sh¨e_˛o£
 (
p‹t_sh¨e
 *
ps
);

52 
	`p‹t_sh¨e_ab‹t
 (
p‹t_sh¨e
 *
ps
);

54 
boﬁ
 
	`is_›ív≤_¥Ÿocﬁ
 (c⁄° 
buf„r
 *
buf
);

56 
	`p‹t_sh¨e_ªdúe˘
 (
p‹t_sh¨e
 *
ps
, c⁄° 
buf„r
 *
hód
, 
sockë_des¸ùt‹_t
 
sd
);

	@src/openvpn/push.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"push.h
"

34 
	~"›ti⁄s.h
"

35 
	~"s¶.h
"

36 
	~"m™age.h
"

38 
	~"memdbg.h
"

40 #i‡
P2MP


49 
	$ª˚ive_auth_Áûed
 (
c⁄ãxt
 *
c
, c⁄° 
buf„r
 *buffer)

51 
	`msg
 (
M_VERB0
, "AUTH: Re˚ived c⁄åﬁ mesßge: %s", 
	`BSTR
(
buf„r
));

52 
	`c⁄√˘i⁄_li°_£t_no_adv™˚
(&
c
->
›ti⁄s
);

53 i‡(
c
->
›ti⁄s
.
puŒ
)

55 
	`auth_ªåy_gë
 ())

57 
AR_NONE
:

58 
c
->
sig
->
sig«l_ª˚ived
 = 
SIGTERM
;

60 
AR_INTERACT
:

61 
	`s¶_purge_auth
 (
Ál£
);

62 
AR_NOINTERACT
:

63 
c
->
sig
->
sig«l_ª˚ived
 = 
SIGUSR1
;

66 
	`ASSERT
 (0);

68 
c
->
sig
->
sig«l_ãxt
 = "auth-failure";

69 #ifde‡
ENABLE_MANAGEMENT


70 i‡(
m™agemít
)

72 c⁄° *
ªas⁄
 = 
NULL
;

73 
buf„r
 
buf
 = *buffer;

74 i‡(
	`buf_°rög_com∑ª_adv™˚
 (&
buf
, "AUTH_FAILED,"Ë&& 
	`BLEN
 (&buf))

75 
ªas⁄
 = 
	`BSTR
 (&
buf
);

76 
	`m™agemít_auth_Áûuª
 (
m™agemít
, 
UP_TYPE_AUTH
, 
ªas⁄
);

80 #ifde‡
ENABLE_CLIENT_CR


81 
buf„r
 
buf
 = *buffer;

82 i‡(
	`buf_°rög_m©ch_hód_°r
 (&
buf
, "AUTH_FAILED,CRV1:"Ë&& 
	`BLEN
 (&buf))

84 
	`buf_adv™˚
 (&
buf
, 12);

85 
	`s¶_put_auth_chÆÀnge
 (
	`BSTR
 (&
buf
));

90 
	}
}

96 
	$£rvî_pushed_sig«l
 (
c⁄ãxt
 *
c
, c⁄° 
buf„r
 *buf„r, c⁄° 
boﬁ
 
ª°¨t
, c⁄° 
adv
)

98 i‡(
c
->
›ti⁄s
.
puŒ
)

100 
buf„r
 
buf
 = *buffer;

101 c⁄° *
m
 = "";

102 i‡(
	`buf_adv™˚
 (&
buf
, 
adv
Ë&& 
	`buf_ªad_u8
 (&bufË=',' && 
	`BLEN
 (&buf))

103 
m
 = 
	`BSTR
 (&
buf
);

107 
boﬁ
 
purge
 = 
åue
;

109 i‡(
m
[0] == '[')

111 
i
;

112 
i
 = 1; 
m
[i] != '\0' && m[i] != ']'; ++i)

114 i‡(
m
[
i
] == 'P')

115 
purge
 = 
Ál£
;

118 i‡(
purge
)

119 
	`s¶_purge_auth
 (
åue
);

122 i‡(
ª°¨t
)

124 
	`msg
 (
D_STREAM_ERRORS
, "C⁄√˘i⁄Ñe£àcomm™d wa†pushed by sîvî ('%s')", 
m
);

125 
c
->
sig
->
sig«l_ª˚ived
 = 
SIGUSR1
;

126 
c
->
sig
->
sig«l_ãxt
 = "server-pushed-connection-reset";

130 
	`msg
 (
D_STREAM_ERRORS
, "HÆàcomm™d wa†pushed by sîvî ('%s')", 
m
);

131 
c
->
sig
->
sig«l_ª˚ived
 = 
SIGTERM
;

132 
c
->
sig
->
sig«l_ãxt
 = "server-pushed-halt";

134 #ifde‡
ENABLE_MANAGEMENT


135 i‡(
m™agemít
)

136 
	`m™agemít_nŸify
 (
m™agemít
, "öfo", 
c
->
sig
->
sig«l_ãxt
, 
m
);

139 
	}
}

141 #i‡
P2MP_SERVER


147 
	$£nd_auth_Áûed
 (
c⁄ãxt
 *
c
, c⁄° *
˛õ¡_ªas⁄
)

149 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

150 c⁄° 
auth_Áûed
[] = "AUTH_FAILED";

151 
size_t
 
Àn
;

153 
	`scheduÀ_exô
 (
c
, c->
›ti⁄s
.
scheduÀd_exô_öãrvÆ
, 
SIGTERM
);

155 
Àn
 = (
˛õ¡_ªas⁄
 ? 
	`°æí
(˛õ¡_ªas⁄)+1 : 0Ë+ (
auth_Áûed
);

156 i‡(
Àn
 > 
PUSH_BUNDLE_SIZE
)

157 
Àn
 = 
PUSH_BUNDLE_SIZE
;

160 
buf„r
 
buf
 = 
	`Æloc_buf_gc
 (
Àn
, &
gc
);

161 
	`buf_¥ötf
 (&
buf
, 
auth_Áûed
);

162 i‡(
˛õ¡_ªas⁄
)

163 
	`buf_¥ötf
 (&
buf
, ",%s", 
˛õ¡_ªas⁄
);

164 
	`£nd_c⁄åﬁ_ch™√l_°rög
 (
c
, 
	`BSTR
 (&
buf
), 
D_PUSH
);

167 
	`gc_‰ì
 (&
gc
);

168 
	}
}

174 
	$£nd_ª°¨t
 (
c⁄ãxt
 *
c
, c⁄° *
kûl_msg
)

176 
	`scheduÀ_exô
 (
c
, c->
›ti⁄s
.
scheduÀd_exô_öãrvÆ
, 
SIGTERM
);

177 
	`£nd_c⁄åﬁ_ch™√l_°rög
 (
c
, 
kûl_msg
 ? kûl_msg : "RESTART", 
D_PUSH
);

178 
	}
}

187 
	$öcomög_push_mesßge
 (
c⁄ãxt
 *
c
, c⁄° 
buf„r
 *buffer)

189 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

190 
›ti⁄_ty≥s_found
 = 0;

191 
°©us
;

193 
	`msg
 (
D_PUSH
, "PUSH: Re˚ived c⁄åﬁ mesßge: '%s'", 
	`ßnôize_c⁄åﬁ_mesßge
(
	`BSTR
(
buf„r
), &
gc
));

195 
°©us
 = 
	`¥o˚ss_öcomög_push_msg
 (
c
,

196 
buf„r
,

197 
c
->
›ti⁄s
.
puŒ
,

198 
	`puŒ_≥rmissi⁄_mask
 (
c
),

199 &
›ti⁄_ty≥s_found
);

201 i‡(
°©us
 =
PUSH_MSG_ERROR
)

202 
	`msg
 (
D_PUSH_ERRORS
, "WARNING: Re˚ived badÖush/puŒ mesßge: %s", 
	`ßnôize_c⁄åﬁ_mesßge
(
	`BSTR
(
buf„r
), &
gc
));

203 i‡(
°©us
 =
PUSH_MSG_REPLY
 || sètu†=
PUSH_MSG_CONTINUATION
)

205 
c
->
›ti⁄s
.
push_›ti⁄_ty≥s_found
 |
›ti⁄_ty≥s_found
;

207 i‡(
°©us
 =
PUSH_MSG_REPLY
)

208 
	`do_up
 (
c
, 
åue
, c->
›ti⁄s
.
push_›ti⁄_ty≥s_found
 );

209 
	`evít_timeout_˛ór
 (&
c
->
c2
.
push_ªque°_öãrvÆ
);

212 
	`gc_‰ì
 (&
gc
);

213 
	}
}

215 
boﬁ


216 
	$£nd_push_ªque°
 (
c⁄ãxt
 *
c
)

218 c⁄° 
max_push_ªque°s
 = 
c
->
›ti⁄s
.
h™dshake_wödow
 / 
PUSH_REQUEST_INTERVAL
;

219 i‡(++
c
->
c2
.
n_£¡_push_ªque°s
 <
max_push_ªque°s
)

221  
	`£nd_c⁄åﬁ_ch™√l_°rög
 (
c
, "PUSH_REQUEST", 
D_PUSH
);

225 
	`msg
 (
D_STREAM_ERRORS
, "Nÿª∂y from sîvîá·î sídög %dÖushÑeque°s", 
max_push_ªque°s
);

226 
c
->
sig
->
sig«l_ª˚ived
 = 
SIGUSR1
;

227 
c
->
sig
->
sig«l_ãxt
 = "no-push-reply";

228  
Ál£
;

230 
	}
}

232 #i‡
P2MP_SERVER


234 
boﬁ


235 
	$£nd_push_ª∂y
 (
c⁄ãxt
 *
c
)

237 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

238 
buf„r
 
buf
 = 
	`Æloc_buf_gc
 (
PUSH_BUNDLE_SIZE
, &
gc
);

239 
push_íåy
 *
e
 = 
c
->
›ti⁄s
.
push_li°
.
hód
;

240 
boﬁ
 
mu…i_push
 = 
Ál£
;

241 
cmd
[] = "PUSH_REPLY";

242 c⁄° 
exåa
 = 84;

243 c⁄° 
ß„_ˇp
 = 
	`BCAP
 (&
buf
Ë- 
exåa
;

244 
boﬁ
 
push_£¡
 = 
Ál£
;

246 
	`msg
–
M_INFO
, "£nd_push_ª∂y(): sa„_ˇp=%d", 
ß„_ˇp
 );

248 
	`buf_¥ötf
 (&
buf
, "%s", 
cmd
);

250 i‡–
c
->
c2
.
push_ifc⁄fig_ùv6_deföed
 )

253 
	`buf_¥ötf
–&
buf
, ",ifconfig-ipv6 %s/%d %s",

254 
	`¥öt_ö6_addr
–
c
->
c2
.
push_ifc⁄fig_ùv6_loˇl
, 0, &
gc
),

255 
c
->
c2
.
push_ifc⁄fig_ùv6_√tbôs
,

256 
	`¥öt_ö6_addr
–
c
->
c2
.
push_ifc⁄fig_ùv6_ªmŸe
, 0, &
gc
) );

257 i‡(
	`BLEN
 (&
buf
Ë>
ß„_ˇp
)

259 
	`msg
 (
M_WARN
, "--push ifconfig-ipv6 option isÅooÜong");

260 
Áû
;

264 
e
)

266 i‡(
e
->
íabÀ
)

268 c⁄° 
l
 = 
	`°æí
 (
e
->
›ti⁄
);

269 i‡(
	`BLEN
 (&
buf
Ë+ 
l
 >
ß„_ˇp
)

271 
	`buf_¥ötf
 (&
buf
, ",push-continuation 2");

273 c⁄° 
boﬁ
 
°©us
 = 
	`£nd_c⁄åﬁ_ch™√l_°rög
 (
c
, 
	`BSTR
 (&
buf
), 
D_PUSH
);

274 i‡(!
°©us
)

275 
Áû
;

276 
push_£¡
 = 
åue
;

277 
mu…i_push
 = 
åue
;

278 
	`buf_ª£t_Àn
 (&
buf
);

279 
	`buf_¥ötf
 (&
buf
, "%s", 
cmd
);

282 i‡(
	`BLEN
 (&
buf
Ë+ 
l
 >
ß„_ˇp
)

284 
	`msg
 (
M_WARN
, "--push option isÅooÜong");

285 
Áû
;

287 
	`buf_¥ötf
 (&
buf
, ",%s", 
e
->
›ti⁄
);

289 
e
 =É->
√xt
;

292 i‡(
c
->
c2
.
push_ifc⁄fig_deföed
 && c->c2.
push_ifc⁄fig_loˇl
 && c->c2.
push_ifc⁄fig_ªmŸe_√tmask
)

294 
ö_addr_t
 
ifc⁄fig_loˇl
 = 
c
->
c2
.
push_ifc⁄fig_loˇl
;

295 #ifde‡
ENABLE_CLIENT_NAT


296 i‡(
c
->
c2
.
push_ifc⁄fig_loˇl_Æüs
)

297 
ifc⁄fig_loˇl
 = 
c
->
c2
.
push_ifc⁄fig_loˇl_Æüs
;

299 
	`buf_¥ötf
 (&
buf
, ",ifconfig %s %s",

300 
	`¥öt_ö_addr_t
 (
ifc⁄fig_loˇl
, 0, &
gc
),

301 
	`¥öt_ö_addr_t
 (
c
->
c2
.
push_ifc⁄fig_ªmŸe_√tmask
, 0, &
gc
));

303 i‡(
mu…i_push
)

304 
	`buf_¥ötf
 (&
buf
, ",push-continuation 1");

306 i‡(
	`BLEN
 (&
buf
Ë> (
cmd
)-1)

308 c⁄° 
boﬁ
 
°©us
 = 
	`£nd_c⁄åﬁ_ch™√l_°rög
 (
c
, 
	`BSTR
 (&
buf
), 
D_PUSH
);

309 i‡(!
°©us
)

310 
Áû
;

311 
push_£¡
 = 
åue
;

317 i‡(!
push_£¡
)

319 
boﬁ
 
°©us
 = 
Ál£
;

321 
	`buf_ª£t_Àn
 (&
buf
);

322 
	`buf_¥ötf
 (&
buf
, "%s", 
cmd
);

323 
°©us
 = 
	`£nd_c⁄åﬁ_ch™√l_°rög
 (
c
, 
	`BSTR
(&
buf
), 
D_PUSH
);

324 i‡(!
°©us
)

325 
Áû
;

328 
	`gc_‰ì
 (&
gc
);

329  
åue
;

331 
Áû
:

332 
	`gc_‰ì
 (&
gc
);

333  
Ál£
;

334 
	}
}

337 
	$push_›ti⁄_ex
 (
›ti⁄s
 *
o
, c⁄° *
›t
, 
boﬁ
 
íabÀ
, 
msgÀvñ
)

339 i‡(!
	`°rög_˛ass
 (
›t
, 
CC_ANY
, 
CC_COMMA
))

341 
	`msg
 (
msgÀvñ
, "PUSH OPTION FAILED (ûÀgÆ comm®(','Ëö såög): '%s'", 
›t
);

345 
push_íåy
 *
e
;

346 
	`ALLOC_OBJ_CLEAR_GC
 (
e
, 
push_íåy
, &
o
->
gc
);

347 
e
->
íabÀ
 = 
åue
;

348 
e
->
›ti⁄
 = 
›t
;

349 i‡(
o
->
push_li°
.
hód
)

351 
	`ASSERT
(
o
->
push_li°
.
èû
);

352 
o
->
push_li°
.
èû
->
√xt
 = 
e
;

353 
o
->
push_li°
.
èû
 = 
e
;

357 
	`ASSERT
(!
o
->
push_li°
.
èû
);

358 
o
->
push_li°
.
hód
 = 
e
;

359 
o
->
push_li°
.
èû
 = 
e
;

362 
	}
}

365 
	$push_›ti⁄
 (
›ti⁄s
 *
o
, c⁄° *
›t
, 
msgÀvñ
)

367 
	`push_›ti⁄_ex
 (
o
, 
›t
, 
åue
, 
msgÀvñ
);

368 
	}
}

371 
	$˛⁄e_push_li°
 (
›ti⁄s
 *
o
)

373 i‡(
o
->
push_li°
.
hód
)

375 c⁄° 
push_íåy
 *
e
 = 
o
->
push_li°
.
hód
;

376 
	`push_ª£t
 (
o
);

377 
e
)

379 
	`push_›ti⁄_ex
 (
o
, 
	`°rög_Æloc
 (
e
->
›ti⁄
, &o->
gc
), 
åue
, 
M_FATAL
);

380 
e
 =É->
√xt
;

383 
	}
}

386 
	$push_›ti⁄s
 (
›ti⁄s
 *
o
, **
p
, 
msgÀvñ
, 
gc_¨ía
 *
gc
)

388 c⁄° **
¨gv
 = 
	`make_exãnded_¨g_¨øy
 (
p
, 
gc
);

389 *
›t
 = 
	`¥öt_¨gv
 (
¨gv
, 
gc
, 0);

390 
	`push_›ti⁄
 (
o
, 
›t
, 
msgÀvñ
);

391 
	}
}

394 
	$push_ª£t
 (
›ti⁄s
 *
o
)

396 
	`CLEAR
 (
o
->
push_li°
);

397 
	}
}

401 
	$¥o˚ss_öcomög_push_msg
 (
c⁄ãxt
 *
c
,

402 c⁄° 
buf„r
 *buffer,

403 
boﬁ
 
h⁄‹_ª˚ived_›ti⁄s
,

404 
≥rmissi⁄_mask
,

405 *
›ti⁄_ty≥s_found
)

407 
ªt
 = 
PUSH_MSG_ERROR
;

408 
buf„r
 
buf
 = *buffer;

410 #i‡
P2MP_SERVER


411 i‡(
	`buf_°rög_com∑ª_adv™˚
 (&
buf
, "PUSH_REQUEST"))

413 i‡(
	`és_authítiˇti⁄_°©us
 (
c
->
c2
.
és_mu…i
, 0Ë=
TLS_AUTHENTICATION_FAILED
 || c->c2.
c⁄ãxt_auth
 =
CAS_FAILED
)

415 c⁄° *
˛õ¡_ªas⁄
 = 
	`és_˛õ¡_ªas⁄
 (
c
->
c2
.
és_mu…i
);

416 
	`£nd_auth_Áûed
 (
c
, 
˛õ¡_ªas⁄
);

417 
ªt
 = 
PUSH_MSG_AUTH_FAILURE
;

419 i‡(!
c
->
c2
.
push_ª∂y_de„ºed
 && c->c2.
c⁄ãxt_auth
 =
CAS_SUCCEEDED
)

421 
time_t
 
now
;

423 
	`›ív≤_time
(&
now
);

424 i‡(
c
->
c2
.
£¡_push_ª∂y_expúy
 > 
now
)

426 
ªt
 = 
PUSH_MSG_ALREADY_REPLIED
;

430 i‡(
	`£nd_push_ª∂y
 (
c
))

432 
ªt
 = 
PUSH_MSG_REQUEST
;

433 
c
->
c2
.
£¡_push_ª∂y_expúy
 = 
now
 + 30;

439 
ªt
 = 
PUSH_MSG_REQUEST_DEFERRED
;

445 i‡(
h⁄‹_ª˚ived_›ti⁄s
 && 
	`buf_°rög_com∑ª_adv™˚
 (&
buf
, "PUSH_REPLY"))

447 c⁄° 
uöt8_t
 
ch
 = 
	`buf_ªad_u8
 (&
buf
);

448 i‡(
ch
 == ',')

450 
buf„r
 
buf_‹ig
 = 
buf
;

451 i‡(!
c
->
c2
.
puŒed_›ti⁄s_md5_öô_d⁄e
)

453 
	`md5_°©e_öô
 (&
c
->
c2
.
puŒed_›ti⁄s_°©e
);

454 
c
->
c2
.
puŒed_›ti⁄s_md5_öô_d⁄e
 = 
åue
;

456 i‡(!
c
->
c2
.
did_¥e_puŒ_ª°‹e
)

458 
	`¥e_puŒ_ª°‹e
 (&
c
->
›ti⁄s
);

459 
c
->
c2
.
did_¥e_puŒ_ª°‹e
 = 
åue
;

461 i‡(
	`≠∂y_push_›ti⁄s
 (&
c
->
›ti⁄s
,

462 &
buf
,

463 
≥rmissi⁄_mask
,

464 
›ti⁄_ty≥s_found
,

465 
c
->
c2
.
es
))

466 
c
->
›ti⁄s
.
push_c⁄töu©i⁄
)

470 
	`md5_°©e_upd©e
 (&
c
->
c2
.
puŒed_›ti⁄s_°©e
, 
	`BPTR
(&
buf_‹ig
), 
	`BLEN
(&buf_orig));

471 
	`md5_°©e_föÆ
 (&
c
->
c2
.
puŒed_›ti⁄s_°©e
, &c->c2.
puŒed_›ti⁄s_dige°
);

472 
c
->
c2
.
puŒed_›ti⁄s_md5_öô_d⁄e
 = 
Ál£
;

473 
ªt
 = 
PUSH_MSG_REPLY
;

476 
	`md5_°©e_upd©e
 (&
c
->
c2
.
puŒed_›ti⁄s_°©e
, 
	`BPTR
(&
buf_‹ig
), 
	`BLEN
(&buf_orig));

477 
ªt
 = 
PUSH_MSG_CONTINUATION
;

481 i‡(
ch
 == '\0')

483 
ªt
 = 
PUSH_MSG_REPLY
;

487  
ªt
;

488 
	}
}

490 #i‡
P2MP_SERVER


496 
	$ªmove_úouãs_‰om_push_rouã_li°
 (
›ti⁄s
 *
o
)

498 i‡(
o
 && o->
push_li°
.
hód
 && o->
úouãs
)

500 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

501 
push_íåy
 *
e
 = 
o
->
push_li°
.
hód
;

504 
e
)

506 *
p
[
MAX_PARMS
];

507 
boﬁ
 
íabÀ
 = 
åue
;

510 
	`CLEAR
 (
p
);

511 i‡(
	`∑r£_löe
 (
e
->
›ti⁄
, 
p
, 
	`SIZE
 (p), "[PUSH_ROUTE_REMOVE]", 1, 
D_ROUTE_DEBUG
, &
gc
))

514 i‡(
p
[0] && !
	`°rcmp
 (p[0], "route") && !p[3])

517 
boﬁ
 
°©us1
, 
°©us2
;

518 c⁄° 
ö_addr_t
 
√tw‹k
 = 
	`gëaddr
 (
GETADDR_HOST_ORDER
, 
p
[1], 0, &
°©us1
, 
NULL
);

519 c⁄° 
ö_addr_t
 
√tmask
 = 
	`gëaddr
 (
GETADDR_HOST_ORDER
, 
p
[2] ?Ö[2] : "255.255.255.255", 0, &
°©us2
, 
NULL
);

522 i‡(
°©us1
 && 
°©us2
)

524 c⁄° 
úouã
 *
ú
;

527 
ú
 = 
o
->
úouãs
; i∏!
NULL
; i∏ú->
√xt
)

529 i‡(
√tw‹k
 =
ú
->√tw‹k && 
√tmask
 =
	`√tbôs_to_√tmask
 (ú->
√tbôs
 >= 0 ? ir->netbits : 32))

531 
íabÀ
 = 
Ál£
;

540 
e
->
íabÀ
 =Énable;

541 i‡(!
íabÀ
)

542 
	`msg
 (
D_PUSH
, "REMOVE PUSH ROUTE: '%s'", 
e
->
›ti⁄
);

544 
e
 =É->
√xt
;

547 
	`gc_‰ì
 (&
gc
);

549 
	}
}

	@src/openvpn/push.h

25 #i‚de‡
PUSH_H


26 
	#PUSH_H


	)

28 #i‡
P2MP


30 
	~"f‹w¨d.h
"

32 
	#PUSH_MSG_ERROR
 0

	)

33 
	#PUSH_MSG_REQUEST
 1

	)

34 
	#PUSH_MSG_REPLY
 2

	)

35 
	#PUSH_MSG_REQUEST_DEFERRED
 3

	)

36 
	#PUSH_MSG_AUTH_FAILURE
 4

	)

37 
	#PUSH_MSG_CONTINUATION
 5

	)

38 
	#PUSH_MSG_ALREADY_REPLIED
 6

	)

40 
öcomög_push_mesßge
 (
c⁄ãxt
 *
c
,

41 c⁄° 
buf„r
 *buffer);

43 
¥o˚ss_öcomög_push_msg
 (
c⁄ãxt
 *
c
,

44 c⁄° 
buf„r
 *buffer,

45 
boﬁ
 
h⁄‹_ª˚ived_›ti⁄s
,

46 
≥rmissi⁄_mask
,

47 *
›ti⁄_ty≥s_found
);

49 
boﬁ
 
£nd_push_ªque°
 (
c⁄ãxt
 *
c
);

51 
ª˚ive_auth_Áûed
 (
c⁄ãxt
 *
c
, c⁄° 
buf„r
 *buffer);

53 
£rvî_pushed_sig«l
 (
c⁄ãxt
 *
c
, c⁄° 
buf„r
 *buf„r, c⁄° 
boﬁ
 
ª°¨t
, c⁄° 
adv
);

55 #i‡
P2MP_SERVER


57 
˛⁄e_push_li°
 (
›ti⁄s
 *
o
);

59 
push_›ti⁄
 (
›ti⁄s
 *
o
, c⁄° *
›t
, 
msgÀvñ
);

60 
push_›ti⁄s
 (
›ti⁄s
 *
o
, **
p
, 
msgÀvñ
, 
gc_¨ía
 *
gc
);

62 
push_ª£t
 (
›ti⁄s
 *
o
);

64 
boﬁ
 
£nd_push_ª∂y
 (
c⁄ãxt
 *
c
);

66 
ªmove_úouãs_‰om_push_rouã_li°
 (
›ti⁄s
 *
o
);

68 
£nd_auth_Áûed
 (
c⁄ãxt
 *
c
, c⁄° *
˛õ¡_ªas⁄
);

70 
£nd_ª°¨t
 (
c⁄ãxt
 *
c
, c⁄° *
kûl_msg
);

	@src/openvpn/pushlist.h

25 #i‡!
deföed
(
PUSHLIST_H
Ë&& 
P2MP
 && 
P2MP_SERVER


26 
	#PUSHLIST_H


	)

30 
	spush_íåy
 {

31 
push_íåy
 *
	m√xt
;

32 
boﬁ
 
	míabÀ
;

33 c⁄° *
	m›ti⁄
;

36 
	spush_li°
 {

37 
push_íåy
 *
	mhód
;

38 
push_íåy
 *
	mèû
;

	@src/openvpn/reliable.c

30 #ifde‡
HAVE_CONFIG_H


31 
	~"c⁄fig.h
"

32 #ñi‡
deföed
(
_MSC_VER
)

33 
	~"c⁄fig-msvc.h
"

36 
	~"syshód.h
"

38 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

40 
	~"buf„r.h
"

41 
	~"îr‹.h
"

42 
	~"comm⁄.h
"

43 
	~"ªlübÀ.h
"

45 
	~"memdbg.h
"

50 
ölöe
 
boﬁ


51 
	$ªlübÀ_pid_ö_ønge1
 (c⁄° 
∑ckë_id_ty≥
 
ã°
,

52 c⁄° 
∑ckë_id_ty≥
 
ba£
,

53 c⁄° 
exã¡
)

55 i‡(
ã°
 >
ba£
)

57 i‡(
ã°
 - 
ba£
 < 
exã¡
)

58  
åue
;

62 i‡((
ã°
+0x80000000uË- (
ba£
+0x80000000uË< 
exã¡
)

63  
åue
;

66  
Ál£
;

67 
	}
}

72 
ölöe
 
boﬁ


73 
	$ªlübÀ_pid_ö_ønge2
 (c⁄° 
∑ckë_id_ty≥
 
ã°
,

74 c⁄° 
∑ckë_id_ty≥
 
ba£
,

75 c⁄° 
exã¡
)

77 i‡(
ba£
 + 
exã¡
 >= base)

79 i‡(
ã°
 < 
ba£
 + 
exã¡
)

80  
åue
;

84 i‡((
ã°
+0x80000000uË< (
ba£
+0x80000000uË+ 
exã¡
)

85  
åue
;

88  
Ál£
;

89 
	}
}

94 
ölöe
 
boﬁ


95 
	$ªlübÀ_pid_mö
 (c⁄° 
∑ckë_id_ty≥
 
p1
,

96 c⁄° 
∑ckë_id_ty≥
 
p2
)

98  !
	`ªlübÀ_pid_ö_ønge1
 (
p1
, 
p2
, 0x80000000u);

99 
	}
}

102 
ölöe
 
boﬁ


103 
	$ªlübÀ_ack_∑ckë_id_¥e£¡
 (
ªlübÀ_ack
 *
ack
, 
∑ckë_id_ty≥
 
pid
)

105 
i
;

106 
i
 = 0; i < 
ack
->
Àn
; ++i)

107 i‡(
ack
->
∑ckë_id
[
i
] =
pid
)

108  
åue
;

109  
Ál£
;

110 
	}
}

113 
boﬁ


114 
	$ªlübÀ_ack_ªad_∑ckë_id
 (
buf„r
 *
buf
, 
∑ckë_id_ty≥
 *
pid
)

116 
∑ckë_id_ty≥
 
√t_pid
;

118 i‡(
	`buf_ªad
 (
buf
, &
√t_pid
,  (net_pid)))

120 *
pid
 = 
	`¡ohpid
 (
√t_pid
);

121 
	`dmsg
 (
D_REL_DEBUG
, "ACKÑód ID " 
∑ckë_id_f‹m©
 " (buf->len=%d)",

122 (
∑ckë_id_¥öt_ty≥
)*
pid
, 
buf
->
Àn
);

123  
åue
;

126 
	`dmsg
 (
D_REL_LOW
, "ACKÑód ID FAILED (buf->Àn=%d)", 
buf
->
Àn
);

127  
Ál£
;

128 
	}
}

131 
boﬁ


132 
	$ªlübÀ_ack_acknowÀdge_∑ckë_id
 (
ªlübÀ_ack
 *
ack
, 
∑ckë_id_ty≥
 
pid
)

134 i‡(!
	`ªlübÀ_ack_∑ckë_id_¥e£¡
 (
ack
, 
pid
Ë&&áck->
Àn
 < 
RELIABLE_ACK_SIZE
)

136 
ack
->
∑ckë_id
[ack->
Àn
++] = 
pid
;

137 
	`dmsg
 (
D_REL_DEBUG
, "ACKácknowÀdgêID " 
∑ckë_id_f‹m©
 " (ack->len=%d)",

138 (
∑ckë_id_¥öt_ty≥
)
pid
, 
ack
->
Àn
);

139  
åue
;

142 
	`dmsg
 (
D_REL_LOW
, "ACKácknowÀdgêID " 
∑ckë_id_f‹m©
 " FAILED (ack->len=%d)",

143 (
∑ckë_id_¥öt_ty≥
)
pid
, 
ack
->
Àn
);

144  
Ál£
;

145 
	}
}

148 
boﬁ


149 
	$ªlübÀ_ack_ªad
 (
ªlübÀ_ack
 * 
ack
,

150 
buf„r
 * 
buf
, c⁄° 
£ssi⁄_id
 * 
sid
)

152 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

153 
i
;

154 
uöt8_t
 
cou¡
;

155 
∑ckë_id_ty≥
 
√t_pid
;

156 
∑ckë_id_ty≥
 
pid
;

157 
£ssi⁄_id
 
£ssi⁄_id_ªmŸe
;

159 i‡(!
	`buf_ªad
 (
buf
, &
cou¡
,  (count)))

160 
îr‹
;

161 
i
 = 0; i < 
cou¡
; ++i)

163 i‡(!
	`buf_ªad
 (
buf
, &
√t_pid
,  (net_pid)))

164 
îr‹
;

165 i‡(
ack
->
Àn
 >
RELIABLE_ACK_SIZE
)

166 
îr‹
;

167 
pid
 = 
	`¡ohpid
 (
√t_pid
);

168 
ack
->
∑ckë_id
[ack->
Àn
++] = 
pid
;

170 i‡(
cou¡
)

172 i‡(!
	`£ssi⁄_id_ªad
 (&
£ssi⁄_id_ªmŸe
, 
buf
))

173 
îr‹
;

174 i‡(!
	`£ssi⁄_id_deföed
 (&
£ssi⁄_id_ªmŸe
) ||

175 !
	`£ssi⁄_id_equÆ
 (&
£ssi⁄_id_ªmŸe
, 
sid
))

177 
	`dmsg
 (
D_REL_LOW
,

179 
	`£ssi⁄_id_¥öt
 (
sid
, &
gc
), sessi⁄_id_¥öà(&
£ssi⁄_id_ªmŸe
, &gc));

180 
îr‹
;

183 
	`gc_‰ì
 (&
gc
);

184  
åue
;

186 
îr‹
:

187 
	`gc_‰ì
 (&
gc
);

188  
Ál£
;

189 
	}
}

191 
	#ACK_SIZE
(
n
Ë( (
uöt8_t
Ë+ (“Ë? 
SID_SIZE
 : 0Ë+  (
∑ckë_id_ty≥
Ë* (n))

	)

195 
boﬁ


196 
	$ªlübÀ_ack_wrôe
 (
ªlübÀ_ack
 * 
ack
,

197 
buf„r
 * 
buf
,

198 c⁄° 
£ssi⁄_id
 * 
sid
, 
max
, 
boﬁ
 
¥ïíd
)

200 
i
, 
j
;

201 
uöt8_t
 
n
;

202 
buf„r
 
sub
;

204 
n
 = 
ack
->
Àn
;

205 i‡(
n
 > 
max
)

206 
n
 = 
max
;

207 
sub
 = 
	`buf_sub
 (
buf
, 
	`ACK_SIZE
(
n
), 
¥ïíd
);

208 i‡(!
	`BDEF
 (&
sub
))

209 
îr‹
;

210 
	`ASSERT
 (
	`buf_wrôe
 (&
sub
, &
n
,  (n)));

211 
i
 = 0; i < 
n
; ++i)

213 
∑ckë_id_ty≥
 
pid
 = 
ack
->
∑ckë_id
[
i
];

214 
∑ckë_id_ty≥
 
√t_pid
 = 
	`ht⁄pid
 (
pid
);

215 
	`ASSERT
 (
	`buf_wrôe
 (&
sub
, &
√t_pid
,  (net_pid)));

216 
	`dmsg
 (
D_REL_DEBUG
, "ACK wrôêID " 
∑ckë_id_f‹m©
 " (ack->Àn=%d,Ç=%d)", (
∑ckë_id_¥öt_ty≥
)
pid
, 
ack
->
Àn
, 
n
);

218 i‡(
n
)

220 
	`ASSERT
 (
	`£ssi⁄_id_deföed
 (
sid
));

221 
	`ASSERT
 (
	`£ssi⁄_id_wrôe
 (
sid
, &
sub
));

222 
i
 = 0, 
j
 = 
n
; j < 
ack
->
Àn
;)

223 
ack
->
∑ckë_id
[
i
++] =áck->∑ckë_id[
j
++];

224 
ack
->
Àn
 = 
i
;

227  
åue
;

229 
îr‹
:

230  
Ál£
;

231 
	}
}

235 
	$ªlübÀ_ack_adju°_‰ame_∑ømëîs
 (
‰ame
* føme, 
max
)

237 
	`‰ame_add_to_exåa_‰ame
 (
‰ame
, 
	`ACK_SIZE
 (
max
));

238 
	}
}

242 
	$ªlübÀ_ack_¥öt
 (
buf„r
 *
buf
, 
boﬁ
 
vîbo£
, 
gc_¨ía
 *
gc
)

244 
i
;

245 
uöt8_t
 
n_ack
;

246 
£ssi⁄_id
 
sid_ack
;

247 
∑ckë_id_ty≥
 
pid
;

248 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

250 
	`buf_¥ötf
 (&
out
, "[");

251 i‡(!
	`buf_ªad
 (
buf
, &
n_ack
,  (n_ack)))

252 
d⁄e
;

253 
i
 = 0; i < 
n_ack
; ++i)

255 i‡(!
	`buf_ªad
 (
buf
, &
pid
,  (pid)))

256 
d⁄e
;

257 
pid
 = 
	`¡ohpid
 (pid);

258 
	`buf_¥ötf
 (&
out
, " " 
∑ckë_id_f‹m©
, (
∑ckë_id_¥öt_ty≥
)
pid
);

260 i‡(
n_ack
)

262 i‡(!
	`£ssi⁄_id_ªad
 (&
sid_ack
, 
buf
))

263 
d⁄e
;

264 i‡(
vîbo£
)

265 
	`buf_¥ötf
 (&
out
, " sid=%s", 
	`£ssi⁄_id_¥öt
 (&
sid_ack
, 
gc
));

268 
d⁄e
:

269 
	`buf_¥ötf
 (&
out
, " ]");

270  
	`BSTR
 (&
out
);

271 
	}
}

278 
	$ªlübÀ_öô
 (
ªlübÀ
 *
ªl
, 
buf_size
, 
off£t
, 
¨øy_size
, 
boﬁ
 
hﬁd
)

280 
i
;

282 
	`CLEAR
 (*
ªl
);

283 
	`ASSERT
 (
¨øy_size
 > 0 &&áºay_sizê<
RELIABLE_CAPACITY
);

284 
ªl
->
hﬁd
 = hold;

285 
ªl
->
size
 = 
¨øy_size
;

286 
ªl
->
off£t
 = offset;

287 
i
 = 0; i < 
ªl
->
size
; ++i)

289 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

290 
e
->
buf
 = 
	`Æloc_buf
 (
buf_size
);

291 
	`ASSERT
 (
	`buf_öô
 (&
e
->
buf
, 
off£t
));

293 
	}
}

296 
	$ªlübÀ_‰ì
 (
ªlübÀ
 *
ªl
)

298 
i
;

299 
i
 = 0; i < 
ªl
->
size
; ++i)

301 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

302 
	`‰ì_buf
 (&
e
->
buf
);

304 
	}
}

307 
boﬁ


308 
	$ªlübÀ_em±y
 (c⁄° 
ªlübÀ
 *
ªl
)

310 
i
;

311 
i
 = 0; i < 
ªl
->
size
; ++i)

313 c⁄° 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

314 i‡(
e
->
a˘ive
)

315  
Ál£
;

317  
åue
;

318 
	}
}

322 
	$ªlübÀ_£nd_purge
 (
ªlübÀ
 *
ªl
, 
ªlübÀ_ack
 *
ack
)

324 
i
, 
j
;

325 
i
 = 0; i < 
ack
->
Àn
; ++i)

327 
∑ckë_id_ty≥
 
pid
 = 
ack
->
∑ckë_id
[
i
];

328 
j
 = 0; j < 
ªl
->
size
; ++j)

330 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
j
];

331 i‡(
e
->
a˘ive
 &&É->
∑ckë_id
 =
pid
)

333 
	`dmsg
 (
D_REL_DEBUG
,

334 "ACKÑe˚ived f‹Öid " 
∑ckë_id_f‹m©
 ", deleting from send buffer",

335 (
∑ckë_id_¥öt_ty≥
)
pid
);

339 i‡(
e
->
√xt_åy
)

341 c⁄° 
öãrvÆ_t
 
wake
 = 
e
->
√xt_åy
 - 
now
;

342 
	`msg
 (
M_INFO
, "ACK " 
∑ckë_id_f‹m©
 ", wake=%d", 
pid
, 
wake
);

346 
e
->
a˘ive
 = 
Ál£
;

351 
	}
}

355 
	$ªlübÀ_¥öt_ids
 (c⁄° 
ªlübÀ
 *
ªl
, 
gc_¨ía
 *
gc
)

357 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

358 
i
;

360 
	`buf_¥ötf
 (&
out
, "[" 
∑ckë_id_f‹m©
 "]", (
∑ckë_id_¥öt_ty≥
)
ªl
->
∑ckë_id
);

361 
i
 = 0; i < 
ªl
->
size
; ++i)

363 c⁄° 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

364 i‡(
e
->
a˘ive
)

365 
	`buf_¥ötf
 (&
out
, " " 
∑ckë_id_f‹m©
, (
∑ckë_id_¥öt_ty≥
)
e
->
∑ckë_id
);

367  
	`BSTR
 (&
out
);

368 
	}
}

371 
boﬁ


372 
	$ªlübÀ_ˇn_gë
 (c⁄° 
ªlübÀ
 *
ªl
)

374 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

375 
i
;

376 
i
 = 0; i < 
ªl
->
size
; ++i)

378 c⁄° 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

379 i‡(!
e
->
a˘ive
)

380  
åue
;

382 
	`dmsg
 (
D_REL_LOW
, "ACKÇÿ‰ìÑe˚ivêbuf„∏avaûabÀ: %s", 
	`ªlübÀ_¥öt_ids
 (
ªl
, &
gc
));

383 
	`gc_‰ì
 (&
gc
);

384  
Ál£
;

385 
	}
}

388 
boﬁ


389 
	$ªlübÀ_nŸ_ª∂ay
 (c⁄° 
ªlübÀ
 *
ªl
, 
∑ckë_id_ty≥
 
id
)

391 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

392 
i
;

393 i‡(
	`ªlübÀ_pid_mö
 (
id
, 
ªl
->
∑ckë_id
))

394 
bad
;

395 
i
 = 0; i < 
ªl
->
size
; ++i)

397 c⁄° 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

398 i‡(
e
->
a˘ive
 &&É->
∑ckë_id
 =
id
)

399 
bad
;

401 
	`gc_‰ì
 (&
gc
);

402  
åue
;

404 
bad
:

405 
	`dmsg
 (
D_REL_DEBUG
, "ACK " 
∑ckë_id_f‹m©
 " i†®ª∂ay: %s", (
∑ckë_id_¥öt_ty≥
)
id
, 
	`ªlübÀ_¥öt_ids
 (
ªl
, &
gc
));

406 
	`gc_‰ì
 (&
gc
);

407  
Ál£
;

408 
	}
}

411 
boﬁ


412 
	$ªlübÀ_w⁄t_bªak_£quítülôy
 (c⁄° 
ªlübÀ
 *
ªl
, 
∑ckë_id_ty≥
 
id
)

414 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

416 c⁄° 
ªt
 = 
	`ªlübÀ_pid_ö_ønge2
 (
id
, 
ªl
->
∑ckë_id
,Ññ->
size
);

418 i‡(!
ªt
)

420 
	`dmsg
 (
D_REL_LOW
, "ACK " 
∑ckë_id_f‹m©
 " breaks sequentiality: %s",

421 (
∑ckë_id_¥öt_ty≥
)
id
, 
	`ªlübÀ_¥öt_ids
 (
ªl
, &
gc
));

424 
	`dmsg
 (
D_REL_DEBUG
, "ACK RWBSÑñ->size=%dÑñ->∑ckë_id=%08x id=%08xÑë=%d\n", 
ªl
->
size
,Ññ->
∑ckë_id
, 
id
, 
ªt
);

426 
	`gc_‰ì
 (&
gc
);

427  
ªt
;

428 
	}
}

431 
buf„r
 *

432 
	$ªlübÀ_gë_buf
 (
ªlübÀ
 *
ªl
)

434 
i
;

435 
i
 = 0; i < 
ªl
->
size
; ++i)

437 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

438 i‡(!
e
->
a˘ive
)

440 
	`ASSERT
 (
	`buf_öô
 (&
e
->
buf
, 
ªl
->
off£t
));

441  &
e
->
buf
;

444  
NULL
;

445 
	}
}

448 
buf„r
 *

449 
	$ªlübÀ_gë_buf_ouçut_£quí˚d
 (
ªlübÀ
 *
ªl
)

451 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

452 
i
;

453 
∑ckë_id_ty≥
 
mö_id
 = 0;

454 
boﬁ
 
mö_id_deföed
 = 
Ál£
;

455 
buf„r
 *
ªt
 = 
NULL
;

458 
i
 = 0; i < 
ªl
->
size
; ++i)

460 c⁄° 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

461 i‡(
e
->
a˘ive
)

463 i‡(!
mö_id_deföed
 || 
	`ªlübÀ_pid_mö
 (
e
->
∑ckë_id
, 
mö_id
))

465 
mö_id_deföed
 = 
åue
;

466 
mö_id
 = 
e
->
∑ckë_id
;

471 i‡(!
mö_id_deföed
 || 
	`ªlübÀ_pid_ö_ønge1
 (
ªl
->
∑ckë_id
, 
mö_id
,Ññ->
size
))

473 
ªt
 = 
	`ªlübÀ_gë_buf
 (
ªl
);

477 
	`dmsg
 (
D_REL_LOW
, "ACK ouçuà£quí˚ brokí: %s", 
	`ªlübÀ_¥öt_ids
 (
ªl
, &
gc
));

479 
	`gc_‰ì
 (&
gc
);

480  
ªt
;

481 
	}
}

484 
buf„r
 *

485 
	$ªlübÀ_gë_buf_£quí˚d
 (
ªlübÀ
 *
ªl
)

487 
i
;

488 
i
 = 0; i < 
ªl
->
size
; ++i)

490 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

491 i‡(
e
->
a˘ive
 &&É->
∑ckë_id
 =
ªl
->packet_id)

493  &
e
->
buf
;

496  
NULL
;

497 
	}
}

500 
boﬁ


501 
	$ªlübÀ_ˇn_£nd
 (c⁄° 
ªlübÀ
 *
ªl
)

503 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

504 
i
;

505 
n_a˘ive
 = 0, 
n_cuºít
 = 0;

506 
i
 = 0; i < 
ªl
->
size
; ++i)

508 c⁄° 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

509 i‡(
e
->
a˘ive
)

511 ++
n_a˘ive
;

512 i‡(
now
 >
e
->
√xt_åy
)

513 ++
n_cuºít
;

516 
	`dmsg
 (
D_REL_DEBUG
, "ACKÑeliable_can_sendáctive=%d current=%d : %s",

517 
n_a˘ive
,

518 
n_cuºít
,

519 
	`ªlübÀ_¥öt_ids
 (
ªl
, &
gc
));

521 
	`gc_‰ì
 (&
gc
);

522  
n_cuºít
 > 0 && !
ªl
->
hﬁd
;

523 
	}
}

525 #ifde‡
EXPONENTIAL_BACKOFF


527 
time_t


528 
	$ªlübÀ_unique_ªåy
 (
ªlübÀ
 *
ªl
, 
time_t
 
ªåy
)

530 
i
;

531 
åue
)

533 
i
 = 0; i < 
ªl
->
size
; ++i)

535 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

536 i‡(
e
->
a˘ive
 &&É->
√xt_åy
 =
ªåy
)

537 
agaö
;

540 
agaö
:

541 ++
ªåy
;

543  
ªåy
;

544 
	}
}

548 
buf„r
 *

549 
	$ªlübÀ_£nd
 (
ªlübÀ
 *
ªl
, *
›code
)

551 
i
;

552 
ªlübÀ_íåy
 *
be°
 = 
NULL
;

553 c⁄° 
time_t
 
loˇl_now
 = 
now
;

555 
i
 = 0; i < 
ªl
->
size
; ++i)

557 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

558 i‡(
e
->
a˘ive
 && 
loˇl_now
 >e->
√xt_åy
)

560 i‡(!
be°
 || 
	`ªlübÀ_pid_mö
 (
e
->
∑ckë_id
, best->packet_id))

561 
be°
 = 
e
;

564 i‡(
be°
)

566 #ifde‡
EXPONENTIAL_BACKOFF


568 
be°
->
√xt_åy
 = 
	`ªlübÀ_unique_ªåy
 (
ªl
, 
loˇl_now
 + be°->
timeout
);

569 
be°
->
timeout
 *= 2;

572 
be°
->
√xt_åy
 = 
loˇl_now
 + be°->
timeout
;

574 *
›code
 = 
be°
->opcode;

575 
	`dmsg
 (
D_REL_DEBUG
, "ACKÑñübÀ_£nd ID " 
∑ckë_id_f‹m©
 " (size=%dÅo=%d)",

576 (
∑ckë_id_¥öt_ty≥
)
be°
->
∑ckë_id
, be°->
buf
.
Àn
,

577 ()(
be°
->
√xt_åy
 - 
loˇl_now
));

578  &
be°
->
buf
;

580  
NULL
;

581 
	}
}

585 
	$ªlübÀ_scheduÀ_now
 (
ªlübÀ
 *
ªl
)

587 
i
;

588 
	`dmsg
 (
D_REL_DEBUG
, "ACKÑeliable_schedule_now");

589 
ªl
->
hﬁd
 = 
Ál£
;

590 
i
 = 0; i < 
ªl
->
size
; ++i)

592 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

593 i‡(
e
->
a˘ive
)

595 
e
->
√xt_åy
 = 
now
;

596 
e
->
timeout
 = 
ªl
->
öôül_timeout
;

599 
	}
}

603 
öãrvÆ_t


604 
	$ªlübÀ_£nd_timeout
 (c⁄° 
ªlübÀ
 *
ªl
)

606 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

607 
öãrvÆ_t
 
ªt
 = 
BIG_TIMEOUT
;

608 
i
;

609 c⁄° 
time_t
 
loˇl_now
 = 
now
;

611 
i
 = 0; i < 
ªl
->
size
; ++i)

613 c⁄° 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

614 i‡(
e
->
a˘ive
)

616 i‡(
e
->
√xt_åy
 <
loˇl_now
)

618 
ªt
 = 0;

623 
ªt
 = 
	`mö_öt
 (ªt, 
e
->
√xt_åy
 - 
loˇl_now
);

628 
	`dmsg
 (
D_REL_DEBUG
, "ACKÑeliable_send_timeout %d %s",

629 (Ë
ªt
,

630 
	`ªlübÀ_¥öt_ids
 (
ªl
, &
gc
));

632 
	`gc_‰ì
 (&
gc
);

633  
ªt
;

634 
	}
}

641 
	$ªlübÀ_m¨k_a˘ive_öcomög
 (
ªlübÀ
 *
ªl
, 
buf„r
 *
buf
,

642 
∑ckë_id_ty≥
 
pid
, 
›code
)

644 
i
;

645 
i
 = 0; i < 
ªl
->
size
; ++i)

647 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

648 i‡(
buf
 =&
e
->buf)

650 
e
->
a˘ive
 = 
åue
;

653 
e
->
∑ckë_id
 = 
pid
;

656 
	`ASSERT
 (!
	`ªlübÀ_pid_mö
 (
pid
, 
ªl
->
∑ckë_id
));

658 
e
->
›code
 = opcode;

659 
e
->
√xt_åy
 = 0;

660 
e
->
timeout
 = 0;

661 
	`dmsg
 (
D_REL_DEBUG
, "ACK m¨ká˘ivêöcomög ID " 
∑ckë_id_f‹m©
, (
∑ckë_id_¥öt_ty≥
)
e
->
∑ckë_id
);

665 
	`ASSERT
 (0);

666 
	}
}

673 
	$ªlübÀ_m¨k_a˘ive_outgoög
 (
ªlübÀ
 *
ªl
, 
buf„r
 *
buf
, 
›code
)

675 
i
;

676 
i
 = 0; i < 
ªl
->
size
; ++i)

678 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

679 i‡(
buf
 =&
e
->buf)

683 
∑ckë_id_ty≥
 
√t_pid
;

684 
e
->
∑ckë_id
 = 
ªl
->packet_id++;

685 
√t_pid
 = 
	`ht⁄pid
 (
e
->
∑ckë_id
);

686 
	`ASSERT
 (
	`buf_wrôe_¥ïíd
 (
buf
, &
√t_pid
,  (net_pid)));

687 
e
->
a˘ive
 = 
åue
;

688 
e
->
›code
 = opcode;

689 
e
->
√xt_åy
 = 0;

690 
e
->
timeout
 = 
ªl
->
öôül_timeout
;

691 
	`dmsg
 (
D_REL_DEBUG
, "ACK m¨ká˘ivêoutgoög ID " 
∑ckë_id_f‹m©
, (
∑ckë_id_¥öt_ty≥
)
e
->
∑ckë_id
);

695 
	`ASSERT
 (0);

696 
	}
}

700 
	$ªlübÀ_m¨k_dñëed
 (
ªlübÀ
 *
ªl
, 
buf„r
 *
buf
, 
boﬁ
 
öc_pid
)

702 
i
;

703 
i
 = 0; i < 
ªl
->
size
; ++i)

705 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

706 i‡(
buf
 =&
e
->buf)

708 
e
->
a˘ive
 = 
Ál£
;

709 i‡(
öc_pid
)

710 
ªl
->
∑ckë_id
 = 
e
->packet_id + 1;

714 
	`ASSERT
 (0);

715 
	}
}

720 
	$ªlübÀ_ack_debug_¥öt
 (c⁄° 
ªlübÀ_ack
 *
ack
, *
desc
)

722 
i
;

724 
	`¥ötf
 ("********* såu˘ÑñübÀ_ack %s\n", 
desc
);

725 
i
 = 0; i < 
ack
->
Àn
; ++i)

727 
	`¥ötf
 (" %d: " 
∑ckë_id_f‹m©
 "\n", 
i
, (
∑ckë_id_¥öt_ty≥
Ë
ack
->
∑ckë_id
[i]);

729 
	}
}

732 
	$ªlübÀ_debug_¥öt
 (c⁄° 
ªlübÀ
 *
ªl
, *
desc
)

734 
i
;

735 
	`upd©e_time
 ();

737 
	`¥ötf
 ("********* såu˘ÑñübÀ %s\n", 
desc
);

738 
	`¥ötf
 (" inôül_timeout=%d\n", ()
ªl
->
öôül_timeout
);

739 
	`¥ötf
 ("Öackë_id=" 
∑ckë_id_f‹m©
 "\n", 
ªl
->
∑ckë_id
);

740 
	`¥ötf
 ("Çow=" 
time_f‹m©
 "\n", 
now
);

741 
i
 = 0; i < 
ªl
->
size
; ++i)

743 c⁄° 
ªlübÀ_íåy
 *
e
 = &
ªl
->
¨øy
[
i
];

744 i‡(
e
->
a˘ive
)

746 
	`¥ötf
 (" %d:Öackë_id=" 
∑ckë_id_f‹m©
 "Üí=%d", 
i
, 
e
->
∑ckë_id
,É->
buf
.
Àn
);

747 
	`¥ötf
 ("Çext_åy=" 
time_f‹m©
, 
e
->
√xt_åy
);

748 
	`¥ötf
 ("\n");

751 
	}
}

756 
	$dummy
(Ë{
	}
}

	@src/openvpn/reliable.h

32 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

34 #i‚de‡
RELIABLE_H


35 
	#RELIABLE_H


	)

37 
	~"basic.h
"

38 
	~"buf„r.h
"

39 
	~"∑ckë_id.h
"

40 
	~"£ssi⁄_id.h
"

41 
	~"mtu.h
"

47 
	#EXPONENTIAL_BACKOFF


	)

49 
	#RELIABLE_ACK_SIZE
 8

	)

54 
	#RELIABLE_CAPACITY
 8

	)

62 
	sªlübÀ_ack


64 
	mÀn
;

65 
∑ckë_id_ty≥
 
	m∑ckë_id
[
RELIABLE_ACK_SIZE
];

72 
	sªlübÀ_íåy


74 
boﬁ
 
	ma˘ive
;

75 
öãrvÆ_t
 
	mtimeout
;

76 
time_t
 
	m√xt_åy
;

77 
∑ckë_id_ty≥
 
	m∑ckë_id
;

78 
	m›code
;

79 
buf„r
 
	mbuf
;

86 
	sªlübÀ


88 
	msize
;

89 
öãrvÆ_t
 
	möôül_timeout
;

90 
∑ckë_id_ty≥
 
	m∑ckë_id
;

91 
	moff£t
;

92 
boﬁ
 
	mhﬁd
;

93 
ªlübÀ_íåy
 
	m¨øy
[
RELIABLE_CAPACITY
];

119 
boﬁ
 
ªlübÀ_ack_ªad
 (
ªlübÀ_ack
 *
ack
,

120 
buf„r
 *
buf
, c⁄° 
£ssi⁄_id
 *
sid
);

129 
ªlübÀ_£nd_purge
 (
ªlübÀ
 *
ªl
, 
ªlübÀ_ack
 *
ack
);

148 
ölöe
 
boﬁ


149 
	$ªlübÀ_ack_em±y
 (
ªlübÀ_ack
 *
ack
)

151  !
ack
->
Àn
;

152 
	}
}

172 
boﬁ
 
ªlübÀ_ack_wrôe
 (
ªlübÀ_ack
 *
ack
,

173 
buf„r
 *
buf
,

174 c⁄° 
£ssi⁄_id
 *
sid
, 
max
, 
boﬁ
 
¥ïíd
);

195 
ªlübÀ_öô
 (
ªlübÀ
 *
ªl
, 
buf_size
, 
off£t
, 
¨øy_size
, 
boﬁ
 
hﬁd
);

202 
ªlübÀ_‰ì
 (
ªlübÀ
 *
ªl
);

205 
ªlübÀ_ack_adju°_‰ame_∑ømëîs
 (
‰ame
* føme, 
max
);

224 
boﬁ
 
ªlübÀ_ˇn_gë
 (c⁄° 
ªlübÀ
 *
ªl
);

237 
boﬁ
 
ªlübÀ_nŸ_ª∂ay
 (c⁄° 
ªlübÀ
 *
ªl
, 
∑ckë_id_ty≥
 
id
);

261 
boﬁ
 
ªlübÀ_w⁄t_bªak_£quítülôy
 (c⁄° 
ªlübÀ
 *
ªl
, 
∑ckë_id_ty≥
 
id
);

273 
boﬁ
 
ªlübÀ_ack_ªad_∑ckë_id
 (
buf„r
 *
buf
, 
∑ckë_id_ty≥
 *
pid
);

286 
buf„r
 *
ªlübÀ_gë_buf
 (
ªlübÀ
 *
ªl
);

297 
ªlübÀ_m¨k_a˘ive_öcomög
 (
ªlübÀ
 *
ªl
, 
buf„r
 *
buf
,

298 
∑ckë_id_ty≥
 
pid
, 
›code
);

313 
boﬁ
 
ªlübÀ_ack_acknowÀdge_∑ckë_id
 (
ªlübÀ_ack
 *
ack
, 
∑ckë_id_ty≥
 
pid
);

332 
buf„r
 *
ªlübÀ_gë_buf_£quí˚d
 (
ªlübÀ
 *
ªl
);

342 
ªlübÀ_m¨k_dñëed
 (
ªlübÀ
 *
ªl
, 
buf„r
 *
buf
, 
boﬁ
 
öc_pid
);

363 
buf„r
 *
ªlübÀ_gë_buf_ouçut_£quí˚d
 (
ªlübÀ
 *
ªl
);

376 
ªlübÀ_m¨k_a˘ive_outgoög
 (
ªlübÀ
 *
ªl
, 
buf„r
 *
buf
, 
›code
);

397 
boﬁ
 
ªlübÀ_ˇn_£nd
 (c⁄° 
ªlübÀ
 *
ªl
);

416 
buf„r
 *
ªlübÀ_£nd
 (
ªlübÀ
 *
ªl
, *
›code
);

435 
boﬁ
 
ªlübÀ_em±y
 (c⁄° 
ªlübÀ
 *
ªl
);

448 
öãrvÆ_t
 
ªlübÀ_£nd_timeout
 (c⁄° 
ªlübÀ
 *
ªl
);

457 
ªlübÀ_scheduÀ_now
 (
ªlübÀ
 *
ªl
);

459 
ªlübÀ_debug_¥öt
 (c⁄° 
ªlübÀ
 *
ªl
, *
desc
);

462 
ölöe
 

463 
	$ªlübÀ_£t_timeout
 (
ªlübÀ
 *
ªl
, 
öãrvÆ_t
 
timeout
)

465 
ªl
->
öôül_timeout
 = 
timeout
;

466 
	}
}

469 c⁄° *
ªlübÀ_ack_¥öt
 (
buf„r
 *
buf
, 
boﬁ
 
vîbo£
, 
gc_¨ía
 *
gc
);

471 
ªlübÀ_ack_debug_¥öt
 (c⁄° 
ªlübÀ_ack
 *
ack
, *
desc
);

	@src/openvpn/route.c

29 #ifde‡
HAVE_CONFIG_H


30 
	~"c⁄fig.h
"

31 #ñi‡
deföed
(
_MSC_VER
)

32 
	~"c⁄fig-msvc.h
"

35 
	~"syshód.h
"

37 
	~"comm⁄.h
"

38 
	~"îr‹.h
"

39 
	~"rouã.h
"

40 
	~"misc.h
"

41 
	~"sockë.h
"

42 
	~"m™age.h
"

43 
	~"wö32.h
"

44 
	~"›ti⁄s.h
"

46 
	~"memdbg.h
"

48 #ifde‡
WIN32


49 
	#METRIC_NOT_USED
 ((
DWORD
)-1)

	)

52 
dñëe_rouã
 (
rouã_ùv4
 *
r
, c⁄° 
tu¡≠
 *
â
, 
Êags
, c⁄° 
rouã_g©eway_öfo
 *
rgi
, c⁄° 
ív_£t
 *
es
);

54 
gë_by∑ss_addªs£s
 (
rouã_by∑ss
 *
rb
, c⁄° 
Êags
);

56 #ifde‡
ENABLE_DEBUG


59 
	$¥öt_by∑ss_addªs£s
 (c⁄° 
rouã_by∑ss
 *
rb
)

61 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

62 
i
;

63 
i
 = 0; i < 
rb
->
n_by∑ss
; ++i)

65 
	`msg
 (
D_ROUTE
, "ROUTE: bypass_host_route[%d]=%s",

66 
i
,

67 
	`¥öt_ö_addr_t
 (
rb
->
by∑ss
[
i
], 0, &
gc
));

69 
	`gc_‰ì
 (&
gc
);

70 
	}
}

74 
boﬁ


75 
	$add_by∑ss_addªss
 (
rouã_by∑ss
 *
rb
, c⁄° 
ö_addr_t
 
a
)

77 
i
;

78 
i
 = 0; i < 
rb
->
n_by∑ss
; ++i)

80 i‡(
a
 =
rb
->
by∑ss
[
i
])

81  
åue
;

83 i‡(
rb
->
n_by∑ss
 < 
N_ROUTE_BYPASS
)

85 
rb
->
by∑ss
[rb->
n_by∑ss
++] = 
a
;

86  
åue
;

90  
Ál£
;

92 
	}
}

94 
rouã_›ti⁄_li°
 *

95 
	$√w_rouã_›ti⁄_li°
 (c⁄° 
max_rouãs
, 
gc_¨ía
 *
a
)

97 
rouã_›ti⁄_li°
 *
ªt
;

98 
	`ALLOC_VAR_ARRAY_CLEAR_GC
 (
ªt
, 
rouã_›ti⁄_li°
, 
rouã_›ti⁄
, 
max_rouãs
, 
a
);

99 
ªt
->
ˇ∑côy
 = 
max_rouãs
;

100  
ªt
;

101 
	}
}

103 
rouã_ùv6_›ti⁄_li°
 *

104 
	$√w_rouã_ùv6_›ti⁄_li°
 (c⁄° 
max_rouãs
, 
gc_¨ía
 *
a
)

106 
rouã_ùv6_›ti⁄_li°
 *
ªt
;

107 
	`ALLOC_VAR_ARRAY_CLEAR_GC
 (
ªt
, 
rouã_ùv6_›ti⁄_li°
, 
rouã_ùv6_›ti⁄
, 
max_rouãs
, 
a
);

108 
ªt
->
ˇ∑côy
 = 
max_rouãs
;

109  
ªt
;

110 
	}
}

112 
rouã_›ti⁄_li°
 *

113 
	$˛⁄e_rouã_›ti⁄_li°
 (c⁄° 
rouã_›ti⁄_li°
 *
§c
, 
gc_¨ía
 *
a
)

115 c⁄° 
size_t
 
æ_size
 = 
	`¨øy_mu…_ß„
 ((
rouã_›ti⁄
), 
§c
->
ˇ∑côy
, (
rouã_›ti⁄_li°
));

116 
rouã_›ti⁄_li°
 *
ªt
 = 
	`gc_mÆloc
 (
æ_size
, 
Ál£
, 
a
);

117 
	`mem˝y
 (
ªt
, 
§c
, 
æ_size
);

118  
ªt
;

119 
	}
}

121 
rouã_ùv6_›ti⁄_li°
 *

122 
	$˛⁄e_rouã_ùv6_›ti⁄_li°
 (c⁄° 
rouã_ùv6_›ti⁄_li°
 *
§c
, 
gc_¨ía
 *
a
)

124 c⁄° 
size_t
 
æ_size
 = 
	`¨øy_mu…_ß„
 ((
rouã_ùv6_›ti⁄
), 
§c
->
ˇ∑côy
, (
rouã_ùv6_›ti⁄_li°
));

125 
rouã_ùv6_›ti⁄_li°
 *
ªt
 = 
	`gc_mÆloc
 (
æ_size
, 
Ál£
, 
a
);

126 
	`mem˝y
 (
ªt
, 
§c
, 
æ_size
);

127  
ªt
;

128 
	}
}

131 
	$c›y_rouã_›ti⁄_li°
 (
rouã_›ti⁄_li°
 *
de°
, c⁄° rouã_›ti⁄_li° *
§c
)

133 c⁄° 
size_t
 
§c_size
 = 
	`¨øy_mu…_ß„
 ((
rouã_›ti⁄
), 
§c
->
ˇ∑côy
, (
rouã_›ti⁄_li°
));

134 i‡(
§c
->
ˇ∑côy
 > 
de°
->capacity)

135 
	`msg
 (
M_FATAL
, 
PACKAGE_NAME
 " ROUTE: (c›yËnumbî o‡rouã o±i⁄†ö sr¯(%dËi†gª©îÅh™ÑouãÜi° c≠acôy i¿de° (%d)", 
§c
->
ˇ∑côy
, 
de°
->capacity);

136 
	`mem˝y
 (
de°
, 
§c
, 
§c_size
);

137 
	}
}

140 
	$c›y_rouã_ùv6_›ti⁄_li°
 (
rouã_ùv6_›ti⁄_li°
 *
de°
,

141 c⁄° 
rouã_ùv6_›ti⁄_li°
 *
§c
)

143 c⁄° 
size_t
 
§c_size
 = 
	`¨øy_mu…_ß„
 ((
rouã_ùv6_›ti⁄
), 
§c
->
ˇ∑côy
, (
rouã_ùv6_›ti⁄_li°
));

144 i‡(
§c
->
ˇ∑côy
 > 
de°
->capacity)

145 
	`msg
 (
M_FATAL
, 
PACKAGE_NAME
 " ROUTE: (c›yËnumbî o‡rouã o±i⁄†ö sr¯(%dËi†gª©îÅh™ÑouãÜi° c≠acôy i¿de° (%d)", 
§c
->
ˇ∑côy
, 
de°
->capacity);

146 
	`mem˝y
 (
de°
, 
§c
, 
§c_size
);

147 
	}
}

149 
rouã_li°
 *

150 
	$√w_rouã_li°
 (c⁄° 
max_rouãs
, 
gc_¨ía
 *
a
)

152 
rouã_li°
 *
ªt
;

153 
	`ALLOC_VAR_ARRAY_CLEAR_GC
 (
ªt
, 
rouã_li°
, 
rouã_ùv4
, 
max_rouãs
, 
a
);

154 
ªt
->
ˇ∑côy
 = 
max_rouãs
;

155  
ªt
;

156 
	}
}

158 
rouã_ùv6_li°
 *

159 
	$√w_rouã_ùv6_li°
 (c⁄° 
max_rouãs
, 
gc_¨ía
 *
a
)

161 
rouã_ùv6_li°
 *
ªt
;

162 
	`ALLOC_VAR_ARRAY_CLEAR_GC
 (
ªt
, 
rouã_ùv6_li°
, 
rouã_ùv6
, 
max_rouãs
, 
a
);

163 
ªt
->
ˇ∑côy
 = 
max_rouãs
;

164  
ªt
;

165 
	}
}

168 
	$rouã_°rög
 (c⁄° 
rouã_ùv4
 *
r
, 
gc_¨ía
 *
gc
)

170 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

171 
	`buf_¥ötf
 (&
out
, "ROUTEÇetwork %sÇetmask %s gateway %s",

172 
	`¥öt_ö_addr_t
 (
r
->
√tw‹k
, 0, 
gc
),

173 
	`¥öt_ö_addr_t
 (
r
->
√tmask
, 0, 
gc
),

174 
	`¥öt_ö_addr_t
 (
r
->
g©eway
, 0, 
gc
)

176 i‡(
r
->
Êags
 & 
RT_METRIC_DEFINED
)

177 
	`buf_¥ötf
 (&
out
, " mëri¯%d", 
r
->
mëric
);

178  
	`BSTR
 (&
out
);

179 
	}
}

181 
boﬁ


182 
	$is_rouã_∑rm_deföed
 (c⁄° *
∑rm
)

184 i‡(!
∑rm
)

185  
Ál£
;

186 i‡(!
	`°rcmp
 (
∑rm
, "default"))

187  
Ál£
;

188  
åue
;

189 
	}
}

192 
	$£ãnv_rouã_addr
 (
ív_£t
 *
es
, c⁄° *
key
, c⁄° 
ö_addr_t
 
addr
, 
i
)

194 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

195 
buf„r
 
«me
 = 
	`Æloc_buf_gc
 (256, &
gc
);

196 i‡(
i
 >= 0)

197 
	`buf_¥ötf
 (&
«me
, "rouã_%s_%d", 
key
, 
i
);

199 
	`buf_¥ötf
 (&
«me
, "rouã_%s", 
key
);

200 
	`£ãnv_°r
 (
es
, 
	`BSTR
 (&
«me
), 
	`¥öt_ö_addr_t
 (
addr
, 0, &
gc
));

201 
	`gc_‰ì
 (&
gc
);

202 
	}
}

204 
boﬁ


205 
	$gë_•ecül_addr
 (c⁄° 
rouã_li°
 *
æ
,

206 c⁄° *
°rög
,

207 
ö_addr_t
 *
out
,

208 
boﬁ
 *
°©us
)

210 i‡(
°©us
)

211 *
°©us
 = 
åue
;

212 i‡(!
	`°rcmp
 (
°rög
, "vpn_gateway"))

214 i‡(
æ
)

216 i‡(
æ
->
•ec
.
Êags
 & 
RTSA_REMOTE_ENDPOINT
)

217 *
out
 = 
æ
->
•ec
.
ªmŸe_ídpoöt
;

220 
	`msg
 (
M_INFO
, 
PACKAGE_NAME
 " ROUTE: vpn_gateway undefined");

221 i‡(
°©us
)

222 *
°©us
 = 
Ál£
;

225  
åue
;

227 i‡(!
	`°rcmp
 (
°rög
, "net_gateway"))

229 i‡(
æ
)

231 i‡(
æ
->
rgi
.
Êags
 & 
RGI_ADDR_DEFINED
)

232 *
out
 = 
æ
->
rgi
.
g©eway
.
addr
;

235 
	`msg
 (
M_INFO
, 
PACKAGE_NAME
 " ROUTE:Çet_gateway undefined -- unableÅo get default gateway from system");

236 i‡(
°©us
)

237 *
°©us
 = 
Ál£
;

240  
åue
;

242 i‡(!
	`°rcmp
 (
°rög
, "remote_host"))

244 i‡(
æ
)

246 i‡(
æ
->
•ec
.
Êags
 & 
RTSA_REMOTE_HOST
)

247 *
out
 = 
æ
->
•ec
.
ªmŸe_ho°
;

250 
	`msg
 (
M_INFO
, 
PACKAGE_NAME
 " ROUTE:Ñemote_host undefined");

251 i‡(
°©us
)

252 *
°©us
 = 
Ál£
;

255  
åue
;

257  
Ál£
;

258 
	}
}

260 
boﬁ


261 
	$is_•ecül_addr
 (c⁄° *
addr_°r
)

263 i‡(
addr_°r
)

264  
	`gë_•ecül_addr
 (
NULL
, 
addr_°r
, NULL, NULL);

266  
Ál£
;

267 
	}
}

269 
boﬁ


270 
	$öô_rouã
 (
rouã_ùv4
 *
r
,

271 
addröfo
 **
√tw‹k_li°
,

272 c⁄° 
rouã_›ti⁄
 *
ro
,

273 c⁄° 
rouã_li°
 *
æ
)

275 c⁄° 
ö_addr_t
 
deÁu…_√tmask
 = 
IPV4_NETMASK_HOST
;

276 
boﬁ
 
°©us
;

277 
ªt
;

278 
ö_addr
 
•ecül
;

280 
	`CLEAR
 (*
r
);

281 
r
->
›ti⁄
 = 
ro
;

285 i‡(!
	`is_rouã_∑rm_deföed
 (
ro
->
√tw‹k
))

287 
Áû
;

294 if(
	`gë_•ecül_addr
 (
æ
, 
ro
->
√tw‹k
, &
•ecül
.
s_addr
, &
°©us
))

296 
•ecül
.
s_addr
 = 
	`ht⁄l
(special.s_addr);

297 
ªt
 = 
	`›ív≤_gëaddröfo
(0, 
	`öë_¡ﬂ
(
•ecül
), 0, 
NULL
,

298 
AF_INET
, 
√tw‹k_li°
);

301 
ªt
 = 
	`›ív≤_gëaddröfo
(
GETADDR_RESOLVE
 | 
GETADDR_WARN_ON_SIGNAL
,

302 
ro
->
√tw‹k
, 0, 
NULL
, 
AF_INET
, 
√tw‹k_li°
);

304 
°©us
 = (
ªt
 == 0);

306 i‡(!
°©us
)

307 
Áû
;

311 i‡(
	`is_rouã_∑rm_deföed
 (
ro
->
√tmask
))

313 
r
->
√tmask
 = 
	`gëaddr
 (

314 
GETADDR_HOST_ORDER


315 | 
GETADDR_WARN_ON_SIGNAL
,

316 
ro
->
√tmask
,

318 &
°©us
,

319 
NULL
);

320 i‡(!
°©us
)

321 
Áû
;

324 
r
->
√tmask
 = 
deÁu…_√tmask
;

328 i‡(
	`is_rouã_∑rm_deföed
 (
ro
->
g©eway
))

330 i‡(!
	`gë_•ecül_addr
 (
æ
, 
ro
->
g©eway
, &
r
->g©eway, &
°©us
))

332 
r
->
g©eway
 = 
	`gëaddr
 (

333 
GETADDR_RESOLVE


334 | 
GETADDR_HOST_ORDER


335 | 
GETADDR_WARN_ON_SIGNAL
,

336 
ro
->
g©eway
,

338 &
°©us
,

339 
NULL
);

341 i‡(!
°©us
)

342 
Áû
;

346 i‡(
æ
->
•ec
.
Êags
 & 
RTSA_REMOTE_ENDPOINT
)

347 
r
->
g©eway
 = 
æ
->
•ec
.
ªmŸe_ídpoöt
;

350 
	`msg
 (
M_WARN
, 
PACKAGE_NAME
 " ROUTE: " PACKAGE_NAME "Çeedsá gatewayÖarameter forá --route optionándÇo default was specified byÉither --route-gateway or --ifconfig options");

351 
Áû
;

357 
r
->
mëric
 = 0;

358 i‡(
	`is_rouã_∑rm_deföed
 (
ro
->
mëric
))

360 
r
->
mëric
 = 
	`©oi
 (
ro
->metric);

361 i‡(
r
->
mëric
 < 0)

363 
	`msg
 (
M_WARN
, 
PACKAGE_NAME
 " ROUTE:Ñoute metric forÇetwork %s (%s) must be >= 0",

364 
ro
->
√tw‹k
,

365 
ro
->
mëric
);

366 
Áû
;

368 
r
->
Êags
 |
RT_METRIC_DEFINED
;

370 i‡(
æ
->
•ec
.
Êags
 & 
RTSA_DEFAULT_METRIC
)

372 
r
->
mëric
 = 
æ
->
•ec
.
deÁu…_mëric
;

373 
r
->
Êags
 |
RT_METRIC_DEFINED
;

376 
r
->
Êags
 |
RT_DEFINED
;

378  
åue
;

380 
Áû
:

381 
	`msg
 (
M_WARN
, 
PACKAGE_NAME
 " ROUTE: failedÅoÖarse/resolveÑoute for host/network: %s",

382 
ro
->
√tw‹k
);

383  
Ál£
;

384 
	}
}

386 
boﬁ


387 
	$öô_rouã_ùv6
 (
rouã_ùv6
 *
r6
,

388 c⁄° 
rouã_ùv6_›ti⁄
 *
r6o
,

389 c⁄° 
rouã_ùv6_li°
 *
æ6
 )

391 
r6
->
deföed
 = 
Ál£
;

393 i‡–!
	`gë_ùv6_addr
–
r6o
->
¥efix
, &
r6
->
√tw‹k
, &r6->
√tbôs
, 
NULL
, 
M_WARN
 ))

394 
Áû
;

397 i‡(
	`is_rouã_∑rm_deföed
 (
r6o
->
g©eway
))

399 i‡–
	`öë_±⁄
–
AF_INET6
, 
r6o
->
g©eway
, &
r6
->gateway ) != 1 )

401 
	`msg
–
M_WARN
, 
PACKAGE_NAME
 "ROUTE6: c™nŸÖ¨£ g©eway s≥¯'%s'", 
r6o
->
g©eway
 );

404 i‡(
æ6
->
ªmŸe_ídpoöt_deföed
)

406 
r6
->
g©eway
 = 
æ6
->
ªmŸe_ídpoöt_ùv6
;

410 
	`msg
 (
M_WARN
, 
PACKAGE_NAME
 " ROUTE6: " PACKAGE_NAME "Çeedsá gatewayÖarameter forá --route-ipv6 optionándÇo default was specified byÉither --route-ipv6-gateway or --ifconfig-ipv6 options");

411 
Áû
;

416 
r6
->
mëric_deföed
 = 
Ál£
;

417 
r6
->
mëric
 = -1;

418 i‡(
	`is_rouã_∑rm_deföed
 (
r6o
->
mëric
))

420 
r6
->
mëric
 = 
	`©oi
 (
r6o
->metric);

421 i‡(
r6
->
mëric
 < 0)

423 
	`msg
 (
M_WARN
, 
PACKAGE_NAME
 " ROUTE:Ñoute metric forÇetwork %s (%s) must be >= 0",

424 
r6o
->
¥efix
,

425 
r6o
->
mëric
);

426 
Áû
;

428 
r6
->
mëric_deföed
 = 
åue
;

430 i‡(
æ6
->
deÁu…_mëric_deföed
)

432 
r6
->
mëric
 = 
æ6
->
deÁu…_mëric
;

433 
r6
->
mëric_deföed
 = 
åue
;

436 
r6
->
deföed
 = 
åue
;

438  
åue
;

440 
Áû
:

441 
	`msg
 (
M_WARN
, 
PACKAGE_NAME
 " ROUTE: failedÅoÖarse/resolveÑoute for host/network: %s",

442 
r6o
->
¥efix
);

443 
r6
->
deföed
 = 
Ál£
;

444  
Ál£
;

445 
	}
}

448 
	$add_rouã_to_›ti⁄_li°
 (
rouã_›ti⁄_li°
 *
l
,

449 c⁄° *
√tw‹k
,

450 c⁄° *
√tmask
,

451 c⁄° *
g©eway
,

452 c⁄° *
mëric
)

454 
rouã_›ti⁄
 *
ro
;

455 i‡(
l
->
n
 >l->
ˇ∑côy
)

456 
	`msg
 (
M_FATAL
, 
PACKAGE_NAME
 " ROUTE: cannotádd moreÅhan %dÑoutes --Ölease increaseÅhe max-routes option inÅhe client configuration file",

457 
l
->
ˇ∑côy
);

458 
ro
 = &
l
->
rouãs
[l->
n
];

459 
ro
->
√tw‹k
 =Çetwork;

460 
ro
->
√tmask
 =Çetmask;

461 
ro
->
g©eway
 = gateway;

462 
ro
->
mëric
 = metric;

463 ++
l
->
n
;

464 
	}
}

467 
	$add_rouã_ùv6_to_›ti⁄_li°
 (
rouã_ùv6_›ti⁄_li°
 *
l
,

468 c⁄° *
¥efix
,

469 c⁄° *
g©eway
,

470 c⁄° *
mëric
)

472 
rouã_ùv6_›ti⁄
 *
ro
;

473 i‡(
l
->
n
 >l->
ˇ∑côy
)

474 
	`msg
 (
M_FATAL
, 
PACKAGE_NAME
 " ROUTE: cannotádd moreÅhan %d IPv6Ñoutes --Ölease increaseÅhe max-routes option inÅhe client configuration file",

475 
l
->
ˇ∑côy
);

476 
ro
 = &
l
->
rouãs_ùv6
[l->
n
];

477 
ro
->
¥efix
 =Örefix;

478 
ro
->
g©eway
 = gateway;

479 
ro
->
mëric
 = metric;

480 ++
l
->
n
;

481 
	}
}

484 
	$˛ór_rouã_li°
 (
rouã_li°
 *
æ
)

486 c⁄° 
ˇ∑côy
 = 
æ
->capacity;

487 c⁄° 
size_t
 
æ_size
 = 
	`¨øy_mu…_ß„
 ((
rouã_ùv4
), 
ˇ∑côy
, (
rouã_li°
));

488 
	`mem£t
(
æ
, 0, 
æ_size
);

489 
æ
->
ˇ∑côy
 = capacity;

490 
	}
}

493 
	$˛ór_rouã_ùv6_li°
 (
rouã_ùv6_li°
 *
æ6
)

495 c⁄° 
ˇ∑côy
 = 
æ6
->capacity;

496 c⁄° 
size_t
 
æ6_size
 = 
	`¨øy_mu…_ß„
 ((
rouã_ùv6
), 
ˇ∑côy
, (
rouã_ùv6_li°
));

497 
	`mem£t
(
æ6
, 0, 
æ6_size
);

498 
æ6
->
ˇ∑côy
 = capacity;

499 
	}
}

502 
	$rouã_li°_add_v≤_g©eway
 (
rouã_li°
 *
æ
,

503 
ív_£t
 *
es
,

504 c⁄° 
ö_addr_t
 
addr
)

506 
	`ASSERT
(
æ
);

507 
æ
->
•ec
.
ªmŸe_ídpoöt
 = 
addr
;

508 
æ
->
•ec
.
Êags
 |
RTSA_REMOTE_ENDPOINT
;

509 
	`£ãnv_rouã_addr
 (
es
, "v≤_g©eway", 
æ
->
•ec
.
ªmŸe_ídpoöt
, -1);

510 
	}
}

513 
	$add_block_loˇl_ôem
 (
rouã_li°
 *
æ
,

514 c⁄° 
rouã_g©eway_addªss
 *
g©eway
,

515 
ö_addr_t
 
èrgë
)

517 c⁄° 
rgi_√eded
 = (
RGI_ADDR_DEFINED
|
RGI_NETMASK_DEFINED
);

518 i‡((
æ
->
rgi
.
Êags
 & 
rgi_√eded
) ==Ñgi_needed

519 && 
æ
->
rgi
.
g©eway
.
√tmask
 < 0xFFFFFFFF

520 && (
æ
->
n
)+2 <æ->
ˇ∑côy
)

522 
rouã_ùv4
 
r
;

523 
l2
;

526 
	`CLEAR
(
r
);

527 
r
.
Êags
 = 
RT_DEFINED
;

528 
r
.
g©eway
 = 
èrgë
;

529 
r
.
√tw‹k
 = 
g©eway
->
addr
 & g©eway->
√tmask
;

530 
l2
 = ((~
g©eway
->
√tmask
)+1)>>1;

531 
r
.
√tmask
 = ~(
l2
-1);

532 
æ
->
rouãs
[æ->
n
++] = 
r
;

533 
r
.
√tw‹k
 +
l2
;

534 
æ
->
rouãs
[æ->
n
++] = 
r
;

536 
	}
}

539 
	$add_block_loˇl
 (
rouã_li°
 *
æ
)

541 c⁄° 
rgi_√eded
 = (
RGI_ADDR_DEFINED
|
RGI_NETMASK_DEFINED
);

542 i‡((
æ
->
Êags
 & 
RG_BLOCK_LOCAL
)

543 && (
æ
->
rgi
.
Êags
 & 
rgi_√eded
) ==Ñgi_needed

544 && (
æ
->
•ec
.
Êags
 & 
RTSA_REMOTE_ENDPOINT
)

545 && 
æ
->
•ec
.
ªmŸe_ho°_loˇl
 !
TLA_LOCAL
)

547 
size_t
 
i
;

550 
	`add_by∑ss_addªss
 (&
æ
->
•ec
.
by∑ss
,Ñl->
rgi
.
g©eway
.
addr
);

553 
	`add_block_loˇl_ôem
 (
æ
, &æ->
rgi
.
g©eway
,Ñl->
•ec
.
ªmŸe_ídpoöt
);

556 
i
 = 0; i < 
æ
->
rgi
.
n_addrs
; ++i)

558 c⁄° 
rouã_g©eway_addªss
 *
gwa
 = &
æ
->
rgi
.
addrs
[
i
];

560 i‡(!((
æ
->
rgi
.
g©eway
.
addr
 &Ñl->rgi.g©eway.
√tmask
Ë=(
gwa
->addr & gwa->netmask)

561 && 
æ
->
rgi
.
g©eway
.
√tmask
 =
gwa
->netmask))

562 
	`add_block_loˇl_ôem
 (
æ
, 
gwa
,Ñl->
•ec
.
ªmŸe_ídpoöt
);

565 
	}
}

567 
boﬁ


568 
	$öô_rouã_li°
 (
rouã_li°
 *
æ
,

569 c⁄° 
rouã_›ti⁄_li°
 *
›t
,

570 c⁄° *
ªmŸe_ídpoöt
,

571 
deÁu…_mëric
,

572 
ö_addr_t
 
ªmŸe_ho°
,

573 
ív_£t
 *
es
)

575 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

576 
boﬁ
 
ªt
 = 
åue
;

578 
	`˛ór_rouã_li°
 (
æ
);

580 
æ
->
Êags
 = 
›t
->flags;

582 i‡(
ªmŸe_ho°
)

584 
æ
->
•ec
.
ªmŸe_ho°
 =Ñemote_host;

585 
æ
->
•ec
.
Êags
 |
RTSA_REMOTE_HOST
;

588 i‡(
deÁu…_mëric
)

590 
æ
->
•ec
.
deÁu…_mëric
 = default_metric;

591 
æ
->
•ec
.
Êags
 |
RTSA_DEFAULT_METRIC
;

594 
	`gë_deÁu…_g©eway
 (&
æ
->
rgi
);

595 i‡(
æ
->
rgi
.
Êags
 & 
RGI_ADDR_DEFINED
)

597 
	`£ãnv_rouã_addr
 (
es
, "√t_g©eway", 
æ
->
rgi
.
g©eway
.
addr
, -1);

598 #i‡
	`deföed
(
ENABLE_DEBUG
Ë&& !deföed(
ENABLE_SMALL
)

599 
	`¥öt_deÁu…_g©eway
 (
D_ROUTE
, &
æ
->
rgi
);

604 
	`dmsg
 (
D_ROUTE
, "ROUTE: default_gateway=UNDEF");

607 i‡(
æ
->
•ec
.
Êags
 & 
RTSA_REMOTE_HOST
)

608 
æ
->
•ec
.
ªmŸe_ho°_loˇl
 = 
	`ã°_loˇl_addr
 (
ªmŸe_ho°
, &æ->
rgi
);

610 i‡(
	`is_rouã_∑rm_deföed
 (
ªmŸe_ídpoöt
))

612 
boﬁ
 
deföed
 = 
Ál£
;

613 
æ
->
•ec
.
ªmŸe_ídpoöt
 = 
	`gëaddr
 (

614 
GETADDR_RESOLVE


615 | 
GETADDR_HOST_ORDER


616 | 
GETADDR_WARN_ON_SIGNAL
,

617 
ªmŸe_ídpoöt
,

619 &
deföed
,

620 
NULL
);

622 i‡(
deföed
)

624 
	`£ãnv_rouã_addr
 (
es
, "v≤_g©eway", 
æ
->
•ec
.
ªmŸe_ídpoöt
, -1);

625 
æ
->
•ec
.
Êags
 |
RTSA_REMOTE_ENDPOINT
;

629 
	`msg
 (
M_WARN
, 
PACKAGE_NAME
 " ROUTE: failedÅoÖarse/resolve default gateway: %s",

630 
ªmŸe_ídpoöt
);

631 
ªt
 = 
Ál£
;

635 i‡(
æ
->
Êags
 & 
RG_ENABLE
)

637 
	`add_block_loˇl
 (
æ
);

638 
	`gë_by∑ss_addªs£s
 (&
æ
->
•ec
.
by∑ss
,Ñl->
Êags
);

639 #ifde‡
ENABLE_DEBUG


640 
	`¥öt_by∑ss_addªs£s
 (&
æ
->
•ec
.
by∑ss
);

646 
i
 = 0;

647 
j
 = 
æ
->
n
;

648 
boﬁ
 
w¨√d
 = 
Ál£
;

649 
i
 = 0; i < 
›t
->
n
; ++i)

651 
addröfo
* 
√éi°
;

652 
rouã_ùv4
 
r
;

654 i‡(!
	`öô_rouã
 (&
r
,

655 &
√éi°
,

656 &
›t
->
rouãs
[
i
],

657 
æ
))

658 
ªt
 = 
Ál£
;

661 
addröfo
* 
cuªÀ
;

662 
cuªÀ
 = 
√éi°
; cuªÀ; cuªÀ = cuªÀ->
ai_√xt
)

664 i‡(
j
 < 
æ
->
ˇ∑côy
)

666 
r
.
√tw‹k
 = 
	`¡ohl
(((
sockaddr_ö
*)(
cuªÀ
)->
ai_addr
)->
sö_addr
.
s_addr
);

667 
æ
->
rouãs
[
j
++] = 
r
;

671 i‡(!
w¨√d
)

673 
	`msg
 (
M_WARN
, 
PACKAGE_NAME
 " ROUTE:Ñouã†dr›≥d beˇu£Çumbî o‡ex∑ndedÑouã†i†gª©îÅh™ÑouãÜi° c≠acôy (%d)", 
æ
->
ˇ∑côy
);

674 
w¨√d
 = 
åue
;

678 
	`‰ìaddröfo
(
√éi°
);

681 
æ
->
n
 = 
j
;

684 
	`gc_‰ì
 (&
gc
);

685  
ªt
;

686 
	}
}

688 
boﬁ


689 
	$öô_rouã_ùv6_li°
 (
rouã_ùv6_li°
 *
æ6
,

690 c⁄° 
rouã_ùv6_›ti⁄_li°
 *
›t6
,

691 c⁄° *
ªmŸe_ídpoöt
,

692 
deÁu…_mëric
,

693 
ív_£t
 *
es
)

695 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

696 
boﬁ
 
ªt
 = 
åue
;

698 
	`˛ór_rouã_ùv6_li°
 (
æ6
);

700 
æ6
->
Êags
 = 
›t6
->flags;

702 i‡(
deÁu…_mëric
 >= 0 )

704 
æ6
->
deÁu…_mëric
 = default_metric;

705 
æ6
->
deÁu…_mëric_deföed
 = 
åue
;

712 
	`dmsg
 (
D_ROUTE
, "ROUTE6: default_gateway=UNDEF");

715 i‡–
	`is_rouã_∑rm_deföed
–
ªmŸe_ídpoöt
 ))

717 i‡–
	`öë_±⁄
–
AF_INET6
, 
ªmŸe_ídpoöt
,

718 &
æ6
->
ªmŸe_ídpoöt_ùv6
) == 1 )

720 
æ6
->
ªmŸe_ídpoöt_deföed
 = 
åue
;

724 
	`msg
 (
M_WARN
, 
PACKAGE_NAME
 " ROUTE: faûedÅÿ∑r£/ªsﬁvêdeÁu… g©eway: %s", 
ªmŸe_ídpoöt
);

725 
ªt
 = 
Ál£
;

729 
æ6
->
ªmŸe_ídpoöt_deföed
 = 
Ál£
;

732 i‡(!(
›t6
->
n
 >0 && o±6->¿<
æ6
->
ˇ∑côy
))

733 
	`msg
 (
M_FATAL
, 
PACKAGE_NAME
 " ROUTE6: (öôËnumbî o‡rouã o±i⁄†(%dËi†gª©îÅh™ÑouãÜi° c≠acôy (%d)", 
›t6
->
n
, 
æ6
->
ˇ∑côy
);

737 
i
, 
j
 = 0;

738 
i
 = 0; i < 
›t6
->
n
; ++i)

740 i‡(!
	`öô_rouã_ùv6
 (&
æ6
->
rouãs_ùv6
[
j
],

741 &
›t6
->
rouãs_ùv6
[
i
],

742 
æ6
 ))

743 
ªt
 = 
Ál£
;

745 ++
j
;

747 
æ6
->
n
 = 
j
;

750 
	`gc_‰ì
 (&
gc
);

751  
ªt
;

752 
	}
}

755 
	$add_rouã3
 (
ö_addr_t
 
√tw‹k
,

756 
ö_addr_t
 
√tmask
,

757 
ö_addr_t
 
g©eway
,

758 c⁄° 
tu¡≠
 *
â
,

759 
Êags
,

760 c⁄° 
rouã_g©eway_öfo
 *
rgi
,

761 c⁄° 
ív_£t
 *
es
)

763 
rouã_ùv4
 
r
;

764 
	`CLEAR
 (
r
);

765 
r
.
Êags
 = 
RT_DEFINED
;

766 
r
.
√tw‹k
 =Çetwork;

767 
r
.
√tmask
 =Çetmask;

768 
r
.
g©eway
 = gateway;

769 
	`add_rouã
 (&
r
, 
â
, 
Êags
, 
rgi
, 
es
);

770 
	}
}

773 
	$dñ_rouã3
 (
ö_addr_t
 
√tw‹k
,

774 
ö_addr_t
 
√tmask
,

775 
ö_addr_t
 
g©eway
,

776 c⁄° 
tu¡≠
 *
â
,

777 
Êags
,

778 c⁄° 
rouã_g©eway_öfo
 *
rgi
,

779 c⁄° 
ív_£t
 *
es
)

781 
rouã_ùv4
 
r
;

782 
	`CLEAR
 (
r
);

783 
r
.
Êags
 = 
RT_DEFINED
|
RT_ADDED
;

784 
r
.
√tw‹k
 =Çetwork;

785 
r
.
√tmask
 =Çetmask;

786 
r
.
g©eway
 = gateway;

787 
	`dñëe_rouã
 (&
r
, 
â
, 
Êags
, 
rgi
, 
es
);

788 
	}
}

791 
	$add_by∑ss_rouãs
 (
rouã_by∑ss
 *
rb
,

792 
ö_addr_t
 
g©eway
,

793 c⁄° 
tu¡≠
 *
â
,

794 
Êags
,

795 c⁄° 
rouã_g©eway_öfo
 *
rgi
,

796 c⁄° 
ív_£t
 *
es
)

798 
i
;

799 
i
 = 0; i < 
rb
->
n_by∑ss
; ++i)

801 i‡(
rb
->
by∑ss
[
i
])

802 
	`add_rouã3
 (
rb
->
by∑ss
[
i
],

803 
IPV4_NETMASK_HOST
,

804 
g©eway
,

805 
â
,

806 
Êags
 | 
ROUTE_REF_GW
,

807 
rgi
,

808 
es
);

810 
	}
}

813 
	$dñ_by∑ss_rouãs
 (
rouã_by∑ss
 *
rb
,

814 
ö_addr_t
 
g©eway
,

815 c⁄° 
tu¡≠
 *
â
,

816 
Êags
,

817 c⁄° 
rouã_g©eway_öfo
 *
rgi
,

818 c⁄° 
ív_£t
 *
es
)

820 
i
;

821 
i
 = 0; i < 
rb
->
n_by∑ss
; ++i)

823 i‡(
rb
->
by∑ss
[
i
])

824 
	`dñ_rouã3
 (
rb
->
by∑ss
[
i
],

825 
IPV4_NETMASK_HOST
,

826 
g©eway
,

827 
â
,

828 
Êags
 | 
ROUTE_REF_GW
,

829 
rgi
,

830 
es
);

832 
	}
}

835 
	$ªdúe˘_deÁu…_rouã_to_v≤
 (
rouã_li°
 *
æ
, c⁄° 
tu¡≠
 *
â
, 
Êags
, c⁄° 
ív_£t
 *
es
)

837 c⁄° 
îr
[] = "NOTE: unableÅoÑedirect default gateway --";

839 i‡–
æ
 &&Ñl->
Êags
 & 
RG_ENABLE
 )

841 i‡(!(
æ
->
•ec
.
Êags
 & 
RTSA_REMOTE_ENDPOINT
))

843 
	`msg
 (
M_WARN
, "%†VPN g©ewayÖ¨amëî (--rouã-g©eway o∏--ifc⁄figËi†missög", 
îr
);

845 i‡(!(
æ
->
rgi
.
Êags
 & 
RGI_ADDR_DEFINED
))

847 
	`msg
 (
M_WARN
, "%†C™nŸÑód cuºíàdeÁu… g©eway from sy°em", 
îr
);

849 i‡(!(
æ
->
•ec
.
Êags
 & 
RTSA_REMOTE_HOST
))

851 
	`msg
 (
M_WARN
, "%†C™nŸ obèö cuºíàªmŸêho°áddªss", 
îr
);

855 
boﬁ
 
loˇl
 = 
	`BOOL_CAST
(
æ
->
Êags
 & 
RG_LOCAL
);

856 i‡(
æ
->
Êags
 & 
RG_AUTO_LOCAL
) {

857 c⁄° 
éa
 = 
æ
->
•ec
.
ªmŸe_ho°_loˇl
;

858 i‡(
éa
 =
TLA_NONLOCAL
)

860 
	`dmsg
 (
D_ROUTE
, "ROUTEÑemote_host is NOT LOCAL");

861 
loˇl
 = 
Ál£
;

863 i‡(
éa
 =
TLA_LOCAL
)

865 
	`dmsg
 (
D_ROUTE
, "ROUTEÑemote_host is LOCAL");

866 
loˇl
 = 
åue
;

869 i‡(!
loˇl
)

874 i‡(
æ
->
•ec
.
ªmŸe_ho°
 !
IPV4_INVALID_ADDR
) {

875 
	`add_rouã3
 (
æ
->
•ec
.
ªmŸe_ho°
,

876 
IPV4_NETMASK_HOST
,

877 
æ
->
rgi
.
g©eway
.
addr
,

878 
â
,

879 
Êags
 | 
ROUTE_REF_GW
,

880 &
æ
->
rgi
,

881 
es
);

882 
æ
->
iÊags
 |
RL_DID_LOCAL
;

884 
	`dmsg
 (
D_ROUTE
, "ROUTEÑemote_hostÖrotocol differs fromÅunneled");

889 
	`add_by∑ss_rouãs
 (&
æ
->
•ec
.
by∑ss
,Ñl->
rgi
.
g©eway
.
addr
, 
â
, 
Êags
, &æ->rgi, 
es
);

891 i‡(
æ
->
Êags
 & 
RG_REROUTE_GW
)

893 i‡(
æ
->
Êags
 & 
RG_DEF1
)

896 
	`add_rouã3
 (0x00000000,

898 
æ
->
•ec
.
ªmŸe_ídpoöt
,

899 
â
,

900 
Êags
,

901 &
æ
->
rgi
,

902 
es
);

905 
	`add_rouã3
 (0x80000000,

907 
æ
->
•ec
.
ªmŸe_ídpoöt
,

908 
â
,

909 
Êags
,

910 &
æ
->
rgi
,

911 
es
);

916 
	`dñ_rouã3
 (0,

918 
æ
->
rgi
.
g©eway
.
addr
,

919 
â
,

920 
Êags
 | 
ROUTE_REF_GW
,

921 &
æ
->
rgi
,

922 
es
);

925 
	`add_rouã3
 (0,

927 
æ
->
•ec
.
ªmŸe_ídpoöt
,

928 
â
,

929 
Êags
,

930 &
æ
->
rgi
,

931 
es
);

936 
æ
->
iÊags
 |
RL_DID_REDIRECT_DEFAULT_GATEWAY
;

939 
	}
}

942 
	$undo_ªdúe˘_deÁu…_rouã_to_v≤
 (
rouã_li°
 *
æ
, c⁄° 
tu¡≠
 *
â
, 
Êags
, c⁄° 
ív_£t
 *
es
)

944 i‡–
æ
 &&Ñl->
iÊags
 & 
RL_DID_REDIRECT_DEFAULT_GATEWAY
 )

947 i‡(
æ
->
iÊags
 & 
RL_DID_LOCAL
)

949 
	`dñ_rouã3
 (
æ
->
•ec
.
ªmŸe_ho°
,

950 
IPV4_NETMASK_HOST
,

951 
æ
->
rgi
.
g©eway
.
addr
,

952 
â
,

953 
Êags
 | 
ROUTE_REF_GW
,

954 &
æ
->
rgi
,

955 
es
);

956 
æ
->
iÊags
 &~
RL_DID_LOCAL
;

960 
	`dñ_by∑ss_rouãs
 (&
æ
->
•ec
.
by∑ss
,Ñl->
rgi
.
g©eway
.
addr
, 
â
, 
Êags
, &æ->rgi, 
es
);

962 i‡(
æ
->
Êags
 & 
RG_REROUTE_GW
)

964 i‡(
æ
->
Êags
 & 
RG_DEF1
)

967 
	`dñ_rouã3
 (0x00000000,

969 
æ
->
•ec
.
ªmŸe_ídpoöt
,

970 
â
,

971 
Êags
,

972 &
æ
->
rgi
,

973 
es
);

976 
	`dñ_rouã3
 (0x80000000,

978 
æ
->
•ec
.
ªmŸe_ídpoöt
,

979 
â
,

980 
Êags
,

981 &
æ
->
rgi
,

982 
es
);

987 
	`dñ_rouã3
 (0,

989 
æ
->
•ec
.
ªmŸe_ídpoöt
,

990 
â
,

991 
Êags
,

992 &
æ
->
rgi
,

993 
es
);

996 
	`add_rouã3
 (0,

998 
æ
->
rgi
.
g©eway
.
addr
,

999 
â
,

1000 
Êags
 | 
ROUTE_REF_GW
,

1001 &
æ
->
rgi
,

1002 
es
);

1006 
æ
->
iÊags
 &~
RL_DID_REDIRECT_DEFAULT_GATEWAY
;

1008 
	}
}

1011 
	$add_rouãs
 (
rouã_li°
 *
æ
, 
rouã_ùv6_li°
 *
æ6
, c⁄° 
tu¡≠
 *
â
, 
Êags
, c⁄° 
ív_£t
 *
es
)

1013 
	`ªdúe˘_deÁu…_rouã_to_v≤
 (
æ
, 
â
, 
Êags
, 
es
);

1014 i‡–
æ
 && !‘l->
iÊags
 & 
RL_ROUTES_ADDED
) )

1016 
i
;

1018 #ifde‡
ENABLE_MANAGEMENT


1019 i‡(
m™agemít
 && 
æ
->
n
)

1021 
	`m™agemít_£t_°©e
 (
m™agemít
,

1022 
OPENVPN_STATE_ADD_ROUTES
,

1023 
NULL
,

1029 
i
 = 0; i < 
æ
->
n
; ++i)

1031 
rouã_ùv4
 *
r
 = &
æ
->
rouãs
[
i
];

1032 
	`check_sub√t_c⁄Êi˘
 (
r
->
√tw‹k
,Ñ->
√tmask
, "route");

1033 i‡(
Êags
 & 
ROUTE_DELETE_FIRST
)

1034 
	`dñëe_rouã
 (
r
, 
â
, 
Êags
, &
æ
->
rgi
, 
es
);

1035 
	`add_rouã
 (
r
, 
â
, 
Êags
, &
æ
->
rgi
, 
es
);

1037 
æ
->
iÊags
 |
RL_ROUTES_ADDED
;

1039 i‡(
æ6
 && !æ6->
rouãs_added
)

1041 
i
;

1043 
i
 = 0; i < 
æ6
->
n
; ++i)

1045 
rouã_ùv6
 *
r
 = &
æ6
->
rouãs_ùv6
[
i
];

1046 i‡(
Êags
 & 
ROUTE_DELETE_FIRST
)

1047 
	`dñëe_rouã_ùv6
 (
r
, 
â
, 
Êags
, 
es
);

1048 
	`add_rouã_ùv6
 (
r
, 
â
, 
Êags
, 
es
);

1050 
æ6
->
rouãs_added
 = 
åue
;

1052 
	}
}

1055 
	$dñëe_rouãs
 (
rouã_li°
 *
æ
, 
rouã_ùv6_li°
 *
æ6
,

1056 c⁄° 
tu¡≠
 *
â
, 
Êags
, c⁄° 
ív_£t
 *
es
)

1058 i‡–
æ
 &&Ñl->
iÊags
 & 
RL_ROUTES_ADDED
 )

1060 
i
;

1061 
i
 = 
æ
->
n
 - 1; i >= 0; --i)

1063 
rouã_ùv4
 * 
r
 = &
æ
->
rouãs
[
i
];

1064 
	`dñëe_rouã
 (
r
, 
â
, 
Êags
, &
æ
->
rgi
, 
es
);

1066 
æ
->
iÊags
 &~
RL_ROUTES_ADDED
;

1069 
	`undo_ªdúe˘_deÁu…_rouã_to_v≤
 (
æ
, 
â
, 
Êags
, 
es
);

1071 i‡–
æ
 )

1073 
	`˛ór_rouã_li°
 (
æ
);

1076 i‡–
æ6
 &&Ñl6->
rouãs_added
 )

1078 
i
;

1079 
i
 = 
æ6
->
n
 - 1; i >= 0; --i)

1081 c⁄° 
rouã_ùv6
 *
r6
 = &
æ6
->
rouãs_ùv6
[
i
];

1082 
	`dñëe_rouã_ùv6
 (
r6
, 
â
, 
Êags
, 
es
);

1084 
æ6
->
rouãs_added
 = 
Ál£
;

1087 i‡–
æ6
 )

1089 
	`˛ór_rouã_ùv6_li°
 (
æ6
);

1091 
	}
}

1093 #i‚de‡
ENABLE_SMALL


1096 
	$show_›t
 (c⁄° *
›ti⁄
)

1098 i‡(!
›ti⁄
)

1101  
›ti⁄
;

1102 
	}
}

1105 
	$¥öt_rouã_›ti⁄
 (c⁄° 
rouã_›ti⁄
 *
ro
, 
Àvñ
)

1107 
	`msg
 (
Àvñ
, "Ñoute %s/%s/%s/%s",

1108 
	`show_›t
 (
ro
->
√tw‹k
),

1109 
	`show_›t
 (
ro
->
√tmask
),

1110 
	`show_›t
 (
ro
->
g©eway
),

1111 
	`show_›t
 (
ro
->
mëric
));

1112 
	}
}

1115 
	$¥öt_rouã_›ti⁄s
 (c⁄° 
rouã_›ti⁄_li°
 *
rﬁ
,

1116 
Àvñ
)

1118 
i
;

1119 i‡(
rﬁ
->
Êags
 & 
RG_ENABLE
)

1120 
	`msg
 (
Àvñ
, " [redirect_default_gatewayÜocal=%d]",

1121 (
rﬁ
->
Êags
 & 
RG_LOCAL
) != 0);

1122 
i
 = 0; i < 
rﬁ
->
n
; ++i)

1123 
	`¥öt_rouã_›ti⁄
 (&
rﬁ
->
rouãs
[
i
], 
Àvñ
);

1124 
	}
}

1127 
	$¥öt_deÁu…_g©eway
(c⁄° 
msgÀvñ
, c⁄° 
rouã_g©eway_öfo
 *
rgi
)

1129 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1130 i‡(
rgi
->
Êags
 & 
RGI_ADDR_DEFINED
)

1132 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, &
gc
);

1133 
	`buf_¥ötf
 (&
out
, "ROUTE_GATEWAY");

1134 i‡(
rgi
->
Êags
 & 
RGI_ON_LINK
)

1135 
	`buf_¥ötf
 (&
out
, " ON_LINK");

1137 
	`buf_¥ötf
 (&
out
, " %s", 
	`¥öt_ö_addr_t
 (
rgi
->
g©eway
.
addr
, 0, &
gc
));

1138 i‡(
rgi
->
Êags
 & 
RGI_NETMASK_DEFINED
)

1139 
	`buf_¥ötf
 (&
out
, "/%s", 
	`¥öt_ö_addr_t
 (
rgi
->
g©eway
.
√tmask
, 0, &
gc
));

1140 #ifde‡
WIN32


1141 i‡(
rgi
->
Êags
 & 
RGI_IFACE_DEFINED
)

1142 
	`buf_¥ötf
 (&
out
, " I=%u", ()
rgi
->
ad≠ãr_ödex
);

1144 i‡(
rgi
->
Êags
 & 
RGI_IFACE_DEFINED
)

1145 
	`buf_¥ötf
 (&
out
, " IFACE=%s", 
rgi
->
iÁ˚
);

1147 i‡(
rgi
->
Êags
 & 
RGI_HWADDR_DEFINED
)

1148 
	`buf_¥ötf
 (&
out
, " HWADDR=%s", 
	`f‹m©_hex_ex
 (
rgi
->
hwaddr
, 6, 0, 1, ":", &
gc
));

1149 
	`msg
 (
msgÀvñ
, "%s", 
	`BSTR
 (&
out
));

1151 
	`gc_‰ì
 (&
gc
);

1152 
	}
}

1157 
	$¥öt_rouã
 (c⁄° 
rouã_ùv4
 *
r
, 
Àvñ
)

1159 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1160 i‡(
r
->
Êags
 & 
RT_DEFINED
)

1161 
	`msg
 (
Àvñ
, "%s", 
	`rouã_°rög
 (
r
, &
gc
));

1162 
	`gc_‰ì
 (&
gc
);

1163 
	}
}

1166 
	$¥öt_rouãs
 (c⁄° 
rouã_li°
 *
æ
, 
Àvñ
)

1168 
i
;

1169 
i
 = 0; i < 
æ
->
n
; ++i)

1170 
	`¥öt_rouã
 (&
æ
->
rouãs
[
i
], 
Àvñ
);

1171 
	}
}

1174 
	$£ãnv_rouã
 (
ív_£t
 *
es
, c⁄° 
rouã_ùv4
 *
r
, 
i
)

1176 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1177 i‡(
r
->
Êags
 & 
RT_DEFINED
)

1179 
	`£ãnv_rouã_addr
 (
es
, "√tw‹k", 
r
->
√tw‹k
, 
i
);

1180 
	`£ãnv_rouã_addr
 (
es
, "√tmask", 
r
->
√tmask
, 
i
);

1181 
	`£ãnv_rouã_addr
 (
es
, "g©eway", 
r
->
g©eway
, 
i
);

1183 i‡(
r
->
Êags
 & 
RT_METRIC_DEFINED
)

1185 
buf„r
 
«me
 = 
	`Æloc_buf_gc
 (256, &
gc
);

1186 
	`buf_¥ötf
 (&
«me
, "rouã_mëric_%d", 
i
);

1187 
	`£ãnv_öt
 (
es
, 
	`BSTR
 (&
«me
), 
r
->
mëric
);

1190 
	`gc_‰ì
 (&
gc
);

1191 
	}
}

1194 
	$£ãnv_rouãs
 (
ív_£t
 *
es
, c⁄° 
rouã_li°
 *
æ
)

1196 
i
;

1197 
i
 = 0; i < 
æ
->
n
; ++i)

1198 
	`£ãnv_rouã
 (
es
, &
æ
->
rouãs
[
i
], i + 1);

1199 
	}
}

1202 
	$£ãnv_rouã_ùv6
 (
ív_£t
 *
es
, c⁄° 
rouã_ùv6
 *
r6
, 
i
)

1204 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1205 i‡(
r6
->
deföed
)

1207 
buf„r
 
«me1
 = 
	`Æloc_buf_gc
–256, &
gc
 );

1208 
buf„r
 
vÆ
 = 
	`Æloc_buf_gc
–256, &
gc
 );

1209 
buf„r
 
«me2
 = 
	`Æloc_buf_gc
–256, &
gc
 );

1211 
	`buf_¥ötf
–&
«me1
, "rouã_ùv6_√tw‹k_%d", 
i
 );

1212 
	`buf_¥ötf
–&
vÆ
, "%s/%d", 
	`¥öt_ö6_addr
–
r6
->
√tw‹k
, 0, &
gc
 ),

1213 
r6
->
√tbôs
 );

1214 
	`£ãnv_°r
–
es
, 
	`BSTR
(&
«me1
), BSTR(&
vÆ
) );

1216 
	`buf_¥ötf
–&
«me2
, "rouã_ùv6_g©eway_%d", 
i
 );

1217 
	`£ãnv_°r
–
es
, 
	`BSTR
(&
«me2
), 
	`¥öt_ö6_addr
–
r6
->
g©eway
, 0, &
gc
 ));

1219 
	`gc_‰ì
 (&
gc
);

1220 
	}
}

1222 
	$£ãnv_rouãs_ùv6
 (
ív_£t
 *
es
, c⁄° 
rouã_ùv6_li°
 *
æ6
)

1224 
i
;

1225 
i
 = 0; i < 
æ6
->
n
; ++i)

1226 
	`£ãnv_rouã_ùv6
 (
es
, &
æ6
->
rouãs_ùv6
[
i
], i + 1);

1227 
	}
}

1248 
	#LR_NOMATCH
 0

	)

1249 
	#LR_MATCH
 1

	)

1250 
	#LR_ERROR
 2

	)

1253 
	$loˇl_rouã
 (
ö_addr_t
 
√tw‹k
,

1254 
ö_addr_t
 
√tmask
,

1255 
ö_addr_t
 
g©eway
,

1256 c⁄° 
rouã_g©eway_öfo
 *
rgi
)

1259 c⁄° 
rgi_√eded
 = (
RGI_ADDR_DEFINED
|
RGI_NETMASK_DEFINED
|
RGI_IFACE_DEFINED
);

1260 i‡(
rgi


1261 && (
rgi
->
Êags
 & 
rgi_√eded
) ==Ñgi_needed

1262 && 
g©eway
 =
rgi
->g©eway.
addr


1263 && 
√tmask
 == 0xFFFFFFFF)

1265 i‡(((
√tw‹k
 ^ 
rgi
->
g©eway
.
addr
Ë&Ñgi->g©eway.
√tmask
) == 0)

1266  
LR_MATCH
;

1270 
size_t
 
i
;

1271 
i
 = 0; i < 
rgi
->
n_addrs
; ++i)

1273 c⁄° 
rouã_g©eway_addªss
 *
gwa
 = &
rgi
->
addrs
[
i
];

1274 i‡(((
√tw‹k
 ^ 
gwa
->
addr
Ë& gwa->
√tmask
) == 0)

1275  
LR_MATCH
;

1279  
LR_NOMATCH
;

1280 
	}
}

1284 
ölöe
 
boﬁ


1285 
	$is_⁄_lök
 (c⁄° 
is_loˇl_rouã
, c⁄° 
Êags
, c⁄° 
rouã_g©eway_öfo
 *
rgi
)

1287  
rgi
 && (
is_loˇl_rouã
 =
LR_MATCH
 || ((
Êags
 & 
ROUTE_REF_GW
Ë&& (rgi->Êag†& 
RGI_ON_LINK
)));

1288 
	}
}

1291 
	$add_rouã
 (
rouã_ùv4
 *
r
,

1292 c⁄° 
tu¡≠
 *
â
,

1293 
Êags
,

1294 c⁄° 
rouã_g©eway_öfo
 *
rgi
,

1295 c⁄° 
ív_£t
 *
es
)

1297 
gc_¨ía
 
gc
;

1298 
¨gv
árgv;

1299 c⁄° *
√tw‹k
;

1300 c⁄° *
√tmask
;

1301 c⁄° *
g©eway
;

1302 
boﬁ
 
°©us
 = 
Ál£
;

1303 
is_loˇl_rouã
;

1305 i‡(!(
r
->
Êags
 & 
RT_DEFINED
))

1308 
	`gc_öô
 (&
gc
);

1309 
	`¨gv_öô
 (&
¨gv
);

1311 
√tw‹k
 = 
	`¥öt_ö_addr_t
 (
r
->√tw‹k, 0, &
gc
);

1312 
√tmask
 = 
	`¥öt_ö_addr_t
 (
r
->√tmask, 0, &
gc
);

1313 
g©eway
 = 
	`¥öt_ö_addr_t
 (
r
->g©eway, 0, &
gc
);

1315 
is_loˇl_rouã
 = 
	`loˇl_rouã
(
r
->
√tw‹k
,Ñ->
√tmask
,Ñ->
g©eway
, 
rgi
);

1316 i‡(
is_loˇl_rouã
 =
LR_ERROR
)

1317 
d⁄e
;

1319 #i‡
	`deföed
(
TARGET_LINUX
)

1320 #ifde‡
ENABLE_IPROUTE


1321 
	`¨gv_¥ötf
 (&
¨gv
, "%sÑouteádd %s/%d",

1322 
ùrouã_∑th
,

1323 
√tw‹k
,

1324 
	`cou¡_√tmask_bôs
(
√tmask
));

1326 i‡(
r
->
Êags
 & 
RT_METRIC_DEFINED
)

1327 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "mëri¯%d", 
r
->
mëric
);

1329 i‡(
	`is_⁄_lök
 (
is_loˇl_rouã
, 
Êags
, 
rgi
))

1330 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "dev %s", 
rgi
->
iÁ˚
);

1332 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "vü %s", 
g©eway
);

1334 
	`¨gv_¥ötf
 (&
¨gv
, "%sádd -net %sÇetmask %s",

1335 
ROUTE_PATH
,

1336 
√tw‹k
,

1337 
√tmask
);

1338 i‡(
r
->
Êags
 & 
RT_METRIC_DEFINED
)

1339 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "mëri¯%d", 
r
->
mëric
);

1340 i‡(
	`is_⁄_lök
 (
is_loˇl_rouã
, 
Êags
, 
rgi
))

1341 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "dev %s", 
rgi
->
iÁ˚
);

1343 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "gw %s", 
g©eway
);

1346 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1347 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: LinuxÑouteádd command failed");

1349 #ñi‡
	`deföed
 (
WIN32
)

1351 
DWORD
 
ai
 = 
TUN_ADAPTER_INDEX_INVALID
;

1352 
	`¨gv_¥ötf
 (&
¨gv
, "%s%sc ADD %s MASK %s %s",

1353 
	`gë_wö_sys_∑th
(),

1354 
WIN_ROUTE_PATH_SUFFIX
,

1355 
√tw‹k
,

1356 
√tmask
,

1357 
g©eway
);

1358 i‡(
r
->
Êags
 & 
RT_METRIC_DEFINED
)

1359 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "METRIC %d", 
r
->
mëric
);

1360 i‡(
	`is_⁄_lök
 (
is_loˇl_rouã
, 
Êags
, 
rgi
))

1362 
ai
 = 
rgi
->
ad≠ãr_ödex
;

1363 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "IF %u", ()
ai
);

1366 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1368 i‡((
Êags
 & 
ROUTE_METHOD_MASK
Ë=
ROUTE_METHOD_IPAPI
)

1370 
°©us
 = 
	`add_rouã_ù≠i
 (
r
, 
â
, 
ai
);

1371 
	`msg
 (
D_ROUTE
, "Rouãáddôi⁄ vü IPAPI %s", 
°©us
 ? "succeeded" : "failed");

1373 i‡((
Êags
 & 
ROUTE_METHOD_MASK
Ë=
ROUTE_METHOD_EXE
)

1375 
	`√tcmd_£m≠h‹e_lock
 ();

1376 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: WindowsÑouteádd command failed");

1377 
	`√tcmd_£m≠h‹e_ªÀa£
 ();

1379 i‡((
Êags
 & 
ROUTE_METHOD_MASK
Ë=
ROUTE_METHOD_ADAPTIVE
)

1381 
°©us
 = 
	`add_rouã_ù≠i
 (
r
, 
â
, 
ai
);

1382 
	`msg
 (
D_ROUTE
, "Rouãáddôi⁄ vü IPAPI %†[ad≠tive]", 
°©us
 ? "succeeded" : "failed");

1383 i‡(!
°©us
)

1385 
	`msg
 (
D_ROUTE
, "Routeáddition fallbackÅoÑoute.exe");

1386 
	`√tcmd_£m≠h‹e_lock
 ();

1387 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: WindowsÑouteádd command failed [adaptive]");

1388 
	`√tcmd_£m≠h‹e_ªÀa£
 ();

1393 
	`ASSERT
 (0);

1397 #ñi‡
	`deföed
 (
TARGET_SOLARIS
)

1401 
	`¨gv_¥ötf
 (&
¨gv
, "%sádd",

1402 
ROUTE_PATH
);

1404 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "%s -netmask %s %s",

1405 
√tw‹k
,

1406 
√tmask
,

1407 
g©eway
);

1416 i‡(
r
->
Êags
 & 
RT_METRIC_DEFINED
 )

1417 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "%d", 
r
->
mëric
);

1419 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1420 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: SolarisÑouteádd command failed");

1422 #ñi‡
	`deföed
(
TARGET_FREEBSD
)

1424 
	`¨gv_¥ötf
 (&
¨gv
, "%sádd",

1425 
ROUTE_PATH
);

1428 i‡(
r
->
Êags
 & 
RT_METRIC_DEFINED
)

1429 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "-πà%d", 
r
->
mëric
);

1432 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "-net %s %s %s",

1433 
√tw‹k
,

1434 
g©eway
,

1435 
√tmask
);

1439 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1440 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: FreeBSDÑouteádd command failed");

1442 #ñi‡
	`deföed
(
TARGET_DRAGONFLY
)

1444 
	`¨gv_¥ötf
 (&
¨gv
, "%sádd",

1445 
ROUTE_PATH
);

1448 i‡(
r
->
Êags
 & 
RT_METRIC_DEFINED
)

1449 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "-πà%d", 
r
->
mëric
);

1452 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "-net %s %s %s",

1453 
√tw‹k
,

1454 
g©eway
,

1455 
√tmask
);

1459 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1460 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: DragonFlyÑouteádd command failed");

1462 #ñi‡
	`deföed
(
TARGET_DARWIN
)

1464 
	`¨gv_¥ötf
 (&
¨gv
, "%sádd",

1465 
ROUTE_PATH
);

1468 i‡(
r
->
Êags
 & 
RT_METRIC_DEFINED
)

1469 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "-πà%d", 
r
->
mëric
);

1472 i‡(
	`is_⁄_lök
 (
is_loˇl_rouã
, 
Êags
, 
rgi
))

1476 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "-cloning -net %s -netmask %s -interface %s",

1477 
√tw‹k
,

1478 
√tmask
,

1479 
rgi
->
iÁ˚
);

1483 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "-net %s %s %s",

1484 
√tw‹k
,

1485 
g©eway
,

1486 
√tmask
);

1489 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1490 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: OS XÑouteádd command failed");

1492 #ñi‡
	`deföed
(
TARGET_OPENBSD
Ë|| deföed(
TARGET_NETBSD
)

1494 
	`¨gv_¥ötf
 (&
¨gv
, "%sádd",

1495 
ROUTE_PATH
);

1498 i‡(
r
->
Êags
 & 
RT_METRIC_DEFINED
)

1499 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "-πà%d", 
r
->
mëric
);

1502 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "-net %s %s -netmask %s",

1503 
√tw‹k
,

1504 
g©eway
,

1505 
√tmask
);

1509 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1510 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: OpenBSD/NetBSDÑouteádd command failed");

1513 
	`msg
 (
M_FATAL
, "Sorry, but I don't know howÅo do 'route' commands onÅhis operating system. TryÖutting yourÑoutes iná --route-up script");

1516 
d⁄e
:

1517 i‡(
°©us
)

1518 
r
->
Êags
 |
RT_ADDED
;

1520 
r
->
Êags
 &~
RT_ADDED
;

1521 
	`¨gv_ª£t
 (&
¨gv
);

1522 
	`gc_‰ì
 (&
gc
);

1523 
	}
}

1527 
	$¥öt_ö6_addr_√tbôs_⁄ly
–
ö6_addr
 
√tw‹k_c›y
, 
√tbôs
,

1528 
gc_¨ía
 * 
gc
)

1534 
byã
 = 15;

1535 
bôs_to_˛ór
 = 128 - 
√tbôs
;

1537  
byã
 >0 && 
bôs_to_˛ór
 > 0 )

1539 i‡–
bôs_to_˛ór
 >= 8 )

1540 { 
√tw‹k_c›y
.
s6_addr
[
byã
--] = 0; 
bôs_to_˛ór
 -= 8; }

1542 { 
√tw‹k_c›y
.
s6_addr
[
byã
--] &(0xf‡<< 
bôs_to_˛ór
); bits_to_clear = 0; }

1545  
	`¥öt_ö6_addr
–
√tw‹k_c›y
, 0, 
gc
);

1546 
	}
}

1549 
	$add_rouã_ùv6
 (
rouã_ùv6
 *
r6
, c⁄° 
tu¡≠
 *
â
, 
Êags
, c⁄° 
ív_£t
 *
es
)

1551 
gc_¨ía
 
gc
;

1552 
¨gv
árgv;

1554 c⁄° *
√tw‹k
;

1555 c⁄° *
g©eway
;

1556 
boﬁ
 
°©us
 = 
Ál£
;

1557 c⁄° *
devi˚
 = 
â
->
a˘uÆ_«me
;

1559 
boﬁ
 
g©eway_√eded
 = 
Ál£
;

1561 i‡(!
r6
->
deföed
)

1564 
	`gc_öô
 (&
gc
);

1565 
	`¨gv_öô
 (&
¨gv
);

1567 
√tw‹k
 = 
	`¥öt_ö6_addr_√tbôs_⁄ly
–
r6
->√tw‹k,Ñ6->
√tbôs
, &
gc
);

1568 
g©eway
 = 
	`¥öt_ö6_addr
–
r6
->g©eway, 0, &
gc
);

1570 i‡–!
â
->
ùv6
 )

1572 
	`msg
–
M_INFO
, "add_route_ipv6():Çotádding %s/%d,Ço IPv6 on if %s",

1573 
√tw‹k
, 
r6
->
√tbôs
, 
devi˚
 );

1577 
	`msg
–
M_INFO
, "add_route_ipv6(%s/%d -> %s metric %d) dev %s",

1578 
√tw‹k
, 
r6
->
√tbôs
, 
g©eway
,Ñ6->
mëric
, 
devi˚
 );

1591 i‡–
â
->
ty≥
 =
DEV_TYPE_TAP
 &&

1592 !(
r6
->
mëric_deföed
 &&Ñ6->
mëric
 == 0 ) )

1594 
g©eway_√eded
 = 
åue
;

1597 #i‡
	`deföed
(
TARGET_LINUX
)

1598 #ifde‡
ENABLE_IPROUTE


1599 
	`¨gv_¥ötf
 (&
¨gv
, "%s -6Ñouteádd %s/%d dev %s",

1600 
ùrouã_∑th
,

1601 
√tw‹k
,

1602 
r6
->
√tbôs
,

1603 
devi˚
);

1604 i‡(
g©eway_√eded
)

1605 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "vü %s", 
g©eway
);

1606 i‡(
r6
->
mëric_deföed
 &&Ñ6->
mëric
 > 0 )

1607 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, " mëri¯%d", 
r6
->
mëric
);

1610 
	`¨gv_¥ötf
 (&
¨gv
, "%s -A inet6ádd %s/%d dev %s",

1611 
ROUTE_PATH
,

1612 
√tw‹k
,

1613 
r6
->
√tbôs
,

1614 
devi˚
);

1615 i‡(
g©eway_√eded
)

1616 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "gw %s", 
g©eway
);

1617 i‡(
r6
->
mëric_deföed
 &&Ñ6->
mëric
 > 0 )

1618 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, " mëri¯%d", 
r6
->
mëric
);

1620 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1621 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: LinuxÑoute -6/-A inet6ádd command failed");

1623 #ñi‡
	`deföed
 (
WIN32
)

1626 
	`¨gv_¥ötf
 (&
¨gv
, "%s%sc interface ipv6áddÑoute %s/%d %s",

1627 
	`gë_wö_sys_∑th
(),

1628 
NETSH_PATH_SUFFIX
,

1629 
√tw‹k
,

1630 
r6
->
√tbôs
,

1631 
devi˚
);

1638 i‡–
â
->
ty≥
 =
DEV_TYPE_TUN
 )

1639 
	`¨gv_¥ötf_ˇt
–&
¨gv
, " %s", "fe80::8" );

1641 
	`¨gv_¥ötf_ˇt
–&
¨gv
, " %s", 
g©eway
 );

1644 i‡(
r
->
mëric_deföed
)

1645 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, " METRIC %d", 
r
->
mëric
);

1651 
	`¨gv_¥ötf_ˇt
–&
¨gv
, " store=active" );

1653 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1655 
	`√tcmd_£m≠h‹e_lock
 ();

1656 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: WindowsÑouteádd ipv6 command failed");

1657 
	`√tcmd_£m≠h‹e_ªÀa£
 ();

1659 #ñi‡
	`deföed
 (
TARGET_SOLARIS
)

1668 
	`¨gv_¥ötf
 (&
¨gv
, "%sádd -inet6 %s/%d %s 0",

1669 
ROUTE_PATH
,

1670 
√tw‹k
,

1671 
r6
->
√tbôs
,

1672 
g©eway
 );

1674 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1675 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: SolarisÑouteádd -inet6 command failed");

1677 #ñi‡
	`deföed
(
TARGET_FREEBSD
Ë|| deföed(
TARGET_DRAGONFLY
)

1679 
	`¨gv_¥ötf
 (&
¨gv
, "%sádd -inet6 %s/%d",

1680 
ROUTE_PATH
,

1681 
√tw‹k
,

1682 
r6
->
√tbôs
);

1684 i‡(
g©eway_√eded
)

1685 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "%s", 
g©eway
);

1687 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "-iÁ˚ %s", 
devi˚
);

1689 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1690 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: *BSDÑouteádd -inet6 command failed");

1692 #ñi‡
	`deföed
(
TARGET_DARWIN
)

1694 
	`¨gv_¥ötf
 (&
¨gv
, "%sádd -inet6 %s -prefixlen %d",

1695 
ROUTE_PATH
,

1696 
√tw‹k
, 
r6
->
√tbôs
 );

1698 i‡(
g©eway_√eded
)

1699 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "%s", 
g©eway
);

1701 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "-iÁ˚ %s", 
devi˚
);

1703 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1704 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: MacOS XÑouteádd -inet6 command failed");

1706 #ñi‡
	`deföed
(
TARGET_OPENBSD
)

1708 
	`¨gv_¥ötf
 (&
¨gv
, "%sádd -inet6 %s -prefixlen %d %s",

1709 
ROUTE_PATH
,

1710 
√tw‹k
, 
r6
->
√tbôs
, 
g©eway
 );

1712 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1713 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: OpenBSDÑouteádd -inet6 command failed");

1715 #ñi‡
	`deföed
(
TARGET_NETBSD
)

1717 
	`¨gv_¥ötf
 (&
¨gv
, "%sádd -inet6 %s/%d %s",

1718 
ROUTE_PATH
,

1719 
√tw‹k
, 
r6
->
√tbôs
, 
g©eway
 );

1721 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1722 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: NetBSDÑouteádd -inet6 command failed");

1725 
	`msg
 (
M_FATAL
, "Sorry, but I don't know howÅo do 'route ipv6' commands onÅhis operating system. TryÖutting yourÑoutes iná --route-up script");

1728 
r6
->
deföed
 = 
°©us
;

1729 
	`¨gv_ª£t
 (&
¨gv
);

1730 
	`gc_‰ì
 (&
gc
);

1731 
	}
}

1734 
	$dñëe_rouã
 (
rouã_ùv4
 *
r
,

1735 c⁄° 
tu¡≠
 *
â
,

1736 
Êags
,

1737 c⁄° 
rouã_g©eway_öfo
 *
rgi
,

1738 c⁄° 
ív_£t
 *
es
)

1740 
gc_¨ía
 
gc
;

1741 
¨gv
árgv;

1742 c⁄° *
√tw‹k
;

1743 c⁄° *
√tmask
;

1744 c⁄° *
g©eway
;

1745 
is_loˇl_rouã
;

1747 i‡((
r
->
Êags
 & (
RT_DEFINED
|
RT_ADDED
)) != (RT_DEFINED|RT_ADDED))

1750 
	`gc_öô
 (&
gc
);

1751 
	`¨gv_öô
 (&
¨gv
);

1753 
√tw‹k
 = 
	`¥öt_ö_addr_t
 (
r
->√tw‹k, 0, &
gc
);

1754 
√tmask
 = 
	`¥öt_ö_addr_t
 (
r
->√tmask, 0, &
gc
);

1755 
g©eway
 = 
	`¥öt_ö_addr_t
 (
r
->g©eway, 0, &
gc
);

1757 
is_loˇl_rouã
 = 
	`loˇl_rouã
(
r
->
√tw‹k
,Ñ->
√tmask
,Ñ->
g©eway
, 
rgi
);

1758 i‡(
is_loˇl_rouã
 =
LR_ERROR
)

1759 
d⁄e
;

1761 #i‡
	`deföed
(
TARGET_LINUX
)

1762 #ifde‡
ENABLE_IPROUTE


1763 
	`¨gv_¥ötf
 (&
¨gv
, "%sÑoute del %s/%d",

1764 
ùrouã_∑th
,

1765 
√tw‹k
,

1766 
	`cou¡_√tmask_bôs
(
√tmask
));

1768 
	`¨gv_¥ötf
 (&
¨gv
, "%s del -net %sÇetmask %s",

1769 
ROUTE_PATH
,

1770 
√tw‹k
,

1771 
√tmask
);

1773 i‡(
r
->
Êags
 & 
RT_METRIC_DEFINED
)

1774 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "mëri¯%d", 
r
->
mëric
);

1775 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1776 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: LinuxÑoute delete command failed");

1778 #ñi‡
	`deföed
 (
WIN32
)

1780 
	`¨gv_¥ötf
 (&
¨gv
, "%s%sc DELETE %s MASK %s %s",

1781 
	`gë_wö_sys_∑th
(),

1782 
WIN_ROUTE_PATH_SUFFIX
,

1783 
√tw‹k
,

1784 
√tmask
,

1785 
g©eway
);

1787 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1789 i‡((
Êags
 & 
ROUTE_METHOD_MASK
Ë=
ROUTE_METHOD_IPAPI
)

1791 c⁄° 
boﬁ
 
°©us
 = 
	`dñ_rouã_ù≠i
 (
r
, 
â
);

1792 
	`msg
 (
D_ROUTE
, "Rouã dñëi⁄ vü IPAPI %s", 
°©us
 ? "succeeded" : "failed");

1794 i‡((
Êags
 & 
ROUTE_METHOD_MASK
Ë=
ROUTE_METHOD_EXE
)

1796 
	`√tcmd_£m≠h‹e_lock
 ();

1797 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: WindowsÑoute delete command failed");

1798 
	`√tcmd_£m≠h‹e_ªÀa£
 ();

1800 i‡((
Êags
 & 
ROUTE_METHOD_MASK
Ë=
ROUTE_METHOD_ADAPTIVE
)

1802 c⁄° 
boﬁ
 
°©us
 = 
	`dñ_rouã_ù≠i
 (
r
, 
â
);

1803 
	`msg
 (
D_ROUTE
, "Rouã dñëi⁄ vü IPAPI %†[ad≠tive]", 
°©us
 ? "succeeded" : "failed");

1804 i‡(!
°©us
)

1806 
	`msg
 (
D_ROUTE
, "Route deletion fallbackÅoÑoute.exe");

1807 
	`√tcmd_£m≠h‹e_lock
 ();

1808 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: WindowsÑoute delete command failed [adaptive]");

1809 
	`√tcmd_£m≠h‹e_ªÀa£
 ();

1814 
	`ASSERT
 (0);

1817 #ñi‡
	`deföed
 (
TARGET_SOLARIS
)

1819 
	`¨gv_¥ötf
 (&
¨gv
, "%s delete %s -netmask %s %s",

1820 
ROUTE_PATH
,

1821 
√tw‹k
,

1822 
√tmask
,

1823 
g©eway
);

1825 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1826 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: SolarisÑoute delete command failed");

1828 #ñi‡
	`deföed
(
TARGET_FREEBSD
)

1830 
	`¨gv_¥ötf
 (&
¨gv
, "%s delete -net %s %s %s",

1831 
ROUTE_PATH
,

1832 
√tw‹k
,

1833 
g©eway
,

1834 
√tmask
);

1836 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1837 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: FreeBSDÑoute delete command failed");

1839 #ñi‡
	`deföed
(
TARGET_DRAGONFLY
)

1841 
	`¨gv_¥ötf
 (&
¨gv
, "%s delete -net %s %s %s",

1842 
ROUTE_PATH
,

1843 
√tw‹k
,

1844 
g©eway
,

1845 
√tmask
);

1847 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1848 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: DragonFlyÑoute delete command failed");

1850 #ñi‡
	`deföed
(
TARGET_DARWIN
)

1852 i‡(
	`is_⁄_lök
 (
is_loˇl_rouã
, 
Êags
, 
rgi
))

1854 
	`¨gv_¥ötf
 (&
¨gv
, "%s delete -cloning -net %s -netmask %s -interface %s",

1855 
ROUTE_PATH
,

1856 
√tw‹k
,

1857 
√tmask
,

1858 
rgi
->
iÁ˚
);

1862 
	`¨gv_¥ötf
 (&
¨gv
, "%s delete -net %s %s %s",

1863 
ROUTE_PATH
,

1864 
√tw‹k
,

1865 
g©eway
,

1866 
√tmask
);

1869 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1870 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: OS XÑoute delete command failed");

1872 #ñi‡
	`deföed
(
TARGET_OPENBSD
Ë|| deföed(
TARGET_NETBSD
)

1874 
	`¨gv_¥ötf
 (&
¨gv
, "%s delete -net %s %s -netmask %s",

1875 
ROUTE_PATH
,

1876 
√tw‹k
,

1877 
g©eway
,

1878 
√tmask
);

1880 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1881 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: OpenBSD/NetBSDÑoute delete command failed");

1884 
	`msg
 (
M_FATAL
, "Sorry, but I don't know howÅo do 'route' commands onÅhis operating system. TryÖutting yourÑoutes iná --route-up script");

1887 
d⁄e
:

1888 
r
->
Êags
 &~
RT_ADDED
;

1889 
	`¨gv_ª£t
 (&
¨gv
);

1890 
	`gc_‰ì
 (&
gc
);

1891 
	}
}

1894 
	$dñëe_rouã_ùv6
 (c⁄° 
rouã_ùv6
 *
r6
, c⁄° 
tu¡≠
 *
â
, 
Êags
, c⁄° 
ív_£t
 *
es
)

1896 
gc_¨ía
 
gc
;

1897 
¨gv
árgv;

1898 c⁄° *
√tw‹k
;

1899 c⁄° *
g©eway
;

1900 c⁄° *
devi˚
 = 
â
->
a˘uÆ_«me
;

1901 
boﬁ
 
g©eway_√eded
 = 
Ál£
;

1903 i‡(!
r6
->
deföed
)

1906 
	`gc_öô
 (&
gc
);

1907 
	`¨gv_öô
 (&
¨gv
);

1909 
√tw‹k
 = 
	`¥öt_ö6_addr_√tbôs_⁄ly
–
r6
->√tw‹k,Ñ6->
√tbôs
, &
gc
);

1910 
g©eway
 = 
	`¥öt_ö6_addr
–
r6
->g©eway, 0, &
gc
);

1912 i‡–!
â
->
ùv6
 )

1914 
	`msg
–
M_INFO
, "delete_route_ipv6():Çot deleting %s/%d,Ço IPv6 on if %s",

1915 
√tw‹k
, 
r6
->
√tbôs
, 
devi˚
 );

1919 
	`msg
–
M_INFO
, "dñëe_rouã_ùv6(%s/%d)", 
√tw‹k
, 
r6
->
√tbôs
 );

1924 i‡–
â
->
ty≥
 =
DEV_TYPE_TAP
 &&

1925 !(
r6
->
mëric_deföed
 &&Ñ6->
mëric
 == 0 ) )

1927 
g©eway_√eded
 = 
åue
;

1931 #i‡
	`deföed
(
TARGET_LINUX
)

1932 #ifde‡
ENABLE_IPROUTE


1933 
	`¨gv_¥ötf
 (&
¨gv
, "%s -6Ñoute del %s/%d dev %s",

1934 
ùrouã_∑th
,

1935 
√tw‹k
,

1936 
r6
->
√tbôs
,

1937 
devi˚
);

1938 i‡(
g©eway_√eded
)

1939 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "vü %s", 
g©eway
);

1941 
	`¨gv_¥ötf
 (&
¨gv
, "%s -A inet6 del %s/%d dev %s",

1942 
ROUTE_PATH
,

1943 
√tw‹k
,

1944 
r6
->
√tbôs
,

1945 
devi˚
);

1946 i‡(
g©eway_√eded
)

1947 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "gw %s", 
g©eway
);

1948 i‡(
r6
->
mëric_deföed
 &&Ñ6->
mëric
 > 0 )

1949 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, " mëri¯%d", 
r6
->
mëric
);

1951 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1952 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: LinuxÑoute -6/-A inet6 del command failed");

1954 #ñi‡
	`deföed
 (
WIN32
)

1957 
	`¨gv_¥ötf
 (&
¨gv
, "%s%sc interface ipv6 deleteÑoute %s/%d %s",

1958 
	`gë_wö_sys_∑th
(),

1959 
NETSH_PATH_SUFFIX
,

1960 
√tw‹k
,

1961 
r6
->
√tbôs
,

1962 
devi˚
);

1970 i‡–
â
->
ty≥
 =
DEV_TYPE_TUN
 )

1971 
	`¨gv_¥ötf_ˇt
–&
¨gv
, " %s", "fe80::8" );

1973 
	`¨gv_¥ötf_ˇt
–&
¨gv
, " %s", 
g©eway
 );

1976 i‡(
r
->
mëric_deföed
)

1977 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "METRIC %d", 
r
->
mëric
);

1984 
	`¨gv_¥ötf_ˇt
–&
¨gv
, " store=active" );

1986 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

1988 
	`√tcmd_£m≠h‹e_lock
 ();

1989 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: WindowsÑoute delete ipv6 command failed");

1990 
	`√tcmd_£m≠h‹e_ªÀa£
 ();

1992 #ñi‡
	`deföed
 (
TARGET_SOLARIS
)

1997 
	`¨gv_¥ötf
 (&
¨gv
, "%s delete -inet6 %s/%d %s",

1998 
ROUTE_PATH
,

1999 
√tw‹k
,

2000 
r6
->
√tbôs
,

2001 
g©eway
 );

2003 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

2004 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: SolarisÑoute delete -inet6 command failed");

2006 #ñi‡
	`deföed
(
TARGET_FREEBSD
Ë|| deföed(
TARGET_DRAGONFLY
)

2008 
	`¨gv_¥ötf
 (&
¨gv
, "%s delete -inet6 %s/%d",

2009 
ROUTE_PATH
,

2010 
√tw‹k
,

2011 
r6
->
√tbôs
 );

2013 i‡(
g©eway_√eded
)

2014 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "%s", 
g©eway
);

2016 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "-iÁ˚ %s", 
devi˚
);

2018 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

2019 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: *BSDÑoute delete -inet6 command failed");

2021 #ñi‡
	`deföed
(
TARGET_DARWIN
)

2023 
	`¨gv_¥ötf
 (&
¨gv
, "%s delete -inet6 %s -prefixlen %d",

2024 
ROUTE_PATH
,

2025 
√tw‹k
, 
r6
->
√tbôs
 );

2027 i‡(
g©eway_√eded
)

2028 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "%s", 
g©eway
);

2030 
	`¨gv_¥ötf_ˇt
 (&
¨gv
, "-iÁ˚ %s", 
devi˚
);

2032 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

2033 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: MacOS XÑoute delete -inet6 command failed");

2035 #ñi‡
	`deföed
(
TARGET_OPENBSD
)

2037 
	`¨gv_¥ötf
 (&
¨gv
, "%s delete -inet6 %s -prefixlen %d %s",

2038 
ROUTE_PATH
,

2039 
√tw‹k
, 
r6
->
√tbôs
, 
g©eway
 );

2041 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

2042 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: OpenBSDÑoute delete -inet6 command failed");

2044 #ñi‡
	`deföed
(
TARGET_NETBSD
)

2046 
	`¨gv_¥ötf
 (&
¨gv
, "%s delete -inet6 %s/%d %s",

2047 
ROUTE_PATH
,

2048 
√tw‹k
, 
r6
->
√tbôs
, 
g©eway
 );

2050 
	`¨gv_msg
 (
D_ROUTE
, &
¨gv
);

2051 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "ERROR: NetBSDÑoute delete -inet6 command failed");

2054 
	`msg
 (
M_FATAL
, "Sorry, but I don't know howÅo do 'route ipv6' commands onÅhis operating system. TryÖutting yourÑoutes iná --route-down script");

2057 
	`¨gv_ª£t
 (&
¨gv
);

2058 
	`gc_‰ì
 (&
gc
);

2059 
	}
}

2066 #i‡
deföed
(
WIN32
)

2068 c⁄° 
MIB_IPFORWARDTABLE
 *

2069 
	$gë_wödows_routög_èbÀ
 (
gc_¨ía
 *
gc
)

2071 
ULONG
 
size
 = 0;

2072 
PMIB_IPFORWARDTABLE
 
π
 = 
NULL
;

2073 
DWORD
 
°©us
;

2075 
°©us
 = 
	`GëIpF‹w¨dTabÀ
 (
NULL
, &
size
, 
TRUE
);

2076 i‡(
°©us
 =
ERROR_INSUFFICIENT_BUFFER
)

2078 
π
 = (
PMIB_IPFORWARDTABLE
Ë
	`gc_mÆloc
 (
size
, 
Ál£
, 
gc
);

2079 
°©us
 = 
	`GëIpF‹w¨dTabÀ
 (
π
, &
size
, 
TRUE
);

2080 i‡(
°©us
 !
NO_ERROR
)

2082 
	`msg
 (
D_ROUTE
, "NOTE: GetIpForwardTableÑeturnedÉrror: %s (code=%u)",

2083 
	`°ªº‹_wö32
 (
°©us
, 
gc
),

2084 ()
°©us
);

2085 
π
 = 
NULL
;

2088  
π
;

2089 
	}
}

2092 
	$ã°_rouã
 (c⁄° 
IP_ADAPTER_INFO
 *
ad≠ãrs
,

2093 c⁄° 
ö_addr_t
 
g©eway
,

2094 
DWORD
 *
ödex
)

2096 
cou¡
 = 0;

2097 
DWORD
 
i
 = 
	`ad≠ãr_ödex_of_ù
 (
ad≠ãrs
, 
g©eway
, &
cou¡
, 
NULL
);

2098 i‡(
ödex
)

2099 *
ödex
 = 
i
;

2100  
cou¡
;

2101 
	}
}

2104 
	$ã°_rouã_hñ≥r
 (
boﬁ
 *
ªt
,

2105 *
cou¡
,

2106 *
good
,

2107 *
ambig
,

2108 c⁄° 
IP_ADAPTER_INFO
 *
ad≠ãrs
,

2109 c⁄° 
ö_addr_t
 
g©eway
)

2111 
c
;

2113 ++*
cou¡
;

2114 
c
 = 
	`ã°_rouã
 (
ad≠ãrs
, 
g©eway
, 
NULL
);

2115 i‡(
c
 == 0)

2116 *
ªt
 = 
Ál£
;

2118 ++*
good
;

2119 i‡(
c
 > 1)

2120 ++*
ambig
;

2121 
	}
}

2126 
boﬁ


2127 
	$ã°_rouãs
 (c⁄° 
rouã_li°
 *
æ
, c⁄° 
tu¡≠
 *
â
)

2129 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2130 c⁄° 
IP_ADAPTER_INFO
 *
ad≠ãrs
 = 
	`gë_ad≠ãr_öfo_li°
 (&
gc
);

2131 
boﬁ
 
ªt
 = 
Ál£
;

2132 
cou¡
 = 0;

2133 
good
 = 0;

2134 
ambig
 = 0;

2135 
boﬁ
 
ad≠ãr_up
 = 
Ál£
;

2137 i‡(
	`is_ad≠ãr_up
 (
â
, 
ad≠ãrs
))

2139 
ªt
 = 
åue
;

2140 
ad≠ãr_up
 = 
åue
;

2142 i‡(
æ
)

2144 
i
;

2145 
i
 = 0; i < 
æ
->
n
; ++i)

2146 
	`ã°_rouã_hñ≥r
 (&
ªt
, &
cou¡
, &
good
, &
ambig
, 
ad≠ãrs
, 
æ
->
rouãs
[
i
].
g©eway
);

2148 i‡((
æ
->
Êags
 & 
RG_ENABLE
Ë&& (æ->
•ec
.Êag†& 
RTSA_REMOTE_ENDPOINT
))

2149 
	`ã°_rouã_hñ≥r
 (&
ªt
, &
cou¡
, &
good
, &
ambig
, 
ad≠ãrs
, 
æ
->
•ec
.
ªmŸe_ídpoöt
);

2153 
	`msg
 (
D_ROUTE
, "TEST ROUTES: %d/%d succeededÜen=%dÑet=%dá=%d u/d=%s",

2154 
good
,

2155 
cou¡
,

2156 
æ
 ?Ñl->
n
 : -1,

2157 ()
ªt
,

2158 
ambig
,

2159 
ad≠ãr_up
 ? "up" : "down");

2161 
	`gc_‰ì
 (&
gc
);

2162  
ªt
;

2163 
	}
}

2165 c⁄° 
MIB_IPFORWARDROW
 *

2166 
	$gë_deÁu…_g©eway_row
 (c⁄° 
MIB_IPFORWARDTABLE
 *
rouãs
)

2168 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2169 
DWORD
 
lowe°_mëric
 = 
MAXDWORD
;

2170 c⁄° 
MIB_IPFORWARDROW
 *
ªt
 = 
NULL
;

2171 
i
;

2172 
be°
 = -1;

2174 i‡(
rouãs
)

2176 
i
 = 0; i < 
rouãs
->
dwNumE¡rõs
; ++i)

2178 c⁄° 
MIB_IPFORWARDROW
 *
row
 = &
rouãs
->
èbÀ
[
i
];

2179 c⁄° 
ö_addr_t
 
√t
 = 
	`¡ohl
 (
row
->
dwF‹w¨dDe°
);

2180 c⁄° 
ö_addr_t
 
mask
 = 
	`¡ohl
 (
row
->
dwF‹w¨dMask
);

2181 c⁄° 
DWORD
 
ödex
 = 
row
->
dwF‹w¨dIfIndex
;

2182 c⁄° 
DWORD
 
mëric
 = 
row
->
dwF‹w¨dMëric1
;

2184 
	`dmsg
 (
D_ROUTE_DEBUG
, "GDGR:Ñoute[%d] %s/%s i=%d m=%d",

2185 
i
,

2186 
	`¥öt_ö_addr_t
 ((
ö_addr_t
Ë
√t
, 0, &
gc
),

2187 
	`¥öt_ö_addr_t
 ((
ö_addr_t
Ë
mask
, 0, &
gc
),

2188 ()
ödex
,

2189 ()
mëric
);

2191 i‡(!
√t
 && !
mask
 && 
mëric
 < 
lowe°_mëric
)

2193 
ªt
 = 
row
;

2194 
lowe°_mëric
 = 
mëric
;

2195 
be°
 = 
i
;

2200 
	`dmsg
 (
D_ROUTE_DEBUG
, "GDGR: be°=%dÜm=%u", 
be°
, ()
lowe°_mëric
);

2202 
	`gc_‰ì
 (&
gc
);

2203  
ªt
;

2204 
	}
}

2207 
	$gë_deÁu…_g©eway
 (
rouã_g©eway_öfo
 *
rgi
)

2209 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2211 c⁄° 
IP_ADAPTER_INFO
 *
ad≠ãrs
 = 
	`gë_ad≠ãr_öfo_li°
 (&
gc
);

2212 c⁄° 
MIB_IPFORWARDTABLE
 *
rouãs
 = 
	`gë_wödows_routög_èbÀ
 (&
gc
);

2213 c⁄° 
MIB_IPFORWARDROW
 *
row
 = 
	`gë_deÁu…_g©eway_row
 (
rouãs
);

2214 
DWORD
 
a_ödex
;

2215 c⁄° 
IP_ADAPTER_INFO
 *
ai
;

2217 
	`CLEAR
(*
rgi
);

2219 i‡(
row
)

2221 
rgi
->
g©eway
.
addr
 = 
	`¡ohl
 (
row
->
dwF‹w¨dNextH›
);

2222 i‡(
rgi
->
g©eway
.
addr
)

2224 
rgi
->
Êags
 |
RGI_ADDR_DEFINED
;

2225 
a_ödex
 = 
	`ad≠ãr_ödex_of_ù
 (
ad≠ãrs
, 
rgi
->
g©eway
.
addr
, 
NULL
, &rgi->g©eway.
√tmask
);

2226 i‡(
a_ödex
 !
TUN_ADAPTER_INDEX_INVALID
)

2228 
rgi
->
ad≠ãr_ödex
 = 
a_ödex
;

2229 
rgi
->
Êags
 |(
RGI_IFACE_DEFINED
|
RGI_NETMASK_DEFINED
);

2230 
ai
 = 
	`gë_ad≠ãr
 (
ad≠ãrs
, 
a_ödex
);

2231 i‡(
ai
)

2233 
	`mem˝y
 (
rgi
->
hwaddr
, 
ai
->
Addªss
, 6);

2234 
rgi
->
Êags
 |
RGI_HWADDR_DEFINED
;

2240 
	`gc_‰ì
 (&
gc
);

2241 
	}
}

2243 
DWORD


2244 
	$wödows_rouã_föd_if_ödex
 (c⁄° 
rouã_ùv4
 *
r
, c⁄° 
tu¡≠
 *
â
)

2246 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2247 
DWORD
 
ªt
 = 
TUN_ADAPTER_INDEX_INVALID
;

2248 
cou¡
 = 0;

2249 c⁄° 
IP_ADAPTER_INFO
 *
ad≠ãrs
 = 
	`gë_ad≠ãr_öfo_li°
 (&
gc
);

2250 c⁄° 
IP_ADAPTER_INFO
 *
tun_ad≠ãr
 = 
	`gë_tun_ad≠ãr
 (
â
, 
ad≠ãrs
);

2251 
boﬁ
 
⁄_tun
 = 
Ál£
;

2254 i‡(
	`is_ù_ö_ad≠ãr_sub√t
 (
tun_ad≠ãr
, 
r
->
g©eway
, 
NULL
))

2256 
ªt
 = 
tun_ad≠ãr
->
Index
;

2257 
cou¡
 = 1;

2258 
⁄_tun
 = 
åue
;

2262 
cou¡
 = 
	`ã°_rouã
 (
ad≠ãrs
, 
r
->
g©eway
, &
ªt
);

2265 i‡(
cou¡
 == 0)

2267 
	`msg
 (
M_WARN
, "Warning:Ñoute gateway isÇotÑeachable onányáctiveÇetworkádapters: %s",

2268 
	`¥öt_ö_addr_t
 (
r
->
g©eway
, 0, &
gc
));

2269 
ªt
 = 
TUN_ADAPTER_INDEX_INVALID
;

2271 i‡(
cou¡
 > 1)

2273 
	`msg
 (
M_WARN
, "Warning:Ñoute gateway isámbiguous: %s (%d matches)",

2274 
	`¥öt_ö_addr_t
 (
r
->
g©eway
, 0, &
gc
),

2275 
cou¡
);

2276 
ªt
 = 
TUN_ADAPTER_INDEX_INVALID
;

2279 
	`dmsg
 (
D_ROUTE_DEBUG
, "DEBUG:Ñoute find if: on_tun=%d count=%d index=%d",

2280 
⁄_tun
,

2281 
cou¡
,

2282 ()
ªt
);

2284 
	`gc_‰ì
 (&
gc
);

2285  
ªt
;

2286 
	}
}

2288 
boﬁ


2289 
	$add_rouã_ù≠i
 (c⁄° 
rouã_ùv4
 *
r
, c⁄° 
tu¡≠
 *
â
, 
DWORD
 
ad≠ãr_ödex
)

2291 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2292 
boﬁ
 
ªt
 = 
Ál£
;

2293 
DWORD
 
°©us
;

2294 c⁄° 
DWORD
 
if_ödex
 = (
ad≠ãr_ödex
 =
TUN_ADAPTER_INDEX_INVALID
Ë? 
	`wödows_rouã_föd_if_ödex
 (
r
, 
â
) :ádapter_index;

2296 i‡(
if_ödex
 !
TUN_ADAPTER_INDEX_INVALID
)

2298 
MIB_IPFORWARDROW
 
‰
;

2299 
	`CLEAR
 (
‰
);

2300 
‰
.
dwF‹w¨dDe°
 = 
	`ht⁄l
 (
r
->
√tw‹k
);

2301 
‰
.
dwF‹w¨dMask
 = 
	`ht⁄l
 (
r
->
√tmask
);

2302 
‰
.
dwF‹w¨dPﬁicy
 = 0;

2303 
‰
.
dwF‹w¨dNextH›
 = 
	`ht⁄l
 (
r
->
g©eway
);

2304 
‰
.
dwF‹w¨dIfIndex
 = 
if_ödex
;

2305 
‰
.
dwF‹w¨dTy≥
 = 4;

2306 
‰
.
dwF‹w¨dPrŸo
 = 3;

2307 
‰
.
dwF‹w¨dAge
 = 0;

2308 
‰
.
dwF‹w¨dNextH›AS
 = 0;

2309 
‰
.
dwF‹w¨dMëric1
 = (
r
->
Êags
 & 
RT_METRIC_DEFINED
Ë?Ñ->
mëric
 : 1;

2310 
‰
.
dwF‹w¨dMëric2
 = 
METRIC_NOT_USED
;

2311 
‰
.
dwF‹w¨dMëric3
 = 
METRIC_NOT_USED
;

2312 
‰
.
dwF‹w¨dMëric4
 = 
METRIC_NOT_USED
;

2313 
‰
.
dwF‹w¨dMëric5
 = 
METRIC_NOT_USED
;

2315 i‡((
r
->
√tw‹k
 &Ñ->
√tmask
) !=Ñ->network)

2316 
	`msg
 (
M_WARN
, "Warning:áddress %s isÇotáÇetworkáddress inÑelationÅoÇetmask %s",

2317 
	`¥öt_ö_addr_t
 (
r
->
√tw‹k
, 0, &
gc
),

2318 
	`¥öt_ö_addr_t
 (
r
->
√tmask
, 0, &
gc
));

2320 
°©us
 = 
	`Cª©eIpF‹w¨dE¡ry
 (&
‰
);

2322 i‡(
°©us
 =
NO_ERROR
)

2323 
ªt
 = 
åue
;

2327 c⁄° 
f‹w¨d_mëric_limô
 = 2048;

2329  ; 
‰
.
dwF‹w¨dMëric1
 <
f‹w¨d_mëric_limô
; ++fr.dwForwardMetric1)

2333 
‰
.
dwF‹w¨dTy≥
 = 4; fr.dwForwardType >= 3; --fr.dwForwardType)

2335 
°©us
 = 
	`Cª©eIpF‹w¨dE¡ry
 (&
‰
);

2336 i‡(
°©us
 =
NO_ERROR
)

2338 
	`msg
 (
D_ROUTE
, "ROUTE: CreateIpForwardEntry succeeded with dwForwardMetric1=%uánd dwForwardType=%u",

2339 ()
‰
.
dwF‹w¨dMëric1
,

2340 ()
‰
.
dwF‹w¨dTy≥
);

2341 
ªt
 = 
åue
;

2342 
doubÀbªak
;

2344 i‡(
°©us
 !
ERROR_BAD_ARGUMENTS
)

2345 
doubÀbªak
;

2349 
doubÀbªak
:

2350 i‡(
°©us
 !
NO_ERROR
)

2351 
	`msg
 (
M_WARN
, "ROUTE:Ñouteáddition failed using CreateIpForwardEntry: %s [status=%u if_index=%u]",

2352 
	`°ªº‹_wö32
 (
°©us
, &
gc
),

2353 ()
°©us
,

2354 ()
if_ödex
);

2358 
	`gc_‰ì
 (&
gc
);

2359  
ªt
;

2360 
	}
}

2362 
boﬁ


2363 
	$dñ_rouã_ù≠i
 (c⁄° 
rouã_ùv4
 *
r
, c⁄° 
tu¡≠
 *
â
)

2365 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2366 
boﬁ
 
ªt
 = 
Ál£
;

2367 
DWORD
 
°©us
;

2368 c⁄° 
DWORD
 
if_ödex
 = 
	`wödows_rouã_föd_if_ödex
 (
r
, 
â
);

2370 i‡(
if_ödex
 !
TUN_ADAPTER_INDEX_INVALID
)

2372 
MIB_IPFORWARDROW
 
‰
;

2373 
	`CLEAR
 (
‰
);

2375 
‰
.
dwF‹w¨dDe°
 = 
	`ht⁄l
 (
r
->
√tw‹k
);

2376 
‰
.
dwF‹w¨dMask
 = 
	`ht⁄l
 (
r
->
√tmask
);

2377 
‰
.
dwF‹w¨dPﬁicy
 = 0;

2378 
‰
.
dwF‹w¨dNextH›
 = 
	`ht⁄l
 (
r
->
g©eway
);

2379 
‰
.
dwF‹w¨dIfIndex
 = 
if_ödex
;

2381 
°©us
 = 
	`DñëeIpF‹w¨dE¡ry
 (&
‰
);

2383 i‡(
°©us
 =
NO_ERROR
)

2384 
ªt
 = 
åue
;

2386 
	`msg
 (
M_WARN
, "ROUTE:Ñoute deletion failed using DeleteIpForwardEntry: %s",

2387 
	`°ªº‹_wö32
 (
°©us
, &
gc
));

2390 
	`gc_‰ì
 (&
gc
);

2391  
ªt
;

2392 
	}
}

2395 
	$f‹m©_rouã_íåy
 (c⁄° 
MIB_IPFORWARDROW
 *
r
, 
gc_¨ía
 *
gc
)

2397 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

2398 
	`buf_¥ötf
 (&
out
, "%s %s %sÖ=%d i=%dÅ=%dÖr=%dá=%d h=%d m=%d/%d/%d/%d/%d",

2399 
	`¥öt_ö_addr_t
 (
r
->
dwF‹w¨dDe°
, 
IA_NET_ORDER
, 
gc
),

2400 
	`¥öt_ö_addr_t
 (
r
->
dwF‹w¨dMask
, 
IA_NET_ORDER
, 
gc
),

2401 
	`¥öt_ö_addr_t
 (
r
->
dwF‹w¨dNextH›
, 
IA_NET_ORDER
, 
gc
),

2402 ()
r
->
dwF‹w¨dPﬁicy
,

2403 ()
r
->
dwF‹w¨dIfIndex
,

2404 ()
r
->
dwF‹w¨dTy≥
,

2405 ()
r
->
dwF‹w¨dPrŸo
,

2406 ()
r
->
dwF‹w¨dAge
,

2407 ()
r
->
dwF‹w¨dNextH›AS
,

2408 ()
r
->
dwF‹w¨dMëric1
,

2409 ()
r
->
dwF‹w¨dMëric2
,

2410 ()
r
->
dwF‹w¨dMëric3
,

2411 ()
r
->
dwF‹w¨dMëric4
,

2412 ()
r
->
dwF‹w¨dMëric5
);

2413  
	`BSTR
 (&
out
);

2414 
	}
}

2420 
	$show_rouãs
 (
msgÀv
)

2422 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2423 
i
;

2425 c⁄° 
MIB_IPFORWARDTABLE
 *
π
 = 
	`gë_wödows_routög_èbÀ
 (&
gc
);

2427 
	`msg
 (
msgÀv
, "SYSTEM ROUTING TABLE");

2428 i‡(
π
)

2430 
i
 = 0; i < 
π
->
dwNumE¡rõs
; ++i)

2432 
	`msg
 (
msgÀv
, "%s", 
	`f‹m©_rouã_íåy
 (&
π
->
èbÀ
[
i
], &
gc
));

2435 
	`gc_‰ì
 (&
gc
);

2436 
	}
}

2438 #ñi‡
deföed
(
TARGET_LINUX
)

2441 
	$gë_deÁu…_g©eway
 (
rouã_g©eway_öfo
 *
rgi
)

2443 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2444 
sd
 = -1;

2445 
be°_«me
[16];

2446 
be°_«me
[0] = 0;

2448 
	`CLEAR
(*
rgi
);

2452 
FILE
 *
Â
 = 
	`f›í
 ("/proc/net/route", "r");

2453 i‡(
Â
)

2455 
löe
[256];

2456 
cou¡
 = 0;

2457 
lowe°_mëric
 = 
UINT_MAX
;

2458 
ö_addr_t
 
be°_gw
 = 0;

2459 
boﬁ
 
found
 = 
Ál£
;

2460 
	`fgës
 (
löe
,  (löe), 
Â
Ë!
NULL
)

2462 i‡(
cou¡
)

2464 
√t_x
 = 0;

2465 
mask_x
 = 0;

2466 
gw_x
 = 0;

2467 
mëric
 = 0;

2468 
Êags
 = 0;

2469 
«me
[16];

2470 
«me
[0] = 0;

2471 c⁄° 
≈
 = 
	`ssˇnf
 (
löe
, "%15s\t%x\t%x\t%x\t%*s\t%*s\t%d\t%x",

2472 
«me
,

2473 &
√t_x
,

2474 &
gw_x
,

2475 &
Êags
,

2476 &
mëric
,

2477 &
mask_x
);

2478 i‡(
≈
 =6 && (
Êags
 & 
IFF_UP
))

2480 c⁄° 
ö_addr_t
 
√t
 = 
	`¡ohl
 (
√t_x
);

2481 c⁄° 
ö_addr_t
 
mask
 = 
	`¡ohl
 (
mask_x
);

2482 c⁄° 
ö_addr_t
 
gw
 = 
	`¡ohl
 (
gw_x
);

2484 i‡(!
√t
 && !
mask
 && 
mëric
 < 
lowe°_mëric
)

2486 
found
 = 
åue
;

2487 
be°_gw
 = 
gw
;

2488 
	`°r˝y
 (
be°_«me
, 
«me
);

2489 
lowe°_mëric
 = 
mëric
;

2493 ++
cou¡
;

2495 
	`f˛o£
 (
Â
);

2497 i‡(
found
)

2499 
rgi
->
g©eway
.
addr
 = 
be°_gw
;

2500 
rgi
->
Êags
 |
RGI_ADDR_DEFINED
;

2501 i‡(!
rgi
->
g©eway
.
addr
 && 
be°_«me
[0])

2502 
rgi
->
Êags
 |
RGI_ON_LINK
;

2508 i‡(
rgi
->
Êags
 & 
RGI_ADDR_DEFINED
)

2510 
i‰eq
 *
i‰
, *
i„nd
;

2511 
ö_addr_t
 
addr
, 
√tmask
;

2512 
i‰eq
 ifreq;

2513 
ifc⁄f
 
ifc
;

2514 
i‰eq
 
ifs
[20];

2516 i‡((
sd
 = 
	`sockë
 (
AF_INET
, 
SOCK_DGRAM
, 0)) < 0)

2518 
	`msg
 (
M_WARN
, "GDG: socket() failed");

2519 
d⁄e
;

2521 
ifc
.
ifc_Àn
 =  (
ifs
);

2522 
ifc
.
ifc_ªq
 = 
ifs
;

2523 i‡(
	`io˘l
 (
sd
, 
SIOCGIFCONF
, &
ifc
) < 0)

2525 
	`msg
 (
M_WARN
, "GDG: ioctl(SIOCGIFCONF) failed");

2526 
d⁄e
;

2530 
i„nd
 = 
ifs
 + (
ifc
.
ifc_Àn
 /  (
i‰eq
));

2531 
i‰
 = 
ifc
.
ifc_ªq
; i‰ < 
i„nd
; ifr++)

2533 i‡(
i‰
->
i‰_addr
.
ß_Ámûy
 =
AF_INET
)

2536 
addr
 = 
	`¡ohl
(((
sockaddr_ö
 *Ë&
i‰
->
i‰_addr
)->
sö_addr
.
s_addr
);

2539 
	`°∫˝y¡
 (
i‰eq
.
i‰_«me
, 
i‰
->ifr_name,  (ifreq.ifr_name));

2542 i‡(
	`io˘l
 (
sd
, 
SIOCGIFFLAGS
, &
i‰eq
) < 0)

2544 i‡(!(
i‰eq
.
i‰_Êags
 & 
IFF_UP
))

2547 i‡(
rgi
->
Êags
 & 
RGI_ON_LINK
)

2551 i‡(
	`°rcmp
(
i‰eq
.
i‰_«me
, 
be°_«me
))

2555 i‡((
i‰eq
.
i‰_Êags
 & 
IFF_POINTOPOINT
Ë&& 
	`io˘l
 (
sd
, 
SIOCGIFDSTADDR
, &ifreq) >= 0)

2557 
rgi
->
g©eway
.
addr
 = 
	`¡ohl
(((
sockaddr_ö
 *Ë&
i‰eq
.
i‰_addr
)->
sö_addr
.
s_addr
);

2558 i‡(
rgi
->
g©eway
.
addr
)

2559 
rgi
->
Êags
 &~
RGI_ON_LINK
;

2566 i‡(
	`io˘l
 (
sd
, 
SIOCGIFNETMASK
, &
i‰eq
) < 0)

2568 
√tmask
 = 
	`¡ohl
(((
sockaddr_ö
 *Ë&
i‰eq
.
i‰_addr
)->
sö_addr
.
s_addr
);

2571 i‡(((
rgi
->
g©eway
.
addr
 ^áddrË& 
√tmask
) != 0)

2575 
rgi
->
g©eway
.
√tmask
 =Çetmask;

2576 
rgi
->
Êags
 |
RGI_NETMASK_DEFINED
;

2580 
	`°∫˝y¡
 (
rgi
->
iÁ˚
, 
i‰eq
.
i‰_«me
, (rgi->iface));

2581 
rgi
->
Êags
 |
RGI_IFACE_DEFINED
;

2584 
	`mem£t
 (&
i‰eq
.
i‰_hwaddr
, 0,  (
sockaddr
));

2585 i‡(
	`io˘l
 (
sd
, 
SIOCGIFHWADDR
, &
i‰eq
) < 0)

2587 
	`msg
 (
M_WARN
, "GDG: SIOCGIFHWADDR(%sËÁûed", 
i‰eq
.
i‰_«me
);

2588 
d⁄e
;

2590 
	`mem˝y
 (
rgi
->
hwaddr
, &
i‰eq
.
i‰_hwaddr
.
ß_d©a
, 6);

2591 
rgi
->
Êags
 |
RGI_HWADDR_DEFINED
;

2598 
d⁄e
:

2599 i‡(
sd
 >= 0)

2600 
	`˛o£
 (
sd
);

2601 
	`gc_‰ì
 (&
gc
);

2602 
	}
}

2604 #ñi‡
deföed
(
TARGET_FREEBSD
)||deföed(
TARGET_DRAGONFLY
)

2606 
	~<sys/ty≥s.h
>

2607 
	~<sys/sockë.h
>

2608 
	~<√töë/ö.h
>

2609 
	~<√t/rouã.h
>

2612 
π_msghdr
 
	mm_πm
;

2613 
	mm_•a˚
[512];

2614 } 
	gm_πmsg
;

2616 
	#ROUNDUP
(
a
) \

2617 ((
a
Ë> 0 ? (1 + ((◊Ë- 1Ë| ((Ë- 1))Ë: ())

	)

2623 
	$gë_deÁu…_g©eway
 (
rouã_g©eway_öfo
 *
rgi
)

2625 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2626 
s
, 
£q
, 
l
, 
pid
, 
πm_addrs
, 
i
;

2627 
sockaddr
 
so_d°
, 
so_mask
;

2628 *
˝
 = 
m_πmsg
.
m_•a˚
;

2629 
sockaddr
 *
g©e
 = 
NULL
, *
ß
;

2630 
π_msghdr
 *
πm_aux
;

2632 
	#NEXTADDR
(
w
, 
u
) \

2633 i‡(
πm_addrs
 & (
w
)) {\

2634 
l
 = 
	`ROUNDUP
(
u
.
ß_Àn
); 
	`memmove
(
˝
, &(u),Ü); cp +=Ü;\

2635 }

	)

2637 
	#ADVANCE
(
x
, 
n
Ë(x +
	`ROUNDUP
(“)->
ß_Àn
))

	)

2639 
	#πm
 
m_πmsg
.
m_πm


	)

2641 
	`CLEAR
(*
rgi
);

2643 
pid
 = 
	`gëpid
();

2644 
£q
 = 0;

2645 
πm_addrs
 = 
RTA_DST
 | 
RTA_NETMASK
;

2647 
	`bzîo
(&
so_d°
, (so_dst));

2648 
	`bzîo
(&
so_mask
, (so_mask));

2649 
	`bzîo
(&
πm
, (
π_msghdr
));

2651 
πm
.
πm_ty≥
 = 
RTM_GET
;

2652 
πm
.
πm_Êags
 = 
RTF_UP
 | 
RTF_GATEWAY
;

2653 
πm
.
πm_vîsi⁄
 = 
RTM_VERSION
;

2654 
πm
.
πm_£q
 = ++
£q
;

2655 
πm
.
πm_addrs
 =Ñtm_addrs;

2657 
so_d°
.
ß_Ámûy
 = 
AF_INET
;

2658 
so_d°
.
ß_Àn
 = (
sockaddr_ö
);

2659 
so_mask
.
ß_Ámûy
 = 
AF_INET
;

2660 
so_mask
.
ß_Àn
 = (
sockaddr_ö
);

2662 
	`NEXTADDR
(
RTA_DST
, 
so_d°
);

2663 
	`NEXTADDR
(
RTA_NETMASK
, 
so_mask
);

2665 
πm
.
πm_msgÀn
 = 
l
 = 
˝
 - (*)&
m_πmsg
;

2667 
s
 = 
	`sockë
(
PF_ROUTE
, 
SOCK_RAW
, 0);

2669 i‡(
	`wrôe
(
s
, (*)&
m_πmsg
, 
l
) < 0)

2671 
	`msg
(
M_WARN
|
M_ERRNO
, "CouldÇotÑetrieve default gateway fromÑoute socket:");

2672 
	`gc_‰ì
 (&
gc
);

2673 
	`˛o£
(
s
);

2678 
l
 = 
	`ªad
(
s
, (*)&
m_πmsg
, (m_rtmsg));

2679 } 
l
 > 0 && (
πm
.
πm_£q
 !
£q
 ||Ñtm.
πm_pid
 !
pid
));

2681 
	`˛o£
(
s
);

2683 
πm_aux
 = &
πm
;

2685 
˝
 = ((*)(
πm_aux
 + 1));

2686 i‡(
πm_aux
->
πm_addrs
) {

2687 
i
 = 1; i; i <<= 1)

2688 i‡(
i
 & 
πm_aux
->
πm_addrs
) {

2689 
ß
 = (
sockaddr
 *)
˝
;

2690 i‡(
i
 =
RTA_GATEWAY
 )

2691 
g©e
 = 
ß
;

2692 
	`ADVANCE
(
˝
, 
ß
);

2697 
	`gc_‰ì
 (&
gc
);

2702 i‡(
g©e
 !
NULL
 )

2704 
rgi
->
g©eway
.
addr
 = 
	`¡ohl
(((
sockaddr_ö
 *)
g©e
)->
sö_addr
.
s_addr
);

2705 
rgi
->
Êags
 |
RGI_ADDR_DEFINED
;

2707 
	`gc_‰ì
 (&
gc
);

2711 
	`gc_‰ì
 (&
gc
);

2713 
	}
}

2715 #ñi‡
deföed
(
TARGET_DARWIN
)

2717 
	~<sys/ty≥s.h
>

2718 
	~<sys/sockë.h
>

2719 
	~<√töë/ö.h
>

2720 
	~<√t/rouã.h
>

2721 
	~<√t/if_dl.h
>

2723 
	sπmsg
 {

2724 
π_msghdr
 
	mm_πm
;

2725 
	mm_•a˚
[512];

2728 
	#ROUNDUP
(
a
) \

2729 ((
a
Ë> 0 ? (1 + ((◊Ë- 1Ë| ((
uöt32_t
Ë- 1))Ë: (uöt32_t))

	)

2731 
	#NEXTADDR
(
w
, 
u
) \

2732 i‡(
πm_addrs
 & (
w
)) {\

2733 
l
 = 
	`ROUNDUP
(
u
.
ß_Àn
); 
	`memmove
(
˝
, &(u),Ü); cp +=Ü;\

2734 }

	)

2736 
	#ADVANCE
(
x
, 
n
Ë(x +
	`ROUNDUP
(“)->
ß_Àn
))

	)

2738 
	#max
(
a
,
b
Ë(◊Ë> (bË? (aË: (b))

	)

2741 
	$gë_deÁu…_g©eway
 (
rouã_g©eway_öfo
 *
rgi
)

2743 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2744 
πmsg
 
m_πmsg
;

2745 
sockfd
 = -1;

2746 
£q
, 
l
, 
pid
, 
πm_addrs
, 
i
;

2747 
sockaddr
 
so_d°
, 
so_mask
;

2748 *
˝
 = 
m_πmsg
.
m_•a˚
;

2749 
sockaddr
 *
g©e
 = 
NULL
, *
iÂ
 = NULL, *
ß
;

2750 
π_msghdr
 *
πm_aux
;

2752 
	#πm
 
m_πmsg
.
m_πm


	)

2754 
	`CLEAR
(*
rgi
);

2757 
pid
 = 
	`gëpid
();

2758 
£q
 = 0;

2759 
πm_addrs
 = 
RTA_DST
 | 
RTA_NETMASK
 | 
RTA_IFP
;

2761 
	`bzîo
(&
m_πmsg
, (m_rtmsg));

2762 
	`bzîo
(&
so_d°
, (so_dst));

2763 
	`bzîo
(&
so_mask
, (so_mask));

2764 
	`bzîo
(&
πm
, (
π_msghdr
));

2766 
πm
.
πm_ty≥
 = 
RTM_GET
;

2767 
πm
.
πm_Êags
 = 
RTF_UP
 | 
RTF_GATEWAY
;

2768 
πm
.
πm_vîsi⁄
 = 
RTM_VERSION
;

2769 
πm
.
πm_£q
 = ++
£q
;

2770 
πm
.
πm_addrs
 =Ñtm_addrs;

2772 
so_d°
.
ß_Ámûy
 = 
AF_INET
;

2773 
so_d°
.
ß_Àn
 = (
sockaddr_ö
);

2774 
so_mask
.
ß_Ámûy
 = 
AF_INET
;

2775 
so_mask
.
ß_Àn
 = (
sockaddr_ö
);

2777 
	`NEXTADDR
(
RTA_DST
, 
so_d°
);

2778 
	`NEXTADDR
(
RTA_NETMASK
, 
so_mask
);

2780 
πm
.
πm_msgÀn
 = 
l
 = 
˝
 - (*)&
m_πmsg
;

2783 
sockfd
 = 
	`sockë
(
PF_ROUTE
, 
SOCK_RAW
, 0);

2784 i‡(
sockfd
 < 0)

2786 
	`msg
 (
M_WARN
, "GDG: socket #1 failed");

2787 
d⁄e
;

2789 i‡(
	`wrôe
(
sockfd
, (*)&
m_πmsg
, 
l
) < 0)

2791 
	`msg
 (
M_WARN
, "GDG:Öroblem writingÅoÑouting socket");

2792 
d⁄e
;

2795 
l
 = 
	`ªad
(
sockfd
, (*)&
m_πmsg
, (m_rtmsg));

2796 } 
l
 > 0 && (
πm
.
πm_£q
 !
£q
 ||Ñtm.
πm_pid
 !
pid
));

2797 
	`˛o£
(
sockfd
);

2798 
sockfd
 = -1;

2801 
πm_aux
 = &
πm
;

2802 
˝
 = ((*)(
πm_aux
 + 1));

2803 i‡(
πm_aux
->
πm_addrs
)

2805 
i
 = 1; i; i <<= 1)

2807 i‡(
i
 & 
πm_aux
->
πm_addrs
)

2809 
ß
 = (
sockaddr
 *)
˝
;

2810 i‡(
i
 =
RTA_GATEWAY
 )

2811 
g©e
 = 
ß
;

2812 i‡(
i
 =
RTA_IFP
)

2813 
iÂ
 = 
ß
;

2814 
	`ADVANCE
(
˝
, 
ß
);

2819 
d⁄e
;

2822 i‡(
g©e
 !
NULL
 )

2825 
rgi
->
g©eway
.
addr
 = 
	`¡ohl
(((
sockaddr_ö
 *)
g©e
)->
sö_addr
.
s_addr
);

2826 i‡(
rgi
->
g©eway
.
addr
)

2827 
rgi
->
Êags
 |
RGI_ADDR_DEFINED
;

2829 i‡(
iÂ
)

2832 c⁄° 
sockaddr_dl
 *
adl
 = (sockaddr_d»*Ë
iÂ
;

2833 
Àn
 = 
adl
->
sdl_∆í
;

2834 i‡(
adl
->
sdl_∆í
 &&ádl->sdl_∆í < (
rgi
->
iÁ˚
))

2836 
	`mem˝y
 (
rgi
->
iÁ˚
, 
adl
->
sdl_d©a
,ádl->
sdl_∆í
);

2837 
rgi
->
iÁ˚
[
adl
->
sdl_∆í
] = '\0';

2838 
rgi
->
Êags
 |
RGI_IFACE_DEFINED
;

2844 i‡(
rgi
->
Êags
 & 
RGI_IFACE_DEFINED
) {

2845 
i‰eq
 
i‰
;

2847 
sockfd
 = 
	`sockë
(
AF_INET
, 
SOCK_DGRAM
, 0);

2848 i‡(
sockfd
 < 0)

2850 
	`msg
 (
M_WARN
, "GDG: socket #2 failed");

2851 
d⁄e
;

2854 
	`CLEAR
(
i‰
);

2855 
i‰
.
i‰_addr
.
ß_Ámûy
 = 
AF_INET
;

2856 
	`°∫˝y¡
(
i‰
.
i‰_«me
, 
rgi
->
iÁ˚
, 
IFNAMSIZ
);

2858 i‡(
	`io˘l
(
sockfd
, 
SIOCGIFNETMASK
, (*)&
i‰
) < 0)

2860 
	`msg
 (
M_WARN
, "GDG: ioctl #1 failed");

2861 
d⁄e
;

2863 
	`˛o£
(
sockfd
);

2864 
sockfd
 = -1;

2866 
rgi
->
g©eway
.
√tmask
 = 
	`¡ohl
(((
sockaddr_ö
 *)&
i‰
.
i‰_addr
)->
sö_addr
.
s_addr
);

2867 
rgi
->
Êags
 |
RGI_NETMASK_DEFINED
;

2871 i‡(
rgi
->
Êags
 & 
RGI_IFACE_DEFINED
)

2873 
ifc⁄f
 
ifc
;

2874 
i‰eq
 *
i‰
;

2875 c⁄° 
bufsize
 = 4096;

2876 *
buf„r
;

2878 
buf„r
 = (*Ë
	`gc_mÆloc
 (
bufsize
, 
åue
, &
gc
);

2879 
sockfd
 = 
	`sockë
(
AF_INET
, 
SOCK_DGRAM
, 0);

2880 i‡(
sockfd
 < 0)

2882 
	`msg
 (
M_WARN
, "GDG: socket #3 failed");

2883 
d⁄e
;

2886 
ifc
.
ifc_Àn
 = 
bufsize
;

2887 
ifc
.
ifc_buf
 = 
buf„r
;

2889 i‡(
	`io˘l
(
sockfd
, 
SIOCGIFCONF
, (*)&
ifc
) < 0)

2891 
	`msg
 (
M_WARN
, "GDG: ioctl #2 failed");

2892 
d⁄e
;

2894 
	`˛o£
(
sockfd
);

2895 
sockfd
 = -1;

2897 
˝
 = 
buf„r
; c∞<buf„∏+ 
ifc
.
ifc_Àn
 - (
i‰eq
); )

2899 
i‰
 = (
i‰eq
 *)
˝
;

2900 c⁄° 
size_t
 
Àn
 = (
i‰
->
i‰_«me
Ë+ 
	`max
((i‰->
i‰_addr
), i‰->i‰_addr.
ß_Àn
);

2901 i‡(!
i‰
->
i‰_addr
.
ß_Ámûy
)

2903 i‡(!
	`°∫cmp
(
i‰
->
i‰_«me
, 
rgi
->
iÁ˚
, 
IFNAMSIZ
))

2905 i‡(
i‰
->
i‰_addr
.
ß_Ámûy
 =
AF_LINK
)

2907 
sockaddr_dl
 *
sdl
 = (sockaddr_d»*)&
i‰
->
i‰_addr
;

2908 
	`mem˝y
(
rgi
->
hwaddr
, 
	`LLADDR
(
sdl
), 6);

2909 
rgi
->
Êags
 |
RGI_HWADDR_DEFINED
;

2912 
˝
 +
Àn
;

2916 
d⁄e
:

2917 i‡(
sockfd
 >= 0)

2918 
	`˛o£
(
sockfd
);

2919 
	`gc_‰ì
 (&
gc
);

2920 
	}
}

2922 #unde‡
max


2924 #ñi‡
deföed
(
TARGET_OPENBSD
Ë|| deföed(
TARGET_NETBSD
)

2926 
	~<sys/ty≥s.h
>

2927 
	~<sys/sockë.h
>

2928 
	~<√töë/ö.h
>

2929 
	~<√t/rouã.h
>

2932 
π_msghdr
 
	mm_πm
;

2933 
	mm_•a˚
[512];

2934 } 
	gm_πmsg
;

2936 
	#ROUNDUP
(
a
) \

2937 ((
a
Ë> 0 ? (1 + ((◊Ë- 1Ë| ((Ë- 1))Ë: ())

	)

2943 
	$gë_deÁu…_g©eway
 (
rouã_g©eway_öfo
 *
rgi
)

2945 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2946 
s
, 
£q
, 
l
, 
πm_addrs
, 
i
;

2947 
pid_t
 
pid
;

2948 
sockaddr
 
so_d°
, 
so_mask
;

2949 *
˝
 = 
m_πmsg
.
m_•a˚
;

2950 
sockaddr
 *
g©e
 = 
NULL
, *
ß
;

2951 
π_msghdr
 *
πm_aux
;

2953 
	#NEXTADDR
(
w
, 
u
) \

2954 i‡(
πm_addrs
 & (
w
)) {\

2955 
l
 = 
	`ROUNDUP
(
u
.
ß_Àn
); 
	`memmove
(
˝
, &(u),Ü); cp +=Ü;\

2956 }

	)

2958 
	#ADVANCE
(
x
, 
n
Ë(x +
	`ROUNDUP
(“)->
ß_Àn
))

	)

2960 
	#πm
 
m_πmsg
.
m_πm


	)

2962 
	`CLEAR
(*
rgi
);

2964 
pid
 = 
	`gëpid
();

2965 
£q
 = 0;

2966 
πm_addrs
 = 
RTA_DST
 | 
RTA_NETMASK
;

2968 
	`bzîo
(&
so_d°
, (so_dst));

2969 
	`bzîo
(&
so_mask
, (so_mask));

2970 
	`bzîo
(&
πm
, (
π_msghdr
));

2972 
πm
.
πm_ty≥
 = 
RTM_GET
;

2973 
πm
.
πm_Êags
 = 
RTF_UP
 | 
RTF_GATEWAY
;

2974 
πm
.
πm_vîsi⁄
 = 
RTM_VERSION
;

2975 
πm
.
πm_£q
 = ++
£q
;

2976 
πm
.
πm_addrs
 =Ñtm_addrs;

2978 
so_d°
.
ß_Ámûy
 = 
AF_INET
;

2979 
so_d°
.
ß_Àn
 = (
sockaddr_ö
);

2980 
so_mask
.
ß_Ámûy
 = 
AF_INET
;

2981 
so_mask
.
ß_Àn
 = (
sockaddr_ö
);

2983 
	`NEXTADDR
(
RTA_DST
, 
so_d°
);

2984 
	`NEXTADDR
(
RTA_NETMASK
, 
so_mask
);

2986 
πm
.
πm_msgÀn
 = 
l
 = 
˝
 - (*)&
m_πmsg
;

2988 
s
 = 
	`sockë
(
PF_ROUTE
, 
SOCK_RAW
, 0);

2990 i‡(
	`wrôe
(
s
, (*)&
m_πmsg
, 
l
) < 0)

2992 
	`msg
(
M_WARN
|
M_ERRNO
, "CouldÇotÑetrieve default gateway fromÑoute socket:");

2993 
	`gc_‰ì
 (&
gc
);

2994 
	`˛o£
(
s
);

2999 
l
 = 
	`ªad
(
s
, (*)&
m_πmsg
, (m_rtmsg));

3000 } 
l
 > 0 && (
πm
.
πm_£q
 !
£q
 ||Ñtm.
πm_pid
 !
pid
));

3002 
	`˛o£
(
s
);

3004 
πm_aux
 = &
πm
;

3006 
˝
 = ((*)(
πm_aux
 + 1));

3007 i‡(
πm_aux
->
πm_addrs
) {

3008 
i
 = 1; i; i <<= 1)

3009 i‡(
i
 & 
πm_aux
->
πm_addrs
) {

3010 
ß
 = (
sockaddr
 *)
˝
;

3011 i‡(
i
 =
RTA_GATEWAY
 )

3012 
g©e
 = 
ß
;

3013 
	`ADVANCE
(
˝
, 
ß
);

3018 
	`gc_‰ì
 (&
gc
);

3023 i‡(
g©e
 !
NULL
 )

3025 
rgi
->
g©eway
.
addr
 = 
	`¡ohl
(((
sockaddr_ö
 *)
g©e
)->
sö_addr
.
s_addr
);

3026 
rgi
->
Êags
 |
RGI_ADDR_DEFINED
;

3028 
	`gc_‰ì
 (&
gc
);

3032 
	`gc_‰ì
 (&
gc
);

3034 
	}
}

3063 
	$gë_deÁu…_g©eway
 (
rouã_g©eway_öfo
 *
rgi
)

3065 
	`CLEAR
(*
rgi
);

3066 
	}
}

3070 
boﬁ


3071 
	$√tmask_to_√tbôs
 (c⁄° 
ö_addr_t
 
√tw‹k
, c⁄° in_addr_à
√tmask
, *
√tbôs
)

3073 
i
;

3074 c⁄° 
addæí
 =  (
ö_addr_t
) * 8;

3076 i‡((
√tw‹k
 & 
√tmask
) ==Çetwork)

3078 
i
 = 0; i <
addæí
; ++i)

3080 
ö_addr_t
 
mask
 = 
	`√tbôs_to_√tmask
 (
i
);

3081 i‡(
mask
 =
√tmask
)

3083 i‡(
i
 =
addæí
)

3084 *
√tbôs
 = -1;

3086 *
√tbôs
 = 
i
;

3087  
åue
;

3091  
Ál£
;

3092 
	}
}

3100 #i‡
deföed
(
WIN32
)

3103 
	$add_ho°_rouã_if_n⁄loˇl
 (
rouã_by∑ss
 *
rb
, c⁄° 
ö_addr_t
 
addr
)

3105 i‡(
	`ã°_loˇl_addr
(
addr
, 
NULL
Ë=
TLA_NONLOCAL
 &&ádd∏!0 &&ádd∏!
IPV4_NETMASK_HOST
)

3106 
	`add_by∑ss_addªss
 (
rb
, 
addr
);

3107 
	}
}

3110 
	$add_ho°_rouã_¨øy
 (
rouã_by∑ss
 *
rb
, c⁄° 
IP_ADDR_STRING
 *
ùli°
)

3112 
ùli°
)

3114 
boﬁ
 
suc˚ed
 = 
Ál£
;

3115 c⁄° 
ö_addr_t
 
ù
 = 
	`gëaddr
 (
GETADDR_HOST_ORDER
, 
ùli°
->
IpAddªss
.
Såög
, 0, &
suc˚ed
, 
NULL
);

3116 i‡(
suc˚ed
)

3118 
	`add_ho°_rouã_if_n⁄loˇl
 (
rb
, 
ù
);

3120 
ùli°
 = i∂i°->
Next
;

3122 
	}
}

3125 
	$gë_by∑ss_addªs£s
 (
rouã_by∑ss
 *
rb
, c⁄° 
Êags
)

3127 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3131 c⁄° 
MIB_IPFORWARDTABLE
 *
rouãs
 = 
	`gë_wödows_routög_èbÀ
 (&
gc
);

3134 c⁄° 
MIB_IPFORWARDROW
 *
row
 = 
	`gë_deÁu…_g©eway_row
 (
rouãs
);

3136 i‡(
row
)

3139 c⁄° 
IP_ADAPTER_INFO
 *
dgi
 = 
	`gë_ad≠ãr_öfo
 (
row
->
dwF‹w¨dIfIndex
, &
gc
);

3142 c⁄° 
IP_PER_ADAPTER_INFO
 *
∑i
 = 
	`gë_≥r_ad≠ãr_öfo
 (
row
->
dwF‹w¨dIfIndex
, &
gc
);

3145 i‡((
Êags
 & 
RG_BYPASS_DHCP
Ë&& 
dgi
 && dgi->
Dh˝E«bÀd
)

3146 
	`add_ho°_rouã_¨øy
 (
rb
, &
dgi
->
Dh˝Sîvî
);

3149 i‡((
Êags
 & 
RG_BYPASS_DNS
Ë&& 
∑i
)

3150 
	`add_ho°_rouã_¨øy
 (
rb
, &
∑i
->
DnsSîvîLi°
);

3153 
	`gc_‰ì
 (&
gc
);

3154 
	}
}

3159 
	$gë_by∑ss_addªs£s
 (
rouã_by∑ss
 *
rb
, c⁄° 
Êags
)

3161 
	}
}

3174 #i‡
deföed
(
WIN32
)

3177 
	$ã°_loˇl_addr
 (c⁄° 
ö_addr_t
 
addr
, c⁄° 
rouã_g©eway_öfo
 *
rgi
)

3179 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3180 c⁄° 
ö_addr_t
 
n⁄loˇl_√tmask
 = 0x80000000L;

3181 
boﬁ
 
ªt
 = 
TLA_NONLOCAL
;

3184 c⁄° 
MIB_IPFORWARDTABLE
 *
π
 = 
	`gë_wödows_routög_èbÀ
 (&
gc
);

3185 i‡(
π
)

3187 
i
;

3188 
i
 = 0; i < 
π
->
dwNumE¡rõs
; ++i)

3190 c⁄° 
MIB_IPFORWARDROW
 *
row
 = &
π
->
èbÀ
[
i
];

3191 c⁄° 
ö_addr_t
 
√t
 = 
	`¡ohl
 (
row
->
dwF‹w¨dDe°
);

3192 c⁄° 
ö_addr_t
 
mask
 = 
	`¡ohl
 (
row
->
dwF‹w¨dMask
);

3193 i‡(
mask
 > 
n⁄loˇl_√tmask
 && (
addr
 & maskË=
√t
)

3195 
ªt
 = 
TLA_LOCAL
;

3201 
	`gc_‰ì
 (&
gc
);

3202  
ªt
;

3203 
	}
}

3208 
	$ã°_loˇl_addr
 (c⁄° 
ö_addr_t
 
addr
, c⁄° 
rouã_g©eway_öfo
 *
rgi
)

3210 i‡(
rgi
)

3212 i‡(
	`loˇl_rouã
 (
addr
, 0xFFFFFFFF, 
rgi
->
g©eway
.addr,Ñgi))

3213  
TLA_LOCAL
;

3215  
TLA_NONLOCAL
;

3217  
TLA_NOT_IMPLEMENTED
;

3218 
	}
}

	@src/openvpn/route.h

29 #i‚de‡
ROUTE_H


30 
	#ROUTE_H


	)

32 
	~"basic.h
"

33 
	~"tun.h
"

34 
	~"misc.h
"

36 
	#MAX_ROUTES_DEFAULT
 100

	)

38 #ifde‡
WIN32


42 
	#ROUTE_METHOD_ADAPTIVE
 0

	)

43 
	#ROUTE_METHOD_IPAPI
 1

	)

44 
	#ROUTE_METHOD_EXE
 2

	)

45 
	#ROUTE_METHOD_MASK
 3

	)

51 
	#ROUTE_DELETE_FIRST
 (1<<2)

	)

52 
	#ROUTE_REF_GW
 (1<<3)

	)

54 
	srouã_by∑ss


56 
	#N_ROUTE_BYPASS
 8

	)

57 
	mn_by∑ss
;

58 
ö_addr_t
 
	mby∑ss
[
N_ROUTE_BYPASS
];

61 
	srouã_•ecül_addr


64 
	#RTSA_REMOTE_ENDPOINT
 (1<<0)

	)

65 
	#RTSA_REMOTE_HOST
 (1<<1)

	)

66 
	#RTSA_DEFAULT_METRIC
 (1<<2)

	)

67 
	mÊags
;

69 
ö_addr_t
 
	mªmŸe_ídpoöt
;

70 
ö_addr_t
 
	mªmŸe_ho°
;

71 
	mªmŸe_ho°_loˇl
;

72 
rouã_by∑ss
 
	mby∑ss
;

73 
	mdeÁu…_mëric
;

76 
	srouã_›ti⁄
 {

77 c⁄° *
	m√tw‹k
;

78 c⁄° *
	m√tmask
;

79 c⁄° *
	mg©eway
;

80 c⁄° *
	mmëric
;

84 
	#RG_ENABLE
 (1<<0)

	)

85 
	#RG_LOCAL
 (1<<1)

	)

86 
	#RG_DEF1
 (1<<2)

	)

87 
	#RG_BYPASS_DHCP
 (1<<3)

	)

88 
	#RG_BYPASS_DNS
 (1<<4)

	)

89 
	#RG_REROUTE_GW
 (1<<5)

	)

90 
	#RG_AUTO_LOCAL
 (1<<6)

	)

91 
	#RG_BLOCK_LOCAL
 (1<<7)

	)

93 
	srouã_›ti⁄_li°
 {

94 
	mÊags
;

95 
	mˇ∑côy
;

96 
	mn
;

97 
rouã_›ti⁄
 
	mrouãs
[
EMPTY_ARRAY_SIZE
];

100 
	srouã_ùv6_›ti⁄
 {

101 c⁄° *
	m¥efix
;

102 c⁄° *
	mg©eway
;

103 c⁄° *
	mmëric
;

106 
	srouã_ùv6_›ti⁄_li°
 {

107 
	mÊags
;

108 
	mˇ∑côy
;

109 
	mn
;

110 
rouã_ùv6_›ti⁄
 
	mrouãs_ùv6
[
EMPTY_ARRAY_SIZE
];

113 
	srouã_ùv4
 {

114 
	#RT_DEFINED
 (1<<0)

	)

115 
	#RT_ADDED
 (1<<1)

	)

116 
	#RT_METRIC_DEFINED
 (1<<2)

	)

117 
	mÊags
;

118 c⁄° 
rouã_›ti⁄
 *
	m›ti⁄
;

119 
ö_addr_t
 
	m√tw‹k
;

120 
ö_addr_t
 
	m√tmask
;

121 
ö_addr_t
 
	mg©eway
;

122 
	mmëric
;

125 
	srouã_ùv6
 {

126 
boﬁ
 
	mdeföed
;

127 
ö6_addr
 
	m√tw‹k
;

128 
	m√tbôs
;

129 
ö6_addr
 
	mg©eway
;

130 
boﬁ
 
	mmëric_deföed
;

131 
	mmëric
;

134 
	srouã_ùv6_li°
 {

135 
boﬁ
 
	mrouãs_added
;

136 
	mÊags
;

137 
	mdeÁu…_mëric
;

138 
boﬁ
 
	mdeÁu…_mëric_deföed
;

139 
ö6_addr
 
	mªmŸe_ídpoöt_ùv6
;

140 
boﬁ
 
	mªmŸe_ídpoöt_deföed
;

141 
boﬁ
 
	mdid_ªdúe˘_deÁu…_g©eway
;

142 
boﬁ
 
	mdid_loˇl
;

143 
	mˇ∑côy
;

144 
	mn
;

145 
rouã_ùv6
 
	mrouãs_ùv6
[
EMPTY_ARRAY_SIZE
];

149 
	srouã_g©eway_addªss
 {

150 
ö_addr_t
 
	maddr
;

151 
ö_addr_t
 
	m√tmask
;

154 
	srouã_g©eway_öfo
 {

155 
	#RGI_ADDR_DEFINED
 (1<<0Ë

	)

156 
	#RGI_NETMASK_DEFINED
 (1<<1Ë

	)

157 
	#RGI_HWADDR_DEFINED
 (1<<2Ë

	)

158 
	#RGI_IFACE_DEFINED
 (1<<3Ë

	)

159 
	#RGI_OVERFLOW
 (1<<4Ë

	)

160 
	#RGI_ON_LINK
 (1<<5)

	)

161 
	mÊags
;

164 #ifde‡
WIN32


165 
DWORD
 
	mad≠ãr_ödex
;

167 
	miÁ˚
[16];

171 
uöt8_t
 
	mhwaddr
[6];

174 
rouã_g©eway_addªss
 
	mg©eway
;

177 
	#RGI_N_ADDRESSES
 8

	)

178 
	mn_addrs
;

179 
rouã_g©eway_addªss
 
	maddrs
[
RGI_N_ADDRESSES
];

182 
	srouã_li°
 {

183 
	#RL_DID_REDIRECT_DEFAULT_GATEWAY
 (1<<0)

	)

184 
	#RL_DID_LOCAL
 (1<<1)

	)

185 
	#RL_ROUTES_ADDED
 (1<<2)

	)

186 
	miÊags
;

188 
rouã_•ecül_addr
 
	m•ec
;

189 
rouã_g©eway_öfo
 
	mrgi
;

190 
	mÊags
;

191 
	mˇ∑côy
;

192 
	mn
;

193 
rouã_ùv4
 
	mrouãs
[
EMPTY_ARRAY_SIZE
];

196 #i‡
P2MP


198 
	súouã
 {

199 
ö_addr_t
 
	m√tw‹k
;

200 
	m√tbôs
;

201 
úouã
 *
	m√xt
;

204 
	súouã_ùv6
 {

205 
ö6_addr
 
	m√tw‹k
;

206 
	m√tbôs
;

207 
úouã_ùv6
 *
	m√xt
;

211 
rouã_›ti⁄_li°
 *
√w_rouã_›ti⁄_li°
 (c⁄° 
max_rouãs
, 
gc_¨ía
 *
a
);

212 
rouã_ùv6_›ti⁄_li°
 *
√w_rouã_ùv6_›ti⁄_li°
 (c⁄° 
max_rouãs
, 
gc_¨ía
 *
a
);

214 
rouã_›ti⁄_li°
 *
˛⁄e_rouã_›ti⁄_li°
 (c⁄° rouã_›ti⁄_li° *
§c
, 
gc_¨ía
 *
a
);

215 
rouã_ùv6_›ti⁄_li°
 *
˛⁄e_rouã_ùv6_›ti⁄_li°
 (c⁄° rouã_ùv6_›ti⁄_li° *
§c
, 
gc_¨ía
 *
a
);

216 
c›y_rouã_›ti⁄_li°
 (
rouã_›ti⁄_li°
 *
de°
, c⁄° rouã_›ti⁄_li° *
§c
);

217 
c›y_rouã_ùv6_›ti⁄_li°
 (
rouã_ùv6_›ti⁄_li°
 *
de°
,

218 c⁄° 
rouã_ùv6_›ti⁄_li°
 *
§c
);

220 
rouã_li°
 *
√w_rouã_li°
 (c⁄° 
max_rouãs
, 
gc_¨ía
 *
a
);

221 
rouã_ùv6_li°
 *
√w_rouã_ùv6_li°
 (c⁄° 
max_rouãs
, 
gc_¨ía
 *
a
);

223 
add_rouã_ùv6
 (
rouã_ùv6
 *
r
, c⁄° 
tu¡≠
 *
â
, 
Êags
, c⁄° 
ív_£t
 *
es
);

224 
dñëe_rouã_ùv6
 (c⁄° 
rouã_ùv6
 *
r
, c⁄° 
tu¡≠
 *
â
, 
Êags
, c⁄° 
ív_£t
 *
es
);

226 
add_rouã
 (
rouã_ùv4
 *
r
,

227 c⁄° 
tu¡≠
 *
â
,

228 
Êags
,

229 c⁄° 
rouã_g©eway_öfo
 *
rgi
,

230 c⁄° 
ív_£t
 *
es
);

232 
add_rouã_to_›ti⁄_li°
 (
rouã_›ti⁄_li°
 *
l
,

233 c⁄° *
√tw‹k
,

234 c⁄° *
√tmask
,

235 c⁄° *
g©eway
,

236 c⁄° *
mëric
);

238 
add_rouã_ùv6_to_›ti⁄_li°
 (
rouã_ùv6_›ti⁄_li°
 *
l
,

239 c⁄° *
¥efix
,

240 c⁄° *
g©eway
,

241 c⁄° *
mëric
);

243 
boﬁ
 
öô_rouã_li°
 (
rouã_li°
 *
æ
,

244 c⁄° 
rouã_›ti⁄_li°
 *
›t
,

245 c⁄° *
ªmŸe_ídpoöt
,

246 
deÁu…_mëric
,

247 
ö_addr_t
 
ªmŸe_ho°
,

248 
ív_£t
 *
es
);

250 
boﬁ
 
öô_rouã_ùv6_li°
 (
rouã_ùv6_li°
 *
æ6
,

251 c⁄° 
rouã_ùv6_›ti⁄_li°
 *
›t6
,

252 c⁄° *
ªmŸe_ídpoöt
,

253 
deÁu…_mëric
,

254 
ív_£t
 *
es
);

256 
rouã_li°_add_v≤_g©eway
 (
rouã_li°
 *
æ
,

257 
ív_£t
 *
es
,

258 c⁄° 
ö_addr_t
 
addr
);

260 
add_rouãs
 (
rouã_li°
 *
æ
,

261 
rouã_ùv6_li°
 *
æ6
,

262 c⁄° 
tu¡≠
 *
â
,

263 
Êags
,

264 c⁄° 
ív_£t
 *
es
);

266 
dñëe_rouãs
 (
rouã_li°
 *
æ
,

267 
rouã_ùv6_li°
 *
æ6
,

268 c⁄° 
tu¡≠
 *
â
,

269 
Êags
,

270 c⁄° 
ív_£t
 *
es
);

272 
£ãnv_rouãs
 (
ív_£t
 *
es
, c⁄° 
rouã_li°
 *
æ
);

273 
£ãnv_rouãs_ùv6
 (
ív_£t
 *
es
, c⁄° 
rouã_ùv6_li°
 *
æ6
);

277 
boﬁ
 
is_•ecül_addr
 (c⁄° *
addr_°r
);

279 
gë_deÁu…_g©eway
 (
rouã_g©eway_öfo
 *
rgi
);

280 
¥öt_deÁu…_g©eway
(c⁄° 
msgÀvñ
, c⁄° 
rouã_g©eway_öfo
 *
rgi
);

288 
	#TLA_NOT_IMPLEMENTED
 0

	)

289 
	#TLA_NONLOCAL
 1

	)

290 
	#TLA_LOCAL
 2

	)

291 
ã°_loˇl_addr
 (c⁄° 
ö_addr_t
 
addr
, c⁄° 
rouã_g©eway_öfo
 *
rgi
);

293 #i‚de‡
ENABLE_SMALL


294 
¥öt_rouã_›ti⁄s
 (c⁄° 
rouã_›ti⁄_li°
 *
rﬁ
,

295 
Àvñ
);

298 
¥öt_rouãs
 (c⁄° 
rouã_li°
 *
æ
, 
Àvñ
);

300 #ifde‡
WIN32


302 
show_rouãs
 (
msgÀv
);

303 
boﬁ
 
ã°_rouãs
 (c⁄° 
rouã_li°
 *
æ
, c⁄° 
tu¡≠
 *
â
);

304 
boﬁ
 
add_rouã_ù≠i
 (c⁄° 
rouã_ùv4
 *
r
, c⁄° 
tu¡≠
 *
â
, 
DWORD
 
ad≠ãr_ödex
);

305 
boﬁ
 
dñ_rouã_ù≠i
 (c⁄° 
rouã_ùv4
 *
r
, c⁄° 
tu¡≠
 *
â
);

308 
ölöe
 
boﬁ
 
	$ã°_rouãs
 (c⁄° 
rouã_li°
 *
æ
, c⁄° 
tu¡≠
 *
â
Ë{  
åue
; 
	}
}

311 
boﬁ
 
√tmask_to_√tbôs
 (c⁄° 
ö_addr_t
 
√tw‹k
, c⁄° in_addr_à
√tmask
, *
√tbôs
);

313 
ölöe
 
ö_addr_t


314 
	$√tbôs_to_√tmask
 (c⁄° 
√tbôs
)

316 c⁄° 
addæí
 =  (
ö_addr_t
) * 8;

317 
ö_addr_t
 
mask
 = 0;

318 i‡(
√tbôs
 > 0 &&Çëbô†<
addæí
)

319 
mask
 = 
IPV4_NETMASK_HOST
 << (
addæí
-
√tbôs
);

320  
mask
;

321 
	}
}

323 
ölöe
 
boﬁ


324 
	$rouã_li°_v≤_g©eway_√eded
 (c⁄° 
rouã_li°
 *
æ
)

326 i‡(!
æ
)

327  
Ál£
;

329  !(
æ
->
•ec
.
Êags
 & 
RTSA_REMOTE_ENDPOINT
);

330 
	}
}

332 
ölöe
 

333 
	$rouã_did_ªdúe˘_deÁu…_g©eway
(c⁄° 
rouã_li°
 *
æ
)

335  
æ
 && 
	`BOOL_CAST
‘l->
iÊags
 & 
RL_DID_REDIRECT_DEFAULT_GATEWAY
);

336 
	}
}

	@src/openvpn/schedule.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 #i‡
P2MP_SERVER


35 
	~"buf„r.h
"

36 
	~"misc.h
"

37 
	~"¸y±o.h
"

38 
	~"scheduÀ.h
"

40 
	~"memdbg.h
"

42 #ifde‡
SCHEDULE_TEST


44 
	s°©us


46 
	m§u
;

47 
	mös
;

48 
	mcﬁl
;

49 
	ml°ïs
;

52 
°©us
 
	gz
;

56 #ifde‡
ENABLE_DEBUG


58 
	$scheduÀ_íåy_debug_öfo
 (c⁄° *
ˇŒî
, c⁄° 
scheduÀ_íåy
 *
e
)

60 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

61 i‡(
e
)

63 
	`dmsg
 (
D_SCHEDULER
, "SCHEDULE: %s wakeup=[%s]Öri=%u",

64 
ˇŒî
,

65 
	`tv_°rög_abs
 (&
e
->
tv
, &
gc
),

66 
e
->
¥i
);

70 
	`dmsg
 (
D_SCHEDULER
, "SCHEDULE: %s NULL",

71 
ˇŒî
);

73 
	`gc_‰ì
 (&
gc
);

74 
	}
}

77 
ölöe
 

78 
	$scheduÀ_£t_¥i
 (
scheduÀ_íåy
 *
e
)

80 
e
->
¥i
 = 
	`øndom
 ();

81 i‡(
e
->
¥i
 < 1)

82 
e
->
¥i
 = 1;

83 
	}
}

90 
ölöe
 

91 
	$scheduÀ_íåy_com∑ª
 (c⁄° 
scheduÀ_íåy
 *
e1
,

92 c⁄° 
scheduÀ_íåy
 *
e2
)

94 i‡(
e1
->
tv
.
tv_£c
 < 
e2
->tv.tv_sec)

96 i‡(
e1
->
tv
.
tv_£c
 > 
e2
->tv.tv_sec)

100 i‡(
e1
->
tv
.
tv_u£c
 < 
e2
->tv.tv_usec)

102 i‡(
e1
->
tv
.
tv_u£c
 > 
e2
->tv.tv_usec)

106 i‡(
e1
->
¥i
 < 
e2
->pri)

108 i‡(
e1
->
¥i
 > 
e2
->pri)

114 
	}
}

119 
ölöe
 

120 
	$scheduÀ_dëach_∑ª¡
 (
scheduÀ
 *
s
, 
scheduÀ_íåy
 *
e
)

122 i‡(
e
)

124 i‡(
e
->
∑ª¡
)

126 i‡(
e
->
∑ª¡
->
…
 ==É)

127 
e
->
∑ª¡
->
…
 = 
NULL
;

128 i‡(
e
->
∑ª¡
->
gt
 ==É)

129 
e
->
∑ª¡
->
gt
 = 
NULL
;

133 
	`ASSERT
 (0);

135 
e
->
∑ª¡
 = 
NULL
;

139 i‡(
s
->
roŸ
 =
e
)

140 
s
->
roŸ
 = 
NULL
;

143 
	}
}

157 
	$scheduÀ_rŸ©e_up
 (
scheduÀ
 *
s
, 
scheduÀ_íåy
 *
e
)

159 i‡(
e
 &&É->
∑ª¡
)

161 
scheduÀ_íåy
 *
…
 = 
e
->lt;

162 
scheduÀ_íåy
 *
gt
 = 
e
->gt;

163 
scheduÀ_íåy
 *
p
 = 
e
->
∑ª¡
;

164 
scheduÀ_íåy
 *
gp
 = 
p
->
∑ª¡
;

166 i‡(
gp
)

168 i‡(
gp
->
gt
 =
p
)

169 
gp
->
gt
 = 
e
;

170 i‡(
gp
->
…
 =
p
)

171 
gp
->
…
 = 
e
;

174 
	`ASSERT
 (0);

179 
s
->
roŸ
 = 
e
;

183 
e
->
∑ª¡
 = 
gp
;

186 
p
->
∑ª¡
 = 
e
;

190 i‡(
p
->
gt
 =
e
)

192 
e
->
…
 = 
p
;

193 
p
->
gt
 = 
…
;

194 i‡(
…
)

195 
…
->
∑ª¡
 = 
p
;

197 i‡(
p
->
…
 =
e
)

199 
e
->
gt
 = 
p
;

200 
p
->
…
 = 
gt
;

201 i‡(
gt
)

202 
gt
->
∑ª¡
 = 
p
;

207 
	`ASSERT
 (0);

210 #ifde‡
SCHEDULE_TEST


211 ++
z
.
§u
;

214 
	}
}

223 
	$scheduÀ_ªmove_node
 (
scheduÀ
 *
s
, 
scheduÀ_íåy
 *
e
)

225 
e
->
…
 ||É->
gt
)

227 i‡(
e
->
…
)

229 i‡(
e
->
gt
)

231 i‡(
e
->
…
->
¥i
 <É->
gt
->pri)

232 
	`scheduÀ_rŸ©e_up
 (
s
, 
e
->
…
);

234 
	`scheduÀ_rŸ©e_up
 (
s
, 
e
->
gt
);

237 
	`scheduÀ_rŸ©e_up
 (
s
, 
e
->
…
);

239 i‡(
e
->
gt
)

240 
	`scheduÀ_rŸ©e_up
 (
s
, 
e
->
gt
);

243 
	`scheduÀ_dëach_∑ª¡
 (
s
, 
e
);

244 
e
->
¥i
 = 0;

245 
	}
}

252 
	$scheduÀ_ö£π
 (
scheduÀ
 *
s
, 
scheduÀ_íåy
 *
e
)

254 
scheduÀ_íåy
 *
c
 = 
s
->
roŸ
;

255 
åue
)

257 c⁄° 
comp
 = 
	`scheduÀ_íåy_com∑ª
 (
e
, 
c
);

259 #ifde‡
SCHEDULE_TEST


260 ++
z
.
ös
;

263 i‡(
comp
 == -1)

265 i‡(
c
->
…
)

267 
c
 = c->
…
;

272 
c
->
…
 = 
e
;

273 
e
->
∑ª¡
 = 
c
;

277 i‡(
comp
 == 1)

279 i‡(
c
->
gt
)

281 
c
 = c->
gt
;

286 
c
->
gt
 = 
e
;

287 
e
->
∑ª¡
 = 
c
;

295 #ifde‡
SCHEDULE_TEST


296 ++
z
.
cﬁl
;

298 
	`scheduÀ_£t_¥i
 (
e
);

300 
c
 = 
s
->
roŸ
;

304 
	}
}

311 
	$scheduÀ_add_modify
 (
scheduÀ
 *
s
, 
scheduÀ_íåy
 *
e
)

313 #ifde‡
ENABLE_DEBUG


314 i‡(
	`check_debug_Àvñ
 (
D_SCHEDULER
))

315 
	`scheduÀ_íåy_debug_öfo
 ("scheduÀ_add_modify", 
e
);

319 i‡(
	`IN_TREE
 (
e
))

320 
	`scheduÀ_ªmove_node
 (
s
, 
e
);

323 
	`scheduÀ_£t_¥i
 (
e
);

325 i‡(
s
->
roŸ
)

326 
	`scheduÀ_ö£π
 (
s
, 
e
);

328 
s
->
roŸ
 = 
e
;

333 
e
->
∑ª¡
 &&É->∑ª¡->
¥i
 >É->pri)

334 
	`scheduÀ_rŸ©e_up
 (
s
, 
e
);

335 
	}
}

340 
scheduÀ_íåy
 *

341 
	$scheduÀ_föd_Àa°
 (
scheduÀ_íåy
 *
e
)

343 i‡(
e
)

345 
e
->
…
)

347 #ifde‡
SCHEDULE_TEST


348 ++
z
.
l°ïs
;

350 
e
 =É->
…
;

354 #ifde‡
ENABLE_DEBUG


355 i‡(
	`check_debug_Àvñ
 (
D_SCHEDULER
))

356 
	`scheduÀ_íåy_debug_öfo
 ("scheduÀ_föd_Àa°", 
e
);

359  
e
;

360 
	}
}

366 
scheduÀ
 *

367 
	$scheduÀ_öô
 ()

369 
scheduÀ
 *
s
;

371 
	`ALLOC_OBJ_CLEAR
 (
s
, 
scheduÀ
);

372  
s
;

373 
	}
}

376 
	$scheduÀ_‰ì
 (
scheduÀ
 *
s
)

378 
	`‰ì
 (
s
);

379 
	}
}

382 
	$scheduÀ_ªmove_íåy
 (
scheduÀ
 *
s
, 
scheduÀ_íåy
 *
e
)

384 
s
->
óæõ°_wakeup
 = 
NULL
;

385 
	`scheduÀ_ªmove_node
 (
s
, 
e
);

386 
	}
}

392 #ifde‡
SCHEDULE_TEST


394 
ölöe
 
scheduÀ_íåy
 *

395 
	$scheduÀ_föd_óæõ°_wakeup
 (
scheduÀ
 *
s
)

397  
	`scheduÀ_föd_Àa°
 (
s
->
roŸ
);

398 
	}
}

405 
	$scheduÀ_debug_íåy
 (c⁄° 
scheduÀ_íåy
* 
e
,

406 
dïth
,

407 *
cou¡
,

408 
timevÆ
 *
Àa°
,

409 c⁄° 
timevÆ
 *
mö
,

410 c⁄° 
timevÆ
 *
max
)

412 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

413 
maxdïth
 = 
dïth
;

414 i‡(
e
)

416 
d
;

418 
	`ASSERT
 (
e
 !e->
…
);

419 
	`ASSERT
 (
e
 !e->
gt
);

420 
	`ASSERT
 (
e
 !e->
∑ª¡
);

421 
	`ASSERT
 (!
e
->
∑ª¡
 ||É->∑ª¡ !e->
…
);

422 
	`ASSERT
 (!
e
->
∑ª¡
 ||É->∑ª¡ !e->
gt
);

423 
	`ASSERT
 (!
e
->
…
 ||É->… !e->
gt
);

425 i‡(
e
->
…
)

427 
	`ASSERT
 (
e
->
…
->
∑ª¡
 ==É);

428 
	`ASSERT
 (
	`scheduÀ_íåy_com∑ª
 (
e
->
…
,É) == -1);

429 
	`ASSERT
 (
e
->
…
->
¥i
 >=É->pri);

432 i‡(
e
->
gt
)

434 
	`ASSERT
 (
e
->
gt
->
∑ª¡
 ==É);

435 
	`ASSERT
 (
	`scheduÀ_íåy_com∑ª
 (
e
->
gt
,É));

436 
	`ASSERT
 (
e
->
gt
->
¥i
 >=É->pri);

439 
	`ASSERT
 (
	`tv_À
 (
mö
, &
e
->
tv
));

440 
	`ASSERT
 (
	`tv_À
 (&
e
->
tv
, 
max
));

442 i‡(
cou¡
)

443 ++(*
cou¡
);

445 i‡(
Àa°
 && 
	`tv_…
 (&
e
->
tv
,Üeast))

446 *
Àa°
 = 
e
->
tv
;

448 
d
 = 
	`scheduÀ_debug_íåy
 (
e
->
…
, 
dïth
+1, 
cou¡
, 
Àa°
, 
mö
, &e->
tv
);

449 i‡(
d
 > 
maxdïth
)

450 
maxdïth
 = 
d
;

452 
d
 = 
	`scheduÀ_debug_íåy
 (
e
->
gt
, 
dïth
+1, 
cou¡
, 
Àa°
, &e->
tv
, 
max
);

453 i‡(
d
 > 
maxdïth
)

454 
maxdïth
 = 
d
;

456 
	`gc_‰ì
 (&
gc
);

457  
maxdïth
;

458 
	}
}

461 
	$scheduÀ_debug
 (
scheduÀ
 *
s
, *
cou¡
, 
timevÆ
 *
Àa°
)

463 
timevÆ
 
mö
;

464 
timevÆ
 
max
;

466 
mö
.
tv_£c
 = 0;

467 
mö
.
tv_u£c
 = 0;

468 
max
.
tv_£c
 = 0x7FFFFFFF;

469 
max
.
tv_u£c
 = 0x7FFFFFFF;

471 i‡(
s
->
roŸ
)

473 
	`ASSERT
 (
s
->
roŸ
->
∑ª¡
 =
NULL
);

475  
	`scheduÀ_debug_íåy
 (
s
->
roŸ
, 0, 
cou¡
, 
Àa°
, &
mö
, &
max
);

476 
	}
}

481 
	$tv_øndomize
 (
timevÆ
 *
tv
)

483 
tv
->
tv_£c
 +
	`øndom
() % 100;

484 
tv
->
tv_u£c
 = 
	`øndom
 () % 100;

485 
	}
}

490 
	$tv_øndomize
 (
timevÆ
 *
tv
)

492 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

493 
choi˚
 = 
	`gë_øndom
 ();

494 i‡((
choi˚
 & 0xFF) == 0)

495 
tv
->
tv_u£c
 +((
choi˚
 >> 8) & 0xFF);

497 
	`¥ng_byãs
 ((
uöt8_t
 *)
tv
,  (
timevÆ
));

498 
	`gc_‰ì
 (&
gc
);

499 
	}
}

504 
	$scheduÀ_vîify
 (
scheduÀ
 *
s
)

506 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

507 
timevÆ
 
Àa°
;

508 
cou¡
;

509 
maxÀv
;

510 
scheduÀ_íåy
* 
e
;

511 c⁄° 
°©us
 
zz
 = 
z
;

513 
Àa°
.
tv_£c
 =Üó°.
tv_u£c
 = 0x7FFFFFFF;

515 
cou¡
 = 0;

517 
maxÀv
 = 
	`scheduÀ_debug
 (
s
, &
cou¡
, &
Àa°
);

519 
e
 = 
	`scheduÀ_föd_óæõ°_wakeup
 (
s
);

521 i‡(
e
)

523 
	`¥ötf
 ("Verification Phase count=%d maxlev=%d sru=%d ins=%d coll=%dÜs=%dÜ=%s",

524 
cou¡
,

525 
maxÀv
,

526 
zz
.
§u
,

527 
zz
.
ös
,

528 
zz
.
cﬁl
,

529 
zz
.
l°ïs
,

530 
	`tv_°rög
 (&
e
->
tv
, &
gc
));

532 i‡(!
	`tv_eq
 (&
Àa°
, &
e
->
tv
))

533 
	`¥ötf
 (" [COMPUTED DIFFERENT MIN VALUES!]");

535 
	`¥ötf
 ("\n");

538 
	`CLEAR
 (
z
);

539 
	`gc_‰ì
 (&
gc
);

540 
	}
}

543 
	$scheduÀ_øndomize_¨øy
 (
scheduÀ_íåy
 **
¨øy
, 
size
)

545 
i
;

546 
i
 = 0; i < 
size
; ++i)

548 c⁄° 
§c
 = 
	`gë_øndom
 (Ë% 
size
;

549 
scheduÀ_íåy
 *
tmp
 = 
¨øy
 [
i
];

550 i‡(
i
 !
§c
)

552 
¨øy
 [
i
] =áºay [
§c
];

553 
¨øy
 [
§c
] = 
tmp
;

556 
	}
}

559 
	$scheduÀ_¥öt_w‹k
 (
scheduÀ_íåy
 *
e
, 
ödít
)

561 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

562 
i
;

563 
i
 = 0; i < 
ödít
; ++i)

564 
	`¥ötf
 (" ");

565 i‡(
e
)

567 
	`¥ötf
 ("%†[%u]É=" 
±r_f‹m©
 ",Ö="Ötr_format "Üt="Ötr_format " gt="Ötr_format "\n",

568 
	`tv_°rög
 (&
e
->
tv
, &
gc
),

569 
e
->
¥i
,

570 (
±r_ty≥
)
e
,

571 (
±r_ty≥
)
e
->
∑ª¡
,

572 (
±r_ty≥
)
e
->
…
,

573 (
±r_ty≥
)
e
->
gt
);

574 
	`scheduÀ_¥öt_w‹k
 (
e
->
…
, 
ödít
+1);

575 
	`scheduÀ_¥öt_w‹k
 (
e
->
gt
, 
ödít
+1);

578 
	`¥ötf
 ("NULL\n");

579 
	`gc_‰ì
 (&
gc
);

580 
	}
}

583 
	$scheduÀ_¥öt
 (
scheduÀ
 *
s
)

585 
	`¥ötf
 ("*************************\n");

586 
	`scheduÀ_¥öt_w‹k
 (
s
->
roŸ
, 0);

587 
	}
}

590 
	$scheduÀ_ã°
 ()

592 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

593 
n
 = 1000;

594 
n_mod
 = 25;

596 
i
, 
j
;

597 
scheduÀ_íåy
 **
¨øy
;

598 
scheduÀ
 *
s
 = 
	`scheduÀ_öô
 ();

599 
scheduÀ_íåy
* 
e
;

601 
	`CLEAR
 (
z
);

602 
	`ALLOC_ARRAY
 (
¨øy
, 
scheduÀ_íåy
 *, 
n
);

604 
	`¥ötf
 ("Creation/Insertion Phase\n");

606 
i
 = 0; i < 
n
; ++i)

608 
	`ALLOC_OBJ_CLEAR
 (
¨øy
[
i
], 
scheduÀ_íåy
);

609 
	`tv_øndomize
 (&
¨øy
[
i
]->
tv
);

612 
	`scheduÀ_add_modify
 (
s
, 
¨øy
[
i
]);

615 
	`scheduÀ_øndomize_¨øy
 (
¨øy
, 
n
);

618 
	`scheduÀ_vîify
 (
s
);

620 
j
 = 1; j <
n_mod
; ++j)

622 
	`¥ötf
 ("Modifiˇti⁄ Pha£ Pas†%d\n", 
j
);

624 
i
 = 0; i < 
n
; ++i)

626 
e
 = 
	`scheduÀ_föd_óæõ°_wakeup
 (
s
);

628 
	`tv_øndomize
 (&
e
->
tv
);

630 
	`scheduÀ_add_modify
 (
s
, 
e
);

634 
	`scheduÀ_vîify
 (
s
);

640 (
e
 = 
	`scheduÀ_föd_óæõ°_wakeup
 (
s
)))

642 
	`scheduÀ_ªmove_node
 (
s
, 
e
);

645 
	`scheduÀ_vîify
 (
s
);

647 
	`¥ötf
 ("S->ROOT i†%s\n", 
s
->
roŸ
 ? "NOT NULL" : "NULL");

649 
i
 = 0; i < 
n
; ++i)

651 
	`‰ì
 (
¨øy
[
i
]);

653 
	`‰ì
 (
¨øy
);

654 
	`‰ì
 (
s
);

655 
	`gc_‰ì
 (&
gc
);

656 
	}
}

	@src/openvpn/schedule.h

25 #i‚de‡
SCHEDULE_H


26 
	#SCHEDULE_H


	)

39 #i‡
P2MP_SERVER


44 
	~"Ÿime.h
"

45 
	~"îr‹.h
"

47 
	sscheduÀ_íåy


49 
timevÆ
 
	mtv
;

50 
	m¥i
;

51 
scheduÀ_íåy
 *
	m∑ª¡
;

52 
scheduÀ_íåy
 *
	m…
;

53 
scheduÀ_íåy
 *
	mgt
;

56 
	sscheduÀ


58 
scheduÀ_íåy
 *
	móæõ°_wakeup
;

59 
scheduÀ_íåy
 *
	mroŸ
;

64 
scheduÀ
 *
scheduÀ_öô
 ();

65 
scheduÀ_‰ì
 (
scheduÀ
 *
s
);

66 
scheduÀ_ªmove_íåy
 (
scheduÀ
 *
s
, 
scheduÀ_íåy
 *
e
);

68 #ifde‡
SCHEDULE_TEST


69 
scheduÀ_ã°
 ();

75 
	#IN_TREE
(
e
Ë(”)->
¥i
)

	)

77 
scheduÀ_íåy
 *
scheduÀ_föd_Àa°
 (scheduÀ_íåy *
e
);

78 
scheduÀ_add_modify
 (
scheduÀ
 *
s
, 
scheduÀ_íåy
 *
e
);

79 
scheduÀ_ªmove_node
 (
scheduÀ
 *
s
, 
scheduÀ_íåy
 *
e
);

95 
ölöe
 

96 
	$scheduÀ_add_íåy
 (
scheduÀ
 *
s
,

97 
scheduÀ_íåy
 *
e
,

98 c⁄° 
timevÆ
 *
tv
,

99 
sigma
)

101 i‡(!
	`IN_TREE
 (
e
Ë|| !
sigma
 || !
	`tv_wôhö_sigma
 (
tv
, &e->tv, sigma))

103 
e
->
tv
 = *tv;

104 
	`scheduÀ_add_modify
 (
s
, 
e
);

105 
s
->
óæõ°_wakeup
 = 
NULL
;

107 
	}
}

115 
ölöe
 
scheduÀ_íåy
 *

116 
	$scheduÀ_gë_óæõ°_wakeup
 (
scheduÀ
 *
s
,

117 
timevÆ
 *
wakeup
)

119 
scheduÀ_íåy
 *
ªt
;

122 i‡(!
s
->
óæõ°_wakeup
)

123 
s
->
óæõ°_wakeup
 = 
	`scheduÀ_föd_Àa°
 (s->
roŸ
);

124 
ªt
 = 
s
->
óæõ°_wakeup
;

125 i‡(
ªt
)

126 *
wakeup
 = 
ªt
->
tv
;

128  
ªt
;

129 
	}
}

	@src/openvpn/session_id.c

34 #ifde‡
HAVE_CONFIG_H


35 
	~"c⁄fig.h
"

36 #ñi‡
deföed
(
_MSC_VER
)

37 
	~"c⁄fig-msvc.h
"

40 
	~"syshód.h
"

42 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

44 
	~"îr‹.h
"

45 
	~"comm⁄.h
"

46 
	~"¸y±o.h
"

47 
	~"£ssi⁄_id.h
"

49 
	~"memdbg.h
"

51 c⁄° 
£ssi⁄_id
 
	gx_£ssi⁄_id_zîo
;

54 
	$£ssi⁄_id_øndom
 (
£ssi⁄_id
 *
sid
)

56 
	`¥ng_byãs
 (
sid
->
id
, 
SID_SIZE
);

57 
	}
}

60 
	$£ssi⁄_id_¥öt
 (c⁄° 
£ssi⁄_id
 *
sid
, 
gc_¨ía
 *
gc
)

62  
	`f‹m©_hex
 (
sid
->
id
, 
SID_SIZE
, 0, 
gc
);

63 
	}
}

66 
	$dummy
(Ë{
	}
}

	@src/openvpn/session_id.h

33 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

35 #i‚de‡
SESSION_ID_H


36 
	#SESSION_ID_H


	)

38 
	~"basic.h
"

39 
	~"buf„r.h
"

41 
	s£ssi⁄_id


43 
uöt8_t
 
	mid
[8];

46 c⁄° 
£ssi⁄_id
 
x_£ssi⁄_id_zîo
;

48 
	#SID_SIZE
 ( (
x_£ssi⁄_id_zîo
.
id
))

	)

50 
ölöe
 
boﬁ


51 
	$£ssi⁄_id_equÆ
 (c⁄° 
£ssi⁄_id
 *
sid1
,

52 c⁄° 
£ssi⁄_id
 *
sid2
)

54  !
	`memcmp
 (
sid1
->
id
, 
sid2
->id, 
SID_SIZE
);

55 
	}
}

57 
ölöe
 
boﬁ


58 
	$£ssi⁄_id_deföed
 (c⁄° 
£ssi⁄_id
 *
sid1
)

60  
	`memcmp
 (
sid1
->
id
, &
x_£ssi⁄_id_zîo
.id, 
SID_SIZE
) != 0;

61 
	}
}

63 
ölöe
 
boﬁ


64 
	$£ssi⁄_id_ªad
 (
£ssi⁄_id
 *
sid
, 
buf„r
 *
buf
)

66  
	`buf_ªad
 (
buf
, 
sid
->
id
, 
SID_SIZE
);

67 
	}
}

69 
ölöe
 
boﬁ


70 
	$£ssi⁄_id_wrôe_¥ïíd
 (c⁄° 
£ssi⁄_id
 *
sid
, 
buf„r
 *
buf
)

72  
	`buf_wrôe_¥ïíd
 (
buf
, 
sid
->
id
, 
SID_SIZE
);

73 
	}
}

75 
ölöe
 
boﬁ


76 
	$£ssi⁄_id_wrôe
 (c⁄° 
£ssi⁄_id
 *
sid
, 
buf„r
 *
buf
)

78  
	`buf_wrôe
 (
buf
, 
sid
->
id
, 
SID_SIZE
);

79 
	}
}

81 
£ssi⁄_id_øndom
 (
£ssi⁄_id
 *
sid
);

83 c⁄° *
£ssi⁄_id_¥öt
 (c⁄° 
£ssi⁄_id
 *
sid
, 
gc_¨ía
 *
gc
);

	@src/openvpn/shaper.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

32 
	~"sh≠î.h
"

33 
	~"memdbg.h
"

35 #ifde‡
ENABLE_FEATURE_SHAPER


41 
boﬁ


42 
	$sh≠î_so⁄e°_evít
 (
timevÆ
 *
tv
, 
dñay
)

44 
boﬁ
 
ªt
 = 
Ál£
;

45 i‡(
dñay
 < 1000000)

47 i‡(
tv
->
tv_£c
)

49 
tv
->
tv_£c
 = 0;

50 
tv
->
tv_u£c
 = 
dñay
;

51 
ªt
 = 
åue
;

53 i‡(
dñay
 < 
tv
->
tv_u£c
)

55 
tv
->
tv_u£c
 = 
dñay
;

56 
ªt
 = 
åue
;

61 c⁄° 
£c
 = 
dñay
 / 1000000;

62 c⁄° 
u£c
 = 
dñay
 % 1000000;

64 i‡(
£c
 < 
tv
->
tv_£c
)

66 
tv
->
tv_£c
 = 
£c
;

67 
tv
->
tv_u£c
 = 
u£c
;

68 
ªt
 = 
åue
;

70 i‡(
£c
 =
tv
->
tv_£c
)

72 i‡(
u£c
 < 
tv
->
tv_u£c
)

74 
tv
->
tv_u£c
 = 
u£c
;

75 
ªt
 = 
åue
;

79 #ifde‡
SHAPER_DEBUG


80 
	`dmsg
 (
D_SHAPER_DEBUG
, "SHAPER shaper_soonest_event sec=%d usec=%dÑet=%d",

81 ()
tv
->
tv_£c
, (Èv->
tv_u£c
, ()
ªt
);

83  
ªt
;

84 
	}
}

87 
	$sh≠î_ª£t_wakeup
 (
sh≠î
 *
s
)

89 
	`CLEAR
 (
s
->
wakeup
);

90 
	}
}

93 
	$sh≠î_msg
 (
sh≠î
 *
s
)

95 
	`msg
 (
M_INFO
, "Output Traffic Shaping initializedát %d bytesÖer second",

96 
s
->
byãs_≥r_£c⁄d
);

97 
	}
}

100 
	$dummy
(Ë{
	}
}

	@src/openvpn/shaper.h

25 #i‚de‡
SHAPER_H


26 
	#SHAPER_H


	)

30 #ifde‡
ENABLE_FEATURE_SHAPER


32 
	~"basic.h
"

33 
	~"öãgî.h
"

34 
	~"misc.h
"

35 
	~"îr‹.h
"

36 
	~"öãrvÆ.h
"

43 
	#SHAPER_MIN
 100

	)

44 
	#SHAPER_MAX
 100000000

	)

46 
	#SHAPER_MAX_TIMEOUT
 10

	)

48 
	#SHAPER_USE_FP


	)

50 
	ssh≠î


52 
	mbyãs_≥r_£c⁄d
;

53 
timevÆ
 
	mwakeup
;

55 #ifde‡
SHAPER_USE_FP


56 
	mÁ˘‹
;

58 
	mÁ˘‹
;

62 
sh≠î_msg
 (
sh≠î
 *
s
);

63 
sh≠î_ª£t_wakeup
 (
sh≠î
 *
s
);

69 
boﬁ
 
sh≠î_so⁄e°_evít
 (
timevÆ
 *
tv
, 
dñay
);

75 
ölöe
 

76 
	$sh≠î_ª£t
 (
sh≠î
 *
s
, 
byãs_≥r_£c⁄d
)

78 
s
->
byãs_≥r_£c⁄d
 = byãs_≥r_£c⁄d ? 
	`c⁄°øö_öt
 (byãs_≥r_£c⁄d, 
SHAPER_MIN
, 
SHAPER_MAX
) : 0;

80 #ifde‡
SHAPER_USE_FP


81 
s
->
Á˘‹
 = 1000000.0 / ()s->
byãs_≥r_£c⁄d
;

83 
s
->
Á˘‹
 = 1000000 / s->
byãs_≥r_£c⁄d
;

85 
	}
}

87 
ölöe
 

88 
	$sh≠î_öô
 (
sh≠î
 *
s
, 
byãs_≥r_£c⁄d
)

90 
	`sh≠î_ª£t
 (
s
, 
byãs_≥r_£c⁄d
);

91 
	`sh≠î_ª£t_wakeup
 (
s
);

92 
	}
}

94 
ölöe
 

95 
	$sh≠î_cuºít_b™dwidth
 (
sh≠î
 *
s
)

97  
s
->
byãs_≥r_£c⁄d
;

98 
	}
}

104 
ölöe
 

105 
	$sh≠î_dñay
 (
sh≠î
* 
s
)

107 
timevÆ
 
tv
;

108 
dñay
 = 0;

110 i‡(
	`tv_deföed
 (&
s
->
wakeup
))

112 
	`ASSERT
 (!
	`›ív≤_gëtimeofday
 (&
tv
, 
NULL
));

113 
dñay
 = 
	`tv_subåa˘
 (&
s
->
wakeup
, &
tv
, 
SHAPER_MAX_TIMEOUT
);

114 #ifde‡
SHAPER_DEBUG


115 
	`dmsg
 (
D_SHAPER_DEBUG
, "SHAPER sh≠î_dñay dñay=%d", 
dñay
);

119  
dñay
 > 0 ? delay : 0;

120 
	}
}

129 
ölöe
 

130 
	$sh≠î_wrŸe_byãs
 (
sh≠î
* 
s
, 
nbyãs
)

132 
timevÆ
 
tv
;

135 
tv
.
tv_£c
 = 0;

136 #ifde‡
SHAPER_USE_FP


137 
tv
.
tv_u£c
 = 
	`mö_öt
 (()(()
	`max_öt
 (
nbyãs
, 100Ë* 
s
->
Á˘‹
), (
SHAPER_MAX_TIMEOUT
*1000000));

139 
tv
.
tv_u£c
 = 
s
->
byãs_≥r_£c⁄d


140 ? 
	`mö_öt
 (
	`max_öt
 (
nbyãs
, 100Ë* 
s
->
Á˘‹
, (
SHAPER_MAX_TIMEOUT
*1000000))

144 i‡(
tv
.
tv_u£c
)

146 
	`ASSERT
 (!
	`›ív≤_gëtimeofday
 (&
s
->
wakeup
, 
NULL
));

147 
	`tv_add
 (&
s
->
wakeup
, &
tv
);

149 #ifde‡
SHAPER_DEBUG


150 
	`dmsg
 (
D_SHAPER_DEBUG
, "SHAPER shaper_wrote_bytes bytes=%d delay=%d sec=%d usec=%d",

151 
nbyãs
,

152 ()
tv
.
tv_u£c
,

153 ()
s
->
wakeup
.
tv_£c
,

154 ()
s
->
wakeup
.
tv_u£c
);

157 
	}
}

165 
ölöe
 
boﬁ


166 
	$sh≠î_ch™ge_p˘
 (
sh≠î
 *
s
, 
p˘
)

168 c⁄° 
‹ig_b™dwidth
 = 
s
->
byãs_≥r_£c⁄d
;

169 c⁄° 
√w_b™dwidth
 = 
‹ig_b™dwidth
 + (‹ig_b™dwidth * 
p˘
 / 100);

170 
	`ASSERT
 (
s
->
byãs_≥r_£c⁄d
);

171 
	`sh≠î_ª£t
 (
s
, 
√w_b™dwidth
);

172  
s
->
byãs_≥r_£c⁄d
 !
‹ig_b™dwidth
;

173 
	}
}

	@src/openvpn/sig.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"buf„r.h
"

34 
	~"îr‹.h
"

35 
	~"wö32.h
"

36 
	~"öô.h
"

37 
	~"°©us.h
"

38 
	~"sig.h
"

39 
	~"occ.h
"

40 
	~"m™age.h
"

41 
	~"›ív≤.h
"

43 
	~"memdbg.h
"

47 
sig«l_öfo
 
	gsigöfo_°©ic
;

49 
	ssig«me
 {

50 
	mvÆue
;

51 c⁄° *
	muµî
;

52 c⁄° *
	mlowî
;

55 c⁄° 
sig«me
 
	gsig«mes
[] = {

56 { 
SIGINT
, "SIGINT", "sigint"},

57 { 
SIGTERM
, "SIGTERM", "sigterm" },

58 { 
SIGHUP
, "SIGHUP", "sighup" },

59 { 
SIGUSR1
, "SIGUSR1", "sigusr1" },

60 { 
SIGUSR2
, "SIGUSR2", "sigusr2" }

64 
	$∑r£_sig«l
 (c⁄° *
sig«me
)

66 
i
;

67 
i
 = 0; i < ()
	`SIZE
 (
sig«mes
); ++i)

69 i‡(!
	`°rcmp
 (
sig«me
, 
sig«mes
[
i
].
uµî
))

70  
sig«mes
[
i
].
vÆue
;

73 
	}
}

76 
	$sig«l_«me
 (c⁄° 
sig
, c⁄° 
boﬁ
 
uµî
)

78 
i
;

79 
i
 = 0; i < ()
	`SIZE
 (
sig«mes
); ++i)

81 i‡(
sig
 =
sig«mes
[
i
].
vÆue
)

82  
uµî
 ? 
sig«mes
[
i
].uµî : sig«mes[i].
lowî
;

85 
	}
}

88 
	$sig«l_des¸ùti⁄
 (c⁄° 
signum
, c⁄° *
sigãxt
)

90 i‡(
sigãxt
)

91  
sigãxt
;

93  
	`sig«l_«me
 (
signum
, 
Ál£
);

94 
	}
}

97 
	$throw_sig«l
 (c⁄° 
signum
)

99 
sigöfo_°©ic
.
sig«l_ª˚ived
 = 
signum
;

100 
sigöfo_°©ic
.
h¨d
 = 
åue
;

101 
	}
}

104 
	$throw_sig«l_so·
 (c⁄° 
signum
, c⁄° *
sig«l_ãxt
)

106 
sigöfo_°©ic
.
sig«l_ª˚ived
 = 
signum
;

107 
sigöfo_°©ic
.
h¨d
 = 
Ál£
;

108 
sigöfo_°©ic
.
sig«l_ãxt
 = signal_text;

109 
	}
}

112 
	$sig«l_ª£t
 (
sig«l_öfo
 *
si
)

114 i‡(
si
)

116 
si
->
sig«l_ª˚ived
 = 0;

117 
si
->
sig«l_ãxt
 = 
NULL
;

118 
si
->
h¨d
 = 
Ál£
;

120 
	}
}

123 
	$¥öt_sig«l
 (c⁄° 
sig«l_öfo
 *
si
, c⁄° *
tôÀ
, 
msgÀvñ
)

125 i‡(
si
)

127 c⁄° *
hs
 = (
si
->
h¨d
 ? "hard" : "soft");

128 c⁄° *
ty≥
 = (
si
->
sig«l_ãxt
 ? si->signal_text : "");

129 c⁄° *
t
 = (
tôÀ
 ?Åitle : "process");

131 
si
->
sig«l_ª˚ived
)

133 
SIGINT
:

134 
SIGTERM
:

135 
	`msg
 (
msgÀvñ
, "%s[%s,%s]Ñeceived, %sÉxiting",

136 
	`sig«l_«me
 (
si
->
sig«l_ª˚ived
, 
åue
), 
hs
, 
ty≥
, 
t
);

138 
SIGHUP
:

139 
SIGUSR1
:

140 
	`msg
 (
msgÀvñ
, "%s[%s,%s]Ñeceived, %sÑestarting",

141 
	`sig«l_«me
 (
si
->
sig«l_ª˚ived
, 
åue
), 
hs
, 
ty≥
, 
t
);

144 
	`msg
 (
msgÀvñ
, "Unknow¿sig«»%d [%s,%s]Ñe˚ived by %s", 
si
->
sig«l_ª˚ived
, 
hs
, 
ty≥
, 
t
);

149 
	`msg
 (
msgÀvñ
, "Unknown signalÑeceived");

150 
	}
}

156 
	$sig«l_ª°¨t_°©us
 (c⁄° 
sig«l_öfo
 *
si
)

158 #ifde‡
ENABLE_MANAGEMENT


159 i‡(
m™agemít
)

161 
°©e
 = -1;

162 
si
->
sig«l_ª˚ived
)

164 
SIGINT
:

165 
SIGTERM
:

166 
°©e
 = 
OPENVPN_STATE_EXITING
;

168 
SIGHUP
:

169 
SIGUSR1
:

170 
°©e
 = 
OPENVPN_STATE_RECONNECTING
;

174 i‡(
°©e
 >= 0)

175 
	`m™agemít_£t_°©e
 (
m™agemít
,

176 
°©e
,

177 
si
->
sig«l_ãxt
 ? si->sig«l_ãxà: 
	`sig«l_«me
 (si->
sig«l_ª˚ived
, 
åue
),

178 (
ö_addr_t
)0,

179 (
ö_addr_t
)0);

182 
	}
}

184 #ifde‡
HAVE_SIGNAL_H


188 
	$sig«l_h™dÀr
 (c⁄° 
signum
)

190 
	`throw_sig«l
 (
signum
);

191 
	`sig«l
 (
signum
, 
sig«l_h™dÀr
);

192 
	}
}

198 #ifde‡
HAVE_SIGNAL_H


199 
	#SM_UNDEF
 0

	)

200 
	#SM_PRE_INIT
 1

	)

201 
	#SM_POST_INIT
 2

	)

202 
	gsig«l_mode
;

206 
	$¥e_öô_sig«l_ˇtch
 ()

208 #i‚de‡
WIN32


209 #ifde‡
HAVE_SIGNAL_H


210 
sig«l_mode
 = 
SM_PRE_INIT
;

211 
	`sig«l
 (
SIGINT
, 
sig«l_h™dÀr
);

212 
	`sig«l
 (
SIGTERM
, 
sig«l_h™dÀr
);

213 
	`sig«l
 (
SIGHUP
, 
SIG_IGN
);

214 
	`sig«l
 (
SIGUSR1
, 
SIG_IGN
);

215 
	`sig«l
 (
SIGUSR2
, 
SIG_IGN
);

216 
	`sig«l
 (
SIGPIPE
, 
SIG_IGN
);

219 
	}
}

222 
	$po°_öô_sig«l_ˇtch
 ()

224 #i‚de‡
WIN32


225 #ifde‡
HAVE_SIGNAL_H


226 
sig«l_mode
 = 
SM_POST_INIT
;

227 
	`sig«l
 (
SIGINT
, 
sig«l_h™dÀr
);

228 
	`sig«l
 (
SIGTERM
, 
sig«l_h™dÀr
);

229 
	`sig«l
 (
SIGHUP
, 
sig«l_h™dÀr
);

230 
	`sig«l
 (
SIGUSR1
, 
sig«l_h™dÀr
);

231 
	`sig«l
 (
SIGUSR2
, 
sig«l_h™dÀr
);

232 
	`sig«l
 (
SIGPIPE
, 
SIG_IGN
);

235 
	}
}

239 
	$ª°‹e_sig«l_°©e
 ()

241 #ifde‡
HAVE_SIGNAL_H


242 i‡(
sig«l_mode
 =
SM_PRE_INIT
)

243 
	`¥e_öô_sig«l_ˇtch
 ();

244 i‡(
sig«l_mode
 =
SM_POST_INIT
)

245 
	`po°_öô_sig«l_ˇtch
 ();

247 
	}
}

255 
	$¥öt_°©us
 (c⁄° 
c⁄ãxt
 *
c
, 
°©us_ouçut
 *
so
)

257 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

259 
	`°©us_ª£t
 (
so
);

261 
	`°©us_¥ötf
 (
so
, "OpenVPN STATISTICS");

262 
	`°©us_¥ötf
 (
so
, "Upd©ed,%s", 
	`time_°rög
 (0, 0, 
Ál£
, &
gc
));

263 
	`°©us_¥ötf
 (
so
, "TUN/TAPÑód byãs," 
cou¡î_f‹m©
, 
c
->
c2
.
tun_ªad_byãs
);

264 
	`°©us_¥ötf
 (
so
, "TUN/TAP wrôêbyãs," 
cou¡î_f‹m©
, 
c
->
c2
.
tun_wrôe_byãs
);

265 
	`°©us_¥ötf
 (
so
, "TCP/UDPÑód byãs," 
cou¡î_f‹m©
, 
c
->
c2
.
lök_ªad_byãs
);

266 
	`°©us_¥ötf
 (
so
, "TCP/UDP wrôêbyãs," 
cou¡î_f‹m©
, 
c
->
c2
.
lök_wrôe_byãs
);

267 
	`°©us_¥ötf
 (
so
, "AuthÑód byãs," 
cou¡î_f‹m©
, 
c
->
c2
.
lök_ªad_byãs_auth
);

268 #ifde‡
ENABLE_LZO


269 i‡(
	`lzo_deföed
 (&
c
->
c2
.
lzo_compw‹k
))

270 
	`lzo_¥öt_°©s
 (&
c
->
c2
.
lzo_compw‹k
, 
so
);

272 #ifde‡
PACKET_TRUNCATION_CHECK


273 
	`°©us_¥ötf
 (
so
, "TUNÑódÅrunˇti⁄s," 
cou¡î_f‹m©
, 
c
->
c2
.
n_åunc_tun_ªad
);

274 
	`°©us_¥ötf
 (
so
, "TUN wrôêåunˇti⁄s," 
cou¡î_f‹m©
, 
c
->
c2
.
n_åunc_tun_wrôe
);

275 
	`°©us_¥ötf
 (
so
, "Pª-í¸y±Årunˇti⁄s," 
cou¡î_f‹m©
, 
c
->
c2
.
n_åunc_¥e_í¸y±
);

276 
	`°©us_¥ötf
 (
so
, "Po°-de¸y±Årunˇti⁄s," 
cou¡î_f‹m©
, 
c
->
c2
.
n_åunc_po°_de¸y±
);

278 #ifde‡
WIN32


279 i‡(
	`tu¡≠_deföed
 (
c
->
c1
.
tu¡≠
))

280 
	`°©us_¥ötf
 (
so
, "TAP-WIN32 driver status,\"%s\"",

281 
	`èp_wö_gëöfo
 (
c
->
c1
.
tu¡≠
, &
gc
));

284 
	`°©us_¥ötf
 (
so
, "END");

285 
	`°©us_Êush
 (
so
);

286 
	`gc_‰ì
 (&
gc
);

287 
	}
}

289 #ifde‡
ENABLE_OCC


296 
	$¥o˚ss_ex∂icô_exô_nŸifiˇti⁄_öô
 (
c⁄ãxt
 *
c
)

298 
	`msg
 (
M_INFO
, "SIGTERMÑeceived, sendingÉxitÇotificationÅoÖeer");

299 
	`evít_timeout_öô
 (&
c
->
c2
.
ex∂icô_exô_nŸifiˇti⁄_öãrvÆ
, 1, 0);

300 
	`ª£t_cﬂr£_timîs
 (
c
);

301 
	`sig«l_ª£t
 (
c
->
sig
);

302 
	`hÆt_n⁄_edge_åiggîed_sig«ls
 ();

303 
c
->
c2
.
ex∂icô_exô_nŸifiˇti⁄_time_waô
 = 
now
;

304 
	}
}

307 
	$¥o˚ss_ex∂icô_exô_nŸifiˇti⁄_timî_wakeup
 (
c⁄ãxt
 *
c
)

309 i‡(
	`evít_timeout_åiggî
 (&
c
->
c2
.
ex∂icô_exô_nŸifiˇti⁄_öãrvÆ
,

310 &
c
->
c2
.
timevÆ
,

311 
ETT_DEFAULT
))

313 
	`ASSERT
 (
c
->
c2
.
ex∂icô_exô_nŸifiˇti⁄_time_waô
 && c->
›ti⁄s
.
˚
.
ex∂icô_exô_nŸifiˇti⁄
);

314 i‡(
now
 >
c
->
c2
.
ex∂icô_exô_nŸifiˇti⁄_time_waô
 + c->
›ti⁄s
.
˚
.
ex∂icô_exô_nŸifiˇti⁄
)

316 
	`evít_timeout_˛ór
 (&
c
->
c2
.
ex∂icô_exô_nŸifiˇti⁄_öãrvÆ
);

317 
c
->
sig
->
sig«l_ª˚ived
 = 
SIGTERM
;

318 
c
->
sig
->
sig«l_ãxt
 = "exit-with-notification";

322 
c
->
c2
.
occ_›
 = 
OCC_EXIT
;

325 
	}
}

333 
	$ªm≠_sig«l
 (
c⁄ãxt
 *
c
)

335 i‡(
c
->
sig
->
sig«l_ª˚ived
 =
SIGUSR1
 && c->
›ti⁄s
.
ªm≠_sigu§1
)

336 
c
->
sig
->
sig«l_ª˚ived
 = c->
›ti⁄s
.
ªm≠_sigu§1
;

337 
	}
}

340 
	$¥o˚ss_sigu§2
 (c⁄° 
c⁄ãxt
 *
c
)

342 
°©us_ouçut
 *
so
 = 
	`°©us_›í
 (
NULL
, 0, 
M_INFO
, NULL, 0);

343 
	`¥öt_°©us
 (
c
, 
so
);

344 
	`°©us_˛o£
 (
so
);

345 
	`sig«l_ª£t
 (
c
->
sig
);

346 
	}
}

348 
boﬁ


349 
	$¥o˚ss_sigãrm
 (
c⁄ãxt
 *
c
)

351 
boﬁ
 
ªt
 = 
åue
;

352 #ifde‡
ENABLE_OCC


353 i‡(
c
->
›ti⁄s
.
˚
.
ex∂icô_exô_nŸifiˇti⁄


354 && !
c
->
c2
.
ex∂icô_exô_nŸifiˇti⁄_time_waô
)

356 
	`¥o˚ss_ex∂icô_exô_nŸifiˇti⁄_öô
 (
c
);

357 
ªt
 = 
Ál£
;

360  
ªt
;

361 
	}
}

363 
boﬁ


364 
	$¥o˚ss_sig«l
 (
c⁄ãxt
 *
c
)

366 
boﬁ
 
ªt
 = 
åue
;

368 i‡(
c
->
sig
->
sig«l_ª˚ived
 =
SIGTERM
 || c->sig->sig«l_ª˚ived =
SIGINT
)

370 
ªt
 = 
	`¥o˚ss_sigãrm
 (
c
);

372 i‡(
c
->
sig
->
sig«l_ª˚ived
 =
SIGUSR2
)

374 
	`¥o˚ss_sigu§2
 (
c
);

375 
ªt
 = 
Ál£
;

377  
ªt
;

378 
	}
}

381 
	$ªgi°î_sig«l
 (
c⁄ãxt
 *
c
, 
sig
, c⁄° *
ãxt
)

383 i‡(
c
->
sig
->
sig«l_ª˚ived
 !
SIGTERM
)

384 
c
->
sig
->
sig«l_ª˚ived
 = sig;

385 
c
->
sig
->
sig«l_ãxt
 = 
ãxt
;

386 
	}
}

	@src/openvpn/sig.h

25 #i‚de‡
SIG_H


26 
	#SIG_H


	)

28 
	~"°©us.h
"

29 
	~"wö32.h
"

35 
	ssig«l_öfo


37 vﬁ©ûê
	msig«l_ª˚ived
;

38 vﬁ©ûê
boﬁ
 
	mh¨d
;

39 c⁄° *
	msig«l_ãxt
;

42 
	#IS_SIG
(
c
Ë((c)->
sig
->
sig«l_ª˚ived
)

	)

44 
	gc⁄ãxt
;

46 
sig«l_öfo
 
sigöfo_°©ic
;

48 
∑r£_sig«l
 (c⁄° *
sig«me
);

49 c⁄° *
sig«l_«me
 (c⁄° 
sig
, c⁄° 
boﬁ
 
uµî
);

50 c⁄° *
sig«l_des¸ùti⁄
 (c⁄° 
signum
, c⁄° *
sigãxt
);

51 
throw_sig«l
 (c⁄° 
signum
);

52 
throw_sig«l_so·
 (c⁄° 
signum
, c⁄° *
sig«l_ãxt
);

54 
¥e_öô_sig«l_ˇtch
 ();

55 
po°_öô_sig«l_ˇtch
 ();

56 
ª°‹e_sig«l_°©e
 ();

58 
¥öt_sig«l
 (c⁄° 
sig«l_öfo
 *
si
, c⁄° *
tôÀ
, 
msgÀvñ
);

59 
¥öt_°©us
 (c⁄° 
c⁄ãxt
 *
c
, 
°©us_ouçut
 *
so
);

61 
ªm≠_sig«l
 (
c⁄ãxt
 *
c
);

63 
sig«l_ª°¨t_°©us
 (c⁄° 
sig«l_öfo
 *
si
);

65 
boﬁ
 
¥o˚ss_sig«l
 (
c⁄ãxt
 *
c
);

67 
ªgi°î_sig«l
 (
c⁄ãxt
 *
c
, 
sig
, c⁄° *
ãxt
);

69 #ifde‡
ENABLE_OCC


70 
¥o˚ss_ex∂icô_exô_nŸifiˇti⁄_timî_wakeup
 (
c⁄ãxt
 *
c
);

73 #ifde‡
WIN32


75 
ölöe
 

76 
	$gë_sig«l
 (vﬁ©ûê*
sig
)

78 *
sig
 = 
	`wö32_sig«l_gë
 (&
wö32_sig«l
);

79 
	}
}

81 
ölöe
 

82 
	$hÆt_n⁄_edge_åiggîed_sig«ls
 ()

84 
	`wö32_sig«l_˛o£
 (&
wö32_sig«l
);

85 
	}
}

89 
ölöe
 

90 
	$gë_sig«l
 (vﬁ©ûê*
sig
)

92 c⁄° 
i
 = 
sigöfo_°©ic
.
sig«l_ª˚ived
;

93 i‡(
i
)

94 *
sig
 = 
i
;

95 
	}
}

97 
ölöe
 

98 
	$hÆt_n⁄_edge_åiggîed_sig«ls
 ()

100 
	}
}

	@src/openvpn/socket.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"sockë.h
"

34 
	~"fdmisc.h
"

35 
	~"misc.h
"

36 
	~"gªmlö.h
"

37 
	~"∂ugö.h
"

38 
	~"ps.h
"

39 
	~"m™age.h
"

40 
	~"misc.h
"

42 
	~"memdbg.h
"

44 c⁄° 
	g¥Ÿo_ovîhód
[] = {

46 
IPv4_UDP_HEADER_SIZE
,

47 
IPv4_TCP_HEADER_SIZE
,

48 
IPv4_TCP_HEADER_SIZE
,

49 
IPv6_UDP_HEADER_SIZE
,

50 
IPv6_TCP_HEADER_SIZE
,

51 
IPv6_TCP_HEADER_SIZE
,

52 
IPv6_TCP_HEADER_SIZE
,

59 
	$sf2gaf
(c⁄° 
gëaddr_Êags
,

60 c⁄° 
sockÊags
)

62 i‡(
sockÊags
 & 
SF_HOST_RANDOMIZE
)

63  
gëaddr_Êags
 | 
GETADDR_RANDOMIZE
;

65  
gëaddr_Êags
;

66 
	}
}

73 
	$h_î∫o_msg
(
h_î∫o_îr
)

75 
h_î∫o_îr
)

77 
HOST_NOT_FOUND
:

79 
NO_DATA
:

81 
NO_RECOVERY
:

83 
TRY_AGAIN
:

87 
	}
}

94 
ö_addr_t


95 
	$gëaddr
 (
Êags
,

96 c⁄° *
ho°«me
,

97 
ªsﬁve_ªåy_£c⁄ds
,

98 
boﬁ
 *
suc˚eded
,

99 vﬁ©ûê*
sig«l_ª˚ived
)

101 
addröfo
 *
ai
;

102 
°©us
;

103 
°©us
 = 
	`›ív≤_gëaddröfo
(
Êags
, 
ho°«me
, 
ªsﬁve_ªåy_£c⁄ds
,

104 
sig«l_ª˚ived
, 
AF_INET
, &
ai
);

105 if(
°©us
==0) {

106 
ö_addr
 
ü
;

107 if(
suc˚eded
)

108 *
suc˚eded
=
åue
;

109 
ü
 = ((
sockaddr_ö
*)
ai
->
ai_addr
)->
sö_addr
;

110 
	`‰ìaddröfo
(
ai
);

111  (
Êags
 & 
GETADDR_HOST_ORDER
Ë? 
	`¡ohl
 (
ü
.
s_addr
) : ia.s_addr;

113 if(
suc˚eded
)

114 *
suc˚eded
 =
Ál£
;

117 
	}
}

125 
	$›ív≤_gëaddröfo
 (
Êags
,

126 c⁄° *
ho°«me
,

127 
ªsﬁve_ªåy_£c⁄ds
,

128 vﬁ©ûê*
sig«l_ª˚ived
,

129 
ai_Ámûy
,

130 
addröfo
 **
ªs
)

132 
addröfo
 
höts
;

133 
°©us
;

134 
sigªc
 = 0;

135 
msgÀvñ
 = (
Êags
 & 
GETADDR_FATAL
Ë? 
M_FATAL
 : 
D_RESOLVE_ERRORS
;

136 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

138 
	`ASSERT
(
ªs
);

140 #i‡
	`deföed
(
HAVE_RES_INIT
)

141 
	`ªs_öô
 ();

144 i‡(!
ho°«me
)

145 
ho°«me
 = "::";

147 i‡(
Êags
 & 
GETADDR_RANDOMIZE
)

148 
ho°«me
 = 
	`ho°«me_øndomize
(ho°«me, &
gc
);

150 i‡(
Êags
 & 
GETADDR_MSG_VIRT_OUT
)

151 
msgÀvñ
 |
M_MSG_VIRT_OUT
;

153 i‡((
Êags
 & (
GETADDR_FATAL_ON_SIGNAL
|
GETADDR_WARN_ON_SIGNAL
))

154 && !
sig«l_ª˚ived
)

155 
sig«l_ª˚ived
 = &
sigªc
;

158 
	`CLEAR
(
höts
);

159 
höts
.
ai_Ámûy
 =ái_family;

160 
höts
.
ai_Êags
 = 
AI_NUMERICHOST
;

161 
höts
.
ai_sockty≥
 = 
SOCK_STREAM
;

163 
°©us
 = 
	`gëaddröfo
(
ho°«me
, 
NULL
, &
höts
, 
ªs
);

165 i‡(
°©us
 != 0)

167 c⁄° 
Áû_waô_öãrvÆ
 = 5;

168 
ªsﬁve_ªåõs
 = (
Êags
 & 
GETADDR_TRY_ONCE
Ë? 1 : (
ªsﬁve_ªåy_£c⁄ds
 / 
Áû_waô_öãrvÆ
);

169 c⁄° *
fmt
;

170 
Àvñ
 = 0;

172 
fmt
 = "RESOLVE: CannotÑesolve hostáddress: %s: %s";

173 i‡((
Êags
 & 
GETADDR_MENTION_RESOLVE_RETRY
)

174 && !
ªsﬁve_ªåy_£c⁄ds
)

175 
fmt
 = "RESOLVE: CannotÑesolve hostáddress: %s: %s (I would haveÑetriedÅhisÇame query if you had specifiedÅhe --resolv-retry option.)";

177 i‡(!(
Êags
 & 
GETADDR_RESOLVE
Ë|| 
°©us
 =
EAI_FAIL
)

179 
	`msg
 (
msgÀvñ
, "RESOLVE: C™nŸÖ¨£ IPáddªss: %s", 
ho°«me
);

180 
d⁄e
;

183 #ifde‡
ENABLE_MANAGEMENT


184 i‡(
Êags
 & 
GETADDR_UPDATE_MANAGEMENT_STATE
)

186 i‡(
m™agemít
)

187 
	`m™agemít_£t_°©e
 (
m™agemít
,

188 
OPENVPN_STATE_RESOLVE
,

189 
NULL
,

190 (
ö_addr_t
)0,

191 (
ö_addr_t
)0);

198 
åue
)

201 
höts
.
ai_Êags
 = 0;

202 
	`dmsg
 (
D_SOCKET_DEBUG
, "GETADDRINFO flags=0x%04xái_family=%dái_socktype=%d",

203 
Êags
, 
höts
.
ai_Ámûy
, höts.
ai_sockty≥
);

204 
°©us
 = 
	`gëaddröfo
(
ho°«me
, 
NULL
, &
höts
, 
ªs
);

206 i‡(
sig«l_ª˚ived
)

208 
	`gë_sig«l
 (
sig«l_ª˚ived
);

209 i‡(*
sig«l_ª˚ived
)

211 i‡(*
sig«l_ª˚ived
 =
SIGUSR1
)

213 
	`msg
 (
Àvñ
, "RESOLVE: Ignored SIGUSR1 signalÑeceived during DNSÑesolutionáttempt");

214 *
sig«l_ª˚ived
 = 0;

218 i‡(0 =
°©us
) {

219 
	`ASSERT
(
ªs
);

220 
	`‰ìaddröfo
(*
ªs
);

221 
ªs
 = 
NULL
;

223 
d⁄e
;

229 i‡(0 =
°©us
)

234 
Àvñ
 = 
msgÀvñ
;

235 i‡(
ªsﬁve_ªåõs
 > 0)

236 
Àvñ
 = 
D_RESOLVE_ERRORS
;

238 
	`msg
 (
Àvñ
,

239 
fmt
,

240 
ho°«me
,

241 
	`gai_°ªº‹
(
°©us
));

243 i‡(--
ªsﬁve_ªåõs
 <= 0)

244 
d⁄e
;

246 
	`›ív≤_¶ìp
 (
Áû_waô_öãrvÆ
);

249 
	`ASSERT
(
ªs
);

262 
d⁄e
:

263 i‡(
sig«l_ª˚ived
 && *signal_received)

265 
Àvñ
 = 0;

266 i‡(
Êags
 & 
GETADDR_FATAL_ON_SIGNAL
)

267 
Àvñ
 = 
M_FATAL
;

268 i‡(
Êags
 & 
GETADDR_WARN_ON_SIGNAL
)

269 
Àvñ
 = 
M_WARN
;

270 
	`msg
 (
Àvñ
, "RESOLVE: signalÑeceived during DNSÑesolutionáttempt");

273 
	`gc_‰ì
 (&
gc
);

274  
°©us
;

275 
	}
}

282 
	$›ív≤_öë_©⁄
 (c⁄° *
dŸãd_quad
, 
ö_addr
 *
addr
)

284 
a
, 
b
, 
c
, 
d
;

286 
	`CLEAR
 (*
addr
);

287 i‡(
	`ssˇnf
 (
dŸãd_quad
, "%u.%u.%u.%u", &
a
, &
b
, &
c
, &
d
) == 4)

289 i‡(
a
 < 256 && 
b
 < 256 && 
c
 < 256 && 
d
 < 256)

291 
addr
->
s_addr
 = 
	`ht⁄l
 (
a
<<24 | 
b
<<16 | 
c
<<8 | 
d
);

292  
OIA_IP
;

295 i‡(
	`°rög_˛ass
 (
dŸãd_quad
, 
CC_DIGIT
|
CC_DOT
, 0))

296  
OIA_ERROR
;

298  
OIA_HOSTNAME
;

299 
	}
}

301 
boﬁ


302 
	$ù_addr_dŸãd_quad_ß„
 (c⁄° *
dŸãd_quad
)

305 i‡(!
dŸãd_quad
)

306  
Ál£
;

309 i‡(
	`°æí
 (
dŸãd_quad
) > 15)

310  
Ál£
;

315 
¬um
 = 0;

316 c⁄° *
p
 = 
dŸãd_quad
;

317 
c
;

319 (
c
 = *
p
++))

321 i‡(
c
 >= '0' && c <= '9')

323 ++
¬um
;

324 i‡(
¬um
 > 3)

325  
Ál£
;

327 i‡(
c
 == '.')

329 
¬um
 = 0;

332  
Ál£
;

338 
ö_addr
 
a
;

339  
	`›ív≤_öë_©⁄
 (
dŸãd_quad
, &
a
Ë=
OIA_IP
;

341 
	}
}

343 
boﬁ


344 
	$ùv6_addr_ß„
 (c⁄° *
ùv6_ãxt_addr
)

347 i‡(!
ùv6_ãxt_addr
)

348  
Ál£
;

351 i‡(
	`°æí
 (
ùv6_ãxt_addr
Ë> 
INET6_ADDRSTRLEN
 )

352  
Ál£
;

356 
ö6_addr
 
a6
;

357  
	`öë_±⁄
–
AF_INET6
, 
ùv6_ãxt_addr
, &
a6
 ) == 1;

359 
	}
}

361 
boﬁ


362 
	$dns_addr_ß„
 (c⁄° *
addr
)

364 i‡(
addr
)

366 c⁄° 
size_t
 
Àn
 = 
	`°æí
 (
addr
);

367  
Àn
 > 0 &&Üí <255 && 
	`°rög_˛ass
 (
addr
, 
CC_ALNUM
|
CC_DASH
|
CC_DOT
, 0);

370  
Ál£
;

371 
	}
}

373 
boﬁ


374 
	$ù_‹_dns_addr_ß„
 (c⁄° *
addr
, c⁄° 
boﬁ
 
Ælow_fqdn
)

376 i‡(
	`ù_addr_dŸãd_quad_ß„
 (
addr
))

377  
åue
;

378 i‡(
Ælow_fqdn
)

379  
	`dns_addr_ß„
 (
addr
);

381  
Ál£
;

382 
	}
}

384 
boﬁ


385 
	$mac_addr_ß„
 (c⁄° *
mac_addr
)

388 i‡(!
mac_addr
)

389  
Ál£
;

392 i‡(
	`°æí
 (
mac_addr
) > 17)

393  
Ál£
;

398 
¬um
 = 0;

399 c⁄° *
p
 = 
mac_addr
;

400 
c
;

402 (
c
 = *
p
++))

404 i‡–(
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') || (c >= 'A' && c <= 'F') )

406 ++
¬um
;

407 i‡(
¬um
 > 2)

408  
Ál£
;

410 i‡(
c
 == ':')

412 
¬um
 = 0;

415  
Ál£
;

420  
åue
;

421 
	}
}

424 
	$upd©e_ªmŸe
 (c⁄° * 
ho°
,

425 
›ív≤_sockaddr
 *
addr
,

426 
boﬁ
 *
ch™ged
,

427 c⁄° 
sockÊags
)

429 
addr
->addr.
ß
.
ß_Ámûy
)

431 
AF_INET
:

432 i‡(
ho°
 && 
addr
)

434 c⁄° 
ö_addr_t
 
√w_addr
 = 
	`gëaddr
 (

435 
	`sf2gaf
(
GETADDR_RESOLVE
|
GETADDR_UPDATE_MANAGEMENT_STATE
, 
sockÊags
),

436 
ho°
,

438 
NULL
,

439 
NULL
);

440 i‡(
√w_addr
 && 
addr
->addr.
ö4
.
sö_addr
.
s_addr
 !=Çew_addr)

442 
addr
->addr.
ö4
.
sö_addr
.
s_addr
 = 
√w_addr
;

443 *
ch™ged
 = 
åue
;

447 
AF_INET6
:

448 i‡(
ho°
 && 
addr
)

450 
°©us
;

451 
addröfo
* 
ai
;

453 
°©us
 = 
	`›ív≤_gëaddröfo
(
	`sf2gaf
(
GETADDR_RESOLVE
|
GETADDR_UPDATE_MANAGEMENT_STATE
, 
sockÊags
), 
ho°
, 1, 
NULL
, 
AF_INET6
, &
ai
);

455 i‡–
°©us
 ==0 )

457 
sockaddr_ö6
 
sö6
;

458 
	`CLEAR
(
sö6
);

459 
sö6
 = *((
sockaddr_ö6
*)
ai
->
ai_addr
);

460 i‡(!
	`IN6_ARE_ADDR_EQUAL
(&
sö6
.
sö6_addr
, &
addr
->addr.
ö6
.sin6_addr))

462 
p‹t
 = 
addr
->addr.
ö6
.
sö6_p‹t
;

464 
addr
->addr.
ö6
 = 
sö6
;

465 
addr
->addr.
ö6
.
sö6_p‹t
 = 
p‹t
;

467 
	`‰ìaddröfo
(
ai
);

472 
	`ASSERT
(0);

474 
	}
}

477 
	$sockë_gë_¢dbuf
 (
sd
)

479 #i‡
	`deföed
(
HAVE_GETSOCKOPT
Ë&& deföed(
SOL_SOCKET
Ë&& deföed(
SO_SNDBUF
)

480 
vÆ
;

481 
sockÀn_t
 
Àn
;

483 
Àn
 =  (
vÆ
);

484 i‡(
	`gësock›t
 (
sd
, 
SOL_SOCKET
, 
SO_SNDBUF
, (*Ë&
vÆ
, &
Àn
) == 0

485 && 
Àn
 = (
vÆ
))

486  
vÆ
;

489 
	}
}

492 
	$sockë_£t_¢dbuf
 (
sd
, 
size
)

494 #i‡
	`deföed
(
HAVE_SETSOCKOPT
Ë&& deföed(
SOL_SOCKET
Ë&& deföed(
SO_SNDBUF
)

495 i‡(
size
 > 0 && sizê< 
SOCKET_SND_RCV_BUF_MAX
)

497 i‡(
	`£tsock›t
 (
sd
, 
SOL_SOCKET
, 
SO_SNDBUF
, (*Ë&
size
,  (size)) != 0)

499 
	`msg
 (
M_WARN
, "NOTE: sësock›àSO_SNDBUF=%d faûed", 
size
);

503 
	}
}

506 
	$sockë_gë_rcvbuf
 (
sd
)

508 #i‡
	`deföed
(
HAVE_GETSOCKOPT
Ë&& deföed(
SOL_SOCKET
Ë&& deföed(
SO_RCVBUF
)

509 
vÆ
;

510 
sockÀn_t
 
Àn
;

512 
Àn
 =  (
vÆ
);

513 i‡(
	`gësock›t
 (
sd
, 
SOL_SOCKET
, 
SO_RCVBUF
, (*Ë&
vÆ
, &
Àn
) == 0

514 && 
Àn
 = (
vÆ
))

515  
vÆ
;

518 
	}
}

520 
boﬁ


521 
	$sockë_£t_rcvbuf
 (
sd
, 
size
)

523 #i‡
	`deföed
(
HAVE_SETSOCKOPT
Ë&& deföed(
SOL_SOCKET
Ë&& deföed(
SO_RCVBUF
)

524 i‡(
size
 > 0 && sizê< 
SOCKET_SND_RCV_BUF_MAX
)

526 i‡(
	`£tsock›t
 (
sd
, 
SOL_SOCKET
, 
SO_RCVBUF
, (*Ë&
size
,  (size)) != 0)

528 
	`msg
 (
M_WARN
, "NOTE: sësock›àSO_RCVBUF=%d faûed", 
size
);

529  
Ál£
;

532  
åue
;

534 
	}
}

537 
	$sockë_£t_buf„rs
 (
fd
, c⁄° 
sockë_buf„r_size
 *
sbs
)

539 i‡(
sbs
)

541 c⁄° 
¢dbuf_ﬁd
 = 
	`sockë_gë_¢dbuf
 (
fd
);

542 c⁄° 
rcvbuf_ﬁd
 = 
	`sockë_gë_rcvbuf
 (
fd
);

544 i‡(
sbs
->
¢dbuf
)

545 
	`sockë_£t_¢dbuf
 (
fd
, 
sbs
->
¢dbuf
);

547 i‡(
sbs
->
rcvbuf
)

548 
	`sockë_£t_rcvbuf
 (
fd
, 
sbs
->
rcvbuf
);

550 
	`msg
 (
D_OSBUF
, "Socket Buffers: R=[%d->%d] S=[%d->%d]",

551 
rcvbuf_ﬁd
,

552 
	`sockë_gë_rcvbuf
 (
fd
),

553 
¢dbuf_ﬁd
,

554 
	`sockë_gë_¢dbuf
 (
fd
));

556 
	}
}

562 
boﬁ


563 
	$sockë_£t_t˝_nodñay
 (
sd
, 
°©e
)

565 #i‡
	`deföed
(
WIN32
Ë|| (deföed(
HAVE_SETSOCKOPT
Ë&& deföed(
IPPROTO_TCP
Ë&& deföed(
TCP_NODELAY
))

566 i‡(
	`£tsock›t
 (
sd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (*Ë&
°©e
,  (state)) != 0)

568 
	`msg
 (
M_WARN
, "NOTE: sësock›àTCP_NODELAY=%d faûed", 
°©e
);

569  
Ál£
;

573 
	`dmsg
 (
D_OSBUF
, "Sockë fœgs: TCP_NODELAY=%d suc˚eded", 
°©e
);

574  
åue
;

577 
	`msg
 (
M_WARN
, "NOTE: sësock›àTCP_NODELAY=%d faûed (Nÿkî√»suµ‹t)", 
°©e
);

578  
Ál£
;

580 
	}
}

582 
ölöe
 

583 
	$sockë_£t_m¨k
 (
sd
, 
m¨k
)

585 #i‡
	`deföed
(
TARGET_LINUX
Ë&& 
HAVE_DECL_SO_MARK


586 i‡(
m¨k
 && 
	`£tsock›t
 (
sd
, 
SOL_SOCKET
, 
SO_MARK
, &mark,  (mark)) != 0)

587 
	`msg
 (
M_WARN
, "NOTE: sësock›àSO_MARK=%d faûed", 
m¨k
);

589 
	}
}

591 
boﬁ


592 
	$sockë_£t_Êags
 (
sd
, 
sockÊags
)

594 i‡(
sockÊags
 & 
SF_TCP_NODELAY
)

595  
	`sockë_£t_t˝_nodñay
 (
sd
, 1);

597  
åue
;

598 
	}
}

600 
boﬁ


601 
	$lök_sockë_upd©e_Êags
 (
lök_sockë
 *
ls
, 
sockÊags
)

603 i‡(
ls
 && 
	`sockë_deföed
 (ls->
sd
))

604  
	`sockë_£t_Êags
 (
ls
->
sd
,Üs->
sockÊags
 = sockflags);

606  
Ál£
;

607 
	}
}

610 
	$lök_sockë_upd©e_buf„r_sizes
 (
lök_sockë
 *
ls
, 
rcvbuf
, 
¢dbuf
)

612 i‡(
ls
 && 
	`sockë_deföed
 (ls->
sd
))

614 
ls
->
sockë_buf„r_sizes
.
¢dbuf
 = sndbuf;

615 
ls
->
sockë_buf„r_sizes
.
rcvbuf
 =Ñcvbuf;

616 
	`sockë_£t_buf„rs
 (
ls
->
sd
, &ls->
sockë_buf„r_sizes
);

618 
	}
}

625 
sockë_des¸ùt‹_t


626 
	$¸óã_sockë_t˝
 (
af
)

628 
sockë_des¸ùt‹_t
 
sd
;

630 i‡((
sd
 = 
	`sockë
 (
af
, 
SOCK_STREAM
, 
IPPROTO_TCP
)) < 0)

631 
	`msg
 (
M_ERR
, "Cannot create TCP socket");

633 #i‚de‡
WIN32


636 
⁄
 = 1;

637 i‡(
	`£tsock›t
 (
sd
, 
SOL_SOCKET
, 
SO_REUSEADDR
,

638 (*Ë&
⁄
,  (on)) < 0)

639 
	`msg
 (
M_ERR
, "TCP: Cannot setsockopt SO_REUSEADDR on TCP socket");

643  
sd
;

644 
	}
}

646 
sockë_des¸ùt‹_t


647 
	$¸óã_sockë_udp
 (c⁄° 
Êags
)

649 
sockë_des¸ùt‹_t
 
sd
;

651 i‡((
sd
 = 
	`sockë
 (
PF_INET
, 
SOCK_DGRAM
, 
IPPROTO_UDP
)) < 0)

652 
	`msg
 (
M_ERR
, "UDP: Cannot create UDP socket");

653 #i‡
ENABLE_IP_PKTINFO


654 i‡(
Êags
 & 
SF_USE_IP_PKTINFO
)

656 
∑d
 = 1;

657 #ifde‡
IP_PKTINFO


658 i‡(
	`£tsock›t
 (
sd
, 
SOL_IP
, 
IP_PKTINFO
,

659 (*)&
∑d
, (pad)) < 0)

660 
	`msg
(
M_ERR
, "UDP: failed setsockopt for IP_PKTINFO");

661 #ñi‡
	`deföed
(
IP_RECVDSTADDR
)

662 i‡(
	`£tsock›t
 (
sd
, 
IPPROTO_IP
, 
IP_RECVDSTADDR
,

663 (*)&
∑d
, (pad)) < 0)

664 
	`msg
(
M_ERR
, "UDP: failed setsockopt for IP_RECVDSTADDR");

666 #îr‹ 
ENABLE_IP_PKTINFO
 
is
 
£t
 
wôhout
 
IP_PKTINFO
 
x‹
 
	`IP_RECVDSTADDR
 (
fix
 
syshód
.
h
)

670  
sd
;

671 
	}
}

673 
sockë_des¸ùt‹_t


674 
	$¸óã_sockë_udp6
 (c⁄° 
Êags
)

676 
sockë_des¸ùt‹_t
 
sd
;

678 i‡((
sd
 = 
	`sockë
 (
PF_INET6
, 
SOCK_DGRAM
, 
IPPROTO_UDP
)) < 0)

679 
	`msg
 (
M_ERR
, "UDP: Cannot create UDP6 socket");

680 #i‡
ENABLE_IP_PKTINFO


681 i‡(
Êags
 & 
SF_USE_IP_PKTINFO
)

683 
∑d
 = 1;

684 #i‚de‡
IPV6_RECVPKTINFO


685 i‡(
	`£tsock›t
 (
sd
, 
IPPROTO_IPV6
, 
IPV6_PKTINFO
,

686 (*)&
∑d
, (pad)) < 0)

688 i‡(
	`£tsock›t
 (
sd
, 
IPPROTO_IPV6
, 
IPV6_RECVPKTINFO
,

689 (*)&
∑d
, (pad)) < 0)

691 
	`msg
(
M_ERR
, "UDP: failed setsockopt for IPV6_RECVPKTINFO");

694  
sd
;

695 
	}
}

698 
	$¸óã_sockë
 (
lök_sockë
 *
sock
)

701 i‡(
sock
->
öfo
.
¥Ÿo
 =
PROTO_UDPv4
)

703 
sock
->
sd
 = 
	`¸óã_sockë_udp
 (sock->
sockÊags
);

704 
sock
->
sockÊags
 |
SF_GETADDRINFO_DGRAM
;

706 #ifde‡
ENABLE_SOCKS


707 i‡(
sock
->
socks_¥oxy
)

708 
sock
->
˘æ_sd
 = 
	`¸óã_sockë_t˝
 (
AF_INET
);

711 i‡(
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv4_SERVER


712 || 
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv4_CLIENT
)

714 
sock
->
sd
 = 
	`¸óã_sockë_t˝
 (
AF_INET
);

716 i‡(
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv6_SERVER


717 || 
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv6_CLIENT
)

719 
sock
->
sd
 = 
	`¸óã_sockë_t˝
 (
AF_INET6
);

721 i‡(
sock
->
öfo
.
¥Ÿo
 =
PROTO_UDPv6
)

723 
sock
->
sd
 = 
	`¸óã_sockë_udp6
 (sock->
sockÊags
);

724 
sock
->
sockÊags
 |
SF_GETADDRINFO_DGRAM
;

728 
	`ASSERT
 (0);

730 
	}
}

737 
	$sockë_do_li°í
 (
sockë_des¸ùt‹_t
 
sd
,

738 c⁄° 
›ív≤_sockaddr
 *
loˇl
,

739 
boﬁ
 
do_li°í
,

740 
boﬁ
 
do_£t_n⁄block
)

742 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

743 i‡(
do_li°í
)

745 
	`msg
 (
M_INFO
, "Listening for incoming TCP connection on %s",

746 
	`¥öt_sockaddr
 (
loˇl
, &
gc
));

747 i‡(
	`li°í
 (
sd
, 1))

748 
	`msg
 (
M_ERR
, "TCP:Üisten() failed");

752 i‡(
do_£t_n⁄block
)

753 
	`£t_n⁄block
 (
sd
);

755 
	`gc_‰ì
 (&
gc
);

756 
	}
}

758 
sockë_des¸ùt‹_t


759 
	$sockë_do_ac˚±
 (
sockë_des¸ùt‹_t
 
sd
,

760 
lök_sockë_a˘uÆ
 *
a˘
,

761 c⁄° 
boﬁ
 
nowaô
)

767 
sockÀn_t
 
ªmŸe_Àn_af
 = 
	`af_addr_size
(
a˘
->
de°
.
addr
.
ß
.
ß_Ámûy
);

768 
sockÀn_t
 
ªmŸe_Àn
 = (
a˘
->
de°
.
addr
);

769 
sockë_des¸ùt‹_t
 
√w_sd
 = 
SOCKET_UNDEFINED
;

771 
	`CLEAR
 (*
a˘
);

773 #ifde‡
HAVE_GETPEERNAME


774 i‡(
nowaô
)

776 
√w_sd
 = 
	`gë≥î«me
 (
sd
, &
a˘
->
de°
.
addr
.
ß
, &
ªmŸe_Àn
);

778 i‡(!
	`sockë_deföed
 (
√w_sd
))

779 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "TCP: getpeername() failed");

781 
√w_sd
 = 
sd
;

784 i‡(
nowaô
)

785 
	`msg
 (
M_WARN
, "TCP:Åhis OS doesÇotÖrovideÅhe getpeername() function");

789 
√w_sd
 = 
	`ac˚±
 (
sd
, &
a˘
->
de°
.
addr
.
ß
, &
ªmŸe_Àn
);

794 
foo
 = 0;

795 ++
foo
;

796 i‡(
foo
 & 1)

797 
√w_sd
 = -1;

801 i‡(!
	`sockë_deföed
 (
√w_sd
))

803 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "TCP:ác˚±(%dËÁûed", 
sd
);

806 i‡(
ªmŸe_Àn_af
 && 
ªmŸe_Àn
 !=Ñemote_len_af)

808 
	`msg
 (
D_LINK_ERRORS
, "TCP: Re˚ived så™gêöcomög c⁄√˘i⁄ wôh unknow¿addªs†Àngth=%d", 
ªmŸe_Àn
);

809 
	`›ív≤_˛o£_sockë
 (
√w_sd
);

810 
√w_sd
 = 
SOCKET_UNDEFINED
;

812  
√w_sd
;

813 
	}
}

816 
	$t˝_c⁄√˘i⁄_e°ablished
 (c⁄° 
lök_sockë_a˘uÆ
 *
a˘
)

818 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

819 
	`msg
 (
M_INFO
, "TCP connectionÉstablished with %s",

820 
	`¥öt_lök_sockë_a˘uÆ
 (
a˘
, &
gc
));

821 
	`gc_‰ì
 (&
gc
);

822 
	}
}

825 
	$sockë_li°í_ac˚±
 (
sockë_des¸ùt‹_t
 
sd
,

826 
lök_sockë_a˘uÆ
 *
a˘
,

827 c⁄° *
ªmŸe_dy«mic
,

828 
boﬁ
 *
ªmŸe_ch™ged
,

829 c⁄° 
›ív≤_sockaddr
 *
loˇl
,

830 
boﬁ
 
do_li°í
,

831 
boﬁ
 
nowaô
,

832 vﬁ©ûê*
sig«l_ª˚ived
)

834 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

836 
›ív≤_sockaddr
 
ªmŸe_vîify
 = 
a˘
->
de°
;

837 
√w_sd
 = 
SOCKET_UNDEFINED
;

839 
	`CLEAR
 (*
a˘
);

840 
	`sockë_do_li°í
 (
sd
, 
loˇl
, 
do_li°í
, 
åue
);

842 
åue
)

844 
°©us
;

845 
fd_£t
 
ªads
;

846 
timevÆ
 
tv
;

848 
	`FD_ZERO
 (&
ªads
);

849 
	`FD_SET
 (
sd
, &
ªads
);

850 
tv
.
tv_£c
 = 0;

851 
tv
.
tv_u£c
 = 0;

853 
°©us
 = 
	`£À˘
 (
sd
 + 1, &
ªads
, 
NULL
, NULL, &
tv
);

855 
	`gë_sig«l
 (
sig«l_ª˚ived
);

856 i‡(*
sig«l_ª˚ived
)

858 
	`gc_‰ì
 (&
gc
);

859  
sd
;

862 i‡(
°©us
 < 0)

863 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "TCP: select() failed");

865 i‡(
°©us
 <= 0)

867 
	`›ív≤_¶ìp
 (1);

871 
√w_sd
 = 
	`sockë_do_ac˚±
 (
sd
, 
a˘
, 
nowaô
);

873 i‡(
	`sockë_deföed
 (
√w_sd
))

875 
	`upd©e_ªmŸe
 (
ªmŸe_dy«mic
, &
ªmŸe_vîify
, 
ªmŸe_ch™ged
, 0);

876 i‡(
	`addr_deföed
 (&
ªmŸe_vîify
)

877 && !
	`addr_m©ch
 (&
ªmŸe_vîify
, &
a˘
->
de°
))

879 
	`msg
 (
M_WARN
,

881 
	`¥öt_lök_sockë_a˘uÆ
 (
a˘
, &
gc
));

882 i‡(
	`›ív≤_˛o£_sockë
 (
√w_sd
))

883 
	`msg
 (
M_ERR
, "TCP: close socket failed (new_sd)");

888 
	`›ív≤_¶ìp
 (1);

891 i‡(!
nowaô
 && 
	`›ív≤_˛o£_sockë
 (
sd
))

892 
	`msg
 (
M_ERR
, "TCP: close socket failed (sd)");

894 
	`t˝_c⁄√˘i⁄_e°ablished
 (
a˘
);

896 
	`gc_‰ì
 (&
gc
);

897  
√w_sd
;

898 
	}
}

901 
	$sockë_böd
 (
sockë_des¸ùt‹_t
 
sd
,

902 
›ív≤_sockaddr
 *
loˇl
,

903 c⁄° *
¥efix
)

905 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

907 i‡(
	`böd
 (
sd
, &
loˇl
->
addr
.
ß
, 
	`af_addr_size
÷oˇl->addr.ß.
ß_Ámûy
)))

909 c⁄° 
î∫um
 = 
	`›ív≤_î∫o
 ();

910 
	`msg
 (
M_FATAL
, "%s: Socket bind failed onÜocaláddress %s: %s",

911 
¥efix
,

912 
	`¥öt_sockaddr
 (
loˇl
, &
gc
),

913 
	`°ªº‹_ts
 (
î∫um
, &
gc
));

915 
	`gc_‰ì
 (&
gc
);

916 
	}
}

919 
	$›ív≤_c⁄√˘
 (
sockë_des¸ùt‹_t
 
sd
,

920 
›ív≤_sockaddr
 *
ªmŸe
,

921 
c⁄√˘_timeout
,

922 vﬁ©ûê*
sig«l_ª˚ived
)

924 
°©us
 = 0;

926 #ifde‡
CONNECT_NONBLOCK


927 
	`£t_n⁄block
 (
sd
);

928 
°©us
 = 
	`c⁄√˘
 (
sd
, &
ªmŸe
->
addr
.
ß
, 
	`af_addr_size
‘emŸe->addr.ß.
ß_Ámûy
));

929 i‡(
°©us
)

930 
°©us
 = 
	`›ív≤_î∫o
 ();

932 #ifde‡
WIN32


933 
°©us
 =
WSAEWOULDBLOCK


935 
°©us
 =
EINPROGRESS


939 
åue
)

941 
fd_£t
 
wrôes
;

942 
timevÆ
 
tv
;

944 
	`FD_ZERO
 (&
wrôes
);

945 
	`FD_SET
 (
sd
, &
wrôes
);

946 
tv
.
tv_£c
 = 0;

947 
tv
.
tv_u£c
 = 0;

949 
°©us
 = 
	`£À˘
 (
sd
 + 1, 
NULL
, &
wrôes
, NULL, &
tv
);

951 i‡(
sig«l_ª˚ived
)

953 
	`gë_sig«l
 (
sig«l_ª˚ived
);

954 i‡(*
sig«l_ª˚ived
)

956 
°©us
 = 0;

960 i‡(
°©us
 < 0)

962 
°©us
 = 
	`›ív≤_î∫o
 ();

965 i‡(
°©us
 <= 0)

967 i‡(--
c⁄√˘_timeout
 < 0)

969 
°©us
 = 
ETIMEDOUT
;

972 
	`›ív≤_¶ìp
 (1);

978 
vÆ
 = 0;

979 
sockÀn_t
 
Àn
;

981 
Àn
 =  (
vÆ
);

982 i‡(
	`gësock›t
 (
sd
, 
SOL_SOCKET
, 
SO_ERROR
, (*Ë&
vÆ
, &
Àn
) == 0

983 && 
Àn
 = (
vÆ
))

984 
°©us
 = 
vÆ
;

986 
°©us
 = 
	`›ív≤_î∫o
 ();

992 
°©us
 = 
	`c⁄√˘
 (
sd
, &
ªmŸe
->
addr
.
ß
, 
	`af_addr_size
‘emŸe->addr.ß.
ß_Ámûy
));

993 i‡(
°©us
)

994 
°©us
 = 
	`›ív≤_î∫o
 ();

997  
°©us
;

998 
	}
}

1001 
	$sockë_c⁄√˘
 (
sockë_des¸ùt‹_t
 *
sd
,

1002 
›ív≤_sockaddr
 *
loˇl
,

1003 
boﬁ
 
böd_loˇl
,

1004 
›ív≤_sockaddr
 *
ªmŸe
,

1005 c⁄° 
boﬁ
 
c⁄√˘i⁄_¥ofûes_deföed
,

1006 c⁄° *
ªmŸe_dy«mic
,

1007 
boﬁ
 *
ªmŸe_ch™ged
,

1008 c⁄° 
c⁄√˘_ªåy_£c⁄ds
,

1009 c⁄° 
c⁄√˘_timeout
,

1010 c⁄° 
c⁄√˘_ªåy_max
,

1011 c⁄° 
sockÊags
,

1012 vﬁ©ûê*
sig«l_ª˚ived
)

1014 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1015 
ªåy
 = 0;

1017 #ifde‡
CONNECT_NONBLOCK


1018 
	`msg
 (
M_INFO
, "AttemptingÅoÉstablish TCP connection with %s [nonblock]",

1019 
	`¥öt_sockaddr
 (
ªmŸe
, &
gc
));

1021 
	`msg
 (
M_INFO
, "AttemptingÅoÉstablish TCP connection with %s",

1022 
	`¥öt_sockaddr
 (
ªmŸe
, &
gc
));

1025 
åue
)

1027 
°©us
;

1029 #ifde‡
ENABLE_MANAGEMENT


1030 i‡(
m™agemít
)

1031 
	`m™agemít_£t_°©e
 (
m™agemít
,

1032 
OPENVPN_STATE_TCP_CONNECT
,

1033 
NULL
,

1034 (
ö_addr_t
)0,

1035 (
ö_addr_t
)0);

1038 
°©us
 = 
	`›ív≤_c⁄√˘
 (*
sd
, 
ªmŸe
, 
c⁄√˘_timeout
, 
sig«l_ª˚ived
);

1040 
	`gë_sig«l
 (
sig«l_ª˚ived
);

1041 i‡(*
sig«l_ª˚ived
)

1042 
d⁄e
;

1044 i‡(!
°©us
)

1047 
	`msg
 (
D_LINK_ERRORS
,

1049 
	`¥öt_sockaddr
 (
ªmŸe
, &
gc
),

1050 
c⁄√˘_ªåy_£c⁄ds
,

1051 
	`°ªº‹_ts
 (
°©us
, &
gc
));

1053 
	`gc_ª£t
 (&
gc
);

1055 
	`›ív≤_˛o£_sockë
 (*
sd
);

1056 *
sd
 = 
SOCKET_UNDEFINED
;

1058 i‡((
c⁄√˘_ªåy_max
 > 0 && ++
ªåy
 >c⁄√˘_ªåy_maxË|| 
c⁄√˘i⁄_¥ofûes_deföed
)

1060 *
sig«l_ª˚ived
 = 
SIGUSR1
;

1061 
d⁄e
;

1064 
	`›ív≤_¶ìp
 (
c⁄√˘_ªåy_£c⁄ds
);

1066 
	`gë_sig«l
 (
sig«l_ª˚ived
);

1067 i‡(*
sig«l_ª˚ived
)

1068 
d⁄e
;

1070 *
sd
 = 
	`¸óã_sockë_t˝
 (
loˇl
->
addr
.
ß
.
ß_Ámûy
);

1072 i‡(
böd_loˇl
)

1073 
	`sockë_böd
 (*
sd
, 
loˇl
, "TCP Client");

1074 
	`upd©e_ªmŸe
 (
ªmŸe_dy«mic
, 
ªmŸe
, 
ªmŸe_ch™ged
, 
sockÊags
);

1077 
	`msg
 (
M_INFO
, "TCP connectionÉstablished with %s",

1078 
	`¥öt_sockaddr
 (
ªmŸe
, &
gc
));

1080 
d⁄e
:

1081 
	`gc_‰ì
 (&
gc
);

1082 
	}
}

1088 
	$sockë_‰ame_öô
 (c⁄° 
‰ame
 *‰ame, 
lök_sockë
 *
sock
)

1090 #ifde‡
WIN32


1091 
	`ovîœµed_io_öô
 (&
sock
->
ªads
, 
‰ame
, 
FALSE
, 
Ál£
);

1092 
	`ovîœµed_io_öô
 (&
sock
->
wrôes
, 
‰ame
, 
TRUE
, 
Ál£
);

1093 
sock
->
rw_h™dÀ
.
ªad
 = sock->
ªads
.
ovîœµed
.
hEvít
;

1094 
sock
->
rw_h™dÀ
.
wrôe
 = sock->
wrôes
.
ovîœµed
.
hEvít
;

1097 i‡(
	`lök_sockë_c⁄√˘i⁄_‹õ¡ed
 (
sock
))

1099 #ifde‡
WIN32


1100 
	`°ªam_buf_öô
 (&
sock
->
°ªam_buf
,

1101 &
sock
->
ªads
.
buf_öô
,

1102 
sock
->
sockÊags
,

1103 
sock
->
öfo
.
¥Ÿo
);

1105 
	`Æloc_buf_sock_tun
 (&
sock
->
°ªam_buf_d©a
,

1106 
‰ame
,

1107 
Ál£
,

1108 
FRAME_HEADROOM_MARKER_READ_STREAM
);

1110 
	`°ªam_buf_öô
 (&
sock
->
°ªam_buf
,

1111 &
sock
->
°ªam_buf_d©a
,

1112 
sock
->
sockÊags
,

1113 
sock
->
öfo
.
¥Ÿo
);

1116 
	}
}

1123 
	$‰ame_adju°_∑th_mtu
 (
‰ame
 *‰ame, 
pmtu
, 
¥Ÿo
)

1125 
	`‰ame_£t_mtu_dy«mic
 (
‰ame
, 
pmtu
 - 
	`d©agøm_ovîhód
 (
¥Ÿo
), 
SET_MTU_UPPER_BOUND
);

1126 
	}
}

1129 
	$ªsﬁve_böd_loˇl
 (
lök_sockë
 *
sock
)

1131 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1134 i‡(!
	`addr_deföed
 (&
sock
->
öfo
.
lß
->
loˇl
))

1137 
	`addr_guess_Ámûy
(
sock
->
öfo
.
¥Ÿo
, sock->
loˇl_ho°
))

1139 
AF_INET
:

1140 
sock
->
öfo
.
lß
->
loˇl
.
addr
.
ö4
.
sö_Ámûy
 = 
AF_INET
;

1141 
sock
->
öfo
.
lß
->
loˇl
.
addr
.
ö4
.
sö_addr
.
s_addr
 =

1142 (
sock
->
loˇl_ho°
 ? 
	`gëaddr
 (
GETADDR_RESOLVE
 | 
GETADDR_WARN_ON_SIGNAL
 | 
GETADDR_FATAL
,

1143 
sock
->
loˇl_ho°
,

1145 
NULL
,

1146 
NULL
)

1147 : 
	`ht⁄l
 (
INADDR_ANY
));

1148 
sock
->
öfo
.
lß
->
loˇl
.
addr
.
ö4
.
sö_p‹t
 = 
	`ht⁄s
 (sock->
loˇl_p‹t
);

1150 
AF_INET6
:

1152 
°©us
;

1153 
	`CLEAR
(
sock
->
öfo
.
lß
->
loˇl
.
addr
.
ö6
);

1154 i‡(
sock
->
loˇl_ho°
)

1156 
addröfo
 *
ai
;

1158 
°©us
 = 
	`›ív≤_gëaddröfo
(
GETADDR_RESOLVE
 | 
GETADDR_WARN_ON_SIGNAL
 | 
GETADDR_FATAL
,

1159 
sock
->
loˇl_ho°
, 0, 
NULL
, 
AF_INET6
, &
ai
);

1160 if(
°©us
 ==0) {

1161 
sock
->
öfo
.
lß
->
loˇl
.
addr
.
ö6
 = *((
sockaddr_ö6
*)(
ai
->
ai_addr
));

1162 
	`‰ìaddröfo
(
ai
);

1167 
sock
->
öfo
.
lß
->
loˇl
.
addr
.
ö6
.
sö6_Ámûy
 = 
AF_INET6
;

1168 
sock
->
öfo
.
lß
->
loˇl
.
addr
.
ö6
.
sö6_addr
 = 
ö6addr_™y
;

1169 
°©us
 = 0;

1171 i‡(!
°©us
 == 0)

1173 
	`msg
 (
M_FATAL
, "getaddr6() failed forÜocal \"%s\": %s",

1174 
sock
->
loˇl_ho°
,

1175 
	`gai_°ªº‹
(
°©us
));

1177 
sock
->
öfo
.
lß
->
loˇl
.
addr
.
ö6
.
sö6_p‹t
 = 
	`ht⁄s
 (sock->
loˇl_p‹t
);

1184 i‡(
sock
->
böd_loˇl
)

1186 #ifde‡
ENABLE_SOCKS


1187 i‡(
sock
->
socks_¥oxy
 && sock->
öfo
.
¥Ÿo
 =
PROTO_UDPv4
)

1188 
	`sockë_böd
 (
sock
->
˘æ_sd
, &sock->
öfo
.
lß
->
loˇl
, "SOCKS");

1191 
	`sockë_böd
 (
sock
->
sd
, &sock->
öfo
.
lß
->
loˇl
, "TCP/UDP");

1193 
	`gc_‰ì
 (&
gc
);

1194 
	}
}

1197 
	$ªsﬁve_ªmŸe
 (
lök_sockë
 *
sock
,

1198 
pha£
,

1199 c⁄° **
ªmŸe_dy«mic
,

1200 vﬁ©ûê*
sig«l_ª˚ived
)

1202 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1203 
af
;

1205 i‡(!
sock
->
did_ªsﬁve_ªmŸe
)

1208 i‡(!
	`addr_deföed
 (&
sock
->
öfo
.
lß
->
ªmŸe
))

1210 
af
 = 
	`addr_guess_Ámûy
(
sock
->
öfo
.
¥Ÿo
, sock->
ªmŸe_ho°
);

1211 
af
)

1213 
AF_INET
:

1214 
sock
->
öfo
.
lß
->
ªmŸe
.
addr
.
ö4
.
sö_Ámûy
 = 
AF_INET
;

1215 
sock
->
öfo
.
lß
->
ªmŸe
.
addr
.
ö4
.
sö_addr
.
s_addr
 = 0;

1217 
AF_INET6
:

1218 
	`CLEAR
(
sock
->
öfo
.
lß
->
ªmŸe
.
addr
.
ö6
);

1219 
sock
->
öfo
.
lß
->
ªmŸe
.
addr
.
ö6
.
sö6_Ámûy
 = 
AF_INET6
;

1220 
sock
->
öfo
.
lß
->
ªmŸe
.
addr
.
ö6
.
sö6_addr
 = 
ö6addr_™y
;

1224 i‡(
sock
->
ªmŸe_ho°
)

1226 
Êags
 = 
	`sf2gaf
(
GETADDR_RESOLVE
|
GETADDR_UPDATE_MANAGEMENT_STATE
, 
sock
->
sockÊags
);

1227 
ªåy
 = 0;

1228 
°©us
 = -1;

1229 
addröfo
* 
ai
;

1231 i‡(
sock
->
c⁄√˘i⁄_¥ofûes_deföed
 && sock->
ªsﬁve_ªåy_£c⁄ds
 =
RESOLV_RETRY_INFINITE
)

1233 i‡(
pha£
 == 2)

1234 
Êags
 |(
GETADDR_TRY_ONCE
 | 
GETADDR_FATAL
);

1235 
ªåy
 = 0;

1237 i‡(
pha£
 == 1)

1239 i‡(
sock
->
ªsﬁve_ªåy_£c⁄ds
)

1241 
ªåy
 = 0;

1245 
Êags
 |(
GETADDR_FATAL
 | 
GETADDR_MENTION_RESOLVE_RETRY
);

1246 
ªåy
 = 0;

1249 i‡(
pha£
 == 2)

1251 i‡(
sock
->
ªsﬁve_ªåy_£c⁄ds
)

1253 
Êags
 |
GETADDR_FATAL
;

1254 
ªåy
 = 
sock
->
ªsﬁve_ªåy_£c⁄ds
;

1258 
	`ASSERT
 (0);

1263 
	`ASSERT
 (0);

1267 
°©us
 = 
	`›ív≤_gëaddröfo
(
Êags
, 
sock
->
ªmŸe_ho°
, 
ªåy
,

1268 
sig«l_ª˚ived
, 
af
, &
ai
);

1269 if(
°©us
 == 0) {

1270 
sock
->
öfo
.
lß
->
ªmŸe
.
addr
.
ö6
 = *((
sockaddr_ö6
*)(
ai
->
ai_addr
));

1271 
	`‰ìaddröfo
(
ai
);

1273 
	`dmsg
 (
D_SOCKET_DEBUG
, "RESOLVE_REMOTE flags=0x%04xÖhase=%dÑrs=%d sig=%d status=%d",

1274 
Êags
,

1275 
pha£
,

1276 
ªåy
,

1277 
sig«l_ª˚ived
 ? *signal_received : -1,

1278 
°©us
);

1280 i‡(
sig«l_ª˚ived
)

1282 i‡(*
sig«l_ª˚ived
)

1283 
d⁄e
;

1285 i‡(
°©us
!=0)

1287 i‡(
sig«l_ª˚ived
)

1288 *
sig«l_ª˚ived
 = 
SIGUSR1
;

1289 
d⁄e
;

1292 
af
)

1294 
AF_INET
:

1295 
sock
->
öfo
.
lß
->
ªmŸe
.
addr
.
ö4
.
sö_p‹t
 = 
	`ht⁄s
 (sock->
ªmŸe_p‹t
);

1297 
AF_INET6
:

1298 
sock
->
öfo
.
lß
->
ªmŸe
.
addr
.
ö6
.
sö6_p‹t
 = 
	`ht⁄s
 (sock->
ªmŸe_p‹t
);

1304 i‡(
	`lök_sockë_a˘uÆ_deföed
 (&
sock
->
öfo
.
lß
->
a˘uÆ
))

1306 
	`msg
 (
M_INFO
, "TCP/UDP: PreservingÑecently usedÑemoteáddress: %s",

1307 
	`¥öt_lök_sockë_a˘uÆ
 (&
sock
->
öfo
.
lß
->
a˘uÆ
, &
gc
));

1308 i‡(
ªmŸe_dy«mic
)

1309 *
ªmŸe_dy«mic
 = 
NULL
;

1313 
	`CLEAR
 (
sock
->
öfo
.
lß
->
a˘uÆ
);

1314 
sock
->
öfo
.
lß
->
a˘uÆ
.
de°
 = sock->öfo.lß->
ªmŸe
;

1318 
sock
->
did_ªsﬁve_ªmŸe
 = 
åue
;

1321 
d⁄e
:

1322 
	`gc_‰ì
 (&
gc
);

1323 
	}
}

1325 
lök_sockë
 *

1326 
	$lök_sockë_√w
 ()

1328 
lök_sockë
 *
sock
;

1330 
	`ALLOC_OBJ_CLEAR
 (
sock
, 
lök_sockë
);

1331 
sock
->
sd
 = 
SOCKET_UNDEFINED
;

1332 #ifde‡
ENABLE_SOCKS


1333 
sock
->
˘æ_sd
 = 
SOCKET_UNDEFINED
;

1335  
sock
;

1336 
	}
}

1340 
lök_sockë_öô_pha£1
 (
lök_sockë
 *
sock
,

1341 c⁄° 
boﬁ
 
c⁄√˘i⁄_¥ofûes_deföed
,

1342 c⁄° *
loˇl_ho°
,

1343 
loˇl_p‹t
,

1344 c⁄° *
ªmŸe_ho°
,

1345 
ªmŸe_p‹t
,

1346 
¥Ÿo
,

1347 
mode
,

1348 c⁄° 
lök_sockë
 *
ac˚±_‰om
,

1349 #ifde‡
ENABLE_HTTP_PROXY


1350 
hâp_¥oxy_öfo
 *
hâp_¥oxy
,

1352 #ifde‡
ENABLE_SOCKS


1353 
socks_¥oxy_öfo
 *
socks_¥oxy
,

1355 #ifde‡
ENABLE_DEBUG


1356 
gªmlö
,

1358 
boﬁ
 
böd_loˇl
,

1359 
boﬁ
 
ªmŸe_Êﬂt
,

1360 
öëd
,

1361 
lök_sockë_addr
 *
lß
,

1362 c⁄° *
ùch™ge_comm™d
,

1363 c⁄° 
∂ugö_li°
 *
∂ugös
,

1364 
ªsﬁve_ªåy_£c⁄ds
,

1365 
c⁄√˘_ªåy_£c⁄ds
,

1366 
c⁄√˘_timeout
,

1367 
c⁄√˘_ªåy_max
,

1368 
mtu_discovî_ty≥
,

1369 
rcvbuf
,

1370 
¢dbuf
,

1371 
m¨k
,

1372 
sockÊags
)

1374 
ASSERT
 (
sock
);

1376 
	gsock
->
	gc⁄√˘i⁄_¥ofûes_deföed
 = 
c⁄√˘i⁄_¥ofûes_deföed
;

1378 
	gsock
->
	gloˇl_ho°
 = 
loˇl_ho°
;

1379 
	gsock
->
	gloˇl_p‹t
 = 
loˇl_p‹t
;

1380 
	gsock
->
	gªmŸe_ho°
 = 
ªmŸe_ho°
;

1381 
	gsock
->
	gªmŸe_p‹t
 = 
ªmŸe_p‹t
;

1383 #ifde‡
ENABLE_HTTP_PROXY


1384 
	gsock
->
	ghâp_¥oxy
 = 
hâp_¥oxy
;

1387 #ifde‡
ENABLE_SOCKS


1388 
	gsock
->
	gsocks_¥oxy
 = 
socks_¥oxy
;

1391 
	gsock
->
	gböd_loˇl
 = 
böd_loˇl
;

1392 
	gsock
->
	göëd
 = 
öëd
;

1393 
	gsock
->
	gªsﬁve_ªåy_£c⁄ds
 = 
ªsﬁve_ªåy_£c⁄ds
;

1394 
	gsock
->
	gc⁄√˘_ªåy_£c⁄ds
 = 
c⁄√˘_ªåy_£c⁄ds
;

1395 
	gsock
->
	gc⁄√˘_timeout
 = 
c⁄√˘_timeout
;

1396 
	gsock
->
	gc⁄√˘_ªåy_max
 = 
c⁄√˘_ªåy_max
;

1397 
	gsock
->
	gmtu_discovî_ty≥
 = 
mtu_discovî_ty≥
;

1399 #ifde‡
ENABLE_DEBUG


1400 
	gsock
->
	ggªmlö
 = 
gªmlö
;

1403 
	gsock
->
	gsockë_buf„r_sizes
.
	grcvbuf
 = 
rcvbuf
;

1404 
	gsock
->
	gsockë_buf„r_sizes
.
	g¢dbuf
 = 
¢dbuf
;

1406 
	gsock
->
	gsockÊags
 = 
sockÊags
;

1408 
	gsock
->
	göfo
.
	g¥Ÿo
 = 
¥Ÿo
;

1409 
	gsock
->
	göfo
.
	gªmŸe_Êﬂt
 = 
ªmŸe_Êﬂt
;

1410 
	gsock
->
	göfo
.
	glß
 = 
lß
;

1411 
	gsock
->
	göfo
.
	gùch™ge_comm™d
 = 
ùch™ge_comm™d
;

1412 
	gsock
->
	göfo
.
	g∂ugös
 = 
∂ugös
;

1414 
	gsock
->
	gmode
 = 
mode
;

1415 i‡(
	gmode
 =
LS_MODE_TCP_ACCEPT_FROM
)

1417 
ASSERT
 (
ac˚±_‰om
);

1418 
ASSERT
 (
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv4_SERVER


1419 || 
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv6_SERVER


1421 
ASSERT
 (!
sock
->
öëd
);

1422 
	gsock
->
	gsd
 = 
ac˚±_‰om
->
sd
;

1425 i‡(
	gÁl£
)

1427 #ifde‡
ENABLE_HTTP_PROXY


1429 i‡(
	gsock
->
	ghâp_¥oxy
)

1431 
ASSERT
 (
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv4_CLIENT
);

1432 
ASSERT
 (!
sock
->
öëd
);

1435 
	gsock
->
	gªmŸe_ho°
 = 
hâp_¥oxy
->
›ti⁄s
.
£rvî
;

1436 
	gsock
->
	gªmŸe_p‹t
 = 
hâp_¥oxy
->
›ti⁄s
.
p‹t
;

1439 
	gsock
->
	g¥oxy_de°_ho°
 = 
ªmŸe_ho°
;

1440 
	gsock
->
	g¥oxy_de°_p‹t
 = 
ªmŸe_p‹t
;

1443 #ifde‡
ENABLE_SOCKS


1445 i‡(
	gsock
->
	gsocks_¥oxy
)

1447 
ASSERT
 (
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv4_CLIENT
 || sock->öfo.¥Ÿÿ=
PROTO_UDPv4
);

1448 
ASSERT
 (!
sock
->
öëd
);

1451 
	gsock
->
	gªmŸe_ho°
 = 
socks_¥oxy
->
£rvî
;

1452 
	gsock
->
	gªmŸe_p‹t
 = 
socks_¥oxy
->
p‹t
;

1455 
	gsock
->
	g¥oxy_de°_ho°
 = 
ªmŸe_ho°
;

1456 
	gsock
->
	g¥oxy_de°_p‹t
 = 
ªmŸe_p‹t
;

1461 
	gsock
->
	gªmŸe_ho°
 = 
ªmŸe_ho°
;

1462 
	gsock
->
	gªmŸe_p‹t
 = 
ªmŸe_p‹t
;

1466 i‡(
	gsock
->
	göfo
.
	g¥Ÿo
 =
PROTO_TCPv4_SERVER
)

1468 i‡(
sock
->
mode
 =
LS_MODE_TCP_ACCEPT_FROM
)

1469 
sock
->
böd_loˇl
 = 
Ál£
;

1471 
	gsock
->
	gböd_loˇl
 = 
åue
;

1475 i‡(
	gsock
->
	göëd
)

1477 
ASSERT
 (
sock
->
öfo
.
¥Ÿo
 !
PROTO_TCPv4_CLIENT


1478 && 
sock
->
öfo
.
¥Ÿo
 !
PROTO_TCPv6_CLIENT
);

1479 
ASSERT
 (
sockë_deföed
 (
öëd_sockë_des¸ùt‹
));

1480 
	gsock
->
	gsd
 = 
öëd_sockë_des¸ùt‹
;

1482 i‡(
	gmode
 !
LS_MODE_TCP_ACCEPT_FROM
)

1484 
¸óã_sockë
 (
sock
);

1487 
sockë_£t_buf„rs
 (
sock
->
sd
, &sock->
sockë_buf„r_sizes
);

1490 
sockë_£t_m¨k
 (
sock
->
sd
, 
m¨k
);

1492 
ªsﬁve_böd_loˇl
 (
sock
);

1493 
ªsﬁve_ªmŸe
 (
sock
, 1, 
NULL
, NULL);

1499 
	$lök_sockë_öô_pha£2
 (
lök_sockë
 *
sock
,

1500 c⁄° 
‰ame
 *frame,

1501 vﬁ©ûê*
sig«l_ª˚ived
)

1503 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1504 c⁄° *
ªmŸe_dy«mic
 = 
NULL
;

1505 
boﬁ
 
ªmŸe_ch™ged
 = 
Ál£
;

1506 
sig_ßve
 = 0;

1508 
	`ASSERT
 (
sock
);

1510 i‡(
sig«l_ª˚ived
 && *signal_received)

1512 
sig_ßve
 = *
sig«l_ª˚ived
;

1513 *
sig«l_ª˚ived
 = 0;

1517 
	`sockë_‰ame_öô
 (
‰ame
, 
sock
);

1524 i‡(
sock
->
ªsﬁve_ªåy_£c⁄ds
)

1525 
ªmŸe_dy«mic
 = 
sock
->
ªmŸe_ho°
;

1528 i‡(
sock
->
öëd
)

1530 i‡(
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv4_SERVER


1531 || 
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv6_SERVER
) {

1533 
sock
->
öfo
.
lß
->
a˘uÆ
.
de°
.
addr
.
ß
.
ß_Ámûy
 = 
AF_INET
;

1534 #ifde‡
HAVE_GETSOCKNAME


1537 
›ív≤_sockaddr
 
loˇl_addr
;

1538 
sockÀn_t
 
addæí
 = (
loˇl_addr
);

1539 i‡(
	`gësock«me
 (
sock
->
sd
, (
sockaddr
 *)&
loˇl_addr
, &
addæí
) == 0) {

1540 
sock
->
öfo
.
lß
->
a˘uÆ
.
de°
.
addr
.
ß
.
ß_Ámûy
 = 
loˇl_addr
.addr.sa.sa_family;

1541 
	`dmsg
 (
D_SOCKET_DEBUG
, "inetd(%s): using sa_family=%d from getsockname(%d)",

1542 
	`¥Ÿo2ascii
(
sock
->
öfo
.
¥Ÿo
, 
Ál£
), 
loˇl_addr
.
addr
.
ß
.
ß_Ámûy
,

1543 
sock
->
sd
);

1545 
	`msg
 (
M_WARN
, "inetd(%s): getsockname(%d) failed, using AF_INET",

1546 
	`¥Ÿo2ascii
(
sock
->
öfo
.
¥Ÿo
, 
Ál£
), sock->
sd
);

1549 
	`msg
 (
M_WARN
, "inetd(%s):Åhis OS doesÇotÖrovideÅhe getsockname() "

1551 
	`¥Ÿo2ascii
(
sock
->
öfo
.
¥Ÿo
, 
Ál£
));

1553 
sock
->
sd
 =

1554 
	`sockë_li°í_ac˚±
 (
sock
->
sd
,

1555 &
sock
->
öfo
.
lß
->
a˘uÆ
,

1556 
ªmŸe_dy«mic
,

1557 &
ªmŸe_ch™ged
,

1558 &
sock
->
öfo
.
lß
->
loˇl
,

1559 
Ál£
,

1560 
sock
->
öëd
 =
INETD_NOWAIT
,

1561 
sig«l_ª˚ived
);

1563 
	`ASSERT
 (!
ªmŸe_ch™ged
);

1564 i‡(*
sig«l_ª˚ived
)

1565 
d⁄e
;

1569 
	`ªsﬁve_ªmŸe
 (
sock
, 2, &
ªmŸe_dy«mic
, 
sig«l_ª˚ived
);

1571 i‡(*
sig«l_ª˚ived
)

1572 
d⁄e
;

1575 i‡(
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv4_SERVER


1576 ||
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv6_SERVER
)

1578 
sock
->
mode
)

1580 
LS_MODE_DEFAULT
:

1581 
sock
->
sd
 = 
	`sockë_li°í_ac˚±
 (sock->sd,

1582 &
sock
->
öfo
.
lß
->
a˘uÆ
,

1583 
ªmŸe_dy«mic
,

1584 &
ªmŸe_ch™ged
,

1585 &
sock
->
öfo
.
lß
->
loˇl
,

1586 
åue
,

1587 
Ál£
,

1588 
sig«l_ª˚ived
);

1590 
LS_MODE_TCP_LISTEN
:

1591 
	`sockë_do_li°í
 (
sock
->
sd
,

1592 &
sock
->
öfo
.
lß
->
loˇl
,

1593 
åue
,

1594 
Ál£
);

1596 
LS_MODE_TCP_ACCEPT_FROM
:

1597 
sock
->
sd
 = 
	`sockë_do_ac˚±
 (sock->sd,

1598 &
sock
->
öfo
.
lß
->
a˘uÆ
,

1599 
Ál£
);

1600 i‡(!
	`sockë_deföed
 (
sock
->
sd
))

1602 *
sig«l_ª˚ived
 = 
SIGTERM
;

1603 
d⁄e
;

1605 
	`t˝_c⁄√˘i⁄_e°ablished
 (&
sock
->
öfo
.
lß
->
a˘uÆ
);

1608 
	`ASSERT
 (0);

1611 i‡(
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv4_CLIENT


1612 ||
sock
->
öfo
.
¥Ÿo
 =
PROTO_TCPv6_CLIENT
)

1615 #ifde‡
GENERAL_PROXY_SUPPORT


1616 
boﬁ
 
¥oxy_ªåy
 = 
Ál£
;

1618 c⁄° 
boﬁ
 
¥oxy_ªåy
 = 
Ál£
;

1621 
	`sockë_c⁄√˘
 (&
sock
->
sd
,

1622 &
sock
->
öfo
.
lß
->
loˇl
,

1623 
sock
->
böd_loˇl
,

1624 &
sock
->
öfo
.
lß
->
a˘uÆ
.
de°
,

1625 
sock
->
c⁄√˘i⁄_¥ofûes_deföed
,

1626 
ªmŸe_dy«mic
,

1627 &
ªmŸe_ch™ged
,

1628 
sock
->
c⁄√˘_ªåy_£c⁄ds
,

1629 
sock
->
c⁄√˘_timeout
,

1630 
sock
->
c⁄√˘_ªåy_max
,

1631 
sock
->
sockÊags
,

1632 
sig«l_ª˚ived
);

1634 i‡(*
sig«l_ª˚ived
)

1635 
d⁄e
;

1637 i‡(
Ál£
)

1639 #ifde‡
ENABLE_HTTP_PROXY


1640 i‡(
sock
->
hâp_¥oxy
)

1642 
¥oxy_ªåy
 = 
	`e°ablish_hâp_¥oxy_∑s°hru
 (
sock
->
hâp_¥oxy
,

1643 
sock
->
sd
,

1644 
sock
->
¥oxy_de°_ho°
,

1645 
sock
->
¥oxy_de°_p‹t
,

1646 &
sock
->
°ªam_buf
.
ªsiduÆ
,

1647 
sig«l_ª˚ived
);

1650 #ifde‡
ENABLE_SOCKS


1651 i‡(
sock
->
socks_¥oxy
)

1653 
	`e°ablish_socks_¥oxy_∑s°hru
 (
sock
->
socks_¥oxy
,

1654 
sock
->
sd
,

1655 
sock
->
¥oxy_de°_ho°
,

1656 
sock
->
¥oxy_de°_p‹t
,

1657 
sig«l_ª˚ived
);

1660 i‡(
¥oxy_ªåy
)

1662 
	`›ív≤_˛o£_sockë
 (
sock
->
sd
);

1663 
sock
->
sd
 = 
	`¸óã_sockë_t˝
 (
AF_INET
);

1665 } 
¥oxy_ªåy
);

1667 #ifde‡
ENABLE_SOCKS


1668 i‡(
sock
->
öfo
.
¥Ÿo
 =
PROTO_UDPv4
 && sock->
socks_¥oxy
)

1670 
	`sockë_c⁄√˘
 (&
sock
->
˘æ_sd
,

1671 &
sock
->
öfo
.
lß
->
loˇl
,

1672 
sock
->
böd_loˇl
,

1673 &
sock
->
öfo
.
lß
->
a˘uÆ
.
de°
,

1674 
sock
->
c⁄√˘i⁄_¥ofûes_deföed
,

1675 
ªmŸe_dy«mic
,

1676 &
ªmŸe_ch™ged
,

1677 
sock
->
c⁄√˘_ªåy_£c⁄ds
,

1678 
sock
->
c⁄√˘_timeout
,

1679 
sock
->
c⁄√˘_ªåy_max
,

1680 
sock
->
sockÊags
,

1681 
sig«l_ª˚ived
);

1683 i‡(*
sig«l_ª˚ived
)

1684 
d⁄e
;

1686 
	`e°ablish_socks_¥oxy_ud∑ssoc
 (
sock
->
socks_¥oxy
,

1687 
sock
->
˘æ_sd
,

1688 
sock
->
sd
,

1689 &
sock
->
socks_ªœy
.
de°
,

1690 
sig«l_ª˚ived
);

1692 i‡(*
sig«l_ª˚ived
)

1693 
d⁄e
;

1695 
sock
->
ªmŸe_ho°
 = sock->
¥oxy_de°_ho°
;

1696 
sock
->
ªmŸe_p‹t
 = sock->
¥oxy_de°_p‹t
;

1697 
sock
->
did_ªsﬁve_ªmŸe
 = 
Ál£
;

1699 
	`addr_zîo_ho°
(&
sock
->
öfo
.
lß
->
a˘uÆ
.
de°
);

1700 
	`addr_zîo_ho°
(&
sock
->
öfo
.
lß
->
ªmŸe
);

1702 
	`ªsﬁve_ªmŸe
 (
sock
, 1, 
NULL
, 
sig«l_ª˚ived
);

1704 i‡(*
sig«l_ª˚ived
)

1705 
d⁄e
;

1709 i‡(*
sig«l_ª˚ived
)

1710 
d⁄e
;

1712 i‡(
ªmŸe_ch™ged
)

1714 
	`msg
 (
M_INFO
, "TCP/UDP: DynamicÑemoteáddress changed during TCP connectionÉstablishment");

1715 
	`addr_c›y_ho°
(&
sock
->
öfo
.
lß
->
ªmŸe
, &sock->öfo.lß->
a˘uÆ
.
de°
);

1720 
	`sockë_£t_Êags
 (
sock
->
sd
, sock->
sockÊags
);

1723 
	`£t_n⁄block
 (
sock
->
sd
);

1727 
	`£t_˛€xec
 (
sock
->
sd
);

1729 #ifde‡
ENABLE_SOCKS


1730 i‡(
	`sockë_deföed
 (
sock
->
˘æ_sd
))

1731 
	`£t_˛€xec
 (
sock
->
˘æ_sd
);

1735 
	`£t_mtu_discovî_ty≥
 (
sock
->
sd
, sock->
mtu_discovî_ty≥
);

1737 #i‡
EXTENDED_SOCKET_ERROR_CAPABILITY


1739 
	`£t_sock_exãnded_îr‹_∑ssög
 (
sock
->
sd
);

1744 c⁄° 
msgÀvñ
 = (
sock
->
mode
 =
LS_MODE_TCP_ACCEPT_FROM
Ë? 
D_INIT_MEDIUM
 : 
M_INFO
;

1746 i‡(
sock
->
öëd
)

1747 
	`msg
 (
msgÀvñ
, "%†lökÜoˇl: [öëd]", 
	`¥Ÿo2ascii
 (
sock
->
öfo
.
¥Ÿo
, 
åue
));

1749 
	`msg
 (
msgÀvñ
, "%sÜinkÜocal%s: %s",

1750 
	`¥Ÿo2ascii
 (
sock
->
öfo
.
¥Ÿo
, 
åue
),

1751 (
sock
->
böd_loˇl
 ? " (bound)" : ""),

1752 
	`¥öt_sockaddr_ex
 (&
sock
->
öfo
.
lß
->
loˇl
, ":", sock->
böd_loˇl
 ? 
PS_SHOW_PORT
 : 0, &
gc
));

1755 
	`msg
 (
msgÀvñ
, "%sÜinkÑemote: %s",

1756 
	`¥Ÿo2ascii
 (
sock
->
öfo
.
¥Ÿo
, 
åue
),

1757 
	`¥öt_lök_sockë_a˘uÆ_ex
 (&
sock
->
öfo
.
lß
->
a˘uÆ
,

1759 
PS_SHOW_PORT_IF_DEFINED
,

1760 &
gc
));

1763 
d⁄e
:

1764 i‡(
sig_ßve
 && 
sig«l_ª˚ived
)

1766 i‡(!*
sig«l_ª˚ived
)

1767 *
sig«l_ª˚ived
 = 
sig_ßve
;

1769 
	`gc_‰ì
 (&
gc
);

1770 
	}
}

1773 
	$lök_sockë_˛o£
 (
lök_sockë
 *
sock
)

1775 i‡(
sock
)

1777 #ifde‡
ENABLE_DEBUG


1778 c⁄° 
gªmlö
 = 
	`GREMLIN_CONNECTION_FLOOD_LEVEL
 (
sock
->gremlin);

1780 c⁄° 
gªmlö
 = 0;

1783 i‡(
	`sockë_deföed
 (
sock
->
sd
))

1785 #ifde‡
WIN32


1786 
	`˛o£_√t_evít_wö32
 (&
sock
->
li°í_h™dÀ
, sock->
sd
, 0);

1788 i‡(!
gªmlö
)

1790 
	`msg
 (
D_LOW
, "TCP/UDP: Closing socket");

1791 i‡(
	`›ív≤_˛o£_sockë
 (
sock
->
sd
))

1792 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "TCP/UDP: Close Socket failed");

1794 
sock
->
sd
 = 
SOCKET_UNDEFINED
;

1795 #ifde‡
WIN32


1796 i‡(!
gªmlö
)

1798 
	`ovîœµed_io_˛o£
 (&
sock
->
ªads
);

1799 
	`ovîœµed_io_˛o£
 (&
sock
->
wrôes
);

1804 #ifde‡
ENABLE_SOCKS


1805 i‡(
	`sockë_deföed
 (
sock
->
˘æ_sd
))

1807 i‡(
	`›ív≤_˛o£_sockë
 (
sock
->
˘æ_sd
))

1808 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "TCP/UDP: Close Socket (ctrl_sd) failed");

1809 
sock
->
˘æ_sd
 = 
SOCKET_UNDEFINED
;

1813 
	`°ªam_buf_˛o£
 (&
sock
->
°ªam_buf
);

1814 
	`‰ì_buf
 (&
sock
->
°ªam_buf_d©a
);

1815 i‡(!
gªmlö
)

1816 
	`‰ì
 (
sock
);

1818 
	}
}

1822 
	$sockë_adju°_‰ame_∑ømëîs
 (
‰ame
 *‰ame, 
¥Ÿo
)

1824 i‡(
	`lök_sockë_¥Ÿo_c⁄√˘i⁄_‹õ¡ed
 (
¥Ÿo
))

1825 
	`‰ame_add_to_exåa_‰ame
 (
‰ame
,  (
∑ckë_size_ty≥
));

1826 
	}
}

1829 
	$£ãnv_åu°ed
 (
ív_£t
 *
es
, c⁄° 
lök_sockë_öfo
 *
öfo
)

1831 
	`£ãnv_lök_sockë_a˘uÆ
 (
es
, "åu°ed", &
öfo
->
lß
->
a˘uÆ
, 
SA_IP_PORT
);

1832 
	}
}

1835 
	$ùch™ge_fmt
 (c⁄° 
boﬁ
 
ö˛ude_cmd
, 
¨gv
 *¨gv, c⁄° 
lök_sockë_öfo
 *
öfo
, 
gc_¨ía
 *
gc
)

1837 c⁄° *
ù
 = 
	`¥öt_sockaddr_ex
 (&
öfo
->
lß
->
a˘uÆ
.
de°
, 
NULL
, 0, 
gc
);

1838 c⁄° *
p‹t
 = 
	`¥öt_sockaddr_ex
 (&
öfo
->
lß
->
a˘uÆ
.
de°
, 
NULL
, 
PS_DONT_SHOW_ADDR
|
PS_SHOW_PORT
, 
gc
);

1839 i‡(
ö˛ude_cmd
)

1840 
	`¨gv_¥ötf
 (
¨gv
, "%sc %s %s",

1841 
öfo
->
ùch™ge_comm™d
,

1842 
ù
,

1843 
p‹t
);

1845 
	`¨gv_¥ötf
 (
¨gv
, "%s %s",

1846 
ù
,

1847 
p‹t
);

1848 
	}
}

1851 
	$lök_sockë_c⁄√˘i⁄_öôüãd
 (c⁄° 
buf„r
 *
buf
,

1852 
lök_sockë_öfo
 *
öfo
,

1853 c⁄° 
lök_sockë_a˘uÆ
 *
a˘
,

1854 c⁄° *
comm⁄_«me
,

1855 
ív_£t
 *
es
)

1857 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1859 
öfo
->
lß
->
a˘uÆ
 = *
a˘
;

1860 
	`£ãnv_åu°ed
 (
es
, 
öfo
);

1861 
öfo
->
c⁄√˘i⁄_e°ablished
 = 
åue
;

1865 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, &
gc
);

1866 i‡(
comm⁄_«me
)

1867 
	`buf_¥ötf
 (&
out
, "[%s] ", 
comm⁄_«me
);

1868 
	`buf_¥ötf
 (&
out
, "Pì∏C⁄√˘i⁄ Inôüãd wôh %s", 
	`¥öt_lök_sockë_a˘uÆ
 (&
öfo
->
lß
->
a˘uÆ
, &
gc
));

1869 
	`msg
 (
M_INFO
, "%s", 
	`BSTR
 (&
out
));

1873 
	`£ãnv_°r
 (
es
, "comm⁄_«me", 
comm⁄_«me
);

1876 i‡(
	`∂ugö_deföed
 (
öfo
->
∂ugös
, 
OPENVPN_PLUGIN_IPCHANGE
))

1878 
¨gv
árgv = 
	`¨gv_√w
 ();

1879 
	`ùch™ge_fmt
 (
Ál£
, &
¨gv
, 
öfo
, &
gc
);

1880 i‡(
	`∂ugö_ˇŒ
 (
öfo
->
∂ugös
, 
OPENVPN_PLUGIN_IPCHANGE
, &
¨gv
, 
NULL
, 
es
Ë!
OPENVPN_PLUGIN_FUNC_SUCCESS
)

1881 
	`msg
 (
M_WARN
, "WARNING: ipchangeÖlugin call failed");

1882 
	`¨gv_ª£t
 (&
¨gv
);

1886 i‡(
öfo
->
ùch™ge_comm™d
)

1888 
¨gv
árgv = 
	`¨gv_√w
 ();

1889 
	`£ãnv_°r
 (
es
, "script_type", "ipchange");

1890 
	`ùch™ge_fmt
 (
åue
, &
¨gv
, 
öfo
, &
gc
);

1891 
	`›ív≤_run_s¸ùt
 (&
¨gv
, 
es
, 0, "--ipchange");

1892 
	`¨gv_ª£t
 (&
¨gv
);

1895 
	`gc_‰ì
 (&
gc
);

1896 
	}
}

1899 
	$lök_sockë_bad_öcomög_addr
 (
buf„r
 *
buf
,

1900 c⁄° 
lök_sockë_öfo
 *
öfo
,

1901 c⁄° 
lök_sockë_a˘uÆ
 *
‰om_addr
)

1903 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1905 
‰om_addr
->
de°
.
addr
.
ß
.
ß_Ámûy
)

1907 
AF_INET
:

1908 
AF_INET6
:

1909 
	`msg
 (
D_LINK_ERRORS
,

1911 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om_addr
, &
gc
),

1912 ()
‰om_addr
->
de°
.
addr
.
ß
.
ß_Ámûy
,

1913 
	`¥öt_sockaddr
 (&
öfo
->
lß
->
ªmŸe
, &
gc
));

1916 
buf
->
Àn
 = 0;

1917 
	`gc_‰ì
 (&
gc
);

1918 
	}
}

1921 
	$lök_sockë_bad_outgoög_addr
 ()

1923 
	`dmsg
 (
D_READ_WRITE
, "TCP/UDP: No outgoingáddressÅo sendÖacket");

1924 
	}
}

1926 
ö_addr_t


1927 
	$lök_sockë_cuºít_ªmŸe
 (c⁄° 
lök_sockë_öfo
 *
öfo
)

1929 c⁄° 
lök_sockë_addr
 *
lß
 = 
öfo
->lsa;

1939 i‡(
lß
->
a˘uÆ
.
de°
.
addr
.
ß
.
ß_Ámûy
 !
AF_INET
)

1940  
IPV4_INVALID_ADDR
;

1942 i‡(
	`lök_sockë_a˘uÆ_deföed
 (&
lß
->
a˘uÆ
))

1943  
	`¡ohl
 (
lß
->
a˘uÆ
.
de°
.
addr
.
ö4
.
sö_addr
.
s_addr
);

1944 i‡(
	`addr_deföed
 (&
lß
->
ªmŸe
))

1945  
	`¡ohl
 (
lß
->
ªmŸe
.
addr
.
ö4
.
sö_addr
.
s_addr
);

1948 
	}
}

1954 
	$sockë_°©
 (c⁄° 
lök_sockë
 *
s
, 
rwÊags
, 
gc_¨ía
 *
gc
)

1956 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (64, 
gc
);

1957 i‡(
s
)

1959 i‡(
rwÊags
 & 
EVENT_READ
)

1961 
	`buf_¥ötf
 (&
out
, "S%s",

1962 (
s
->
rwÊags_debug
 & 
EVENT_READ
) ? "R" : "r");

1963 #ifde‡
WIN32


1964 
	`buf_¥ötf
 (&
out
, "%s",

1965 
	`ovîœµed_io_°©e_ascii
 (&
s
->
ªads
));

1968 i‡(
rwÊags
 & 
EVENT_WRITE
)

1970 
	`buf_¥ötf
 (&
out
, "S%s",

1971 (
s
->
rwÊags_debug
 & 
EVENT_WRITE
) ? "W" : "w");

1972 #ifde‡
WIN32


1973 
	`buf_¥ötf
 (&
out
, "%s",

1974 
	`ovîœµed_io_°©e_ascii
 (&
s
->
wrôes
));

1980 
	`buf_¥ötf
 (&
out
, "S?");

1982  
	`BSTR
 (&
out
);

1983 
	}
}

1990 
ölöe
 

1991 
	$°ªam_buf_ª£t
 (
°ªam_buf
 *
sb
)

1993 
	`dmsg
 (
D_STREAM_DEBUG
, "STREAM: RESET");

1994 
sb
->
ªsiduÆ_fuŒy_f‹med
 = 
Ál£
;

1995 
sb
->
buf
 = sb->
buf_öô
;

1996 
	`buf_ª£t
 (&
sb
->
√xt
);

1997 
sb
->
Àn
 = -1;

1998 
	}
}

2001 
	$°ªam_buf_öô
 (
°ªam_buf
 *
sb
,

2002 
buf„r
 *
buf
,

2003 c⁄° 
sockÊags
,

2004 c⁄° 
¥Ÿo
)

2006 
sb
->
buf_öô
 = *
buf
;

2007 
sb
->
maxÀn
 = sb->
buf_öô
.
Àn
;

2008 
sb
->
buf_öô
.
Àn
 = 0;

2009 
sb
->
ªsiduÆ
 = 
	`Æloc_buf
 (sb->
maxÀn
);

2010 
sb
->
îr‹
 = 
Ál£
;

2011 #i‡
PORT_SHARE


2012 
sb
->
p‹t_sh¨e_°©e
 = ((
sockÊags
 & 
SF_PORT_SHARE
Ë&& (
¥Ÿo
 =
PROTO_TCPv4_SERVER
))

2013 ? 
PS_ENABLED


2014 : 
PS_DISABLED
;

2016 
	`°ªam_buf_ª£t
 (
sb
);

2018 
	`dmsg
 (
D_STREAM_DEBUG
, "STREAM: INIT maxÀn=%d", 
sb
->
maxÀn
);

2019 
	}
}

2021 
ölöe
 

2022 
	$°ªam_buf_£t_√xt
 (
°ªam_buf
 *
sb
)

2025 
sb
->
√xt
 = sb->
buf
;

2026 
sb
->
√xt
.
off£t
 = sb->
buf
.off£à+ sb->buf.
Àn
;

2027 
sb
->
√xt
.
Àn
 = (sb->À¿>0 ? sb->À¿: sb->
maxÀn
Ë- sb->
buf
.len;

2028 
	`dmsg
 (
D_STREAM_DEBUG
, "STREAM: SET NEXT, buf=[%d,%d]Çext=[%d,%d]Üen=%d maxlen=%d",

2029 
sb
->
buf
.
off£t
, sb->buf.
Àn
,

2030 
sb
->
√xt
.
off£t
, sb->√xt.
Àn
,

2031 
sb
->
Àn
, sb->
maxÀn
);

2032 
	`ASSERT
 (
sb
->
√xt
.
Àn
 > 0);

2033 
	`ASSERT
 (
	`buf_ß„
 (&
sb
->
buf
, sb->
√xt
.
Àn
));

2034 
	}
}

2036 
ölöe
 

2037 
	$°ªam_buf_gë_föÆ
 (
°ªam_buf
 *
sb
, 
buf„r
 *
buf
)

2039 
	`dmsg
 (
D_STREAM_DEBUG
, "STREAM: GET FINALÜen=%d",

2040 
	`buf_deföed
 (&
sb
->
buf
Ë? sb->buf.
Àn
 : -1);

2041 
	`ASSERT
 (
	`buf_deföed
 (&
sb
->
buf
));

2042 *
buf
 = 
sb
->buf;

2043 
	}
}

2045 
ölöe
 

2046 
	$°ªam_buf_gë_√xt
 (
°ªam_buf
 *
sb
, 
buf„r
 *
buf
)

2048 
	`dmsg
 (
D_STREAM_DEBUG
, "STREAM: GET NEXTÜen=%d",

2049 
	`buf_deföed
 (&
sb
->
√xt
Ë? sb->√xt.
Àn
 : -1);

2050 
	`ASSERT
 (
	`buf_deföed
 (&
sb
->
√xt
));

2051 *
buf
 = 
sb
->
√xt
;

2052 
	}
}

2054 
boﬁ


2055 
	$°ªam_buf_ªad_£tup_dow‹k
 (
lök_sockë
* 
sock
)

2057 i‡(
sock
->
°ªam_buf
.
ªsiduÆ
.
Àn
 && !sock->°ªam_buf.
ªsiduÆ_fuŒy_f‹med
)

2059 
	`ASSERT
 (
	`buf_c›y
 (&
sock
->
°ªam_buf
.
buf
, &sock->°ªam_buf.
ªsiduÆ
));

2060 
	`ASSERT
 (
	`buf_öô
 (&
sock
->
°ªam_buf
.
ªsiduÆ
, 0));

2061 
sock
->
°ªam_buf
.
ªsiduÆ_fuŒy_f‹med
 = 
	`°ªam_buf_added
 (&sock->stream_buf, 0);

2062 
	`dmsg
 (
D_STREAM_DEBUG
, "STREAM: RESIDUAL FULLY FORMED [%s],Üen=%d",

2063 
sock
->
°ªam_buf
.
ªsiduÆ_fuŒy_f‹med
 ? "YES" : "NO",

2064 
sock
->
°ªam_buf
.
ªsiduÆ
.
Àn
);

2067 i‡(!
sock
->
°ªam_buf
.
ªsiduÆ_fuŒy_f‹med
)

2068 
	`°ªam_buf_£t_√xt
 (&
sock
->
°ªam_buf
);

2069  !
sock
->
°ªam_buf
.
ªsiduÆ_fuŒy_f‹med
;

2070 
	}
}

2072 
boﬁ


2073 
	$°ªam_buf_added
 (
°ªam_buf
 *
sb
,

2074 
Àngth_added
)

2076 
	`dmsg
 (
D_STREAM_DEBUG
, "STREAM: ADDÜígth_added=%d", 
Àngth_added
);

2077 i‡(
Àngth_added
 > 0)

2078 
sb
->
buf
.
Àn
 +
Àngth_added
;

2082 i‡(
sb
->
Àn
 < 0 && sb->
buf
.À¿>(Ë (
∑ckë_size_ty≥
))

2084 
∑ckë_size_ty≥
 
√t_size
;

2086 #i‡
PORT_SHARE


2087 i‡(
sb
->
p‹t_sh¨e_°©e
 =
PS_ENABLED
)

2089 i‡(!
	`is_›ív≤_¥Ÿocﬁ
 (&
sb
->
buf
))

2091 
	`msg
 (
D_STREAM_ERRORS
, "Non-OpenVPN clientÖrotocol detected");

2092 
sb
->
p‹t_sh¨e_°©e
 = 
PS_FOREIGN
;

2093 
sb
->
îr‹
 = 
åue
;

2094  
Ál£
;

2097 
sb
->
p‹t_sh¨e_°©e
 = 
PS_DISABLED
;

2101 
	`ASSERT
 (
	`buf_ªad
 (&
sb
->
buf
, &
√t_size
,  (net_size)));

2102 
sb
->
Àn
 = 
	`¡ohps
 (
√t_size
);

2104 i‡(
sb
->
Àn
 < 1 || sb->À¿> sb->
maxÀn
)

2106 
	`msg
 (
M_WARN
, "WARNING: BadÉnˇpsuœãdÖackëÜígth fromÖì∏(%d), which mu° bê> 0ánd <%d --ÖÀa£ÉnsuªÅh© --tun-mtu o∏--lök-mtu i†equÆ o¿bŸhÖìr†--Åhi†c⁄dôi⁄ couldálsÿödiˇãáÖossibÀá˘ivê©èck o¿thêTCPÜök -- [Aâem±ögÑe°¨t...]", 
sb
->
Àn
, sb->
maxÀn
);

2107 
	`°ªam_buf_ª£t
 (
sb
);

2108 
sb
->
îr‹
 = 
åue
;

2109  
Ál£
;

2114 i‡(
sb
->
Àn
 > 0 && sb->
buf
.len >= sb->len)

2117 
	`ASSERT
 (
	`buf_öô
 (&
sb
->
ªsiduÆ
, 0));

2118 i‡(
sb
->
buf
.
Àn
 > sb->len)

2119 
	`ASSERT
 (
	`buf_c›y_ex˚ss
 (&
sb
->
ªsiduÆ
, &sb->
buf
, sb->
Àn
));

2120 
	`dmsg
 (
D_STREAM_DEBUG
, "STREAM: ADDÑeturned TRUE, buf_len=%d,Ñesidual_len=%d",

2121 
	`BLEN
 (&
sb
->
buf
),

2122 
	`BLEN
 (&
sb
->
ªsiduÆ
));

2123  
åue
;

2127 
	`dmsg
 (
D_STREAM_DEBUG
, "STREAM: ADDÑëu∫ed FALSE (have=%dÇìd=%d)", 
sb
->
buf
.
Àn
, sb->len);

2128 
	`°ªam_buf_£t_√xt
 (
sb
);

2129  
Ál£
;

2131 
	}
}

2134 
	$°ªam_buf_˛o£
 (
°ªam_buf
* 
sb
)

2136 
	`‰ì_buf
 (&
sb
->
ªsiduÆ
);

2137 
	}
}

2144 
evít_t


2145 
	$sockë_li°í_evít_h™dÀ
 (
lök_sockë
 *
s
)

2147 #ifde‡
WIN32


2148 i‡(!
	`deföed_√t_evít_wö32
 (&
s
->
li°í_h™dÀ
))

2149 
	`öô_√t_evít_wö32
 (&
s
->
li°í_h™dÀ
, 
FD_ACCEPT
, s->
sd
, 0);

2150  &
s
->
li°í_h™dÀ
;

2152  
s
->
sd
;

2154 
	}
}

2161 
	$¥öt_sockaddr
 (c⁄° 
›ív≤_sockaddr
 *
addr
, 
gc_¨ía
 *
gc
)

2163  
	`¥öt_sockaddr_ex
 (
addr
, ":", 
PS_SHOW_PORT
, 
gc
);

2164 
	}
}

2167 
	$¥öt_sockaddr_ex
 (c⁄° 
›ív≤_sockaddr
 *
addr
,

2168 c⁄° * 
£∑øt‹
,

2169 c⁄° 
Êags
,

2170 
gc_¨ía
 *
gc
)

2172 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (128, 
gc
);

2173 
boﬁ
 
addr_is_deföed
;

2174 
addr_is_deföed
 = 
	`addr_deföed
 (
addr
);

2175 i‡(!
addr_is_deföed
) {

2178 
addr
->addr.
ß
.
ß_Ámûy
)

2180 
AF_INET
:

2182 c⁄° 
p‹t

	`¡ohs
 (
addr
->addr.
ö4
.
sö_p‹t
);

2183 
	`buf_puts
 (&
out
, "[AF_INET]");

2185 i‡(!(
Êags
 & 
PS_DONT_SHOW_ADDR
))

2186 
	`buf_¥ötf
 (&
out
, "%s", (
	`addr_deföed
 (
addr
Ë? 
	`öë_¡ﬂ
 (addr->addr.
ö4
.
sö_addr
) : "[undef]"));

2188 i‡(((
Êags
 & 
PS_SHOW_PORT
Ë|| (
	`addr_deföed
 (
addr
Ë&& (Êag†& 
PS_SHOW_PORT_IF_DEFINED
)))

2189 && 
p‹t
)

2191 i‡(
£∑øt‹
)

2192 
	`buf_¥ötf
 (&
out
, "%s", 
£∑øt‹
);

2194 
	`buf_¥ötf
 (&
out
, "%d", 
p‹t
);

2198 
AF_INET6
:

2200 c⁄° 
p‹t

	`¡ohs
 (
addr
->addr.
ö6
.
sö6_p‹t
);

2201 
buf
[
INET6_ADDRSTRLEN
] = "";

2202 
	`buf_puts
 (&
out
, "[AF_INET6]");

2203 i‡(
addr_is_deföed
)

2205 
	`gë«meöfo
(&
addr
->addr.
ß
,  (
sockaddr_ö6
),

2206 
buf
,  (buf), 
NULL
, 0, 
NI_NUMERICHOST
);

2207 
	`buf_puts
 (&
out
, 
buf
);

2209 i‡(((
Êags
 & 
PS_SHOW_PORT
Ë|| (
addr_is_deföed
 && (Êag†& 
PS_SHOW_PORT_IF_DEFINED
)))

2210 && 
p‹t
)

2212 i‡(
£∑øt‹
)

2213 
	`buf_puts
 (&
out
, 
£∑øt‹
);

2215 
	`buf_¥ötf
 (&
out
, "%d", 
p‹t
);

2220 
	`ASSERT
(0);

2222  
	`BSTR
 (&
out
);

2223 
	}
}

2226 
	$¥öt_lök_sockë_a˘uÆ
 (c⁄° 
lök_sockë_a˘uÆ
 *
a˘
, 
gc_¨ía
 *
gc
)

2228  
	`¥öt_lök_sockë_a˘uÆ_ex
 (
a˘
, ":", 
PS_SHOW_PORT
|
PS_SHOW_PKTINFO
, 
gc
);

2229 
	}
}

2231 #i‚de‡
IF_NAMESIZE


2232 
	#IF_NAMESIZE
 16

	)

2236 
	$¥öt_lök_sockë_a˘uÆ_ex
 (c⁄° 
lök_sockë_a˘uÆ
 *
a˘
,

2237 c⁄° *
£∑øt‹
,

2238 c⁄° 
Êags
,

2239 
gc_¨ía
 *
gc
)

2241 i‡(
a˘
)

2243 
i‚ame
[
IF_NAMESIZE
] = "[undef]";

2244 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (128, 
gc
);

2245 
	`buf_¥ötf
 (&
out
, "%s", 
	`¥öt_sockaddr_ex
 (&
a˘
->
de°
, 
£∑øt‹
, 
Êags
, 
gc
));

2246 #i‡
ENABLE_IP_PKTINFO


2247 i‡((
Êags
 & 
PS_SHOW_PKTINFO
Ë&& 
	`addr_deföed_ùi
(
a˘
))

2249 
a˘
->
de°
.
addr
.
ß
.
ß_Ámûy
)

2251 
AF_INET
:

2253 
›ív≤_sockaddr
 
ß
;

2254 
	`CLEAR
 (
ß
);

2255 
ß
.
addr
.
ö4
.
sö_Ámûy
 = 
AF_INET
;

2256 #ifde‡
IP_PKTINFO


2257 
ß
.
addr
.
ö4
.
sö_addr
 = 
a˘
->
pi
.ö4.
ùi_•ec_d°
;

2258 
	`if_ödext⁄ame
(
a˘
->
pi
.
ö4
.
ùi_ifödex
, 
i‚ame
);

2259 #ñi‡
	`deföed
(
IP_RECVDSTADDR
)

2260 
ß
.
addr
.
ö4
.
sö_addr
 = 
a˘
->
pi
.in4;

2261 
i‚ame
[0]=0;

2263 #îr‹ 
ENABLE_IP_PKTINFO
 
is
 
£t
 
wôhout
 
IP_PKTINFO
 
x‹
 
	`IP_RECVDSTADDR
 (
fix
 
syshód
.
h
)

2265 
	`buf_¥ötf
 (&
out
, " (via %s%%%s)",

2266 
	`¥öt_sockaddr_ex
 (&
ß
, 
£∑øt‹
, 0, 
gc
),

2267 
i‚ame
);

2270 
AF_INET6
:

2272 
sockaddr_ö6
 
sö6
;

2273 
buf
[
INET6_ADDRSTRLEN
] = "[undef]";

2274 
	`CLEAR
(
sö6
);

2275 
sö6
.
sö6_Ámûy
 = 
AF_INET6
;

2276 
sö6
.
sö6_addr
 = 
a˘
->
pi
.
ö6
.
ùi6_addr
;

2277 
	`if_ödext⁄ame
(
a˘
->
pi
.
ö6
.
ùi6_ifödex
, 
i‚ame
);

2278 i‡(
	`gë«meöfo
((
sockaddr
 *)&
sö6
,  (
sockaddr_ö6
),

2279 
buf
,  (buf), 
NULL
, 0, 
NI_NUMERICHOST
) == 0)

2280 
	`buf_¥ötf
 (&
out
, " (vü %s%%%s)", 
buf
, 
i‚ame
);

2282 
	`buf_¥ötf
 (&
out
, " (vü [gë«meöfo(Ëîr]%%%s)", 
i‚ame
);

2288  
	`BSTR
 (&
out
);

2292 
	}
}

2299 
	$¥öt_ö_addr_t
 (
ö_addr_t
 
addr
, 
Êags
, 
gc_¨ía
 *
gc
)

2301 
ö_addr
 
ü
;

2302 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (64, 
gc
);

2304 i‡(
addr
 || !(
Êags
 & 
IA_EMPTY_IF_UNDEF
))

2306 
	`CLEAR
 (
ü
);

2307 
ü
.
s_addr
 = (
Êags
 & 
IA_NET_ORDER
Ë? 
addr
 : 
	`ht⁄l
 (addr);

2309 
	`buf_¥ötf
 (&
out
, "%s", 
	`öë_¡ﬂ
 (
ü
));

2311  
	`BSTR
 (&
out
);

2312 
	}
}

2319 
	$¥öt_ö6_addr
 (
ö6_addr
 
a6
, 
Êags
, 
gc_¨ía
 *
gc
)

2321 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (64, 
gc
);

2322 
tmp_out_buf
[64];

2324 i‡–
	`memcmp
(&
a6
, &
ö6addr_™y
, (a6)) != 0 ||

2325 !(
Êags
 & 
IA_EMPTY_IF_UNDEF
))

2327 
	`öë_¡›
 (
AF_INET6
, &
a6
, 
tmp_out_buf
, (tmp_out_buf)-1);

2328 
	`buf_¥ötf
 (&
out
, "%s", 
tmp_out_buf
 );

2330  
	`BSTR
 (&
out
);

2331 
	}
}

2333 #i‚de‡
UINT8_MAX


2334 
	#UINT8_MAX
 0xff

	)

2340 
ö6_addr
 
	$add_ö6_addr
–
ö6_addr
 
ba£
, 
uöt32_t
 
add
 )

2342 
i
;

2344  
i
=15; i>=0 && 
add
 > 0 ; i-- )

2346 
ˇºy
;

2347 
uöt32_t
 
h
;

2349 
h
 = (Ë
ba£
.
s6_addr
[
i
];

2350 
ba£
.
s6_addr
[
i
] = (
h
+
add
Ë& 
UINT8_MAX
;

2355 
ˇºy
 = ((
h
 & 0xffË+ (
add
 & 0xff)) >> 8;

2356 
add
 = (add>>8Ë+ 
ˇºy
;

2358  
ba£
;

2359 
	}
}

2363 
	$£ãnv_sockaddr
 (
ív_£t
 *
es
, c⁄° *
«me_¥efix
, c⁄° 
›ív≤_sockaddr
 *
addr
, c⁄° 
Êags
)

2365 
«me_buf
[256];

2367 
buf
[128];

2368 
addr
->addr.
ß
.
ß_Ámûy
)

2370 
AF_INET
:

2371 i‡(
Êags
 & 
SA_IP_PORT
)

2372 
	`›ív≤_¢¥ötf
 (
«me_buf
,  («me_buf), "%s_ù", 
«me_¥efix
);

2374 
	`›ív≤_¢¥ötf
 (
«me_buf
,  («me_buf), "%s", 
«me_¥efix
);

2376 
	`£ãnv_°r
 (
es
, 
«me_buf
, 
	`öë_¡ﬂ
 (
addr
->addr.
ö4
.
sö_addr
));

2378 i‡((
Êags
 & 
SA_IP_PORT
Ë&& 
addr
->addr.
ö4
.
sö_p‹t
)

2380 
	`›ív≤_¢¥ötf
 (
«me_buf
,  («me_buf), "%s_p‹t", 
«me_¥efix
);

2381 
	`£ãnv_öt
 (
es
, 
«me_buf
, 
	`¡ohs
 (
addr
->addr.
ö4
.
sö_p‹t
));

2384 
AF_INET6
:

2385 
	`›ív≤_¢¥ötf
 (
«me_buf
,  («me_buf), "%s_ù6", 
«me_¥efix
);

2386 
	`gë«meöfo
(&
addr
->addr.
ß
,  (
sockaddr_ö6
),

2387 
buf
, (buf), 
NULL
, 0, 
NI_NUMERICHOST
);

2388 
	`£ãnv_°r
 (
es
, 
«me_buf
, 
buf
);

2390 i‡((
Êags
 & 
SA_IP_PORT
Ë&& 
addr
->addr.
ö6
.
sö6_p‹t
)

2392 
	`›ív≤_¢¥ötf
 (
«me_buf
,  («me_buf), "%s_p‹t", 
«me_¥efix
);

2393 
	`£ãnv_öt
 (
es
, 
«me_buf
, 
	`¡ohs
 (
addr
->addr.
ö6
.
sö6_p‹t
));

2397 
	}
}

2400 
	$£ãnv_ö_addr_t
 (
ív_£t
 *
es
, c⁄° *
«me_¥efix
, 
ö_addr_t
 
addr
, c⁄° 
Êags
)

2402 i‡(
addr
 || !(
Êags
 & 
SA_SET_IF_NONZERO
))

2404 
›ív≤_sockaddr
 
si
;

2405 
	`CLEAR
 (
si
);

2406 
si
.
addr
.
ö4
.
sö_Ámûy
 = 
AF_INET
;

2407 
si
.
addr
.
ö4
.
sö_addr
.
s_addr
 = 
	`ht⁄l
 (addr);

2408 
	`£ãnv_sockaddr
 (
es
, 
«me_¥efix
, &
si
, 
Êags
);

2410 
	}
}

2413 
	$£ãnv_lök_sockë_a˘uÆ
 (
ív_£t
 *
es
,

2414 c⁄° *
«me_¥efix
,

2415 c⁄° 
lök_sockë_a˘uÆ
 *
a˘
,

2416 c⁄° 
Êags
)

2418 
	`£ãnv_sockaddr
 (
es
, 
«me_¥efix
, &
a˘
->
de°
, 
Êags
);

2419 
	}
}

2425 
	s¥Ÿo_«mes
 {

2426 c⁄° *
	msh‹t_f‹m
;

2427 c⁄° *
	mdi•œy_f‹m
;

2428 
boﬁ
 
	mis_dgøm
;

2429 
boﬁ
 
	mis_√t
;

2430 
	m¥Ÿo_af
;

2434 c⁄° 
¥Ÿo_«mes
 
	g¥Ÿo_«mes
[
PROTO_N
] = {

2435 {"¥Ÿo-unöôülized", "¥Ÿo-NONE",0,0, 
AF_UNSPEC
},

2436 {"udp", "UDPv4",1,1, 
AF_INET
},

2437 {"t˝-£rvî", "TCPv4_SERVER",0,1, 
AF_INET
},

2438 {"t˝-˛õ¡", "TCPv4_CLIENT",0,1, 
AF_INET
},

2439 {"t˝", "TCPv4",0,1, 
AF_INET
},

2440 {"udp6" ,"UDPv6",1,1, 
AF_INET6
},

2441 {"t˝6-£rvî","TCPv6_SERVER",0,1, 
AF_INET6
},

2442 {"t˝6-˛õ¡","TCPv6_CLIENT",0,1, 
AF_INET6
},

2443 {"t˝6" ,"TCPv6",0,1, 
AF_INET6
},

2446 
boﬁ


2447 
	$¥Ÿo_is_√t
(
¥Ÿo
)

2449 i‡(
¥Ÿo
 < 0 ||ÖrŸÿ>
PROTO_N
)

2450 
	`ASSERT
(0);

2451  
¥Ÿo_«mes
[
¥Ÿo
].
is_√t
;

2452 
	}
}

2453 
boﬁ


2454 
	$¥Ÿo_is_dgøm
(
¥Ÿo
)

2456 i‡(
¥Ÿo
 < 0 ||ÖrŸÿ>
PROTO_N
)

2457 
	`ASSERT
(0);

2458  
¥Ÿo_«mes
[
¥Ÿo
].
is_dgøm
;

2459 
	}
}

2460 
boﬁ


2461 
	$¥Ÿo_is_udp
(
¥Ÿo
)

2463 i‡(
¥Ÿo
 < 0 ||ÖrŸÿ>
PROTO_N
)

2464 
	`ASSERT
(0);

2465  
¥Ÿo_«mes
[
¥Ÿo
].
is_dgøm
&&¥Ÿo_«mes[¥Ÿo].
is_√t
;

2466 
	}
}

2467 
boﬁ


2468 
	$¥Ÿo_is_t˝
(
¥Ÿo
)

2470 i‡(
¥Ÿo
 < 0 ||ÖrŸÿ>
PROTO_N
)

2471 
	`ASSERT
(0);

2472  (!
¥Ÿo_«mes
[
¥Ÿo
].
is_dgøm
)&&¥Ÿo_«mes[¥Ÿo].
is_√t
;

2473 
	}
}

2476 
	$¥Ÿo_ß_Ámûy
(
¥Ÿo
)

2478 i‡(
¥Ÿo
 < 0 ||ÖrŸÿ>
PROTO_N
)

2479 
	`ASSERT
(0);

2480  
¥Ÿo_«mes
[
¥Ÿo
].
¥Ÿo_af
;

2481 
	}
}

2484 
	$ascii2¥Ÿo
 (c⁄° * 
¥Ÿo_«me
)

2486 
i
;

2487 
	`ASSERT
 (
PROTO_N
 =
	`SIZE
 (
¥Ÿo_«mes
));

2488 
i
 = 0; i < 
PROTO_N
; ++i)

2489 i‡(!
	`°rcmp
 (
¥Ÿo_«me
, 
¥Ÿo_«mes
[
i
].
sh‹t_f‹m
))

2490  
i
;

2492 
	}
}

2495 
	$¥Ÿo2ascii
 (
¥Ÿo
, 
boﬁ
 
di•œy_f‹m
)

2497 
	`ASSERT
 (
PROTO_N
 =
	`SIZE
 (
¥Ÿo_«mes
));

2498 i‡(
¥Ÿo
 < 0 ||ÖrŸÿ>
PROTO_N
)

2500 i‡(
di•œy_f‹m
)

2501  
¥Ÿo_«mes
[
¥Ÿo
].
di•œy_f‹m
;

2503  
¥Ÿo_«mes
[
¥Ÿo
].
sh‹t_f‹m
;

2504 
	}
}

2507 
	$¥Ÿo2ascii_Æl
 (
gc_¨ía
 *
gc
)

2509 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

2510 
i
;

2512 
	`ASSERT
 (
PROTO_N
 =
	`SIZE
 (
¥Ÿo_«mes
));

2513 
i
 = 0; i < 
PROTO_N
; ++i)

2515 i‡(
i
)

2516 
	`buf_¥ötf
(&
out
, " ");

2517 
	`buf_¥ötf
(&
out
, "[%s]", 
	`¥Ÿo2ascii
(
i
, 
Ál£
));

2519  
	`BSTR
 (&
out
);

2520 
	}
}

2523 
	$addr_guess_Ámûy
(
¥Ÿo
, c⁄° *
«me
)

2525 
ªt
;

2526 i‡(
¥Ÿo
)

2528  
	`¥Ÿo_ß_Ámûy
(
¥Ÿo
);

2532 
addröfo
 
höts
 , *
ai
;

2533 
îr
;

2534 
	`CLEAR
(
höts
);

2535 
höts
.
ai_Êags
 = 
AI_NUMERICHOST
;

2536 
îr
 = 
	`gëaddröfo
(
«me
, 
NULL
, &
höts
, &
ai
);

2537 i‡–0 =
îr
 )

2539 
ªt
=
ai
->
ai_Ámûy
;

2540 
	`‰ìaddröfo
(
ai
);

2541  
ªt
;

2544  
AF_INET
;

2545 
	}
}

2547 
	$addr_Ámûy_«me
 (
af
)

2549 
af
)

2551 
AF_INET
:  "AF_INET";

2552 
AF_INET6
:  "AF_INET6";

2555 
	}
}

2570 
	$¥Ÿo_ªmŸe
 (
¥Ÿo
, 
boﬁ
 
ªmŸe
)

2572 
	`ASSERT
 (
¥Ÿo
 >0 &&ÖrŸÿ< 
PROTO_N
);

2573 i‡(
ªmŸe
)

2575 
¥Ÿo
)

2577 
PROTO_TCPv4_SERVER
:  
PROTO_TCPv4_CLIENT
;

2578 
PROTO_TCPv4_CLIENT
:  
PROTO_TCPv4_SERVER
;

2579 
PROTO_TCPv6_SERVER
:  
PROTO_TCPv4_CLIENT
;

2580 
PROTO_TCPv6_CLIENT
:  
PROTO_TCPv4_SERVER
;

2581 
PROTO_UDPv6
:  
PROTO_UDPv4
;

2586 
¥Ÿo
)

2588 
PROTO_TCPv6_SERVER
:  
PROTO_TCPv4_SERVER
;

2589 
PROTO_TCPv6_CLIENT
:  
PROTO_TCPv4_CLIENT
;

2590 
PROTO_UDPv6
:  
PROTO_UDPv4
;

2593  
¥Ÿo
;

2594 
	}
}

2601 
	$bad_addªss_Àngth
 (
a˘uÆ
, 
ex≥˘ed
)

2603 
	`msg
 (
M_FATAL
, "ERROR:Ñeceived strange incomingÖacket withánáddressÜength of %d -- we onlyácceptáddressÜengths of %d.",

2604 
a˘uÆ
,

2605 
ex≥˘ed
);

2606 
	}
}

2613 
	$lök_sockë_ªad_t˝
 (
lök_sockë
 *
sock
,

2614 
buf„r
 *
buf
)

2616 
Àn
 = 0;

2618 i‡(!
sock
->
°ªam_buf
.
ªsiduÆ_fuŒy_f‹med
)

2620 #ifde‡
WIN32


2621 
Àn
 = 
	`sockë_föÆize
 (
sock
->
sd
, &sock->
ªads
, 
buf
, 
NULL
);

2623 
buf„r
 
‰ag
;

2624 
	`°ªam_buf_gë_√xt
 (&
sock
->
°ªam_buf
, &
‰ag
);

2625 
Àn
 = 
	`ªcv
 (
sock
->
sd
, 
	`BPTR
 (&
‰ag
), 
	`BLEN
 (&‰ag), 
MSG_NOSIGNAL
);

2628 i‡(!
Àn
)

2629 
sock
->
°ªam_ª£t
 = 
åue
;

2630 i‡(
Àn
 <= 0)

2631  
buf
->
Àn
 =Üen;

2634 i‡(
sock
->
°ªam_buf
.
ªsiduÆ_fuŒy_f‹med


2635 || 
	`°ªam_buf_added
 (&
sock
->
°ªam_buf
, 
Àn
))

2637 
	`°ªam_buf_gë_föÆ
 (&
sock
->
°ªam_buf
, 
buf
);

2638 
	`°ªam_buf_ª£t
 (&
sock
->
°ªam_buf
);

2639  
buf
->
Àn
;

2642  
buf
->
Àn
 = 0;

2643 
	}
}

2645 #i‚de‡
WIN32


2647 #i‡
ENABLE_IP_PKTINFO


2649 #¥agm®
∑ck
(1)

2650 
	s›ív≤_ö4_pktöfo


2652 
cmsghdr
 
	mcmsghdr
;

2653 #ifde‡
HAVE_IN_PKTINFO


2654 
ö_pktöfo
 
	mpi4
;

2655 #ñi‡
deföed
(
IP_RECVDSTADDR
)

2656 
ö_addr
 
	mpi4
;

2659 
	s›ív≤_ö6_pktöfo


2661 
cmsghdr
 
	mcmsghdr
;

2662 
ö6_pktöfo
 
	mpi6
;

2665 
	u›ív≤_pktöfo
 {

2666 
›ív≤_ö4_pktöfo
 
	mmsgpi4
;

2667 
›ív≤_ö6_pktöfo
 
	mmsgpi6
;

2669 #¥agm®
∑ck
()

2671 
sockÀn_t


2672 
	$lök_sockë_ªad_udp_posix_ªcvmsg
 (
lök_sockë
 *
sock
,

2673 
buf„r
 *
buf
,

2674 
maxsize
,

2675 
lök_sockë_a˘uÆ
 *
‰om
)

2677 
iovec
 
iov
;

2678 
›ív≤_pktöfo
 
›i
;

2679 
msghdr
 
mesg
;

2680 
sockÀn_t
 
‰omÀn
 =  (
‰om
->
de°
.
addr
);

2682 
iov
.
iov_ba£
 = 
	`BPTR
 (
buf
);

2683 
iov
.
iov_Àn
 = 
maxsize
;

2684 
mesg
.
msg_iov
 = &
iov
;

2685 
mesg
.
msg_iovÀn
 = 1;

2686 
mesg
.
msg_«me
 = &
‰om
->
de°
.
addr
;

2687 
mesg
.
msg_«mñí
 = 
‰omÀn
;

2688 
mesg
.
msg_c⁄åﬁ
 = &
›i
;

2689 
mesg
.
msg_c⁄åﬁÀn
 =  
›i
;

2690 
buf
->
Àn
 = 
	`ªcvmsg
 (
sock
->
sd
, &
mesg
, 0);

2691 i‡(
buf
->
Àn
 >= 0)

2693 
cmsghdr
 *
cmsg
;

2694 
‰omÀn
 = 
mesg
.
msg_«mñí
;

2695 
cmsg
 = 
	`CMSG_FIRSTHDR
 (&
mesg
);

2696 i‡(
cmsg
 !
NULL


2697 && 
	`CMSG_NXTHDR
 (&
mesg
, 
cmsg
Ë=
NULL


2698 #ifde‡
IP_PKTINFO


2699 && 
cmsg
->
cmsg_Àvñ
 =
SOL_IP


2700 && 
cmsg
->
cmsg_ty≥
 =
IP_PKTINFO


2701 #ñi‡
	`deföed
(
IP_RECVDSTADDR
)

2702 && 
cmsg
->
cmsg_Àvñ
 =
IPPROTO_IP


2703 && 
cmsg
->
cmsg_ty≥
 =
IP_RECVDSTADDR


2705 #îr‹ 
ENABLE_IP_PKTINFO
 
is
 
£t
 
wôhout
 
IP_PKTINFO
 
x‹
 
	`IP_RECVDSTADDR
 (
fix
 
syshód
.
h
)

2707 && 
cmsg
->
cmsg_Àn
 > (
›ív≤_ö4_pktöfo
))

2709 #ifde‡
IP_PKTINFO


2710 
ö_pktöfo
 *
pkti
 = (ö_pktöfÿ*Ë
	`CMSG_DATA
 (
cmsg
);

2711 
‰om
->
pi
.
ö4
.
ùi_ifödex
 = 
pkti
->ipi_ifindex;

2712 
‰om
->
pi
.
ö4
.
ùi_•ec_d°
 = 
pkti
->ipi_spec_dst;

2713 #ñi‡
	`deföed
(
IP_RECVDSTADDR
)

2714 
‰om
->
pi
.
ö4
 = *(
ö_addr
*Ë
	`CMSG_DATA
 (
cmsg
);

2716 #îr‹ 
ENABLE_IP_PKTINFO
 
is
 
£t
 
wôhout
 
IP_PKTINFO
 
x‹
 
	`IP_RECVDSTADDR
 (
fix
 
syshód
.
h
)

2719 i‡(
cmsg
 !
NULL


2720 && 
	`CMSG_NXTHDR
 (&
mesg
, 
cmsg
Ë=
NULL


2721 && 
cmsg
->
cmsg_Àvñ
 =
IPPROTO_IPV6


2722 && 
cmsg
->
cmsg_ty≥
 =
IPV6_PKTINFO


2723 && 
cmsg
->
cmsg_Àn
 > (
›ív≤_ö6_pktöfo
))

2725 
ö6_pktöfo
 *
pkti6
 = (ö6_pktöfÿ*Ë
	`CMSG_DATA
 (
cmsg
);

2726 
‰om
->
pi
.
ö6
.
ùi6_ifödex
 = 
pkti6
->ipi6_ifindex;

2727 
‰om
->
pi
.
ö6
.
ùi6_addr
 = 
pkti6
->ipi6_addr;

2730  
‰omÀn
;

2731 
	}
}

2735 
	$lök_sockë_ªad_udp_posix
 (
lök_sockë
 *
sock
,

2736 
buf„r
 *
buf
,

2737 
maxsize
,

2738 
lök_sockë_a˘uÆ
 *
‰om
)

2740 
sockÀn_t
 
‰omÀn
 =  (
‰om
->
de°
.
addr
);

2741 
sockÀn_t
 
ex≥˘edÀn
 = 
	`af_addr_size
(
	`¥Ÿo_ß_Ámûy
(
sock
->
öfo
.
¥Ÿo
));

2742 
	`addr_zîo_ho°
(&
‰om
->
de°
);

2743 
	`ASSERT
 (
	`buf_ß„
 (
buf
, 
maxsize
));

2744 #i‡
ENABLE_IP_PKTINFO


2746 i‡(
	`¥Ÿo_is_udp
(
sock
->
öfo
.
¥Ÿo
Ë&& sock->
sockÊags
 & 
SF_USE_IP_PKTINFO
)

2747 
‰omÀn
 = 
	`lök_sockë_ªad_udp_posix_ªcvmsg
 (
sock
, 
buf
, 
maxsize
, 
‰om
);

2750 
buf
->
Àn
 = 
	`ªcv‰om
 (
sock
->
sd
, 
	`BPTR
 (buf), 
maxsize
, 0,

2751 &
‰om
->
de°
.
addr
.
ß
, &
‰omÀn
);

2752 i‡(
buf
->
Àn
 >0 && 
ex≥˘edÀn
 && 
‰omÀn
 !=Éxpectedlen)

2753 
	`bad_addªss_Àngth
 (
‰omÀn
, 
ex≥˘edÀn
);

2754  
buf
->
Àn
;

2755 
	}
}

2764 
	$lök_sockë_wrôe_t˝
 (
lök_sockë
 *
sock
,

2765 
buf„r
 *
buf
,

2766 
lök_sockë_a˘uÆ
 *
to
)

2768 
∑ckë_size_ty≥
 
Àn
 = 
	`BLEN
 (
buf
);

2769 
	`dmsg
 (
D_STREAM_DEBUG
, "STREAM: WRITE %d off£t=%d", ()
Àn
, 
buf
->
off£t
);

2770 
	`ASSERT
 (
Àn
 <
sock
->
°ªam_buf
.
maxÀn
);

2771 
Àn
 = 
	`ht⁄ps
 (len);

2772 
	`ASSERT
 (
	`buf_wrôe_¥ïíd
 (
buf
, &
Àn
,  (len)));

2773 #ifde‡
WIN32


2774  
	`lök_sockë_wrôe_wö32
 (
sock
, 
buf
, 
to
);

2776  
	`lök_sockë_wrôe_t˝_posix
 (
sock
, 
buf
, 
to
);

2778 
	}
}

2780 #i‡
ENABLE_IP_PKTINFO


2783 
	$lök_sockë_wrôe_udp_posix_£ndmsg
 (
lök_sockë
 *
sock
,

2784 
buf„r
 *
buf
,

2785 
lök_sockë_a˘uÆ
 *
to
)

2787 
iovec
 
iov
;

2788 
msghdr
 
mesg
;

2789 
cmsghdr
 *
cmsg
;

2790 
›ív≤_pktöfo
 
›i
;

2792 
iov
.
iov_ba£
 = 
	`BPTR
 (
buf
);

2793 
iov
.
iov_Àn
 = 
	`BLEN
 (
buf
);

2794 
mesg
.
msg_iov
 = &
iov
;

2795 
mesg
.
msg_iovÀn
 = 1;

2796 
sock
->
öfo
.
lß
->
ªmŸe
.
addr
.
ß
.
ß_Ámûy
)

2798 
AF_INET
:

2800 
mesg
.
msg_«me
 = &
to
->
de°
.
addr
.
ß
;

2801 
mesg
.
msg_«mñí
 =  (
sockaddr_ö
);

2802 
mesg
.
msg_c⁄åﬁ
 = &
›i
;

2803 
mesg
.
msg_Êags
 = 0;

2804 #ifde‡
HAVE_IN_PKTINFO


2805 
mesg
.
msg_c⁄åﬁÀn
 =  (
›ív≤_ö4_pktöfo
);

2806 
cmsg
 = 
	`CMSG_FIRSTHDR
 (&
mesg
);

2807 
cmsg
->
cmsg_Àn
 =  (
›ív≤_ö4_pktöfo
);

2808 
cmsg
->
cmsg_Àvñ
 = 
SOL_IP
;

2809 
cmsg
->
cmsg_ty≥
 = 
IP_PKTINFO
;

2811 
ö_pktöfo
 *
pkti
;

2812 
pkti
 = (
ö_pktöfo
 *Ë
	`CMSG_DATA
 (
cmsg
);

2813 
pkti
->
ùi_ifödex
 = 
to
->
pi
.
ö4
.ipi_ifindex;

2814 
pkti
->
ùi_•ec_d°
 = 
to
->
pi
.
ö4
.ipi_spec_dst;

2815 
pkti
->
ùi_addr
.
s_addr
 = 0;

2817 #ñi‡
	`deföed
(
IP_RECVDSTADDR
)

2818 
	`ASSERT
–
	`CMSG_SPACE
( (
ö_addr
)Ë<(
›i
) );

2819 
mesg
.
msg_c⁄åﬁÀn
 = 
	`CMSG_SPACE
( (
ö_addr
));

2820 
cmsg
 = 
	`CMSG_FIRSTHDR
 (&
mesg
);

2821 
cmsg
->
cmsg_Àn
 = 
	`CMSG_LEN
((
ö_addr
));

2822 
cmsg
->
cmsg_Àvñ
 = 
IPPROTO_IP
;

2823 
cmsg
->
cmsg_ty≥
 = 
IP_RECVDSTADDR
;

2824 *(
ö_addr
 *Ë
	`CMSG_DATA
 (
cmsg
Ë
to
->
pi
.
ö4
;

2826 #îr‹ 
ENABLE_IP_PKTINFO
 
is
 
£t
 
wôhout
 
IP_PKTINFO
 
x‹
 
	`IP_RECVDSTADDR
 (
fix
 
syshód
.
h
)

2830 
AF_INET6
:

2832 
ö6_pktöfo
 *
pkti6
;

2833 
mesg
.
msg_«me
 = &
to
->
de°
.
addr
.
ß
;

2834 
mesg
.
msg_«mñí
 =  (
sockaddr_ö6
);

2835 
mesg
.
msg_c⁄åﬁ
 = &
›i
;

2836 
mesg
.
msg_c⁄åﬁÀn
 =  (
›ív≤_ö6_pktöfo
);

2837 
mesg
.
msg_Êags
 = 0;

2838 
cmsg
 = 
	`CMSG_FIRSTHDR
 (&
mesg
);

2839 
cmsg
->
cmsg_Àn
 =  (
›ív≤_ö6_pktöfo
);

2840 
cmsg
->
cmsg_Àvñ
 = 
IPPROTO_IPV6
;

2841 
cmsg
->
cmsg_ty≥
 = 
IPV6_PKTINFO
;

2842 
pkti6
 = (
ö6_pktöfo
 *Ë
	`CMSG_DATA
 (
cmsg
);

2843 
pkti6
->
ùi6_ifödex
 = 
to
->
pi
.
ö6
.ipi6_ifindex;

2844 
pkti6
->
ùi6_addr
 = 
to
->
pi
.
ö6
.ipi6_addr;

2847 : 
	`ASSERT
(0);

2849  
	`£ndmsg
 (
sock
->
sd
, &
mesg
, 0);

2850 
	}
}

2858 #ifde‡
WIN32


2861 
	$sockë_ªcv_queue
 (
lök_sockë
 *
sock
, 
maxsize
)

2863 i‡(
sock
->
ªads
.
io°©e
 =
IOSTATE_INITIAL
)

2865 
WSABUF
 
wßbuf
[1];

2866 
°©us
;

2869 i‡(
	`¥Ÿo_is_udp
(
sock
->
öfo
.
¥Ÿo
))

2871 
sock
->
ªads
.
buf
 = sock->ªads.
buf_öô
;

2873 i‡(
	`¥Ÿo_is_t˝
(
sock
->
öfo
.
¥Ÿo
))

2875 
	`°ªam_buf_gë_√xt
 (&
sock
->
°ªam_buf
, &sock->
ªads
.
buf
);

2879 
	`ASSERT
 (0);

2883 
wßbuf
[0].
buf
 = 
	`BPTR
 (&
sock
->
ªads
.buf);

2884 
wßbuf
[0].
Àn
 = 
maxsize
 ? maxsizê: 
	`BLEN
 (&
sock
->
ªads
.
buf
);

2887 
	`ASSERT
 (
wßbuf
[0].
Àn
 <
	`BLEN
 (&
sock
->
ªads
.
buf
));

2890 
	`ASSERT
 (
	`Re£tEvít
 (
sock
->
ªads
.
ovîœµed
.
hEvít
));

2891 
sock
->
ªads
.
Êags
 = 0;

2893 i‡(
	`¥Ÿo_is_udp
(
sock
->
öfo
.
¥Ÿo
))

2895 
sock
->
ªads
.
addr_deföed
 = 
åue
;

2896 i‡(
sock
->
öfo
.
¥Ÿo
 =
PROTO_UDPv6
)

2897 
sock
->
ªads
.
addæí
 =  (sock->ªads.
addr6
);

2899 
sock
->
ªads
.
addæí
 =  (sock->ªads.
addr
);

2900 
°©us
 = 
	`WSARecvFrom
(

2901 
sock
->
sd
,

2902 
wßbuf
,

2904 &
sock
->
ªads
.
size
,

2905 &
sock
->
ªads
.
Êags
,

2906 (
sockaddr
 *Ë&
sock
->
ªads
.
addr
,

2907 &
sock
->
ªads
.
addæí
,

2908 &
sock
->
ªads
.
ovîœµed
,

2909 
NULL
);

2911 i‡(
	`¥Ÿo_is_t˝
(
sock
->
öfo
.
¥Ÿo
))

2913 
sock
->
ªads
.
addr_deföed
 = 
Ál£
;

2914 
°©us
 = 
	`WSARecv
(

2915 
sock
->
sd
,

2916 
wßbuf
,

2918 &
sock
->
ªads
.
size
,

2919 &
sock
->
ªads
.
Êags
,

2920 &
sock
->
ªads
.
ovîœµed
,

2921 
NULL
);

2925 
°©us
 = 0;

2926 
	`ASSERT
 (0);

2929 i‡(!
°©us
)

2931 
addæí
 = 
	`af_addr_size
(
sock
->
öfo
.
lß
->
loˇl
.
addr
.
ß
.
ß_Ámûy
);

2932 i‡(
sock
->
ªads
.
addr_deföed
 && sock->ªads.
addæí
 !=áddrlen)

2933 
	`bad_addªss_Àngth
 (
sock
->
ªads
.
addæí
,áddrlen);

2934 
sock
->
ªads
.
io°©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

2937 
	`ASSERT
 (
	`SëEvít
 (
sock
->
ªads
.
ovîœµed
.
hEvít
));

2938 
sock
->
ªads
.
°©us
 = 0;

2940 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: Socket Receive immediateÑeturn [%d,%d]",

2941 (Ë
wßbuf
[0].
Àn
,

2942 (Ë
sock
->
ªads
.
size
);

2946 
°©us
 = 
	`WSAGëLa°Eº‹
 ();

2947 i‡(
°©us
 =
WSA_IO_PENDING
)

2949 
sock
->
ªads
.
io°©e
 = 
IOSTATE_QUEUED
;

2950 
sock
->
ªads
.
°©us
 = status;

2951 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: Socket Receive queued [%d]",

2952 (Ë
wßbuf
[0].
Àn
);

2956 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2957 
	`ASSERT
 (
	`SëEvít
 (
sock
->
ªads
.
ovîœµed
.
hEvít
));

2958 
sock
->
ªads
.
io°©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

2959 
sock
->
ªads
.
°©us
 = status;

2960 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: Socket ReceiveÉrror [%d]: %s",

2961 (Ë
wßbuf
[0].
Àn
,

2962 
	`°ªº‹_wö32
 (
°©us
, &
gc
));

2963 
	`gc_‰ì
 (&
gc
);

2967  
sock
->
ªads
.
io°©e
;

2968 
	}
}

2971 
	$sockë_£nd_queue
 (
lök_sockë
 *
sock
, 
buf„r
 *
buf
, c⁄° 
lök_sockë_a˘uÆ
 *
to
)

2973 i‡(
sock
->
wrôes
.
io°©e
 =
IOSTATE_INITIAL
)

2975 
WSABUF
 
wßbuf
[1];

2976 
°©us
;

2979 
sock
->
wrôes
.
buf
 = sock->wrôes.
buf_öô
;

2980 
sock
->
wrôes
.
buf
.
Àn
 = 0;

2981 
	`ASSERT
 (
	`buf_c›y
 (&
sock
->
wrôes
.
buf
, buf));

2984 
wßbuf
[0].
buf
 = 
	`BPTR
 (&
sock
->
wrôes
.buf);

2985 
wßbuf
[0].
Àn
 = 
	`BLEN
 (&
sock
->
wrôes
.
buf
);

2988 
	`ASSERT
 (
	`Re£tEvít
 (
sock
->
wrôes
.
ovîœµed
.
hEvít
));

2989 
sock
->
wrôes
.
Êags
 = 0;

2991 i‡(
	`¥Ÿo_is_udp
(
sock
->
öfo
.
¥Ÿo
))

2994 
sock
->
wrôes
.
addr_deföed
 = 
åue
;

2995 i‡(
sock
->
öfo
.
¥Ÿo
 =
PROTO_UDPv6
)

2997 
sock
->
wrôes
.
addr6
 = 
to
->
de°
.
addr
.
ö6
;

2998 
sock
->
wrôes
.
addæí
 =  (sock->wrôes.
addr6
);

3002 
sock
->
wrôes
.
addr
 = 
to
->
de°
.addr.
ö4
;

3003 
sock
->
wrôes
.
addæí
 =  (sock->wrôes.
addr
);

3006 
°©us
 = 
	`WSASídTo
(

3007 
sock
->
sd
,

3008 
wßbuf
,

3010 &
sock
->
wrôes
.
size
,

3011 
sock
->
wrôes
.
Êags
,

3012 (
sockaddr
 *Ë&
sock
->
wrôes
.
addr
,

3013 
sock
->
wrôes
.
addæí
,

3014 &
sock
->
wrôes
.
ovîœµed
,

3015 
NULL
);

3017 i‡(
	`¥Ÿo_is_t˝
(
sock
->
öfo
.
¥Ÿo
))

3020 
sock
->
wrôes
.
addr_deföed
 = 
Ál£
;

3022 
°©us
 = 
	`WSASíd
(

3023 
sock
->
sd
,

3024 
wßbuf
,

3026 &
sock
->
wrôes
.
size
,

3027 
sock
->
wrôes
.
Êags
,

3028 &
sock
->
wrôes
.
ovîœµed
,

3029 
NULL
);

3033 
°©us
 = 0;

3034 
	`ASSERT
 (0);

3037 i‡(!
°©us
)

3039 
sock
->
wrôes
.
io°©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

3042 
	`ASSERT
 (
	`SëEvít
 (
sock
->
wrôes
.
ovîœµed
.
hEvít
));

3044 
sock
->
wrôes
.
°©us
 = 0;

3046 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: Socket Send immediateÑeturn [%d,%d]",

3047 (Ë
wßbuf
[0].
Àn
,

3048 (Ë
sock
->
wrôes
.
size
);

3052 
°©us
 = 
	`WSAGëLa°Eº‹
 ();

3053 i‡(
°©us
 =
WSA_IO_PENDING
)

3055 
sock
->
wrôes
.
io°©e
 = 
IOSTATE_QUEUED
;

3056 
sock
->
wrôes
.
°©us
 = status;

3057 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: Socket Send queued [%d]",

3058 (Ë
wßbuf
[0].
Àn
);

3062 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3063 
	`ASSERT
 (
	`SëEvít
 (
sock
->
wrôes
.
ovîœµed
.
hEvít
));

3064 
sock
->
wrôes
.
io°©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

3065 
sock
->
wrôes
.
°©us
 = status;

3067 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: Socket SendÉrror [%d]: %s",

3068 (Ë
wßbuf
[0].
Àn
,

3069 
	`°ªº‹_wö32
 (
°©us
, &
gc
));

3071 
	`gc_‰ì
 (&
gc
);

3075  
sock
->
wrôes
.
io°©e
;

3076 
	}
}

3079 
	$sockë_föÆize
 (
SOCKET
 
s
,

3080 
ovîœµed_io
 *
io
,

3081 
buf„r
 *
buf
,

3082 
lök_sockë_a˘uÆ
 *
‰om
)

3084 
ªt
 = -1;

3085 
BOOL
 
°©us
;

3087 
io
->
io°©e
)

3089 
IOSTATE_QUEUED
:

3090 
°©us
 = 
	`WSAGëOvîœµedResu…
(

3091 
s
,

3092 &
io
->
ovîœµed
,

3093 &
io
->
size
,

3094 
FALSE
,

3095 &
io
->
Êags


3097 i‡(
°©us
)

3100 i‡(
buf
)

3101 *
buf
 = 
io
->buf;

3102 
ªt
 = 
io
->
size
;

3103 
io
->
io°©e
 = 
IOSTATE_INITIAL
;

3104 
	`ASSERT
 (
	`Re£tEvít
 (
io
->
ovîœµed
.
hEvít
));

3106 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: Sockë Com∂ëi⁄ suc˚s†[%d]", 
ªt
);

3111 
ªt
 = -1;

3112 i‡(
	`WSAGëLa°Eº‹
(Ë!
WSA_IO_INCOMPLETE
)

3115 
io
->
io°©e
 = 
IOSTATE_INITIAL
;

3116 
	`ASSERT
 (
	`Re£tEvít
 (
io
->
ovîœµed
.
hEvít
));

3117 
	`msg
 (
D_WIN32_IO
 | 
M_ERRNO
, "WIN32 I/O: Socket CompletionÉrror");

3122 
IOSTATE_IMMEDIATE_RETURN
:

3123 
io
->
io°©e
 = 
IOSTATE_INITIAL
;

3124 
	`ASSERT
 (
	`Re£tEvít
 (
io
->
ovîœµed
.
hEvít
));

3125 i‡(
io
->
°©us
)

3128 
	`WSASëLa°Eº‹
 (
io
->
°©us
);

3129 
ªt
 = -1;

3130 
	`msg
 (
D_WIN32_IO
 | 
M_ERRNO
, "WIN32 I/O: Socket CompletionÇon-queuedÉrror");

3135 i‡(
buf
)

3136 *
buf
 = 
io
->buf;

3137 
ªt
 = 
io
->
size
;

3138 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: Sockë Com∂ëi⁄Ç⁄-queued suc˚s†[%d]", 
ªt
);

3142 
IOSTATE_INITIAL
:

3143 
	`WSASëLa°Eº‹
 (
WSAEINVAL
);

3144 
ªt
 = -1;

3145 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: Socket Completion BAD STATE");

3149 
	`ASSERT
 (0);

3153 i‡(
‰om
)

3155 i‡(
ªt
 >0 && 
io
->
addr_deföed
)

3163 
io
->
addæí
)

3165 (
sockaddr_ö
):

3166 (
sockaddr_ö6
):

3169 (
sockaddr_ö6
)-4:

3172 
	`bad_addªss_Àngth
 (
io
->
addæí
, 
	`af_addr_size
(io->
addr
.
sö_Ámûy
));

3175 
io
->
addr
.
sö_Ámûy
)

3177 
AF_INET
:

3178 
‰om
->
de°
.
addr
.
ö4
 = 
io
->addr;

3180 
AF_INET6
:

3181 
‰om
->
de°
.
addr
.
ö6
 = 
io
->
addr6
;

3186 
	`CLEAR
 (
‰om
->
de°
.
addr
);

3189 i‡(
buf
)

3190 
buf
->
Àn
 = 
ªt
;

3191  
ªt
;

3192 
	}
}

3201 
	$sockë_£t
 (
lök_sockë
 *
s
,

3202 
evít_£t
 *
es
,

3203 
rwÊags
,

3204 *
¨g
,

3205 *
≥rsi°ít
)

3207 i‡(
s
)

3209 i‡((
rwÊags
 & 
EVENT_READ
Ë&& !
	`°ªam_buf_ªad_£tup
 (
s
))

3211 
	`ASSERT
 (!
≥rsi°ít
);

3212 
rwÊags
 &~
EVENT_READ
;

3215 #ifde‡
WIN32


3216 i‡(
rwÊags
 & 
EVENT_READ
)

3217 
	`sockë_ªcv_queue
 (
s
, 0);

3221 i‡(!
≥rsi°ít
 || *≥rsi°íà!
rwÊags
)

3223 
	`evít_˘l
 (
es
, 
	`sockë_evít_h™dÀ
 (
s
), 
rwÊags
, 
¨g
);

3224 i‡(
≥rsi°ít
)

3225 *
≥rsi°ít
 = 
rwÊags
;

3228 
s
->
rwÊags_debug
 = 
rwÊags
;

3230  
rwÊags
;

3231 
	}
}

3234 
	$sd_˛o£
 (
sockë_des¸ùt‹_t
 *
sd
)

3236 i‡(
sd
 && 
	`sockë_deföed
 (*sd))

3238 
	`›ív≤_˛o£_sockë
 (*
sd
);

3239 *
sd
 = 
SOCKET_UNDEFINED
;

3241 
	}
}

3243 #i‡
UNIX_SOCK_SUPPORT


3250 
	$sockaddr_unix_«me
 (c⁄° 
sockaddr_un
 *
loˇl
, c⁄° *
nuŒ
)

3252 i‡(
loˇl
 &&Üoˇl->
sun_Ámûy
 =
PF_UNIX
)

3253  
loˇl
->
sun_∑th
;

3255  
nuŒ
;

3256 
	}
}

3258 
sockë_des¸ùt‹_t


3259 
	$¸óã_sockë_unix
 ()

3261 
sockë_des¸ùt‹_t
 
sd
;

3263 i‡((
sd
 = 
	`sockë
 (
PF_UNIX
, 
SOCK_STREAM
, 0)) < 0)

3264 
	`msg
 (
M_ERR
, "Cannot create unix domain socket");

3265  
sd
;

3266 
	}
}

3269 
	$sockë_böd_unix
 (
sockë_des¸ùt‹_t
 
sd
,

3270 
sockaddr_un
 *
loˇl
,

3271 c⁄° *
¥efix
)

3273 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3275 #ifde‡
HAVE_UMASK


3276 c⁄° 
mode_t
 
‹ig_umask
 = 
	`umask
 (0);

3279 i‡(
	`böd
 (
sd
, (
sockaddr
 *Ë
loˇl
,  (
sockaddr_un
)))

3281 c⁄° 
î∫um
 = 
	`›ív≤_î∫o
 ();

3282 
	`msg
 (
M_FATAL
, "%s: Socket bind[%d] failed on unix domain socket %s: %s",

3283 
¥efix
,

3284 ()
sd
,

3285 
	`sockaddr_unix_«me
 (
loˇl
, "NULL"),

3286 
	`°ªº‹_ts
 (
î∫um
, &
gc
));

3289 #ifde‡
HAVE_UMASK


3290 
	`umask
 (
‹ig_umask
);

3293 
	`gc_‰ì
 (&
gc
);

3294 
	}
}

3296 
sockë_des¸ùt‹_t


3297 
	$sockë_ac˚±_unix
 (
sockë_des¸ùt‹_t
 
sd
,

3298 
sockaddr_un
 *
ªmŸe
)

3300 
sockÀn_t
 
ªmŸe_Àn
 =  (
sockaddr_un
);

3301 
sockë_des¸ùt‹_t
 
ªt
;

3303 
	`CLEAR
 (*
ªmŸe
);

3304 
ªt
 = 
	`ac˚±
 (
sd
, (
sockaddr
 *Ë
ªmŸe
, &
ªmŸe_Àn
);

3305  
ªt
;

3306 
	}
}

3309 
	$sockë_c⁄√˘_unix
 (
sockë_des¸ùt‹_t
 
sd
,

3310 
sockaddr_un
 *
ªmŸe
)

3312 
°©us
 = 
	`c⁄√˘
 (
sd
, (
sockaddr
 *Ë
ªmŸe
,  (
sockaddr_un
));

3313 i‡(
°©us
)

3314 
°©us
 = 
	`›ív≤_î∫o
 ();

3315  
°©us
;

3316 
	}
}

3319 
	$sockaddr_unix_öô
 (
sockaddr_un
 *
loˇl
, c⁄° *
∑th
)

3321 
loˇl
->
sun_Ámûy
 = 
PF_UNIX
;

3322 
	`°∫˝y¡
 (
loˇl
->
sun_∑th
, 
∑th
,  (local->sun_path));

3323 
	}
}

3326 
	$sockë_dñëe_unix
 (c⁄° 
sockaddr_un
 *
loˇl
)

3328 c⁄° *
«me
 = 
	`sockaddr_unix_«me
 (
loˇl
, 
NULL
);

3329 #ifde‡
HAVE_UNLINK


3330 i‡(
«me
 && 
	`°æí
 (name))

3331 
	`u∆ök
 (
«me
);

3333 
	}
}

3335 
boﬁ


3336 
	$unix_sockë_gë_≥î_uid_gid
 (c⁄° 
sockë_des¸ùt‹_t
 
sd
, *
uid
, *
gid
)

3338 #ifde‡
HAVE_GETPEEREID


3339 
uid_t
 
u
;

3340 
gid_t
 
g
;

3341 i‡(
	`gë≥îeid
 (
sd
, &
u
, &
g
) == -1)

3342  
Ál£
;

3343 i‡(
uid
)

3344 *
uid
 = 
u
;

3345 i‡(
gid
)

3346 *
gid
 = 
g
;

3347  
åue
;

3348 #ñi‡
	`deföed
(
SO_PEERCRED
)

3349 
u¸ed
 
≥î¸ed
;

3350 
sockÀn_t
 
so_Àn
 = (
≥î¸ed
);

3351 i‡(
	`gësock›t
(
sd
, 
SOL_SOCKET
, 
SO_PEERCRED
, &
≥î¸ed
, &
so_Àn
) == -1)

3352  
Ál£
;

3353 i‡(
uid
)

3354 *
uid
 = 
≥î¸ed
.uid;

3355 i‡(
gid
)

3356 *
gid
 = 
≥î¸ed
.gid;

3357  
åue
;

3359  
Ál£
;

3361 
	}
}

	@src/openvpn/socket.h

25 #i‚de‡
SOCKET_H


26 
	#SOCKET_H


	)

28 
	~"buf„r.h
"

29 
	~"comm⁄.h
"

30 
	~"îr‹.h
"

31 
	~"¥Ÿo.h
"

32 
	~"mtu.h
"

33 
	~"wö32.h
"

34 
	~"evít.h
"

35 
	~"¥oxy.h
"

36 
	~"socks.h
"

37 
	~"misc.h
"

42 
	#OPENVPN_PORT
 1194

	)

47 
	#SOCKET_SND_RCV_BUF_MAX
 1000000

	)

53 
	#RESOLV_RETRY_INFINITE
 1000000000

	)

61 
uöt16_t
 
	t∑ckë_size_ty≥
;

64 
	#ht⁄ps
(
x
Ë
	`ht⁄s
(x)

	)

67 
	#¡ohps
(
x
Ë
	`¡ohs
(x)

	)

70 
	s›ív≤_sockaddr


74 
sockaddr
 
	mß
;

75 
sockaddr_ö
 
	mö4
;

76 
sockaddr_ö6
 
	mö6
;

77 } 
	maddr
;

81 
	slök_sockë_a˘uÆ


84 
›ív≤_sockaddr
 
	mde°
;

85 #i‡
ENABLE_IP_PKTINFO


87 #ifde‡
HAVE_IN_PKTINFO


88 
ö_pktöfo
 
	mö4
;

89 #ñi‡
deföed
(
IP_RECVDSTADDR
)

90 
ö_addr
 
	mö4
;

92 
ö6_pktöfo
 
	mö6
;

93 } 
	mpi
;

98 
	slök_sockë_addr


100 
›ív≤_sockaddr
 
	mloˇl
;

101 
›ív≤_sockaddr
 
	mªmŸe
;

102 
lök_sockë_a˘uÆ
 
	ma˘uÆ
;

105 
	slök_sockë_öfo


107 
lök_sockë_addr
 *
	mlß
;

108 
boﬁ
 
	mc⁄√˘i⁄_e°ablished
;

109 c⁄° *
	mùch™ge_comm™d
;

110 c⁄° 
∂ugö_li°
 *
	m∂ugös
;

111 
boﬁ
 
	mªmŸe_Êﬂt
;

112 
	m¥Ÿo
;

113 
	mmtu_ch™ged
;

120 
	s°ªam_buf


122 
buf„r
 
	mbuf_öô
;

123 
buf„r
 
	mªsiduÆ
;

124 
	mmaxÀn
;

125 
boﬁ
 
	mªsiduÆ_fuŒy_f‹med
;

127 
buf„r
 
	mbuf
;

128 
buf„r
 
	m√xt
;

129 
	mÀn
;

131 
boﬁ
 
	mîr‹
;

133 #i‡
PORT_SHARE


134 
	#PS_DISABLED
 0

	)

135 
	#PS_ENABLED
 1

	)

136 
	#PS_FOREIGN
 2

	)

137 
	mp‹t_sh¨e_°©e
;

144 
	ssockë_buf„r_size


146 
	mrcvbuf
;

147 
	m¢dbuf
;

155 
	slök_sockë


157 
lök_sockë_öfo
 
	möfo
;

159 
sockë_des¸ùt‹_t
 
	msd
;

161 #ifde‡
ENABLE_SOCKS


162 
sockë_des¸ùt‹_t
 
	m˘æ_sd
;

165 #ifde‡
WIN32


166 
ovîœµed_io
 
	mªads
;

167 
ovîœµed_io
 
	mwrôes
;

168 
rw_h™dÀ
 
	mrw_h™dÀ
;

169 
rw_h™dÀ
 
	mli°í_h™dÀ
;

173 
	mrwÊags_debug
;

176 
boﬁ
 
	mli°í_≥rsi°ít_queued
;

179 
boﬁ
 
	mc⁄√˘i⁄_¥ofûes_deföed
;

181 c⁄° *
	mªmŸe_ho°
;

182 
	mªmŸe_p‹t
;

183 c⁄° *
	mloˇl_ho°
;

184 
	mloˇl_p‹t
;

185 
boﬁ
 
	mböd_loˇl
;

187 
	#INETD_NONE
 0

	)

188 
	#INETD_WAIT
 1

	)

189 
	#INETD_NOWAIT
 2

	)

190 
	möëd
;

192 
	#LS_MODE_DEFAULT
 0

	)

193 
	#LS_MODE_TCP_LISTEN
 1

	)

194 
	#LS_MODE_TCP_ACCEPT_FROM
 2

	)

195 
	mmode
;

197 
	mªsﬁve_ªåy_£c⁄ds
;

198 
	mc⁄√˘_ªåy_£c⁄ds
;

199 
	mc⁄√˘_timeout
;

200 
	mc⁄√˘_ªåy_max
;

201 
	mmtu_discovî_ty≥
;

203 
sockë_buf„r_size
 
	msockë_buf„r_sizes
;

205 
	mmtu
;

207 
boﬁ
 
	mdid_ªsﬁve_ªmŸe
;

209 
	#SF_USE_IP_PKTINFO
 (1<<0)

	)

210 
	#SF_TCP_NODELAY
 (1<<1)

	)

211 
	#SF_PORT_SHARE
 (1<<2)

	)

212 
	#SF_HOST_RANDOMIZE
 (1<<3)

	)

213 
	#SF_GETADDRINFO_DGRAM
 (1<<4)

	)

214 
	msockÊags
;

217 
°ªam_buf
 
	m°ªam_buf
;

218 
buf„r
 
	m°ªam_buf_d©a
;

219 
boﬁ
 
	m°ªam_ª£t
;

221 #ifde‡
ENABLE_HTTP_PROXY


223 
hâp_¥oxy_öfo
 *
	mhâp_¥oxy
;

226 #ifde‡
ENABLE_SOCKS


228 
socks_¥oxy_öfo
 *
	msocks_¥oxy
;

229 
lök_sockë_a˘uÆ
 
	msocks_ªœy
;

232 #i‡
deföed
(
ENABLE_HTTP_PROXY
Ë|| deföed(
ENABLE_SOCKS
)

234 c⁄° *
	m¥oxy_de°_ho°
;

235 
	m¥oxy_de°_p‹t
;

238 #i‡
PASSTOS_CAPABILITY


240 #i‡
deföed
(
TARGET_LINUX
)

241 
uöt8_t
 
	m±os
;

243 
	m±os
;

245 
boﬁ
 
	m±os_deföed
;

248 #ifde‡
ENABLE_DEBUG


249 
	mgªmlö
;

257 #i‚de‡
MSG_NOSIGNAL


258 
	#MSG_NOSIGNAL
 0

	)

261 #ifde‡
WIN32


263 
	#›ív≤_˛o£_sockë
(
s
Ë
	`˛o£sockë
(s)

	)

265 
sockë_ªcv_queue
 (
lök_sockë
 *
sock
, 
maxsize
);

267 
sockë_£nd_queue
 (
lök_sockë
 *
sock
,

268 
buf„r
 *
buf
,

269 c⁄° 
lök_sockë_a˘uÆ
 *
to
);

271 
sockë_föÆize
 (

272 
SOCKET
 
s
,

273 
ovîœµed_io
 *
io
,

274 
buf„r
 *
buf
,

275 
lök_sockë_a˘uÆ
 *
‰om
);

279 
	#›ív≤_˛o£_sockë
(
s
Ë
	`˛o£
(s)

	)

283 
lök_sockë
 *
lök_sockë_√w
 ();

285 
sockë_böd
 (
sockë_des¸ùt‹_t
 
sd
,

286 
›ív≤_sockaddr
 *
loˇl
,

287 c⁄° *
¥efix
);

289 
›ív≤_c⁄√˘
 (
sockë_des¸ùt‹_t
 
sd
,

290 
›ív≤_sockaddr
 *
ªmŸe
,

291 
c⁄√˘_timeout
,

292 vﬁ©ûê*
sig«l_ª˚ived
);

299 
lök_sockë_öô_pha£1
 (
lök_sockë
 *
sock
,

300 c⁄° 
boﬁ
 
c⁄√˘i⁄_¥ofûes_deföed
,

301 c⁄° *
loˇl_ho°
,

302 
loˇl_p‹t
,

303 c⁄° *
ªmŸe_ho°
,

304 
ªmŸe_p‹t
,

305 
¥Ÿo
,

306 
mode
,

307 c⁄° 
lök_sockë
 *
ac˚±_‰om
,

308 #ifde‡
ENABLE_HTTP_PROXY


309 
hâp_¥oxy_öfo
 *
hâp_¥oxy
,

311 #ifde‡
ENABLE_SOCKS


312 
socks_¥oxy_öfo
 *
socks_¥oxy
,

314 #ifde‡
ENABLE_DEBUG


315 
gªmlö
,

317 
boﬁ
 
böd_loˇl
,

318 
boﬁ
 
ªmŸe_Êﬂt
,

319 
öëd
,

320 
lök_sockë_addr
 *
lß
,

321 c⁄° *
ùch™ge_comm™d
,

322 c⁄° 
∂ugö_li°
 *
∂ugös
,

323 
ªsﬁve_ªåy_£c⁄ds
,

324 
c⁄√˘_ªåy_£c⁄ds
,

325 
c⁄√˘_timeout
,

326 
c⁄√˘_ªåy_max
,

327 
mtu_discovî_ty≥
,

328 
rcvbuf
,

329 
¢dbuf
,

330 
m¨k
,

331 
sockÊags
);

333 
lök_sockë_öô_pha£2
 (
lök_sockë
 *
sock
,

334 c⁄° 
‰ame
 *frame,

335 vﬁ©ûê*
sig«l_ª˚ived
);

337 
sockë_adju°_‰ame_∑ømëîs
 (
‰ame
 *‰ame, 
¥Ÿo
);

339 
‰ame_adju°_∑th_mtu
 (
‰ame
 *‰ame, 
pmtu
, 
¥Ÿo
);

341 
lök_sockë_˛o£
 (
lök_sockë
 *
sock
);

343 
sd_˛o£
 (
sockë_des¸ùt‹_t
 *
sd
);

345 
	#PS_SHOW_PORT_IF_DEFINED
 (1<<0)

	)

346 
	#PS_SHOW_PORT
 (1<<1)

	)

347 
	#PS_SHOW_PKTINFO
 (1<<2)

	)

348 
	#PS_DONT_SHOW_ADDR
 (1<<3)

	)

350 c⁄° *
¥öt_sockaddr_ex
 (c⁄° 
›ív≤_sockaddr
 *
addr
,

351 c⁄° * 
£∑øt‹
,

352 c⁄° 
Êags
,

353 
gc_¨ía
 *
gc
);

356 c⁄° *
¥öt_sockaddr
 (c⁄° 
›ív≤_sockaddr
 *
addr
,

357 
gc_¨ía
 *
gc
);

359 c⁄° *
¥öt_lök_sockë_a˘uÆ_ex
 (c⁄° 
lök_sockë_a˘uÆ
 *
a˘
,

360 c⁄° * 
£∑øt‹
,

361 c⁄° 
Êags
,

362 
gc_¨ía
 *
gc
);

364 c⁄° *
¥öt_lök_sockë_a˘uÆ
 (c⁄° 
lök_sockë_a˘uÆ
 *
a˘
,

365 
gc_¨ía
 *
gc
);

368 
	#IA_EMPTY_IF_UNDEF
 (1<<0)

	)

369 
	#IA_NET_ORDER
 (1<<1)

	)

370 c⁄° *
¥öt_ö_addr_t
 (
ö_addr_t
 
addr
, 
Êags
, 
gc_¨ía
 *
gc
);

371 c⁄° *
¥öt_ö6_addr
 (
ö6_addr
 
addr6
, 
Êags
, 
gc_¨ía
 *
gc
);

372 
ö6_addr
 
add_ö6_addr
–ö6_add∏
ba£
, 
uöt32_t
 
add
 );

374 
	#SA_IP_PORT
 (1<<0)

	)

375 
	#SA_SET_IF_NONZERO
 (1<<1)

	)

376 
£ãnv_sockaddr
 (
ív_£t
 *
es
,

377 c⁄° *
«me_¥efix
,

378 c⁄° 
›ív≤_sockaddr
 *
addr
,

379 c⁄° 
Êags
);

381 
£ãnv_ö_addr_t
 (
ív_£t
 *
es
,

382 c⁄° *
«me_¥efix
,

383 
ö_addr_t
 
addr
,

384 c⁄° 
Êags
);

386 
£ãnv_lök_sockë_a˘uÆ
 (
ív_£t
 *
es
,

387 c⁄° *
«me_¥efix
,

388 c⁄° 
lök_sockë_a˘uÆ
 *
a˘
,

389 c⁄° 
Êags
);

391 
bad_addªss_Àngth
 (
a˘uÆ
, 
ex≥˘ed
);

396 
	#IPV4_INVALID_ADDR
 0xffffffff

	)

397 
ö_addr_t
 
lök_sockë_cuºít_ªmŸe
 (c⁄° 
lök_sockë_öfo
 *
öfo
);

399 
lök_sockë_c⁄√˘i⁄_öôüãd
 (c⁄° 
buf„r
 *
buf
,

400 
lök_sockë_öfo
 *
öfo
,

401 c⁄° 
lök_sockë_a˘uÆ
 *
addr
,

402 c⁄° *
comm⁄_«me
,

403 
ív_£t
 *
es
);

405 
lök_sockë_bad_öcomög_addr
 (
buf„r
 *
buf
,

406 c⁄° 
lök_sockë_öfo
 *
öfo
,

407 c⁄° 
lök_sockë_a˘uÆ
 *
‰om_addr
);

409 
lök_sockë_bad_outgoög_addr
 ();

411 
£ãnv_åu°ed
 (
ív_£t
 *
es
, c⁄° 
lök_sockë_öfo
 *
öfo
);

413 
boﬁ
 
lök_sockë_upd©e_Êags
 (
lök_sockë
 *
ls
, 
sockÊags
);

414 
lök_sockë_upd©e_buf„r_sizes
 (
lök_sockë
 *
ls
, 
rcvbuf
, 
¢dbuf
);

421 
	#OIA_HOSTNAME
 0

	)

422 
	#OIA_IP
 1

	)

423 
	#OIA_ERROR
 -1

	)

424 
›ív≤_öë_©⁄
 (c⁄° *
dŸãd_quad
, 
ö_addr
 *
addr
);

427 
boﬁ
 
ù_addr_dŸãd_quad_ß„
 (c⁄° *
dŸãd_quad
);

428 
boﬁ
 
ù_‹_dns_addr_ß„
 (c⁄° *
addr
, c⁄° boﬁ 
Ælow_fqdn
);

429 
boﬁ
 
mac_addr_ß„
 (c⁄° *
mac_addr
);

430 
boﬁ
 
ùv6_addr_ß„
 (c⁄° *
ùv6_ãxt_addr
);

432 
sockë_des¸ùt‹_t
 
¸óã_sockë_t˝
 (
af
);

434 
sockë_des¸ùt‹_t
 
sockë_do_ac˚±
 (sockë_des¸ùt‹_à
sd
,

435 
lök_sockë_a˘uÆ
 *
a˘
,

436 c⁄° 
boﬁ
 
nowaô
);

440 
boﬁ
 
¥Ÿo_is_√t
(
¥Ÿo
);

441 
boﬁ
 
¥Ÿo_is_dgøm
(
¥Ÿo
);

442 
boﬁ
 
¥Ÿo_is_udp
(
¥Ÿo
);

443 
boﬁ
 
¥Ÿo_is_t˝
(
¥Ÿo
);

446 #i‡
UNIX_SOCK_SUPPORT


448 
sockë_des¸ùt‹_t
 
¸óã_sockë_unix
 ();

450 
sockë_böd_unix
 (
sockë_des¸ùt‹_t
 
sd
,

451 
sockaddr_un
 *
loˇl
,

452 c⁄° *
¥efix
);

454 
sockë_des¸ùt‹_t
 
sockë_ac˚±_unix
 (sockë_des¸ùt‹_à
sd
,

455 
sockaddr_un
 *
ªmŸe
);

457 
sockë_c⁄√˘_unix
 (
sockë_des¸ùt‹_t
 
sd
,

458 
sockaddr_un
 *
ªmŸe
);

460 
sockaddr_unix_öô
 (
sockaddr_un
 *
loˇl
, c⁄° *
∑th
);

462 c⁄° *
sockaddr_unix_«me
 (c⁄° 
sockaddr_un
 *
loˇl
, c⁄° *
nuŒ
);

464 
sockë_dñëe_unix
 (c⁄° 
sockaddr_un
 *
loˇl
);

466 
boﬁ
 
unix_sockë_gë_≥î_uid_gid
 (c⁄° 
sockë_des¸ùt‹_t
 
sd
, *
uid
, *
gid
);

474 
	#GETADDR_RESOLVE
 (1<<0)

	)

475 
	#GETADDR_FATAL
 (1<<1)

	)

476 
	#GETADDR_HOST_ORDER
 (1<<2)

	)

477 
	#GETADDR_MENTION_RESOLVE_RETRY
 (1<<3)

	)

478 
	#GETADDR_FATAL_ON_SIGNAL
 (1<<4)

	)

479 
	#GETADDR_WARN_ON_SIGNAL
 (1<<5)

	)

480 
	#GETADDR_MSG_VIRT_OUT
 (1<<6)

	)

481 
	#GETADDR_TRY_ONCE
 (1<<7)

	)

482 
	#GETADDR_UPDATE_MANAGEMENT_STATE
 (1<<8)

	)

483 
	#GETADDR_RANDOMIZE
 (1<<9)

	)

485 
ö_addr_t
 
gëaddr
 (
Êags
,

486 c⁄° *
ho°«me
,

487 
ªsﬁve_ªåy_£c⁄ds
,

488 
boﬁ
 *
suc˚eded
,

489 vﬁ©ûê*
sig«l_ª˚ived
);

491 
›ív≤_gëaddröfo
 (
Êags
,

492 c⁄° *
ho°«me
,

493 
ªsﬁve_ªåy_£c⁄ds
,

494 vﬁ©ûê*
sig«l_ª˚ived
,

495 
ai_Ámûy
,

496 
addröfo
 **
ªs
);

506 
	e¥Ÿo_num
 {

507 
	mPROTO_NONE
,

508 
	mPROTO_UDPv4
,

509 
	mPROTO_TCPv4_SERVER
,

510 
	mPROTO_TCPv4_CLIENT
,

511 
	mPROTO_TCPv4
,

512 
	mPROTO_UDPv6
,

513 
	mPROTO_TCPv6_SERVER
,

514 
	mPROTO_TCPv6_CLIENT
,

515 
	mPROTO_TCPv6
,

516 
	mPROTO_N


519 
ascii2¥Ÿo
 (c⁄° * 
¥Ÿo_«me
);

520 c⁄° *
¥Ÿo2ascii
 (
¥Ÿo
, 
boﬁ
 
di•œy_f‹m
);

521 c⁄° *
¥Ÿo2ascii_Æl
 (
gc_¨ía
 *
gc
);

522 
¥Ÿo_ªmŸe
 (
¥Ÿo
, 
boﬁ
 
ªmŸe
);

523 c⁄° *
addr_Ámûy_«me
(
af
);

528 
	#IPv4_UDP_HEADER_SIZE
 28

	)

529 
	#IPv4_TCP_HEADER_SIZE
 40

	)

530 
	#IPv6_UDP_HEADER_SIZE
 48

	)

531 
	#IPv6_TCP_HEADER_SIZE
 60

	)

533 c⁄° 
¥Ÿo_ovîhód
[];

535 
ölöe
 

536 
	$d©agøm_ovîhód
 (
¥Ÿo
)

538 
	`ASSERT
 (
¥Ÿo
 >0 &&ÖrŸÿ< 
PROTO_N
);

539  
¥Ÿo_ovîhód
 [
¥Ÿo
];

540 
	}
}

546 
ölöe
 
boﬁ


547 
	$ÀgÆ_ùv4_p‹t
 (
p‹t
)

549  
p‹t
 > 0 &&Öort < 65536;

550 
	}
}

552 
ölöe
 
boﬁ


553 
	$lök_sockë_¥Ÿo_c⁄√˘i⁄_‹õ¡ed
 (
¥Ÿo
)

555  !
	`¥Ÿo_is_dgøm
(
¥Ÿo
);

556 
	}
}

558 
ölöe
 
boﬁ


559 
	$lök_sockë_c⁄√˘i⁄_‹õ¡ed
 (c⁄° 
lök_sockë
 *
sock
)

561 i‡(
sock
)

562  
	`lök_sockë_¥Ÿo_c⁄√˘i⁄_‹õ¡ed
 (
sock
->
öfo
.
¥Ÿo
);

564  
Ál£
;

565 
	}
}

567 
ölöe
 
boﬁ


568 
	$addr_deföed
 (c⁄° 
›ív≤_sockaddr
 *
addr
)

570 i‡(!
addr
)  0;

571 
addr
->addr.
ß
.
ß_Ámûy
) {

572 
AF_INET
:  
addr
->addr.
ö4
.
sö_addr
.
s_addr
 != 0;

573 
AF_INET6
:  !
	`IN6_IS_ADDR_UNSPECIFIED
(&
addr
->addr.
ö6
.
sö6_addr
);

576 
	}
}

577 
ölöe
 
boﬁ


578 
	$addr_deföed_ùi
 (c⁄° 
lök_sockë_a˘uÆ
 *
lß
)

580 #i‡
ENABLE_IP_PKTINFO


581 i‡(!
lß
)  0;

582 
lß
->
de°
.
addr
.
ß
.
ß_Ámûy
) {

583 #ifde‡
HAVE_IN_PKTINFO


584 
AF_INET
:  
lß
->
pi
.
ö4
.
ùi_•ec_d°
.
s_addr
 != 0;

585 #ñi‡
	`deföed
(
IP_RECVDSTADDR
)

586 
AF_INET
:  
lß
->
pi
.
ö4
.
s_addr
 != 0;

588 
AF_INET6
:  !
	`IN6_IS_ADDR_UNSPECIFIED
(&
lß
->
pi
.
ö6
.
ùi6_addr
);

592 
	`ASSERT
(0);

594  
Ál£
;

595 
	}
}

597 
ölöe
 
boﬁ


598 
	$lök_sockë_a˘uÆ_deföed
 (c⁄° 
lök_sockë_a˘uÆ
 *
a˘
)

600  
a˘
 && 
	`addr_deföed
 (&a˘->
de°
);

601 
	}
}

603 
ölöe
 
boﬁ


604 
	$addr_m©ch
 (c⁄° 
›ív≤_sockaddr
 *
a1
, c⁄° ›ív≤_sockadd∏*
a2
)

606 
a1
->
addr
.
ß
.
ß_Ámûy
) {

607 
AF_INET
:

608  
a1
->
addr
.
ö4
.
sö_addr
.
s_addr
 =
a2
->addr.in4.sin_addr.s_addr;

609 
AF_INET6
:

610  
	`IN6_ARE_ADDR_EQUAL
(&
a1
->
addr
.
ö6
.
sö6_addr
, &
a2
->addr.in6.sin6_addr);

612 
	`ASSERT
(0);

613  
Ál£
;

614 
	}
}

616 
ölöe
 
ö_addr_t


617 
	$addr_ho°
 (c⁄° 
›ív≤_sockaddr
 *
addr
)

624 if(
addr
->addr.
ß
.
ß_Ámûy
 !
AF_INET
)

626  
	`¡ohl
 (
addr
->addr.
ö4
.
sö_addr
.
s_addr
);

627 
	}
}

629 
ölöe
 
boﬁ


630 
	$addr_p‹t_m©ch
 (c⁄° 
›ív≤_sockaddr
 *
a1
, c⁄° ›ív≤_sockadd∏*
a2
)

632 
a1
->
addr
.
ß
.
ß_Ámûy
) {

633 
AF_INET
:

634  
a1
->
addr
.
ö4
.
sö_addr
.
s_addr
 =
a2
->addr.in4.sin_addr.s_addr

635 && 
a1
->
addr
.
ö4
.
sö_p‹t
 =
a2
->addr.in4.sin_port;

636 
AF_INET6
:

637  
	`IN6_ARE_ADDR_EQUAL
(&
a1
->
addr
.
ö6
.
sö6_addr
, &
a2
->addr.in6.sin6_addr)

638 && 
a1
->
addr
.
ö6
.
sö6_p‹t
 =
a2
->addr.in6.sin6_port;

640 
	`ASSERT
(0);

641  
Ál£
;

642 
	}
}

644 
ölöe
 
boﬁ


645 
	$addr_m©ch_¥Ÿo
 (c⁄° 
›ív≤_sockaddr
 *
a1
,

646 c⁄° 
›ív≤_sockaddr
 *
a2
,

647 c⁄° 
¥Ÿo
)

649  
	`lök_sockë_¥Ÿo_c⁄√˘i⁄_‹õ¡ed
 (
¥Ÿo
)

650 ? 
	`addr_m©ch
 (
a1
, 
a2
)

651 : 
	`addr_p‹t_m©ch
 (
a1
, 
a2
);

652 
	}
}

654 
ölöe
 

655 
	$addr_zîo_ho°
(
›ív≤_sockaddr
 *
addr
)

657 
addr
->addr.
ß
.
ß_Ámûy
) {

658 
AF_INET
:

659 
addr
->addr.
ö4
.
sö_addr
.
s_addr
 = 0;

661 
AF_INET6
:

662 
	`mem£t
(&
addr
->addr.
ö6
.
sö6_addr
, 0,  (
ö6_addr
));

665 
	}
}

667 
ölöe
 

668 
	$addr_c›y_ß
(
›ív≤_sockaddr
 *
d°
, c⁄° ›ív≤_sockadd∏*
§c
)

670 
d°
->
addr
 = 
§c
->addr;

671 
	}
}

673 
ölöe
 

674 
	$addr_c›y_ho°
(
›ív≤_sockaddr
 *
d°
, c⁄° ›ív≤_sockadd∏*
§c
)

676 
§c
->
addr
.
ß
.
ß_Ámûy
) {

677 
AF_INET
:

678 
d°
->
addr
.
ö4
.
sö_addr
.
s_addr
 = 
§c
->addr.in4.sin_addr.s_addr;

680 
AF_INET6
:

681 
d°
->
addr
.
ö6
.
sö6_addr
 = 
§c
->addr.in6.sin6_addr;

684 
	}
}

686 
ölöe
 
boﬁ


687 
	$addr_öë4‹6
(
sockaddr
 *
addr
)

689  
addr
->
ß_Ámûy
 =
AF_INET
 ||áddr->ß_Ámûy =
AF_INET6
;

690 
	}
}

692 
addr_guess_Ámûy
(
¥Ÿo
, c⁄° *
«me
);

693 
ölöe
 

694 
	$af_addr_size
(
af
)

696 
af
) {

697 
AF_INET
:   (
sockaddr_ö
);

698 
AF_INET6
:   (
sockaddr_ö6
);

702 
	`msg
 (
M_ERR
, "Badáddªs†Ámûy: %d\n", 
af
);

703 
	`ASSERT
(0);

707 
	}
}

709 
ölöe
 
boﬁ


710 
	$lök_sockë_a˘uÆ_m©ch
 (c⁄° 
lök_sockë_a˘uÆ
 *
a1
, c⁄° lök_sockë_a˘uÆ *
a2
)

712  
	`addr_p‹t_m©ch
 (&
a1
->
de°
, &
a2
->dest);

713 
	}
}

715 #i‡
PORT_SHARE


717 
ölöe
 
boﬁ


718 
	$sockë_f‹eign_¥Ÿocﬁ_dëe˘ed
 (c⁄° 
lök_sockë
 *
sock
)

720  
	`lök_sockë_c⁄√˘i⁄_‹õ¡ed
 (
sock
)

721 && 
sock
->
°ªam_buf
.
p‹t_sh¨e_°©e
 =
PS_FOREIGN
;

722 
	}
}

724 
ölöe
 c⁄° 
buf„r
 *

725 
	$sockë_f‹eign_¥Ÿocﬁ_hód
 (c⁄° 
lök_sockë
 *
sock
)

727  &
sock
->
°ªam_buf
.
buf
;

728 
	}
}

730 
ölöe
 

731 
	$sockë_f‹eign_¥Ÿocﬁ_sd
 (c⁄° 
lök_sockë
 *
sock
)

733  
sock
->
sd
;

734 
	}
}

738 
ölöe
 
boﬁ


739 
	$sockë_c⁄√˘i⁄_ª£t
 (c⁄° 
lök_sockë
 *
sock
, 
°©us
)

741 i‡(
	`lök_sockë_c⁄√˘i⁄_‹õ¡ed
 (
sock
))

743 i‡(
sock
->
°ªam_ª£t
 || sock->
°ªam_buf
.
îr‹
)

744  
åue
;

745 i‡(
°©us
 < 0)

747 c⁄° 
îr
 = 
	`›ív≤_î∫o
 ();

748 #ifde‡
WIN32


749  
îr
 =
WSAECONNRESET
 ||Éº =
WSAECONNABORTED
;

751  
îr
 =
ECONNRESET
;

755  
Ál£
;

756 
	}
}

758 
ölöe
 
boﬁ


759 
	$lök_sockë_vîify_öcomög_addr
 (
buf„r
 *
buf
,

760 c⁄° 
lök_sockë_öfo
 *
öfo
,

761 c⁄° 
lök_sockë_a˘uÆ
 *
‰om_addr
)

763 i‡(
buf
->
Àn
 > 0)

765 
‰om_addr
->
de°
.
addr
.
ß
.
ß_Ámûy
) {

766 
AF_INET6
:

767 
AF_INET
:

768 i‡(!
	`lök_sockë_a˘uÆ_deföed
 (
‰om_addr
))

769  
Ál£
;

770 i‡(
öfo
->
ªmŸe_Êﬂt
 || !
	`addr_deföed
 (&öfo->
lß
->
ªmŸe
))

771  
åue
;

772 i‡(
	`addr_m©ch_¥Ÿo
 (&
‰om_addr
->
de°
, &
öfo
->
lß
->
ªmŸe
, info->
¥Ÿo
))

773  
åue
;

776  
Ál£
;

777 
	}
}

779 
ölöe
 

780 
	$lök_sockë_gë_outgoög_addr
 (
buf„r
 *
buf
,

781 c⁄° 
lök_sockë_öfo
 *
öfo
,

782 
lök_sockë_a˘uÆ
 **
a˘
)

784 i‡(
buf
->
Àn
 > 0)

786 
lök_sockë_addr
 *
lß
 = 
öfo
->lsa;

787 i‡(
	`lök_sockë_a˘uÆ_deföed
 (&
lß
->
a˘uÆ
))

788 *
a˘
 = &
lß
->
a˘uÆ
;

791 
	`lök_sockë_bad_outgoög_addr
 ();

792 
buf
->
Àn
 = 0;

793 *
a˘
 = 
NULL
;

796 
	}
}

798 
ölöe
 

799 
	$lök_sockë_£t_outgoög_addr
 (c⁄° 
buf„r
 *
buf
,

800 
lök_sockë_öfo
 *
öfo
,

801 c⁄° 
lök_sockë_a˘uÆ
 *
a˘
,

802 c⁄° *
comm⁄_«me
,

803 
ív_£t
 *
es
)

805 i‡(!
buf
 || buf->
Àn
 > 0)

807 
lök_sockë_addr
 *
lß
 = 
öfo
->lsa;

810 (!
öfo
->
c⁄√˘i⁄_e°ablished


811 || !
	`addr_m©ch_¥Ÿo
 (&
a˘
->
de°
, &
lß
->
a˘uÆ
.de°, 
öfo
->
¥Ÿo
))

813 && (
öfo
->
ªmŸe_Êﬂt


814 || !
	`addr_deföed
 (&
lß
->
ªmŸe
)

815 || 
	`addr_m©ch_¥Ÿo
 (&
a˘
->
de°
, &
lß
->
ªmŸe
, 
öfo
->
¥Ÿo
))

818 
	`lök_sockë_c⁄√˘i⁄_öôüãd
 (
buf
, 
öfo
, 
a˘
, 
comm⁄_«me
, 
es
);

821 
	}
}

829 
°ªam_buf_öô
 (
°ªam_buf
 *
sb
,

830 
buf„r
 *
buf
,

831 c⁄° 
sockÊags
,

832 c⁄° 
¥Ÿo
);

834 
°ªam_buf_˛o£
 (
°ªam_buf
* 
sb
);

835 
boﬁ
 
°ªam_buf_added
 (
°ªam_buf
 *
sb
, 
Àngth_added
);

837 
ölöe
 
boﬁ


838 
	$°ªam_buf_ªad_£tup
 (
lök_sockë
* 
sock
)

840 
boﬁ
 
	`°ªam_buf_ªad_£tup_dow‹k
 (
lök_sockë
* 
sock
);

841 i‡(
	`lök_sockë_c⁄√˘i⁄_‹õ¡ed
 (
sock
))

842  
	`°ªam_buf_ªad_£tup_dow‹k
 (
sock
);

844  
åue
;

845 
	}
}

851 
lök_sockë_ªad_t˝
 (
lök_sockë
 *
sock
,

852 
buf„r
 *
buf
);

854 #ifde‡
WIN32


856 
ölöe
 

857 
	$lök_sockë_ªad_udp_wö32
 (
lök_sockë
 *
sock
,

858 
buf„r
 *
buf
,

859 
lök_sockë_a˘uÆ
 *
‰om
)

861  
	`sockë_föÆize
 (
sock
->
sd
, &sock->
ªads
, 
buf
, 
‰om
);

862 
	}
}

866 
lök_sockë_ªad_udp_posix
 (
lök_sockë
 *
sock
,

867 
buf„r
 *
buf
,

868 
maxsize
,

869 
lök_sockë_a˘uÆ
 *
‰om
);

874 
ölöe
 

875 
	$lök_sockë_ªad
 (
lök_sockë
 *
sock
,

876 
buf„r
 *
buf
,

877 
maxsize
,

878 
lök_sockë_a˘uÆ
 *
‰om
)

880 i‡(
	`¥Ÿo_is_udp
(
sock
->
öfo
.
¥Ÿo
))

882 
ªs
;

884 #ifde‡
WIN32


885 
ªs
 = 
	`lök_sockë_ªad_udp_wö32
 (
sock
, 
buf
, 
‰om
);

887 
ªs
 = 
	`lök_sockë_ªad_udp_posix
 (
sock
, 
buf
, 
maxsize
, 
‰om
);

889  
ªs
;

891 i‡(
	`¥Ÿo_is_t˝
(
sock
->
öfo
.
¥Ÿo
))

894 
	`addr_c›y_ß
(&
‰om
->
de°
, &
sock
->
öfo
.
lß
->
a˘uÆ
.dest);

895  
	`lök_sockë_ªad_t˝
 (
sock
, 
buf
);

899 
	`ASSERT
 (0);

902 
	}
}

908 
lök_sockë_wrôe_t˝
 (
lök_sockë
 *
sock
,

909 
buf„r
 *
buf
,

910 
lök_sockë_a˘uÆ
 *
to
);

912 #ifde‡
WIN32


914 
ölöe
 

915 
	$lök_sockë_wrôe_wö32
 (
lök_sockë
 *
sock
,

916 
buf„r
 *
buf
,

917 
lök_sockë_a˘uÆ
 *
to
)

919 
îr
 = 0;

920 
°©us
 = 0;

921 i‡(
	`ovîœµed_io_a˘ive
 (&
sock
->
wrôes
))

923 
°©us
 = 
	`sockë_föÆize
 (
sock
->
sd
, &sock->
wrôes
, 
NULL
, NULL);

924 i‡(
°©us
 < 0)

925 
îr
 = 
	`WSAGëLa°Eº‹
 ();

927 
	`sockë_£nd_queue
 (
sock
, 
buf
, 
to
);

928 i‡(
°©us
 < 0)

930 
	`WSASëLa°Eº‹
 (
îr
);

931  
°©us
;

934  
	`BLEN
 (
buf
);

935 
	}
}

939 
ölöe
 

940 
	$lök_sockë_wrôe_udp_posix
 (
lök_sockë
 *
sock
,

941 
buf„r
 *
buf
,

942 
lök_sockë_a˘uÆ
 *
to
)

944 #i‡
ENABLE_IP_PKTINFO


945 
	`lök_sockë_wrôe_udp_posix_£ndmsg
 (
lök_sockë
 *
sock
,

946 
buf„r
 *
buf
,

947 
lök_sockë_a˘uÆ
 *
to
);

949 i‡(
	`¥Ÿo_is_udp
(
sock
->
öfo
.
¥Ÿo
Ë&& (sock->
sockÊags
 & 
SF_USE_IP_PKTINFO
)

950 && 
	`addr_deföed_ùi
(
to
))

951  
	`lök_sockë_wrôe_udp_posix_£ndmsg
 (
sock
, 
buf
, 
to
);

954  
	`£ndto
 (
sock
->
sd
, 
	`BPTR
 (
buf
), 
	`BLEN
 (buf), 0,

955 (
sockaddr
 *Ë&
to
->
de°
.
addr
.
ß
,

956 (
sockÀn_t
Ë
	`af_addr_size
(
to
->
de°
.
addr
.
ß
.
ß_Ámûy
));

957 
	}
}

959 
ölöe
 

960 
	$lök_sockë_wrôe_t˝_posix
 (
lök_sockë
 *
sock
,

961 
buf„r
 *
buf
,

962 
lök_sockë_a˘uÆ
 *
to
)

964  
	`£nd
 (
sock
->
sd
, 
	`BPTR
 (
buf
), 
	`BLEN
 (buf), 
MSG_NOSIGNAL
);

965 
	}
}

969 
ölöe
 

970 
	$lök_sockë_wrôe_udp
 (
lök_sockë
 *
sock
,

971 
buf„r
 *
buf
,

972 
lök_sockë_a˘uÆ
 *
to
)

974 #ifde‡
WIN32


975  
	`lök_sockë_wrôe_wö32
 (
sock
, 
buf
, 
to
);

977  
	`lök_sockë_wrôe_udp_posix
 (
sock
, 
buf
, 
to
);

979 
	}
}

982 
ölöe
 

983 
	$lök_sockë_wrôe
 (
lök_sockë
 *
sock
,

984 
buf„r
 *
buf
,

985 
lök_sockë_a˘uÆ
 *
to
)

987 i‡(
	`¥Ÿo_is_udp
(
sock
->
öfo
.
¥Ÿo
))

989  
	`lök_sockë_wrôe_udp
 (
sock
, 
buf
, 
to
);

991 i‡(
	`¥Ÿo_is_t˝
(
sock
->
öfo
.
¥Ÿo
))

993  
	`lök_sockë_wrôe_t˝
 (
sock
, 
buf
, 
to
);

997 
	`ASSERT
 (0);

1000 
	}
}

1002 #i‡
PASSTOS_CAPABILITY


1007 
ölöe
 

1008 
	$lök_sockë_exåa˘_tos
 (
lök_sockë
 *
ls
, c⁄° 
buf„r
 *
ùbuf
)

1010 i‡(
ls
 && 
ùbuf
)

1012 
›ív≤_ùhdr
 *
ùh
 = (›ív≤_ùhd∏*Ë
	`BPTR
 (
ùbuf
);

1013 
ls
->
±os
 = 
ùh
->
tos
;

1014 
ls
->
±os_deföed
 = 
åue
;

1016 
	}
}

1022 
ölöe
 

1023 
	$lök_sockë_£t_tos
 (
lök_sockë
 *
ls
)

1025 i‡(
ls
 &&Üs->
±os_deföed
)

1026 
	`£tsock›t
 (
ls
->
sd
, 
IPPROTO_IP
, 
IP_TOS
, (c⁄° *)&ls->
±os
,  (ls->ptos));

1027 
	}
}

1035 
ölöe
 
boﬁ


1036 
	$sockë_ªad_ªsiduÆ
 (c⁄° 
lök_sockë
 *
s
)

1038  
s
 && s->
°ªam_buf
.
ªsiduÆ_fuŒy_f‹med
;

1039 
	}
}

1041 
ölöe
 
evít_t


1042 
	$sockë_evít_h™dÀ
 (c⁄° 
lök_sockë
 *
s
)

1044 #ifde‡
WIN32


1045  &
s
->
rw_h™dÀ
;

1047  
s
->
sd
;

1049 
	}
}

1051 
evít_t
 
sockë_li°í_evít_h™dÀ
 (
lök_sockë
 *
s
);

1054 
sockë_£t
 (
lök_sockë
 *
s
,

1055 
evít_£t
 *
es
,

1056 
rwÊags
,

1057 *
¨g
,

1058 *
≥rsi°ít
);

1060 
ölöe
 

1061 
	$sockë_£t_li°í_≥rsi°ít
 (
lök_sockë
 *
s
,

1062 
evít_£t
 *
es
,

1063 *
¨g
)

1065 i‡(
s
 && !s->
li°í_≥rsi°ít_queued
)

1067 
	`evít_˘l
 (
es
, 
	`sockë_li°í_evít_h™dÀ
 (
s
), 
EVENT_READ
, 
¨g
);

1068 
s
->
li°í_≥rsi°ít_queued
 = 
åue
;

1070 
	}
}

1072 
ölöe
 

1073 
	$sockë_ª£t_li°í_≥rsi°ít
 (
lök_sockë
 *
s
)

1075 #ifde‡
WIN32


1076 
	`ª£t_√t_evít_wö32
 (&
s
->
li°í_h™dÀ
, s->
sd
);

1078 
	}
}

1080 c⁄° *
sockë_°©
 (c⁄° 
lök_sockë
 *
s
, 
rwÊags
, 
gc_¨ía
 *
gc
);

	@src/openvpn/socks.c

33 #ifde‡
HAVE_CONFIG_H


34 
	~"c⁄fig.h
"

35 #ñi‡
deföed
(
_MSC_VER
)

36 
	~"c⁄fig-msvc.h
"

39 
	~"syshód.h
"

41 #ifde‡
ENABLE_SOCKS


43 
	~"comm⁄.h
"

44 
	~"misc.h
"

45 
	~"wö32.h
"

46 
	~"sockë.h
"

47 
	~"fdmisc.h
"

48 
	~"misc.h
"

49 
	~"¥oxy.h
"

51 
	~"memdbg.h
"

53 
	#UP_TYPE_SOCKS
 "SOCKS Proxy"

	)

56 
	$socks_adju°_‰ame_∑ømëîs
 (
‰ame
 *‰ame, 
¥Ÿo
)

58 i‡(
¥Ÿo
 =
PROTO_UDPv4
)

59 
	`‰ame_add_to_exåa_lök
 (
‰ame
, 10);

60 
	}
}

62 
socks_¥oxy_öfo
 *

63 
	$socks_¥oxy_√w
 (c⁄° *
£rvî
,

64 
p‹t
,

65 c⁄° *
authfûe
,

66 
boﬁ
 
ªåy
)

68 
socks_¥oxy_öfo
 *
p
;

70 
	`ALLOC_OBJ_CLEAR
 (
p
, 
socks_¥oxy_öfo
);

72 
	`ASSERT
 (
£rvî
);

73 
	`ASSERT
 (
	`ÀgÆ_ùv4_p‹t
 (
p‹t
));

75 
	`°∫˝y¡
 (
p
->
£rvî
, server,  (p->server));

76 
p
->
p‹t
 =Öort;

78 i‡(
authfûe
)

79 
	`°∫˝y¡
 (
p
->
authfûe
,áuthfile,  (p->authfile));

81 
p
->
authfûe
[0] = 0;

83 
p
->
ªåy
 =Ñetry;

84 
p
->
deföed
 = 
åue
;

86  
p
;

87 
	}
}

90 
	$socks_¥oxy_˛o£
 (
socks_¥oxy_öfo
 *
•
)

92 
	`‰ì
 (
•
);

93 
	}
}

95 
boﬁ


96 
	$socks_u£∫ame_∑ssw‹d_auth
 (
socks_¥oxy_öfo
 *
p
,

97 
sockë_des¸ùt‹_t
 
sd
,

98 vﬁ©ûê*
sig«l_ª˚ived
)

100 
to_£nd
[516];

101 
buf
[2];

102 
Àn
 = 0;

103 c⁄° 
timeout_£c
 = 5;

104 
u£r_∑ss
 
¸eds
;

105 
ssize_t
 
size
;

107 
¸eds
.
deföed
 = 0;

108 
	`gë_u£r_∑ss
 (&
¸eds
, 
p
->
authfûe
, 
UP_TYPE_SOCKS
, 
GET_USER_PASS_MANAGEMENT
);

110 if–!
¸eds
.
u£∫ame
 || (
	`°æí
(creds.username) > 255)

111 || !
¸eds
.
∑ssw‹d
 || (
	`°æí
(creds.password) > 255) ) {

112 
	`msg
 (
M_NONFATAL
,

115  
Ál£
;

117 
	`›ív≤_¢¥ötf
 (
to_£nd
,  (to_£nd), "\x01%c%s%c%s", (Ë
	`°æí
(
¸eds
.
u£∫ame
),

118 
¸eds
.
u£∫ame
, (Ë
	`°æí
(¸eds.
∑ssw‹d
), creds.password);

119 
size
 = 
	`£nd
 (
sd
, 
to_£nd
, 
	`°æí
—o_£nd), 
MSG_NOSIGNAL
);

121 i‡(
size
 !
	`°æí
 (
to_£nd
))

123 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_username_password_auth: TCPÖort write failed on send()");

124  
Ál£
;

127 
Àn
 < 2)

129 
°©us
;

130 
ssize_t
 
size
;

131 
fd_£t
 
ªads
;

132 
timevÆ
 
tv
;

133 
c
;

135 
	`FD_ZERO
 (&
ªads
);

136 
	`FD_SET
 (
sd
, &
ªads
);

137 
tv
.
tv_£c
 = 
timeout_£c
;

138 
tv
.
tv_u£c
 = 0;

140 
°©us
 = 
	`£À˘
 (
sd
 + 1, &
ªads
, 
NULL
, NULL, &
tv
);

142 
	`gë_sig«l
 (
sig«l_ª˚ived
);

143 i‡(*
sig«l_ª˚ived
)

144  
Ál£
;

147 i‡(
°©us
 == 0)

149 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_username_password_auth: TCPÖortÑeadÅimeoutÉxpired");

150  
Ál£
;

154 i‡(
°©us
 < 0)

156 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_username_password_auth: TCPÖortÑead failed on select()");

157  
Ál£
;

161 
size
 = 
	`ªcv
(
sd
, &
c
, 1, 
MSG_NOSIGNAL
);

164 i‡(
size
 != 1)

166 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_username_password_auth: TCPÖortÑead failed onÑecv()");

167  
Ál£
;

171 
buf
[
Àn
++] = 
c
;

175 i‡(
buf
[0] != 5 && buf[1] != 0)

177 
	`msg
 (
D_LINK_ERRORS
, "socks_username_password_auth: serverÑefusedÅheáuthentication");

178  
Ál£
;

181  
åue
;

182 
	}
}

184 
boﬁ


185 
	$socks_h™dshake
 (
socks_¥oxy_öfo
 *
p
,

186 
sockë_des¸ùt‹_t
 
sd
,

187 vﬁ©ûê*
sig«l_ª˚ived
)

189 
buf
[2];

190 
Àn
 = 0;

191 c⁄° 
timeout_£c
 = 5;

192 
ssize_t
 
size
;

195 
mëhod_£l
[3] = { 0x05, 0x01, 0x00 };

196 i‡(
p
->
authfûe
[0])

197 
mëhod_£l
[2] = 0x02;

199 
size
 = 
	`£nd
 (
sd
, 
mëhod_£l
,  (mëhod_£l), 
MSG_NOSIGNAL
);

200 i‡(
size
 ! (
mëhod_£l
))

202 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_handshake: TCPÖort write failed on send()");

203  
Ál£
;

206 
Àn
 < 2)

208 
°©us
;

209 
ssize_t
 
size
;

210 
fd_£t
 
ªads
;

211 
timevÆ
 
tv
;

212 
c
;

214 
	`FD_ZERO
 (&
ªads
);

215 
	`FD_SET
 (
sd
, &
ªads
);

216 
tv
.
tv_£c
 = 
timeout_£c
;

217 
tv
.
tv_u£c
 = 0;

219 
°©us
 = 
	`£À˘
 (
sd
 + 1, &
ªads
, 
NULL
, NULL, &
tv
);

221 
	`gë_sig«l
 (
sig«l_ª˚ived
);

222 i‡(*
sig«l_ª˚ived
)

223  
Ál£
;

226 i‡(
°©us
 == 0)

228 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_handshake: TCPÖortÑeadÅimeoutÉxpired");

229  
Ál£
;

233 i‡(
°©us
 < 0)

235 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_handshake: TCPÖortÑead failed on select()");

236  
Ál£
;

240 
size
 = 
	`ªcv
(
sd
, &
c
, 1, 
MSG_NOSIGNAL
);

243 i‡(
size
 != 1)

245 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_handshake: TCPÖortÑead failed onÑecv()");

246  
Ál£
;

250 
buf
[
Àn
++] = 
c
;

254 i‡(
buf
[0] != '\x05')

256 
	`msg
 (
D_LINK_ERRORS
, "socks_handshake: SocksÖroxyÑeturned bad status");

257  
Ál£
;

261 i‡(
buf
[1] !
mëhod_£l
[2])

263 
	`msg
 (
D_LINK_ERRORS
, "socks_handshake: SocksÖroxyÑeturned unexpectedáuth");

264  
Ál£
;

268 
buf
[1])

274 i‡(!
p
->
authfûe
[0])

276 
	`msg
(
D_LINK_ERRORS
, "socks_handshake: serverásked for username/logináuth but we were "

278  
Ál£
;

281 i‡(!
	`socks_u£∫ame_∑ssw‹d_auth
(
p
, 
sd
, 
sig«l_ª˚ived
))

282  
Ál£
;

287 
	`msg
(
D_LINK_ERRORS
, "socks_handshake: unknown SOCKSáuth method");

288  
Ál£
;

291  
åue
;

292 
	}
}

294 
boﬁ


295 
	$ªcv_socks_ª∂y
 (
sockë_des¸ùt‹_t
 
sd
,

296 
›ív≤_sockaddr
 *
addr
,

297 vﬁ©ûê*
sig«l_ª˚ived
)

299 
©yp
 = '\0';

300 
Æí
 = 0;

301 
Àn
 = 0;

302 
buf
[22];

303 c⁄° 
timeout_£c
 = 5;

305 i‡(
addr
 !
NULL
)

307 
addr
->addr.
ö4
.
sö_Ámûy
 = 
AF_INET
;

308 
addr
->addr.
ö4
.
sö_addr
.
s_addr
 = 
	`ht⁄l
 (
INADDR_ANY
);

309 
addr
->addr.
ö4
.
sö_p‹t
 = 
	`ht⁄s
 (0);

312 
Àn
 < 4 + 
Æí
 + 2)

314 
°©us
;

315 
ssize_t
 
size
;

316 
fd_£t
 
ªads
;

317 
timevÆ
 
tv
;

318 
c
;

320 
	`FD_ZERO
 (&
ªads
);

321 
	`FD_SET
 (
sd
, &
ªads
);

322 
tv
.
tv_£c
 = 
timeout_£c
;

323 
tv
.
tv_u£c
 = 0;

325 
°©us
 = 
	`£À˘
 (
sd
 + 1, &
ªads
, 
NULL
, NULL, &
tv
);

327 
	`gë_sig«l
 (
sig«l_ª˚ived
);

328 i‡(*
sig«l_ª˚ived
)

329  
Ál£
;

332 i‡(
°©us
 == 0)

334 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "recv_socks_reply: TCPÖortÑeadÅimeoutÉxpired");

335  
Ál£
;

339 i‡(
°©us
 < 0)

341 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "recv_socks_reply: TCPÖortÑead failed on select()");

342  
Ál£
;

346 
size
 = 
	`ªcv
(
sd
, &
c
, 1, 
MSG_NOSIGNAL
);

349 i‡(
size
 != 1)

351 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "recv_socks_reply: TCPÖortÑead failed onÑecv()");

352  
Ál£
;

355 i‡(
Àn
 == 3)

356 
©yp
 = 
c
;

358 i‡(
Àn
 == 4)

360 
©yp
)

363 
Æí
 = 4;

367 
Æí
 = (Ë
c
;

371 
Æí
 = 16;

375 
	`msg
 (
D_LINK_ERRORS
, "recv_socks_reply: SocksÖroxyÑeturned badáddressÅype");

376  
Ál£
;

381 i‡(
Àn
 < ()(
buf
))

382 
buf
[
Àn
] = 
c
;

383 ++
Àn
;

387 i‡(
buf
[0] != '\x05' || buf[1] != '\x00')

389 
	`msg
 (
D_LINK_ERRORS
, "recv_socks_reply: SocksÖroxyÑeturned badÑeply");

390  
Ál£
;

394 i‡(
©yp
 ='\x01' && 
addr
 !
NULL
)

396 
	`mem˝y
 (&
addr
->addr.
ö4
.
sö_addr
, 
buf
 + 4,  (addr->addr.in4.sin_addr));

397 
	`mem˝y
 (&
addr
->addr.
ö4
.
sö_p‹t
, 
buf
 + 8,  (addr->addr.in4.sin_port));

401  
åue
;

402 
	}
}

405 
	$e°ablish_socks_¥oxy_∑s°hru
 (
socks_¥oxy_öfo
 *
p
,

406 
sockë_des¸ùt‹_t
 
sd
,

407 c⁄° *
ho°
,

408 c⁄° 
p‹t
,

409 vﬁ©ûê*
sig«l_ª˚ived
)

411 
buf
[128];

412 
size_t
 
Àn
;

414 i‡(!
	`socks_h™dshake
 (
p
, 
sd
, 
sig«l_ª˚ived
))

415 
îr‹
;

418 
buf
[0] = '\x05';

419 
buf
[1] = '\x01';

420 
buf
[2] = '\x00';

421 
buf
[3] = '\x03';

423 
Àn
 = 
	`°æí
(
ho°
);

424 
Àn
 = (5 +Üí + 2 > (
buf
)) ? ((buf) - 5 - 2) :Üen;

426 
buf
[4] = (Ë
Àn
;

427 
	`mem˝y
(
buf
 + 5, 
ho°
, 
Àn
);

429 
buf
[5 + 
Àn
] = (Ë(
p‹t
 >> 8);

430 
buf
[5 + 
Àn
 + 1] = (Ë(
p‹t
 & 0xff);

433 c⁄° 
ssize_t
 
size
 = 
	`£nd
 (
sd
, 
buf
, 5 + 
Àn
 + 2, 
MSG_NOSIGNAL
);

434 i‡(()
size
 !5 + ()
Àn
 + 2)

436 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "establish_socks_proxy_passthru: TCPÖort write failed on send()");

437 
îr‹
;

442 i‡(!
	`ªcv_socks_ª∂y
 (
sd
, 
NULL
, 
sig«l_ª˚ived
))

443 
îr‹
;

447 
îr‹
:

449 i‡(!*
sig«l_ª˚ived
)

450 *
sig«l_ª˚ived
 = (
p
->
ªåy
 ? 
SIGUSR1
 : 
SIGTERM
);

452 
	}
}

455 
	$e°ablish_socks_¥oxy_ud∑ssoc
 (
socks_¥oxy_öfo
 *
p
,

456 
sockë_des¸ùt‹_t
 
˘æ_sd
,

457 
sockë_des¸ùt‹_t
 
udp_sd
,

458 
›ív≤_sockaddr
 *
ªœy_addr
,

459 vﬁ©ûê*
sig«l_ª˚ived
)

461 i‡(!
	`socks_h™dshake
 (
p
, 
˘æ_sd
, 
sig«l_ª˚ived
))

462 
îr‹
;

468 c⁄° 
ssize_t
 
size
 = 
	`£nd
 (
˘æ_sd
,

470 10, 
MSG_NOSIGNAL
);

471 i‡(
size
 != 10)

473 
	`msg
 (
D_LINK_ERRORS
 | 
M_ERRNO
, "establish_socks_proxy_passthru: TCPÖort write failed on send()");

474 
îr‹
;

479 
	`CLEAR
 (*
ªœy_addr
);

480 i‡(!
	`ªcv_socks_ª∂y
 (
˘æ_sd
, 
ªœy_addr
, 
sig«l_ª˚ived
))

481 
îr‹
;

485 
îr‹
:

487 i‡(!*
sig«l_ª˚ived
)

488 *
sig«l_ª˚ived
 = (
p
->
ªåy
 ? 
SIGUSR1
 : 
SIGTERM
);

490 
	}
}

499 
	$socks_¥o˚ss_öcomög_udp
 (
buf„r
 *
buf
,

500 
lök_sockë_a˘uÆ
 *
‰om
)

502 
©yp
;

504 i‡(
	`BLEN
 (
buf
) < 10)

505 
îr‹
;

507 
	`buf_ªad_u16
 (
buf
);

508 i‡(
	`buf_ªad_u8
 (
buf
) != 0)

509 
îr‹
;

511 
©yp
 = 
	`buf_ªad_u8
 (
buf
);

512 i‡(
©yp
 != 1)

513 
îr‹
;

515 
	`buf_ªad
 (
buf
, &
‰om
->
de°
.
addr
.
ö4
.
sö_addr
,  (from->dest.addr.in4.sin_addr));

516 
	`buf_ªad
 (
buf
, &
‰om
->
de°
.
addr
.
ö4
.
sö_p‹t
,  (from->dest.addr.in4.sin_port));

520 
îr‹
:

521 
buf
->
Àn
 = 0;

522 
	}
}

532 
	$socks_¥o˚ss_outgoög_udp
 (
buf„r
 *
buf
,

533 c⁄° 
lök_sockë_a˘uÆ
 *
to
)

540 
buf„r
 
hód
 = 
	`buf_sub
 (
buf
, 10, 
åue
);

543 
	`ASSERT
 (
	`buf_deföed
 (&
hód
));

545 
	`buf_wrôe_u16
 (&
hód
, 0);

546 
	`buf_wrôe_u8
 (&
hód
, 0);

547 
	`buf_wrôe_u8
 (&
hód
, '\x01');

548 
	`buf_wrôe
 (&
hód
, &
to
->
de°
.
addr
.
ö4
.
sö_addr
,  (to->dest.addr.in4.sin_addr));

549 
	`buf_wrôe
 (&
hód
, &
to
->
de°
.
addr
.
ö4
.
sö_p‹t
,  (to->dest.addr.in4.sin_port));

552 
	}
}

555 
	$dummy
(Ë{
	}
}

	@src/openvpn/socks.h

30 #i‚de‡
SOCKS_H


31 
	#SOCKS_H


	)

33 #ifde‡
ENABLE_SOCKS


35 
	~"buf„r.h
"

37 
	g›ív≤_sockaddr
;

38 
	glök_sockë_a˘uÆ
;

40 
	ssocks_¥oxy_öfo
 {

41 
boﬁ
 
	mdeföed
;

42 
boﬁ
 
	mªåy
;

44 
	m£rvî
[128];

45 
	mp‹t
;

46 
	mauthfûe
[256];

49 
socks_adju°_‰ame_∑ømëîs
 (
‰ame
 *‰ame, 
¥Ÿo
);

51 
socks_¥oxy_öfo
 *
socks_¥oxy_√w
 (c⁄° *
£rvî
,

52 
p‹t
,

53 c⁄° *
authfûe
,

54 
boﬁ
 
ªåy
);

56 
socks_¥oxy_˛o£
 (
socks_¥oxy_öfo
 *
•
);

58 
e°ablish_socks_¥oxy_∑s°hru
 (
socks_¥oxy_öfo
 *
p
,

59 
sockë_des¸ùt‹_t
 
sd
,

60 c⁄° *
ho°
,

61 c⁄° 
p‹t
,

62 vﬁ©ûê*
sig«l_ª˚ived
);

64 
e°ablish_socks_¥oxy_ud∑ssoc
 (
socks_¥oxy_öfo
 *
p
,

65 
sockë_des¸ùt‹_t
 
˘æ_sd
,

66 
sockë_des¸ùt‹_t
 
udp_sd
,

67 
›ív≤_sockaddr
 *
ªœy_addr
,

68 vﬁ©ûê*
sig«l_ª˚ived
);

70 
socks_¥o˚ss_öcomög_udp
 (
buf„r
 *
buf
,

71 
lök_sockë_a˘uÆ
 *
‰om
);

73 
socks_¥o˚ss_outgoög_udp
 (
buf„r
 *
buf
,

74 c⁄° 
lök_sockë_a˘uÆ
 *
to
);

	@src/openvpn/ssl.c

39 #ifde‡
HAVE_CONFIG_H


40 
	~"c⁄fig.h
"

41 #ñi‡
deföed
(
_MSC_VER
)

42 
	~"c⁄fig-msvc.h
"

45 
	~"syshód.h
"

47 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

49 
	~"îr‹.h
"

50 
	~"comm⁄.h
"

51 
	~"öãgî.h
"

52 
	~"sockë.h
"

53 
	~"misc.h
"

54 
	~"fdmisc.h
"

55 
	~"öãrvÆ.h
"

56 
	~"≥rf.h
"

57 
	~"°©us.h
"

58 
	~"gªmlö.h
"

59 
	~"pkcs11.h
"

60 
	~"li°.h
"

61 
	~"ba£64.h
"

62 
	~"rouã.h
"

64 
	~"s¶.h
"

65 
	~"s¶_vîify.h
"

66 
	~"s¶_backíd.h
"

68 
	~"memdbg.h
"

70 #i‚de‡
ENABLE_OCC


71 c⁄° 
	gs¶_deÁu…_›ti⁄s_°rög
[] = "V0 UNDEF";

74 
ölöe
 const *

75 
	$loˇl_›ti⁄s_°rög
 (c⁄° 
és_£ssi⁄
 *
£ssi⁄
)

77 #ifde‡
ENABLE_OCC


78  
£ssi⁄
->
›t
->
loˇl_›ti⁄s
;

80  
s¶_deÁu…_›ti⁄s_°rög
;

82 
	}
}

84 #ifde‡
MEASURE_TLS_HANDSHAKE_STATS


86 
	gés_h™dshake_suc˚ss
;

87 
	gés_h™dshake_îr‹
;

88 
	gés_∑ckës_gíî©ed
;

89 
	gés_∑ckës_£¡
;

91 
	#INCR_SENT
 ++
és_∑ckës_£¡


	)

92 
	#INCR_GENERATED
 ++
és_∑ckës_gíî©ed


	)

93 
	#INCR_SUCCESS
 ++
és_h™dshake_suc˚ss


	)

94 
	#INCR_ERROR
 ++
és_h™dshake_îr‹


	)

97 
	$show_és_≥rf‹m™˚_°©s
()

99 
	`msg
 (
D_TLS_DEBUG_LOW
, "TLS Handshakes, success=%f%% (good=%d, bad=%d),Ñetransmits=%f%%",

100 (Ë
és_h™dshake_suc˚ss
 / (és_h™dshake_suc˚s†+ 
és_h™dshake_îr‹
) * 100.0,

101 
és_h™dshake_suc˚ss
, 
és_h™dshake_îr‹
,

102 (Ë(
és_∑ckës_£¡
 - 
és_∑ckës_gíî©ed
) /Åls_packets_generated * 100.0);

103 
	}
}

106 
	#INCR_SENT


	)

107 
	#INCR_GENERATED


	)

108 
	#INCR_SUCCESS


	)

109 
	#INCR_ERROR


	)

116 c⁄° 
és_cùhî_«me_∑ú
 
	gés_cùhî_«me_å™¶©i⁄_èbÀ
[] = {

238 #ifde‡
ENABLE_CRYPTO_OPENSSL


251 {
NULL
, NULL}

254 c⁄° 
és_cùhî_«me_∑ú
 *

255 
	$és_gë_cùhî_«me_∑ú
 (c⁄° * 
cùhî_«me
, 
size_t
 
Àn
) {

256 c⁄° 
és_cùhî_«me_∑ú
 * 
∑ú
 = 
és_cùhî_«me_å™¶©i⁄_èbÀ
;

258 
∑ú
->
›ís¶_«me
 !
NULL
) {

259 i‡((
	`°æí
(
∑ú
->
›ís¶_«me
Ë=
Àn
 && 0 =
	`memcmp
 (
cùhî_«me
,Öair->openssl_name,Üen)) ||

260 (
	`°æí
(
∑ú
->
ü«_«me
Ë=
Àn
 && 0 =
	`memcmp
 (
cùhî_«me
,Öair->iana_name,Üen))) {

261  
∑ú
;

263 
∑ú
++;

267  
NULL
;

268 
	}
}

277 
	$és_adju°_‰ame_∑ømëîs
(
‰ame
 *frame)

279 
	`‰ame_add_to_exåa_‰ame
 (
‰ame
, 1);

280 
	}
}

287 
	$és_öô_c⁄åﬁ_ch™√l_‰ame_∑ømëîs
(c⁄° 
‰ame
 *
d©a_ch™√l_‰ame
,

288 
‰ame
 *frame)

296 
‰ame
->
lök_mtu
 = 
d©a_ch™√l_‰ame
->link_mtu;

297 
‰ame
->
exåa_lök
 = 
d©a_ch™√l_‰ame
->extra_link;

300 
	`és_adju°_‰ame_∑ømëîs
 (
‰ame
);

301 
	`ªlübÀ_ack_adju°_‰ame_∑ømëîs
 (
‰ame
, 
CONTROL_SEND_ACK_MAX
);

302 
	`‰ame_add_to_exåa_‰ame
 (
‰ame
, 
SID_SIZE
 +  (
∑ckë_id_ty≥
));

305 
	`‰ame_£t_mtu_dy«mic
 (
‰ame
, 0, 
SET_MTU_TUN
);

306 
	}
}

309 
	$öô_s¶_lib
 ()

311 
	`és_öô_lib
 ();

313 
	`¸y±o_öô_lib
 ();

314 
	}
}

317 
	$‰ì_s¶_lib
 ()

319 
	`¸y±o_unöô_lib
 ();

320 
	`¥ng_unöô
();

322 
	`és_‰ì_lib
();

323 
	}
}

330 
u£r_∑ss
 
	g∑ssbuf
;

333 
	$≥m_∑ssw‹d_£tup
 (c⁄° *
auth_fûe
)

335 i‡(!
	`°æí
 (
∑ssbuf
.
∑ssw‹d
))

336 
	`gë_u£r_∑ss
 (&
∑ssbuf
, 
auth_fûe
, 
UP_TYPE_PRIVATE_KEY
, 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_SENSITIVE
|
GET_USER_PASS_PASSWORD_ONLY
);

337 
	}
}

340 
	$≥m_∑ssw‹d_ˇŒback
 (*
buf
, 
size
, 
rwÊag
, *
u
)

342 i‡(
buf
)

345 
	`≥m_∑ssw‹d_£tup
 (
NULL
);

346 
	`°∫˝y¡
 (
buf
, 
∑ssbuf
.
∑ssw‹d
, 
size
);

347 
	`purge_u£r_∑ss
 (&
∑ssbuf
, 
Ál£
);

349  
	`°æí
 (
buf
);

352 
	}
}

358 
boﬁ
 
	gauth_u£r_∑ss_íabÀd
;

359 
u£r_∑ss
 
	gauth_u£r_∑ss
;

361 #ifde‡
ENABLE_CLIENT_CR


362 *
	gauth_chÆÀnge
;

366 
	$auth_u£r_∑ss_£tup
 (c⁄° *
auth_fûe
, c⁄° 
°©ic_chÆÀnge_öfo
 *
sci
)

368 
auth_u£r_∑ss_íabÀd
 = 
åue
;

369 i‡(!
auth_u£r_∑ss
.
deföed
)

371 #i‡
AUTO_USERID


372 
	`gë_u£r_∑ss_auto_u£rid
 (&
auth_u£r_∑ss
, 
auth_fûe
);

374 #ifde‡
ENABLE_CLIENT_CR


375 i‡(
auth_chÆÀnge
)

376 
	`gë_u£r_∑ss_¸
 (&
auth_u£r_∑ss
,

377 
auth_fûe
,

378 
UP_TYPE_AUTH
,

379 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_SENSITIVE
|
GET_USER_PASS_DYNAMIC_CHALLENGE
,

380 
auth_chÆÀnge
);

381 i‡(
sci
)

383 
Êags
 = 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_SENSITIVE
|
GET_USER_PASS_STATIC_CHALLENGE
;

384 i‡(
sci
->
Êags
 & 
SC_ECHO
)

385 
Êags
 |
GET_USER_PASS_STATIC_CHALLENGE_ECHO
;

386 
	`gë_u£r_∑ss_¸
 (&
auth_u£r_∑ss
,

387 
auth_fûe
,

388 
UP_TYPE_AUTH
,

389 
Êags
,

390 
sci
->
chÆÀnge_ãxt
);

394 
	`gë_u£r_∑ss
 (&
auth_u£r_∑ss
, 
auth_fûe
, 
UP_TYPE_AUTH
, 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_SENSITIVE
);

397 
	}
}

403 
	$s¶_£t_auth_noˇche
 ()

405 
∑ssbuf
.
noˇche
 = 
åue
;

406 
auth_u£r_∑ss
.
noˇche
 = 
åue
;

407 
	}
}

413 
	$s¶_£t_auth_tokí
 (c⁄° *
tokí
)

415 
	`£t_auth_tokí
 (&
auth_u£r_∑ss
, 
tokí
);

416 
	}
}

422 
	$s¶_purge_auth
 (c⁄° 
boﬁ
 
auth_u£r_∑ss_⁄ly
)

424 i‡(!
auth_u£r_∑ss_⁄ly
)

426 #ifde‡
ENABLE_PKCS11


427 
	`pkcs11_logout
 ();

429 
	`purge_u£r_∑ss
 (&
∑ssbuf
, 
åue
);

431 
	`purge_u£r_∑ss
 (&
auth_u£r_∑ss
, 
åue
);

432 #ifde‡
ENABLE_CLIENT_CR


433 
	`s¶_purge_auth_chÆÀnge
();

435 
	}
}

437 #ifde‡
ENABLE_CLIENT_CR


440 
	$s¶_purge_auth_chÆÀnge
 ()

442 
	`‰ì
 (
auth_chÆÀnge
);

443 
auth_chÆÀnge
 = 
NULL
;

444 
	}
}

447 
	$s¶_put_auth_chÆÀnge
 (c⁄° *
¸_°r
)

449 
	`s¶_purge_auth_chÆÀnge
();

450 
auth_chÆÀnge
 = 
	`°rög_Æloc
(
¸_°r
, 
NULL
);

451 
	}
}

461 
	$és_vîsi⁄_∑r£
(c⁄° *
v°r
, c⁄° *
exåa
)

463 c⁄° 
max_vîsi⁄
 = 
	`és_vîsi⁄_max
();

464 i‡(!
	`°rcmp
(
v°r
, "1.0"Ë&& 
TLS_VER_1_0
 <
max_vîsi⁄
)

465  
TLS_VER_1_0
;

466 i‡(!
	`°rcmp
(
v°r
, "1.1"Ë&& 
TLS_VER_1_1
 <
max_vîsi⁄
)

467  
TLS_VER_1_1
;

468 i‡(!
	`°rcmp
(
v°r
, "1.2"Ë&& 
TLS_VER_1_2
 <
max_vîsi⁄
)

469  
TLS_VER_1_2
;

470 i‡(
exåa
 && !
	`°rcmp
(extra, "or-highest"))

471  
max_vîsi⁄
;

473  
TLS_VER_BAD
;

474 
	}
}

481 
	$öô_s¶
 (c⁄° 
›ti⁄s
 *›ti⁄s, 
és_roŸ_˘x
 *
√w_˘x
)

483 
	`ASSERT
(
NULL
 !
√w_˘x
);

485 
	`és_˛ór_îr‹
();

487 i‡(
›ti⁄s
->
és_£rvî
)

489 
	`és_˘x_£rvî_√w
(
√w_˘x
, 
›ti⁄s
->
s¶_Êags
);

490 
	`és_˘x_lﬂd_dh_∑øms
(
√w_˘x
, 
›ti⁄s
->
dh_fûe
, o±i⁄s->
dh_fûe_ölöe
);

494 
	`és_˘x_˛õ¡_√w
(
√w_˘x
, 
›ti⁄s
->
s¶_Êags
);

497 
	`és_˘x_£t_›ti⁄s
(
√w_˘x
, 
›ti⁄s
->
s¶_Êags
);

499 i‡(
›ti⁄s
->
pkcs12_fûe
)

501 i‡(0 !
	`és_˘x_lﬂd_pkcs12
(
√w_˘x
, 
›ti⁄s
->
pkcs12_fûe
,

502 
›ti⁄s
->
pkcs12_fûe_ölöe
, !›ti⁄s->
ˇ_fûe
))

503 
îr
;

505 #ifde‡
ENABLE_PKCS11


506 i‡(
›ti⁄s
->
pkcs11_¥ovidîs
[0])

508 i‡(!
	`és_˘x_u£_pkcs11
 (
√w_˘x
, 
›ti⁄s
->
pkcs11_id_m™agemít
, o±i⁄s->
pkcs11_id
))

510 
	`msg
 (
M_WARN
, "CannotÜoad certificate \"%s\" using PKCS#11 interface",

511 
›ti⁄s
->
pkcs11_id
);

512 
îr
;

516 #ifde‡
ENABLE_CRYPTOAPI


517 i‡(
›ti⁄s
->
¸y±ﬂpi_˚π
)

519 
	`és_˘x_lﬂd_¸y±ﬂpi
(
√w_˘x
, 
›ti⁄s
->
¸y±ﬂpi_˚π
);

522 #ifde‡
MANAGMENT_EXTERNAL_KEY


523 i‡((
›ti⁄s
->
m™agemít_Êags
 & 
MF_EXTERNAL_KEY
Ë&& o±i⁄s->
˚π_fûe
)

525 
	`és_˘x_u£_exã∫Æ_¥iv©e_key
(
√w_˘x
, 
›ti⁄s
->
˚π_fûe
,

526 
›ti⁄s
->
˚π_fûe_ölöe
);

532 i‡(
›ti⁄s
->
˚π_fûe
)

534 
	`és_˘x_lﬂd_˚π_fûe
(
√w_˘x
, 
›ti⁄s
->
˚π_fûe
, o±i⁄s->
˚π_fûe_ölöe
);

538 i‡(
›ti⁄s
->
¥iv_key_fûe
)

540 i‡(0 !
	`és_˘x_lﬂd_¥iv_fûe
(
√w_˘x
, 
›ti⁄s
->
¥iv_key_fûe
, o±i⁄s->
¥iv_key_fûe_ölöe
))

541 
îr
;

545 i‡(
›ti⁄s
->
ˇ_fûe
 || o±i⁄s->
ˇ_∑th
)

547 
	`és_˘x_lﬂd_ˇ
(
√w_˘x
, 
›ti⁄s
->
ˇ_fûe
, o±i⁄s->
ˇ_fûe_ölöe
,

548 
›ti⁄s
->
ˇ_∑th
, o±i⁄s->
és_£rvî
);

553 i‡(
›ti⁄s
->
exåa_˚πs_fûe
 || o±i⁄s->
exåa_˚πs_fûe_ölöe
)

555 
	`és_˘x_lﬂd_exåa_˚πs
(
√w_˘x
, 
›ti⁄s
->
exåa_˚πs_fûe
, o±i⁄s->
exåa_˚πs_fûe_ölöe
);

559 i‡(
›ti⁄s
->
cùhî_li°
)

561 
	`és_˘x_ª°ri˘_cùhîs
(
√w_˘x
, 
›ti⁄s
->
cùhî_li°
);

564 #ifde‡
ENABLE_CRYPTO_POLARSSL


566 
	`és_˘x_≥rs⁄Æi£_øndom
 (
√w_˘x
);

569 
	`és_˛ór_îr‹
 ();

572 
îr
:

573 
	`és_˛ór_îr‹
 ();

574 
	`és_˘x_‰ì
 (
√w_˘x
);

576 
	}
}

582 
	$°©e_«me
 (
°©e
)

584 
°©e
)

586 
S_UNDEF
:

588 
S_INITIAL
:

590 
S_PRE_START
:

592 
S_START
:

594 
S_SENT_KEY
:

596 
S_GOT_KEY
:

598 
S_ACTIVE
:

600 
S_NORMAL_OP
:

602 
S_ERROR
:

607 
	}
}

610 
	$∑ckë_›code_«me
 (
›
)

612 
›
)

614 
P_CONTROL_HARD_RESET_CLIENT_V1
:

616 
P_CONTROL_HARD_RESET_SERVER_V1
:

618 
P_CONTROL_HARD_RESET_CLIENT_V2
:

620 
P_CONTROL_HARD_RESET_SERVER_V2
:

622 
P_CONTROL_SOFT_RESET_V1
:

624 
P_CONTROL_V1
:

626 
P_ACK_V1
:

628 
P_DATA_V1
:

630 
P_DATA_V2
:

635 
	}
}

638 
	$£ssi⁄_ödex_«me
 (
ödex
)

640 
ödex
)

642 
TM_ACTIVE
:

644 
TM_UNTRUSTED
:

646 
TM_LAME_DUCK
:

651 
	}
}

657 
	$¥öt_key_id
 (
és_mu…i
 *
mu…i
, 
gc_¨ía
 *
gc
)

659 
i
;

660 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

662 
i
 = 0; i < 
KEY_SCAN_SIZE
; ++i)

664 
key_°©e
 *
ks
 = 
mu…i
->
key_sˇn
[
i
];

665 
	`buf_¥ötf
 (&
out
, " [key#%d sèã=%†id=%d sid=%s]", 
i
,

666 
	`°©e_«me
 (
ks
->
°©e
), ks->
key_id
,

667 
	`£ssi⁄_id_¥öt
 (&
ks
->
£ssi⁄_id_ªmŸe
, 
gc
));

670  
	`BSTR
 (&
out
);

671 
	}
}

680 
boﬁ


681 
	$is_h¨d_ª£t
 (
›
, 
key_mëhod
)

683 i‡(!
key_mëhod
 || key_method == 1)

684 i‡(
›
 =
P_CONTROL_HARD_RESET_CLIENT_V1
 || o∞=
P_CONTROL_HARD_RESET_SERVER_V1
)

685  
åue
;

687 i‡(!
key_mëhod
 || key_method >= 2)

688 i‡(
›
 =
P_CONTROL_HARD_RESET_CLIENT_V2
 || o∞=
P_CONTROL_HARD_RESET_SERVER_V2
)

689  
åue
;

691  
Ál£
;

692 
	}
}

718 
	$key_°©e_öô
 (
és_£ssi⁄
 *
£ssi⁄
, 
key_°©e
 *
ks
)

720 
	`upd©e_time
 ();

722 
	`CLEAR
 (*
ks
);

728 
	`key_°©e_s¶_öô
(&
ks
->
ks_s¶
, &
£ssi⁄
->
›t
->
s¶_˘x
, sessi⁄->›t->
£rvî
,

729 
£ssi⁄
);

732 
ks
->
öôül_›code
 = 
£ssi⁄
->initial_opcode;

733 
£ssi⁄
->
öôül_›code
 = 
P_CONTROL_SOFT_RESET_V1
;

734 
ks
->
°©e
 = 
S_INITIAL
;

735 
ks
->
key_id
 = 
£ssi⁄
->key_id;

741 ++
£ssi⁄
->
key_id
;

742 
£ssi⁄
->
key_id
 &
P_KEY_ID_MASK
;

743 i‡(!
£ssi⁄
->
key_id
)

744 
£ssi⁄
->
key_id
 = 1;

747 
	`ALLOC_OBJ_CLEAR
 (
ks
->
key_§c
, 
key_sour˚2
);

750 
	`ALLOC_OBJ_CLEAR
 (
ks
->
£nd_ªlübÀ
, 
ªlübÀ
);

751 
	`ALLOC_OBJ_CLEAR
 (
ks
->
ªc_ªlübÀ
, 
ªlübÀ
);

752 
	`ALLOC_OBJ_CLEAR
 (
ks
->
ªc_ack
, 
ªlübÀ_ack
);

755 
ks
->
∂aöãxt_ªad_buf
 = 
	`Æloc_buf
 (
TLS_CHANNEL_BUF_SIZE
);

756 
ks
->
∂aöãxt_wrôe_buf
 = 
	`Æloc_buf
 (
TLS_CHANNEL_BUF_SIZE
);

757 
ks
->
ack_wrôe_buf
 = 
	`Æloc_buf
 (
	`BUF_SIZE
 (&
£ssi⁄
->
›t
->
‰ame
));

758 
	`ªlübÀ_öô
 (
ks
->
£nd_ªlübÀ
, 
	`BUF_SIZE
 (&
£ssi⁄
->
›t
->
‰ame
),

759 
	`FRAME_HEADROOM
 (&
£ssi⁄
->
›t
->
‰ame
), 
TLS_RELIABLE_N_SEND_BUFFERS
,

760 
ks
->
key_id
 ? 
Ál£
 : 
£ssi⁄
->
›t
->
xmô_hﬁd
);

761 
	`ªlübÀ_öô
 (
ks
->
ªc_ªlübÀ
, 
	`BUF_SIZE
 (&
£ssi⁄
->
›t
->
‰ame
),

762 
	`FRAME_HEADROOM
 (&
£ssi⁄
->
›t
->
‰ame
), 
TLS_RELIABLE_N_REC_BUFFERS
,

763 
Ál£
);

764 
	`ªlübÀ_£t_timeout
 (
ks
->
£nd_ªlübÀ
, 
£ssi⁄
->
›t
->
∑ckë_timeout
);

767 
	`∑ckë_id_öô
 (&
ks
->
∑ckë_id
,

768 
£ssi⁄
->
›t
->
t˝_mode
,

769 
£ssi⁄
->
›t
->
ª∂ay_wödow
,

770 
£ssi⁄
->
›t
->
ª∂ay_time
,

771 "SSL", 
ks
->
key_id
);

773 #ifde‡
MANAGEMENT_DEF_AUTH


774 
ks
->
mda_key_id
 = 
£ssi⁄
->
›t
->
mda_c⁄ãxt
->
mda_key_id_cou¡î
++;

776 
	}
}

793 
	$key_°©e_‰ì
 (
key_°©e
 *
ks
, 
boﬁ
 
˛ór
)

795 
ks
->
°©e
 = 
S_UNDEF
;

797 
	`key_°©e_s¶_‰ì
(&
ks
->
ks_s¶
);

799 
	`‰ì_key_˘x_bi
 (&
ks
->
key
);

800 
	`‰ì_buf
 (&
ks
->
∂aöãxt_ªad_buf
);

801 
	`‰ì_buf
 (&
ks
->
∂aöãxt_wrôe_buf
);

802 
	`‰ì_buf
 (&
ks
->
ack_wrôe_buf
);

803 
	`buf„r_li°_‰ì
(
ks
->
∑ybuf
);

805 i‡(
ks
->
£nd_ªlübÀ
)

807 
	`ªlübÀ_‰ì
 (
ks
->
£nd_ªlübÀ
);

808 
	`‰ì
 (
ks
->
£nd_ªlübÀ
);

811 i‡(
ks
->
ªc_ªlübÀ
)

813 
	`ªlübÀ_‰ì
 (
ks
->
ªc_ªlübÀ
);

814 
	`‰ì
 (
ks
->
ªc_ªlübÀ
);

817 i‡(
ks
->
ªc_ack
)

818 
	`‰ì
 (
ks
->
ªc_ack
);

820 i‡(
ks
->
key_§c
)

821 
	`‰ì
 (
ks
->
key_§c
);

823 
	`∑ckë_id_‰ì
 (&
ks
->
∑ckë_id
);

825 #ifde‡
PLUGIN_DEF_AUTH


826 
	`key_°©e_rm_auth_c⁄åﬁ_fûe
 (
ks
);

829 i‡(
˛ór
)

830 
	`CLEAR
 (*
ks
);

831 
	}
}

841 
ölöe
 
	$és_£ssi⁄_£t_£lf_ª„ª¡ül_poöãrs
 (
és_£ssi⁄
* 
£ssi⁄
) {

842 
£ssi⁄
->
és_auth
.
∑ckë_id
 = &£ssi⁄->
és_auth_pid
;

843 
	}
}

867 
	$és_£ssi⁄_öô
 (
és_mu…i
 *
mu…i
, 
és_£ssi⁄
 *
£ssi⁄
)

869 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

871 
	`dmsg
 (
D_TLS_DEBUG
, "TLS:Åls_session_init:Éntry");

873 
	`CLEAR
 (*
£ssi⁄
);

876 
£ssi⁄
->
›t
 = &
mu…i
->opt;

879 !
	`£ssi⁄_id_deföed
(&
£ssi⁄
->
£ssi⁄_id
))

880 
	`£ssi⁄_id_øndom
 (&
£ssi⁄
->
£ssi⁄_id
);

883 
	`ASSERT
 (
£ssi⁄
->
›t
->
key_mëhod
 >= 1);

884 i‡(
£ssi⁄
->
›t
->
key_mëhod
 == 1)

886 
£ssi⁄
->
öôül_›code
 = sessi⁄->
›t
->
£rvî
 ?

887 
P_CONTROL_HARD_RESET_SERVER_V1
 : 
P_CONTROL_HARD_RESET_CLIENT_V1
;

891 
£ssi⁄
->
öôül_›code
 = sessi⁄->
›t
->
£rvî
 ?

892 
P_CONTROL_HARD_RESET_SERVER_V2
 : 
P_CONTROL_HARD_RESET_CLIENT_V2
;

896 
£ssi⁄
->
és_auth
 = sessi⁄->
›t
->tls_auth;

899 
	`és_£ssi⁄_£t_£lf_ª„ª¡ül_poöãrs
 (
£ssi⁄
);

902 
	`∑ckë_id_öô
 (
£ssi⁄
->
és_auth
.
∑ckë_id
,

903 
£ssi⁄
->
›t
->
t˝_mode
,

904 
£ssi⁄
->
›t
->
ª∂ay_wödow
,

905 
£ssi⁄
->
›t
->
ª∂ay_time
,

906 "TLS_AUTH", 
£ssi⁄
->
key_id
);

909 
	`∑ckë_id_≥rsi°_lﬂd_obj
 (
£ssi⁄
->
és_auth
.
pid_≥rsi°
, sessi⁄->és_auth.
∑ckë_id
);

911 
	`key_°©e_öô
 (
£ssi⁄
, &£ssi⁄->
key
[
KS_PRIMARY
]);

913 
	`dmsg
 (
D_TLS_DEBUG
, "TLS:Åls_session_init:Çew session object, sid=%s",

914 
	`£ssi⁄_id_¥öt
 (&
£ssi⁄
->
£ssi⁄_id
, &
gc
));

916 
	`gc_‰ì
 (&
gc
);

917 
	}
}

932 
	$és_£ssi⁄_‰ì
 (
és_£ssi⁄
 *
£ssi⁄
, 
boﬁ
 
˛ór
)

934 
i
;

936 i‡(
£ssi⁄
->
és_auth
.
∑ckë_id
)

937 
	`∑ckë_id_‰ì
 (
£ssi⁄
->
és_auth
.
∑ckë_id
);

939 
i
 = 0; i < 
KS_SIZE
; ++i)

940 
	`key_°©e_‰ì
 (&
£ssi⁄
->
key
[
i
], 
Ál£
);

942 i‡(
£ssi⁄
->
comm⁄_«me
)

943 
	`‰ì
 (
£ssi⁄
->
comm⁄_«me
);

945 
	`˚π_hash_‰ì
 (
£ssi⁄
->
˚π_hash_£t
);

947 i‡(
˛ór
)

948 
	`CLEAR
 (*
£ssi⁄
);

949 
	}
}

957 
	$move_£ssi⁄
 (
és_mu…i
* 
mu…i
, 
de°
, 
§c
, 
boﬁ
 
ªöô_§c
)

959 
	`msg
 (
D_TLS_DEBUG_LOW
, "TLS: move_session: dest=%s src=%sÑeinit_src=%d",

960 
	`£ssi⁄_ödex_«me
(
de°
),

961 
	`£ssi⁄_ödex_«me
(
§c
),

962 
ªöô_§c
);

963 
	`ASSERT
 (
§c
 !
de°
);

964 
	`ASSERT
 (
§c
 >0 && sr¯< 
TM_SIZE
);

965 
	`ASSERT
 (
de°
 >0 && de° < 
TM_SIZE
);

966 
	`és_£ssi⁄_‰ì
 (&
mu…i
->
£ssi⁄
[
de°
], 
Ál£
);

967 
mu…i
->
£ssi⁄
[
de°
] = mu…i->£ssi⁄[
§c
];

968 
	`és_£ssi⁄_£t_£lf_ª„ª¡ül_poöãrs
 (&
mu…i
->
£ssi⁄
[
de°
]);

970 i‡(
ªöô_§c
)

971 
	`és_£ssi⁄_öô
 (
mu…i
, &mu…i->
£ssi⁄
[
§c
]);

973 
	`CLEAR
 (
mu…i
->
£ssi⁄
[
§c
]);

975 
	`dmsg
 (
D_TLS_DEBUG
, "TLS: move_session:Éxit");

976 
	}
}

979 
	$ª£t_£ssi⁄
 (
és_mu…i
 *
mu…i
, 
és_£ssi⁄
 *
£ssi⁄
)

981 
	`és_£ssi⁄_‰ì
 (
£ssi⁄
, 
Ál£
);

982 
	`és_£ssi⁄_öô
 (
mu…i
, 
£ssi⁄
);

983 
	}
}

990 
	$öôüã_u¡ru°ed_£ssi⁄
 (
és_mu…i
 *
mu…i
, 
sockaddr_ö
 *
to
)

992 
és_£ssi⁄
 *
£ssi⁄
 = &
mu…i
->£ssi⁄[
TM_UNTRUSTED
];

993 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

995 
	`ª£t_£ssi⁄
 (
mu…i
, 
£ssi⁄
);

996 
ks
->
ªmŸe_addr
 = *
to
;

997 
	`msg
 (
D_TLS_DEBUG_LOW
, "TLS: inôüã_u¡ru°ed_£ssi⁄:áddr=%s", 
	`¥öt_sockaddr
 (
to
));

998 
	}
}

1005 
ölöe
 

1006 
	$compuã_óæõ°_wakeup
 (
öãrvÆ_t
 *
óæõ°
, i¡îvÆ_à
£c⁄ds_‰om_now
) {

1007 i‡(
£c⁄ds_‰om_now
 < *
óæõ°
)

1008 *
óæõ°
 = 
£c⁄ds_‰om_now
;

1009 i‡(*
óæõ°
 < 0)

1010 *
óæõ°
 = 0;

1011 
	}
}

1017 
ölöe
 
boﬁ


1018 
	$œme_duck_mu°_dõ
 (c⁄° 
és_£ssi⁄
* 
£ssi⁄
, 
öãrvÆ_t
 *
wakeup
)

1020 c⁄° 
key_°©e
* 
œme
 = &
£ssi⁄
->
key
[
KS_LAME_DUCK
];

1021 i‡(
œme
->
°©e
 >
S_INITIAL
)

1023 c⁄° 
time_t
 
loˇl_now
 = 
now
;

1024 
	`ASSERT
 (
œme
->
mu°_dõ
);

1025 i‡(
loˇl_now
 < 
œme
->
mu°_dõ
)

1027 
	`compuã_óæõ°_wakeup
 (
wakeup
, 
œme
->
mu°_dõ
 - 
loˇl_now
);

1028  
Ál£
;

1031  
åue
;

1033 i‡(
œme
->
°©e
 =
S_ERROR
)

1034  
åue
;

1036  
Ál£
;

1037 
	}
}

1039 
és_mu…i
 *

1040 
	$és_mu…i_öô
 (
és_›ti⁄s
 *tls_options)

1042 
és_mu…i
 *
ªt
;

1044 
	`ALLOC_OBJ_CLEAR
 (
ªt
, 
és_mu…i
);

1047 
ªt
->
›t
 = *
és_›ti⁄s
;

1050 
ªt
->
›t
.
és_auth
.
key_˘x_bi
 = &ªt->›t.
és_auth_key
;

1053 
	`ASSERT
 (
	`SIZE
 (
ªt
->
key_sˇn
) == 3);

1054 
ªt
->
key_sˇn
[0] = &ªt->
£ssi⁄
[
TM_ACTIVE
].
key
[
KS_PRIMARY
];

1055 
ªt
->
key_sˇn
[1] = &ªt->
£ssi⁄
[
TM_ACTIVE
].
key
[
KS_LAME_DUCK
];

1056 
ªt
->
key_sˇn
[2] = &ªt->
£ssi⁄
[
TM_LAME_DUCK
].
key
[
KS_LAME_DUCK
];

1059 
ªt
->
u£_≥î_id
 = 
Ál£
;

1061  
ªt
;

1062 
	}
}

1065 
	$és_mu…i_öô_föÆize
 (
és_mu…i
* 
mu…i
, c⁄° 
‰ame
* frame)

1067 
	`és_öô_c⁄åﬁ_ch™√l_‰ame_∑ømëîs
 (
‰ame
, &
mu…i
->
›t
.frame);

1071 
	`és_£ssi⁄_öô
 (
mu…i
, &mu…i->
£ssi⁄
[
TM_ACTIVE
]);

1073 i‡(!
mu…i
->
›t
.
sögÀ_£ssi⁄
)

1074 
	`és_£ssi⁄_öô
 (
mu…i
, &mu…i->
£ssi⁄
[
TM_UNTRUSTED
]);

1075 
	}
}

1081 
és_auth_°™dÆ⁄e
 *

1082 
	$és_auth_°™dÆ⁄e_öô
 (
és_›ti⁄s
 *tls_options,

1083 
gc_¨ía
 *
gc
)

1085 
és_auth_°™dÆ⁄e
 *
ès
;

1087 
	`ALLOC_OBJ_CLEAR_GC
 (
ès
, 
és_auth_°™dÆ⁄e
, 
gc
);

1090 
ès
->
és_auth_key
 = 
és_›ti⁄s
->tls_auth_key;

1091 
ès
->
és_auth_›ti⁄s
.
key_˘x_bi
 = &ès->
és_auth_key
;

1092 
ès
->
és_auth_›ti⁄s
.
Êags
 |
CO_PACKET_ID_LONG_FORM
;

1095 
ès
->
‰ame
 = 
és_›ti⁄s
->frame;

1097  
ès
;

1098 
	}
}

1101 
	$és_auth_°™dÆ⁄e_föÆize
 (
és_auth_°™dÆ⁄e
 *
ès
,

1102 c⁄° 
‰ame
 *frame)

1104 
	`és_öô_c⁄åﬁ_ch™√l_‰ame_∑ømëîs
 (
‰ame
, &
ès
->frame);

1105 
	}
}

1113 
	$és_mu…i_öô_£t_›ti⁄s
 (
és_mu…i
* 
mu…i
,

1114 c⁄° *
loˇl
,

1115 c⁄° *
ªmŸe
)

1117 #ifde‡
ENABLE_OCC


1119 
mu…i
->
›t
.
loˇl_›ti⁄s
 = 
loˇl
;

1120 
mu…i
->
›t
.
ªmŸe_›ti⁄s
 = 
ªmŸe
;

1122 
	}
}

1128 
	$és_mu…i_‰ì
 (
és_mu…i
 *
mu…i
, 
boﬁ
 
˛ór
)

1130 
i
;

1132 
	`ASSERT
 (
mu…i
);

1134 #ifde‡
MANAGEMENT_DEF_AUTH


1135 
	`m™_def_auth_£t_˛õ¡_ªas⁄
(
mu…i
, 
NULL
);

1137 
	`‰ì
 (
mu…i
->
≥î_öfo
);

1140 i‡(
mu…i
->
locked_˙
)

1141 
	`‰ì
 (
mu…i
->
locked_˙
);

1143 i‡(
mu…i
->
locked_u£∫ame
)

1144 
	`‰ì
 (
mu…i
->
locked_u£∫ame
);

1146 
	`˚π_hash_‰ì
 (
mu…i
->
locked_˚π_hash_£t
);

1148 
i
 = 0; i < 
TM_SIZE
; ++i)

1149 
	`és_£ssi⁄_‰ì
 (&
mu…i
->
£ssi⁄
[
i
], 
Ál£
);

1151 i‡(
˛ór
)

1152 
	`CLEAR
 (*
mu…i
);

1154 
	`‰ì
(
mu…i
);

1155 
	}
}

1167 
	#SWAP_BUF_SIZE
 256

	)

1169 
boﬁ


1170 
	$sw≠_hmac
 (
buf„r
 *
buf
, c⁄° 
¸y±o_›ti⁄s
 *
co
, 
boﬁ
 
öcomög
)

1172 
key_˘x
 *
˘x
;

1174 
	`ASSERT
 (
co
);

1176 
˘x
 = (
öcomög
 ? &
co
->
key_˘x_bi
->
de¸y±
 : &co->key_˘x_bi->
í¸y±
);

1177 
	`ASSERT
 (
˘x
->
hmac
);

1181 c⁄° 
hmac_size
 = 
	`hmac_˘x_size
 (
˘x
->
hmac
Ë+ 
	`∑ckë_id_size
 (
åue
);

1184 c⁄° 
osid_size
 = 1 + 
SID_SIZE
;

1186 
e1
, 
e2
;

1187 
uöt8_t
 *
b
 = 
	`BPTR
 (
buf
);

1188 
uöt8_t
 
buf1
[
SWAP_BUF_SIZE
];

1189 
uöt8_t
 
buf2
[
SWAP_BUF_SIZE
];

1191 i‡(
öcomög
)

1193 
e1
 = 
osid_size
;

1194 
e2
 = 
hmac_size
;

1198 
e1
 = 
hmac_size
;

1199 
e2
 = 
osid_size
;

1202 
	`ASSERT
 (
e1
 <
SWAP_BUF_SIZE
 && 
e2
 <= SWAP_BUF_SIZE);

1204 i‡(
buf
->
Àn
 >
e1
 + 
e2
)

1206 
	`mem˝y
 (
buf1
, 
b
, 
e1
);

1207 
	`mem˝y
 (
buf2
, 
b
 + 
e1
, 
e2
);

1208 
	`mem˝y
 (
b
, 
buf2
, 
e2
);

1209 
	`mem˝y
 (
b
 + 
e2
, 
buf1
, 
e1
);

1210  
åue
;

1213  
Ál£
;

1215 
	}
}

1217 #unde‡
SWAP_BUF_SIZE


1223 
	$wrôe_c⁄åﬁ_auth
 (
és_£ssi⁄
 *
£ssi⁄
,

1224 
key_°©e
 *
ks
,

1225 
buf„r
 *
buf
,

1226 
lök_sockë_a˘uÆ
 **
to_lök_addr
,

1227 
›code
,

1228 
max_ack
,

1229 
boﬁ
 
¥ïíd_ack
)

1231 
uöt8_t
 *
hódî
;

1232 
buf„r
 
nuŒ
 = 
	`˛ór_buf
 ();

1234 
	`ASSERT
 (
	`lök_sockë_a˘uÆ_deföed
 (&
ks
->
ªmŸe_addr
));

1235 
	`ASSERT
 (
ªlübÀ_ack_wrôe


1236 (
ks
->
ªc_ack
, 
buf
, &ks->
£ssi⁄_id_ªmŸe
, 
max_ack
, 
¥ïíd_ack
));

1237 
	`ASSERT
 (
	`£ssi⁄_id_wrôe_¥ïíd
 (&
£ssi⁄
->
£ssi⁄_id
, 
buf
));

1238 
	`ASSERT
 (
hódî
 = 
	`buf_¥ïíd
 (
buf
, 1));

1239 *
hódî
 = 
ks
->
key_id
 | (
›code
 << 
P_OPCODE_SHIFT
);

1240 i‡(
£ssi⁄
->
és_auth
.
key_˘x_bi
->
í¸y±
.
hmac
)

1243 
	`›ív≤_í¸y±
 (
buf
, 
nuŒ
, &
£ssi⁄
->
és_auth
, 
NULL
);

1244 
	`ASSERT
 (
	`sw≠_hmac
 (
buf
, &
£ssi⁄
->
és_auth
, 
Ál£
));

1246 *
to_lök_addr
 = &
ks
->
ªmŸe_addr
;

1247 
	}
}

1252 
boﬁ


1253 
	$ªad_c⁄åﬁ_auth
 (
buf„r
 *
buf
,

1254 c⁄° 
¸y±o_›ti⁄s
 *
co
,

1255 c⁄° 
lök_sockë_a˘uÆ
 *
‰om
)

1257 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1259 i‡(
co
->
key_˘x_bi
->
de¸y±
.
hmac
)

1261 
buf„r
 
nuŒ
 = 
	`˛ór_buf
 ();

1264 i‡(!
	`sw≠_hmac
 (
buf
, 
co
, 
åue
))

1266 
	`msg
 (
D_TLS_ERRORS
,

1268 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
));

1269 
	`gc_‰ì
 (&
gc
);

1270  
Ál£
;

1275 
	`›ív≤_de¸y±
 (
buf
, 
nuŒ
, 
co
, 
NULL
);

1276 i‡(!
buf
->
Àn
)

1278 
	`msg
 (
D_TLS_ERRORS
,

1280 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
));

1281 
	`gc_‰ì
 (&
gc
);

1282  
Ál£
;

1289 
	`buf_adv™˚
 (
buf
, 
SID_SIZE
 + 1);

1291 
	`gc_‰ì
 (&
gc
);

1292  
åue
;

1293 
	}
}

1300 
	$key_sour˚_¥öt
 (c⁄° 
key_sour˚
 *
k
,

1301 c⁄° *
¥efix
)

1303 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1305 
	`VALGRIND_MAKE_READABLE
 ((*)
k
->
¥e_ma°î
,  (k->pre_master));

1306 
	`VALGRIND_MAKE_READABLE
 ((*)
k
->
øndom1
,  (k->random1));

1307 
	`VALGRIND_MAKE_READABLE
 ((*)
k
->
øndom2
,  (k->random2));

1309 
	`dmsg
 (
D_SHOW_KEY_SOURCE
,

1311 
¥efix
,

1312 
	`f‹m©_hex
 (
k
->
¥e_ma°î
,  (k->¥e_ma°î), 0, &
gc
));

1313 
	`dmsg
 (
D_SHOW_KEY_SOURCE
,

1315 
¥efix
,

1316 
	`f‹m©_hex
 (
k
->
øndom1
,  (k->øndom1), 0, &
gc
));

1317 
	`dmsg
 (
D_SHOW_KEY_SOURCE
,

1319 
¥efix
,

1320 
	`f‹m©_hex
 (
k
->
øndom2
,  (k->øndom2), 0, &
gc
));

1322 
	`gc_‰ì
 (&
gc
);

1323 
	}
}

1326 
	$key_sour˚2_¥öt
 (c⁄° 
key_sour˚2
 *
k
)

1328 
	`key_sour˚_¥öt
 (&
k
->
˛õ¡
, "Client");

1329 
	`key_sour˚_¥öt
 (&
k
->
£rvî
, "Server");

1330 
	}
}

1344 
	$és1_P_hash
(c⁄° 
md_kt_t
 *
md_kt
,

1345 c⁄° 
uöt8_t
 *
£c
,

1346 
£c_Àn
,

1347 c⁄° 
uöt8_t
 *
£ed
,

1348 
£ed_Àn
,

1349 
uöt8_t
 *
out
,

1350 
ﬁí
)

1352 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1353 
chunk
,
n
;

1354 
hmac_˘x_t
 
˘x
;

1355 
hmac_˘x_t
 
˘x_tmp
;

1356 
uöt8_t
 
A1
[
MAX_HMAC_KEY_LENGTH
];

1357 
A1_Àn
;

1359 #ifde‡
ENABLE_DEBUG


1360 c⁄° 
ﬁí_‹ig
 = 
ﬁí
;

1361 c⁄° 
uöt8_t
 *
out_‹ig
 = 
out
;

1364 
	`CLEAR
(
˘x
);

1365 
	`CLEAR
(
˘x_tmp
);

1367 
	`dmsg
 (
D_SHOW_KEY_SOURCE
, "és1_P_hash sec: %s", 
	`f‹m©_hex
 (
£c
, 
£c_Àn
, 0, &
gc
));

1368 
	`dmsg
 (
D_SHOW_KEY_SOURCE
, "és1_P_hash sìd: %s", 
	`f‹m©_hex
 (
£ed
, 
£ed_Àn
, 0, &
gc
));

1370 
chunk
 = 
	`md_kt_size
(
md_kt
);

1371 
A1_Àn
 = 
	`md_kt_size
(
md_kt
);

1373 
	`hmac_˘x_öô
(&
˘x
, 
£c
, 
£c_Àn
, 
md_kt
);

1374 
	`hmac_˘x_öô
(&
˘x_tmp
, 
£c
, 
£c_Àn
, 
md_kt
);

1376 
	`hmac_˘x_upd©e
(&
˘x
,
£ed
,
£ed_Àn
);

1377 
	`hmac_˘x_föÆ
(&
˘x
, 
A1
);

1379 
n
=0;

1382 
	`hmac_˘x_ª£t
(&
˘x
);

1383 
	`hmac_˘x_ª£t
(&
˘x_tmp
);

1384 
	`hmac_˘x_upd©e
(&
˘x
,
A1
,
A1_Àn
);

1385 
	`hmac_˘x_upd©e
(&
˘x_tmp
,
A1
,
A1_Àn
);

1386 
	`hmac_˘x_upd©e
(&
˘x
,
£ed
,
£ed_Àn
);

1388 i‡(
ﬁí
 > 
chunk
)

1390 
	`hmac_˘x_föÆ
(&
˘x
, 
out
);

1391 
out
+=
chunk
;

1392 
ﬁí
-=
chunk
;

1393 
	`hmac_˘x_föÆ
(&
˘x_tmp
, 
A1
);

1397 
	`hmac_˘x_föÆ
(&
˘x
, 
A1
);

1398 
	`mem˝y
(
out
,
A1
,
ﬁí
);

1402 
	`hmac_˘x_˛ónup
(&
˘x
);

1403 
	`hmac_˘x_˛ónup
(&
˘x_tmp
);

1404 
	`CLEAR
 (
A1
);

1406 
	`dmsg
 (
D_SHOW_KEY_SOURCE
, "és1_P_hash out: %s", 
	`f‹m©_hex
 (
out_‹ig
, 
ﬁí_‹ig
, 0, &
gc
));

1407 
	`gc_‰ì
 (&
gc
);

1408 
	}
}

1430 
	$és1_PRF
(
uöt8_t
 *
œbñ
,

1431 
œbñ_Àn
,

1432 c⁄° 
uöt8_t
 *
£c
,

1433 
¶í
,

1434 
uöt8_t
 *
out1
,

1435 
ﬁí
)

1437 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1438 c⁄° 
md_kt_t
 *
md5
 = 
	`md_kt_gë
("MD5");

1439 c⁄° 
md_kt_t
 *
sha1
 = 
	`md_kt_gë
("SHA1");

1440 
Àn
,
i
;

1441 c⁄° 
uöt8_t
 *
S1
,*
S2
;

1442 
uöt8_t
 *
out2
;

1444 
out2
 = (
uöt8_t
 *Ë
	`gc_mÆloc
 (
ﬁí
, 
Ál£
, &
gc
);

1446 
Àn
=
¶í
/2;

1447 
S1
=
£c
;

1448 
S2
&(
£c
[
Àn
]);

1449 
Àn
+=(
¶í
&1);

1451 
	`és1_P_hash
(
md5
 ,
S1
,
Àn
,
œbñ
,
œbñ_Àn
,
out1
,
ﬁí
);

1452 
	`és1_P_hash
(
sha1
,
S2
,
Àn
,
œbñ
,
œbñ_Àn
,
out2
,
ﬁí
);

1454 
i
=0; i<
ﬁí
; i++)

1455 
out1
[
i
]^=
out2
[i];

1457 
	`mem£t
 (
out2
, 0, 
ﬁí
);

1459 
	`dmsg
 (
D_SHOW_KEY_SOURCE
, "és1_PRF out[%d]: %s", 
ﬁí
, 
	`f‹m©_hex
 (
out1
, oÀn, 0, &
gc
));

1461 
	`gc_‰ì
 (&
gc
);

1462 
	}
}

1465 
	$›ív≤_PRF
 (c⁄° 
uöt8_t
 *
£¸ë
,

1466 
£¸ë_Àn
,

1467 c⁄° *
œbñ
,

1468 c⁄° 
uöt8_t
 *
˛õ¡_£ed
,

1469 
˛õ¡_£ed_Àn
,

1470 c⁄° 
uöt8_t
 *
£rvî_£ed
,

1471 
£rvî_£ed_Àn
,

1472 c⁄° 
£ssi⁄_id
 *
˛õ¡_sid
,

1473 c⁄° 
£ssi⁄_id
 *
£rvî_sid
,

1474 
uöt8_t
 *
ouçut
,

1475 
ouçut_Àn
)

1479 
buf„r
 
£ed
 = 
	`Æloc_buf
 (
	`°æí
 (
œbñ
)

1480 + 
˛õ¡_£ed_Àn


1481 + 
£rvî_£ed_Àn


1482 + 
SID_SIZE
 * 2);

1484 
	`ASSERT
 (
	`buf_wrôe
 (&
£ed
, 
œbñ
, 
	`°æí
 (label)));

1485 
	`ASSERT
 (
	`buf_wrôe
 (&
£ed
, 
˛õ¡_£ed
, 
˛õ¡_£ed_Àn
));

1486 
	`ASSERT
 (
	`buf_wrôe
 (&
£ed
, 
£rvî_£ed
, 
£rvî_£ed_Àn
));

1488 i‡(
˛õ¡_sid
)

1489 
	`ASSERT
 (
	`buf_wrôe
 (&
£ed
, 
˛õ¡_sid
->
id
, 
SID_SIZE
));

1490 i‡(
£rvî_sid
)

1491 
	`ASSERT
 (
	`buf_wrôe
 (&
£ed
, 
£rvî_sid
->
id
, 
SID_SIZE
));

1494 
	`és1_PRF
 (
	`BPTR
(&
£ed
), 
	`BLEN
(&£ed), 
£¸ë
, 
£¸ë_Àn
, 
ouçut
, 
ouçut_Àn
);

1496 
	`buf_˛ór
 (&
£ed
);

1497 
	`‰ì_buf
 (&
£ed
);

1499 
	`VALGRIND_MAKE_READABLE
 ((*)
ouçut
, 
ouçut_Àn
);

1500 
	}
}

1506 
boﬁ


1507 
	$gíî©e_key_ex∑nsi⁄
 (
key_˘x_bi
 *
key
,

1508 c⁄° 
key_ty≥
 *key_type,

1509 c⁄° 
key_sour˚2
 *
key_§c
,

1510 c⁄° 
£ssi⁄_id
 *
˛õ¡_sid
,

1511 c⁄° 
£ssi⁄_id
 *
£rvî_sid
,

1512 
boﬁ
 
£rvî
)

1514 
uöt8_t
 
ma°î
[48];

1515 
key2
 key2;

1516 
boﬁ
 
ªt
 = 
Ál£
;

1517 
i
;

1519 
	`CLEAR
 (
ma°î
);

1520 
	`CLEAR
 (
key2
);

1523 
	`key_sour˚2_¥öt
 (
key_§c
);

1526 
	`›ív≤_PRF
 (
key_§c
->
˛õ¡
.
¥e_ma°î
,

1527 (
key_§c
->
˛õ¡
.
¥e_ma°î
),

1528 
KEY_EXPANSION_ID
 " master secret",

1529 
key_§c
->
˛õ¡
.
øndom1
,

1530 (
key_§c
->
˛õ¡
.
øndom1
),

1531 
key_§c
->
£rvî
.
øndom1
,

1532 (
key_§c
->
£rvî
.
øndom1
),

1533 
NULL
,

1534 
NULL
,

1535 
ma°î
,

1536 (
ma°î
));

1539 
	`›ív≤_PRF
 (
ma°î
,

1540 (
ma°î
),

1541 
KEY_EXPANSION_ID
 " keyÉxpansion",

1542 
key_§c
->
˛õ¡
.
øndom2
,

1543 (
key_§c
->
˛õ¡
.
øndom2
),

1544 
key_§c
->
£rvî
.
øndom2
,

1545 (
key_§c
->
£rvî
.
øndom2
),

1546 
˛õ¡_sid
,

1547 
£rvî_sid
,

1548 (
uöt8_t
*)
key2
.
keys
,

1549 (
key2
.
keys
));

1551 
key2
.
n
 = 2;

1553 
	`key2_¥öt
 (&
key2
, 
key_ty≥
, "Master Encrypt", "Master Decrypt");

1556 
i
 = 0; i < 2; ++i)

1558 
	`fixup_key
 (&
key2
.
keys
[
i
], 
key_ty≥
);

1559 i‡(!
	`check_key
 (&
key2
.
keys
[
i
], 
key_ty≥
))

1561 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: Bad dynamic key generated");

1562 
exô
;

1568 
	`ASSERT
 (
£rvî
 =
åue
 || sîvî =
Ál£
);

1570 
	`öô_key_˘x
 (&
key
->
í¸y±
,

1571 &
key2
.
keys
[()
£rvî
],

1572 
key_ty≥
,

1573 
OPENVPN_OP_ENCRYPT
,

1576 
	`öô_key_˘x
 (&
key
->
de¸y±
,

1577 &
key2
.
keys
[1-()
£rvî
],

1578 
key_ty≥
,

1579 
OPENVPN_OP_DECRYPT
,

1582 
ªt
 = 
åue
;

1584 
exô
:

1585 
	`CLEAR
 (
ma°î
);

1586 
	`CLEAR
 (
key2
);

1588  
ªt
;

1589 
	}
}

1591 
boﬁ


1592 
	$øndom_byãs_to_buf
 (
buf„r
 *
buf
,

1593 
uöt8_t
 *
out
,

1594 
ouéí
)

1596 i‡(!
	`ønd_byãs
 (
out
, 
ouéí
))

1597 
	`msg
 (
M_FATAL
, "ERROR: RandomÇumber generator cannot obtainÉntropy for key generation [SSL]");

1598 i‡(!
	`buf_wrôe
 (
buf
, 
out
, 
ouéí
))

1599  
Ál£
;

1600  
åue
;

1601 
	}
}

1603 
boﬁ


1604 
	$key_sour˚2_øndomize_wrôe
 (
key_sour˚2
 *
k2
,

1605 
buf„r
 *
buf
,

1606 
boﬁ
 
£rvî
)

1608 
key_sour˚
 *
k
 = &
k2
->
˛õ¡
;

1609 i‡(
£rvî
)

1610 
k
 = &
k2
->
£rvî
;

1612 
	`CLEAR
 (*
k
);

1614 i‡(!
£rvî
)

1616 i‡(!
	`øndom_byãs_to_buf
 (
buf
, 
k
->
¥e_ma°î
,  (k->pre_master)))

1617  
Ál£
;

1620 i‡(!
	`øndom_byãs_to_buf
 (
buf
, 
k
->
øndom1
,  (k->random1)))

1621  
Ál£
;

1622 i‡(!
	`øndom_byãs_to_buf
 (
buf
, 
k
->
øndom2
,  (k->random2)))

1623  
Ál£
;

1625  
åue
;

1626 
	}
}

1629 
	$key_sour˚2_ªad
 (
key_sour˚2
 *
k2
,

1630 
buf„r
 *
buf
,

1631 
boﬁ
 
£rvî
)

1633 
key_sour˚
 *
k
 = &
k2
->
˛õ¡
;

1635 i‡(!
£rvî
)

1636 
k
 = &
k2
->
£rvî
;

1638 
	`CLEAR
 (*
k
);

1640 i‡(
£rvî
)

1642 i‡(!
	`buf_ªad
 (
buf
, 
k
->
¥e_ma°î
,  (k->pre_master)))

1646 i‡(!
	`buf_ªad
 (
buf
, 
k
->
øndom1
,  (k->random1)))

1648 i‡(!
	`buf_ªad
 (
buf
, 
k
->
øndom2
,  (k->random2)))

1652 
	}
}

1655 
	$Êush_∑ylﬂd_buf„r
 (
key_°©e
 *
ks
)

1657 
buf„r
 *
b
;

1659 (
b
 = 
	`buf„r_li°_≥ek
 (
ks
->
∑ybuf
)))

1661 
	`key_°©e_wrôe_∂aöãxt_c⁄°
 (&
ks
->
ks_s¶
, 
b
->
d©a
, b->
Àn
);

1662 
	`buf„r_li°_p›
 (
ks
->
∑ybuf
);

1664 
	}
}

1667 
	#FULL_SYNC
 \

1668 (
	`ªlübÀ_em±y
(
ks
->
£nd_ªlübÀ
Ë&& 
	`ªlübÀ_ack_em±y
 (ks->
ªc_ack
))

	)

1675 
	$key_°©e_so·_ª£t
 (
és_£ssi⁄
 *
£ssi⁄
)

1677 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

1678 
key_°©e
 *
ks_œme
 = &
£ssi⁄
->
key
[
KS_LAME_DUCK
];

1680 
ks
->
mu°_dõ
 = 
now
 + 
£ssi⁄
->
›t
->
å™sôi⁄_wödow
;

1681 
	`key_°©e_‰ì
 (
ks_œme
, 
Ál£
);

1682 *
ks_œme
 = *
ks
;

1684 
	`key_°©e_öô
 (
£ssi⁄
, 
ks
);

1685 
ks
->
£ssi⁄_id_ªmŸe
 = 
ks_œme
->session_id_remote;

1686 
ks
->
ªmŸe_addr
 = 
ks_œme
->remote_addr;

1687 
	}
}

1693 
boﬁ


1694 
	$wrôe_em±y_°rög
 (
buf„r
 *
buf
)

1696 i‡(!
	`buf_wrôe_u16
 (
buf
, 0))

1697  
Ál£
;

1698  
åue
;

1699 
	}
}

1701 
boﬁ


1702 
	$wrôe_°rög
 (
buf„r
 *
buf
, c⁄° *
°r
, c⁄° 
maxÀn
)

1704 c⁄° 
Àn
 = 
	`°æí
 (
°r
) + 1;

1705 i‡(
Àn
 < 1 || (
maxÀn
 >= 0 &&Üen > maxlen))

1706  
Ál£
;

1707 i‡(!
	`buf_wrôe_u16
 (
buf
, 
Àn
))

1708  
Ál£
;

1709 i‡(!
	`buf_wrôe
 (
buf
, 
°r
, 
Àn
))

1710  
Ál£
;

1711  
åue
;

1712 
	}
}

1714 
boﬁ


1715 
	$ªad_°rög
 (
buf„r
 *
buf
, *
°r
, c⁄° 
ˇ∑côy
)

1717 c⁄° 
Àn
 = 
	`buf_ªad_u16
 (
buf
);

1718 i‡(
Àn
 < 1 ||Üí > ()
ˇ∑côy
)

1719  
Ál£
;

1720 i‡(!
	`buf_ªad
 (
buf
, 
°r
, 
Àn
))

1721  
Ál£
;

1722 
°r
[
Àn
-1] = '\0';

1723  
åue
;

1724 
	}
}

1727 
	$ªad_°rög_Æloc
 (
buf„r
 *
buf
)

1729 c⁄° 
Àn
 = 
	`buf_ªad_u16
 (
buf
);

1730 *
°r
;

1732 i‡(
Àn
 < 1)

1733  
NULL
;

1734 
°r
 = (*Ë
	`mÆloc
(
Àn
);

1735 
	`check_mÆloc_ªtu∫
(
°r
);

1736 i‡(!
	`buf_ªad
 (
buf
, 
°r
, 
Àn
))

1738 
	`‰ì
 (
°r
);

1739  
NULL
;

1741 
°r
[
Àn
-1] = '\0';

1742  
°r
;

1743 
	}
}

1746 
	$ªad_°rög_disˇrd
 (
buf„r
 *
buf
)

1748 *
d©a
 = 
	`ªad_°rög_Æloc
(
buf
);

1749 i‡(
d©a
)

1750 
	`‰ì
 (
d©a
);

1751 
	}
}

1758 
boﬁ


1759 
	$key_mëhod_1_wrôe
 (
buf„r
 *
buf
, 
és_£ssi⁄
 *
£ssi⁄
)

1761 
key
 key;

1762 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

1763 
key_°©e
 *
ks_œme
 = &
£ssi⁄
->
key
[
KS_LAME_DUCK
];

1765 
	`ASSERT
 (
£ssi⁄
->
›t
->
key_mëhod
 == 1);

1766 
	`ASSERT
 (
	`buf_öô
 (
buf
, 0));

1768 
	`gíî©e_key_øndom
 (&
key
, &
£ssi⁄
->
›t
->
key_ty≥
);

1769 i‡(!
	`check_key
 (&
key
, &
£ssi⁄
->
›t
->
key_ty≥
))

1771 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: BadÉncrypting key generated");

1772  
Ál£
;

1775 i‡(!
	`wrôe_key
 (&
key
, &
£ssi⁄
->
›t
->
key_ty≥
, 
buf
))

1777 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: write_key failed");

1778  
Ál£
;

1781 
	`öô_key_˘x
 (&
ks
->
key
.
í¸y±
, &key, &
£ssi⁄
->
›t
->
key_ty≥
,

1782 
OPENVPN_OP_ENCRYPT
, "Data Channel Encrypt");

1783 
	`CLEAR
 (
key
);

1787 c⁄° *
loˇl_›ti⁄s
 = 
	`loˇl_›ti⁄s_°rög
 (
£ssi⁄
);

1788 c⁄° 
›éí
 = 
	`°æí
 (
loˇl_›ti⁄s
) + 1;

1789 i‡(!
	`buf_wrôe
 (
buf
, 
loˇl_›ti⁄s
, 
›éí
))

1791 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: KM1 write options failed");

1792  
Ál£
;

1796  
åue
;

1797 
	}
}

1799 
boﬁ


1800 
	$push_≥î_öfo
(
buf„r
 *
buf
, 
és_£ssi⁄
 *
£ssi⁄
)

1802 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1803 
boﬁ
 
ªt
 = 
Ál£
;

1805 #ifde‡
ENABLE_PUSH_PEER_INFO


1806 i‡(
£ssi⁄
->
›t
->
push_≥î_öfo_dëaû
 > 0)

1808 
ív_£t
 *
es
 = 
£ssi⁄
->
›t
->es;

1809 
ív_ôem
 *
e
;

1810 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (512*3, &
gc
);

1813 
	`buf_¥ötf
 (&
out
, "IV_VER=%s\n", 
PACKAGE_VERSION
);

1816 #i‡
	`deföed
(
TARGET_LINUX
)

1817 
	`buf_¥ötf
 (&
out
, "IV_PLAT=linux\n");

1818 #ñi‡
	`deföed
(
TARGET_SOLARIS
)

1819 
	`buf_¥ötf
 (&
out
, "IV_PLAT=solaris\n");

1820 #ñi‡
	`deföed
(
TARGET_OPENBSD
)

1821 
	`buf_¥ötf
 (&
out
, "IV_PLAT=openbsd\n");

1822 #ñi‡
	`deföed
(
TARGET_DARWIN
)

1823 
	`buf_¥ötf
 (&
out
, "IV_PLAT=mac\n");

1824 #ñi‡
	`deföed
(
TARGET_NETBSD
)

1825 
	`buf_¥ötf
 (&
out
, "IV_PLAT=netbsd\n");

1826 #ñi‡
	`deföed
(
TARGET_FREEBSD
)

1827 
	`buf_¥ötf
 (&
out
, "IV_PLAT=freebsd\n");

1828 #ñi‡
	`deföed
(
WIN32
)

1829 
	`buf_¥ötf
 (&
out
, "IV_PLAT=win\n");

1833 #ifde‡
ENABLE_LZO_STUB


1834 
	`buf_¥ötf
 (&
out
, "IV_LZO_STUB=1\n");

1837 
	`buf_¥ötf
(&
out
, "IV_PROTO=2\n");

1839 i‡(
£ssi⁄
->
›t
->
push_≥î_öfo_dëaû
 >= 2)

1842 
rouã_g©eway_öfo
 
rgi
;

1843 
	`gë_deÁu…_g©eway
 (&
rgi
);

1844 i‡(
rgi
.
Êags
 & 
RGI_HWADDR_DEFINED
)

1845 
	`buf_¥ötf
 (&
out
, "IV_HWADDR=%s\n", 
	`f‹m©_hex_ex
 (
rgi
.
hwaddr
, 6, 0, 1, ":", &
gc
));

1846 
	`buf_¥ötf
 (&
out
, "IV_SSL=%s\n", 
	`gë_s¶_libøry_vîsi⁄
() );

1850 
e
=
es
->
li°
;É !
NULL
;ÉÛ->
√xt
)

1852 i‡(
e
->
°rög
)

1854 i‡(((
	`°∫cmp
(
e
->
°rög
, "UV_", 3)==0 && 
£ssi⁄
->
›t
->
push_≥î_öfo_dëaû
 >= 2)

1855 || (
	`°∫cmp
(
e
->
°rög
,"IV_GUI_VER=",("IV_GUI_VER=")-1)==0))

1856 && 
	`buf_ß„
(&
out
, 
	`°æí
(
e
->
°rög
)+1))

1857 
	`buf_¥ötf
 (&
out
, "%s\n", 
e
->
°rög
);

1861 i‡(!
	`wrôe_°rög
(
buf
, 
	`BSTR
(&
out
), -1))

1862 
îr‹
;

1867 i‡(!
	`wrôe_em±y_°rög
 (
buf
))

1868 
îr‹
;

1870 
ªt
 = 
åue
;

1872 
îr‹
:

1873 
	`gc_‰ì
 (&
gc
);

1874  
ªt
;

1875 
	}
}

1877 
boﬁ


1878 
	$key_mëhod_2_wrôe
 (
buf„r
 *
buf
, 
és_£ssi⁄
 *
£ssi⁄
)

1880 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

1881 
key_°©e
 *
ks_œme
 = &
£ssi⁄
->
key
[
KS_LAME_DUCK
];

1883 
	`ASSERT
 (
£ssi⁄
->
›t
->
key_mëhod
 == 2);

1884 
	`ASSERT
 (
	`buf_öô
 (
buf
, 0));

1887 i‡(!
	`buf_wrôe_u32
 (
buf
, 0))

1888 
îr‹
;

1891 i‡(!
	`buf_wrôe_u8
 (
buf
, (
£ssi⁄
->
›t
->
key_mëhod
 & 
KEY_METHOD_MASK
)))

1892 
îr‹
;

1895 i‡(!
	`key_sour˚2_øndomize_wrôe
 (
ks
->
key_§c
, 
buf
, 
£ssi⁄
->
›t
->
£rvî
))

1896 
îr‹
;

1900 i‡(!
	`wrôe_°rög
 (
buf
, 
	`loˇl_›ti⁄s_°rög
 (
£ssi⁄
), 
TLS_OPTIONS_LEN
))

1901 
îr‹
;

1905 i‡(
auth_u£r_∑ss_íabÀd
)

1907 #ifde‡
ENABLE_CLIENT_CR


1908 
	`auth_u£r_∑ss_£tup
 (
NULL
, 
£ssi⁄
->
›t
->
sci
);

1910 
	`auth_u£r_∑ss_£tup
 (
NULL
, NULL);

1912 i‡(!
	`wrôe_°rög
 (
buf
, 
auth_u£r_∑ss
.
u£∫ame
, -1))

1913 
îr‹
;

1914 i‡(!
	`wrôe_°rög
 (
buf
, 
auth_u£r_∑ss
.
∑ssw‹d
, -1))

1915 
îr‹
;

1916 
	`purge_u£r_∑ss
 (&
auth_u£r_∑ss
, 
Ál£
);

1920 i‡(!
	`wrôe_em±y_°rög
 (
buf
))

1921 
îr‹
;

1922 i‡(!
	`wrôe_em±y_°rög
 (
buf
))

1923 
îr‹
;

1926 i‡(!
	`push_≥î_öfo
 (
buf
, 
£ssi⁄
))

1927 
îr‹
;

1932 i‡(
£ssi⁄
->
›t
->
£rvî
)

1934 i‡(
ks
->
authítiˇãd
)

1936 i‡(!
	`gíî©e_key_ex∑nsi⁄
 (&
ks
->
key
,

1937 &
£ssi⁄
->
›t
->
key_ty≥
,

1938 
ks
->
key_§c
,

1939 &
ks
->
£ssi⁄_id_ªmŸe
,

1940 &
£ssi⁄
->
£ssi⁄_id
,

1941 
åue
))

1943 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: server generate_key_expansion failed");

1944 
îr‹
;

1948 
	`CLEAR
 (*
ks
->
key_§c
);

1951  
åue
;

1953 
îr‹
:

1954 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: Key Method #2 write failed");

1955 
	`CLEAR
 (*
ks
->
key_§c
);

1956  
Ál£
;

1957 
	}
}

1959 
boﬁ


1960 
	$key_mëhod_1_ªad
 (
buf„r
 *
buf
, 
és_£ssi⁄
 *
£ssi⁄
)

1962 
°©us
;

1963 
key
 key;

1964 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

1965 
key_°©e
 *
ks_œme
 = &
£ssi⁄
->
key
[
KS_LAME_DUCK
];

1967 
	`ASSERT
 (
£ssi⁄
->
›t
->
key_mëhod
 == 1);

1969 i‡(!
£ssi⁄
->
vîifõd
)

1971 
	`msg
 (
D_TLS_ERRORS
,

1973 
îr‹
;

1976 
°©us
 = 
	`ªad_key
 (&
key
, &
£ssi⁄
->
›t
->
key_ty≥
, 
buf
);

1977 i‡(
°©us
 != 1)

1979 
	`msg
 (
D_TLS_ERRORS
,

1981 
îr‹
;

1984 i‡(!
	`check_key
 (&
key
, &
£ssi⁄
->
›t
->
key_ty≥
))

1986 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: Bad decrypting keyÑeceived fromÖeer");

1987 
îr‹
;

1990 i‡(
buf
->
Àn
 < 1)

1992 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: Missing options string");

1993 
îr‹
;

1996 #ifde‡
ENABLE_OCC


1999 i‡(!
£ssi⁄
->
›t
->
dißbÀ_occ
 &&

2000 !
	`›ti⁄s_cmp_equÆ_ß„
 ((*Ë
	`BPTR
 (
buf
), 
£ssi⁄
->
›t
->
ªmŸe_›ti⁄s
, buf->
Àn
))

2002 
	`›ti⁄s_w¨nög_ß„
 ((*Ë
	`BPTR
 (
buf
), 
£ssi⁄
->
›t
->
ªmŸe_›ti⁄s
, buf->
Àn
);

2006 
	`buf_˛ór
 (
buf
);

2008 
	`öô_key_˘x
 (&
ks
->
key
.
de¸y±
, &key, &
£ssi⁄
->
›t
->
key_ty≥
,

2009 
OPENVPN_OP_DECRYPT
, "Data Channel Decrypt");

2010 
	`CLEAR
 (
key
);

2011 
ks
->
authítiˇãd
 = 
åue
;

2012  
åue
;

2014 
îr‹
:

2015 
	`buf_˛ór
 (
buf
);

2016 
	`CLEAR
 (
key
);

2017  
Ál£
;

2018 
	}
}

2020 
boﬁ


2021 
	$key_mëhod_2_ªad
 (
buf„r
 *
buf
, 
és_mu…i
 *
mu…i
, 
és_£ssi⁄
 *
£ssi⁄
)

2023 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

2024 
key_°©e
 *
ks_œme
 = &
£ssi⁄
->
key
[
KS_LAME_DUCK
];

2026 
key_mëhod_Êags
;

2027 
boﬁ
 
u£∫ame_°©us
, 
∑ssw‹d_°©us
;

2029 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2030 *
›ti⁄s
;

2033 
	`ALLOC_ARRAY_CLEAR_GC
 (
›ti⁄s
, , 
TLS_OPTIONS_LEN
, &
gc
);

2035 
	`ASSERT
 (
£ssi⁄
->
›t
->
key_mëhod
 == 2);

2038 i‡(!
	`buf_adv™˚
 (
buf
, 4)) {

2039 
	`msg
 (
D_TLS_ERRORS
, "TLS ERROR: Plaintext bufferÅoo short (%d bytes).",

2040 
buf
->
Àn
);

2041 
îr‹
;

2045 
key_mëhod_Êags
 = 
	`buf_ªad_u8
 (
buf
);

2046 i‡((
key_mëhod_Êags
 & 
KEY_METHOD_MASK
) != 2)

2048 
	`msg
 (
D_TLS_ERRORS
,

2050 
key_mëhod_Êags
);

2051 
îr‹
;

2055 i‡(!
	`key_sour˚2_ªad
 (
ks
->
key_§c
, 
buf
, 
£ssi⁄
->
›t
->
£rvî
))

2057 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: ErrorÑeadingÑemote data channel key sourceÉntropy fromÖlaintext buffer");

2058 
îr‹
;

2062 i‡(!
	`ªad_°rög
 (
buf
, 
›ti⁄s
, 
TLS_OPTIONS_LEN
))

2064 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: FailedÅoÑeadÑequired OCC options string");

2065 
îr‹
;

2068 
ks
->
authítiˇãd
 = 
Ál£
;

2070 i‡(
	`vîify_u£r_∑ss_íabÀd
(
£ssi⁄
))

2073 
u£r_∑ss
 *
up
;

2075 
	`ALLOC_OBJ_CLEAR_GC
 (
up
, 
u£r_∑ss
, &
gc
);

2076 
u£∫ame_°©us
 = 
	`ªad_°rög
 (
buf
, 
up
->
u£∫ame
, 
USER_PASS_LEN
);

2077 
∑ssw‹d_°©us
 = 
	`ªad_°rög
 (
buf
, 
up
->
∑ssw‹d
, 
USER_PASS_LEN
);

2079 i‡(!
u£∫ame_°©us
 || !
∑ssw‹d_°©us
)

2081 
	`CLEAR
 (*
up
);

2082 i‡(!(
£ssi⁄
->
›t
->
s¶_Êags
 & 
SSLF_AUTH_USER_PASS_OPTIONAL
))

2084 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: Auth Username/Password wasÇotÖrovided byÖeer");

2085 
îr‹
;

2089 #ifde‡
MANAGEMENT_DEF_AUTH


2091 
	`‰ì
 (
mu…i
->
≥î_öfo
);

2092 
mu…i
->
≥î_öfo
 = 
	`ªad_°rög_Æloc
 (
buf
);

2095 
	`vîify_u£r_∑ss
(
up
, 
mu…i
, 
£ssi⁄
);

2096 
	`CLEAR
 (*
up
);

2101 i‡(!
£ssi⁄
->
vîifõd
)

2103 
	`msg
 (
D_TLS_ERRORS
,

2105 
îr‹
;

2107 
ks
->
authítiˇãd
 = 
åue
;

2111 i‡(
ks
->
authítiˇãd
)

2113 
	`vîify_föÆ_auth_checks
(
mu…i
, 
£ssi⁄
);

2116 #ifde‡
ENABLE_OCC


2118 i‡(!
£ssi⁄
->
›t
->
dißbÀ_occ
 &&

2119 !
	`›ti⁄s_cmp_equÆ
 (
›ti⁄s
, 
£ssi⁄
->
›t
->
ªmŸe_›ti⁄s
))

2121 
	`›ti⁄s_w¨nög
 (
›ti⁄s
, 
£ssi⁄
->
›t
->
ªmŸe_›ti⁄s
);

2122 i‡(
£ssi⁄
->
›t
->
s¶_Êags
 & 
SSLF_OPT_VERIFY
)

2124 
	`msg
 (
D_TLS_ERRORS
, "Option inconsistency warningsÅriggering disconnect dueÅo --opt-verify");

2125 
ks
->
authítiˇãd
 = 
Ál£
;

2130 
	`buf_˛ór
 (
buf
);

2136 i‡(
ks
->
authítiˇãd
 && 
	`∂ugö_deföed
 (
£ssi⁄
->
›t
->
∂ugös
, 
OPENVPN_PLUGIN_TLS_FINAL
))

2138 i‡(
	`∂ugö_ˇŒ
 (
£ssi⁄
->
›t
->
∂ugös
, 
OPENVPN_PLUGIN_TLS_FINAL
, 
NULL
, NULL, sessi⁄->›t->
es
Ë!
OPENVPN_PLUGIN_FUNC_SUCCESS
)

2139 
ks
->
authítiˇãd
 = 
Ál£
;

2145 i‡(!
£ssi⁄
->
›t
->
£rvî
)

2147 i‡(!
	`gíî©e_key_ex∑nsi⁄
 (&
ks
->
key
,

2148 &
£ssi⁄
->
›t
->
key_ty≥
,

2149 
ks
->
key_§c
,

2150 &
£ssi⁄
->
£ssi⁄_id
,

2151 &
ks
->
£ssi⁄_id_ªmŸe
,

2152 
Ál£
))

2154 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: client generate_key_expansion failed");

2155 
îr‹
;

2158 
	`CLEAR
 (*
ks
->
key_§c
);

2161 
	`gc_‰ì
 (&
gc
);

2162  
åue
;

2164 
îr‹
:

2165 
	`CLEAR
 (*
ks
->
key_§c
);

2166 
	`buf_˛ór
 (
buf
);

2167 
	`gc_‰ì
 (&
gc
);

2168  
Ál£
;

2169 
	}
}

2172 
	$auth_de„ºed_expúe_wödow
 (c⁄° 
és_›ti⁄s
 *
o
)

2174 
ªt
 = 
o
->
h™dshake_wödow
;

2175 c⁄° 
r2
 = 
o
->
ª√gŸüã_£c⁄ds
 / 2;

2177 i‡(
o
->
ª√gŸüã_£c⁄ds
 && 
r2
 < 
ªt
)

2178 
ªt
 = 
r2
;

2179  
ªt
;

2180 
	}
}

2191 
boﬁ


2192 
	$és_¥o˚ss
 (
és_mu…i
 *
mu…i
,

2193 
és_£ssi⁄
 *
£ssi⁄
,

2194 
buf„r
 *
to_lök
,

2195 
lök_sockë_a˘uÆ
 **
to_lök_addr
,

2196 
lök_sockë_öfo
 *
to_lök_sockë_öfo
,

2197 
öãrvÆ_t
 *
wakeup
)

2199 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2200 
buf„r
 *
buf
;

2201 
boﬁ
 
°©e_ch™ge
 = 
Ál£
;

2202 
boﬁ
 
a˘ive
 = 
Ál£
;

2203 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

2204 
key_°©e
 *
ks_œme
 = &
£ssi⁄
->
key
[
KS_LAME_DUCK
];

2207 
	`ASSERT
 (
ks
->
°©e
 !
S_UNDEF
);

2208 
	`ASSERT
 (
ks
->
°©e
 !
S_ERROR
);

2209 
	`ASSERT
 (
	`£ssi⁄_id_deföed
 (&
£ssi⁄
->
£ssi⁄_id
));

2212 i‡(
ks
->
°©e
 >
S_ACTIVE
 &&

2213 ((
£ssi⁄
->
›t
->
ª√gŸüã_£c⁄ds


2214 && 
now
 >
ks
->
e°ablished
 + 
£ssi⁄
->
›t
->
ª√gŸüã_£c⁄ds
)

2215 || (
£ssi⁄
->
›t
->
ª√gŸüã_byãs


2216 && 
ks
->
n_byãs
 >
£ssi⁄
->
›t
->
ª√gŸüã_byãs
)

2217 || (
£ssi⁄
->
›t
->
ª√gŸüã_∑ckës


2218 && 
ks
->
n_∑ckës
 >
£ssi⁄
->
›t
->
ª√gŸüã_∑ckës
)

2219 || (
	`∑ckë_id_˛o£_to_wøµög
 (&
ks
->
∑ckë_id
.
£nd
))))

2221 
	`msg
 (
D_TLS_DEBUG_LOW
,

2222 "TLS: so·Ñe£à£c=%d byãs=" 
cou¡î_f‹m©
 "/%dÖkts=" counter_format "/%d",

2223 ()(
ks
->
e°ablished
 + 
£ssi⁄
->
›t
->
ª√gŸüã_£c⁄ds
 - 
now
),

2224 
ks
->
n_byãs
, 
£ssi⁄
->
›t
->
ª√gŸüã_byãs
,

2225 
ks
->
n_∑ckës
, 
£ssi⁄
->
›t
->
ª√gŸüã_∑ckës
);

2226 
	`key_°©e_so·_ª£t
 (
£ssi⁄
);

2230 i‡(
	`œme_duck_mu°_dõ
 (
£ssi⁄
, 
wakeup
)) {

2231 
	`key_°©e_‰ì
 (
ks_œme
, 
åue
);

2232 
	`msg
 (
D_TLS_DEBUG_LOW
, "TLS:Åls_process: killedÉxpiring key");

2237 
	`upd©e_time
 ();

2239 
	`dmsg
 (
D_TLS_DEBUG
, "TLS:Åls_process: chg=%d ks=%sÜame=%sÅo_link->len=%d wakeup=%d",

2240 
°©e_ch™ge
,

2241 
	`°©e_«me
 (
ks
->
°©e
),

2242 
	`°©e_«me
 (
ks_œme
->
°©e
),

2243 
to_lök
->
Àn
,

2244 *
wakeup
);

2246 
°©e_ch™ge
 = 
Ál£
;

2255 i‡(
åue
)

2258 i‡(
ks
->
°©e
 =
S_INITIAL
)

2260 
buf
 = 
	`ªlübÀ_gë_buf_ouçut_£quí˚d
 (
ks
->
£nd_ªlübÀ
);

2261 i‡(
buf
)

2263 
ks
->
mu°_√gŸüã
 = 
now
 + 
£ssi⁄
->
›t
->
h™dshake_wödow
;

2264 
ks
->
auth_de„ºed_expúe
 = 
now
 + 
	`auth_de„ºed_expúe_wödow
 (
£ssi⁄
->
›t
);

2267 
	`ªlübÀ_m¨k_a˘ive_outgoög
 (
ks
->
£nd_ªlübÀ
, 
buf
, ks->
öôül_›code
);

2268 
INCR_GENERATED
;

2270 
ks
->
°©e
 = 
S_PRE_START
;

2271 
°©e_ch™ge
 = 
åue
;

2272 
	`dmsg
 (
D_TLS_DEBUG
, "TLS: Initial Handshake, sid=%s",

2273 
	`£ssi⁄_id_¥öt
 (&
£ssi⁄
->
£ssi⁄_id
, &
gc
));

2275 #ifde‡
ENABLE_MANAGEMENT


2276 i‡(
m™agemít
 && 
ks
->
öôül_›code
 !
P_CONTROL_SOFT_RESET_V1
)

2278 
	`m™agemít_£t_°©e
 (
m™agemít
,

2279 
OPENVPN_STATE_WAIT
,

2280 
NULL
,

2289 i‡(
now
 >
ks
->
mu°_√gŸüã
)

2291 i‡(
ks
->
°©e
 < 
S_ACTIVE
)

2293 
	`msg
 (
D_TLS_ERRORS
,

2295 
£ssi⁄
->
›t
->
h™dshake_wödow
);

2296 
îr‹
;

2300 
	`dmsg
 (
D_TLS_DEBUG_MED
, "STATE S_NORMAL_OP");

2301 
ks
->
°©e
 = 
S_NORMAL_OP
;

2302 
ks
->
mu°_√gŸüã
 = 0;

2307 i‡(
ks
->
°©e
 =
S_PRE_START
 && 
FULL_SYNC
)

2309 
ks
->
°©e
 = 
S_START
;

2310 
°©e_ch™ge
 = 
åue
;

2311 
	`dmsg
 (
D_TLS_DEBUG_MED
, "STATE S_START");

2315 i‡(((
ks
->
°©e
 =
S_GOT_KEY
 && !
£ssi⁄
->
›t
->
£rvî
) ||

2316 (
ks
->
°©e
 =
S_SENT_KEY
 && 
£ssi⁄
->
›t
->
£rvî
)))

2318 i‡(
FULL_SYNC
)

2320 
ks
->
e°ablished
 = 
now
;

2321 
	`dmsg
 (
D_TLS_DEBUG_MED
, "STATE S_ACTIVE");

2322 i‡(
	`check_debug_Àvñ
 (
D_HANDSHAKE
))

2323 
	`¥öt_dëaûs
 (&
ks
->
ks_s¶
, "Control Channel:");

2324 
°©e_ch™ge
 = 
åue
;

2325 
ks
->
°©e
 = 
S_ACTIVE
;

2326 
INCR_SUCCESS
;

2329 
	`lök_sockë_£t_outgoög_addr
 (
NULL
, 
to_lök_sockë_öfo
, &
ks
->
ªmŸe_addr
, 
£ssi⁄
->
comm⁄_«me
, sessi⁄->
›t
->
es
);

2332 
	`Êush_∑ylﬂd_buf„r
 (
ks
);

2334 #ifde‡
MEASURE_TLS_HANDSHAKE_STATS


2335 
	`show_és_≥rf‹m™˚_°©s
();

2342 i‡(!
to_lök
->
Àn
 && 
	`ªlübÀ_ˇn_£nd
 (
ks
->
£nd_ªlübÀ
))

2344 
›code
;

2345 
buf„r
 
b
;

2347 
buf
 = 
	`ªlübÀ_£nd
 (
ks
->
£nd_ªlübÀ
, &
›code
);

2348 
	`ASSERT
 (
buf
);

2349 
b
 = *
buf
;

2350 
INCR_SENT
;

2352 
	`wrôe_c⁄åﬁ_auth
 (
£ssi⁄
, 
ks
, &
b
, 
to_lök_addr
, 
›code
,

2353 
CONTROL_SEND_ACK_MAX
, 
åue
);

2354 *
to_lök
 = 
b
;

2355 
a˘ive
 = 
åue
;

2356 
°©e_ch™ge
 = 
åue
;

2357 
	`dmsg
 (
D_TLS_DEBUG
, "Reliable -> TCP/UDP");

2361 #i‚de‡
TLS_AGGREGATE_ACK


2363 i‡(!
to_lök
->
Àn
 && !
	`ªlübÀ_ack_em±y
 (
ks
->
ªc_ack
))

2365 
buf
 = &
ks
->
ack_wrôe_buf
;

2366 
	`ASSERT
 (
	`buf_öô
 (
buf
, 
	`FRAME_HEADROOM
 (&
mu…i
->
›t
.
‰ame
)));

2367 
	`wrôe_c⁄åﬁ_auth
 (
£ssi⁄
, 
ks
, 
buf
, 
to_lök_addr
, 
P_ACK_V1
,

2368 
RELIABLE_ACK_SIZE
, 
Ál£
);

2369 *
to_lök
 = *
buf
;

2370 
a˘ive
 = 
åue
;

2371 
°©e_ch™ge
 = 
åue
;

2372 
	`dmsg
 (
D_TLS_DEBUG
, "Dedicated ACK -> TCP/UDP");

2378 
buf
 = 
	`ªlübÀ_gë_buf_£quí˚d
 (
ks
->
ªc_ªlübÀ
);

2379 i‡(
buf
)

2381 
°©us
 = 0;

2382 i‡(
buf
->
Àn
)

2384 
°©us
 = 
	`key_°©e_wrôe_cùhîãxt
 (&
ks
->
ks_s¶
, 
buf
);

2385 i‡(
°©us
 == -1)

2387 
	`msg
 (
D_TLS_ERRORS
,

2389 
îr‹
;

2394 
°©us
 = 1;

2396 i‡(
°©us
 == 1)

2398 
	`ªlübÀ_m¨k_dñëed
 (
ks
->
ªc_ªlübÀ
, 
buf
, 
åue
);

2399 
°©e_ch™ge
 = 
åue
;

2400 
	`dmsg
 (
D_TLS_DEBUG
, "Incoming Ciphertext -> TLS");

2405 
buf
 = &
ks
->
∂aöãxt_ªad_buf
;

2406 i‡(!
buf
->
Àn
)

2408 
°©us
;

2410 
	`ASSERT
 (
	`buf_öô
 (
buf
, 0));

2411 
°©us
 = 
	`key_°©e_ªad_∂aöãxt
 (&
ks
->
ks_s¶
, 
buf
, 
TLS_CHANNEL_BUF_SIZE
);

2412 
	`upd©e_time
 ();

2413 i‡(
°©us
 == -1)

2415 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: TLS object -> incomingÖlaintextÑeadÉrror");

2416 
îr‹
;

2418 i‡(
°©us
 == 1)

2420 
°©e_ch™ge
 = 
åue
;

2421 
	`dmsg
 (
D_TLS_DEBUG
, "TLS -> Incoming Plaintext");

2424 i‡(!
°©us
)

2425 
	`msg
 (
M_INFO
, "TLSÖlaintextÑead -> NULLÑeturn");

2430 
buf
 = &
ks
->
∂aöãxt_wrôe_buf
;

2431 i‡(!
buf
->
Àn
 && ((
ks
->
°©e
 =
S_START
 && !
£ssi⁄
->
›t
->
£rvî
) ||

2432 (
ks
->
°©e
 =
S_GOT_KEY
 && 
£ssi⁄
->
›t
->
£rvî
)))

2434 i‡(
£ssi⁄
->
›t
->
key_mëhod
 == 1)

2436 i‡(!
	`key_mëhod_1_wrôe
 (
buf
, 
£ssi⁄
))

2437 
îr‹
;

2439 i‡(
£ssi⁄
->
›t
->
key_mëhod
 == 2)

2441 i‡(!
	`key_mëhod_2_wrôe
 (
buf
, 
£ssi⁄
))

2442 
îr‹
;

2446 
	`ASSERT
 (0);

2449 
°©e_ch™ge
 = 
åue
;

2450 
	`dmsg
 (
D_TLS_DEBUG_MED
, "STATE S_SENT_KEY");

2451 
ks
->
°©e
 = 
S_SENT_KEY
;

2455 
buf
 = &
ks
->
∂aöãxt_ªad_buf
;

2456 i‡(
buf
->
Àn


2457 && ((
ks
->
°©e
 =
S_SENT_KEY
 && !
£ssi⁄
->
›t
->
£rvî
)

2458 || (
ks
->
°©e
 =
S_START
 && 
£ssi⁄
->
›t
->
£rvî
)))

2460 i‡(
£ssi⁄
->
›t
->
key_mëhod
 == 1)

2462 i‡(!
	`key_mëhod_1_ªad
 (
buf
, 
£ssi⁄
))

2463 
îr‹
;

2465 i‡(
£ssi⁄
->
›t
->
key_mëhod
 == 2)

2467 i‡(!
	`key_mëhod_2_ªad
 (
buf
, 
mu…i
, 
£ssi⁄
))

2468 
îr‹
;

2472 
	`ASSERT
 (0);

2475 
°©e_ch™ge
 = 
åue
;

2476 
	`dmsg
 (
D_TLS_DEBUG_MED
, "STATE S_GOT_KEY");

2477 
ks
->
°©e
 = 
S_GOT_KEY
;

2481 
buf
 = &
ks
->
∂aöãxt_wrôe_buf
;

2482 i‡(
buf
->
Àn
)

2484 
°©us
 = 
	`key_°©e_wrôe_∂aöãxt
 (&
ks
->
ks_s¶
, 
buf
);

2485 i‡(
°©us
 == -1)

2487 
	`msg
 (
D_TLS_ERRORS
,

2489 
îr‹
;

2491 i‡(
°©us
 == 1)

2493 
°©e_ch™ge
 = 
åue
;

2494 
	`dmsg
 (
D_TLS_DEBUG
, "Outgoing Plaintext -> TLS");

2499 i‡(
ks
->
°©e
 >
S_START
)

2501 
buf
 = 
	`ªlübÀ_gë_buf_ouçut_£quí˚d
 (
ks
->
£nd_ªlübÀ
);

2502 i‡(
buf
)

2504 
°©us
 = 
	`key_°©e_ªad_cùhîãxt
 (&
ks
->
ks_s¶
, 
buf
, 
	`PAYLOAD_SIZE_DYNAMIC
 (&
mu…i
->
›t
.
‰ame
));

2505 i‡(
°©us
 == -1)

2507 
	`msg
 (
D_TLS_ERRORS
,

2509 
îr‹
;

2511 i‡(
°©us
 == 1)

2513 
	`ªlübÀ_m¨k_a˘ive_outgoög
 (
ks
->
£nd_ªlübÀ
, 
buf
, 
P_CONTROL_V1
);

2514 
INCR_GENERATED
;

2515 
°©e_ch™ge
 = 
åue
;

2516 
	`dmsg
 (
D_TLS_DEBUG
, "Outgoing Ciphertext -> Reliable");

2522 
°©e_ch™ge
);

2524 
	`upd©e_time
 ();

2526 #ifde‡
TLS_AGGREGATE_ACK


2528 i‡(!
to_lök
->
Àn
 && !
	`ªlübÀ_ack_em±y
 (
ks
->
ªc_ack
))

2530 
buf
 = &
ks
->
ack_wrôe_buf
;

2531 
	`ASSERT
 (
	`buf_öô
 (
buf
, 
	`FRAME_HEADROOM
 (&
mu…i
->
›t
.
‰ame
)));

2532 
	`wrôe_c⁄åﬁ_auth
 (
£ssi⁄
, 
ks
, 
buf
, 
to_lök_addr
, 
P_ACK_V1
,

2533 
RELIABLE_ACK_SIZE
, 
Ál£
);

2534 *
to_lök
 = *
buf
;

2535 
a˘ive
 = 
åue
;

2536 
°©e_ch™ge
 = 
åue
;

2537 
	`dmsg
 (
D_TLS_DEBUG
, "Dedicated ACK -> TCP/UDP");

2543 i‡(
ks
->
°©e
 >
S_INITIAL
)

2545 
	`compuã_óæõ°_wakeup
 (
wakeup
,

2546 
	`ªlübÀ_£nd_timeout
 (
ks
->
£nd_ªlübÀ
));

2548 i‡(
ks
->
mu°_√gŸüã
)

2549 
	`compuã_óæõ°_wakeup
 (
wakeup
, 
ks
->
mu°_√gŸüã
 - 
now
);

2552 i‡(
ks
->
e°ablished
 && 
£ssi⁄
->
›t
->
ª√gŸüã_£c⁄ds
)

2553 
	`compuã_óæõ°_wakeup
 (
wakeup
,

2554 
ks
->
e°ablished
 + 
£ssi⁄
->
›t
->
ª√gŸüã_£c⁄ds
 - 
now
);

2557 i‡(*
wakeup
 <= 0)

2559 *
wakeup
 = 1;

2563 
a˘ive
 = 
åue
;

2566 
	`dmsg
 (
D_TLS_DEBUG
, "TLS:Åls_¥o˚ss:Åimeouà£àtÿ%d", *
wakeup
);

2568 
	`gc_‰ì
 (&
gc
);

2569  
a˘ive
;

2572 
îr‹
:

2573 
	`és_˛ór_îr‹
();

2574 
ks
->
°©e
 = 
S_ERROR
;

2575 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: TLS handshake failed");

2576 
INCR_ERROR
;

2577 
	`gc_‰ì
 (&
gc
);

2578  
Ál£
;

2579 
	}
}

2589 
	$és_mu…i_¥o˚ss
 (
és_mu…i
 *
mu…i
,

2590 
buf„r
 *
to_lök
,

2591 
lök_sockë_a˘uÆ
 **
to_lök_addr
,

2592 
lök_sockë_öfo
 *
to_lök_sockë_öfo
,

2593 
öãrvÆ_t
 *
wakeup
)

2595 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2596 
i
;

2597 
a˘ive
 = 
TLSMP_INACTIVE
;

2598 
boﬁ
 
îr‹
 = 
Ál£
;

2599 
ès
;

2601 
	`≥rf_push
 (
PERF_TLS_MULTI_PROCESS
);

2603 
	`és_˛ór_îr‹
 ();

2610 
i
 = 0; i < 
TM_SIZE
; ++i)

2612 
és_£ssi⁄
 *
£ssi⁄
 = &
mu…i
->£ssi⁄[
i
];

2613 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

2614 
key_°©e
 *
ks_œme
 = &
£ssi⁄
->
key
[
KS_LAME_DUCK
];

2617 i‡(
i
 =
TM_ACTIVE
 && 
ks
->
°©e
 =
S_INITIAL
 &&

2618 
	`lök_sockë_a˘uÆ_deföed
 (&
to_lök_sockë_öfo
->
lß
->
a˘uÆ
))

2619 
ks
->
ªmŸe_addr
 = 
to_lök_sockë_öfo
->
lß
->
a˘uÆ
;

2621 
	`dmsg
 (
D_TLS_DEBUG
,

2623 
i
,

2624 
	`°©e_«me
 (
ks
->
°©e
),

2625 
	`£ssi⁄_id_¥öt
 (&
£ssi⁄
->
£ssi⁄_id
, &
gc
),

2626 
	`£ssi⁄_id_¥öt
 (&
ks
->
£ssi⁄_id_ªmŸe
, &
gc
),

2627 
	`¥öt_lök_sockë_a˘uÆ
 (&
ks
->
ªmŸe_addr
, &
gc
));

2629 i‡(
ks
->
°©e
 >
S_INITIAL
 && 
	`lök_sockë_a˘uÆ_deföed
 (&ks->
ªmŸe_addr
))

2631 
lök_sockë_a˘uÆ
 *
éa
 = 
NULL
;

2633 
	`upd©e_time
 ();

2635 i‡(
	`és_¥o˚ss
 (
mu…i
, 
£ssi⁄
, 
to_lök
, &
éa
,

2636 
to_lök_sockë_öfo
, 
wakeup
))

2637 
a˘ive
 = 
TLSMP_ACTIVE
;

2644 i‡(
éa
)

2646 
mu…i
->
to_lök_addr
 = *
éa
;

2647 *
to_lök_addr
 = &
mu…i
->to_link_addr;

2656 i‡(
ks
->
°©e
 =
S_ERROR
)

2658 ++
mu…i
->
n_so·_îr‹s
;

2660 i‡(
i
 =
TM_ACTIVE
)

2661 
îr‹
 = 
åue
;

2663 i‡(
i
 =
TM_ACTIVE


2664 && 
ks_œme
->
°©e
 >
S_ACTIVE


2665 && !
mu…i
->
›t
.
sögÀ_£ssi⁄
)

2666 
	`move_£ssi⁄
 (
mu…i
, 
TM_LAME_DUCK
, 
TM_ACTIVE
, 
åue
);

2668 
	`ª£t_£ssi⁄
 (
mu…i
, 
£ssi⁄
);

2673 
	`upd©e_time
 ();

2675 
ès
 = 
	`és_authítiˇti⁄_°©us
 (
mu…i
, 
TLS_MULTI_AUTH_STATUS_INTERVAL
);

2680 i‡(
	`œme_duck_mu°_dõ
 (&
mu…i
->
£ssi⁄
[
TM_LAME_DUCK
], 
wakeup
)) {

2681 
	`és_£ssi⁄_‰ì
 (&
mu…i
->
£ssi⁄
[
TM_LAME_DUCK
], 
åue
);

2682 
	`msg
 (
D_TLS_DEBUG_LOW
, "TLS:Åls_multi_process: killedÉxpiring key");

2694 i‡(
	`DECRYPT_KEY_ENABLED
 (
mu…i
, &mu…i->
£ssi⁄
[
TM_UNTRUSTED
].
key
[
KS_PRIMARY
])) {

2695 
	`move_£ssi⁄
 (
mu…i
, 
TM_ACTIVE
, 
TM_UNTRUSTED
, 
åue
);

2696 
	`msg
 (
D_TLS_DEBUG_LOW
, "TLS:Åls_multi_process: untrusted sessionÖromotedÅo %strusted",

2697 
ès
 =
TLS_AUTHENTICATION_SUCCEEDED
 ? "" : "semi-");

2704 i‡(
îr‹
)

2706 
i
 = 0; i < (Ë
	`SIZE
 (
mu…i
->
key_sˇn
); ++i)

2708 i‡(
mu…i
->
key_sˇn
[
i
]->
°©e
 >
S_ACTIVE
)

2709 
noh¨d
;

2711 ++
mu…i
->
n_h¨d_îr‹s
;

2713 
noh¨d
:

2715 #ifde‡
ENABLE_DEBUG


2718 c⁄° 
throw_Àvñ
 = 
	`GREMLIN_CONNECTION_FLOOD_LEVEL
 (
mu…i
->
›t
.
gªmlö
);

2719 i‡(
throw_Àvñ
)

2721 
i
 = 0; i < (Ë
	`SIZE
 (
mu…i
->
key_sˇn
); ++i)

2723 i‡(
mu…i
->
key_sˇn
[
i
]->
°©e
 >
throw_Àvñ
)

2725 ++
mu…i
->
n_h¨d_îr‹s
;

2726 ++
mu…i
->
n_so·_îr‹s
;

2733 
	`≥rf_p›
 ();

2734 
	`gc_‰ì
 (&
gc
);

2736  (
ès
 =
TLS_AUTHENTICATION_FAILED
Ë? 
TLSMP_KILL
 : 
a˘ive
;

2737 
	}
}

2769 
boﬁ


2770 
	$és_¥e_de¸y±
 (
és_mu…i
 *
mu…i
,

2771 c⁄° 
lök_sockë_a˘uÆ
 *
‰om
,

2772 
buf„r
 *
buf
,

2773 
¸y±o_›ti⁄s
 *
›t
)

2775 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2776 
boﬁ
 
ªt
 = 
Ál£
;

2778 i‡(
buf
->
Àn
 > 0)

2780 
i
;

2781 
›
;

2782 
key_id
;

2786 
uöt8_t
 
c
 = *
	`BPTR
 (
buf
);

2787 
›
 = 
c
 >> 
P_OPCODE_SHIFT
;

2788 
key_id
 = 
c
 & 
P_KEY_ID_MASK
;

2791 i‡((
›
 =
P_DATA_V1
Ë|| (› =
P_DATA_V2
))

2794 
i
 = 0; i < 
KEY_SCAN_SIZE
; ++i)

2796 
key_°©e
 *
ks
 = 
mu…i
->
key_sˇn
[
i
];

2811 i‡(
	`DECRYPT_KEY_ENABLED
 (
mu…i
, 
ks
)

2812 && 
key_id
 =
ks
->key_id

2813 && 
ks
->
authítiˇãd


2814 #ifde‡
ENABLE_DEF_AUTH


2815 && !
ks
->
auth_de„ºed


2817 && 
	`lök_sockë_a˘uÆ_m©ch
 (
‰om
, &
ks
->
ªmŸe_addr
))

2820 
›t
->
key_˘x_bi
 = &
ks
->
key
;

2821 
›t
->
∑ckë_id
 = 
mu…i
->›t.
ª∂ay
 ? &
ks
->∑ckë_id : 
NULL
;

2822 
›t
->
pid_≥rsi°
 = 
NULL
;

2823 
›t
->
Êags
 &
mu…i
->›t.
¸y±o_Êags_™d
;

2824 
›t
->
Êags
 |
mu…i
->›t.
¸y±o_Êags_‹
;

2826 
	`ASSERT
 (
	`buf_adv™˚
 (
buf
, 1));

2827 i‡(
›
 =
P_DATA_V2
)

2829 i‡(
buf
->
Àn
 < 4)

2831 
	`msg
 (
D_TLS_ERRORS
, "ProtocolÉrror:Ñeceived P_DATA_V2 from %s butÜength is < 4",

2832 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
));

2833 
îr‹
;

2835 
	`ASSERT
 (
	`buf_adv™˚
 (
buf
, 3));

2838 ++
ks
->
n_∑ckës
;

2839 
ks
->
n_byãs
 +
buf
->
Àn
;

2840 
	`dmsg
 (
D_TLS_KEYSELECT
,

2842 
key_id
, 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
));

2843 
	`gc_‰ì
 (&
gc
);

2844  
ªt
;

2849 
	`dmsg
 (
D_TLS_ERRORS
, "TLS_PRE_DECRYPT: [%d] dken=%dÑkid=%dÜkid=%dáuth=%d def=%d match=%d",

2850 
i
,

2851 
	`DECRYPT_KEY_ENABLED
 (
mu…i
, 
ks
),

2852 
key_id
,

2853 
ks
->
key_id
,

2854 
ks
->
authítiˇãd
,

2855 #ifde‡
ENABLE_DEF_AUTH


2856 
ks
->
auth_de„ºed
,

2860 
	`lök_sockë_a˘uÆ_m©ch
 (
‰om
, &
ks
->
ªmŸe_addr
));

2865 
	`msg
 (
D_TLS_ERRORS
,

2867 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
), 
key_id
);

2868 
îr‹_lôe
;

2872 
boﬁ
 
do_bur°
 = 
Ál£
;

2873 
boﬁ
 
√w_lök
 = 
Ál£
;

2874 
£ssi⁄_id
 
sid
;

2877 i‡(
›
 < 
P_FIRST_OPCODE
 || o∞> 
P_LAST_OPCODE
)

2879 
	`msg
 (
D_TLS_ERRORS
,

2881 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
), 
›
);

2882 
îr‹
;

2886 i‡(
	`is_h¨d_ª£t
 (
›
, 0))

2889 i‡(((
›
 =
P_CONTROL_HARD_RESET_CLIENT_V1


2890 || 
›
 =
P_CONTROL_HARD_RESET_CLIENT_V2
Ë&& !
mu…i
->
›t
.
£rvî
)

2891 || ((
›
 =
P_CONTROL_HARD_RESET_SERVER_V1


2892 || 
›
 =
P_CONTROL_HARD_RESET_SERVER_V2
Ë&& 
mu…i
->
›t
.
£rvî
))

2894 
	`msg
 (
D_TLS_ERRORS
,

2896 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
));

2897 
îr‹
;

2904 
	`dmsg
 (
D_TLS_DEBUG
, "TLS: control channel, op=%s, IP=%s",

2905 
	`∑ckë_›code_«me
 (
›
), 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
));

2909 
buf„r
 
tmp
 = *
buf
;

2910 
	`buf_adv™˚
 (&
tmp
, 1);

2911 i‡(!
	`£ssi⁄_id_ªad
 (&
sid
, &
tmp
Ë|| !
	`£ssi⁄_id_deföed
 (&sid))

2913 
	`msg
 (
D_TLS_ERRORS
,

2915 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
));

2916 
îr‹
;

2921 
i
 = 0; i < 
TM_SIZE
; ++i)

2923 
és_£ssi⁄
 *
£ssi⁄
 = &
mu…i
->£ssi⁄[
i
];

2924 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

2926 
	`dmsg
 (
D_TLS_DEBUG
,

2928 
i
,

2929 
	`°©e_«me
 (
ks
->
°©e
),

2930 
	`£ssi⁄_id_¥öt
 (&
£ssi⁄
->
£ssi⁄_id
, &
gc
),

2931 
	`£ssi⁄_id_¥öt
 (&
sid
, &
gc
),

2932 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
),

2933 
	`£ssi⁄_id_¥öt
 (&
ks
->
£ssi⁄_id_ªmŸe
, &
gc
),

2934 
	`¥öt_lök_sockë_a˘uÆ
 (&
ks
->
ªmŸe_addr
, &
gc
));

2936 i‡(
	`£ssi⁄_id_equÆ
 (&
ks
->
£ssi⁄_id_ªmŸe
, &
sid
))

2939 i‡(
i
 =
TM_LAME_DUCK
) {

2940 
	`msg
 (
D_TLS_ERRORS
,

2942 
	`£ssi⁄_id_¥öt
 (&
sid
, &
gc
));

2943 
îr‹
;

2945 
	`dmsg
 (
D_TLS_DEBUG
,

2947 
i
, 
	`£ssi⁄_id_¥öt
 (&
sid
, &
gc
));

2956 i‡(
i
 =
TM_SIZE
 && 
	`is_h¨d_ª£t
 (
›
, 0))

2958 
és_£ssi⁄
 *
£ssi⁄
 = &
mu…i
->£ssi⁄[
TM_ACTIVE
];

2959 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

2961 i‡(!
	`is_h¨d_ª£t
 (
›
, 
mu…i
->
›t
.
key_mëhod
))

2963 
	`msg
 (
D_TLS_ERRORS
, "TLS ERROR: initialÖacketÜocal/remote key_method mismatch,Üocal key_method=%d, op=%s",

2964 
mu…i
->
›t
.
key_mëhod
,

2965 
	`∑ckë_›code_«me
 (
›
));

2966 
îr‹
;

2973 i‡(!
	`£ssi⁄_id_deföed
 (&
ks
->
£ssi⁄_id_ªmŸe
))

2975 i‡(
mu…i
->
›t
.
sögÀ_£ssi⁄
 && mu…i->
n_£ssi⁄s
)

2977 
	`msg
 (
D_TLS_ERRORS
,

2979 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
));

2980 
îr‹
;

2983 #ifde‡
ENABLE_MANAGEMENT


2984 i‡(
m™agemít
)

2986 
	`m™agemít_£t_°©e
 (
m™agemít
,

2987 
OPENVPN_STATE_AUTH
,

2988 
NULL
,

2994 
	`msg
 (
D_TLS_DEBUG_LOW
,

2996 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
),

2997 
	`£ssi⁄_id_¥öt
 (&
sid
, &
gc
));

2999 
do_bur°
 = 
åue
;

3000 
√w_lök
 = 
åue
;

3001 
i
 = 
TM_ACTIVE
;

3002 
£ssi⁄
->
u¡ru°ed_addr
 = *
‰om
;

3006 i‡(
i
 =
TM_SIZE
 && 
	`is_h¨d_ª£t
 (
›
, 0))

3012 
és_£ssi⁄
 *
£ssi⁄
 = &
mu…i
->£ssi⁄[
TM_UNTRUSTED
];

3018 i‡(
mu…i
->
›t
.
sögÀ_£ssi⁄
)

3020 
	`msg
 (
D_TLS_ERRORS
,

3022 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
));

3023 
îr‹
;

3026 i‡(!
	`is_h¨d_ª£t
 (
›
, 
mu…i
->
›t
.
key_mëhod
))

3028 
	`msg
 (
D_TLS_ERRORS
, "TLS ERROR:Çew sessionÜocal/remote key_method mismatch,Üocal key_method=%d, op=%s",

3029 
mu…i
->
›t
.
key_mëhod
,

3030 
	`∑ckë_›code_«me
 (
›
));

3031 
îr‹
;

3034 i‡(!
	`ªad_c⁄åﬁ_auth
 (
buf
, &
£ssi⁄
->
és_auth
, 
‰om
))

3035 
îr‹
;

3043 
	`msg
 (
D_TLS_DEBUG_LOW
,

3045 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
));

3047 
√w_lök
 = 
åue
;

3048 
i
 = 
TM_UNTRUSTED
;

3049 
£ssi⁄
->
u¡ru°ed_addr
 = *
‰om
;

3053 
és_£ssi⁄
 *
£ssi⁄
 = &
mu…i
->£ssi⁄[
i
];

3054 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

3059 i‡(
i
 !
TM_ACTIVE
 && i !
TM_UNTRUSTED
)

3061 
	`msg
 (
D_TLS_ERRORS
,

3063 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
),

3064 
i
,

3065 
	`∑ckë_›code_«me
 (
›
));

3066 
îr‹
;

3072 i‡(!
√w_lök
 && !
	`lök_sockë_a˘uÆ_m©ch
 (&
ks
->
ªmŸe_addr
, 
‰om
))

3074 
	`msg
 (
D_TLS_ERRORS
, "TLS Error: Received controlÖacket from unexpected IPáddr: %s",

3075 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
));

3076 
îr‹
;

3082 i‡(
›
 =
P_CONTROL_SOFT_RESET_V1


3083 && 
	`DECRYPT_KEY_ENABLED
 (
mu…i
, 
ks
))

3085 i‡(!
	`ªad_c⁄åﬁ_auth
 (
buf
, &
£ssi⁄
->
és_auth
, 
‰om
))

3086 
îr‹
;

3088 
	`key_°©e_so·_ª£t
 (
£ssi⁄
);

3090 
	`dmsg
 (
D_TLS_DEBUG
,

3092 
i
, 
	`£ssi⁄_id_¥öt
 (&
sid
, &
gc
));

3099 i‡(
›
 =
P_CONTROL_SOFT_RESET_V1
)

3100 
do_bur°
 = 
åue
;

3102 i‡(!
	`ªad_c⁄åﬁ_auth
 (
buf
, &
£ssi⁄
->
és_auth
, 
‰om
))

3103 
îr‹
;

3105 
	`dmsg
 (
D_TLS_DEBUG
,

3107 
i
, 
	`£ssi⁄_id_¥öt
 (&
sid
, &
gc
));

3117 
és_£ssi⁄
 *
£ssi⁄
 = &
mu…i
->£ssi⁄[
i
];

3118 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

3121 
	`ASSERT
 (
ks
->
°©e
 !
S_UNDEF
);

3122 
	`ASSERT
 (
ks
->
°©e
 !
S_ERROR
);

3123 
	`ASSERT
 (
	`£ssi⁄_id_deföed
 (&
£ssi⁄
->
£ssi⁄_id
));

3126 
ªt
 = 
åue
;

3131 i‡(
√w_lök
)

3133 
ks
->
£ssi⁄_id_ªmŸe
 = 
sid
;

3134 
ks
->
ªmŸe_addr
 = *
‰om
;

3135 ++
mu…i
->
n_£ssi⁄s
;

3137 i‡(!
	`lök_sockë_a˘uÆ_m©ch
 (&
ks
->
ªmŸe_addr
, 
‰om
))

3139 
	`msg
 (
D_TLS_ERRORS
,

3141 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
));

3142 
îr‹
;

3150 i‡(
do_bur°
 && !
£ssi⁄
->
bur°
)

3152 
	`ªlübÀ_scheduÀ_now
 (
ks
->
£nd_ªlübÀ
);

3153 
£ssi⁄
->
bur°
 = 
åue
;

3157 i‡(
ks
->
key_id
 != key_id)

3159 
	`msg
 (
D_TLS_ERRORS
,

3161 
ks
->
key_id
, key_id, 
	`¥öt_key_id
 (
mu…i
, &
gc
));

3162 
îr‹
;

3171 
ªlübÀ_ack
 
£nd_ack
;

3173 
£nd_ack
.
Àn
 = 0;

3174 i‡(!
	`ªlübÀ_ack_ªad
 (&
£nd_ack
, 
buf
, &
£ssi⁄
->
£ssi⁄_id
))

3176 
	`msg
 (
D_TLS_ERRORS
,

3178 
îr‹
;

3180 
	`ªlübÀ_£nd_purge
 (
ks
->
£nd_ªlübÀ
, &
£nd_ack
);

3183 i‡(
›
 !
P_ACK_V1
 && 
	`ªlübÀ_ˇn_gë
 (
ks
->
ªc_ªlübÀ
))

3185 
∑ckë_id_ty≥
 
id
;

3188 i‡(
	`ªlübÀ_ack_ªad_∑ckë_id
 (
buf
, &
id
))

3191 i‡(
	`ªlübÀ_w⁄t_bªak_£quítülôy
 (
ks
->
ªc_ªlübÀ
, 
id
))

3193 i‡(
	`ªlübÀ_nŸ_ª∂ay
 (
ks
->
ªc_ªlübÀ
, 
id
))

3196 
buf„r
 *
ö
 = 
	`ªlübÀ_gë_buf
 (
ks
->
ªc_ªlübÀ
);

3197 
	`ASSERT
 (
ö
);

3198 
	`ASSERT
 (
	`buf_c›y
 (
ö
, 
buf
));

3199 
	`ªlübÀ_m¨k_a˘ive_öcomög
 (
ks
->
ªc_ªlübÀ
, 
ö
, 
id
, 
›
);

3203 
	`ªlübÀ_ack_acknowÀdge_∑ckë_id
 (
ks
->
ªc_ack
, 
id
);

3211 
d⁄e
:

3212 
buf
->
Àn
 = 0;

3213 
›t
->
key_˘x_bi
 = 
NULL
;

3214 
›t
->
∑ckë_id
 = 
NULL
;

3215 
›t
->
pid_≥rsi°
 = 
NULL
;

3216 
›t
->
Êags
 &
mu…i
->›t.
¸y±o_Êags_™d
;

3217 
	`gc_‰ì
 (&
gc
);

3218  
ªt
;

3220 
îr‹
:

3221 ++
mu…i
->
n_so·_îr‹s
;

3222 
îr‹_lôe
:

3223 
	`és_˛ór_îr‹
();

3224 
d⁄e
;

3225 
	}
}

3238 
boﬁ


3239 
	$és_¥e_de¸y±_lôe
 (c⁄° 
és_auth_°™dÆ⁄e
 *
ès
,

3240 c⁄° 
lök_sockë_a˘uÆ
 *
‰om
,

3241 c⁄° 
buf„r
 *
buf
)

3244 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3245 
boﬁ
 
ªt
 = 
Ál£
;

3247 i‡(
buf
->
Àn
 > 0)

3249 
›
;

3250 
key_id
;

3254 
uöt8_t
 
c
 = *
	`BPTR
 (
buf
);

3255 
›
 = 
c
 >> 
P_OPCODE_SHIFT
;

3256 
key_id
 = 
c
 & 
P_KEY_ID_MASK
;

3262 i‡(
›
 !
P_CONTROL_HARD_RESET_CLIENT_V2
)

3267 
	`dmsg
 (
D_TLS_STATE_ERRORS
,

3269 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
),

3270 
›
);

3271 
îr‹
;

3274 i‡(
key_id
 != 0)

3276 
	`dmsg
 (
D_TLS_STATE_ERRORS
,

3278 
key_id
,

3279 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
));

3280 
îr‹
;

3283 i‡(
buf
->
Àn
 > 
	`EXPANDED_SIZE_DYNAMIC
 (&
ès
->
‰ame
))

3285 
	`dmsg
 (
D_TLS_STATE_ERRORS
,

3287 
buf
->
Àn
,

3288 
	`¥öt_lök_sockë_a˘uÆ
 (
‰om
, &
gc
),

3289 
	`EXPANDED_SIZE_DYNAMIC
 (&
ès
->
‰ame
));

3290 
îr‹
;

3294 
buf„r
 
√wbuf
 = 
	`˛⁄e_buf
 (
buf
);

3295 
¸y±o_›ti⁄s
 
co
 = 
ès
->
és_auth_›ti⁄s
;

3296 
boﬁ
 
°©us
;

3303 
co
.
Êags
 |
CO_IGNORE_PACKET_ID
;

3306 
°©us
 = 
	`ªad_c⁄åﬁ_auth
 (&
√wbuf
, &
co
, 
‰om
);

3307 
	`‰ì_buf
 (&
√wbuf
);

3308 i‡(!
°©us
)

3309 
îr‹
;

3327 
ªt
 = 
åue
;

3330 
	`gc_‰ì
 (&
gc
);

3331  
ªt
;

3333 
îr‹
:

3334 
	`és_˛ór_îr‹
();

3335 
	`gc_‰ì
 (&
gc
);

3336  
ªt
;

3337 
	}
}

3341 
	$és_¥e_í¸y±
 (
és_mu…i
 *
mu…i
,

3342 
buf„r
 *
buf
, 
¸y±o_›ti⁄s
 *
›t
)

3344 
mu…i
->
ßve_ks
 = 
NULL
;

3345 i‡(
buf
->
Àn
 > 0)

3347 
i
;

3348 
key_°©e
 *
ks_£À˘
 = 
NULL
;

3349 
i
 = 0; i < 
KEY_SCAN_SIZE
; ++i)

3351 
key_°©e
 *
ks
 = 
mu…i
->
key_sˇn
[
i
];

3352 i‡(
ks
->
°©e
 >
S_ACTIVE


3353 && 
ks
->
authítiˇãd


3354 #ifde‡
ENABLE_DEF_AUTH


3355 && !
ks
->
auth_de„ºed


3359 i‡(!
ks_£À˘
)

3360 
ks_£À˘
 = 
ks
;

3361 i‡(
now
 >
ks
->
auth_de„ºed_expúe
)

3363 
ks_£À˘
 = 
ks
;

3369 i‡(
ks_£À˘
)

3371 
›t
->
key_˘x_bi
 = &
ks_£À˘
->
key
;

3372 
›t
->
∑ckë_id
 = 
mu…i
->›t.
ª∂ay
 ? &
ks_£À˘
->∑ckë_id : 
NULL
;

3373 
›t
->
pid_≥rsi°
 = 
NULL
;

3374 
›t
->
Êags
 &
mu…i
->›t.
¸y±o_Êags_™d
;

3375 
›t
->
Êags
 |
mu…i
->›t.
¸y±o_Êags_‹
;

3376 
mu…i
->
ßve_ks
 = 
ks_£À˘
;

3377 
	`dmsg
 (
D_TLS_KEYSELECT
, "TLS:Åls_¥e_í¸y±: key_id=%d", 
ks_£À˘
->
key_id
);

3382 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3383 
	`dmsg
 (
D_TLS_KEYSELECT
, "TLS Warning:Ço data channel send keyávailable: %s",

3384 
	`¥öt_key_id
 (
mu…i
, &
gc
));

3385 
	`gc_‰ì
 (&
gc
);

3389 
buf
->
Àn
 = 0;

3390 
›t
->
key_˘x_bi
 = 
NULL
;

3391 
›t
->
∑ckë_id
 = 
NULL
;

3392 
›t
->
pid_≥rsi°
 = 
NULL
;

3393 
›t
->
Êags
 &
mu…i
->›t.
¸y±o_Êags_™d
;

3394 
	}
}

3398 
	$és_po°_í¸y±
 (
és_mu…i
 *
mu…i
, 
buf„r
 *
buf
)

3400 
key_°©e
 *
ks
;

3401 
uöt8_t
 *
›
;

3402 
uöt32_t
 
≥î
;

3404 
ks
 = 
mu…i
->
ßve_ks
;

3405 
mu…i
->
ßve_ks
 = 
NULL
;

3406 i‡(
buf
->
Àn
 > 0)

3408 
	`ASSERT
 (
ks
);

3410 i‡(!
mu…i
->
›t
.
£rvî
 && mu…i->
u£_≥î_id
)

3412 
≥î
 = 
	`ht⁄l
(((
P_DATA_V2
 << 
P_OPCODE_SHIFT
Ë| 
ks
->
key_id
Ë<< 24 | (
mu…i
->
≥î_id
 & 0xFFFFFF));

3413 
	`ASSERT
 (
	`buf_wrôe_¥ïíd
 (
buf
, &
≥î
, 4));

3417 
	`ASSERT
 (
›
 = 
	`buf_¥ïíd
 (
buf
, 1));

3418 *
›
 = (
P_DATA_V1
 << 
P_OPCODE_SHIFT
Ë| 
ks
->
key_id
;

3420 ++
ks
->
n_∑ckës
;

3421 
ks
->
n_byãs
 +
buf
->
Àn
;

3423 
	}
}

3430 
boﬁ


3431 
	$és_£nd_∑ylﬂd
 (
és_mu…i
 *
mu…i
,

3432 c⁄° 
uöt8_t
 *
d©a
,

3433 
size
)

3435 
és_£ssi⁄
 *
£ssi⁄
;

3436 
key_°©e
 *
ks
;

3437 
boﬁ
 
ªt
 = 
Ál£
;

3439 
	`és_˛ór_îr‹
();

3441 
	`ASSERT
 (
mu…i
);

3443 
£ssi⁄
 = &
mu…i
->£ssi⁄[
TM_ACTIVE
];

3444 
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

3446 i‡(
ks
->
°©e
 >
S_ACTIVE
)

3448 i‡(
	`key_°©e_wrôe_∂aöãxt_c⁄°
 (&
ks
->
ks_s¶
, 
d©a
, 
size
) == 1)

3449 
ªt
 = 
åue
;

3453 i‡(!
ks
->
∑ybuf
)

3454 
ks
->
∑ybuf
 = 
	`buf„r_li°_√w
 (0);

3455 
	`buf„r_li°_push_d©a
 (
ks
->
∑ybuf
, 
d©a
, (
size_t
)
size
);

3456 
ªt
 = 
åue
;

3460 
	`és_˛ór_îr‹
();

3462  
ªt
;

3463 
	}
}

3465 
boﬁ


3466 
	$és_ªc_∑ylﬂd
 (
és_mu…i
 *
mu…i
,

3467 
buf„r
 *
buf
)

3469 
és_£ssi⁄
 *
£ssi⁄
;

3470 
key_°©e
 *
ks
;

3471 
boﬁ
 
ªt
 = 
Ál£
;

3473 
	`és_˛ór_îr‹
();

3475 
	`ASSERT
 (
mu…i
);

3477 
£ssi⁄
 = &
mu…i
->£ssi⁄[
TM_ACTIVE
];

3478 
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

3480 i‡(
ks
->
°©e
 >
S_ACTIVE
 && 
	`BLEN
 (&ks->
∂aöãxt_ªad_buf
))

3482 i‡(
	`buf_c›y
 (
buf
, &
ks
->
∂aöãxt_ªad_buf
))

3483 
ªt
 = 
åue
;

3484 
ks
->
∂aöãxt_ªad_buf
.
Àn
 = 0;

3487 
	`és_˛ór_îr‹
();

3489  
ªt
;

3490 
	}
}

3497 
	$¥Ÿocﬁ_dump
 (
buf„r
 *buf„r, 
Êags
, 
gc_¨ía
 *
gc
)

3499 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

3500 
buf„r
 
buf
 = *buffer;

3502 
uöt8_t
 
c
;

3503 
›
;

3504 
key_id
;

3506 
és_auth_hmac_size
 = (
Êags
 & 
PD_TLS_AUTH_HMAC_SIZE_MASK
);

3508 i‡(
buf
.
Àn
 <= 0)

3510 
	`buf_¥ötf
 (&
out
, "DATA UNDEFÜí=%d", 
buf
.
Àn
);

3511 
d⁄e
;

3514 i‡(!(
Êags
 & 
PD_TLS
))

3515 
¥öt_d©a
;

3520 i‡(!
	`buf_ªad
 (&
buf
, &
c
,  (c)))

3521 
d⁄e
;

3522 
›
 = (
c
 >> 
P_OPCODE_SHIFT
);

3523 
key_id
 = 
c
 & 
P_KEY_ID_MASK
;

3524 
	`buf_¥ötf
 (&
out
, "%†kid=%d", 
	`∑ckë_›code_«me
 (
›
), 
key_id
);

3526 i‡((
›
 =
P_DATA_V1
Ë|| (› =
P_DATA_V2
))

3527 
¥öt_d©a
;

3533 
£ssi⁄_id
 
sid
;

3535 i‡(!
	`£ssi⁄_id_ªad
 (&
sid
, &
buf
))

3536 
d⁄e
;

3537 i‡(
Êags
 & 
PD_VERBOSE
)

3538 
	`buf_¥ötf
 (&
out
, " sid=%s", 
	`£ssi⁄_id_¥öt
 (&
sid
, 
gc
));

3544 i‡(
és_auth_hmac_size
)

3546 
∑ckë_id_√t
 
pö
;

3547 
uöt8_t
 
és_auth_hmac
[
MAX_HMAC_KEY_LENGTH
];

3549 
	`ASSERT
 (
és_auth_hmac_size
 <
MAX_HMAC_KEY_LENGTH
);

3551 i‡(!
	`buf_ªad
 (&
buf
, 
és_auth_hmac
, 
és_auth_hmac_size
))

3552 
d⁄e
;

3553 i‡(
Êags
 & 
PD_VERBOSE
)

3554 
	`buf_¥ötf
 (&
out
, "Åls_hmac=%s", 
	`f‹m©_hex
 (
és_auth_hmac
, 
és_auth_hmac_size
, 0, 
gc
));

3556 i‡(!
	`∑ckë_id_ªad
 (&
pö
, &
buf
, 
åue
))

3557 
d⁄e
;

3558 
	`buf_¥ötf
(&
out
, "Öid=%s", 
	`∑ckë_id_√t_¥öt
 (&
pö
, (
Êags
 & 
PD_VERBOSE
), 
gc
));

3564 
	`buf_¥ötf
 (&
out
, " %s", 
	`ªlübÀ_ack_¥öt
(&
buf
, (
Êags
 & 
PD_VERBOSE
), 
gc
));

3566 i‡(
›
 =
P_ACK_V1
)

3567 
d⁄e
;

3573 
∑ckë_id_ty≥
 
l
;

3574 i‡(!
	`buf_ªad
 (&
buf
, &
l
,  (l)))

3575 
d⁄e
;

3576 
l
 = 
	`¡ohpid
 (l);

3577 
	`buf_¥ötf
 (&
out
, "Öid=" 
∑ckë_id_f‹m©
, (
∑ckë_id_¥öt_ty≥
)
l
);

3580 
¥öt_d©a
:

3581 i‡(
Êags
 & 
PD_SHOW_DATA
)

3582 
	`buf_¥ötf
 (&
out
, " DATA %s", 
	`f‹m©_hex
 (
	`BPTR
 (&
buf
), 
	`BLEN
 (&buf), 80, 
gc
));

3584 
	`buf_¥ötf
 (&
out
, " DATAÜí=%d", 
buf
.
Àn
);

3586 
d⁄e
:

3587  
	`BSTR
 (&
out
);

3588 
	}
}

3591 
	$dummy
(Ë{
	}
}

	@src/openvpn/ssl.h

30 #i‚de‡
OPENVPN_SSL_H


31 
	#OPENVPN_SSL_H


	)

33 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

35 
	~"basic.h
"

36 
	~"comm⁄.h
"

37 
	~"¸y±o.h
"

38 
	~"∑ckë_id.h
"

39 
	~"£ssi⁄_id.h
"

40 
	~"ªlübÀ.h
"

41 
	~"sockë.h
"

42 
	~"mtu.h
"

43 
	~"›ti⁄s.h
"

44 
	~"∂ugö.h
"

46 
	~"s¶_comm⁄.h
"

47 
	~"s¶_vîify.h
"

48 
	~"s¶_backíd.h
"

51 
	#KEY_EXPANSION_ID
 "O≥nVPN"

	)

54 
	#P_KEY_ID_MASK
 0x07

	)

55 
	#P_OPCODE_SHIFT
 3

	)

58 
	#P_CONTROL_HARD_RESET_CLIENT_V1
 1

	)

59 
	#P_CONTROL_HARD_RESET_SERVER_V1
 2

	)

60 
	#P_CONTROL_SOFT_RESET_V1
 3

	)

61 
	#P_CONTROL_V1
 4

	)

62 
	#P_ACK_V1
 5

	)

63 
	#P_DATA_V1
 6

	)

64 
	#P_DATA_V2
 9

	)

67 
	#P_CONTROL_HARD_RESET_CLIENT_V2
 7

	)

68 
	#P_CONTROL_HARD_RESET_SERVER_V2
 8

	)

71 
	#P_FIRST_OPCODE
 1

	)

72 
	#P_LAST_OPCODE
 9

	)

77 
	#TLS_AGGREGATE_ACK


	)

85 
	#CONTROL_SEND_ACK_MAX
 4

	)

90 
	#TLS_RELIABLE_N_SEND_BUFFERS
 4

	)

91 
	#TLS_RELIABLE_N_REC_BUFFERS
 8

	)

96 
	#TLS_MULTI_REFRESH
 15

	)

97 
	#TLS_MULTI_HORIZON
 2

	)

105 
	#TLS_MULTI_THREAD_SEND_TIMEOUT
 5

	)

108 
	#TLS_MULTI_AUTH_STATUS_INTERVAL
 10

	)

115 
	#TLS_OPTIONS_LEN
 512

	)

118 
	#X509_USERNAME_FIELD_DEFAULT
 "CN"

	)

123 
	#KEY_METHOD_MIN
 1

	)

124 
	#KEY_METHOD_MAX
 2

	)

127 
	#KEY_METHOD_MASK
 0x0F

	)

138 
	sés_auth_°™dÆ⁄e


140 
key_˘x_bi
 
	més_auth_key
;

141 
¸y±o_›ti⁄s
 
	més_auth_›ti⁄s
;

142 
‰ame
 
	m‰ame
;

148 
öô_s¶_lib
 ();

153 
‰ì_s¶_lib
 ();

159 
öô_s¶
 (c⁄° 
›ti⁄s
 *›ti⁄s, 
és_roŸ_˘x
 *
˘x
);

181 
és_mu…i
 *
és_mu…i_öô
 (
és_›ti⁄s
 *tls_options);

197 
és_mu…i_öô_föÆize
(
és_mu…i
 *
mu…i
,

198 c⁄° 
‰ame
 *frame);

203 
és_auth_°™dÆ⁄e
 *
és_auth_°™dÆ⁄e_öô
 (
és_›ti⁄s
 *tls_options,

204 
gc_¨ía
 *
gc
);

209 
és_auth_°™dÆ⁄e_föÆize
 (
és_auth_°™dÆ⁄e
 *
ès
,

210 c⁄° 
‰ame
 *frame);

217 
és_mu…i_öô_£t_›ti⁄s
(
és_mu…i
* 
mu…i
,

218 c⁄° *
loˇl
,

219 c⁄° *
ªmŸe
);

233 
és_mu…i_‰ì
 (
és_mu…i
 *
mu…i
, 
boﬁ
 
˛ór
);

239 
	#TLSMP_INACTIVE
 0

	)

240 
	#TLSMP_ACTIVE
 1

	)

241 
	#TLSMP_KILL
 2

	)

249 
és_mu…i_¥o˚ss
 (
és_mu…i
 *
mu…i
,

250 
buf„r
 *
to_lök
,

251 
lök_sockë_a˘uÆ
 **
to_lök_addr
,

252 
lök_sockë_öfo
 *
to_lök_sockë_öfo
,

253 
öãrvÆ_t
 *
wakeup
);

307 
boﬁ
 
és_¥e_de¸y±
 (
és_mu…i
 *
mu…i
,

308 c⁄° 
lök_sockë_a˘uÆ
 *
‰om
,

309 
buf„r
 *
buf
,

310 
¸y±o_›ti⁄s
 *
›t
);

348 
boﬁ
 
és_¥e_de¸y±_lôe
 (c⁄° 
és_auth_°™dÆ⁄e
 *
ès
,

349 c⁄° 
lök_sockë_a˘uÆ
 *
‰om
,

350 c⁄° 
buf„r
 *
buf
);

366 
és_¥e_í¸y±
 (
és_mu…i
 *
mu…i
,

367 
buf„r
 *
buf
, 
¸y±o_›ti⁄s
 *
›t
);

378 
és_po°_í¸y±
 (
és_mu…i
 *
mu…i
, 
buf„r
 *
buf
);

386 
≥m_∑ssw‹d_£tup
 (c⁄° *
auth_fûe
);

392 
auth_u£r_∑ss_£tup
 (c⁄° *
auth_fûe
, c⁄° 
°©ic_chÆÀnge_öfo
 *
sc_öfo
);

397 
s¶_£t_auth_noˇche
 ();

403 
s¶_purge_auth
 (c⁄° 
boﬁ
 
auth_u£r_∑ss_⁄ly
);

405 
s¶_£t_auth_tokí
 (c⁄° *
tokí
);

407 #ifde‡
ENABLE_CLIENT_CR


413 
s¶_purge_auth_chÆÀnge
 ();

414 
s¶_put_auth_chÆÀnge
 (c⁄° *
¸_°r
);

420 
és_adju°_‰ame_∑ømëîs
(
‰ame
 *frame);

425 
boﬁ
 
és_£nd_∑ylﬂd
 (
és_mu…i
 *
mu…i
,

426 c⁄° 
uöt8_t
 *
d©a
,

427 
size
);

432 
boﬁ
 
és_ªc_∑ylﬂd
 (
és_mu…i
 *
mu…i
,

433 
buf„r
 *
buf
);

435 #ifde‡
MANAGEMENT_DEF_AUTH


436 
ölöe
 *

437 
	$és_gë_≥î_öfo
(c⁄° 
és_mu…i
 *
mu…i
)

439  
mu…i
->
≥î_öfo
;

440 
	}
}

447 
ölöe
 
boﬁ


448 
	$és_öôül_∑ckë_ª˚ived
 (c⁄° 
és_mu…i
 *
mu…i
)

450  
mu…i
->
n_£ssi⁄s
 > 0;

451 
	}
}

453 
ölöe
 
boﬁ


454 
	$és_ã°_auth_de„ºed_öãrvÆ
 (c⁄° 
és_mu…i
 *
mu…i
)

456 i‡(
mu…i
)

458 c⁄° 
key_°©e
 *
ks
 = &
mu…i
->
£ssi⁄
[
TM_ACTIVE
].
key
[
KS_PRIMARY
];

459  
now
 < 
ks
->
auth_de„ºed_expúe
;

461  
Ál£
;

462 
	}
}

464 
ölöe
 

465 
	$és_ã°_∑ylﬂd_Àn
 (c⁄° 
és_mu…i
 *
mu…i
)

467 i‡(
mu…i
)

469 c⁄° 
key_°©e
 *
ks
 = &
mu…i
->
£ssi⁄
[
TM_ACTIVE
].
key
[
KS_PRIMARY
];

470 i‡(
ks
->
°©e
 >
S_ACTIVE
)

471  
	`BLEN
 (&
ks
->
∂aöãxt_ªad_buf
);

474 
	}
}

476 
ölöe
 

477 
	$és_£t_sögÀ_£ssi⁄
 (
és_mu…i
 *
mu…i
)

479 i‡(
mu…i
)

480 
mu…i
->
›t
.
sögÀ_£ssi⁄
 = 
åue
;

481 
	}
}

486 
	#PD_TLS_AUTH_HMAC_SIZE_MASK
 0xFF

	)

487 
	#PD_SHOW_DATA
 (1<<8)

	)

488 
	#PD_TLS
 (1<<9)

	)

489 
	#PD_VERBOSE
 (1<<10)

	)

491 c⁄° *
¥Ÿocﬁ_dump
 (
buf„r
 *buffer,

492 
Êags
,

493 
gc_¨ía
 *
gc
);

499 #ifde‡
MEASURE_TLS_HANDSHAKE_STATS


500 
show_és_≥rf‹m™˚_°©s
();

504 
exåa˘_x509_fõld_ã°
 ();

	@src/openvpn/ssl_backend.h

31 #i‚de‡
SSL_BACKEND_H_


32 
	#SSL_BACKEND_H_


	)

34 
	~"buf„r.h
"

36 #ifde‡
ENABLE_CRYPTO_OPENSSL


37 
	~"s¶_›ís¶.h
"

38 
	~"s¶_vîify_›ís¶.h
"

39 
	#SSLAPI
 
SSLAPI_OPENSSL


	)

41 #ifde‡
ENABLE_CRYPTO_POLARSSL


42 
	~"s¶_pﬁ¨s¶.h
"

43 
	~"s¶_vîify_pﬁ¨s¶.h
"

44 
	#SSLAPI
 
SSLAPI_POLARSSL


	)

48 #i‚de‡
SSLAPI


49 
	#SSLAPI
 
SSLAPI_NONE


	)

55 
	gés_£ssi⁄
;

63 °ru˘ { c⁄° *
	m›ís¶_«me
; c⁄° *
	mü«_«me
; } 
	tés_cùhî_«me_∑ú
;

64 c⁄° 
és_cùhî_«me_∑ú
 *
és_gë_cùhî_«me_∑ú
 (c⁄° *
cùhî_«me
, 
size_t
 
Àn
);

80 
≥m_∑ssw‹d_ˇŒback
 (*
buf
, 
size
, 
rwÊag
, *
u
);

92 
és_öô_lib
();

97 
és_‰ì_lib
();

101 
és_˛ór_îr‹
();

112 
	#TLS_VER_BAD
 -1

	)

113 
	#TLS_VER_UNSPEC
 0

	)

114 
	#TLS_VER_1_0
 1

	)

115 
	#TLS_VER_1_1
 2

	)

116 
	#TLS_VER_1_2
 3

	)

117 
és_vîsi⁄_∑r£
(c⁄° *
v°r
, c⁄° *
exåa
);

125 
és_vîsi⁄_max
();

133 
és_˘x_£rvî_√w
(
és_roŸ_˘x
 *
˘x
, 
s¶_Êags
);

141 
és_˘x_˛õ¡_√w
(
és_roŸ_˘x
 *
˘x
, 
s¶_Êags
);

148 
és_˘x_‰ì
(
és_roŸ_˘x
 *
˘x
);

157 
boﬁ
 
és_˘x_öôüli£d
(
és_roŸ_˘x
 *
˘x
);

168 
és_˘x_£t_›ti⁄s
 (
és_roŸ_˘x
 *
˘x
, 
s¶_Êags
);

176 
és_˘x_ª°ri˘_cùhîs
(
és_roŸ_˘x
 *
˘x
, c⁄° *
cùhîs
);

187 
és_˘x_lﬂd_dh_∑øms
(
és_roŸ_˘x
 *
˘x
, c⁄° *
dh_fûe
,

188 c⁄° *
dh_fûe_ölöe
);

202 
és_˘x_lﬂd_pkcs12
(
és_roŸ_˘x
 *
˘x
, c⁄° *
pkcs12_fûe
,

203 c⁄° *
pkcs12_fûe_ölöe
, 
boﬁ
 
lﬂd_ˇ_fûe


213 #ifde‡
ENABLE_CRYPTOAPI


214 
és_˘x_lﬂd_¸y±ﬂpi
(
és_roŸ_˘x
 *
˘x
, c⁄° *
¸y±ﬂpi_˚π
);

226 
és_˘x_lﬂd_˚π_fûe
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
˚π_fûe
,

227 c⁄° *
˚π_fûe_ölöe
);

240 
és_˘x_lﬂd_¥iv_fûe
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
¥iv_key_fûe
,

241 c⁄° *
¥iv_key_fûe_ölöe


244 #ifde‡
MANAGMENT_EXTERNAL_KEY


258 
és_˘x_u£_exã∫Æ_¥iv©e_key
 (
és_roŸ_˘x
 *
˘x
,

259 c⁄° *
˚π_fûe
, c⁄° *
˚π_fûe_ölöe
);

274 
és_˘x_lﬂd_ˇ
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
ˇ_fûe
,

275 c⁄° *
ˇ_fûe_ölöe
, c⁄° *
ˇ_∑th
, 
boﬁ
 
és_£rvî


289 
és_˘x_lﬂd_exåa_˚πs
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
exåa_˚πs_fûe
,

290 c⁄° *
exåa_˚πs_fûe_ölöe


293 #ifde‡
ENABLE_CRYPTO_POLARSSL


300 
és_˘x_≥rs⁄Æi£_øndom
(
és_roŸ_˘x
 *
˘x
);

318 
key_°©e_s¶_öô
(
key_°©e_s¶
 *
ks_s¶
,

319 c⁄° 
és_roŸ_˘x
 *
s¶_˘x
, 
boﬁ
 
is_£rvî
, 
és_£ssi⁄
 *
£ssi⁄
);

326 
key_°©e_s¶_‰ì
(
key_°©e_s¶
 *
ks_s¶
);

352 
key_°©e_wrôe_∂aöãxt
 (
key_°©e_s¶
 *
ks_s¶
, 
buf„r
 *
buf
);

369 
key_°©e_wrôe_∂aöãxt_c⁄°
 (
key_°©e_s¶
 *
ks_s¶
,

370 c⁄° 
uöt8_t
 *
d©a
, 
Àn
);

390 
key_°©e_ªad_cùhîãxt
 (
key_°©e_s¶
 *
ks_s¶
, 
buf„r
 *
buf
,

391 
maxÀn
);

416 
key_°©e_wrôe_cùhîãxt
 (
key_°©e_s¶
 *
ks_s¶
,

417 
buf„r
 *
buf
);

437 
key_°©e_ªad_∂aöãxt
 (
key_°©e_s¶
 *
ks_s¶
, 
buf„r
 *
buf
,

438 
maxÀn
);

455 
¥öt_dëaûs
 (
key_°©e_s¶
 * 
ks_s¶
, c⁄° *
¥efix
);

463 
show_avaûabÀ_és_cùhîs
 (c⁄° *
és_cùhîs
);

469 
gë_highe°_¥e„ªn˚_és_cùhî
 (*
buf
, 
size
);

475 c⁄° * 
gë_s¶_libøry_vîsi⁄
();

	@src/openvpn/ssl_common.h

30 #i‚de‡
SSL_COMMON_H_


31 
	#SSL_COMMON_H_


	)

33 
	~"£ssi⁄_id.h
"

34 
	~"sockë.h
"

35 
	~"∑ckë_id.h
"

36 
	~"¸y±o.h
"

37 
	~"›ti⁄s.h
"

39 
	~"s¶_backíd.h
"

42 
	#UP_TYPE_AUTH
 "Auth"

	)

43 
	#UP_TYPE_PRIVATE_KEY
 "Priv©êKey"

	)

78 
	#S_ERROR
 -1

	)

79 
	#S_UNDEF
 0

	)

81 
	#S_INITIAL
 1

	)

84 
	#S_PRE_START
 2

	)

87 
	#S_START
 3

	)

89 
	#S_SENT_KEY
 4

	)

91 
	#S_GOT_KEY
 5

	)

94 
	#S_ACTIVE
 6

	)

99 
	#S_NORMAL_OP
 7

	)

109 
	skey_sour˚
 {

110 
uöt8_t
 
	m¥e_ma°î
[48];

113 
uöt8_t
 
	møndom1
[32];

116 
uöt8_t
 
	møndom2
[32];

126 
	skey_sour˚2
 {

127 
key_sour˚
 
	m˛õ¡
;

128 
key_sour˚
 
	m£rvî
;

149 
	skey_°©e


151 
	m°©e
;

152 
	mkey_id
;

154 
key_°©e_s¶
 
	mks_s¶
;

156 
time_t
 
	me°ablished
;

157 
time_t
 
	mmu°_√gŸüã
;

158 
time_t
 
	mmu°_dõ
;

160 
	möôül_›code
;

161 
£ssi⁄_id
 
	m£ssi⁄_id_ªmŸe
;

162 
lök_sockë_a˘uÆ
 
	mªmŸe_addr
;

163 
∑ckë_id
 
	m∑ckë_id
;

165 
key_˘x_bi
 
	mkey
;

167 
key_sour˚2
 *
	mkey_§c
;

169 
buf„r
 
	m∂aöãxt_ªad_buf
;

170 
buf„r
 
	m∂aöãxt_wrôe_buf
;

171 
buf„r
 
	mack_wrôe_buf
;

173 
ªlübÀ
 *
	m£nd_ªlübÀ
;

174 
ªlübÀ
 *
	mªc_ªlübÀ
;

175 
ªlübÀ_ack
 *
	mªc_ack
;

177 
buf„r_li°
 *
	m∑ybuf
;

179 
cou¡î_ty≥
 
	mn_byãs
;

180 
cou¡î_ty≥
 
	mn_∑ckës
;

185 
boﬁ
 
	mauthítiˇãd
;

186 
time_t
 
	mauth_de„ºed_expúe
;

188 #ifde‡
ENABLE_DEF_AUTH


190 
boﬁ
 
	mauth_de„ºed
;

191 #ifde‡
MANAGEMENT_DEF_AUTH


192 
	mmda_key_id
;

193 
	mmda_°©us
;

195 #ifde‡
PLUGIN_DEF_AUTH


196 
	mauth_c⁄åﬁ_°©us
;

197 
time_t
 
	macf_œ°_mod
;

198 *
	mauth_c⁄åﬁ_fûe
;

207 
	sés_›ti⁄s


210 
és_roŸ_˘x
 
	ms¶_˘x
;

213 
key_ty≥
 
	mkey_ty≥
;

216 
boﬁ
 
	m£rvî
;

219 
boﬁ
 
	mxmô_hﬁd
;

221 #ifde‡
ENABLE_OCC


224 c⁄° *
	mloˇl_›ti⁄s
;

225 c⁄° *
	mªmŸe_›ti⁄s
;

229 
	mkey_mëhod
;

230 
boﬁ
 
	mª∂ay
;

231 
boﬁ
 
	msögÀ_£ssi⁄
;

232 #ifde‡
ENABLE_OCC


233 
boﬁ
 
	mdißbÀ_occ
;

235 #ifde‡
ENABLE_PUSH_PEER_INFO


236 
	mpush_≥î_öfo_dëaû
;

238 
	må™sôi⁄_wödow
;

239 
	mh™dshake_wödow
;

240 
öãrvÆ_t
 
	m∑ckë_timeout
;

241 
	mª√gŸüã_byãs
;

242 
	mª√gŸüã_∑ckës
;

243 
öãrvÆ_t
 
	mª√gŸüã_£c⁄ds
;

246 c⁄° *
	mvîify_comm™d
;

247 c⁄° *
	mvîify_exp‹t_˚π
;

248 
	mvîify_x509_ty≥
;

249 c⁄° *
	mvîify_x509_«me
;

250 c⁄° *
	m¸l_fûe
;

251 
	mns_˚π_ty≥
;

252 
	mªmŸe_˚π_ku
[
MAX_PARMS
];

253 c⁄° *
	mªmŸe_˚π_eku
;

254 
uöt8_t
 *
	mvîify_hash
;

255 *
	mx509_u£∫ame_fõld
;

259 
boﬁ
 
	m∑ss_c⁄fig_öfo
;

262 
	m¸y±o_Êags_™d
;

263 
	m¸y±o_Êags_‹
;

265 
	mª∂ay_wödow
;

266 
	mª∂ay_time
;

267 
boﬁ
 
	mt˝_mode
;

270 
¸y±o_›ti⁄s
 
	més_auth
;

271 
key_˘x_bi
 
	més_auth_key
;

274 
‰ame
 
	m‰ame
;

277 c⁄° *
	mauth_u£r_∑ss_vîify_s¸ùt
;

278 
boﬁ
 
	mauth_u£r_∑ss_vîify_s¸ùt_vü_fûe
;

279 c⁄° *
	mtmp_dú
;

282 c⁄° *
	m˛õ¡_c⁄fig_dú_ex˛usive
;

285 
ív_£t
 *
	mes
;

286 c⁄° 
∂ugö_li°
 *
	m∂ugös
;

289 
	#SSLF_CLIENT_CERT_NOT_REQUIRED
 (1<<0)

	)

290 
	#SSLF_USERNAME_AS_COMMON_NAME
 (1<<1)

	)

291 
	#SSLF_AUTH_USER_PASS_OPTIONAL
 (1<<2)

	)

292 
	#SSLF_OPT_VERIFY
 (1<<4)

	)

293 
	#SSLF_CRL_VERIFY_DIR
 (1<<5)

	)

294 
	#SSLF_TLS_VERSION_MIN_SHIFT
 6

	)

295 
	#SSLF_TLS_VERSION_MIN_MASK
 0xF

	)

296 
	#SSLF_TLS_VERSION_MAX_SHIFT
 10

	)

297 
	#SSLF_TLS_VERSION_MAX_MASK
 0xF

	)

298 
	ms¶_Êags
;

300 #ifde‡
MANAGEMENT_DEF_AUTH


301 
m™_def_auth_c⁄ãxt
 *
	mmda_c⁄ãxt
;

304 #ifde‡
ENABLE_X509_TRACK


305 c⁄° 
x509_åack
 *
	mx509_åack
;

308 #ifde‡
ENABLE_CLIENT_CR


309 c⁄° 
°©ic_chÆÀnge_öfo
 *
	msci
;

313 
	mgªmlö
;

323 
	#KS_PRIMARY
 0

	)

324 
	#KS_LAME_DUCK
 1

	)

326 
	#KS_SIZE
 2

	)

347 
	sés_£ssi⁄


350 
és_›ti⁄s
 *
	m›t
;

353 
boﬁ
 
	mbur°
;

356 
¸y±o_›ti⁄s
 
	més_auth
;

357 
∑ckë_id
 
	més_auth_pid
;

359 
	möôül_›code
;

360 
£ssi⁄_id
 
	m£ssi⁄_id
;

361 
	mkey_id
;

363 
	mlimô_√xt
;

365 
	mvîify_maxÀvñ
;

367 *
	mcomm⁄_«me
;

369 
˚π_hash_£t
 *
	m˚π_hash_£t
;

371 #ifde‡
ENABLE_PF


372 
uöt32_t
 
	mcomm⁄_«me_hashvÆ
;

375 
boﬁ
 
	mvîifõd
;

378 
lök_sockë_a˘uÆ
 
	mu¡ru°ed_addr
;

380 
key_°©e
 
	mkey
[
KS_SIZE
];

400 
	#TM_ACTIVE
 0

	)

401 
	#TM_UNTRUSTED
 1

	)

403 
	#TM_LAME_DUCK
 2

	)

404 
	#TM_SIZE
 3

	)

420 
	#KEY_SCAN_SIZE
 3

	)

436 
	sés_mu…i


442 
és_›ti⁄s
 
	m›t
;

444 
key_°©e
* 
	mkey_sˇn
[
KEY_SCAN_SIZE
];

453 
key_°©e
 *
	mßve_ks
;

459 
lök_sockë_a˘uÆ
 
	mto_lök_addr
;

461 
	mn_£ssi⁄s
;

467 
	mn_h¨d_îr‹s
;

468 
	mn_so·_îr‹s
;

473 *
	mlocked_˙
;

474 *
	mlocked_u£∫ame
;

475 
˚π_hash_£t
 *
	mlocked_˚π_hash_£t
;

477 #ifde‡
ENABLE_DEF_AUTH


481 *
	m˛õ¡_ªas⁄
;

487 *
	m≥î_öfo
;

490 
time_t
 
	mès_œ°
;

494 
uöt32_t
 
	m≥î_id
;

495 
boﬁ
 
	mu£_≥î_id
;

500 
és_£ssi⁄
 
	m£ssi⁄
[
TM_SIZE
];

	@src/openvpn/ssl_openssl.c

30 #ifde‡
HAVE_CONFIG_H


31 
	~"c⁄fig.h
"

32 #ñi‡
deföed
(
_MSC_VER
)

33 
	~"c⁄fig-msvc.h
"

36 
	~"syshód.h
"

38 #i‡
deföed
(
ENABLE_SSL
Ë&& deföed(
ENABLE_CRYPTO_OPENSSL
)

40 
	~"îæevñ.h
"

41 
	~"buf„r.h
"

42 
	~"misc.h
"

43 
	~"m™age.h
"

44 
	~"memdbg.h
"

45 
	~"s¶_backíd.h
"

46 
	~"s¶_comm⁄.h
"

47 
	~"ba£64.h
"

49 #ifde‡
ENABLE_CRYPTOAPI


50 
	~"¸y±ﬂpi.h
"

53 
	~"s¶_vîify_›ís¶.h
"

55 
	~<›ís¶/îr.h
>

56 
	~<›ís¶/pkcs12.h
>

57 
	~<›ís¶/x509.h
>

58 
	~<›ís¶/¸y±o.h
>

66 
	gmyd©a_ödex
;

69 
	$és_öô_lib
()

71 
	`SSL_libøry_öô
();

72 #i‚de‡
ENABLE_SMALL


73 
	`SSL_lﬂd_îr‹_°rögs
();

75 
	`O≥nSSL_add_Æl_Æg‹ôhms
 ();

77 
myd©a_ödex
 = 
	`SSL_gë_ex_√w_ödex
(0, "°ru˘ sessi⁄ *", 
NULL
, NULL, NULL);

78 
	`ASSERT
 (
myd©a_ödex
 >= 0);

79 
	}
}

82 
	$és_‰ì_lib
()

84 
	`EVP_˛ónup
();

85 #i‚de‡
ENABLE_SMALL


86 
	`ERR_‰ì_°rögs
();

88 
	}
}

91 
	$és_˛ór_îr‹
()

93 
	`ERR_˛ór_îr‹
 ();

94 
	}
}

100 
RSA
 *

101 
	$tmp_rß_cb
 (
SSL
 * 
s
, 
is_exp‹t
, 
keyÀngth
)

103 
RSA
 *
rß_tmp
 = 
NULL
;

104 i‡(
rß_tmp
 =
NULL
)

106 
ªt
 = -1;

107 
BIGNUM
 *
bn
 = 
	`BN_√w
();

108 
rß_tmp
 = 
	`RSA_√w
();

110 
	`msg
 (
D_HANDSHAKE
, "Gíî©ögÅem∞(%d bôËRSA key", 
keyÀngth
);

112 if(!
bn
 || !
	`BN_£t_w‹d
(bn, 
RSA_F4
) ||

113 !
	`RSA_gíî©e_key_ex
(
rß_tmp
, 
keyÀngth
, 
bn
, 
NULL
))

114 
	`msg
(
M_SSLERR
, "FailedÅo generateÅemp RSA key");

116 i‡(
bn
Ë
	`BN_‰ì
( bn );

118  (
rß_tmp
);

119 
	}
}

122 
	$és_˘x_£rvî_√w
(
és_roŸ_˘x
 *
˘x
, 
s¶_Êags
)

124 c⁄° 
és_vîsi⁄_mö
 =

125 (
s¶_Êags
 >> 
SSLF_TLS_VERSION_MIN_SHIFT
Ë& 
SSLF_TLS_VERSION_MIN_MASK
;

127 
	`ASSERT
(
NULL
 !
˘x
);

129 i‡(
és_vîsi⁄_mö
 > 
TLS_VER_UNSPEC
)

130 
˘x
->˘x = 
	`SSL_CTX_√w
 (
	`SSLv23_£rvî_mëhod
 ());

132 
˘x
->˘x = 
	`SSL_CTX_√w
 (
	`TLSv1_£rvî_mëhod
 ());

134 i‡(
˘x
->˘x =
NULL
)

135 
	`msg
 (
M_SSLERR
, "SSL_CTX_new SSLv23_server_method");

137 
	`SSL_CTX_£t_tmp_rß_ˇŒback
 (
˘x
->˘x, 
tmp_rß_cb
);

138 
	}
}

141 
	$és_˘x_˛õ¡_√w
(
és_roŸ_˘x
 *
˘x
, 
s¶_Êags
)

143 c⁄° 
és_vîsi⁄_mö
 =

144 (
s¶_Êags
 >> 
SSLF_TLS_VERSION_MIN_SHIFT
Ë& 
SSLF_TLS_VERSION_MIN_MASK
;

146 
	`ASSERT
(
NULL
 !
˘x
);

148 i‡(
és_vîsi⁄_mö
 > 
TLS_VER_UNSPEC
)

149 
˘x
->˘x = 
	`SSL_CTX_√w
 (
	`SSLv23_˛õ¡_mëhod
 ());

151 
˘x
->˘x = 
	`SSL_CTX_√w
 (
	`TLSv1_˛õ¡_mëhod
 ());

153 i‡(
˘x
->˘x =
NULL
)

154 
	`msg
 (
M_SSLERR
, "SSL_CTX_new SSLv23_client_method");

155 
	}
}

158 
	$és_˘x_‰ì
(
és_roŸ_˘x
 *
˘x
)

160 
	`ASSERT
(
NULL
 !
˘x
);

161 i‡(
NULL
 !
˘x
->ctx)

162 
	`SSL_CTX_‰ì
 (
˘x
->ctx);

163 
˘x
->˘x = 
NULL
;

164 
	}
}

166 
boﬁ
 
	$és_˘x_öôüli£d
(
és_roŸ_˘x
 *
˘x
)

168 
	`ASSERT
(
NULL
 !
˘x
);

169  
NULL
 !
˘x
->ctx;

170 
	}
}

176 #i‚de‡
INFO_CALLBACK_SSL_CONST


177 
	#INFO_CALLBACK_SSL_CONST
 c⁄°

	)

180 
	$öfo_ˇŒback
 (
INFO_CALLBACK_SSL_CONST
 
SSL
 * 
s
, 
whîe
, 
ªt
)

182 i‡(
whîe
 & 
SSL_CB_LOOP
)

184 
	`dmsg
 (
D_HANDSHAKE_VERBOSE
, "SSL state (%s): %s",

185 
whîe
 & 
SSL_ST_CONNECT
 ? "connect" :

186 
whîe
 & 
SSL_ST_ACCEPT
 ? "accept" :

187 "undeföed", 
	`SSL_°©e_°rög_l⁄g
 (
s
));

189 i‡(
whîe
 & 
SSL_CB_ALERT
)

191 
	`dmsg
 (
D_HANDSHAKE_VERBOSE
, "SSLálert (%s): %s: %s",

192 
whîe
 & 
SSL_CB_READ
 ? "read" : "write",

193 
	`SSL_Æît_ty≥_°rög_l⁄g
 (
ªt
),

194 
	`SSL_Æît_desc_°rög_l⁄g
 (
ªt
));

196 
	}
}

204 
	$és_vîsi⁄_max
()

206 #i‡
	`deföed
(
SSL_OP_NO_TLSv1_2
)

207  
TLS_VER_1_2
;

208 #ñi‡
	`deföed
(
SSL_OP_NO_TLSv1_1
)

209  
TLS_VER_1_1
;

211  
TLS_VER_1_0
;

213 
	}
}

216 
	$és_˘x_£t_›ti⁄s
 (
és_roŸ_˘x
 *
˘x
, 
s¶_Êags
)

218 
	`ASSERT
(
NULL
 !
˘x
);

222 
s¶›t
 = 
SSL_OP_SINGLE_DH_USE
 | 
SSL_OP_NO_TICKET
 | 
SSL_OP_NO_SSLv2
 | 
SSL_OP_NO_SSLv3
;

223 c⁄° 
és_vî_mö
 =

224 (
s¶_Êags
 >> 
SSLF_TLS_VERSION_MIN_SHIFT
Ë& 
SSLF_TLS_VERSION_MIN_MASK
;

225 
és_vî_max
 =

226 (
s¶_Êags
 >> 
SSLF_TLS_VERSION_MAX_SHIFT
Ë& 
SSLF_TLS_VERSION_MAX_MASK
;

228 i‡(
és_vî_max
 <
TLS_VER_UNSPEC
)

229 
és_vî_max
 = 
	`és_vîsi⁄_max
();

231 i‡(
és_vî_mö
 > 
TLS_VER_1_0
 || 
és_vî_max
 < TLS_VER_1_0)

232 
s¶›t
 |
SSL_OP_NO_TLSv1
;

233 #ifde‡
SSL_OP_NO_TLSv1_1


234 i‡(
és_vî_mö
 > 
TLS_VER_1_1
 || 
és_vî_max
 < TLS_VER_1_1)

235 
s¶›t
 |
SSL_OP_NO_TLSv1_1
;

237 #ifde‡
SSL_OP_NO_TLSv1_2


238 i‡(
és_vî_mö
 > 
TLS_VER_1_2
 || 
és_vî_max
 < TLS_VER_1_2)

239 
s¶›t
 |
SSL_OP_NO_TLSv1_2
;

241 
	`SSL_CTX_£t_›ti⁄s
 (
˘x
->˘x, 
s¶›t
);

244 
	`SSL_CTX_£t_£ssi⁄_ˇche_mode
 (
˘x
->˘x, 
SSL_SESS_CACHE_OFF
);

245 
	`SSL_CTX_£t_deÁu…_∑sswd_cb
 (
˘x
->˘x, 
≥m_∑ssw‹d_ˇŒback
);

248 #i‡
P2MP_SERVER


249 i‡(
s¶_Êags
 & 
SSLF_CLIENT_CERT_NOT_REQUIRED
)

251 
	`msg
 (
M_WARN
, "WARNING: POTENTIALLY DANGEROUS OPTION "

257 
	`SSL_CTX_£t_vîify
 (
˘x
->˘x, 
SSL_VERIFY_PEER
 | 
SSL_VERIFY_FAIL_IF_NO_PEER_CERT
,

258 
vîify_ˇŒback
);

260 
	`SSL_CTX_£t_öfo_ˇŒback
 (
˘x
->˘x, 
öfo_ˇŒback
);

261 
	}
}

264 
	$és_˘x_ª°ri˘_cùhîs
(
és_roŸ_˘x
 *
˘x
, c⁄° *
cùhîs
)

266 
size_t
 
begö_of_cùhî
, 
íd_of_cùhî
;

268 c⁄° *
cuºít_cùhî
;

269 
size_t
 
cuºít_cùhî_Àn
;

271 c⁄° 
és_cùhî_«me_∑ú
 *
cùhî_∑ú
;

273 
›ís¶_cùhîs
[4096];

274 
size_t
 
›ís¶_cùhîs_Àn
 = 0;

275 
›ís¶_cùhîs
[0] = '\0';

277 
	`ASSERT
(
NULL
 !
˘x
);

280 
begö_of_cùhî
 = 
íd_of_cùhî
 = 0;

281 ; 
begö_of_cùhî
 < 
	`°æí
(
cùhîs
); begö_of_cùhî = 
íd_of_cùhî
) {

282 
íd_of_cùhî
 +
	`°rc•n
(&
cùhîs
[
begö_of_cùhî
], ":");

283 
cùhî_∑ú
 = 
	`és_gë_cùhî_«me_∑ú
(&
cùhîs
[
begö_of_cùhî
], 
íd_of_cùhî
 - begin_of_cipher);

285 i‡(
NULL
 =
cùhî_∑ú
)

288 
cuºít_cùhî
 = &
cùhîs
[
begö_of_cùhî
];

289 
cuºít_cùhî_Àn
 = 
íd_of_cùhî
 - 
begö_of_cùhî
;

294 
	`msg
 (
M_WARN
, "No validÅranslation found for TLS cipher '%.*s'",

295 (Ë
	`MIN
(
cuºít_cùhî_Àn
, 256), 
cuºít_cùhî
);

300 
cuºít_cùhî
 = 
cùhî_∑ú
->
›ís¶_«me
;

301 
cuºít_cùhî_Àn
 = 
	`°æí
(
cuºít_cùhî
);

303 i‡(
íd_of_cùhî
 - 
begö_of_cùhî
 =
cuºít_cùhî_Àn
 &&

304 0 =
	`memcmp
 (&
cùhîs
[
begö_of_cùhî
], 
cùhî_∑ú
->
›ís¶_«me
, 
íd_of_cùhî
 - begin_of_cipher))

307 
	`msg
 (
M_WARN
, "Dïªˇãd TLS cùhîÇamê'%s',ÖÀa£ u£ IANAÇamê'%s'", 
cùhî_∑ú
->
›ís¶_«me
, cùhî_∑ú->
ü«_«me
);

312 i‡((((
›ís¶_cùhîs
)-1Ë- 
›ís¶_cùhîs_Àn
Ë< 
cuºít_cùhî_Àn
) {

313 
	`msg
(
M_SSLERR
, "FaûedÅÿ£àª°ri˘ed TLS cùhîÜi°,Åoÿl⁄g (>%d).", ()(
›ís¶_cùhîs
)-1);

317 
	`mem˝y
(&
›ís¶_cùhîs
[
›ís¶_cùhîs_Àn
], 
cuºít_cùhî
, 
cuºít_cùhî_Àn
);

318 
›ís¶_cùhîs_Àn
 +
cuºít_cùhî_Àn
;

319 
›ís¶_cùhîs
[
›ís¶_cùhîs_Àn
] = ':';

320 
›ís¶_cùhîs_Àn
++;

322 
íd_of_cùhî
++;

325 i‡(
›ís¶_cùhîs_Àn
 > 0)

326 
›ís¶_cùhîs
[
›ís¶_cùhîs_Àn
-1] = '\0';

329 if(!
	`SSL_CTX_£t_cùhî_li°
(
˘x
->˘x, 
›ís¶_cùhîs
))

330 
	`msg
(
M_SSLERR
, "FaûedÅÿ£àª°ri˘ed TLS cùhîÜi°: %s", 
›ís¶_cùhîs
);

331 
	}
}

334 
	$és_˘x_lﬂd_dh_∑øms
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
dh_fûe
,

335 c⁄° *
dh_fûe_ölöe


338 
DH
 *
dh
;

339 
BIO
 *
bio
;

341 
	`ASSERT
(
NULL
 !
˘x
);

343 i‡(!
	`°rcmp
 (
dh_fûe
, 
INLINE_FILE_TAG
Ë&& 
dh_fûe_ölöe
)

345 i‡(!(
bio
 = 
	`BIO_√w_mem_buf
 ((*)
dh_fûe_ölöe
, -1)))

346 
	`msg
 (
M_SSLERR
, "Cannot open memory BIO for inline DHÖarameters");

351 i‡(!(
bio
 = 
	`BIO_√w_fûe
 (
dh_fûe
, "r")))

352 
	`msg
 (
M_SSLERR
, "C™nŸ o≥¿%†f‹ DHÖ¨amëîs", 
dh_fûe
);

355 
dh
 = 
	`PEM_ªad_bio_DH∑øms
 (
bio
, 
NULL
, NULL, NULL);

356 
	`BIO_‰ì
 (
bio
);

358 i‡(!
dh
)

359 
	`msg
 (
M_SSLERR
, "C™nŸÜﬂd DHÖ¨amëî†‰om %s", 
dh_fûe
);

360 i‡(!
	`SSL_CTX_£t_tmp_dh
 (
˘x
->˘x, 
dh
))

361 
	`msg
 (
M_SSLERR
, "SSL_CTX_set_tmp_dh");

363 
	`msg
 (
D_TLS_DEBUG_LOW
, "Diffie-Hellman initialized with %d bit key",

364 8 * 
	`DH_size
 (
dh
));

366 
	`DH_‰ì
 (
dh
);

367 
	}
}

370 
	$és_˘x_lﬂd_pkcs12
(
és_roŸ_˘x
 *
˘x
, c⁄° *
pkcs12_fûe
,

371 c⁄° *
pkcs12_fûe_ölöe
,

372 
boﬁ
 
lﬂd_ˇ_fûe


375 
FILE
 *
Â
;

376 
EVP_PKEY
 *
pkey
;

377 
X509
 *
˚π
;

378 
	`STACK_OF
(
X509
Ë*
ˇ
 = 
NULL
;

379 
PKCS12
 *
p12
;

380 
i
;

381 
∑ssw‹d
[256];

383 
	`ASSERT
(
NULL
 !
˘x
);

385 i‡(!
	`°rcmp
 (
pkcs12_fûe
, 
INLINE_FILE_TAG
Ë&& 
pkcs12_fûe_ölöe
)

387 
BIO
 *
b64
 = 
	`BIO_√w
(
	`BIO_f_ba£64
());

388 
BIO
 *
bio
 = 
	`BIO_√w_mem_buf
((*Ë
pkcs12_fûe_ölöe
,

389 (Ë
	`°æí
(
pkcs12_fûe_ölöe
));

390 
	`ASSERT
(
b64
 && 
bio
);

391 
	`BIO_push
(
b64
, 
bio
);

392 
p12
 = 
	`d2i_PKCS12_bio
(
b64
, 
NULL
);

393 i‡(!
p12
)

394 
	`msg
(
M_SSLERR
, "ErrorÑeading inline PKCS#12 file");

395 
	`BIO_‰ì
(
b64
);

396 
	`BIO_‰ì
(
bio
);

401 i‡(!(
Â
 = 
	`∂©f‹m_f›í
(
pkcs12_fûe
, "rb")))

402 
	`msg
(
M_SSLERR
, "Eº‹ o≥nög fûê%s", 
pkcs12_fûe
);

403 
p12
 = 
	`d2i_PKCS12_Â
(
Â
, 
NULL
);

404 
	`f˛o£
(
Â
);

405 i‡(!
p12
)

406 
	`msg
(
M_SSLERR
, "Eº‹Ñódög PKCS#12 fûê%s", 
pkcs12_fûe
);

410 i‡(!
	`PKCS12_∑r£
(
p12
, "", &
pkey
, &
˚π
, &
ˇ
))

412 
	`≥m_∑ssw‹d_ˇŒback
 (
∑ssw‹d
, ’assw‹dË- 1, 0, 
NULL
);

414 
ˇ
 = 
NULL
;

415 i‡(!
	`PKCS12_∑r£
(
p12
, 
∑ssw‹d
, &
pkey
, &
˚π
, &
ˇ
))

417 #ifde‡
ENABLE_MANAGEMENT


418 i‡(
m™agemít
 && (
	`ERR_GET_REASON
 (
	`ERR_≥ek_îr‹
()Ë=
PKCS12_R_MAC_VERIFY_FAILURE
))

419 
	`m™agemít_auth_Áûuª
 (
m™agemít
, 
UP_TYPE_PRIVATE_KEY
, 
NULL
);

421 
	`PKCS12_‰ì
(
p12
);

425 
	`PKCS12_‰ì
(
p12
);

428 i‡(!
	`SSL_CTX_u£_˚πifiˇã
 (
˘x
->˘x, 
˚π
))

429 
	`msg
 (
M_SSLERR
, "Cannot use certificate");

432 i‡(!
	`SSL_CTX_u£_Priv©eKey
 (
˘x
->˘x, 
pkey
))

433 
	`msg
 (
M_SSLERR
, "Cannot useÖrivate key");

434 
	`w¨n_if_group_Ÿhîs_ac˚ssibÀ
 (
pkcs12_fûe
);

437 i‡(!
	`SSL_CTX_check_¥iv©e_key
 (
˘x
->ctx))

438 
	`msg
 (
M_SSLERR
, "Private key doesÇot matchÅhe certificate");

441 i‡(
lﬂd_ˇ_fûe
)

447 i‡(
ˇ
 && 
	`sk_X509_num
(ca))

449 
i
 = 0; i < 
	`sk_X509_num
(
ˇ
); i++)

451 i‡(!
	`X509_STORE_add_˚π
(
˘x
->˘x->
˚π_°‹e
,
	`sk_X509_vÆue
(
ˇ
, 
i
)))

452 
	`msg
 (
M_SSLERR
, "Cannotádd certificateÅo certificate chain (X509_STORE_add_cert)");

453 i‡(!
	`SSL_CTX_add_˛õ¡_CA
(
˘x
->˘x, 
	`sk_X509_vÆue
(
ˇ
, 
i
)))

454 
	`msg
 (
M_SSLERR
, "Cannotádd certificateÅo client CAÜist (SSL_CTX_add_client_CA)");

463 i‡(
ˇ
 && 
	`sk_X509_num
(ca))

465 
i
 = 0; i < 
	`sk_X509_num
(
ˇ
); i++)

467 i‡(!
	`SSL_CTX_add_exåa_chaö_˚π
(
˘x
->˘x,
	`sk_X509_vÆue
(
ˇ
, 
i
)))

468 
	`msg
 (
M_SSLERR
, "CannotáddÉxtra certificateÅo chain (SSL_CTX_add_extra_chain_cert)");

473 
	}
}

475 #ifde‡
ENABLE_CRYPTOAPI


477 
	$és_˘x_lﬂd_¸y±ﬂpi
(
és_roŸ_˘x
 *
˘x
, c⁄° *
¸y±ﬂpi_˚π
)

479 
	`ASSERT
(
NULL
 !
˘x
);

482 i‡(!
	`SSL_CTX_u£_Cry±oAPI_˚πifiˇã
 (
˘x
->˘x, 
¸y±ﬂpi_˚π
))

483 
	`msg
 (
M_SSLERR
, "CannotÜoad certificate \"%s\" from Microsoft Certificate Store",

484 
¸y±ﬂpi_˚π
);

485 
	}
}

489 
	$és_˘x_add_exåa_˚πs
 (
és_roŸ_˘x
 *
˘x
, 
BIO
 *
bio
)

491 
X509
 *
˚π
;

494 
˚π
 = 
NULL
;

495 i‡(!
	`PEM_ªad_bio_X509
 (
bio
, &
˚π
, 0, 
NULL
))

497 i‡(!
˚π
)

498 
	`msg
 (
M_SSLERR
, "ErrorÑeadingÉxtra certificate");

499 i‡(
	`SSL_CTX_add_exåa_chaö_˚π
(
˘x
->˘x, 
˚π
) != 1)

500 
	`msg
 (
M_SSLERR
, "ErroráddingÉxtra certificate");

502 
	}
}

506 
	$és_˘x_lﬂd_˚π_fûe_™d_c›y
 (
és_roŸ_˘x
 *
˘x
,

507 c⁄° *
˚π_fûe
, c⁄° *
˚π_fûe_ölöe
, 
X509
 **
x509


510 
BIO
 *
ö
 = 
NULL
;

511 
X509
 *
x
 = 
NULL
;

512 
ªt
 = 0;

513 
boﬁ
 
ölöe_fûe
 = 
Ál£
;

515 
	`ASSERT
 (
NULL
 !
˘x
);

516 i‡(
NULL
 !
x509
)

517 
	`ASSERT
 (
NULL
 =*
x509
);

519 
ölöe_fûe
 = (
	`°rcmp
 (
˚π_fûe
, 
INLINE_FILE_TAG
) == 0);

521 i‡(
ölöe_fûe
 && 
˚π_fûe_ölöe
)

522 
ö
 = 
	`BIO_√w_mem_buf
 ((*)
˚π_fûe_ölöe
, -1);

524 
ö
 = 
	`BIO_√w_fûe
 (
˚π_fûe
, "r");

526 i‡(
ö
 =
NULL
)

528 
	`SSLîr
 (
SSL_F_SSL_CTX_USE_CERTIFICATE_FILE
, 
ERR_R_SYS_LIB
);

529 
íd
;

532 
x
 = 
	`PEM_ªad_bio_X509
 (
ö
, 
NULL
, 
˘x
->˘x->
deÁu…_∑sswd_ˇŒback
,

533 
˘x
->˘x->
deÁu…_∑sswd_ˇŒback_u£rd©a
);

534 i‡(
x
 =
NULL
)

536 
	`SSLîr
 (
SSL_F_SSL_CTX_USE_CERTIFICATE_FILE
, 
ERR_R_PEM_LIB
);

537 
íd
;

540 
ªt
 = 
	`SSL_CTX_u£_˚πifiˇã
 (
˘x
->˘x, 
x
);

541 i‡(
ªt
)

542 
	`és_˘x_add_exåa_˚πs
 (
˘x
, 
ö
);

544 
íd
:

545 i‡(!
ªt
)

547 i‡(
ölöe_fûe
)

548 
	`msg
 (
M_SSLERR
, "CannotÜoad inline certificate file");

550 
	`msg
 (
M_SSLERR
, "C™nŸÜﬂd cîtifiˇã fûê%s", 
˚π_fûe
);

553 i‡(
ö
 !
NULL
)

554 
	`BIO_‰ì
(
ö
);

555 i‡(
x509
)

556 *
x509
 = 
x
;

557 i‡(
x
)

558 
	`X509_‰ì
 (
x
);

559 
	}
}

562 
	$és_˘x_lﬂd_˚π_fûe
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
˚π_fûe
,

563 c⁄° *
˚π_fûe_ölöe
)

565 
	`és_˘x_lﬂd_˚π_fûe_™d_c›y
 (
˘x
, 
˚π_fûe
, 
˚π_fûe_ölöe
, 
NULL
);

566 
	}
}

569 
	$és_˘x_‰ì_˚π_fûe
 (
X509
 *
x509
)

571 
	`X509_‰ì
(
x509
);

572 
	}
}

575 
	$és_˘x_lﬂd_¥iv_fûe
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
¥iv_key_fûe
,

576 c⁄° *
¥iv_key_fûe_ölöe


579 
°©us
;

580 
SSL_CTX
 *
s¶_˘x
 = 
NULL
;

581 
BIO
 *
ö
 = 
NULL
;

582 
EVP_PKEY
 *
pkey
 = 
NULL
;

583 
ªt
 = 1;

585 
	`ASSERT
(
NULL
 !
˘x
);

587 
s¶_˘x
 = 
˘x
->ctx;

589 i‡(!
	`°rcmp
 (
¥iv_key_fûe
, 
INLINE_FILE_TAG
Ë&& 
¥iv_key_fûe_ölöe
)

590 
ö
 = 
	`BIO_√w_mem_buf
 ((*)
¥iv_key_fûe_ölöe
, -1);

592 
ö
 = 
	`BIO_√w_fûe
 (
¥iv_key_fûe
, "r");

594 i‡(!
ö
)

595 
íd
;

597 
pkey
 = 
	`PEM_ªad_bio_Priv©eKey
 (
ö
, 
NULL
,

598 
s¶_˘x
->
deÁu…_∑sswd_ˇŒback
,

599 
s¶_˘x
->
deÁu…_∑sswd_ˇŒback_u£rd©a
);

600 i‡(!
pkey
)

601 
íd
;

603 i‡(!
	`SSL_CTX_u£_Priv©eKey
 (
s¶_˘x
, 
pkey
))

605 #ifde‡
ENABLE_MANAGEMENT


606 i‡(
m™agemít
 && (
	`ERR_GET_REASON
 (
	`ERR_≥ek_îr‹
()Ë=
EVP_R_BAD_DECRYPT
))

607 
	`m™agemít_auth_Áûuª
 (
m™agemít
, 
UP_TYPE_PRIVATE_KEY
, 
NULL
);

609 
	`msg
 (
M_WARN
|
M_SSL
, "C™nŸÜﬂdÖriv©êkey fûê%s", 
¥iv_key_fûe
);

610 
íd
;

612 
	`w¨n_if_group_Ÿhîs_ac˚ssibÀ
 (
¥iv_key_fûe
);

615 i‡(!
	`SSL_CTX_check_¥iv©e_key
 (
s¶_˘x
))

616 
	`msg
 (
M_SSLERR
, "Private key doesÇot matchÅhe certificate");

617 
ªt
 = 0;

619 
íd
:

620 i‡(
pkey
)

621 
	`EVP_PKEY_‰ì
 (
pkey
);

622 i‡(
ö
)

623 
	`BIO_‰ì
 (
ö
);

624  
ªt
;

625 
	}
}

627 #ifde‡
MANAGMENT_EXTERNAL_KEY


631 
	$rß_pub_íc
(
Êí
, c⁄° *
‰om
, *
to
, 
RSA
 *
rß
, 
∑ddög
)

633 
	`ASSERT
(0);

635 
	}
}

639 
	$rß_pub_dec
(
Êí
, c⁄° *
‰om
, *
to
, 
RSA
 *
rß
, 
∑ddög
)

641 
	`ASSERT
(0);

643 
	}
}

647 
	$rß_¥iv_dec
(
Êí
, c⁄° *
‰om
, *
to
, 
RSA
 *
rß
, 
∑ddög
)

649 
	`ASSERT
(0);

651 
	}
}

655 
	$rß_föish
(
RSA
 *
rß
)

657 
	`‰ì
 ((*)
rß
->
mëh
);

658 
rß
->
mëh
 = 
NULL
;

660 
	}
}

664 
	$rß_¥iv_íc
(
Êí
, c⁄° *
‰om
, *
to
, 
RSA
 *
rß
, 
∑ddög
)

667 *
ö_b64
 = 
NULL
;

668 *
out_b64
 = 
NULL
;

669 
ªt
 = -1;

670 
Àn
;

672 i‡(
∑ddög
 !
RSA_PKCS1_PADDING
)

674 
	`RSAîr
 (
RSA_F_RSA_EAY_PRIVATE_ENCRYPT
, 
RSA_R_UNKNOWN_PADDING_TYPE
);

675 
d⁄e
;

679 i‡(
	`›ív≤_ba£64_ícode
 (
‰om
, 
Êí
, &
ö_b64
) <= 0)

680 
d⁄e
;

683 i‡(
m™agemít
)

684 
out_b64
 = 
	`m™agemít_quîy_rß_sig
 (
m™agemít
, 
ö_b64
);

685 i‡(!
out_b64
)

686 
d⁄e
;

689 
Àn
 = 
	`RSA_size
(
rß
);

690 
ªt
 = 
	`›ív≤_ba£64_decode
 (
out_b64
, 
to
, 
Àn
);

693 i‡(
ªt
 !
Àn
)

694 
ªt
 = -1;

696 
d⁄e
:

697 i‡(
ö_b64
)

698 
	`‰ì
 (
ö_b64
);

699 i‡(
out_b64
)

700 
	`‰ì
 (
out_b64
);

701  
ªt
;

702 
	}
}

705 
	$és_˘x_u£_exã∫Æ_¥iv©e_key
 (
és_roŸ_˘x
 *
˘x
,

706 c⁄° *
˚π_fûe
, c⁄° *
˚π_fûe_ölöe
)

708 
RSA
 *
rß
 = 
NULL
;

709 
RSA
 *
pub_rß
;

710 
RSA_METHOD
 *
rß_mëh
;

711 
X509
 *
˚π
 = 
NULL
;

713 
	`ASSERT
 (
NULL
 !
˘x
);

714 
	`ASSERT
 (
NULL
 !
˚π
);

716 
	`és_˘x_lﬂd_˚π_fûe_™d_c›y
 (
˘x
, 
˚π_fûe
, 
˚π_fûe_ölöe
, &
˚π
);

719 
	`ALLOC_OBJ_CLEAR
 (
rß_mëh
, 
RSA_METHOD
);

720 
rß_mëh
->
«me
 = "OpenVPNÉxternalÖrivate key RSA Method";

721 
rß_mëh
->
rß_pub_íc
 =Ñsa_pub_enc;

722 
rß_mëh
->
rß_pub_dec
 =Ñsa_pub_dec;

723 
rß_mëh
->
rß_¥iv_íc
 =Ñsa_priv_enc;

724 
rß_mëh
->
rß_¥iv_dec
 =Ñsa_priv_dec;

725 
rß_mëh
->
öô
 = 
NULL
;

726 
rß_mëh
->
föish
 = 
rß_föish
;

727 
rß_mëh
->
Êags
 = 
RSA_METHOD_FLAG_NO_CHECK
;

728 
rß_mëh
->
≠p_d©a
 = 
NULL
;

731 
rß
 = 
	`RSA_√w
();

732 i‡(
rß
 =
NULL
)

734 
	`SSLîr
(
SSL_F_SSL_USE_PRIVATEKEY
, 
ERR_R_MALLOC_FAILURE
);

735 
îr
;

739 
	`ASSERT
(
˚π
->
˚π_öfo
->
key
->
pkey
);

740 
pub_rß
 = 
˚π
->
˚π_öfo
->
key
->
pkey
->pkey.
rß
;

743 
rß
->
n
 = 
	`BN_dup
(
pub_rß
->n);

744 
rß
->
Êags
 |
RSA_FLAG_EXT_PKEY
;

745 i‡(!
	`RSA_£t_mëhod
(
rß
, 
rß_mëh
))

746 
îr
;

749 i‡(!
	`SSL_CTX_u£_RSAPriv©eKey
(
˘x
->˘x, 
rß
))

750 
îr
;

752 
	`X509_‰ì
(
˚π
);

753 
	`RSA_‰ì
(
rß
);

756 
îr
:

757 i‡(
˚π
)

758 
	`X509_‰ì
(
˚π
);

759 i‡(
rß
)

760 
	`RSA_‰ì
(
rß
);

763 i‡(
rß_mëh
)

764 
	`‰ì
(
rß_mëh
);

766 
	`msg
 (
M_SSLERR
, "CannotÉnable SSLÉxternalÖrivate key capability");

768 
	}
}

773 
	$sk_x509_«me_cmp
(c⁄° 
X509_NAME
 * c⁄° *
a
, c⁄° X509_NAME * c⁄° *
b
)

775  
	`X509_NAME_cmp
 (*
a
, *
b
);

776 
	}
}

779 
	$és_˘x_lﬂd_ˇ
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
ˇ_fûe
,

780 c⁄° *
ˇ_fûe_ölöe
,

781 c⁄° *
ˇ_∑th
, 
boﬁ
 
és_£rvî


784 
	`STACK_OF
(
X509_INFO
Ë*
öfo_°ack
 = 
NULL
;

785 
	`STACK_OF
(
X509_NAME
Ë*
˚π_«mes
 = 
NULL
;

786 
X509_LOOKUP
 *
lookup
 = 
NULL
;

787 
X509_STORE
 *
°‹e
 = 
NULL
;

788 
X509_NAME
 *
xn
 = 
NULL
;

789 
BIO
 *
ö
 = 
NULL
;

790 
i
, 
added
 = 0, 
¥ev
 = 0;

792 
	`ASSERT
(
NULL
 !
˘x
);

794 
°‹e
 = 
	`SSL_CTX_gë_˚π_°‹e
(
˘x
->ctx);

795 i‡(!
°‹e
)

796 
	`msg
(
M_SSLERR
, "Cannot get certificate store (SSL_CTX_get_cert_store)");

799 i‡(
ˇ_fûe
)

801 i‡(!
	`°rcmp
 (
ˇ_fûe
, 
INLINE_FILE_TAG
Ë&& 
ˇ_fûe_ölöe
)

802 
ö
 = 
	`BIO_√w_mem_buf
 ((*)
ˇ_fûe_ölöe
, -1);

804 
ö
 = 
	`BIO_√w_fûe
 (
ˇ_fûe
, "r");

806 i‡(
ö
)

807 
öfo_°ack
 = 
	`PEM_X509_INFO_ªad_bio
 (
ö
, 
NULL
, NULL, NULL);

809 i‡(
öfo_°ack
)

811 
i
 = 0; i < 
	`sk_X509_INFO_num
 (
öfo_°ack
); i++)

813 
X509_INFO
 *
öfo
 = 
	`sk_X509_INFO_vÆue
 (
öfo_°ack
, 
i
);

814 i‡(
öfo
->
¸l
)

815 
	`X509_STORE_add_¸l
 (
°‹e
, 
öfo
->
¸l
);

817 i‡(
és_£rvî
 && !
öfo
->
x509
)

819 
	`msg
 (
M_SSLERR
, "X509Çame was missing in TLS mode");

822 i‡(
öfo
->
x509
)

824 
	`X509_STORE_add_˚π
 (
°‹e
, 
öfo
->
x509
);

825 
added
++;

827 i‡(!
és_£rvî
)

831 i‡(
˚π_«mes
 =
NULL
)

833 
˚π_«mes
 = 
	`sk_X509_NAME_√w
 (
sk_x509_«me_cmp
);

834 i‡(!
˚π_«mes
)

838 
xn
 = 
	`X509_gë_subje˘_«me
 (
öfo
->
x509
);

839 i‡(!
xn
)

843 i‡(
	`sk_X509_NAME_föd
 (
˚π_«mes
, 
xn
) == -1)

845 
xn
 = 
	`X509_NAME_dup
 (xn);

846 i‡(!
xn
)

848 
	`sk_X509_NAME_push
 (
˚π_«mes
, 
xn
);

852 i‡(
és_£rvî
) {

853 
˙um
 = 
	`sk_X509_NAME_num
 (
˚π_«mes
);

854 i‡(
˙um
 !(
¥ev
 + 1)) {

855 
	`msg
 (
M_WARN
, "C™nŸÜﬂd CA cîtifiˇã fûê%†”¡ry %d didÇŸ vÆid©e)", 
	`≈
(
ˇ_fûe
), 
added
);

857 
¥ev
 = 
˙um
;

861 
	`sk_X509_INFO_p›_‰ì
 (
öfo_°ack
, 
X509_INFO_‰ì
);

864 i‡(
és_£rvî
)

865 
	`SSL_CTX_£t_˛õ¡_CA_li°
 (
˘x
->˘x, 
˚π_«mes
);

867 i‡(!
added
)

868 
	`msg
 (
M_SSLERR
, "C™nŸÜﬂd CA cîtifiˇã fûê%†“ÿíåõ†wîêªad)", 
	`≈
(
ˇ_fûe
));

870 i‡(
és_£rvî
) {

871 
˙um
 = 
	`sk_X509_NAME_num
 (
˚π_«mes
);

872 i‡(
˙um
 !
added
)

873 
	`msg
 (
M_SSLERR
, "C™nŸÜﬂd CA cîtifiˇã fûê%†(⁄ly %d o‡%dÉ¡rõ†wîêvÆid X509Çames)", 
	`≈
(
ˇ_fûe
), 
˙um
, 
added
);

876 i‡(
ö
)

877 
	`BIO_‰ì
 (
ö
);

881 i‡(
ˇ_∑th
)

883 
lookup
 = 
	`X509_STORE_add_lookup
 (
°‹e
, 
	`X509_LOOKUP_hash_dú
 ());

884 i‡(
lookup
 && 
	`X509_LOOKUP_add_dú
 (lookup, 
ˇ_∑th
, 
X509_FILETYPE_PEM
))

885 
	`msg
(
M_WARN
, "WARNING:Éx≥rimíè»›ti⁄ --ˇ∑th %s", 
ˇ_∑th
);

887 
	`msg
(
M_SSLERR
, "C™nŸáddÜooku∞© --ˇ∑th %s", 
ˇ_∑th
);

888 #i‡
OPENSSL_VERSION_NUMBER
 >= 0x00907000L

889 
	`X509_STORE_£t_Êags
 (
°‹e
, 
X509_V_FLAG_CRL_CHECK
 | 
X509_V_FLAG_CRL_CHECK_ALL
);

891 
	`msg
(
M_WARN
, "WARNING:Åhis version of OpenSSL cannot handle CRL files in capath");

894 
	}
}

897 
	$és_˘x_lﬂd_exåa_˚πs
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
exåa_˚πs_fûe
,

898 c⁄° *
exåa_˚πs_fûe_ölöe


901 
BIO
 *
ö
;

902 i‡(!
	`°rcmp
 (
exåa_˚πs_fûe
, 
INLINE_FILE_TAG
Ë&& 
exåa_˚πs_fûe_ölöe
)

903 
ö
 = 
	`BIO_√w_mem_buf
 ((*)
exåa_˚πs_fûe_ölöe
, -1);

905 
ö
 = 
	`BIO_√w_fûe
 (
exåa_˚πs_fûe
, "r");

907 i‡(
ö
 =
NULL
)

908 
	`msg
 (
M_SSLERR
, "C™nŸÜﬂdÉxåa-˚π†fûe: %s", 
exåa_˚πs_fûe
);

910 
	`és_˘x_add_exåa_˚πs
 (
˘x
, 
ö
);

912 
	`BIO_‰ì
 (
ö
);

913 
	}
}

926 #ifde‡
BIO_DEBUG


928 #w¨nög 
BIO_DEBUG
 
deföed


930 
FILE
 *
	gbioÂ
;

931 
boﬁ
 
	gbioÂ_toggÀ
;

932 
time_t
 
	gbioÂ_œ°_›í
;

933 c⁄° 
	gbioÂ_ª›í_öãrvÆ
 = 600;

936 
	$˛o£_bioÂ
()

938 i‡(
bioÂ
)

940 
	`ASSERT
 (!
	`f˛o£
 (
bioÂ
));

941 
bioÂ
 = 
NULL
;

943 
	}
}

946 
	$›í_bioÂ
()

948 c⁄° 
time_t
 
cuºít
 = 
	`time
 (
NULL
);

949 c⁄° 
pid_t
 
pid
 = 
	`gëpid
 ();

951 i‡(
bioÂ_œ°_›í
 + 
bioÂ_ª›í_öãrvÆ
 < 
cuºít
)

952 
	`˛o£_bioÂ
();

953 i‡(!
bioÂ
)

955 
‚
[256];

956 
	`›ív≤_¢¥ötf
(
‚
, (‚), "bio/%d-%d.log", 
pid
, 
bioÂ_toggÀ
);

957 
bioÂ
 = 
	`f›í
 (
‚
, "w");

958 
	`ASSERT
 (
bioÂ
);

959 
bioÂ_œ°_›í
 = 
	`time
 (
NULL
);

960 
bioÂ_toggÀ
 ^= 1;

962 
	}
}

965 
	$bio_debug_d©a
 (c⁄° *
mode
, 
BIO
 *
bio
, c⁄° 
uöt8_t
 *
buf
, 
Àn
, c⁄° *
desc
)

967 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

968 i‡(
Àn
 > 0)

970 
	`›í_bioÂ
();

971 
	`Ârötf
(
bioÂ
, "BIO_%†%†time=" 
time_f‹m©
 " bio=" 
±r_f‹m©
 "Üen=%d data=%s\n",

972 
mode
, 
desc
, 
	`time
 (
NULL
), (
±r_ty≥
)
bio
, 
Àn
, 
	`f‹m©_hex
 (
buf
,Üí, 0, &
gc
));

973 
	`fÊush
 (
bioÂ
);

975 
	`gc_‰ì
 (&
gc
);

976 
	}
}

979 
	$bio_debug_oc
 (c⁄° *
mode
, 
BIO
 *
bio
)

981 
	`›í_bioÂ
();

982 
	`Ârötf
(
bioÂ
, "BIO %†time=" 
time_f‹m©
 " bio=" 
±r_f‹m©
 "\n",

983 
mode
, 
	`time
 (
NULL
), (
±r_ty≥
)
bio
);

984 
	`fÊush
 (
bioÂ
);

985 
	}
}

994 
BIO
 *

995 
	$gëbio
 (
BIO_METHOD
 * 
ty≥
, c⁄° *
desc
)

997 
BIO
 *
ªt
;

998 
ªt
 = 
	`BIO_√w
 (
ty≥
);

999 i‡(!
ªt
)

1000 
	`msg
 (
M_SSLERR
, "Eº‹ cª©ög %†BIO", 
desc
);

1001  
ªt
;

1002 
	}
}

1008 
	$bio_wrôe
 (
BIO
 *
bio
, c⁄° 
uöt8_t
 *
d©a
, 
size
, c⁄° *
desc
)

1010 
i
;

1011 
ªt
 = 0;

1012 
	`ASSERT
 (
size
 >= 0);

1013 i‡(
size
)

1021 #ifde‡
BIO_DEBUG


1022 
	`bio_debug_d©a
 ("wrôe", 
bio
, 
d©a
, 
size
, 
desc
);

1024 
i
 = 
	`BIO_wrôe
 (
bio
, 
d©a
, 
size
);

1026 i‡(
i
 < 0)

1028 i‡(
	`BIO_should_ªåy
 (
bio
))

1034 
	`msg
 (
D_TLS_ERRORS
 | 
M_SSL
, "TLS ERROR: BIO write %sÉrror",

1035 
desc
);

1036 
ªt
 = -1;

1037 
	`ERR_˛ór_îr‹
 ();

1040 i‡(
i
 !
size
)

1042 
	`msg
 (
D_TLS_ERRORS
 | 
M_SSL
,

1043 "TLS ERROR: BIO wrôê%†öcom∂ëê%d/%d", 
desc
, 
i
, 
size
);

1044 
ªt
 = -1;

1045 
	`ERR_˛ór_îr‹
 ();

1049 
	`dmsg
 (
D_HANDSHAKE_VERBOSE
, "BIO wrôê%†%d byãs", 
desc
, 
i
);

1050 
ªt
 = 1;

1053  
ªt
;

1054 
	}
}

1062 
	$bio_wrôe_po°
 (c⁄° 
°©us
, 
buf„r
 *
buf
)

1064 i‡(
°©us
 == 1)

1066 
	`mem£t
 (
	`BPTR
 (
buf
), 0, 
	`BLEN
 (buf));

1067 
buf
->
Àn
 = 0;

1069 
	}
}

1075 
	$bio_ªad
 (
BIO
 *
bio
, 
buf„r
 *
buf
, 
maxÀn
, c⁄° *
desc
)

1077 
i
;

1078 
ªt
 = 0;

1079 
	`ASSERT
 (
buf
->
Àn
 >= 0);

1080 i‡(
buf
->
Àn
)

1086 
Àn
 = 
	`buf_f‹w¨d_ˇ∑côy
 (
buf
);

1087 i‡(
maxÀn
 < 
Àn
)

1088 
Àn
 = 
maxÀn
;

1094 
i
 = 
	`BIO_ªad
 (
bio
, 
	`BPTR
 (
buf
), 
Àn
);

1096 
	`VALGRIND_MAKE_READABLE
 ((*Ë&
i
,  (i));

1098 #ifde‡
BIO_DEBUG


1099 
	`bio_debug_d©a
 ("ªad", 
bio
, 
	`BPTR
 (
buf
), 
i
, 
desc
);

1101 i‡(
i
 < 0)

1103 i‡(
	`BIO_should_ªåy
 (
bio
))

1109 
	`msg
 (
D_TLS_ERRORS
 | 
M_SSL
, "TLS_ERROR: BIOÑead %sÉrror",

1110 
desc
);

1111 
buf
->
Àn
 = 0;

1112 
ªt
 = -1;

1113 
	`ERR_˛ór_îr‹
 ();

1116 i‡(!
i
)

1118 
buf
->
Àn
 = 0;

1122 
	`dmsg
 (
D_HANDSHAKE_VERBOSE
, "BIOÑód %†%d byãs", 
desc
, 
i
);

1123 
buf
->
Àn
 = 
i
;

1124 
ªt
 = 1;

1125 
	`VALGRIND_MAKE_READABLE
 ((*Ë
	`BPTR
 (
buf
), 
	`BLEN
 (buf));

1128  
ªt
;

1129 
	}
}

1132 
	$key_°©e_s¶_öô
(
key_°©e_s¶
 *
ks_s¶
, c⁄° 
és_roŸ_˘x
 *
s¶_˘x
, 
boﬁ
 
is_£rvî
, 
és_£ssi⁄
 *
£ssi⁄
)

1134 
	`ASSERT
(
NULL
 !
s¶_˘x
);

1135 
	`ASSERT
(
ks_s¶
);

1136 
	`CLEAR
 (*
ks_s¶
);

1138 
ks_s¶
->
s¶
 = 
	`SSL_√w
 (
s¶_˘x
->
˘x
);

1139 i‡(!
ks_s¶
->
s¶
)

1140 
	`msg
 (
M_SSLERR
, "SSL_new failed");

1144 
	`SSL_£t_ex_d©a
 (
ks_s¶
->
s¶
, 
myd©a_ödex
, 
£ssi⁄
);

1146 
ks_s¶
->
s¶_bio
 = 
	`gëbio
 (
	`BIO_f_s¶
 (), "ssl_bio");

1147 
ks_s¶
->
˘_ö
 = 
	`gëbio
 (
	`BIO_s_mem
 (), "ct_in");

1148 
ks_s¶
->
˘_out
 = 
	`gëbio
 (
	`BIO_s_mem
 (), "ct_out");

1150 #ifde‡
BIO_DEBUG


1151 
	`bio_debug_oc
 ("›í s¶_bio", 
ks_s¶
->
s¶_bio
);

1152 
	`bio_debug_oc
 ("›í ct_ö", 
ks_s¶
->
˘_ö
);

1153 
	`bio_debug_oc
 ("›í ct_out", 
ks_s¶
->
˘_out
);

1156 i‡(
is_£rvî
)

1157 
	`SSL_£t_ac˚±_°©e
 (
ks_s¶
->
s¶
);

1159 
	`SSL_£t_c⁄√˘_°©e
 (
ks_s¶
->
s¶
);

1161 
	`SSL_£t_bio
 (
ks_s¶
->
s¶
, ks_s¶->
˘_ö
, ks_s¶->
˘_out
);

1162 
	`BIO_£t_s¶
 (
ks_s¶
->
s¶_bio
, ks_s¶->
s¶
, 
BIO_NOCLOSE
);

1163 
	}
}

1165 
	$key_°©e_s¶_‰ì
(
key_°©e_s¶
 *
ks_s¶
)

1167 i‡(
ks_s¶
->
s¶
) {

1168 #ifde‡
BIO_DEBUG


1169 
	`bio_debug_oc
 ("˛o£ s¶_bio", 
ks_s¶
->
s¶_bio
);

1170 
	`bio_debug_oc
 ("˛o£ ct_ö", 
ks_s¶
->
˘_ö
);

1171 
	`bio_debug_oc
 ("˛o£ ct_out", 
ks_s¶
->
˘_out
);

1173 
	`BIO_‰ì_Æl
(
ks_s¶
->
s¶_bio
);

1174 
	`SSL_‰ì
 (
ks_s¶
->
s¶
);

1176 
	}
}

1179 
	$key_°©e_wrôe_∂aöãxt
 (
key_°©e_s¶
 *
ks_s¶
, 
buf„r
 *
buf
)

1181 
ªt
 = 0;

1182 
	`≥rf_push
 (
PERF_BIO_WRITE_PLAINTEXT
);

1184 #ifde‡
ENABLE_CRYPTO_OPENSSL


1185 
	`ASSERT
 (
NULL
 !
ks_s¶
);

1187 
ªt
 = 
	`bio_wrôe
 (
ks_s¶
->
s¶_bio
, 
	`BPTR
(
buf
), 
	`BLEN
(buf),

1189 
	`bio_wrôe_po°
 (
ªt
, 
buf
);

1192 
	`≥rf_p›
 ();

1193  
ªt
;

1194 
	}
}

1197 
	$key_°©e_wrôe_∂aöãxt_c⁄°
 (
key_°©e_s¶
 *
ks_s¶
, c⁄° 
uöt8_t
 *
d©a
, 
Àn
)

1199 
ªt
 = 0;

1200 
	`≥rf_push
 (
PERF_BIO_WRITE_PLAINTEXT
);

1202 
	`ASSERT
 (
NULL
 !
ks_s¶
);

1204 
ªt
 = 
	`bio_wrôe
 (
ks_s¶
->
s¶_bio
, 
d©a
, 
Àn
, "tls_write_plaintext_const");

1206 
	`≥rf_p›
 ();

1207  
ªt
;

1208 
	}
}

1211 
	$key_°©e_ªad_cùhîãxt
 (
key_°©e_s¶
 *
ks_s¶
, 
buf„r
 *
buf
,

1212 
maxÀn
)

1214 
ªt
 = 0;

1215 
	`≥rf_push
 (
PERF_BIO_READ_CIPHERTEXT
);

1217 
	`ASSERT
 (
NULL
 !
ks_s¶
);

1219 
ªt
 = 
	`bio_ªad
 (
ks_s¶
->
˘_out
, 
buf
, 
maxÀn
, "tls_read_ciphertext");

1221 
	`≥rf_p›
 ();

1222  
ªt
;

1223 
	}
}

1226 
	$key_°©e_wrôe_cùhîãxt
 (
key_°©e_s¶
 *
ks_s¶
, 
buf„r
 *
buf
)

1228 
ªt
 = 0;

1229 
	`≥rf_push
 (
PERF_BIO_WRITE_CIPHERTEXT
);

1231 
	`ASSERT
 (
NULL
 !
ks_s¶
);

1233 
ªt
 = 
	`bio_wrôe
 (
ks_s¶
->
˘_ö
, 
	`BPTR
(
buf
), 
	`BLEN
(buf), "tls_write_ciphertext");

1234 
	`bio_wrôe_po°
 (
ªt
, 
buf
);

1236 
	`≥rf_p›
 ();

1237  
ªt
;

1238 
	}
}

1241 
	$key_°©e_ªad_∂aöãxt
 (
key_°©e_s¶
 *
ks_s¶
, 
buf„r
 *
buf
,

1242 
maxÀn
)

1244 
ªt
 = 0;

1245 
	`≥rf_push
 (
PERF_BIO_READ_PLAINTEXT
);

1247 
	`ASSERT
 (
NULL
 !
ks_s¶
);

1249 
ªt
 = 
	`bio_ªad
 (
ks_s¶
->
s¶_bio
, 
buf
, 
maxÀn
, "tls_read_plaintext");

1251 
	`≥rf_p›
 ();

1252  
ªt
;

1253 
	}
}

1263 
	$¥öt_dëaûs
 (
key_°©e_s¶
 * 
ks_s¶
, c⁄° *
¥efix
)

1265 c⁄° 
SSL_CIPHER
 *
cùh
;

1266 
X509
 *
˚π
;

1267 
s1
[256];

1268 
s2
[256];

1270 
s1
[0] = 
s2
[0] = 0;

1271 
cùh
 = 
	`SSL_gë_cuºít_cùhî
 (
ks_s¶
->
s¶
);

1272 
	`›ív≤_¢¥ötf
 (
s1
,  (s1), "%s %s, cipher %s %s",

1273 
¥efix
,

1274 
	`SSL_gë_vîsi⁄
 (
ks_s¶
->
s¶
),

1275 
	`SSL_CIPHER_gë_vîsi⁄
 (
cùh
),

1276 
	`SSL_CIPHER_gë_«me
 (
cùh
));

1277 
˚π
 = 
	`SSL_gë_≥î_˚πifiˇã
 (
ks_s¶
->
s¶
);

1278 i‡(
˚π
 !
NULL
)

1280 
EVP_PKEY
 *
pkey
 = 
	`X509_gë_pubkey
 (
˚π
);

1281 i‡(
pkey
 !
NULL
)

1283 i‡(
pkey
->
ty≥
 =
EVP_PKEY_RSA
 &&Ökey->pkey.
rß
 !
NULL


1284 && 
pkey
->pkey.
rß
->
n
 !
NULL
)

1286 
	`›ív≤_¢¥ötf
 (
s2
,  (s2), ", %d bit RSA",

1287 
	`BN_num_bôs
 (
pkey
->pkey.
rß
->
n
));

1289 i‡(
pkey
->
ty≥
 =
EVP_PKEY_DSA
 &&Ökey->pkey.
dß
 !
NULL


1290 && 
pkey
->pkey.
dß
->
p
 !
NULL
)

1292 
	`›ív≤_¢¥ötf
 (
s2
,  (s2), ", %d bit DSA",

1293 
	`BN_num_bôs
 (
pkey
->pkey.
dß
->
p
));

1295 
	`EVP_PKEY_‰ì
 (
pkey
);

1297 
	`X509_‰ì
 (
˚π
);

1301 
	`msg
 (
D_HANDSHAKE
, "%s%s", 
s1
, 
s2
);

1302 
	}
}

1305 
	$show_avaûabÀ_és_cùhîs
 (c⁄° *
cùhî_li°
)

1307 
és_roŸ_˘x
 
és_˘x
;

1308 
SSL
 *
s¶
;

1309 c⁄° *
cùhî_«me
;

1310 c⁄° *
¥öt_«me
;

1311 c⁄° 
és_cùhî_«me_∑ú
 *
∑ú
;

1312 
¥i‹ôy
 = 0;

1314 
és_˘x
.
˘x
 = 
	`SSL_CTX_√w
 (
	`SSLv23_mëhod
 ());

1315 i‡(!
és_˘x
.
˘x
)

1316 
	`msg
 (
M_SSLERR
, "Cannot create SSL_CTX object");

1318 
s¶
 = 
	`SSL_√w
 (
és_˘x
.
˘x
);

1319 i‡(!
s¶
)

1320 
	`msg
 (
M_SSLERR
, "Cannot create SSL object");

1322 i‡(
cùhî_li°
)

1323 
	`és_˘x_ª°ri˘_cùhîs
(&
és_˘x
, 
cùhî_li°
);

1325 
	`¥ötf
 ("Available TLS Ciphers,\n");

1326 
	`¥ötf
 ("listed in order ofÖreference:\n\n");

1327 (
cùhî_«me
 = 
	`SSL_gë_cùhî_li°
 (
s¶
, 
¥i‹ôy
++)))

1329 
∑ú
 = 
	`és_gë_cùhî_«me_∑ú
(
cùhî_«me
, 
	`°æí
(cipher_name));

1331 i‡(
NULL
 =
∑ú
) {

1333 
	`¥ötf
 ("%†(NÿIANAÇamêknow¿tÿO≥nVPN, u£ O≥nSSLÇame.)\n", 
cùhî_«me
);

1335 
	`¥ötf
 ("%s\n", 
∑ú
->
ü«_«me
);

1339 
	`¥ötf
 ("\n");

1341 
	`SSL_‰ì
 (
s¶
);

1342 
	`SSL_CTX_‰ì
 (
és_˘x
.
˘x
);

1343 
	}
}

1346 
	$gë_highe°_¥e„ªn˚_és_cùhî
 (*
buf
, 
size
)

1348 
SSL_CTX
 *
˘x
;

1349 
SSL
 *
s¶
;

1350 c⁄° *
cùhî_«me
;

1352 
˘x
 = 
	`SSL_CTX_√w
 (
	`SSLv23_mëhod
 ());

1353 i‡(!
˘x
)

1354 
	`msg
 (
M_SSLERR
, "Cannot create SSL_CTX object");

1355 
s¶
 = 
	`SSL_√w
 (
˘x
);

1356 i‡(!
s¶
)

1357 
	`msg
 (
M_SSLERR
, "Cannot create SSL object");

1359 
cùhî_«me
 = 
	`SSL_gë_cùhî_li°
 (
s¶
, 0);

1360 
	`°∫˝y¡
 (
buf
, 
cùhî_«me
, 
size
);

1362 
	`SSL_‰ì
 (
s¶
);

1363 
	`SSL_CTX_‰ì
 (
˘x
);

1364 
	}
}

1367 
	$gë_s¶_libøry_vîsi⁄
()

1369  
	`SSLóy_vîsi⁄
(
SSLEAY_VERSION
);

1370 
	}
}

	@src/openvpn/ssl_openssl.h

30 #i‚de‡
SSL_OPENSSL_H_


31 
	#SSL_OPENSSL_H_


	)

33 
	~<›ís¶/s¶.h
>

42 #i‚de‡
SSL_OP_NO_TICKET


43 
	#SSL_OP_NO_TICKET
 0

	)

51 
	sés_roŸ_˘x
 {

52 
SSL_CTX
 *
	m˘x
;

55 
	skey_°©e_s¶
 {

56 
SSL
 *
	ms¶
;

57 
BIO
 *
	ms¶_bio
;

58 
BIO
 *
	m˘_ö
;

59 
BIO
 *
	m˘_out
;

66 
myd©a_ödex
;

68 
›ís¶_£t_myd©a_ödex
 ();

	@src/openvpn/ssl_polarssl.c

31 #ifde‡
HAVE_CONFIG_H


32 
	~"c⁄fig.h
"

33 #ñi‡
deföed
(
_MSC_VER
)

34 
	~"c⁄fig-msvc.h
"

37 
	~"syshód.h
"

39 #i‡
deföed
(
ENABLE_SSL
Ë&& deföed(
ENABLE_CRYPTO_POLARSSL
)

41 
	~"îæevñ.h
"

42 
	~"s¶_backíd.h
"

43 
	~"ba£64.h
"

44 
	~"buf„r.h
"

45 
	~"misc.h
"

46 
	~"m™age.h
"

47 
	~"s¶_comm⁄.h
"

49 
	~<pﬁ¨s¶/sha2.h
>

50 
	~<pﬁ¨s¶/havege.h
>

52 
	~"s¶_vîify_pﬁ¨s¶.h
"

53 
	~<pﬁ¨s¶/îr‹.h
>

54 
	~<pﬁ¨s¶/≥m.h
>

55 
	~<pﬁ¨s¶/vîsi⁄.h
>

58 
	$és_öô_lib
()

60 
	}
}

63 
	$és_‰ì_lib
()

65 
	}
}

68 
	$és_˛ór_îr‹
()

70 
	}
}

73 
	$és_˘x_£rvî_√w
(
és_roŸ_˘x
 *
˘x
, 
s¶_Êags
)

75 
	`ASSERT
(
NULL
 !
˘x
);

76 
	`CLEAR
(*
˘x
);

78 
	`ALLOC_OBJ_CLEAR
(
˘x
->
dhm_˘x
, 
dhm_c⁄ãxt
);

79 
	`ALLOC_OBJ_CLEAR
(
˘x
->
¥iv_key
, 
rß_c⁄ãxt
);

81 
	`ALLOC_OBJ_CLEAR
(
˘x
->
ˇ_chaö
, 
x509_˚π
);

82 
	`ALLOC_OBJ_CLEAR
(
˘x
->
¸t_chaö
, 
x509_˚π
);

85 
˘x
->
ídpoöt
 = 
SSL_IS_SERVER
;

86 
˘x
->
öôüli£d
 = 
åue
;

87 
	}
}

90 
	$és_˘x_˛õ¡_√w
(
és_roŸ_˘x
 *
˘x
, 
s¶_Êags
)

92 
	`ASSERT
(
NULL
 !
˘x
);

93 
	`CLEAR
(*
˘x
);

95 
	`ALLOC_OBJ_CLEAR
(
˘x
->
dhm_˘x
, 
dhm_c⁄ãxt
);

96 
	`ALLOC_OBJ_CLEAR
(
˘x
->
¥iv_key
, 
rß_c⁄ãxt
);

98 
	`ALLOC_OBJ_CLEAR
(
˘x
->
ˇ_chaö
, 
x509_˚π
);

99 
	`ALLOC_OBJ_CLEAR
(
˘x
->
¸t_chaö
, 
x509_˚π
);

101 
˘x
->
ídpoöt
 = 
SSL_IS_CLIENT
;

102 
˘x
->
öôüli£d
 = 
åue
;

103 
	}
}

106 
	$és_˘x_‰ì
(
és_roŸ_˘x
 *
˘x
)

108 i‡(
˘x
)

110 
	`rß_‰ì
(
˘x
->
¥iv_key
);

111 
	`‰ì
(
˘x
->
¥iv_key
);

113 
	`x509_‰ì
(
˘x
->
ˇ_chaö
);

114 
	`‰ì
(
˘x
->
ˇ_chaö
);

116 
	`x509_‰ì
(
˘x
->
¸t_chaö
);

117 
	`‰ì
(
˘x
->
¸t_chaö
);

119 
	`dhm_‰ì
(
˘x
->
dhm_˘x
);

120 
	`‰ì
(
˘x
->
dhm_˘x
);

122 #i‡
	`deföed
(
ENABLE_PKCS11
)

123 i‡(
˘x
->
¥iv_key_pkcs11
 !
NULL
) {

124 
	`pkcs11_¥iv_key_‰ì
(
˘x
->
¥iv_key_pkcs11
);

125 
	`‰ì
(
˘x
->
¥iv_key_pkcs11
);

128 #i‡
	`deföed
(
MANAGMENT_EXTERNAL_KEY
)

129 i‡(
˘x
->
exã∫Æ_key
 !
NULL
)

130 
	`‰ì
(
˘x
->
exã∫Æ_key
);

133 i‡(
˘x
->
Ælowed_cùhîs
)

134 
	`‰ì
(
˘x
->
Ælowed_cùhîs
);

136 
	`CLEAR
(*
˘x
);

138 
˘x
->
öôüli£d
 = 
Ál£
;

141 
	}
}

143 
boﬁ


144 
	$és_˘x_öôüli£d
(
és_roŸ_˘x
 *
˘x
)

146 
	`ASSERT
(
NULL
 !
˘x
);

147  
˘x
->
öôüli£d
;

148 
	}
}

151 
	$és_˘x_£t_›ti⁄s
 (
és_roŸ_˘x
 *
˘x
, 
s¶_Êags
)

153 
	}
}

156 
	$és_å™¶©e_cùhî_«me
 (c⁄° * 
cùhî_«me
) {

157 c⁄° 
és_cùhî_«me_∑ú
 * 
∑ú
 = 
	`és_gë_cùhî_«me_∑ú
(
cùhî_«me
, 
	`°æí
(cipher_name));

159 i‡(
NULL
 =
∑ú
)

162  
cùhî_«me
;

165 i‡(0 !
	`°rcmp
(
cùhî_«me
, 
∑ú
->
ü«_«me
))

168 
	`msg
(
M_WARN
, "Dïªˇãd cùhî suôê«mê'%s',ÖÀa£ u£ IANAÇamê'%s'", 
∑ú
->
›ís¶_«me
,Öaú->
ü«_«me
);

171  
∑ú
->
ü«_«me
;

172 
	}
}

175 
	$és_˘x_ª°ri˘_cùhîs
(
és_roŸ_˘x
 *
˘x
, c⁄° *
cùhîs
)

177 *
tmp_cùhîs
, *
tmp_cùhîs_‹ig
, *
tokí
;

178 
i
, 
cùhî_cou¡
;

179 
cùhîs_Àn
 = 
	`°æí
 (
cùhîs
);

181 
	`ASSERT
 (
NULL
 !
˘x
);

182 
	`ASSERT
 (0 !
cùhîs_Àn
);

185 
i
 = 0, 
cùhî_cou¡
 = 1; i < 
cùhîs_Àn
; i++)

186 i‡(
cùhîs
[
i
] == ':')

187 
cùhî_cou¡
++;

190 
	`ALLOC_ARRAY_CLEAR
(
˘x
->
Ælowed_cùhîs
, , 
cùhî_cou¡
+1)

193 
i
 = 0;

194 
tmp_cùhîs_‹ig
 = 
tmp_cùhîs
 = 
	`°rdup
(
cùhîs
);

196 
tokí
 = 
	`°πok
 (
tmp_cùhîs
, ":");

197 
tokí
)

199 
˘x
->
Ælowed_cùhîs
[
i
] = 
	`s¶_gë_cùhîsuôe_id
 (

200 
	`és_å™¶©e_cùhî_«me
 (
tokí
));

201 i‡(0 !
˘x
->
Ælowed_cùhîs
[
i
])

202 
i
++;

203 
tokí
 = 
	`°πok
 (
NULL
, ":");

205 
	`‰ì
(
tmp_cùhîs_‹ig
);

206 
	}
}

209 
	$és_˘x_lﬂd_dh_∑øms
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
dh_fûe
,

210 c⁄° *
dh_ölöe


213 i‡(!
	`°rcmp
 (
dh_fûe
, 
INLINE_FILE_TAG
Ë&& 
dh_ölöe
)

215 i‡(0 !
	`x509∑r£_dhm
(
˘x
->
dhm_˘x
, (c⁄° *Ë
dh_ölöe
,

216 
	`°æí
(
dh_ölöe
)))

217 
	`msg
 (
M_FATAL
, "CannotÑead inline DHÖarameters");

221 i‡(0 !
	`x509∑r£_dhmfûe
(
˘x
->
dhm_˘x
, 
dh_fûe
))

222 
	`msg
 (
M_FATAL
, "C™nŸÑód DHÖ¨amëî†‰om fûê%s", 
dh_fûe
);

225 
	`msg
 (
D_TLS_DEBUG_LOW
, "Diffõ-Hñlm™ inôülized wôh " 
cou¡î_f‹m©
 " bit key",

226 (
cou¡î_ty≥
Ë8 * 
	`mpi_size
(&
˘x
->
dhm_˘x
->
P
));

227 
	}
}

230 
	$és_˘x_lﬂd_pkcs12
(
és_roŸ_˘x
 *
˘x
, c⁄° *
pkcs12_fûe
,

231 c⁄° *
pkcs12_fûe_ölöe
,

232 
boﬁ
 
lﬂd_ˇ_fûe


235 
	`msg
(
M_FATAL
, "PKCS #12 filesÇot yet supported for PolarSSL.");

237 
	}
}

239 #ifde‡
ENABLE_CRYPTOAPI


241 
	$és_˘x_lﬂd_¸y±ﬂpi
(
és_roŸ_˘x
 *
˘x
, c⁄° *
¸y±ﬂpi_˚π
)

243 
	`msg
(
M_FATAL
, "Windows CryptoAPIÇot yet supported for PolarSSL.");

244 
	}
}

248 
	$és_˘x_lﬂd_˚π_fûe
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
˚π_fûe
,

249 c⁄° *
˚π_ölöe


252 
	`ASSERT
(
NULL
 !
˘x
);

254 i‡(!
	`°rcmp
 (
˚π_fûe
, 
INLINE_FILE_TAG
Ë&& 
˚π_ölöe
)

256 i‡(0 !
	`x509∑r£_¸t
(
˘x
->
¸t_chaö
,

257 (c⁄° *Ë
˚π_ölöe
, 
	`°æí
(cert_inline)))

258 
	`msg
 (
M_FATAL
, "CannotÜoad inline certificate file");

262 i‡(0 !
	`x509∑r£_¸tfûe
(
˘x
->
¸t_chaö
, 
˚π_fûe
))

263 
	`msg
 (
M_FATAL
, "C™nŸÜﬂd cîtifiˇã fûê%s", 
˚π_fûe
);

265 
	}
}

268 
	$és_˘x_lﬂd_¥iv_fûe
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
¥iv_key_fûe
,

269 c⁄° *
¥iv_key_ölöe


272 
°©us
;

273 
	`ASSERT
(
NULL
 !
˘x
);

275 i‡(!
	`°rcmp
 (
¥iv_key_fûe
, 
INLINE_FILE_TAG
Ë&& 
¥iv_key_ölöe
)

277 
°©us
 = 
	`x509∑r£_key
(
˘x
->
¥iv_key
,

278 (c⁄° *Ë
¥iv_key_ölöe
, 
	`°æí
(priv_key_inline),

279 
NULL
, 0);

280 i‡(
POLARSSL_ERR_X509_PASSWORD_REQUIRED
 =
°©us
)

282 
∑ssbuf
[512] = {0};

283 
	`≥m_∑ssw‹d_ˇŒback
(
∑ssbuf
, 512, 0, 
NULL
);

284 
°©us
 = 
	`x509∑r£_key
(
˘x
->
¥iv_key
,

285 (c⁄° *Ë
¥iv_key_ölöe
, 
	`°æí
(priv_key_inline),

286 (c⁄° *Ë
∑ssbuf
, 
	`°æí
(passbuf));

291 
°©us
 = 
	`x509∑r£_keyfûe
(
˘x
->
¥iv_key
, 
¥iv_key_fûe
, 
NULL
);

292 i‡(
POLARSSL_ERR_X509_PASSWORD_REQUIRED
 =
°©us
)

294 
∑ssbuf
[512] = {0};

295 
	`≥m_∑ssw‹d_ˇŒback
(
∑ssbuf
, 512, 0, 
NULL
);

296 
°©us
 = 
	`x509∑r£_keyfûe
(
˘x
->
¥iv_key
, 
¥iv_key_fûe
, 
∑ssbuf
);

299 i‡(0 !
°©us
)

301 #ifde‡
ENABLE_MANAGEMENT


302 i‡(
m™agemít
 && (
POLARSSL_ERR_X509_PASSWORD_MISMATCH
 =
°©us
))

303 
	`m™agemít_auth_Áûuª
 (
m™agemít
, 
UP_TYPE_PRIVATE_KEY
, 
NULL
);

305 
	`msg
 (
M_WARN
, "C™nŸÜﬂdÖriv©êkey fûê%s", 
¥iv_key_fûe
);

309 
	`w¨n_if_group_Ÿhîs_ac˚ssibÀ
 (
¥iv_key_fûe
);

313 i‡(!
	`SSL_CTX_check_¥iv©e_key
 (
˘x
))

314 
	`msg
 (
M_SSLERR
, "Private key doesÇot matchÅhe certificate");

317 
	}
}

319 #ifde‡
MANAGMENT_EXTERNAL_KEY


322 
	sexã∫Æ_c⁄ãxt
 {

323 
size_t
 
	msig«tuª_Àngth
;

327 
	$és_˘x_u£_exã∫Æ_¥iv©e_key
 (
és_roŸ_˘x
 *
˘x
,

328 c⁄° *
˚π_fûe
, c⁄° *
˚π_fûe_ölöe
)

330 
	`ASSERT
(
NULL
 !
˘x
);

332 
	`és_˘x_lﬂd_˚π_fûe
(
˘x
, 
˚π_fûe
, 
˚π_fûe_ölöe
);

334 i‡(
˘x
->
¸t_chaö
 =
NULL
)

338 
	`ALLOC_OBJ_CLEAR
 (
˘x
->
exã∫Æ_key
, 
exã∫Æ_c⁄ãxt
);

339 
˘x
->
exã∫Æ_key
->
sig«tuª_Àngth
 = ctx->
¸t_chaö
->
rß
.
Àn
;

342 
	}
}

344 
ölöe
 
exã∫Æ_pkcs1_sign
–*
˘x_void±r
,

345 (*
f_∫g
)(*, *, 
size_t
), *
p_∫g
, 
mode
,

346 
hash_id
, 
hashÀn
, c⁄° *
hash
,

347 *
sig
 )

349 
exã∫Æ_c⁄ãxt
 * c⁄° 
˘x
 = 
˘x_void±r
;

350 *
ö_b64
 = 
NULL
;

351 *
out_b64
 = 
NULL
;

352 
rv
;

353 * c⁄° 
p
 = 
sig
;

354 
size_t
 
a¢_Àn
;

356 
	`ASSERT
(
NULL
 !
˘x
);

358 i‡(
RSA_PRIVATE
 !
mode
)

360 
rv
 = 
POLARSSL_ERR_RSA_BAD_INPUT_DATA
;

361 
d⁄e
;

370  
hash_id
 )

372 
SIG_RSA_RAW
:

373 
a¢_Àn
 = 0;

374 
	`mem˝y
–
p
, 
hash
, 
hashÀn
 );

377 
SIG_RSA_MD2
:

378 
a¢_Àn
 = 
	`OID_SIZE
(
ASN1_HASH_MDX
);

379 
	`mem˝y
–
p
, 
ASN1_HASH_MDX
, 
a¢_Àn
 );

380 
	`mem˝y
–
p
 + 
a¢_Àn
, 
hash
, 
hashÀn
 );

381 
p
[13] = 2; ;

383 
SIG_RSA_MD4
:

384 
a¢_Àn
 = 
	`OID_SIZE
(
ASN1_HASH_MDX
);

385 
	`mem˝y
–
p
, 
ASN1_HASH_MDX
, 
a¢_Àn
 );

386 
	`mem˝y
–
p
 + 
a¢_Àn
, 
hash
, 
hashÀn
 );

387 
p
[13] = 4; ;

389 
SIG_RSA_MD5
:

390 
a¢_Àn
 = 
	`OID_SIZE
(
ASN1_HASH_MDX
);

391 
	`mem˝y
–
p
, 
ASN1_HASH_MDX
, 
a¢_Àn
 );

392 
	`mem˝y
–
p
 + 
a¢_Àn
, 
hash
, 
hashÀn
 );

393 
p
[13] = 5; ;

395 
SIG_RSA_SHA1
:

396 
a¢_Àn
 = 
	`OID_SIZE
(
ASN1_HASH_SHA1
);

397 
	`mem˝y
–
p
, 
ASN1_HASH_SHA1
, 
a¢_Àn
 );

398 
	`mem˝y
–
p
 + 15, 
hash
, 
hashÀn
 );

401 
SIG_RSA_SHA224
:

402 
a¢_Àn
 = 
	`OID_SIZE
(
ASN1_HASH_SHA2X
);

403 
	`mem˝y
–
p
, 
ASN1_HASH_SHA2X
, 
a¢_Àn
 );

404 
	`mem˝y
–
p
 + 
a¢_Àn
, 
hash
, 
hashÀn
 );

405 
p
[1] +
hashÀn
;Ö[14] = 4;Ö[18] += hashlen; ;

407 
SIG_RSA_SHA256
:

408 
a¢_Àn
 = 
	`OID_SIZE
(
ASN1_HASH_SHA2X
);

409 
	`mem˝y
–
p
, 
ASN1_HASH_SHA2X
, 
a¢_Àn
 );

410 
	`mem˝y
–
p
 + 
a¢_Àn
, 
hash
, 
hashÀn
 );

411 
p
[1] +
hashÀn
;Ö[14] = 1;Ö[18] += hashlen; ;

413 
SIG_RSA_SHA384
:

414 
a¢_Àn
 = 
	`OID_SIZE
(
ASN1_HASH_SHA2X
);

415 
	`mem˝y
–
p
, 
ASN1_HASH_SHA2X
, 
a¢_Àn
 );

416 
	`mem˝y
–
p
 + 
a¢_Àn
, 
hash
, 
hashÀn
 );

417 
p
[1] +
hashÀn
;Ö[14] = 2;Ö[18] += hashlen; ;

419 
SIG_RSA_SHA512
:

420 
a¢_Àn
 = 
	`OID_SIZE
(
ASN1_HASH_SHA2X
);

421 
	`mem˝y
–
p
, 
ASN1_HASH_SHA2X
, 
a¢_Àn
 );

422 
	`mem˝y
–
p
 + 
a¢_Àn
, 
hash
, 
hashÀn
 );

423 
p
[1] +
hashÀn
;Ö[14] = 3;Ö[18] += hashlen; ;

427 
rv
 = 
POLARSSL_ERR_RSA_BAD_INPUT_DATA
;

428 
d⁄e
;

432 i‡(
	`›ív≤_ba£64_ícode
 (
sig
, 
a¢_Àn
 + 
hashÀn
, &
ö_b64
) <= 0)

434 
rv
 = 
POLARSSL_ERR_RSA_BAD_INPUT_DATA
;

435 
d⁄e
;

439 i‡(
m™agemít
)

440 
out_b64
 = 
	`m™agemít_quîy_rß_sig
 (
m™agemít
, 
ö_b64
);

441 i‡(!
out_b64
)

443 
rv
 = 
POLARSSL_ERR_RSA_PRIVATE_FAILED
;

444 
d⁄e
;

448 i‡–
	`›ív≤_ba£64_decode
 (
out_b64
, 
sig
, 
˘x
->
sig«tuª_Àngth
) !=

449 
˘x
->
sig«tuª_Àngth
 )

451 
rv
 = 
POLARSSL_ERR_RSA_PRIVATE_FAILED
;

452 
d⁄e
;

455 
rv
 = 0;

457 
d⁄e
:

458 i‡(
ö_b64
)

459 
	`‰ì
 (
ö_b64
);

460 i‡(
out_b64
)

461 
	`‰ì
 (
out_b64
);

462  
rv
;

463 
	}
}

465 
ölöe
 
size_t
 
	$exã∫Æ_key_Àn
(*
v˘x
)

467 
exã∫Æ_c⁄ãxt
 * c⁄° 
˘x
 = 
v˘x
;

469  
˘x
->
sig«tuª_Àngth
;

470 
	}
}

473 
	$és_˘x_lﬂd_ˇ
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
ˇ_fûe
,

474 c⁄° *
ˇ_ölöe
,

475 c⁄° *
ˇ_∑th
, 
boﬁ
 
és_£rvî


478 i‡(
ˇ_∑th
)

479 
	`msg
(
M_FATAL
, "ERROR: PolarSSL cannot handleÅhe capath directive");

481 i‡(
ˇ_fûe
 && !
	`°rcmp
 (ˇ_fûe, 
INLINE_FILE_TAG
Ë&& 
ˇ_ölöe
)

483 i‡(0 !
	`x509∑r£_¸t
(
˘x
->
ˇ_chaö
, (c⁄° *Ë
ˇ_ölöe
,

484 
	`°æí
(
ˇ_ölöe
)))

485 
	`msg
 (
M_FATAL
, "CannotÜoad inline CA certificates");

490 i‡(0 !
	`x509∑r£_¸tfûe
(
˘x
->
ˇ_chaö
, 
ˇ_fûe
))

491 
	`msg
 (
M_FATAL
, "C™nŸÜﬂd CA cîtifiˇã fûê%s", 
ˇ_fûe
);

493 
	}
}

496 
	$és_˘x_lﬂd_exåa_˚πs
 (
és_roŸ_˘x
 *
˘x
, c⁄° *
exåa_˚πs_fûe
,

497 c⁄° *
exåa_˚πs_ölöe


500 
	`ASSERT
(
NULL
 !
˘x
);

502 i‡(!
	`°rcmp
 (
exåa_˚πs_fûe
, 
INLINE_FILE_TAG
Ë&& 
exåa_˚πs_ölöe
)

504 i‡(0 !
	`x509∑r£_¸t
(
˘x
->
¸t_chaö
,

505 (c⁄° *Ë
exåa_˚πs_ölöe
,

506 
	`°æí
(
exåa_˚πs_ölöe
)))

507 
	`msg
 (
M_FATAL
, "CannotÜoad inlineÉxtra-certs file");

511 i‡(0 !
	`x509∑r£_¸tfûe
(
˘x
->
¸t_chaö
, 
exåa_˚πs_fûe
))

512 
	`msg
 (
M_FATAL
, "C™nŸÜﬂdÉxåa-˚π†fûe: %s", 
exåa_˚πs_fûe
);

514 
	}
}

526 
ölöe
 
	$buf_‰ì_íåy
(
buf„r_íåy
 *
íåy
)

528 i‡(
NULL
 !
íåy
)

530 
	`‰ì
(
íåy
->
d©a
);

531 
	`‰ì
(
íåy
);

533 
	}
}

535 
	$buf_‰ì_íåõs
(
ídÀss_buf„r
 *
buf
)

537 
buf
->
fú°_block
)

539 
buf„r_íåy
 *
cur_block
 = 
buf
->
fú°_block
;

540 
buf
->
fú°_block
 = 
cur_block
->
√xt_block
;

541 
	`buf_‰ì_íåy
(
cur_block
);

543 
buf
->
œ°_block
 = 
NULL
;

544 
	}
}

546 
	$ídÀss_buf_ªad
–* 
˘x
, * 
out
, 
size_t
 
out_Àn
 )

548 
ídÀss_buf„r
 *
ö
 = (ídÀss_buf„∏*Ë
˘x
;

549 
size_t
 
ªad_Àn
 = 0;

551 i‡(
ö
->
fú°_block
 =
NULL
)

552  
POLARSSL_ERR_NET_WANT_READ
;

554 
ö
->
fú°_block
 !
NULL
 && 
ªad_Àn
 < 
out_Àn
)

556 
block_Àn
 = 
ö
->
fú°_block
->
Àngth
 - in->
d©a_°¨t
;

557 i‡(
block_Àn
 <
out_Àn
 - 
ªad_Àn
)

559 
buf„r_íåy
 *
cur_íåy
 = 
ö
->
fú°_block
;

560 
	`mem˝y
(
out
 + 
ªad_Àn
, 
cur_íåy
->
d©a
 + 
ö
->
d©a_°¨t
,

561 
block_Àn
);

563 
ªad_Àn
 +
block_Àn
;

565 
ö
->
fú°_block
 = 
cur_íåy
->
√xt_block
;

566 
ö
->
d©a_°¨t
 = 0;

568 i‡(
ö
->
fú°_block
 =
NULL
)

569 
ö
->
œ°_block
 = 
NULL
;

571 
	`buf_‰ì_íåy
(
cur_íåy
);

575 
	`mem˝y
(
out
 + 
ªad_Àn
, 
ö
->
fú°_block
->
d©a
 + in->
d©a_°¨t
,

576 
out_Àn
 - 
ªad_Àn
);

577 
ö
->
d©a_°¨t
 +
out_Àn
 - 
ªad_Àn
;

578 
ªad_Àn
 = 
out_Àn
;

582  
ªad_Àn
;

583 
	}
}

585 
	$ídÀss_buf_wrôe
–*
˘x
, c⁄° *
ö
, 
size_t
 
Àn
 )

587 
ídÀss_buf„r
 *
out
 = (ídÀss_buf„∏*Ë
˘x
;

588 
buf„r_íåy
 *
√w_block
 = 
	`mÆloc
((buffer_entry));

589 i‡(
NULL
 =
√w_block
)

590  
POLARSSL_ERR_NET_SEND_FAILED
;

592 
√w_block
->
d©a
 = 
	`mÆloc
(
Àn
);

593 i‡(
NULL
 =
√w_block
->
d©a
)

595 
	`‰ì
(
√w_block
);

596  
POLARSSL_ERR_NET_SEND_FAILED
;

599 
√w_block
->
Àngth
 = 
Àn
;

600 
√w_block
->
√xt_block
 = 
NULL
;

602 
	`mem˝y
(
√w_block
->
d©a
, 
ö
, 
Àn
);

604 i‡(
NULL
 =
out
->
fú°_block
)

605 
out
->
fú°_block
 = 
√w_block
;

607 i‡(
NULL
 !
out
->
œ°_block
)

608 
out
->
œ°_block
->
√xt_block
 = 
√w_block
;

610 
out
->
œ°_block
 = 
√w_block
;

612  
Àn
;

613 
	}
}

615 
	$my_debug
–*
˘x
, 
Àvñ
, c⁄° *
°r
 )

617 i‡(
Àvñ
 == 1)

619 
	`dmsg
 (
D_HANDSHAKE_VERBOSE
, "Pﬁ¨SSLáÀπ: %s", 
°r
);

621 
	}
}

626 
	$és_˘x_≥rs⁄Æi£_øndom
(
és_roŸ_˘x
 *
˘x
)

628 
ﬁd_sha256_hash
[32] = {0};

629 
sha256_hash
[32] = {0};

630 
˘r_drbg_c⁄ãxt
 *
cd_˘x
 = 
	`ønd_˘x_gë
();

632 i‡(
NULL
 !
˘x
->
¸t_chaö
)

634 
x509_˚π
 *
˚π
 = 
˘x
->
¸t_chaö
;

636 
	`sha2
(
˚π
->
tbs
.
p
, cît->tbs.
Àn
, 
sha256_hash
, 
Ál£
);

637 i‡–0 !
	`memcmp
(
ﬁd_sha256_hash
, 
sha256_hash
, (sha256_hash)))

639 
	`˘r_drbg_upd©e
(
cd_˘x
, 
sha256_hash
, 32);

640 
	`mem˝y
(
ﬁd_sha256_hash
, 
sha256_hash
, (old_sha256_hash));

643 
	}
}

646 
	$és_vîsi⁄_max
()

648 #i‡
	`deföed
(
SSL_MAJOR_VERSION_3
Ë&& deföed(
SSL_MINOR_VERSION_3
)

649  
TLS_VER_1_2
;

650 #ñi‡
	`deföed
(
SSL_MAJOR_VERSION_3
Ë&& deföed(
SSL_MINOR_VERSION_2
)

651  
TLS_VER_1_1
;

653  
TLS_VER_1_0
;

655 
	}
}

667 
	$és_vîsi⁄_to_maj‹_mö‹
(
és_vî
, *
maj‹
, *
mö‹
) {

668 
	`ASSERT
(
maj‹
);

669 
	`ASSERT
(
mö‹
);

671 
és_vî
)

673 
TLS_VER_1_0
:

674 *
maj‹
 = 
SSL_MAJOR_VERSION_3
;

675 *
mö‹
 = 
SSL_MINOR_VERSION_1
;

677 
TLS_VER_1_1
:

678 *
maj‹
 = 
SSL_MAJOR_VERSION_3
;

679 *
mö‹
 = 
SSL_MINOR_VERSION_2
;

681 
TLS_VER_1_2
:

682 *
maj‹
 = 
SSL_MAJOR_VERSION_3
;

683 *
mö‹
 = 
SSL_MINOR_VERSION_3
;

686 
	`msg
(
M_FATAL
, "%s: invÆid TLS vîsi⁄ %d", 
__func__
, 
és_vî
);

689 
	}
}

691 
	$key_°©e_s¶_öô
(
key_°©e_s¶
 *
ks_s¶
,

692 c⁄° 
és_roŸ_˘x
 *
s¶_˘x
, 
boﬁ
 
is_£rvî
, 
és_£ssi⁄
 *
£ssi⁄
)

694 
	`ASSERT
(
NULL
 !
s¶_˘x
);

695 
	`ASSERT
(
ks_s¶
);

696 
	`CLEAR
(*
ks_s¶
);

698 
	`ALLOC_OBJ_CLEAR
(
ks_s¶
->
˘x
, 
s¶_c⁄ãxt
);

699 i‡(0 =
	`s¶_öô
(
ks_s¶
->
˘x
))

702 
	`s¶_£t_dbg
 (
ks_s¶
->
˘x
, 
my_debug
, 
NULL
);

703 
	`s¶_£t_ídpoöt
 (
ks_s¶
->
˘x
, 
s¶_˘x
->
ídpoöt
);

705 
	`s¶_£t_∫g
 (
ks_s¶
->
˘x
, 
˘r_drbg_øndom
, 
	`ønd_˘x_gë
());

707 i‡(
s¶_˘x
->
Ælowed_cùhîs
)

708 
	`s¶_£t_cùhîsuôes
 (
ks_s¶
->
˘x
, 
s¶_˘x
->
Ælowed_cùhîs
);

711 i‡(
is_£rvî
)

712 
	`s¶_£t_dh_∑øm_˘x
 (
ks_s¶
->
˘x
, 
s¶_˘x
->
dhm_˘x
 );

713 #i‡
	`deföed
(
ENABLE_PKCS11
)

714 i‡(
s¶_˘x
->
¥iv_key_pkcs11
 !
NULL
)

715 
	`s¶_£t_own_˚π_Æt
–
ks_s¶
->
˘x
, 
s¶_˘x
->
¸t_chaö
,

716 
s¶_˘x
->
¥iv_key_pkcs11
, 
s¶_pkcs11_de¸y±
, 
s¶_pkcs11_sign
,

717 
s¶_pkcs11_key_Àn
 );

720 #i‡
	`deföed
(
MANAGMENT_EXTERNAL_KEY
)

721 i‡(
s¶_˘x
->
exã∫Æ_key
 !
NULL
)

722 
	`s¶_£t_own_˚π_Æt
–
ks_s¶
->
˘x
, 
s¶_˘x
->
¸t_chaö
,

723 
s¶_˘x
->
exã∫Æ_key
, 
NULL
, 
exã∫Æ_pkcs1_sign
,

724 
exã∫Æ_key_Àn
 );

727 
	`s¶_£t_own_˚π
–
ks_s¶
->
˘x
, 
s¶_˘x
->
¸t_chaö
, s¶_˘x->
¥iv_key
 );

730 #i‡
P2MP_SERVER


731 i‡(
£ssi⁄
->
›t
->
s¶_Êags
 & 
SSLF_CLIENT_CERT_NOT_REQUIRED
)

733 
	`msg
 (
M_WARN
, "WARNING: POTENTIALLY DANGEROUS OPTION "

740 
	`s¶_£t_authmode
 (
ks_s¶
->
˘x
, 
SSL_VERIFY_REQUIRED
);

741 
	`s¶_£t_vîify
 (
ks_s¶
->
˘x
, 
vîify_ˇŒback
, 
£ssi⁄
);

745 
	`s¶_£t_ˇ_chaö
 (
ks_s¶
->
˘x
, 
s¶_˘x
->
ˇ_chaö
, 
NULL
, NULL );

749 c⁄° 
és_vîsi⁄_mö
 =

750 (
£ssi⁄
->
›t
->
s¶_Êags
 >> 
SSLF_TLS_VERSION_MIN_SHIFT
) &

751 
SSLF_TLS_VERSION_MIN_MASK
;

754 
maj‹
 = 
SSL_MAJOR_VERSION_3
;

755 
mö‹
 = 
SSL_MINOR_VERSION_1
;

757 i‡(
és_vîsi⁄_mö
 > 
TLS_VER_UNSPEC
)

758 
	`és_vîsi⁄_to_maj‹_mö‹
(
és_vîsi⁄_mö
, &
maj‹
, &
mö‹
);

760 
	`s¶_£t_mö_vîsi⁄
(
ks_s¶
->
˘x
, 
maj‹
, 
mö‹
);

765 c⁄° 
és_vîsi⁄_max
 =

766 (
£ssi⁄
->
›t
->
s¶_Êags
 >> 
SSLF_TLS_VERSION_MAX_SHIFT
) &

767 
SSLF_TLS_VERSION_MAX_MASK
;

769 i‡(
és_vîsi⁄_max
 > 
TLS_VER_UNSPEC
)

771 
maj‹
, 
mö‹
;

772 
	`és_vîsi⁄_to_maj‹_mö‹
(
és_vîsi⁄_max
, &
maj‹
, &
mö‹
);

773 
	`s¶_£t_max_vîsi⁄
(
ks_s¶
->
˘x
, 
maj‹
, 
mö‹
);

778 
	`ALLOC_OBJ_CLEAR
 (
ks_s¶
->
˘_ö
, 
ídÀss_buf„r
);

779 
	`ALLOC_OBJ_CLEAR
 (
ks_s¶
->
˘_out
, 
ídÀss_buf„r
);

780 
	`s¶_£t_bio
 (
ks_s¶
->
˘x
, 
ídÀss_buf_ªad
, ks_s¶->
˘_ö
,

781 
ídÀss_buf_wrôe
, 
ks_s¶
->
˘_out
);

783 
	}
}

786 
	$key_°©e_s¶_‰ì
(
key_°©e_s¶
 *
ks_s¶
)

788 i‡(
ks_s¶
) {

789 i‡(
ks_s¶
->
˘x
)

791 
	`s¶_‰ì
(
ks_s¶
->
˘x
);

792 
	`‰ì
(
ks_s¶
->
˘x
);

794 i‡(
ks_s¶
->
˘_ö
) {

795 
	`buf_‰ì_íåõs
(
ks_s¶
->
˘_ö
);

796 
	`‰ì
(
ks_s¶
->
˘_ö
);

798 i‡(
ks_s¶
->
˘_out
) {

799 
	`buf_‰ì_íåõs
(
ks_s¶
->
˘_out
);

800 
	`‰ì
(
ks_s¶
->
˘_out
);

802 
	`CLEAR
(*
ks_s¶
);

804 
	}
}

807 
	$key_°©e_wrôe_∂aöãxt
 (
key_°©e_s¶
 *
ks
, 
buf„r
 *
buf
)

809 
ªtvÆ
 = 0;

810 
	`≥rf_push
 (
PERF_BIO_WRITE_PLAINTEXT
);

812 
	`ASSERT
 (
NULL
 !
ks
);

813 
	`ASSERT
 (
buf
);

814 
	`ASSERT
 (
buf
->
Àn
 >= 0);

816 i‡(0 =
buf
->
Àn
)

819 
	`≥rf_p›
 ();

822 
ªtvÆ
 = 
	`s¶_wrôe
(
ks
->
˘x
, 
	`BPTR
(
buf
), buf->
Àn
);

824 i‡(
ªtvÆ
 < 0)

826 
	`≥rf_p›
 ();

827 i‡(
POLARSSL_ERR_NET_WANT_WRITE
 =
ªtvÆ
 || 
POLARSSL_ERR_NET_WANT_READ
 ==Ñetval)

829 
	`msg
 (
D_TLS_ERRORS
, "TLS ERROR: writeÅls_write_plaintextÉrror");

833 i‡(
ªtvÆ
 !
buf
->
Àn
)

835 
	`msg
 (
D_TLS_ERRORS
,

837 
ªtvÆ
, 
buf
->
Àn
);

838 
	`≥rf_p›
 ();

843 
	`dmsg
 (
D_HANDSHAKE_VERBOSE
, "wrôêés_wrôe_∂aöãxà%d byãs", 
ªtvÆ
);

845 
	`mem£t
 (
	`BPTR
 (
buf
), 0, 
	`BLEN
 (buf));

846 
buf
->
Àn
 = 0;

848 
	`≥rf_p›
 ();

850 
	}
}

853 
	$key_°©e_wrôe_∂aöãxt_c⁄°
 (
key_°©e_s¶
 *
ks
, c⁄° 
uöt8_t
 *
d©a
, 
Àn
)

855 
ªtvÆ
 = 0;

856 
	`≥rf_push
 (
PERF_BIO_WRITE_PLAINTEXT
);

858 
	`ASSERT
 (
NULL
 !
ks
);

859 
	`ASSERT
 (
Àn
 >= 0);

861 i‡(0 =
Àn
)

863 
	`≥rf_p›
 ();

867 
	`ASSERT
 (
d©a
);

869 
ªtvÆ
 = 
	`s¶_wrôe
(
ks
->
˘x
, 
d©a
, 
Àn
);

871 i‡(
ªtvÆ
 < 0)

873 
	`≥rf_p›
 ();

874 i‡(
POLARSSL_ERR_NET_WANT_WRITE
 =
ªtvÆ
 || 
POLARSSL_ERR_NET_WANT_READ
 ==Ñetval)

876 
	`msg
 (
D_TLS_ERRORS
, "TLS ERROR: writeÅls_write_plaintext_constÉrror");

880 i‡(
ªtvÆ
 !
Àn
)

882 
	`msg
 (
D_TLS_ERRORS
,

884 
ªtvÆ
, 
Àn
);

885 
	`≥rf_p›
 ();

890 
	`dmsg
 (
D_HANDSHAKE_VERBOSE
, "wrôêés_wrôe_∂aöãxt_c⁄° %d byãs", 
ªtvÆ
);

892 
	`≥rf_p›
 ();

894 
	}
}

897 
	$key_°©e_ªad_cùhîãxt
 (
key_°©e_s¶
 *
ks
, 
buf„r
 *
buf
,

898 
maxÀn
)

900 
ªtvÆ
 = 0;

901 
Àn
 = 0;

902 
îr‹_mesßge
[1024];

904 
	`≥rf_push
 (
PERF_BIO_READ_CIPHERTEXT
);

906 
	`ASSERT
 (
NULL
 !
ks
);

907 
	`ASSERT
 (
buf
);

908 
	`ASSERT
 (
buf
->
Àn
 >= 0);

910 i‡(
buf
->
Àn
)

912 
	`≥rf_p›
 ();

916 
Àn
 = 
	`buf_f‹w¨d_ˇ∑côy
 (
buf
);

917 i‡(
maxÀn
 < 
Àn
)

918 
Àn
 = 
maxÀn
;

920 
ªtvÆ
 = 
	`ídÀss_buf_ªad
(
ks
->
˘_out
, 
	`BPTR
(
buf
), 
Àn
);

923 i‡(
ªtvÆ
 < 0)

925 
	`≥rf_p›
 ();

926 i‡(
POLARSSL_ERR_NET_WANT_WRITE
 =
ªtvÆ
 || 
POLARSSL_ERR_NET_WANT_READ
 ==Ñetval)

928 
	`îr‹_°ªº‹
(
ªtvÆ
, 
îr‹_mesßge
, (error_message));

929 
	`msg
 (
D_TLS_ERRORS
, "TLS_ERROR:ÑódÅls_ªad_cùhîãxàîr‹: %d %s", 
ªtvÆ
, 
îr‹_mesßge
);

930 
buf
->
Àn
 = 0;

934 i‡(0 =
ªtvÆ
)

936 
buf
->
Àn
 = 0;

937 
	`≥rf_p›
 ();

942 
	`dmsg
 (
D_HANDSHAKE_VERBOSE
, "ªadÅls_ªad_cùhîãxà%d byãs", 
ªtvÆ
);

943 
buf
->
Àn
 = 
ªtvÆ
;

944 
	`≥rf_p›
 ();

946 
	}
}

949 
	$key_°©e_wrôe_cùhîãxt
 (
key_°©e_s¶
 *
ks
, 
buf„r
 *
buf
)

951 
ªtvÆ
 = 0;

952 
	`≥rf_push
 (
PERF_BIO_WRITE_CIPHERTEXT
);

954 
	`ASSERT
 (
NULL
 !
ks
);

955 
	`ASSERT
 (
buf
);

956 
	`ASSERT
 (
buf
->
Àn
 >= 0);

958 i‡(0 =
buf
->
Àn
)

960 
	`≥rf_p›
 ();

964 
ªtvÆ
 = 
	`ídÀss_buf_wrôe
(
ks
->
˘_ö
, 
	`BPTR
(
buf
), buf->
Àn
);

966 i‡(
ªtvÆ
 < 0)

968 
	`≥rf_p›
 ();

970 i‡(
POLARSSL_ERR_NET_WANT_WRITE
 =
ªtvÆ
 || 
POLARSSL_ERR_NET_WANT_READ
 ==Ñetval)

972 
	`msg
 (
D_TLS_ERRORS
, "TLS ERROR: writeÅls_write_ciphertextÉrror");

976 i‡(
ªtvÆ
 !
buf
->
Àn
)

978 
	`msg
 (
D_TLS_ERRORS
,

980 
ªtvÆ
, 
buf
->
Àn
);

981 
	`≥rf_p›
 ();

986 
	`dmsg
 (
D_HANDSHAKE_VERBOSE
, "wrôêés_wrôe_cùhîãxà%d byãs", 
ªtvÆ
);

988 
	`mem£t
 (
	`BPTR
 (
buf
), 0, 
	`BLEN
 (buf));

989 
buf
->
Àn
 = 0;

991 
	`≥rf_p›
 ();

993 
	}
}

996 
	$key_°©e_ªad_∂aöãxt
 (
key_°©e_s¶
 *
ks
, 
buf„r
 *
buf
,

997 
maxÀn
)

999 
ªtvÆ
 = 0;

1000 
Àn
 = 0;

1001 
îr‹_mesßge
[1024];

1003 
	`≥rf_push
 (
PERF_BIO_READ_PLAINTEXT
);

1005 
	`ASSERT
 (
NULL
 !
ks
);

1006 
	`ASSERT
 (
buf
);

1007 
	`ASSERT
 (
buf
->
Àn
 >= 0);

1009 i‡(
buf
->
Àn
)

1011 
	`≥rf_p›
 ();

1015 
Àn
 = 
	`buf_f‹w¨d_ˇ∑côy
 (
buf
);

1016 i‡(
maxÀn
 < 
Àn
)

1017 
Àn
 = 
maxÀn
;

1019 
ªtvÆ
 = 
	`s¶_ªad
(
ks
->
˘x
, 
	`BPTR
(
buf
), 
Àn
);

1022 i‡(
ªtvÆ
 < 0)

1024 i‡(
POLARSSL_ERR_NET_WANT_WRITE
 =
ªtvÆ
 || 
POLARSSL_ERR_NET_WANT_READ
 ==Ñetval)

1026 
	`îr‹_°ªº‹
(
ªtvÆ
, 
îr‹_mesßge
, (error_message));

1027 
	`msg
 (
D_TLS_ERRORS
, "TLS_ERROR:ÑódÅls_ªad_∂aöãxàîr‹: %d %s", 
ªtvÆ
, 
îr‹_mesßge
);

1028 
buf
->
Àn
 = 0;

1029 
	`≥rf_p›
 ();

1033 i‡(0 =
ªtvÆ
)

1035 
buf
->
Àn
 = 0;

1036 
	`≥rf_p›
 ();

1041 
	`dmsg
 (
D_HANDSHAKE_VERBOSE
, "ªadÅls_ªad_∂aöãxà%d byãs", 
ªtvÆ
);

1042 
buf
->
Àn
 = 
ªtvÆ
;

1044 
	`≥rf_p›
 ();

1046 
	}
}

1056 
	$¥öt_dëaûs
 (
key_°©e_s¶
 * 
ks_s¶
, c⁄° *
¥efix
)

1058 c⁄° 
x509_˚π
 *
˚π
;

1059 
s1
[256];

1060 
s2
[256];

1062 
s1
[0] = 
s2
[0] = 0;

1063 
	`›ív≤_¢¥ötf
 (
s1
,  (s1), "%s %s, cipher %s",

1064 
¥efix
,

1065 
	`s¶_gë_vîsi⁄
 (
ks_s¶
->
˘x
),

1066 
	`s¶_gë_cùhîsuôe
(
ks_s¶
->
˘x
));

1068 
˚π
 = 
	`s¶_gë_≥î_˚π
(
ks_s¶
->
˘x
);

1069 i‡(
˚π
 !
NULL
)

1071 
	`›ív≤_¢¥ötf
 (
s2
,  (s2), ", " 
cou¡î_f‹m©
 " bô RSA", (
cou¡î_ty≥
Ë
˚π
->
rß
.
Àn
 * 8);

1074 
	`msg
 (
D_HANDSHAKE
, "%s%s", 
s1
, 
s2
);

1075 
	}
}

1078 
	$show_avaûabÀ_és_cùhîs
 (c⁄° *
cùhî_li°
)

1080 
és_roŸ_˘x
 
és_˘x
;

1081 c⁄° *
cùhîs
 = 
	`s¶_li°_cùhîsuôes
();

1083 i‡(
cùhî_li°
) {

1084 
	`és_˘x_ª°ri˘_cùhîs
(&
és_˘x
, 
cùhî_li°
);

1085 
cùhîs
 = 
és_˘x
.
Ælowed_cùhîs
;

1088 #i‚de‡
ENABLE_SMALL


1089 
	`¥ötf
 ("Available TLS Ciphers,\n");

1090 
	`¥ötf
 ("listed in order ofÖreference:\n\n");

1093 *
cùhîs
 != 0)

1095 
	`¥ötf
 ("%s\n", 
	`s¶_gë_cùhîsuôe_«me
(*
cùhîs
));

1096 
cùhîs
++;

1098 
	`¥ötf
 ("\n");

1099 
	}
}

1102 
	$gë_highe°_¥e„ªn˚_és_cùhî
 (*
buf
, 
size
)

1104 c⁄° *
cùhî_«me
;

1105 c⁄° *
cùhîs
 = 
	`s¶_li°_cùhîsuôes
();

1106 i‡(*
cùhîs
 == 0)

1107 
	`msg
 (
M_FATAL
, "CannotÑetrieveÜist of supported SSL ciphers.");

1109 
cùhî_«me
 = 
	`s¶_gë_cùhîsuôe_«me
(*
cùhîs
);

1110 
	`°∫˝y¡
 (
buf
, 
cùhî_«me
, 
size
);

1111 
	}
}

1114 
	$gë_s¶_libøry_vîsi⁄
()

1116 
pﬁ¨_vîsi⁄
[30];

1117 
pv
 = 
	`vîsi⁄_gë_numbî
();

1118 
	`•rötf
–
pﬁ¨_vîsi⁄
, "PolarSSL %d.%d.%d",

1119 (
pv
>>24)&0xff, (pv>>16)&0xff, (pv>>8)&0xff );

1120  
pﬁ¨_vîsi⁄
;

1121 
	}
}

	@src/openvpn/ssl_polarssl.h

30 #i‚de‡
SSL_POLARSSL_H_


31 
	#SSL_POLARSSL_H_


	)

33 
	~"syshód.h
"

35 
	~<pﬁ¨s¶/s¶.h
>

37 #i‡
deföed
(
ENABLE_PKCS11
)

38 
	~<pﬁ¨s¶/pkcs11.h
>

41 
_buf„r_íåy
 
	tbuf„r_íåy
;

43 
	s_buf„r_íåy
 {

44 
size_t
 
	mÀngth
;

45 
uöt8_t
 *
	md©a
;

46 
buf„r_íåy
 *
	m√xt_block
;

50 
size_t
 
	md©a_°¨t
;

51 
buf„r_íåy
 *
	mfú°_block
;

52 
buf„r_íåy
 *
	mœ°_block
;

53 } 
	tídÀss_buf„r
;

61 
	sés_roŸ_˘x
 {

62 
boﬁ
 
	möôüli£d
;

64 
	mídpoöt
;

66 
dhm_c⁄ãxt
 *
	mdhm_˘x
;

67 
x509_˚π
 *
	m¸t_chaö
;

68 
x509_˚π
 *
	mˇ_chaö
;

69 
rß_c⁄ãxt
 *
	m¥iv_key
;

70 #i‡
deföed
(
ENABLE_PKCS11
)

71 
pkcs11_c⁄ãxt
 *
	m¥iv_key_pkcs11
;

73 #ifde‡
MANAGMENT_EXTERNAL_KEY


74 
exã∫Æ_c⁄ãxt
 *
	mexã∫Æ_key
;

76 * 
	mÆlowed_cùhîs
;

79 
	skey_°©e_s¶
 {

80 
s¶_c⁄ãxt
 *
	m˘x
;

81 
ídÀss_buf„r
 *
	m˘_ö
;

82 
ídÀss_buf„r
 *
	m˘_out
;

	@src/openvpn/ssl_verify.c

30 #ifde‡
HAVE_CONFIG_H


31 
	~"c⁄fig.h
"

32 #ñi‡
deföed
(
_MSC_VER
)

33 
	~"c⁄fig-msvc.h
"

36 
	~"syshód.h
"

38 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

40 
	~"misc.h
"

41 
	~"m™age.h
"

42 
	~"s¶_vîify.h
"

43 
	~"s¶_vîify_backíd.h
"

45 #ifde‡
ENABLE_CRYPTO_OPENSSL


46 
	~"s¶_vîify_›ís¶.h
"

50 
	#TLS_USERNAME_LEN
 64

	)

53 
	#X509_NAME_CHAR_CLASS
 (
CC_ALNUM
|
CC_UNDERBAR
|
CC_DASH
|
CC_DOT
|
CC_AT
|
CC_SLASH
|
CC_COLON
|
CC_EQUAL
)

	)

56 
	#COMMON_NAME_CHAR_CLASS
 (
CC_ALNUM
|
CC_UNDERBAR
|
CC_DASH
|
CC_DOT
|
CC_AT
|
CC_SLASH
)

	)

59 
	$°rög_mod_ªm≠_«me
 (*
°r
, c⁄° 
ª°ri˘ive_Êags
)

61 i‡(
	`com∑t_Êag
 (
COMPAT_FLAG_QUERY
 | 
COMPAT_NAMES
)

62 && !
	`com∑t_Êag
 (
COMPAT_FLAG_QUERY
 | 
COMPAT_NO_NAME_REMAPPING
))

63 
	`°rög_mod
 (
°r
, 
ª°ri˘ive_Êags
, 0, '_');

65 
	`°rög_mod
 (
°r
, 
CC_PRINT
, 
CC_CRLF
, '_');

66 
	}
}

72 
	$£ãnv_u¡ru°ed
 (
és_£ssi⁄
 *
£ssi⁄
)

74 
	`£ãnv_lök_sockë_a˘uÆ
 (
£ssi⁄
->
›t
->
es
, "u¡ru°ed", &£ssi⁄->
u¡ru°ed_addr
, 
SA_IP_PORT
);

75 
	}
}

81 
	$és_dóuthítiˇã
 (
és_mu…i
 *
mu…i
)

83 i‡(
mu…i
)

85 
i
, 
j
;

86 
i
 = 0; i < 
TM_SIZE
; ++i)

87 
j
 = 0; j < 
KS_SIZE
; ++j)

88 
mu…i
->
£ssi⁄
[
i
].
key
[
j
].
authítiˇãd
 = 
Ál£
;

90 
	}
}

96 
	$£t_comm⁄_«me
 (
és_£ssi⁄
 *
£ssi⁄
, c⁄° *
comm⁄_«me
)

98 i‡(
£ssi⁄
->
comm⁄_«me
)

100 
	`‰ì
 (
£ssi⁄
->
comm⁄_«me
);

101 
£ssi⁄
->
comm⁄_«me
 = 
NULL
;

102 #ifde‡
ENABLE_PF


103 
£ssi⁄
->
comm⁄_«me_hashvÆ
 = 0;

106 i‡(
comm⁄_«me
)

109 
£ssi⁄
->
comm⁄_«me
 = 
	`°rög_Æloc
 (comm⁄_«me, 
NULL
);

110 #ifde‡
ENABLE_PF


112 c⁄° 
uöt32_t
 
Àn
 = (uöt32_tË
	`°æí
 (
comm⁄_«me
);

113 i‡(
Àn
)

114 
£ssi⁄
->
comm⁄_«me_hashvÆ
 = 
	`hash_func
 ((c⁄° 
uöt8_t
*)
comm⁄_«me
, 
Àn
+1, 0);

116 
£ssi⁄
->
comm⁄_«me_hashvÆ
 = 0;

120 
	}
}

128 
	$és_comm⁄_«me
 (c⁄° 
és_mu…i
 *
mu…i
, c⁄° 
boﬁ
 
nuŒ
)

130 c⁄° *
ªt
 = 
NULL
;

131 i‡(
mu…i
)

132 
ªt
 = 
mu…i
->
£ssi⁄
[
TM_ACTIVE
].
comm⁄_«me
;

133 i‡(
ªt
 && 
	`°æí
 (ret))

134  
ªt
;

135 i‡(
nuŒ
)

136  
NULL
;

139 
	}
}

145 
	$és_lock_comm⁄_«me
 (
és_mu…i
 *
mu…i
)

147 c⁄° *
˙
 = 
mu…i
->
£ssi⁄
[
TM_ACTIVE
].
comm⁄_«me
;

148 i‡(
˙
 && !
mu…i
->
locked_˙
)

149 
mu…i
->
locked_˙
 = 
	`°rög_Æloc
 (
˙
, 
NULL
);

150 
	}
}

155 
boﬁ


156 
	$és_lock_u£∫ame
 (
és_mu…i
 *
mu…i
, c⁄° *
u£∫ame
)

158 i‡(
mu…i
->
locked_u£∫ame
)

160 i‡(!
u£∫ame
 || 
	`°rcmp
 (u£∫ame, 
mu…i
->
locked_u£∫ame
))

162 
	`msg
 (
D_TLS_ERRORS
, "TLS Auth Error: usernameáttemptedÅo change from '%s'Åo '%s' --Åunnel disabled",

163 
mu…i
->
locked_u£∫ame
,

164 
	`≈
(
u£∫ame
));

167 
	`és_dóuthítiˇã
 (
mu…i
);

168  
Ál£
;

173 i‡(
u£∫ame
)

174 
mu…i
->
locked_u£∫ame
 = 
	`°rög_Æloc
 (
u£∫ame
, 
NULL
);

176  
åue
;

177 
	}
}

180 
	$és_u£∫ame
 (c⁄° 
és_mu…i
 *
mu…i
, c⁄° 
boﬁ
 
nuŒ
)

182 c⁄° *
ªt
 = 
NULL
;

183 i‡(
mu…i
)

184 
ªt
 = 
mu…i
->
locked_u£∫ame
;

185 i‡(
ªt
 && 
	`°æí
 (ret))

186  
ªt
;

187 i‡(
nuŒ
)

188  
NULL
;

191 
	}
}

194 
	$˚π_hash_ªmembî
 (
és_£ssi⁄
 *
£ssi⁄
, c⁄° 
îr‹_dïth
, c⁄° *
sha1_hash
)

196 i‡(
îr‹_dïth
 >0 &&Éº‹_dïth < 
MAX_CERT_DEPTH
)

198 i‡(!
£ssi⁄
->
˚π_hash_£t
)

199 
	`ALLOC_OBJ_CLEAR
 (
£ssi⁄
->
˚π_hash_£t
, cert_hash_set);

200 i‡(!
£ssi⁄
->
˚π_hash_£t
->
ch
[
îr‹_dïth
])

201 
	`ALLOC_OBJ
 (
£ssi⁄
->
˚π_hash_£t
->
ch
[
îr‹_dïth
], 
˚π_hash
);

203 
˚π_hash
 *
ch
 = 
£ssi⁄
->
˚π_hash_£t
->ch[
îr‹_dïth
];

204 
	`mem˝y
 (
ch
->
sha1_hash
, sha1_hash, 
SHA_DIGEST_LENGTH
);

207 
	}
}

211 
	$˚π_hash_¥öt
 (c⁄° 
˚π_hash_£t
 *
chs
, 
msgÀvñ
)

213 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

214 
	`msg
 (
msgÀvñ
, "CERT_HASH");

215 i‡(
chs
)

217 
i
;

218 
i
 = 0; i < 
MAX_CERT_DEPTH
; ++i)

220 c⁄° 
˚π_hash
 *
ch
 = 
chs
->ch[
i
];

221 i‡(
ch
)

222 
	`msg
 (
msgÀvñ
, "%d:%s", 
i
, 
	`f‹m©_hex
(
ch
->
sha1_hash
, 
SHA_DIGEST_LENGTH
, 0, &
gc
));

225 
	`gc_‰ì
 (&
gc
);

226 
	}
}

230 
	$˚π_hash_‰ì
 (
˚π_hash_£t
 *
chs
)

232 i‡(
chs
)

234 
i
;

235 
i
 = 0; i < 
MAX_CERT_DEPTH
; ++i)

236 
	`‰ì
 (
chs
->
ch
[
i
]);

237 
	`‰ì
 (
chs
);

239 
	}
}

241 
boﬁ


242 
	$˚π_hash_com∑ª
 (c⁄° 
˚π_hash_£t
 *
chs1
, c⁄° ˚π_hash_£à*
chs2
)

244 i‡(
chs1
 && 
chs2
)

246 
i
;

247 
i
 = 0; i < 
MAX_CERT_DEPTH
; ++i)

249 c⁄° 
˚π_hash
 *
ch1
 = 
chs1
->
ch
[
i
];

250 c⁄° 
˚π_hash
 *
ch2
 = 
chs2
->
ch
[
i
];

252 i‡(!
ch1
 && !
ch2
)

254 i‡(
ch1
 && 
ch2
 && !
	`memcmp
 (ch1->
sha1_hash
, ch2->sha1_hash, 
SHA_DIGEST_LENGTH
))

257  
Ál£
;

259  
åue
;

261 i‡(!
chs1
 && !
chs2
)

262  
åue
;

264  
Ál£
;

265 
	}
}

267 
˚π_hash_£t
 *

268 
	$˚π_hash_c›y
 (c⁄° 
˚π_hash_£t
 *
chs
)

270 
˚π_hash_£t
 *
de°
 = 
NULL
;

271 i‡(
chs
)

273 
i
;

274 
	`ALLOC_OBJ_CLEAR
 (
de°
, 
˚π_hash_£t
);

275 
i
 = 0; i < 
MAX_CERT_DEPTH
; ++i)

277 c⁄° 
˚π_hash
 *
ch
 = 
chs
->ch[
i
];

278 i‡(
ch
)

280 
	`ALLOC_OBJ
 (
de°
->
ch
[
i
], 
˚π_hash
);

281 
	`mem˝y
 (
de°
->
ch
[
i
]->
sha1_hash
, ch->sha1_hash, 
SHA_DIGEST_LENGTH
);

285  
de°
;

286 
	}
}

288 
	$és_lock_˚π_hash_£t
 (
és_mu…i
 *
mu…i
)

290 c⁄° 
˚π_hash_£t
 *
chs
 = 
mu…i
->
£ssi⁄
[
TM_ACTIVE
].cert_hash_set;

291 i‡(
chs
 && !
mu…i
->
locked_˚π_hash_£t
)

292 
mu…i
->
locked_˚π_hash_£t
 = 
	`˚π_hash_c›y
 (
chs
);

293 
	}
}

299 
	$¥öt_nsCîtTy≥
 (
ty≥
)

301 
ty≥
)

303 
NS_CERT_CHECK_SERVER
:

305 
NS_CERT_CHECK_CLIENT
:

310 
	}
}

320 
ªsu…_t


321 
	$vîify_≥î_˚π
(c⁄° 
és_›ti⁄s
 *
›t
, 
›ív≤_x509_˚π_t
 *
≥î_˚π
,

322 c⁄° *
subje˘
, c⁄° *
comm⁄_«me
)

325 i‡(
›t
->
ns_˚π_ty≥
 !
NS_CERT_CHECK_NONE
)

327 i‡(
SUCCESS
 =
	`x509_vîify_ns_˚π_ty≥
 (
≥î_˚π
, 
›t
->
ns_˚π_ty≥
))

329 
	`msg
 (
D_HANDSHAKE
, "VERIFY OK:ÇsCertType=%s",

330 
	`¥öt_nsCîtTy≥
 (
›t
->
ns_˚π_ty≥
));

334 
	`msg
 (
D_HANDSHAKE
, "VERIFYÇsCertType ERROR: %s,ÑequireÇsCertType=%s",

335 
subje˘
, 
	`¥öt_nsCîtTy≥
 (
›t
->
ns_˚π_ty≥
));

336  
FAILURE
;

340 #i‡
OPENSSL_VERSION_NUMBER
 >0x00907000L || 
ENABLE_CRYPTO_POLARSSL


343 i‡(
›t
->
ªmŸe_˚π_ku
[0] != 0)

345 i‡(
SUCCESS
 =
	`x509_vîify_˚π_ku
 (
≥î_˚π
, 
›t
->
ªmŸe_˚π_ku
, 
MAX_PARMS
))

347 
	`msg
 (
D_HANDSHAKE
, "VERIFY KU OK");

351 
	`msg
 (
D_HANDSHAKE
, "VERIFY KU ERROR");

352  
FAILURE
;

357 i‡(
›t
->
ªmŸe_˚π_eku
 !
NULL
)

359 i‡(
SUCCESS
 =
	`x509_vîify_˚π_eku
 (
≥î_˚π
, 
›t
->
ªmŸe_˚π_eku
))

361 
	`msg
 (
D_HANDSHAKE
, "VERIFY EKU OK");

365 
	`msg
 (
D_HANDSHAKE
, "VERIFY EKU ERROR");

366  
FAILURE
;

373 i‡(
›t
->
vîify_x509_ty≥
 !
VERIFY_X509_NONE
)

375 i‡–(
›t
->
vîify_x509_ty≥
 =
VERIFY_X509_SUBJECT_DN


376 && 
	`°rcmp
 (
›t
->
vîify_x509_«me
, 
subje˘
) == 0)

377 || (
›t
->
vîify_x509_ty≥
 =
VERIFY_X509_SUBJECT_RDN


378 && 
	`°rcmp
 (
›t
->
vîify_x509_«me
, 
comm⁄_«me
) == 0)

379 || (
›t
->
vîify_x509_ty≥
 =
VERIFY_X509_SUBJECT_RDN_PREFIX


380 && 
	`°∫cmp
 (
›t
->
vîify_x509_«me
, 
comm⁄_«me
,

381 
	`°æí
 (
›t
->
vîify_x509_«me
)) == 0) )

382 
	`msg
 (
D_HANDSHAKE
, "VERIFY X509NAME OK: %s", 
subje˘
);

385 
	`msg
 (
D_HANDSHAKE
, "VERIFY X509NAME ERROR: %s, must be %s",

386 
subje˘
, 
›t
->
vîify_x509_«me
);

387  
FAILURE
;

391  
SUCCESS
;

392 
	}
}

399 
vîify_˚π_£t_ív
(
ív_£t
 *
es
, 
›ív≤_x509_˚π_t
 *
≥î_˚π
, 
˚π_dïth
,

400 c⁄° *
subje˘
, c⁄° *
comm⁄_«me


401 #ifde‡
ENABLE_X509_TRACK


402 , c⁄° 
x509_åack
 *x509_track

406 
	gív«me
[64];

407 *
	g£rül
 = 
NULL
;

408 
gc_¨ía
 
	ggc
 = 
gc_√w
 ();

411 #ifde‡
ENABLE_X509_TRACK


412 i‡(
	gx509_åack
)

413 
x509_£ãnv_åack
 (
x509_åack
, 
es
, 
˚π_dïth
, 
≥î_˚π
);

416 
x509_£ãnv
 (
es
, 
˚π_dïth
, 
≥î_˚π
);

419 
›ív≤_¢¥ötf
 (
ív«me
, ”nv«me), "és_id_%d", 
˚π_dïth
);

420 
£ãnv_°r
 (
es
, 
ív«me
, 
subje˘
);

424 
›ív≤_¢¥ötf
 (
ív«me
, ”nv«me), "és_comm⁄_«me_%d", 
˚π_dïth
);

425 
£ãnv_°r
 (
es
, 
ív«me
, 
comm⁄_«me
);

430 *
	gsha1_hash
 = 
x509_gë_sha1_hash
(
≥î_˚π
, &
gc
);

432 
›ív≤_¢¥ötf
 (
ív«me
, ”nv«me), "és_dige°_%d", 
˚π_dïth
);

433 
£ãnv_°r
 (
es
, 
ív«me
, 
f‹m©_hex_ex
(
sha1_hash
, 
SHA_DIGEST_LENGTH
, 0, 1,

434 ":", &
gc
));

438 
	g£rül
 = 
backíd_x509_gë_£rül
(
≥î_˚π
, &
gc
);

439 
›ív≤_¢¥ötf
 (
ív«me
, ”nv«me), "és_£rül_%d", 
˚π_dïth
);

440 
£ãnv_°r
 (
es
, 
ív«me
, 
£rül
);

443 
	g£rül
 = 
backíd_x509_gë_£rül_hex
(
≥î_˚π
, &
gc
);

444 
›ív≤_¢¥ötf
 (
ív«me
, ”nv«me), "és_£rül_hex_%d", 
˚π_dïth
);

445 
£ãnv_°r
 (
es
, 
ív«me
, 
£rül
);

447 
gc_‰ì
(&
gc
);

453 
ªsu…_t


454 
	$vîify_˚π_ˇŒ_∂ugö
(c⁄° 
∂ugö_li°
 *
∂ugös
, 
ív_£t
 *
es
,

455 
˚π_dïth
, 
›ív≤_x509_˚π_t
 *
˚π
, *
subje˘
)

457 i‡(
	`∂ugö_deföed
 (
∂ugös
, 
OPENVPN_PLUGIN_TLS_VERIFY
))

459 
ªt
;

460 
¨gv
árgv = 
	`¨gv_√w
 ();

462 
	`¨gv_¥ötf
 (&
¨gv
, "%d %s", 
˚π_dïth
, 
subje˘
);

464 
ªt
 = 
	`∂ugö_ˇŒ_s¶
 (
∂ugös
, 
OPENVPN_PLUGIN_TLS_VERIFY
, &
¨gv
, 
NULL
, 
es
, 
˚π_dïth
, 
˚π
);

466 
	`¨gv_ª£t
 (&
¨gv
);

468 i‡(
ªt
 =
OPENVPN_PLUGIN_FUNC_SUCCESS
)

470 
	`msg
 (
D_HANDSHAKE
, "VERIFY PLUGIN OK: depth=%d, %s",

471 
˚π_dïth
, 
subje˘
);

475 
	`msg
 (
D_HANDSHAKE
, "VERIFY PLUGIN ERROR: depth=%d, %s",

476 
˚π_dïth
, 
subje˘
);

477  
FAILURE
;

480  
SUCCESS
;

481 
	}
}

484 
	$vîify_˚π_exp‹t_˚π
(
›ív≤_x509_˚π_t
 *
≥î˚π
, c⁄° *
tmp_dú
, 
gc_¨ía
 *
gc
)

486 
FILE
 *
≥î˚π_fûe
;

487 c⁄° *
≥î˚π_fûíame
="";

489 if(!
tmp_dú
)

490  
NULL
;

493 
≥î˚π_fûíame
 = 
	`¸óã_ãmp_fûe
 (
tmp_dú
, "pcf", 
gc
);

496 
≥î˚π_fûe
 = 
	`f›í
(
≥î˚π_fûíame
, "w+");

497 if(!
≥î˚π_fûe
)

499 
	`msg
 (
M_ERR
, "FaûedÅÿ›íÅemp‹¨y fûê: %s", 
≥î˚π_fûíame
);

500  
NULL
;

503 i‡(
SUCCESS
 !
	`x509_wrôe_≥m
(
≥î˚π_fûe
, 
≥î˚π
))

504 
	`msg
 (
M_ERR
, "Error writing PEM file containing certificate");

506 
	`f˛o£
(
≥î˚π_fûe
);

507  
≥î˚π_fûíame
;

508 
	}
}

514 
ªsu…_t


515 
	$vîify_˚π_ˇŒ_comm™d
(c⁄° *
vîify_comm™d
, 
ív_£t
 *
es
,

516 
˚π_dïth
, 
›ív≤_x509_˚π_t
 *
˚π
, *
subje˘
, c⁄° *
vîify_exp‹t_˚π
)

518 c⁄° *
tmp_fûe
 = 
NULL
;

519 
ªt
;

520 
gc_¨ía
 
gc
 = 
	`gc_√w
();

521 
¨gv
árgv = 
	`¨gv_√w
 ();

523 
	`£ãnv_°r
 (
es
, "script_type", "tls-verify");

525 i‡(
vîify_exp‹t_˚π
)

527 i‡((
tmp_fûe
=
	`vîify_˚π_exp‹t_˚π
(
˚π
, 
vîify_exp‹t_˚π
, &
gc
)))

529 
	`£ãnv_°r
(
es
, "≥î_˚π", 
tmp_fûe
);

533 
	`¨gv_¥ötf
 (&
¨gv
, "%s¯%d %s", 
vîify_comm™d
, 
˚π_dïth
, 
subje˘
);

535 
	`¨gv_msg_¥efix
 (
D_TLS_DEBUG
, &
¨gv
, "TLS:Éxecuting verify command");

536 
ªt
 = 
	`›ív≤_run_s¸ùt
 (&
¨gv
, 
es
, 0, "--tls-verify script");

538 i‡(
vîify_exp‹t_˚π
)

540 i‡(
tmp_fûe
)

541 
	`∂©f‹m_u∆ök
(
tmp_fûe
);

544 
	`gc_‰ì
(&
gc
);

545 
	`¨gv_ª£t
 (&
¨gv
);

547 i‡(
ªt
)

549 
	`msg
 (
D_HANDSHAKE
, "VERIFY SCRIPT OK: depth=%d, %s",

550 
˚π_dïth
, 
subje˘
);

551  
SUCCESS
;

554 
	`msg
 (
D_HANDSHAKE
, "VERIFY SCRIPT ERROR: depth=%d, %s",

555 
˚π_dïth
, 
subje˘
);

556  
FAILURE
;

557 
	}
}

562 
ªsu…_t


563 
	$vîify_check_¸l_dú
(c⁄° *
¸l_dú
, 
›ív≤_x509_˚π_t
 *
˚π
)

565 
ªsu…_t
 
ªt
 = 
FAILURE
;

566 
‚
[256];

567 
fd
 = -1;

568 
gc_¨ía
 
gc
 = 
	`gc_√w
();

570 *
£rül
 = 
	`backíd_x509_gë_£rül
(
˚π
, &
gc
);

572 i‡(!
	`›ív≤_¢¥ötf
(
‚
, (‚), "%s%c%s", 
¸l_dú
, 
OS_SPECIFIC_DIRSEP
, 
£rül
))

574 
	`msg
 (
D_HANDSHAKE
, "VERIFY CRL: filename overflow");

575 
˛ónup
;

577 
fd
 = 
	`∂©f‹m_›í
 (
‚
, 
O_RDONLY
, 0);

578 i‡(
fd
 >= 0)

580 
	`msg
 (
D_HANDSHAKE
, "VERIFY CRL: cîtifiˇã sîü»numbî %†i†ªvoked", 
£rül
);

581 
˛ónup
;

584 
ªt
 = 
SUCCESS
;

586 
˛ónup
:

588 i‡(
fd
 != -1)

589 
	`˛o£
(
fd
);

590 
	`gc_‰ì
(&
gc
);

591  
ªt
;

592 
	}
}

594 
ªsu…_t


595 
	$vîify_˚π
(
és_£ssi⁄
 *
£ssi⁄
, 
›ív≤_x509_˚π_t
 *
˚π
, 
˚π_dïth
)

597 
ªsu…_t
 
ªt
 = 
FAILURE
;

598 *
subje˘
 = 
NULL
;

599 
comm⁄_«me
[
TLS_USERNAME_LEN
] = {0};

600 c⁄° 
és_›ti⁄s
 *
›t
;

601 
gc_¨ía
 
gc
 = 
	`gc_√w
();

603 
›t
 = 
£ssi⁄
->opt;

604 
	`ASSERT
 (
›t
);

606 
£ssi⁄
->
vîifõd
 = 
Ál£
;

609 
subje˘
 = 
	`x509_gë_subje˘
(
˚π
, &
gc
);

610 i‡(!
subje˘
)

612 
	`msg
 (
D_TLS_ERRORS
, "VERIFY ERROR: depth=%d, couldÇotÉxtract X509 "

613 "subje˘ såög from cîtifiˇã", 
˚π_dïth
);

614 
˛ónup
;

618 
	`°rög_mod_ªm≠_«me
 (
subje˘
, 
X509_NAME_CHAR_CLASS
);

619 
	`°rög_ª∂a˚_Àadög
 (
subje˘
, '-', '_');

622 i‡(
SUCCESS
 !
	`x509_gë_u£∫ame
 (
comm⁄_«me
, 
TLS_USERNAME_LEN
,

623 
›t
->
x509_u£∫ame_fõld
, 
˚π
))

625 i‡(!
˚π_dïth
)

627 
	`msg
 (
D_TLS_ERRORS
, "VERIFY ERROR: couldÇotÉxtract %s from X509 "

630 
›t
->
x509_u£∫ame_fõld
,

631 
subje˘
,

632 
TLS_USERNAME_LEN
);

633 
˛ónup
;

638 
	`°rög_mod_ªm≠_«me
 (
comm⁄_«me
, 
COMMON_NAME_CHAR_CLASS
);

641 i‡(
˚π_dïth
 >
MAX_CERT_DEPTH
)

643 
	`msg
 (
D_TLS_ERRORS
, "TLS Eº‹: C⁄vﬁuãd cîtifiˇã chaö dëe˘ed wôh dïth [%d] gª©îÅh™ %d", 
˚π_dïth
, 
MAX_CERT_DEPTH
);

644 
˛ónup
;

648 i‡(
˚π_dïth
 =1 && 
›t
->
vîify_hash
)

650 *
sha1_hash
 = 
	`x509_gë_sha1_hash
(
˚π
, &
gc
);

651 i‡(
	`memcmp
 (
sha1_hash
, 
›t
->
vîify_hash
, 
SHA_DIGEST_LENGTH
))

653 
	`msg
 (
D_TLS_ERRORS
, "TLS Error:Üevel-1 certificate hash verification failed");

654 
˛ónup
;

659 i‡(
˚π_dïth
 == 0)

660 
	`£t_comm⁄_«me
 (
£ssi⁄
, 
comm⁄_«me
);

662 
£ssi⁄
->
vîify_maxÀvñ
 = 
	`max_öt
 (£ssi⁄->vîify_maxÀvñ, 
˚π_dïth
);

665 
	`vîify_˚π_£t_ív
(
›t
->
es
, 
˚π
, 
˚π_dïth
, 
subje˘
, 
comm⁄_«me


666 #ifde‡
ENABLE_X509_TRACK


667 , 
›t
->
x509_åack


672 
	`£ãnv_u¡ru°ed
 (
£ssi⁄
);

675 i‡(
˚π_dïth
 =0 && 
SUCCESS
 !
	`vîify_≥î_˚π
(
›t
, 
˚π
, 
subje˘
, 
comm⁄_«me
))

676 
˛ónup
;

679 i‡(
SUCCESS
 !
	`vîify_˚π_ˇŒ_∂ugö
(
›t
->
∂ugös
, o±->
es
, 
˚π_dïth
, 
˚π
, 
subje˘
))

680 
˛ónup
;

683 i‡(
›t
->
vîify_comm™d
 && 
SUCCESS
 !
	`vîify_˚π_ˇŒ_comm™d
(opt->verify_command,

684 
›t
->
es
, 
˚π_dïth
, 
˚π
, 
subje˘
, o±->
vîify_exp‹t_˚π
))

685 
˛ónup
;

688 i‡(
›t
->
¸l_fûe
)

690 i‡(
›t
->
s¶_Êags
 & 
SSLF_CRL_VERIFY_DIR
)

692 i‡(
SUCCESS
 !
	`vîify_check_¸l_dú
(
›t
->
¸l_fûe
, 
˚π
))

693 
˛ónup
;

697 i‡(
SUCCESS
 !
	`x509_vîify_¸l
(
›t
->
¸l_fûe
, 
˚π
, 
subje˘
))

698 
˛ónup
;

702 
	`msg
 (
D_HANDSHAKE
, "VERIFY OK: dïth=%d, %s", 
˚π_dïth
, 
subje˘
);

703 
£ssi⁄
->
vîifõd
 = 
åue
;

704 
ªt
 = 
SUCCESS
;

706 
˛ónup
:

708 i‡(
ªt
 !
SUCCESS
)

710 
	`és_˛ór_îr‹
();

711 
£ssi⁄
->
vîifõd
 = 
Ál£
;

713 
	`gc_‰ì
(&
gc
);

715  
ªt
;

716 
	}
}

723 #ifde‡
ENABLE_DEF_AUTH


726 
	#ACF_UNDEFINED
 0

	)

727 
	#ACF_SUCCEEDED
 1

	)

728 
	#ACF_DISABLED
 2

	)

729 
	#ACF_FAILED
 3

	)

732 #ifde‡
MANAGEMENT_DEF_AUTH


734 
	$m™_def_auth_£t_˛õ¡_ªas⁄
 (
és_mu…i
 *
mu…i
, c⁄° *
˛õ¡_ªas⁄
)

736 i‡(
mu…i
->
˛õ¡_ªas⁄
)

738 
	`‰ì
 (
mu…i
->
˛õ¡_ªas⁄
);

739 
mu…i
->
˛õ¡_ªas⁄
 = 
NULL
;

741 i‡(
˛õ¡_ªas⁄
 && 
	`°æí
 (client_reason))

743 
mu…i
->
˛õ¡_ªas⁄
 = 
	`°rög_Æloc
 (˛õ¡_ªas⁄, 
NULL
);

744 
	}
}

746 
ölöe
 

747 
	$m™_def_auth_ã°
 (c⁄° 
key_°©e
 *
ks
)

749 i‡(
	`m™agemít_íabÀ_def_auth
 (
m™agemít
))

750  
ks
->
mda_°©us
;

752  
ACF_DISABLED
;

753 
	}
}

756 #ifde‡
PLUGIN_DEF_AUTH


763 
	$key_°©e_rm_auth_c⁄åﬁ_fûe
 (
key_°©e
 *
ks
)

765 i‡(
ks
 && ks->
auth_c⁄åﬁ_fûe
)

767 
	`∂©f‹m_u∆ök
 (
ks
->
auth_c⁄åﬁ_fûe
);

768 
	`‰ì
 (
ks
->
auth_c⁄åﬁ_fûe
);

769 
ks
->
auth_c⁄åﬁ_fûe
 = 
NULL
;

771 
	}
}

774 
	$key_°©e_gí_auth_c⁄åﬁ_fûe
 (
key_°©e
 *
ks
, c⁄° 
és_›ti⁄s
 *
›t
)

776 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

777 c⁄° *
acf
;

779 
	`key_°©e_rm_auth_c⁄åﬁ_fûe
 (
ks
);

780 
acf
 = 
	`¸óã_ãmp_fûe
 (
›t
->
tmp_dú
, "acf", &
gc
);

781 i‡(
acf
) {

782 
ks
->
auth_c⁄åﬁ_fûe
 = 
	`°rög_Æloc
 (
acf
, 
NULL
);

783 
	`£ãnv_°r
 (
›t
->
es
, "auth_c⁄åﬁ_fûe", 
ks
->
auth_c⁄åﬁ_fûe
);

786 
	`gc_‰ì
 (&
gc
);

787 
	}
}

790 
	$key_°©e_ã°_auth_c⁄åﬁ_fûe
 (
key_°©e
 *
ks
)

792 i‡(
ks
 && ks->
auth_c⁄åﬁ_fûe
)

794 
ªt
 = 
ks
->
auth_c⁄åﬁ_°©us
;

795 i‡(
ªt
 =
ACF_UNDEFINED
)

797 
FILE
 *
Â
 = 
	`f›í
 (
ks
->
auth_c⁄åﬁ_fûe
, "r");

798 i‡(
Â
)

800 c⁄° 
c
 = 
	`fgëc
 (
Â
);

801 i‡(
c
 == '1')

802 
ªt
 = 
ACF_SUCCEEDED
;

803 i‡(
c
 == '0')

804 
ªt
 = 
ACF_FAILED
;

805 
	`f˛o£
 (
Â
);

806 
ks
->
auth_c⁄åﬁ_°©us
 = 
ªt
;

809  
ªt
;

811  
ACF_DISABLED
;

812 
	}
}

822 
	$és_authítiˇti⁄_°©us
 (
és_mu…i
 *
mu…i
, c⁄° 
œãncy
)

824 
boﬁ
 
de„ºed
 = 
Ál£
;

825 
boﬁ
 
suc˚ss
 = 
Ál£
;

826 
boﬁ
 
a˘ive
 = 
Ál£
;

828 #ifde‡
ENABLE_DEF_AUTH


829 c⁄° 
acf_mîge
[] =

831 
ACF_UNDEFINED
,

832 
ACF_UNDEFINED
,

833 
ACF_UNDEFINED
,

834 
ACF_FAILED
,

835 
ACF_UNDEFINED
,

836 
ACF_SUCCEEDED
,

837 
ACF_SUCCEEDED
,

838 
ACF_FAILED
,

839 
ACF_UNDEFINED
,

840 
ACF_SUCCEEDED
,

841 
ACF_DISABLED
,

842 
ACF_FAILED
,

843 
ACF_FAILED
,

844 
ACF_FAILED
,

845 
ACF_FAILED
,

846 
ACF_FAILED


850 i‡(
mu…i
)

852 
i
;

854 #ifde‡
ENABLE_DEF_AUTH


855 i‡(
œãncy
 && 
mu…i
->
ès_œ°
 && mu…i->ès_œ° +Ü©ícy >
now
)

856  
TLS_AUTHENTICATION_UNDEFINED
;

857 
mu…i
->
ès_œ°
 = 
now
;

860 
i
 = 0; i < 
KEY_SCAN_SIZE
; ++i)

862 
key_°©e
 *
ks
 = 
mu…i
->
key_sˇn
[
i
];

863 i‡(
	`DECRYPT_KEY_ENABLED
 (
mu…i
, 
ks
))

865 
a˘ive
 = 
åue
;

866 i‡(
ks
->
authítiˇãd
)

868 #ifde‡
ENABLE_DEF_AUTH


869 
s1
 = 
ACF_DISABLED
;

870 
s2
 = 
ACF_DISABLED
;

871 #ifde‡
PLUGIN_DEF_AUTH


872 
s1
 = 
	`key_°©e_ã°_auth_c⁄åﬁ_fûe
 (
ks
);

874 #ifde‡
MANAGEMENT_DEF_AUTH


875 
s2
 = 
	`m™_def_auth_ã°
 (
ks
);

877 
	`ASSERT
 (
s1
 < 4 && 
s2
 < 4);

878 
acf_mîge
[(
s1
<<2Ë+ 
s2
])

880 
ACF_SUCCEEDED
:

881 
ACF_DISABLED
:

882 
suc˚ss
 = 
åue
;

883 
ks
->
auth_de„ºed
 = 
Ál£
;

885 
ACF_UNDEFINED
:

886 i‡(
now
 < 
ks
->
auth_de„ºed_expúe
)

887 
de„ºed
 = 
åue
;

889 
ACF_FAILED
:

890 
ks
->
authítiˇãd
 = 
Ál£
;

893 
	`ASSERT
 (0);

896 
suc˚ss
 = 
åue
;

904 
	`dmsg
 (
D_TLS_ERRORS
, "TAS:á=%d s=%d d=%d", 
a˘ive
, 
suc˚ss
, 
de„ºed
);

907 i‡(
suc˚ss
)

908  
TLS_AUTHENTICATION_SUCCEEDED
;

909 i‡(!
a˘ive
 || 
de„ºed
)

910  
TLS_AUTHENTICATION_DEFERRED
;

912  
TLS_AUTHENTICATION_FAILED
;

913 
	}
}

915 #ifde‡
MANAGEMENT_DEF_AUTH


920 
boﬁ


921 
	$és_authítiˇã_key
 (
és_mu…i
 *
mu…i
, c⁄° 
mda_key_id
, c⁄° 
boﬁ
 
auth
, c⁄° *
˛õ¡_ªas⁄
)

923 
boﬁ
 
ªt
 = 
Ál£
;

924 i‡(
mu…i
)

926 
i
;

927 
	`m™_def_auth_£t_˛õ¡_ªas⁄
 (
mu…i
, 
˛õ¡_ªas⁄
);

928 
i
 = 0; i < 
KEY_SCAN_SIZE
; ++i)

930 
key_°©e
 *
ks
 = 
mu…i
->
key_sˇn
[
i
];

931 i‡(
ks
->
mda_key_id
 == mda_key_id)

933 
ks
->
mda_°©us
 = 
auth
 ? 
ACF_SUCCEEDED
 : 
ACF_FAILED
;

934 
ªt
 = 
åue
;

938  
ªt
;

939 
	}
}

956 
boﬁ


957 
	$vîify_u£r_∑ss_s¸ùt
 (
és_£ssi⁄
 *
£ssi⁄
, c⁄° 
u£r_∑ss
 *
up
)

959 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

960 
¨gv
árgv = 
	`¨gv_√w
 ();

961 c⁄° *
tmp_fûe
 = "";

962 
boﬁ
 
ªt
 = 
Ál£
;

965 i‡((
£ssi⁄
->
›t
->
s¶_Êags
 & 
SSLF_AUTH_USER_PASS_OPTIONAL
Ë|| 
	`°æí
 (
up
->
u£∫ame
))

968 
	`£ãnv_°r
 (
£ssi⁄
->
›t
->
es
, "script_type", "user-pass-verify");

970 i‡(
£ssi⁄
->
›t
->
auth_u£r_∑ss_vîify_s¸ùt_vü_fûe
)

972 
°©us_ouçut
 *
so
;

974 
tmp_fûe
 = 
	`¸óã_ãmp_fûe
 (
£ssi⁄
->
›t
->
tmp_dú
, "up", &
gc
);

975 if–
tmp_fûe
 ) {

976 
so
 = 
	`°©us_›í
 (
tmp_fûe
, 0, -1, 
NULL
, 
STATUS_OUTPUT_WRITE
);

977 
	`°©us_¥ötf
 (
so
, "%s", 
up
->
u£∫ame
);

978 
	`°©us_¥ötf
 (
so
, "%s", 
up
->
∑ssw‹d
);

979 i‡(!
	`°©us_˛o£
 (
so
))

981 
	`msg
 (
D_TLS_ERRORS
, "TLS Auth Error: couldÇot write username/passwordÅo file: %s",

982 
tmp_fûe
);

983 
d⁄e
;

986 
	`msg
 (
D_TLS_ERRORS
, "TLS Auth Error: couldÇot create write "

992 
	`£ãnv_°r
 (
£ssi⁄
->
›t
->
es
, "u£∫ame", 
up
->
u£∫ame
);

993 
	`£ãnv_°r
 (
£ssi⁄
->
›t
->
es
, "∑ssw‹d", 
up
->
∑ssw‹d
);

997 
	`£ãnv_°r
 (
£ssi⁄
->
›t
->
es
, "comm⁄_«me", sessi⁄->
comm⁄_«me
);

1000 
	`£ãnv_u¡ru°ed
 (
£ssi⁄
);

1003 
	`¨gv_¥ötf
 (&
¨gv
, "%s¯%s", 
£ssi⁄
->
›t
->
auth_u£r_∑ss_vîify_s¸ùt
, 
tmp_fûe
);

1006 
ªt
 = 
	`›ív≤_run_s¸ùt
 (&
¨gv
, 
£ssi⁄
->
›t
->
es
, 0,

1009 i‡(!
£ssi⁄
->
›t
->
auth_u£r_∑ss_vîify_s¸ùt_vü_fûe
)

1010 
	`£ãnv_dñ
 (
£ssi⁄
->
›t
->
es
, "password");

1014 
	`msg
 (
D_TLS_ERRORS
, "TLS Auth Error:ÖeerÖrovidedá blank username");

1017 
d⁄e
:

1018 i‡(
tmp_fûe
 && 
	`°æí
 (tmp_file) > 0)

1019 
	`∂©f‹m_u∆ök
 (
tmp_fûe
);

1021 
	`¨gv_ª£t
 (&
¨gv
);

1022 
	`gc_‰ì
 (&
gc
);

1023  
ªt
;

1024 
	}
}

1030 
	$vîify_u£r_∑ss_∂ugö
 (
és_£ssi⁄
 *
£ssi⁄
, c⁄° 
u£r_∑ss
 *
up
, c⁄° *
øw_u£∫ame
)

1032 
ªtvÆ
 = 
OPENVPN_PLUGIN_FUNC_ERROR
;

1033 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

1036 i‡((
£ssi⁄
->
›t
->
s¶_Êags
 & 
SSLF_AUTH_USER_PASS_OPTIONAL
Ë|| 
	`°æí
 (
up
->
u£∫ame
))

1039 
	`£ãnv_°r
 (
£ssi⁄
->
›t
->
es
, "u£∫ame", (
øw_u£∫ame
 ?Ñaw_u£∫amê: 
up
->
u£∫ame
));

1040 
	`£ãnv_°r
 (
£ssi⁄
->
›t
->
es
, "∑ssw‹d", 
up
->
∑ssw‹d
);

1043 
	`£ãnv_°r
 (
£ssi⁄
->
›t
->
es
, "comm⁄_«me", sessi⁄->
comm⁄_«me
);

1046 
	`£ãnv_u¡ru°ed
 (
£ssi⁄
);

1048 #ifde‡
PLUGIN_DEF_AUTH


1050 
	`key_°©e_gí_auth_c⁄åﬁ_fûe
 (
ks
, 
£ssi⁄
->
›t
);

1054 
ªtvÆ
 = 
	`∂ugö_ˇŒ
 (
£ssi⁄
->
›t
->
∂ugös
, 
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
, 
NULL
, NULL, sessi⁄->›t->
es
);

1056 #ifde‡
PLUGIN_DEF_AUTH


1058 i‡(
ªtvÆ
 !
OPENVPN_PLUGIN_FUNC_DEFERRED
)

1059 
	`key_°©e_rm_auth_c⁄åﬁ_fûe
 (
ks
);

1062 
	`£ãnv_dñ
 (
£ssi⁄
->
›t
->
es
, "password");

1063 i‡(
øw_u£∫ame
)

1064 
	`£ãnv_°r
 (
£ssi⁄
->
›t
->
es
, "u£∫ame", 
up
->
u£∫ame
);

1068 
	`msg
 (
D_TLS_ERRORS
, "TLS Auth Error (verify_user_pass_plugin):ÖeerÖrovidedá blank username");

1071  
ªtvÆ
;

1072 
	}
}

1075 #ifde‡
MANAGEMENT_DEF_AUTH


1079 
	#KMDA_ERROR
 0

	)

1080 
	#KMDA_SUCCESS
 1

	)

1081 
	#KMDA_UNDEF
 2

	)

1082 
	#KMDA_DEF
 3

	)

1085 
	$vîify_u£r_∑ss_m™agemít
 (
és_£ssi⁄
 *
£ssi⁄
, c⁄° 
u£r_∑ss
 *
up
, c⁄° *
øw_u£∫ame
)

1087 
ªtvÆ
 = 
KMDA_ERROR
;

1088 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

1091 i‡((
£ssi⁄
->
›t
->
s¶_Êags
 & 
SSLF_AUTH_USER_PASS_OPTIONAL
Ë|| 
	`°æí
 (
up
->
u£∫ame
))

1094 
	`£ãnv_°r
 (
£ssi⁄
->
›t
->
es
, "u£∫ame", (
øw_u£∫ame
 ?Ñaw_u£∫amê: 
up
->
u£∫ame
));

1095 
	`£ãnv_°r
 (
£ssi⁄
->
›t
->
es
, "∑ssw‹d", 
up
->
∑ssw‹d
);

1098 
	`£ãnv_°r
 (
£ssi⁄
->
›t
->
es
, "comm⁄_«me", sessi⁄->
comm⁄_«me
);

1101 
	`£ãnv_u¡ru°ed
 (
£ssi⁄
);

1103 i‡(
m™agemít
)

1104 
	`m™agemít_nŸify_˛õ¡_√edög_auth
 (
m™agemít
, 
ks
->
mda_key_id
, 
£ssi⁄
->
›t
->
mda_c⁄ãxt
, sessi⁄->›t->
es
);

1106 
	`£ãnv_dñ
 (
£ssi⁄
->
›t
->
es
, "password");

1107 i‡(
øw_u£∫ame
)

1108 
	`£ãnv_°r
 (
£ssi⁄
->
›t
->
es
, "u£∫ame", 
up
->
u£∫ame
);

1110 
ªtvÆ
 = 
KMDA_SUCCESS
;

1114 
	`msg
 (
D_TLS_ERRORS
, "TLS Auth Error (verify_user_pass_management):ÖeerÖrovidedá blank username");

1117  
ªtvÆ
;

1118 
	}
}

1125 
	$vîify_u£r_∑ss
(
u£r_∑ss
 *
up
, 
és_mu…i
 *
mu…i
,

1126 
és_£ssi⁄
 *
£ssi⁄
)

1128 
s1
 = 
OPENVPN_PLUGIN_FUNC_SUCCESS
;

1129 
boﬁ
 
s2
 = 
åue
;

1130 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

1132 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1133 *
øw_u£∫ame
 = 
NULL
;

1135 #ifde‡
MANAGEMENT_DEF_AUTH


1136 
m™_def_auth
 = 
KMDA_UNDEF
;

1138 i‡(
	`m™agemít_íabÀ_def_auth
 (
m™agemít
))

1139 
m™_def_auth
 = 
KMDA_DEF
;

1146 i‡(
	`com∑t_Êag
 (
COMPAT_FLAG_QUERY
 | 
COMPAT_NAMES
))

1148 
	`ALLOC_ARRAY_CLEAR_GC
 (
øw_u£∫ame
, , 
USER_PASS_LEN
, &
gc
);

1149 
	`°r˝y
 (
øw_u£∫ame
, 
up
->
u£∫ame
);

1150 
	`°rög_mod
 (
øw_u£∫ame
, 
CC_PRINT
, 
CC_CRLF
, '_');

1154 
	`°rög_mod_ªm≠_«me
 (
up
->
u£∫ame
, 
COMMON_NAME_CHAR_CLASS
);

1155 
	`°rög_mod
 (
up
->
∑ssw‹d
, 
CC_PRINT
, 
CC_CRLF
, '_');

1158 #ifde‡
MANAGEMENT_DEF_AUTH


1159 i‡(
m™_def_auth
 =
KMDA_DEF
)

1160 
m™_def_auth
 = 
	`vîify_u£r_∑ss_m™agemít
 (
£ssi⁄
, 
up
, 
øw_u£∫ame
);

1162 i‡(
	`∂ugö_deföed
 (
£ssi⁄
->
›t
->
∂ugös
, 
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
))

1163 
s1
 = 
	`vîify_u£r_∑ss_∂ugö
 (
£ssi⁄
, 
up
, 
øw_u£∫ame
);

1164 i‡(
£ssi⁄
->
›t
->
auth_u£r_∑ss_vîify_s¸ùt
)

1165 
s2
 = 
	`vîify_u£r_∑ss_s¸ùt
 (
£ssi⁄
, 
up
);

1168 i‡((
£ssi⁄
->
›t
->
s¶_Êags
 & 
SSLF_USERNAME_AS_COMMON_NAME
Ë&& 
	`°æí
 (
up
->
u£∫ame
Ë>
TLS_USERNAME_LEN
)

1170 
	`msg
 (
D_TLS_ERRORS
, "TLS Auth Eº‹: --u£∫ame-as-comm⁄Çamê•ecifõdánd u£∫amêi†l⁄gîÅh™ÅhêmaximumÖîmôãd Comm⁄ NamêÀngth o‡%d ch¨a˘îs", 
TLS_USERNAME_LEN
);

1171 
s1
 = 
OPENVPN_PLUGIN_FUNC_ERROR
;

1175 i‡((
s1
 =
OPENVPN_PLUGIN_FUNC_SUCCESS


1176 #ifde‡
PLUGIN_DEF_AUTH


1177 || 
s1
 =
OPENVPN_PLUGIN_FUNC_DEFERRED


1179 Ë&& 
s2


1180 #ifde‡
MANAGEMENT_DEF_AUTH


1181 && 
m™_def_auth
 !
KMDA_ERROR


1183 && 
	`és_lock_u£∫ame
 (
mu…i
, 
up
->
u£∫ame
))

1185 
ks
->
authítiˇãd
 = 
åue
;

1186 #ifde‡
PLUGIN_DEF_AUTH


1187 i‡(
s1
 =
OPENVPN_PLUGIN_FUNC_DEFERRED
)

1188 
ks
->
auth_de„ºed
 = 
åue
;

1190 #ifde‡
MANAGEMENT_DEF_AUTH


1191 i‡(
m™_def_auth
 !
KMDA_UNDEF
)

1192 
ks
->
auth_de„ºed
 = 
åue
;

1194 i‡((
£ssi⁄
->
›t
->
s¶_Êags
 & 
SSLF_USERNAME_AS_COMMON_NAME
))

1195 
	`£t_comm⁄_«me
 (
£ssi⁄
, 
up
->
u£∫ame
);

1196 #ifde‡
ENABLE_DEF_AUTH


1197 
	`msg
 (
D_HANDSHAKE
, "TLS: Username/Passwordáuthentication %s for username '%s' %s",

1198 
ks
->
auth_de„ºed
 ? "deferred" : "succeeded",

1199 
up
->
u£∫ame
,

1200 (
£ssi⁄
->
›t
->
s¶_Êags
 & 
SSLF_USERNAME_AS_COMMON_NAME
) ? "[CN SET]" : "");

1202 
	`msg
 (
D_HANDSHAKE
, "TLS: Username/Passwordáuthentication %s for username '%s' %s",

1204 
up
->
u£∫ame
,

1205 (
£ssi⁄
->
›t
->
s¶_Êags
 & 
SSLF_USERNAME_AS_COMMON_NAME
) ? "[CN SET]" : "");

1210 
	`msg
 (
D_TLS_ERRORS
, "TLS Auth Error: Auth Username/Password verification failed forÖeer");

1213 
	`gc_‰ì
 (&
gc
);

1214 
	}
}

1217 
	$vîify_föÆ_auth_checks
(
és_mu…i
 *
mu…i
, 
és_£ssi⁄
 *
£ssi⁄
)

1219 
key_°©e
 *
ks
 = &
£ssi⁄
->
key
[
KS_PRIMARY
];

1222 i‡(!
£ssi⁄
->
comm⁄_«me
)

1223 
	`£t_comm⁄_«me
 (
£ssi⁄
, "");

1226 i‡(
ks
->
authítiˇãd
 && 
mu…i
->
locked_˙
)

1228 c⁄° *
˙
 = 
£ssi⁄
->
comm⁄_«me
;

1229 i‡(
˙
 && 
	`°rcmp
 (˙, 
mu…i
->
locked_˙
))

1231 
	`msg
 (
D_TLS_ERRORS
, "TLS Auth Error: TLS object CNáttemptedÅo change from '%s'Åo '%s' --Åunnel disabled",

1232 
mu…i
->
locked_˙
,

1233 
˙
);

1236 
	`£t_comm⁄_«me
 (
£ssi⁄
, 
mu…i
->
locked_˙
);

1237 
	`és_dóuthítiˇã
 (
mu…i
);

1242 i‡(
ks
->
authítiˇãd
 && 
mu…i
->
locked_˚π_hash_£t
)

1244 c⁄° 
˚π_hash_£t
 *
chs
 = 
£ssi⁄
->cert_hash_set;

1245 i‡(
chs
 && !
	`˚π_hash_com∑ª
 (chs, 
mu…i
->
locked_˚π_hash_£t
))

1247 
	`msg
 (
D_TLS_ERRORS
, "TLS Auth Error: TLS object CN=%s client-provided SSL certs unexpectedly changed during mid-sessionÑeauth",

1248 
£ssi⁄
->
comm⁄_«me
);

1251 
	`és_dóuthítiˇã
 (
mu…i
);

1256 i‡(
ks
->
authítiˇãd
 && 
£ssi⁄
->
›t
->
˛õ¡_c⁄fig_dú_ex˛usive
)

1258 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1260 c⁄° *
˙
 = 
£ssi⁄
->
comm⁄_«me
;

1261 c⁄° *
∑th
 = 
	`gí_∑th
 (
£ssi⁄
->
›t
->
˛õ¡_c⁄fig_dú_ex˛usive
, 
˙
, &
gc
);

1262 i‡(!
˙
 || !
	`°rcmp
 (˙, 
CCD_DEFAULT
Ë|| !
	`ã°_fûe
 (
∑th
))

1264 
ks
->
authítiˇãd
 = 
Ál£
;

1265 
	`msg
 (
D_TLS_ERRORS
, "TLS Auth Error: --client-config-diráuthentication failed for commonÇame '%s' file='%s'",

1266 
£ssi⁄
->
comm⁄_«me
,

1267 
∑th
 ?Öath : "UNDEF");

1270 
	`gc_‰ì
 (&
gc
);

1272 
	}
}

	@src/openvpn/ssl_verify.h

30 #i‚de‡
SSL_VERIFY_H_


31 
	#SSL_VERIFY_H_


	)

33 
	~"syshód.h
"

34 
	~"misc.h
"

35 
	~"m™age.h
"

36 
	~"s¶_comm⁄.h
"

39 #ifde‡
ENABLE_CRYPTO_OPENSSL


40 
	~"s¶_vîify_›ís¶.h
"

42 #ifde‡
ENABLE_CRYPTO_POLARSSL


43 
	~"s¶_vîify_pﬁ¨s¶.h
"

46 
	~"s¶_vîify_backíd.h
"

53 
	#MAX_CERT_DEPTH
 16

	)

56 
	s˚π_hash
 {

57 
	msha1_hash
[
SHA_DIGEST_LENGTH
];

61 
	s˚π_hash_£t
 {

62 
˚π_hash
 *
	mch
[
MAX_CERT_DEPTH
];

65 
	#VERIFY_X509_NONE
 0

	)

66 
	#VERIFY_X509_SUBJECT_DN
 1

	)

67 
	#VERIFY_X509_SUBJECT_RDN
 2

	)

68 
	#VERIFY_X509_SUBJECT_RDN_PREFIX
 3

	)

69 
	#TLS_REMOTE_SUBJECT_DN
 1 + 0x100

	)

70 
	#TLS_REMOTE_SUBJECT_RDN_PREFIX
 3 + 0x100

	)

72 
	#TLS_AUTHENTICATION_SUCCEEDED
 0

	)

73 
	#TLS_AUTHENTICATION_FAILED
 1

	)

74 
	#TLS_AUTHENTICATION_DEFERRED
 2

	)

75 
	#TLS_AUTHENTICATION_UNDEFINED
 3

	)

83 
és_authítiˇti⁄_°©us
 (
és_mu…i
 *
mu…i
, c⁄° 
œãncy
);

93 
	#DECRYPT_KEY_ENABLED
(
mu…i
, 
ks
Ë((ks)->
°©e
 >(
S_GOT_KEY
 - (mu…i)->
›t
.
£rvî
))

	)

100 
key_°©e_rm_auth_c⁄åﬁ_fûe
 (
key_°©e
 *
ks
);

107 
˚π_hash_‰ì
 (
˚π_hash_£t
 *
chs
);

114 
és_lock_˚π_hash_£t
 (
és_mu…i
 *
mu…i
);

121 
és_lock_comm⁄_«me
 (
és_mu…i
 *
mu…i
);

129 c⁄° *
és_comm⁄_«me
 (c⁄° 
és_mu…i
* 
mu…i
, c⁄° 
boﬁ
 
nuŒ
);

137 c⁄° *
és_u£∫ame
 (c⁄° 
és_mu…i
 *
mu…i
, c⁄° 
boﬁ
 
nuŒ
);

139 #ifde‡
ENABLE_PF


150 
ölöe
 
boﬁ


151 
	$és_comm⁄_«me_hash
 (c⁄° 
és_mu…i
 *
mu…i
, c⁄° **
˙
, 
uöt32_t
 *
˙_hash
)

153 i‡(
mu…i
)

155 c⁄° 
és_£ssi⁄
 *
s
 = &
mu…i
->
£ssi⁄
[
TM_ACTIVE
];

156 i‡(
s
->
comm⁄_«me
 && s->common_name[0] != '\0')

158 *
˙
 = 
s
->
comm⁄_«me
;

159 *
˙_hash
 = 
s
->
comm⁄_«me_hashvÆ
;

160  
åue
;

163  
Ál£
;

164 
	}
}

177 
ölöe
 
boﬁ
 
	$vîify_u£r_∑ss_íabÀd
(
és_£ssi⁄
 *
£ssi⁄
)

179  (
£ssi⁄
->
›t
->
auth_u£r_∑ss_vîify_s¸ùt


180 || 
	`∂ugö_deföed
 (
£ssi⁄
->
›t
->
∂ugös
, 
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
)

181 #ifde‡
MANAGEMENT_DEF_AUTH


182 || 
	`m™agemít_íabÀ_def_auth
 (
m™agemít
)

185 
	}
}

200 
vîify_u£r_∑ss
(
u£r_∑ss
 *
up
, 
és_mu…i
 *
mu…i
,

201 
és_£ssi⁄
 *
£ssi⁄
);

212 
vîify_föÆ_auth_checks
(
és_mu…i
 *
mu…i
, 
és_£ssi⁄
 *
£ssi⁄
);

214 #ifde‡
ENABLE_X509_TRACK


216 
	sx509_åack


218 c⁄° 
x509_åack
 *
	m√xt
;

219 c⁄° *
	m«me
;

220 
	#XT_FULL_CHAIN
 (1<<0)

	)

221 
	mÊags
;

222 
	mnid
;

225 
x509_åack_add
 (c⁄° 
x509_åack
 **
Œ_hód
, c⁄° *
«me
, 
msgÀvñ
, 
gc_¨ía
 *
gc
);

233 
	#NS_CERT_CHECK_NONE
 (0)

	)

235 
	#NS_CERT_CHECK_SERVER
 (1<<0)

	)

237 
	#NS_CERT_CHECK_CLIENT
 (1<<1)

	)

242 #ifde‡
MANAGEMENT_DEF_AUTH


243 
boﬁ
 
és_authítiˇã_key
 (
és_mu…i
 *
mu…i
, c⁄° 
mda_key_id
, c⁄° boﬁ 
auth
, c⁄° *
˛õ¡_ªas⁄
);

244 
m™_def_auth_£t_˛õ¡_ªas⁄
 (
és_mu…i
 *
mu…i
, c⁄° *
˛õ¡_ªas⁄
);

247 
ölöe
 const *

248 
	$és_˛õ¡_ªas⁄
 (
és_mu…i
 *
mu…i
)

250 #ifde‡
ENABLE_DEF_AUTH


251  
mu…i
->
˛õ¡_ªas⁄
;

253  
NULL
;

255 
	}
}

	@src/openvpn/ssl_verify_backend.h

30 #i‚de‡
SSL_VERIFY_BACKEND_H_


31 
	#SSL_VERIFY_BACKEND_H_


	)

36 íum { 
	mSUCCESS
=0, 
	mFAILURE
=1 } 
	tªsu…_t
;

58 
ªsu…_t
 
vîify_˚π
(
és_£ssi⁄
 *
£ssi⁄
, 
›ív≤_x509_˚π_t
 *
˚π
, 
˚π_dïth
);

71 
˚π_hash_ªmembî
 (
és_£ssi⁄
 *
£ssi⁄
, c⁄° 
˚π_dïth
,

72 c⁄° *
sha1_hash
);

88 *
x509_gë_subje˘
 (
›ív≤_x509_˚π_t
 *
˚π
, 
gc_¨ía
 *
gc
);

97 *
x509_gë_sha1_hash
 (
›ív≤_x509_˚π_t
 *
˚π
, 
gc_¨ía
 *
gc
);

112 
ªsu…_t
 
x509_gë_u£∫ame
 (*
comm⁄_«me
, 
˙_Àn
,

113 * 
x509_u£∫ame_fõld
, 
›ív≤_x509_˚π_t
 *
≥î_˚π
);

126 *
backíd_x509_gë_£rül
 (
›ív≤_x509_˚π_t
 *
˚π
, 
gc_¨ía
 *
gc
);

139 *
backíd_x509_gë_£rül_hex
 (
›ív≤_x509_˚π_t
 *
˚π
,

140 
gc_¨ía
 *
gc
);

151 
x509_£ãnv
 (
ív_£t
 *
es
, 
˚π_dïth
, 
›ív≤_x509_˚π_t
 *
˚π
);

153 #ifde‡
ENABLE_X509_TRACK


166 
x509_åack_add
 (c⁄° 
x509_åack
 **
Œ_hód
, c⁄° *
«me
,

167 
msgÀvñ
, 
gc_¨ía
 *
gc
);

189 
x509_£ãnv_åack
 (c⁄° 
x509_åack
 *
xt
, 
ív_£t
 *
es
,

190 c⁄° 
dïth
, 
›ív≤_x509_˚π_t
 *
x509
);

205 
ªsu…_t
 
x509_vîify_ns_˚π_ty≥
(c⁄° 
›ív≤_x509_˚π_t
 *
˚π
, c⁄° 
ußge
);

207 #i‡
OPENSSL_VERSION_NUMBER
 >0x00907000L || 
ENABLE_CRYPTO_POLARSSL


219 
ªsu…_t
 
x509_vîify_˚π_ku
 (
›ív≤_x509_˚π_t
 *
x509
, c⁄° * c⁄° 
ex≥˘ed_ku
,

220 
ex≥˘ed_Àn
);

235 
ªsu…_t
 
x509_vîify_˚π_eku
 (
›ív≤_x509_˚π_t
 *
x509
, c⁄° * c⁄° 
ex≥˘ed_oid
);

248 
ªsu…_t
 
x509_wrôe_≥m
(
FILE
 *
≥î˚π_fûe
, 
›ív≤_x509_˚π_t
 *
≥î˚π
);

261 
ªsu…_t
 
x509_vîify_¸l
(c⁄° *
¸l_fûe
, 
›ív≤_x509_˚π_t
 *
˚π
,

262 c⁄° *
subje˘
);

	@src/openvpn/ssl_verify_openssl.c

30 #ifde‡
HAVE_CONFIG_H


31 
	~"c⁄fig.h
"

32 #ñi‡
deföed
(
_MSC_VER
)

33 
	~"c⁄fig-msvc.h
"

36 
	~"syshód.h
"

38 #i‡
deföed
(
ENABLE_SSL
Ë&& deföed(
ENABLE_CRYPTO_OPENSSL
)

40 
	~"s¶_vîify.h
"

41 
	~"s¶_vîify_backíd.h
"

42 
	~"s¶_›ís¶.h
"

43 
	~<›ís¶/x509v3.h
>

44 
	~<›ís¶/îr.h
>

47 
	$vîify_ˇŒback
 (
¥evîify_ok
, 
X509_STORE_CTX
 * 
˘x
)

49 
ªt
 = 0;

50 
és_£ssi⁄
 *
£ssi⁄
;

51 
SSL
 *
s¶
;

52 
gc_¨ía
 
gc
 = 
	`gc_√w
();

55 
s¶
 = 
	`X509_STORE_CTX_gë_ex_d©a
 (
˘x
, 
	`SSL_gë_ex_d©a_X509_STORE_CTX_idx
());

56 
	`ASSERT
 (
s¶
);

57 
£ssi⁄
 = (
és_£ssi⁄
 *Ë
	`SSL_gë_ex_d©a
 (
s¶
, 
myd©a_ödex
);

58 
	`ASSERT
 (
£ssi⁄
);

60 
	`˚π_hash_ªmembî
 (
£ssi⁄
, 
˘x
->
îr‹_dïth
,

61 
	`x509_gë_sha1_hash
(
˘x
->
cuºít_˚π
, &
gc
));

64 i‡(!
¥evîify_ok
)

67 *
subje˘
 = 
	`x509_gë_subje˘
(
˘x
->
cuºít_˚π
, &
gc
);

69 i‡(
subje˘
)

72 
	`msg
 (
D_TLS_ERRORS
, "VERIFY ERROR: depth=%d,Érror=%s: %s",

73 
˘x
->
îr‹_dïth
,

74 
	`X509_vîify_˚π_îr‹_°rög
 (
˘x
->
îr‹
),

75 
subje˘
);

78 
	`ERR_˛ór_îr‹
();

80 
£ssi⁄
->
vîifõd
 = 
Ál£
;

81 
˛ónup
;

84 i‡(
SUCCESS
 !
	`vîify_˚π
(
£ssi⁄
, 
˘x
->
cuºít_˚π
, ctx->
îr‹_dïth
))

85 
˛ónup
;

87 
ªt
 = 1;

89 
˛ónup
:

90 
	`gc_‰ì
(&
gc
);

92  
ªt
;

93 
	}
}

95 #ifde‡
ENABLE_X509ALTUSERNAME


97 
boﬁ
 
	$exåa˘_x509_exãnsi⁄
(
X509
 *
˚π
, *
fõld«me
, *
out
, 
size
)

99 
boﬁ
 
ªtvÆ
 = 
Ál£
;

100 *
buf
 = 0;

101 
GENERAL_NAMES
 *
exãnsi⁄s
;

102 
nid
 = 
	`OBJ_txt2nid
(
fõld«me
);

104 
exãnsi⁄s
 = (
GENERAL_NAMES
 *)
	`X509_gë_ext_d2i
(
˚π
, 
nid
, 
NULL
, NULL);

105 i‡–
exãnsi⁄s
 )

107 
numÆts
;

108 
i
;

114 
numÆts
 = 
	`sk_GENERAL_NAME_num
(
exãnsi⁄s
);

117 
i
=0; i<
numÆts
; i++)

120 c⁄° 
GENERAL_NAME
 *
«me
 = 
	`sk_GENERAL_NAME_vÆue
 (
exãnsi⁄s
, 
i
 );

122 
«me
->
ty≥
)

124 
GEN_EMAIL
:

125 
	`ASN1_STRING_to_UTF8
((**)&
buf
, 
«me
->
d
.
ü5
);

126 i‡–
	`°æí
 (
buf
Ë!
«me
->
d
.
ü5
->
Àngth
 )

128 
	`msg
 (
D_TLS_ERRORS
, "ASN1 ERROR: string containedÅerminating zero");

129 
	`OPENSSL_‰ì
 (
buf
);

131 
	`°∫˝y¡
(
out
, 
buf
, 
size
);

132 
	`OPENSSL_‰ì
(
buf
);

133 
ªtvÆ
 = 
åue
;

137 
	`msg
 (
D_TLS_ERRORS
, "ASN1 ERROR: canÇot handle fieldÅype %i",

138 
«me
->
ty≥
);

142 
	`sk_GENERAL_NAME_‰ì
 (
exãnsi⁄s
);

144  
ªtvÆ
;

145 
	}
}

160 
ªsu…_t


161 
	$exåa˘_x509_fõld_s¶
 (
X509_NAME
 *
x509
, c⁄° *
fõld_«me
, *
out
,

162 
size
)

164 
œ°pos
 = -1;

165 
tmp
 = -1;

166 
X509_NAME_ENTRY
 *
x509√
 = 0;

167 
ASN1_STRING
 *
a¢1
 = 0;

168 *
buf
 = (*)1;

169 
nid
 = 
	`OBJ_txt2nid
((*)
fõld_«me
);

171 
	`ASSERT
 (
size
 > 0);

172 *
out
 = '\0';

174 
œ°pos
 = 
tmp
;

175 
tmp
 = 
	`X509_NAME_gë_ödex_by_NID
(
x509
, 
nid
, 
œ°pos
);

176 } 
tmp
 > -1);

179 i‡(
œ°pos
 == -1)

180  
FAILURE
;

182 
x509√
 = 
	`X509_NAME_gë_íåy
(
x509
, 
œ°pos
);

183 i‡(!
x509√
)

184  
FAILURE
;

186 
a¢1
 = 
	`X509_NAME_ENTRY_gë_d©a
(
x509√
);

187 i‡(!
a¢1
)

188  
FAILURE
;

189 
tmp
 = 
	`ASN1_STRING_to_UTF8
(&
buf
, 
a¢1
);

190 i‡(
tmp
 <= 0)

191  
FAILURE
;

193 
	`°∫˝y¡
(
out
, (*)
buf
, 
size
);

196 c⁄° 
ªsu…_t
 
ªt
 = (
	`°æí
 ((*)
buf
Ë< 
size
Ë? 
SUCCESS
: 
FAILURE
;

197 
	`OPENSSL_‰ì
 (
buf
);

198  
ªt
;

200 
	}
}

202 
ªsu…_t


203 
	$x509_gë_u£∫ame
 (*
comm⁄_«me
, 
˙_Àn
,

204 * 
x509_u£∫ame_fõld
, 
X509
 *
≥î_˚π
)

206 #ifde‡
ENABLE_X509ALTUSERNAME


207 i‡(
	`°∫cmp
("ext:",
x509_u£∫ame_fõld
,4) == 0)

209 i‡(!
	`exåa˘_x509_exãnsi⁄
 (
≥î_˚π
, 
x509_u£∫ame_fõld
+4, 
comm⁄_«me
, 
˙_Àn
))

210  
FAILURE
;

213 i‡(
FAILURE
 =
	`exåa˘_x509_fõld_s¶
 (
	`X509_gë_subje˘_«me
 (
≥î_˚π
),

214 
x509_u£∫ame_fõld
, 
comm⁄_«me
, 
˙_Àn
))

215  
FAILURE
;

217  
SUCCESS
;

218 
	}
}

221 
	$backíd_x509_gë_£rül
 (
›ív≤_x509_˚π_t
 *
˚π
, 
gc_¨ía
 *
gc
)

223 
ASN1_INTEGER
 *
a¢1_i
;

224 
BIGNUM
 *
bignum
;

225 *
›ís¶_£rül
, *
£rül
;

227 
a¢1_i
 = 
	`X509_gë_£rülNumbî
(
˚π
);

228 
bignum
 = 
	`ASN1_INTEGER_to_BN
(
a¢1_i
, 
NULL
);

229 
›ís¶_£rül
 = 
	`BN_bn2dec
(
bignum
);

231 
£rül
 = 
	`°rög_Æloc
(
›ís¶_£rül
, 
gc
);

233 
	`BN_‰ì
(
bignum
);

234 
	`OPENSSL_‰ì
(
›ís¶_£rül
);

236  
£rül
;

237 
	}
}

240 
	$backíd_x509_gë_£rül_hex
 (
›ív≤_x509_˚π_t
 *
˚π
, 
gc_¨ía
 *
gc
)

242 c⁄° 
ASN1_INTEGER
 *
a¢1_i
 = 
	`X509_gë_£rülNumbî
(
˚π
);

244  
	`f‹m©_hex_ex
(
a¢1_i
->
d©a
,á¢1_i->
Àngth
, 0, 1, ":", 
gc
);

245 
	}
}

248 
	$x509_gë_sha1_hash
 (
X509
 *
˚π
, 
gc_¨ía
 *
gc
)

250 *
hash
 = 
	`gc_mÆloc
(
SHA_DIGEST_LENGTH
, 
Ál£
, 
gc
);

251 
	`mem˝y
(
hash
, 
˚π
->
sha1_hash
, 
SHA_DIGEST_LENGTH
);

252  
hash
;

253 
	}
}

256 
	$x509_gë_subje˘
 (
X509
 *
˚π
, 
gc_¨ía
 *
gc
)

258 
BIO
 *
subje˘_bio
 = 
NULL
;

259 
BUF_MEM
 *
subje˘_mem
;

260 *
subje˘
 = 
NULL
;

261 
maxÀn
 = 0;

267 i‡(
	`com∑t_Êag
 (
COMPAT_FLAG_QUERY
 | 
COMPAT_NAMES
))

269 
subje˘
 = 
	`gc_mÆloc
 (256, 
Ál£
, 
gc
);

270 
	`X509_NAME_⁄ñöe
 (
	`X509_gë_subje˘_«me
 (
˚π
), 
subje˘
, 256);

271 
subje˘
[255] = '\0';

272  
subje˘
;

275 
subje˘_bio
 = 
	`BIO_√w
 (
	`BIO_s_mem
 ());

276 i‡(
subje˘_bio
 =
NULL
)

277 
îr
;

279 
	`X509_NAME_¥öt_ex
 (
subje˘_bio
, 
	`X509_gë_subje˘_«me
 (
˚π
),

280 0, 
XN_FLAG_SEP_CPLUS_SPC
 | 
XN_FLAG_FN_SN
 |

281 
ASN1_STRFLGS_UTF8_CONVERT
 | 
ASN1_STRFLGS_ESC_CTRL
);

283 i‡(
	`BIO_eof
 (
subje˘_bio
))

284 
îr
;

286 
	`BIO_gë_mem_±r
 (
subje˘_bio
, &
subje˘_mem
);

288 
maxÀn
 = 
subje˘_mem
->
Àngth
 + 1;

289 
subje˘
 = 
	`gc_mÆloc
 (
maxÀn
, 
Ál£
, 
gc
);

291 
	`mem˝y
 (
subje˘
, 
subje˘_mem
->
d©a
, 
maxÀn
);

292 
subje˘
[
maxÀn
 - 1] = '\0';

294 
îr
:

295 i‡(
subje˘_bio
)

296 
	`BIO_‰ì
 (
subje˘_bio
);

298  
subje˘
;

299 
	}
}

302 #ifde‡
ENABLE_X509_TRACK


305 
	$x509_åack_add
 (c⁄° 
x509_åack
 **
Œ_hód
, c⁄° *
«me
, 
msgÀvñ
, 
gc_¨ía
 *
gc
)

307 
x509_åack
 *
xt
;

308 
	`ALLOC_OBJ_CLEAR_GC
 (
xt
, 
x509_åack
, 
gc
);

309 i‡(*
«me
 == '+')

311 
xt
->
Êags
 |
XT_FULL_CHAIN
;

312 ++
«me
;

314 
xt
->
«me
 =Çame;

315 
xt
->
nid
 = 
	`OBJ_txt2nid
(
«me
);

316 i‡(
xt
->
nid
 !
NID_undef
)

318 
xt
->
√xt
 = *
Œ_hód
;

319 *
Œ_hód
 = 
xt
;

322 
	`msg
(
msgÀvñ
, "x509_åack:Çÿsucháâribuã '%s'", 
«me
);

323 
	}
}

327 
	$do_£ãnv_x509
 (
ív_£t
 *
es
, c⁄° *
«me
, *
vÆue
, 
dïth
)

329 *
«me_ex∑nd
;

330 
size_t
 
«me_ex∑nd_size
;

332 
	`°rög_mod
 (
vÆue
, 
CC_ANY
, 
CC_CRLF
, '?');

333 
	`msg
 (
D_X509_ATTR
, "X509 ATTRIBUTEÇame='%s' vÆue='%s' dïth=%d", 
«me
, 
vÆue
, 
dïth
);

334 
«me_ex∑nd_size
 = 64 + 
	`°æí
 (
«me
);

335 
«me_ex∑nd
 = (*Ë
	`mÆloc
 (
«me_ex∑nd_size
);

336 
	`check_mÆloc_ªtu∫
 (
«me_ex∑nd
);

337 
	`›ív≤_¢¥ötf
 (
«me_ex∑nd
, 
«me_ex∑nd_size
, "X509_%d_%s", 
dïth
, 
«me
);

338 
	`£ãnv_°r
 (
es
, 
«me_ex∑nd
, 
vÆue
);

339 
	`‰ì
 (
«me_ex∑nd
);

340 
	}
}

343 
	$x509_£ãnv_åack
 (c⁄° 
x509_åack
 *
xt
, 
ív_£t
 *
es
, c⁄° 
dïth
, 
X509
 *
x509
)

345 
X509_NAME
 *
x509_«me
 = 
	`X509_gë_subje˘_«me
 (
x509
);

346 c⁄° 
nuŒc
 = '\0';

347 
i
;

349 
xt
)

351 i‡(
dïth
 =0 || (
xt
->
Êags
 & 
XT_FULL_CHAIN
))

353 
i
 = 
	`X509_NAME_gë_ödex_by_NID
(
x509_«me
, 
xt
->
nid
, -1);

354 i‡(
i
 >= 0)

356 
X509_NAME_ENTRY
 *
ít
 = 
	`X509_NAME_gë_íåy
(
x509_«me
, 
i
);

357 i‡(
ít
)

359 
ASN1_STRING
 *
vÆ
 = 
	`X509_NAME_ENTRY_gë_d©a
 (
ít
);

360 *
buf
;

361 
buf
 = (*)1;

362 i‡(
	`ASN1_STRING_to_UTF8
 (&
buf
, 
vÆ
) > 0)

364 
	`do_£ãnv_x509
(
es
, 
xt
->
«me
, (*)
buf
, 
dïth
);

365 
	`OPENSSL_‰ì
 (
buf
);

371 
i
 = 
	`X509_gë_ext_by_NID
(
x509
, 
xt
->
nid
, -1);

372 i‡(
i
 >= 0)

374 
X509_EXTENSION
 *
ext
 = 
	`X509_gë_ext
(
x509
, 
i
);

375 i‡(
ext
)

377 
BIO
 *
bio
 = 
	`BIO_√w
(
	`BIO_s_mem
());

378 i‡(
bio
)

380 i‡(
	`X509V3_EXT_¥öt
(
bio
, 
ext
, 0, 0))

382 i‡(
	`BIO_wrôe
(
bio
, &
nuŒc
, 1) == 1)

384 *
°r
;

385 
	`BIO_gë_mem_d©a
(
bio
, &
°r
);

386 
	`do_£ãnv_x509
(
es
, 
xt
->
«me
, 
°r
, 
dïth
);

389 
	`BIO_‰ì
(
bio
);

395 
xt
 = xt->
√xt
;

397 
	}
}

406 
	$x509_£ãnv
 (
ív_£t
 *
es
, 
˚π_dïth
, 
›ív≤_x509_˚π_t
 *
≥î_˚π
)

408 
i
, 
n
;

409 
‚_nid
;

410 
ASN1_OBJECT
 *
‚
;

411 
ASN1_STRING
 *
vÆ
;

412 
X509_NAME_ENTRY
 *
ít
;

413 c⁄° *
objbuf
;

414 *
buf
;

415 *
«me_ex∑nd
;

416 
size_t
 
«me_ex∑nd_size
;

417 
X509_NAME
 *
x509
 = 
	`X509_gë_subje˘_«me
 (
≥î_˚π
);

419 
n
 = 
	`X509_NAME_íåy_cou¡
 (
x509
);

420 
i
 = 0; i < 
n
; ++i)

422 
ít
 = 
	`X509_NAME_gë_íåy
 (
x509
, 
i
);

423 i‡(!
ít
)

425 
‚
 = 
	`X509_NAME_ENTRY_gë_obje˘
 (
ít
);

426 i‡(!
‚
)

428 
vÆ
 = 
	`X509_NAME_ENTRY_gë_d©a
 (
ít
);

429 i‡(!
vÆ
)

431 
‚_nid
 = 
	`OBJ_obj2nid
 (
‚
);

432 i‡(
‚_nid
 =
NID_undef
)

434 
objbuf
 = 
	`OBJ_nid2¢
 (
‚_nid
);

435 i‡(!
objbuf
)

437 
buf
 = (*)1;

438 i‡(
	`ASN1_STRING_to_UTF8
 (&
buf
, 
vÆ
) <= 0)

440 
«me_ex∑nd_size
 = 64 + 
	`°æí
 (
objbuf
);

441 
«me_ex∑nd
 = (*Ë
	`mÆloc
 (
«me_ex∑nd_size
);

442 
	`check_mÆloc_ªtu∫
 (
«me_ex∑nd
);

443 
	`›ív≤_¢¥ötf
 (
«me_ex∑nd
, 
«me_ex∑nd_size
, "X509_%d_%s", 
˚π_dïth
,

444 
objbuf
);

445 
	`°rög_mod
 (
«me_ex∑nd
, 
CC_PRINT
, 
CC_CRLF
, '_');

446 
	`°rög_mod
 ((*)
buf
, 
CC_PRINT
, 
CC_CRLF
, '_');

447 
	`£ãnv_°r
 (
es
, 
«me_ex∑nd
, (*)
buf
);

448 
	`‰ì
 (
«me_ex∑nd
);

449 
	`OPENSSL_‰ì
 (
buf
);

451 
	}
}

453 
ªsu…_t


454 
	$x509_vîify_ns_˚π_ty≥
(c⁄° 
›ív≤_x509_˚π_t
 *
≥î_˚π
, c⁄° 
ußge
)

456 i‡(
ußge
 =
NS_CERT_CHECK_NONE
)

457  
SUCCESS
;

458 i‡(
ußge
 =
NS_CERT_CHECK_CLIENT
)

459  ((
≥î_˚π
->
ex_Êags
 & 
EXFLAG_NSCERT
)

460 && (
≥î_˚π
->
ex_ns˚π
 & 
NS_SSL_CLIENT
)Ë? 
SUCCESS
: 
FAILURE
;

461 i‡(
ußge
 =
NS_CERT_CHECK_SERVER
)

462  ((
≥î_˚π
->
ex_Êags
 & 
EXFLAG_NSCERT
)

463 && (
≥î_˚π
->
ex_ns˚π
 & 
NS_SSL_SERVER
)Ë? 
SUCCESS
: 
FAILURE
;

465  
FAILURE
;

466 
	}
}

468 #i‡
OPENSSL_VERSION_NUMBER
 >= 0x00907000L

470 
ªsu…_t


471 
	$x509_vîify_˚π_ku
 (
X509
 *
x509
, c⁄° * c⁄° 
ex≥˘ed_ku
,

472 
ex≥˘ed_Àn
)

474 
ASN1_BIT_STRING
 *
ku
 = 
NULL
;

475 
ªsu…_t
 
fFound
 = 
FAILURE
;

477 i‡((
ku
 = (
ASN1_BIT_STRING
 *Ë
	`X509_gë_ext_d2i
 (
x509
, 
NID_key_ußge
, 
NULL
,

478 
NULL
)) == NULL)

480 
	`msg
 (
D_HANDSHAKE
, "Certificate doesÇot have key usageÉxtension");

484 
nku
 = 0;

485 
i
;

486 
i
 = 0; i < 8; i++)

488 i‡(
	`ASN1_BIT_STRING_gë_bô
 (
ku
, 
i
))

489 
nku
 |1 << (7 - 
i
);

495 i‡((
nku
 & 0xff) == 0)

497 
nku
 >>= 8;

500 
	`msg
 (
D_HANDSHAKE
, "Validating certificate key usage");

501 
i
 = 0; 
fFound
 !
SUCCESS
 && i < 
ex≥˘ed_Àn
; i++)

503 i‡(
ex≥˘ed_ku
[
i
] != 0)

505 
	`msg
 (
D_HANDSHAKE
, "++ Certificate has key usage %04x,Éxpects "

506 "%04x", 
nku
, 
ex≥˘ed_ku
[
i
]);

508 i‡(
nku
 =
ex≥˘ed_ku
[
i
])

509 
fFound
 = 
SUCCESS
;

514 i‡(
ku
 !
NULL
)

515 
	`ASN1_BIT_STRING_‰ì
 (
ku
);

517  
fFound
;

518 
	}
}

520 
ªsu…_t


521 
	$x509_vîify_˚π_eku
 (
X509
 *
x509
, c⁄° * c⁄° 
ex≥˘ed_oid
)

523 
EXTENDED_KEY_USAGE
 *
eku
 = 
NULL
;

524 
ªsu…_t
 
fFound
 = 
FAILURE
;

526 i‡((
eku
 = (
EXTENDED_KEY_USAGE
 *Ë
	`X509_gë_ext_d2i
 (
x509
, 
NID_ext_key_ußge
,

527 
NULL
, NULL)) == NULL)

529 
	`msg
 (
D_HANDSHAKE
, "Certificate doesÇot haveÉxtended key usageÉxtension");

533 
i
;

535 
	`msg
 (
D_HANDSHAKE
, "Validating certificateÉxtended key usage");

536 
i
 = 0; 
SUCCESS
 !
fFound
 && i < 
	`sk_ASN1_OBJECT_num
 (
eku
); i++)

538 
ASN1_OBJECT
 *
oid
 = 
	`sk_ASN1_OBJECT_vÆue
 (
eku
, 
i
);

539 
szOid
[1024];

541 i‡(
SUCCESS
 !
fFound
 && 
	`OBJ_obj2txt
 (
szOid
, (szOid), 
oid
, 0) != -1)

543 
	`msg
 (
D_HANDSHAKE
, "++ Certificate has EKU (str) %s,Éxpects %s",

544 
szOid
, 
ex≥˘ed_oid
);

545 i‡(!
	`°rcmp
 (
ex≥˘ed_oid
, 
szOid
))

546 
fFound
 = 
SUCCESS
;

548 i‡(
SUCCESS
 !
fFound
 && 
	`OBJ_obj2txt
 (
szOid
, (szOid), 
oid
, 1) != -1)

550 
	`msg
 (
D_HANDSHAKE
, "++ Certificate has EKU (oid) %s,Éxpects %s",

551 
szOid
, 
ex≥˘ed_oid
);

552 i‡(!
	`°rcmp
 (
ex≥˘ed_oid
, 
szOid
))

553 
fFound
 = 
SUCCESS
;

558 i‡(
eku
 !
NULL
)

559 
	`sk_ASN1_OBJECT_p›_‰ì
 (
eku
, 
ASN1_OBJECT_‰ì
);

561  
fFound
;

562 
	}
}

564 
ªsu…_t


565 
	$x509_wrôe_≥m
(
FILE
 *
≥î˚π_fûe
, 
X509
 *
≥î˚π
)

567 i‡(
	`PEM_wrôe_X509
(
≥î˚π_fûe
, 
≥î˚π
) < 0)

569 
	`msg
 (
M_ERR
, "FailedÅo writeÖeer certificate in PEM format");

570  
FAILURE
;

572  
SUCCESS
;

573 
	}
}

580 
ªsu…_t


581 
	$x509_vîify_¸l
(c⁄° *
¸l_fûe
, 
X509
 *
≥î_˚π
, c⁄° *
subje˘
)

583 
X509_CRL
 *
¸l
=
NULL
;

584 
X509_REVOKED
 *
ªvoked
;

585 
BIO
 *
ö
=
NULL
;

586 
n
,
i
;

587 
ªsu…_t
 
ªtvÆ
 = 
FAILURE
;

589 
ö
 = 
	`BIO_√w_fûe
 (
¸l_fûe
, "r");

591 i‡(
ö
 =
NULL
) {

592 
	`msg
 (
M_WARN
, "CRL: c™nŸÑód: %s", 
¸l_fûe
);

593 
íd
;

595 
¸l
=
	`PEM_ªad_bio_X509_CRL
(
ö
,
NULL
,NULL,NULL);

596 i‡(
¸l
 =
NULL
) {

597 
	`msg
 (
M_WARN
, "CRL: c™nŸÑód CRL from fûê%s", 
¸l_fûe
);

598 
íd
;

601 i‡(
	`X509_NAME_cmp
(
	`X509_CRL_gë_issuî
(
¸l
), 
	`X509_gë_issuî_«me
(
≥î_˚π
)) != 0) {

602 
	`msg
 (
M_WARN
, "CRL: CRL %s is fromá different issuerÅhanÅhe issuer of "

603 "˚πifiˇã %s", 
¸l_fûe
, 
subje˘
);

604 
ªtvÆ
 = 
SUCCESS
;

605 
íd
;

608 
n
 = 
	`sk_X509_REVOKED_num
(
	`X509_CRL_gë_REVOKED
(
¸l
));

609 
i
 = 0; i < 
n
; i++) {

610 
ªvoked
 = (
X509_REVOKED
 *)
	`sk_X509_REVOKED_vÆue
(
	`X509_CRL_gë_REVOKED
(
¸l
), 
i
);

611 i‡(
	`ASN1_INTEGER_cmp
(
ªvoked
->
£rülNumbî
, 
	`X509_gë_£rülNumbî
(
≥î_˚π
)) == 0) {

612 
	`msg
 (
D_HANDSHAKE
, "CRL CHECK FAILED: %†i†REVOKED",
subje˘
);

613 
íd
;

617 
ªtvÆ
 = 
SUCCESS
;

618 
	`msg
 (
D_HANDSHAKE
, "CRL CHECK OK: %s",
subje˘
);

620 
íd
:

621 
	`BIO_‰ì
(
ö
);

622 i‡(
¸l
)

623 
	`X509_CRL_‰ì
 (
¸l
);

625  
ªtvÆ
;

626 
	}
}

	@src/openvpn/ssl_verify_openssl.h

31 #i‚de‡
SSL_VERIFY_OPENSSL_H_


32 
	#SSL_VERIFY_OPENSSL_H_


	)

34 
	~<›ís¶/x509.h
>

36 #i‚de‡
__OPENVPN_X509_CERT_T_DECLARED


37 
	#__OPENVPN_X509_CERT_T_DECLARED


	)

38 
X509
 
	t›ív≤_x509_˚π_t
;

72 
vîify_ˇŒback
 (
¥evîify_ok
, 
X509_STORE_CTX
 * 
˘x
);

	@src/openvpn/ssl_verify_polarssl.c

30 #ifde‡
HAVE_CONFIG_H


31 
	~"c⁄fig.h
"

32 #ñi‡
deföed
(
_MSC_VER
)

33 
	~"c⁄fig-msvc.h
"

36 
	~"syshód.h
"

38 #i‡
deföed
(
ENABLE_SSL
Ë&& deföed(
ENABLE_CRYPTO_POLARSSL
)

40 
	~"s¶_vîify.h
"

41 
	~<pﬁ¨s¶/îr‹.h
>

42 
	~<pﬁ¨s¶/bignum.h
>

43 
	~<pﬁ¨s¶/sha1.h
>

45 
	#MAX_SUBJECT_LENGTH
 256

	)

48 
	$vîify_ˇŒback
 (*
£ssi⁄_obj
, 
x509_˚π
 *
˚π
, 
˚π_dïth
,

49 *
Êags
)

51 
és_£ssi⁄
 *
£ssi⁄
 = (és_£ssi⁄ *Ë
£ssi⁄_obj
;

52 
gc_¨ía
 
gc
 = 
	`gc_√w
();

54 
	`ASSERT
 (
˚π
);

55 
	`ASSERT
 (
£ssi⁄
);

57 
£ssi⁄
->
vîifõd
 = 
Ál£
;

60 
	`˚π_hash_ªmembî
 (
£ssi⁄
, 
˚π_dïth
, 
	`x509_gë_sha1_hash
(
˚π
, &
gc
));

63 i‡(*
Êags
 != 0)

65 *
subje˘
 = 
	`x509_gë_subje˘
(
˚π
, &
gc
);

67 i‡(
subje˘
)

68 
	`msg
 (
D_TLS_ERRORS
, "VERIFY ERROR: dïth=%d, fœgs=%x, %s", 
˚π_dïth
, *
Êags
, 
subje˘
);

70 
	`msg
 (
D_TLS_ERRORS
, "VERIFY ERROR: depth=%d, flags=%x, couldÇotÉxtract X509 "

71 "subje˘ såög from cîtifiˇã", *
Êags
, 
˚π_dïth
);

75 i‡(
SUCCESS
 !
	`vîify_˚π
(
£ssi⁄
, 
˚π
, 
˚π_dïth
))

77 *
Êags
 |
BADCERT_OTHER
;

80 
	`gc_‰ì
(&
gc
);

86 
	}
}

88 #ifde‡
ENABLE_X509ALTUSERNAME


92 
ªsu…_t


93 
	$x509_gë_u£∫ame
 (*
˙
, 
˙_Àn
,

94 *
x509_u£∫ame_fõld
, 
x509_˚π
 *
˚π
)

96 
x509_«me
 *
«me
;

98 
	`ASSERT
–
˙
 !
NULL
 );

100 
«me
 = &
˚π
->
subje˘
;

103  
«me
 !
NULL
 )

105 if–
	`memcmp
–
«me
->
oid
.
p
, 
OID_CN
, 
	`OID_SIZE
(OID_CN) ) == 0)

108 
«me
 =Çame->
√xt
;

112 if–
«me
 =
NULL
 )

113  
FAILURE
;

116 i‡(
˙_Àn
 > 
«me
->
vÆ
.
Àn
)

117 
	`mem˝y
–
˙
, 
«me
->
vÆ
.
p
,Çame->vÆ.
Àn
 );

120 
	`mem˝y
–
˙
, 
«me
->
vÆ
.
p
, 
˙_Àn
);

121 
˙
[
˙_Àn
-1] = '\0';

124  
SUCCESS
;

125 
	}
}

128 
	$backíd_x509_gë_£rül
 (
›ív≤_x509_˚π_t
 *
˚π
, 
gc_¨ía
 *
gc
)

130 
ªt
 = 0;

131 
i
 = 0;

132 *
buf
 = 
NULL
;

133 
size_t
 
buÊí
 = 0;

134 
mpi
 
£rül_mpi
 = { 0 };

135 
ªtvÆ
 = 0;

138 
	`mpi_öô
(&
£rül_mpi
);

139 
ªtvÆ
 = 
	`mpi_ªad_bö¨y
(&
£rül_mpi
, 
˚π
->
£rül
.
p
, cît->£rül.
Àn
);

140 i‡(
ªtvÆ
 < 0)

142 
îrbuf
[128];

143 
	`îr‹_°ªº‹
(
ªtvÆ
, 
îrbuf
, (errbuf));

145 
	`msg
(
M_WARN
, "FaûedÅÿªåõvê£rü»‰om cîtifiˇã: %s.", 
îrbuf
);

146  
NULL
;

150 
	`mpi_wrôe_°rög
(&
£rül_mpi
, 10, 
buf
, &
buÊí
);

151 
buf
 = 
	`gc_mÆloc
(
buÊí
, 
åue
, 
gc
);

154 
ªtvÆ
 = 
	`mpi_wrôe_°rög
(&
£rül_mpi
, 10, 
buf
, &
buÊí
);

155 i‡(
ªtvÆ
 < 0)

157 
îrbuf
[128];

158 
	`îr‹_°ªº‹
(
ªtvÆ
, 
îrbuf
, (errbuf));

160 
	`msg
(
M_WARN
, "FaûedÅÿwrôê£rü»tÿ°rög: %s.", 
îrbuf
);

161  
NULL
;

164  
buf
;

165 
	}
}

168 
	$backíd_x509_gë_£rül_hex
 (
›ív≤_x509_˚π_t
 *
˚π
, 
gc_¨ía
 *
gc
)

170 *
buf
 = 
NULL
;

171 
size_t
 
Àn
 = 
˚π
->
£rül
.len * 3 + 1;

173 
buf
 = 
	`gc_mÆloc
(
Àn
, 
åue
, 
gc
);

175 if(
	`x509∑r£_£rül_gës
(
buf
, 
Àn
-1, &
˚π
->
£rül
) < 0)

176 
buf
 = 
NULL
;

178  
buf
;

179 
	}
}

182 
	$x509_gë_sha1_hash
 (
x509_˚π
 *
˚π
, 
gc_¨ía
 *
gc
)

184 *
sha1_hash
 = 
	`gc_mÆloc
(
SHA_DIGEST_LENGTH
, 
Ál£
, 
gc
);

185 
	`sha1
(
˚π
->
tbs
.
p
, cît->tbs.
Àn
, 
sha1_hash
);

186  
sha1_hash
;

187 
	}
}

190 
	$x509_gë_subje˘
(
x509_˚π
 *
˚π
, 
gc_¨ía
 *
gc
)

192 
tmp_subje˘
[
MAX_SUBJECT_LENGTH
] = {0};

193 *
subje˘
 = 
NULL
;

195 
ªt
 = 0;

197 
ªt
 = 
	`x509∑r£_dn_gës
–
tmp_subje˘
, 
MAX_SUBJECT_LENGTH
-1, &
˚π
->
subje˘
 );

198 i‡(
ªt
 > 0)

201 
subje˘
 = 
	`°rög_Æloc
(
tmp_subje˘
, 
gc
);

204  
subje˘
;

205 
	}
}

213 
	$x509_£ãnv
 (
ív_£t
 *
es
, 
˚π_dïth
, 
›ív≤_x509_˚π_t
 *
˚π
)

215 
i
;

216 
c
;

217 c⁄° 
x509_«me
 *
«me
;

218 
s
[128];

220 
«me
 = &
˚π
->
subje˘
;

222 
	`mem£t
–
s
, 0, ( s ) );

224  
«me
 !
NULL
 )

226 
«me_ex∑nd
[64+8];

228 if–
«me
->
oid
.
Àn
 =2 && 
	`memcmp
–«me->oid.
p
, 
OID_X520
, 2 ) == 0 )

230  
«me
->
oid
.
p
[2] )

232 
X520_COMMON_NAME
:

233 
	`›ív≤_¢¥ötf
 (
«me_ex∑nd
, (name_expand), "X509_%d_CN",

234 
˚π_dïth
); ;

236 
X520_COUNTRY
:

237 
	`›ív≤_¢¥ötf
 (
«me_ex∑nd
, (name_expand), "X509_%d_C",

238 
˚π_dïth
); ;

240 
X520_LOCALITY
:

241 
	`›ív≤_¢¥ötf
 (
«me_ex∑nd
, (name_expand), "X509_%d_L",

242 
˚π_dïth
); ;

244 
X520_STATE
:

245 
	`›ív≤_¢¥ötf
 (
«me_ex∑nd
, (name_expand), "X509_%d_ST",

246 
˚π_dïth
); ;

248 
X520_ORGANIZATION
:

249 
	`›ív≤_¢¥ötf
 (
«me_ex∑nd
, (name_expand), "X509_%d_O",

250 
˚π_dïth
); ;

252 
X520_ORG_UNIT
:

253 
	`›ív≤_¢¥ötf
 (
«me_ex∑nd
, (name_expand), "X509_%d_OU",

254 
˚π_dïth
); ;

257 
	`›ív≤_¢¥ötf
 (
«me_ex∑nd
, (name_expand),

258 "X509_%d_0x%02X", 
˚π_dïth
, 
«me
->
oid
.
p
[2]);

262 if–
«me
->
oid
.
Àn
 =8 && 
	`memcmp
–«me->oid.
p
, 
OID_PKCS9
, 8 ) == 0 )

264  
«me
->
oid
.
p
[8] )

266 
PKCS9_EMAIL
:

267 
	`›ív≤_¢¥ötf
 (
«me_ex∑nd
, (name_expand),

268 "X509_%d_emaûAddªss", 
˚π_dïth
); ;

271 
	`›ív≤_¢¥ötf
 (
«me_ex∑nd
, (name_expand),

272 "X509_%d_0x%02X", 
˚π_dïth
, 
«me
->
oid
.
p
[8]);

278 
	`›ív≤_¢¥ötf
 (
«me_ex∑nd
, (name_expand), "X509_%d_\?\?",

279 
˚π_dïth
);

282  
i
 = 0; i < 
«me
->
vÆ
.
Àn
; i++ )

284 if–
i
 >(Ë–
s
 ) - 1 )

287 
c
 = 
«me
->
vÆ
.
p
[
i
];

288 if–
c
 < 32 || c == 127 || ( c > 128 && c < 160 ) )

289 
s
[
i
] = '?';

290 
s
[
i
] = 
c
;

292 
s
[
i
] = '\0';

295 
	`°rög_mod
 (
«me_ex∑nd
, 
CC_PRINT
, 
CC_CRLF
, '_');

296 
	`°rög_mod
 ((*)
s
, 
CC_PRINT
, 
CC_CRLF
, '_');

297 
	`£ãnv_°r
 (
es
, 
«me_ex∑nd
, (*)
s
);

299 
«me
 =Çame->
√xt
;

301 
	}
}

303 
ªsu…_t


304 
	$x509_vîify_ns_˚π_ty≥
(c⁄° 
x509_˚π
 *
˚π
, c⁄° 
ußge
)

306 i‡(
ußge
 =
NS_CERT_CHECK_NONE
)

307  
SUCCESS
;

308 i‡(
ußge
 =
NS_CERT_CHECK_CLIENT
)

309  ((
˚π
->
ext_ty≥s
 & 
EXT_NS_CERT_TYPE
)

310 && (
˚π
->
ns_˚π_ty≥
 & 
NS_CERT_TYPE_SSL_CLIENT
)Ë? 
SUCCESS
 : 
FAILURE
;

311 i‡(
ußge
 =
NS_CERT_CHECK_SERVER
)

312  ((
˚π
->
ext_ty≥s
 & 
EXT_NS_CERT_TYPE
)

313 && (
˚π
->
ns_˚π_ty≥
 & 
NS_CERT_TYPE_SSL_SERVER
)Ë? 
SUCCESS
 : 
FAILURE
;

315  
FAILURE
;

316 
	}
}

318 
ªsu…_t


319 
	$x509_vîify_˚π_ku
 (
x509_˚π
 *
˚π
, c⁄° * c⁄° 
ex≥˘ed_ku
,

320 
ex≥˘ed_Àn
)

322 
ªsu…_t
 
fFound
 = 
FAILURE
;

324 if(!(
˚π
->
ext_ty≥s
 & 
EXT_KEY_USAGE
))

326 
	`msg
 (
D_HANDSHAKE
, "Certificate doesÇot have key usageÉxtension");

330 
i
;

331 
nku
 = 
˚π
->
key_ußge
;

333 
	`msg
 (
D_HANDSHAKE
, "Validating certificate key usage");

334 
i
=0; 
SUCCESS
 !
fFound
 && i<
ex≥˘ed_Àn
; i++)

336 i‡(
ex≥˘ed_ku
[
i
] != 0)

338 
	`msg
 (
D_HANDSHAKE
, "++ Certificate has key usage %04x,Éxpects "

339 "%04x", 
nku
, 
ex≥˘ed_ku
[
i
]);

341 i‡(
nku
 =
ex≥˘ed_ku
[
i
])

343 
fFound
 = 
SUCCESS
;

348  
fFound
;

349 
	}
}

351 
ªsu…_t


352 
	$x509_vîify_˚π_eku
 (
x509_˚π
 *
˚π
, c⁄° * c⁄° 
ex≥˘ed_oid
)

354 
ªsu…_t
 
fFound
 = 
FAILURE
;

356 i‡(!(
˚π
->
ext_ty≥s
 & 
EXT_EXTENDED_KEY_USAGE
))

358 
	`msg
 (
D_HANDSHAKE
, "Certificate doesÇot haveÉxtended key usageÉxtension");

362 
x509_£quí˚
 *
oid_£q
 = &(
˚π
->
ext_key_ußge
);

364 
	`msg
 (
D_HANDSHAKE
, "Validating certificateÉxtended key usage");

365 
oid_£q
 !
NULL
)

367 
x509_buf
 *
oid
 = &
oid_£q
->
buf
;

368 
oid_num_°r
[1024];

369 c⁄° *
oid_°r
;

371 
oid_°r
 = 
	`x509_oid_gë_des¸ùti⁄
(
oid
);

372 i‡(
oid_°r
 !
NULL
)

374 
	`msg
 (
D_HANDSHAKE
, "++ Certificate has EKU (str) %s,Éxpects %s",

375 
oid_°r
, 
ex≥˘ed_oid
);

376 i‡(!
	`°rcmp
 (
ex≥˘ed_oid
, 
oid_°r
))

378 
fFound
 = 
SUCCESS
;

383 i‡(0 < 
	`x509_oid_gë_numîic_°rög
–
oid_num_°r
,

384  (
oid_num_°r
), 
oid
))

386 
	`msg
 (
D_HANDSHAKE
, "++ Certificate has EKU (oid) %s,Éxpects %s",

387 
oid_num_°r
, 
ex≥˘ed_oid
);

388 i‡(!
	`°rcmp
 (
ex≥˘ed_oid
, 
oid_num_°r
))

390 
fFound
 = 
SUCCESS
;

394 
oid_£q
 = oid_£q->
√xt
;

398  
fFound
;

399 
	}
}

401 
ªsu…_t


402 
	$x509_wrôe_≥m
(
FILE
 *
≥î˚π_fûe
, 
x509_˚π
 *
≥î˚π
)

404 
	`msg
 (
M_WARN
, "PolarSSL doesÇot support writingÖeer certificate in PEM format");

405  
FAILURE
;

406 
	}
}

411 
ªsu…_t


412 
	$x509_vîify_¸l
(c⁄° *
¸l_fûe
, 
x509_˚π
 *
˚π
, c⁄° *
subje˘
)

414 
ªsu…_t
 
ªtvÆ
 = 
FAILURE
;

415 
x509_¸l
 
¸l
 = {0};

417 
pﬁ¨_ªtvÆ
 = 
	`x509∑r£_¸lfûe
(&
¸l
, 
¸l_fûe
);

418 i‡(
pﬁ¨_ªtvÆ
 != 0)

420 
îr°r
[128];

421 
	`îr‹_°ªº‹
(
pﬁ¨_ªtvÆ
, 
îr°r
, (errstr));

422 
	`msg
 (
M_WARN
, "CRL: c™nŸÑód CRL from fûê%†(%s)", 
¸l_fûe
, 
îr°r
);

423 
íd
;

426 if(
˚π
->
issuî_øw
.
Àn
 !
¸l
.issuer_raw.len ||

427 
	`memcmp
(
¸l
.
issuî_øw
.
p
, 
˚π
->issuî_øw.p, cæ.issuî_øw.
Àn
) != 0)

429 
	`msg
 (
M_WARN
, "CRL: CRL %s is fromá different issuerÅhanÅhe issuer of "

430 "˚πifiˇã %s", 
¸l_fûe
, 
subje˘
);

431 
ªtvÆ
 = 
SUCCESS
;

432 
íd
;

435 i‡(0 !
	`x509∑r£_ªvoked
(
˚π
, &
¸l
))

437 
	`msg
 (
D_HANDSHAKE
, "CRL CHECK FAILED: %†i†REVOKED", 
subje˘
);

438 
íd
;

441 
ªtvÆ
 = 
SUCCESS
;

442 
	`msg
 (
D_HANDSHAKE
, "CRL CHECK OK: %s",
subje˘
);

444 
íd
:

445 
	`x509_¸l_‰ì
(&
¸l
);

446  
ªtvÆ
;

447 
	}
}

	@src/openvpn/ssl_verify_polarssl.h

30 #i‚de‡
SSL_VERIFY_POLARSSL_H_


31 
	#SSL_VERIFY_POLARSSL_H_


	)

33 
	~"syshód.h
"

34 
	~"misc.h
"

35 
	~"m™age.h
"

36 
	~<pﬁ¨s¶/x509.h
>

38 #i‚de‡
__OPENVPN_X509_CERT_T_DECLARED


39 
	#__OPENVPN_X509_CERT_T_DECLARED


	)

40 
x509_˚π
 
	t›ív≤_x509_˚π_t
;

75 
vîify_ˇŒback
 (*
£ssi⁄_obj
, 
x509_˚π
 *
˚π
, 
˚π_dïth
,

76 *
Êags
);

	@src/openvpn/status.c

25 #ifde‡
HAVE_CONFIG_H


26 
	~"c⁄fig.h
"

27 #ñi‡
deföed
(
_MSC_VER
)

28 
	~"c⁄fig-msvc.h
"

31 
	~"syshód.h
"

33 
	~"°©us.h
"

34 
	~"≥rf.h
"

35 
	~"misc.h
"

36 
	~"fdmisc.h
"

38 
	~"memdbg.h
"

45 
	$¥öt_°©us_mode
 (
Êags
)

47 
Êags
)

49 
STATUS_OUTPUT_WRITE
:

51 
STATUS_OUTPUT_READ
:

53 
STATUS_OUTPUT_READ
|
STATUS_OUTPUT_WRITE
:

58 
	}
}

60 
°©us_ouçut
 *

61 
	$°©us_›í
 (c⁄° *
fûíame
,

62 c⁄° 
ª‰esh_‰eq
,

63 c⁄° 
msgÀvñ
,

64 c⁄° 
vútuÆ_ouçut
 *
vout
,

65 c⁄° 
Êags
)

67 
°©us_ouçut
 *
so
 = 
NULL
;

68 i‡(
fûíame
 || 
msgÀvñ
 >0 || 
vout
)

70 
	`ALLOC_OBJ_CLEAR
 (
so
, 
°©us_ouçut
);

71 
so
->
Êags
 = flags;

72 
so
->
msgÀvñ
 = msglevel;

73 
so
->
vout
 = vout;

74 
so
->
fd
 = -1;

75 
	`buf_ª£t
 (&
so
->
ªad_buf
);

76 
	`evít_timeout_˛ór
 (&
so
->
ë
);

77 i‡(
fûíame
)

79 
so
->
Êags
)

81 
STATUS_OUTPUT_WRITE
:

82 
so
->
fd
 = 
	`∂©f‹m_›í
 (
fûíame
,

83 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
,

84 
S_IRUSR
 | 
S_IWUSR
);

86 
STATUS_OUTPUT_READ
:

87 
so
->
fd
 = 
	`∂©f‹m_›í
 (
fûíame
,

88 
O_RDONLY
,

89 
S_IRUSR
 | 
S_IWUSR
);

91 
STATUS_OUTPUT_READ
|
STATUS_OUTPUT_WRITE
:

92 
so
->
fd
 = 
	`∂©f‹m_›í
 (
fûíame
,

93 
O_CREAT
 | 
O_RDWR
,

94 
S_IRUSR
 | 
S_IWUSR
);

97 
	`ASSERT
 (0);

99 i‡(
so
->
fd
 >= 0)

101 
so
->
fûíame
 = 
	`°rög_Æloc
 (fûíame, 
NULL
);

102 
	`£t_˛€xec
 (
so
->
fd
);

105 i‡(
so
->
Êags
 & 
STATUS_OUTPUT_READ
)

106 
so
->
ªad_buf
 = 
	`Æloc_buf
 (512);

110 
	`msg
 (
M_WARN
, "NŸe: c™nŸ o≥¿%†f‹ %s", 
fûíame
, 
	`¥öt_°©us_mode
 (
so
->
Êags
));

111 
so
->
îr‹s
 = 
åue
;

115 
so
->
Êags
 = 
STATUS_OUTPUT_WRITE
;

117 i‡((
so
->
Êags
 & 
STATUS_OUTPUT_WRITE
Ë&& 
ª‰esh_‰eq
 > 0)

119 
	`evít_timeout_öô
 (&
so
->
ë
, 
ª‰esh_‰eq
, 0);

122  
so
;

123 
	}
}

125 
boﬁ


126 
	$°©us_åiggî
 (
°©us_ouçut
 *
so
)

128 i‡(
so
)

130 
timevÆ
 
nuŒ
;

131 
	`CLEAR
 (
nuŒ
);

132  
	`evít_timeout_åiggî
 (&
so
->
ë
, &
nuŒ
, 
ETT_DEFAULT
);

135  
Ál£
;

136 
	}
}

138 
boﬁ


139 
	$°©us_åiggî_tv
 (
°©us_ouçut
 *
so
, 
timevÆ
 *
tv
)

141 i‡(
so
)

142  
	`evít_timeout_åiggî
 (&
so
->
ë
, 
tv
, 
ETT_DEFAULT
);

144  
Ál£
;

145 
	}
}

148 
	$°©us_ª£t
 (
°©us_ouçut
 *
so
)

150 i‡(
so
 && so->
fd
 >= 0)

151 
	`l£ek
 (
so
->
fd
, (
off_t
)0, 
SEEK_SET
);

152 
	}
}

155 
	$°©us_Êush
 (
°©us_ouçut
 *
so
)

157 i‡(
so
 && so->
fd
 >0 && (so->
Êags
 & 
STATUS_OUTPUT_WRITE
))

159 #i‡
	`deföed
(
HAVE_FTRUNCATE
)

161 c⁄° 
off_t
 
off
 = 
	`l£ek
 (
so
->
fd
, (off_t)0, 
SEEK_CUR
);

162 i‡(
	`·runˇã
 (
so
->
fd
, 
off
) != 0) {

163 
	`msg
 (
M_WARN
, "FaûedÅÿåunˇã sètu†fûe: %s", 
	`°ªº‹
(
î∫o
));

166 #ñi‡
	`deföed
(
HAVE_CHSIZE
)

168 c⁄° 
off
 = (Ë
	`l£ek
 (
so
->
fd
, (
off_t
)0, 
SEEK_CUR
);

169 
	`chsize
 (
so
->
fd
, 
off
);

172 #w¨nög 
bŸh
 
·runˇã
 
™d
 
chsize
 
fun˘i⁄s
 
≠≥¨
 
to
 
be
 
missög
 
‰om
 
this
 
OS


176 i‡(
	`buf_deföed
 (&
so
->
ªad_buf
))

178 
	`ASSERT
 (
	`buf_öô
 (&
so
->
ªad_buf
, 0));

181 
	}
}

184 
boﬁ


185 
	$°©us_˛o£
 (
°©us_ouçut
 *
so
)

187 
boﬁ
 
ªt
 = 
åue
;

188 i‡(
so
)

190 i‡(
so
->
îr‹s
)

191 
ªt
 = 
Ál£
;

192 i‡(
so
->
fd
 >= 0)

194 i‡(
	`˛o£
 (
so
->
fd
) < 0)

195 
ªt
 = 
Ál£
;

197 i‡(
so
->
fûíame
)

198 
	`‰ì
 (
so
->
fûíame
);

199 i‡(
	`buf_deföed
 (&
so
->
ªad_buf
))

200 
	`‰ì_buf
 (&
so
->
ªad_buf
);

201 
	`‰ì
 (
so
);

204 
ªt
 = 
Ál£
;

205  
ªt
;

206 
	}
}

208 
	#STATUS_PRINTF_MAXLEN
 512

	)

211 
	$°©us_¥ötf
 (
°©us_ouçut
 *
so
, c⁄° *
f‹m©
, ...)

213 i‡(
so
 && (so->
Êags
 & 
STATUS_OUTPUT_WRITE
))

215 
buf
[
STATUS_PRINTF_MAXLEN
+2];

216 
va_li°
 
¨gli°
;

217 
°©
;

219 
	`va_°¨t
 (
¨gli°
, 
f‹m©
);

220 
°©
 = 
	`v¢¥ötf
 (
buf
, 
STATUS_PRINTF_MAXLEN
, 
f‹m©
, 
¨gli°
);

221 
	`va_íd
 (
¨gli°
);

222 
buf
[
STATUS_PRINTF_MAXLEN
 - 1] = 0;

224 i‡(
°©
 < 0 || sèà>
STATUS_PRINTF_MAXLEN
)

225 
so
->
îr‹s
 = 
åue
;

227 i‡(
so
->
msgÀvñ
 >0 && !so->
îr‹s
)

228 
	`msg
 (
so
->
msgÀvñ
, "%s", 
buf
);

230 i‡(
so
->
fd
 >0 && !so->
îr‹s
)

232 
Àn
;

233 
	`°rˇt
 (
buf
, "\n");

234 
Àn
 = 
	`°æí
 (
buf
);

235 i‡(
Àn
 > 0)

237 i‡(
	`wrôe
 (
so
->
fd
, 
buf
, 
Àn
) !=Üen)

238 
so
->
îr‹s
 = 
åue
;

242 i‡(
so
->
vout
 && !so->
îr‹s
)

244 
	`chomp
 (
buf
);

245 (*
so
->
vout
->
func
Ë(so->vout->
¨g
, so->vout->
Êags_deÁu…
, 
buf
);

248 
	}
}

250 
boﬁ


251 
	$°©us_ªad
 (
°©us_ouçut
 *
so
, 
buf„r
 *
buf
)

253 
boﬁ
 
ªt
 = 
Ál£
;

255 i‡(
so
 && so->
fd
 >0 && (so->
Êags
 & 
STATUS_OUTPUT_READ
))

257 
	`ASSERT
 (
	`buf_deföed
 (&
so
->
ªad_buf
));

258 
	`ASSERT
 (
	`buf_deföed
 (
buf
));

259 
åue
)

261 c⁄° 
c
 = 
	`buf_ªad_u8
 (&
so
->
ªad_buf
);

264 i‡(
c
 == -1)

266 
Àn
;

268 
	`ASSERT
 (
	`buf_öô
 (&
so
->
ªad_buf
, 0));

269 
Àn
 = 
	`ªad
 (
so
->
fd
, 
	`BPTR
 (&so->
ªad_buf
), 
	`BCAP
 (&so->read_buf));

270 i‡(
Àn
 <= 0)

273 
	`ASSERT
 (
	`buf_öc_Àn
 (&
so
->
ªad_buf
, 
Àn
));

277 
ªt
 = 
åue
;

279 i‡(
c
 == '\r')

282 i‡(
c
 == '\n')

285 
	`buf_wrôe_u8
 (
buf
, 
c
);

288 
	`buf_nuŒ_ãrmö©e
 (
buf
);

291  
ªt
;

292 
	}
}

	@src/openvpn/status.h

25 #i‚de‡
STATUS_H


26 
	#STATUS_H


	)

28 
	~"öãrvÆ.h
"

33 
	svútuÆ_ouçut
 {

34 *
	m¨g
;

35 
	mÊags_deÁu…
;

36 (*
	mfunc
Ë(*
	m¨g
, c⁄° 
	mÊags
, c⁄° *
	m°r
);

39 
ölöe
 

40 
	$vútuÆ_ouçut_¥öt
 (c⁄° 
vútuÆ_ouçut
 *
vo
, c⁄° 
Êags
, c⁄° *
°r
)

42 (*
vo
->
func
Ë(vo->
¨g
, 
Êags
, 
°r
);

43 
	}
}

49 
	s°©us_ouçut


51 
	#STATUS_OUTPUT_READ
 (1<<0)

	)

52 
	#STATUS_OUTPUT_WRITE
 (1<<1)

	)

53 
	mÊags
;

55 *
	mfûíame
;

56 
	mfd
;

57 
	mmsgÀvñ
;

58 c⁄° 
vútuÆ_ouçut
 *
	mvout
;

60 
buf„r
 
	mªad_buf
;

62 
evít_timeout
 
	më
;

64 
boﬁ
 
	mîr‹s
;

67 
°©us_ouçut
 *
°©us_›í
 (c⁄° *
fûíame
,

68 c⁄° 
ª‰esh_‰eq
,

69 c⁄° 
msgÀvñ
,

70 c⁄° 
vútuÆ_ouçut
 *
vout
,

71 c⁄° 
Êags
);

73 
boﬁ
 
°©us_åiggî_tv
 (
°©us_ouçut
 *
so
, 
timevÆ
 *
tv
);

74 
boﬁ
 
°©us_åiggî
 (
°©us_ouçut
 *
so
);

75 
°©us_ª£t
 (
°©us_ouçut
 *
so
);

76 
°©us_Êush
 (
°©us_ouçut
 *
so
);

77 
boﬁ
 
°©us_˛o£
 (
°©us_ouçut
 *
so
);

78 
	$°©us_¥ötf
 (
°©us_ouçut
 *
so
, c⁄° *
f‹m©
, ...)

79 #ifde‡
__GNUC__


80 #i‡
__USE_MINGW_ANSI_STDIO


81 
	`__©åibuã__
 ((
	$f‹m©
 (
gnu_¥ötf
, 2, 3)))

83 
	`__©åibuã__
 ((
	$f‹m©
 (
__¥ötf__
, 2, 3)))

88 
boﬁ
 
	`°©us_ªad
 (
°©us_ouçut
 *
so
, 
buf„r
 *
buf
);

90 
ölöe
 

91 
	$°©us_rw_Êags
 (c⁄° 
°©us_ouçut
 *
so
)

93 i‡(
so
)

94  
so
->
Êags
;

97 
	}
}

	@src/openvpn/syshead.h

25 #i‚de‡
SYSHEAD_H


26 
	#SYSHEAD_H


	)

28 
	~"com∑t.h
"

29 
	~"com∑t-°dboﬁ.h
"

32 #i‡
deföed
(
__GNUC__
)

33 
	#likñy
(
x
Ë
	`__buûtö_ex≥˘
((x),1)

	)

34 
	#u∆ikñy
(
x
Ë
	`__buûtö_ex≥˘
((x),0)

	)

36 
	#likñy
(
x
Ë(x)

	)

37 
	#u∆ikñy
(
x
Ë(x)

	)

40 #ifde‡
WIN32


41 
	~<wödows.h
>

42 
	~<wösock2.h
>

43 
	#¶ìp
(
x
Ë
	`SÀï
((x)*1000)

	)

44 
	#øndom
 
ønd


	)

45 
	#§™dom
 
§™d


	)

48 #i‡
deföed
(
__APPLE__
)

49 #i‡
__ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED__
 >= 1070

50 
	#__APPLE_USE_RFC_3542
 1

	)

54 #ifde‡
HAVE_SYS_TYPES_H


55 
	~<sys/ty≥s.h
>

58 #ifde‡
HAVE_SYS_WAIT_H


59 
	~<sys/waô.h
>

62 #i‚de‡
WIN32


63 #i‚de‡
WEXITSTATUS


64 
	#WEXITSTATUS
(
°©_vÆ
Ë(()(°©_vÆË>> 8)

	)

66 #i‚de‡
WIFEXITED


67 
	#WIFEXITED
(
°©_vÆ
Ë(((°©_vÆË& 255Ë=0)

	)

71 #ifde‡
HAVE_SYS_TIME_H


72 
	~<sys/time.h
>

75 #ifde‡
HAVE_TIME_H


76 
	~<time.h
>

79 #ifde‡
HAVE_SYS_SOCKET_H


80 
	~<sys/sockë.h
>

83 #ifde‡
HAVE_SYS_UN_H


84 
	~<sys/un.h
>

87 #ifde‡
HAVE_SYS_IOCTL_H


88 
	~<sys/io˘l.h
>

91 #ifde‡
HAVE_SYS_STAT_H


92 
	~<sys/°©.h
>

95 #ifde‡
HAVE_FCNTL_H


96 
	~<f˙é.h
>

99 #ifde‡
HAVE_DIRECT_H


100 
	~<dúe˘.h
>

103 #ifde‡
HAVE_IO_H


104 
	~<io.h
>

107 #ifde‡
HAVE_SYS_FILE_H


108 
	~<sys/fûe.h
>

111 #ifde‡
HAVE_STDLIB_H


112 
	~<°dlib.h
>

115 #ifde‡
HAVE_INTTYPES_H


116 
	~<öây≥s.h
>

117 #ñi‡
deföed
(
HAVE_STDINT_H
)

118 
	~<°döt.h
>

121 #ifde‡
HAVE_STDARG_H


122 
	~<°d¨g.h
>

125 #ifde‡
HAVE_UNISTD_H


126 
	~<uni°d.h
>

129 #ifde‡
HAVE_SIGNAL_H


130 
	~<sig«l.h
>

133 #ifde‡
HAVE_LIMITS_H


134 
	~<limôs.h
>

137 #ifde‡
HAVE_STDIO_H


138 
	~<°dio.h
>

141 #ifde‡
HAVE_CTYPE_H


142 
	~<˘y≥.h
>

145 #ifde‡
HAVE_ERRNO_H


146 
	~<î∫o.h
>

149 #ifde‡
HAVE_ERR_H


150 
	~<îr.h
>

153 #ifde‡
HAVE_SYSLOG_H


154 
	~<sy¶og.h
>

157 #ifde‡
HAVE_PWD_H


158 
	~<pwd.h
>

161 #ifde‡
HAVE_GRP_H


162 
	~<gΩ.h
>

165 #ifde‡
HAVE_NETDB_H


166 
	~<√tdb.h
>

169 #ifde‡
HAVE_NETINET_IN_H


170 
	~<√töë/ö.h
>

173 #ifde‡
HAVE_RESOLV_H


174 
	~<ªsﬁv.h
>

177 #ifde‡
HAVE_SYS_POLL_H


178 
	~<sys/pﬁl.h
>

181 #ifde‡
HAVE_SYS_EPOLL_H


182 
	~<sys/ïﬁl.h
>

185 #ifde‡
ENABLE_SELINUX


186 
	~<£löux/£löux.h
>

189 #i‡
deföed
(
HAVE_LIBGEN_H
)

190 
	~<libgí.h
>

193 #ifde‡
TARGET_SOLARIS


194 #ifde‡
HAVE_STRINGS_H


195 
	~<°rögs.h
>

198 #ifde‡
HAVE_STRING_H


199 
	~<°rög.h
>

203 #ifde‡
HAVE_ARPA_INET_H


204 
	~<¨∑/öë.h
>

207 #ifde‡
HAVE_NET_IF_H


208 
	~<√t/if.h
>

211 #ifde‡
TARGET_NETBSD


212 
	~<√t/if_èp.h
>

215 #ifde‡
TARGET_LINUX


217 #i‡
deföed
(
HAVE_NETINET_IF_ETHER_H
)

218 
	~<√töë/if_ëhî.h
>

221 #ifde‡
HAVE_LINUX_IF_TUN_H


222 
	~<löux/if_tun.h
>

225 #ifde‡
HAVE_NETINET_IP_H


226 
	~<√töë/ù.h
>

229 #ifde‡
HAVE_LINUX_SOCKIOS_H


230 
	~<löux/sockios.h
>

233 #ifde‡
HAVE_LINUX_TYPES_H


234 
	~<löux/ty≥s.h
>

237 #ifde‡
HAVE_LINUX_ERRQUEUE_H


238 
	~<löux/îrqueue.h
>

241 #ifde‡
HAVE_NETINET_TCP_H


242 
	~<√töë/t˝.h
>

247 #ifde‡
TARGET_SOLARIS


249 #ifde‡
HAVE_STROPTS_H


250 
	~<°r›ts.h
>

251 #unde‡
S_ERROR


254 #ifde‡
HAVE_NET_IF_TUN_H


255 
	~<√t/if_tun.h
>

258 #ifde‡
HAVE_SYS_SOCKIO_H


259 
	~<sys/sockio.h
>

262 #ifde‡
HAVE_NETINET_IN_SYSTM_H


263 
	~<√töë/ö_sy°m.h
>

266 #ifde‡
HAVE_NETINET_IP_H


267 
	~<√töë/ù.h
>

270 #ifde‡
HAVE_NETINET_TCP_H


271 
	~<√töë/t˝.h
>

276 #ifde‡
TARGET_OPENBSD


278 #ifde‡
HAVE_SYS_UIO_H


279 
	~<sys/uio.h
>

282 #ifde‡
HAVE_NETINET_IN_SYSTM_H


283 
	~<√töë/ö_sy°m.h
>

286 #ifde‡
HAVE_NETINET_IP_H


287 
	~<√töë/ù.h
>

290 #ifde‡
HAVE_NET_IF_TUN_H


291 
	~<√t/if_tun.h
>

296 #ifde‡
TARGET_FREEBSD


298 #ifde‡
HAVE_SYS_UIO_H


299 
	~<sys/uio.h
>

302 #ifde‡
HAVE_NETINET_IN_SYSTM_H


303 
	~<√töë/ö_sy°m.h
>

306 #ifde‡
HAVE_NETINET_IP_H


307 
	~<√töë/ù.h
>

310 #ifde‡
HAVE_NETINET_TCP_H


311 
	~<√töë/t˝.h
>

314 #ifde‡
HAVE_NET_IF_TUN_H


315 
	~<√t/if_tun.h
>

320 #ifde‡
TARGET_NETBSD


322 #ifde‡
HAVE_NET_IF_TUN_H


323 
	~<√t/if_tun.h
>

326 #ifde‡
HAVE_NETINET_TCP_H


327 
	~<√töë/t˝.h
>

332 #ifde‡
TARGET_DRAGONFLY


334 #ifde‡
HAVE_SYS_UIO_H


335 
	~<sys/uio.h
>

338 #ifde‡
HAVE_NETINET_IN_SYSTM_H


339 
	~<√töë/ö_sy°m.h
>

342 #ifde‡
HAVE_NETINET_IP_H


343 
	~<√töë/ù.h
>

346 #ifde‡
HAVE_NET_TUN_IF_TUN_H


347 
	~<√t/tun/if_tun.h
>

352 #ifde‡
TARGET_DARWIN


354 #ifde‡
HAVE_NETINET_TCP_H


355 
	~<√töë/t˝.h
>

360 #ifde‡
WIN32


361 
	~<ùhÕ≠i.h
>

362 
	~<¡ddndis.h
>

363 
	~<wööë.h
>

364 
	~<shñœpi.h
>

366 
	~<wösock2.h
>

367 
	~<ws2t˝ù.h
>

370 #ifde‡
HAVE_SYS_MMAN_H


371 #ifde‡
TARGET_DARWIN


372 
	#_P1003_1B_VISIBLE


	)

374 
	~<sys/mm™.h
>

381 #ifde‡
__STRICT_ANSI__


382 
	#PEDANTIC
 1

	)

383 #unde‡
HAVE_CPP_VARARG_MACRO_GCC


384 #unde‡
HAVE_CPP_VARARG_MACRO_ISO


385 #unde‡
EMPTY_ARRAY_SIZE


386 
	#EMPTY_ARRAY_SIZE
 1

	)

387 #unde‡
ölöe


388 
	#ölöe


	)

390 
	#PEDANTIC
 0

	)

396 #i‡
deföed
(
IPPROTO_IP
Ë&& deföed(
IP_TOS
Ë&& deföed(
HAVE_SETSOCKOPT
)

397 
	#PASSTOS_CAPABILITY
 1

	)

399 
	#PASSTOS_CAPABILITY
 0

	)

405 #i‡
deföed
(
HAVE_GETTIMEOFDAY
Ë|| deföed(
WIN32
)

406 
	#HAVE_GETTIMEOFDAY_NANOSECONDS
 1

	)

412 #i‚de‡
MIN


413 
	#MIN
(
a
,
b
Ë((◊)<(b))?◊):(b))

	)

419 #i‡
deföed
(
HAVE_LINUX_TYPES_H
Ë&& deföed(
HAVE_LINUX_ERRQUEUE_H
Ë&& deföed(
HAVE_SOCK_EXTENDED_ERR
Ë&& deföed(
HAVE_MSGHDR
Ë&& deföed(
HAVE_CMSGHDR
Ë&& deföed(
CMSG_FIRSTHDR
Ë&& deföed(
CMSG_NXTHDR
Ë&& deföed(
IP_RECVERR
Ë&& deföed(
MSG_ERRQUEUE
Ë&& deföed(
SOL_IP
Ë&& deföed(
HAVE_IOVEC
)

420 
	#EXTENDED_SOCKET_ERROR_CAPABILITY
 1

	)

422 
	#EXTENDED_SOCKET_ERROR_CAPABILITY
 0

	)

429 #i‡
deföed
(
ENABLE_MULTIHOME
Ë&& ((deföed(
HAVE_IN_PKTINFO
)&&deföed(
IP_PKTINFO
)Ë|| deföed(
IP_RECVDSTADDR
)Ë&& deföed(
HAVE_MSGHDR
Ë&& deföed(
HAVE_CMSGHDR
Ë&& deföed(
HAVE_IOVEC
Ë&& deföed(
CMSG_FIRSTHDR
Ë&& deföed(
CMSG_NXTHDR
Ë&& deföed(
HAVE_RECVMSG
Ë&& deföed(
HAVE_SENDMSG
)

430 
	#ENABLE_IP_PKTINFO
 1

	)

432 
	#ENABLE_IP_PKTINFO
 0

	)

439 #i‚de‡
SOL_IP


440 
	#SOL_IP
 
IPPROTO_IP


	)

447 #unde‡
EXTENDED_SOCKET_ERROR_CAPABILITY


448 
	#EXTENDED_SOCKET_ERROR_CAPABILITY
 0

	)

454 #i‡
deföed
(
HAVE_OPENLOG
Ë&& deföed(
HAVE_SYSLOG
)

455 
	#SYSLOG_CAPABILITY
 1

	)

457 
	#SYSLOG_CAPABILITY
 0

	)

463 #i‚de‡
O_BINARY


464 
	#O_BINARY
 0

	)

470 #ifde‡
WIN32


471 
	#OS_SPECIFIC_DIRSEP
 '\\'

	)

473 
	#OS_SPECIFIC_DIRSEP
 '/'

	)

480 #ifde‡
WIN32


481 
	#WIN32_0_1
 1

	)

483 
	#WIN32_0_1
 0

	)

489 #ifde‡
WIN32


490 
	#SOCKET_UNDEFINED
 (
INVALID_SOCKET
)

	)

491 
SOCKET
 
	tsockë_des¸ùt‹_t
;

493 
	#SOCKET_UNDEFINED
 (-1)

	)

494 
	tsockë_des¸ùt‹_t
;

497 
ölöe
 

498 
	$sockë_deföed
 (c⁄° 
sockë_des¸ùt‹_t
 
sd
)

500  
sd
 !
SOCKET_UNDEFINED
;

501 
	}
}

506 
	#USE_64_BIT_COUNTERS


	)

512 #i‡
deföed
(
HAVE_EXECVE
Ë&& deföed(
HAVE_FORK
)

513 
	#ENABLE_FEATURE_EXECVE


	)

520 #i‡
deföed
(
ENABLE_CLIENT_SERVER
Ë&& deföed(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
Ë&& deföed(
HAVE_GETTIMEOFDAY_NANOSECONDS
)

521 
	#P2MP
 1

	)

523 
	#P2MP
 0

	)

526 #i‡
P2MP
 && !
deföed
(
ENABLE_CLIENT_ONLY
)

527 
	#P2MP_SERVER
 1

	)

529 
	#P2MP_SERVER
 0

	)

535 #i‡
deföed
(
ENABLE_PORT_SHARE
Ë&& 
P2MP_SERVER
 && deföed(
SCM_RIGHTS
Ë&& deföed(
HAVE_MSGHDR
Ë&& deföed(
HAVE_CMSGHDR
Ë&& deföed(
HAVE_IOVEC
Ë&& deföed(
CMSG_FIRSTHDR
Ë&& deföed(
CMSG_NXTHDR
Ë&& deföed(
HAVE_RECVMSG
Ë&& deföed(
HAVE_SENDMSG
)

536 
	#PORT_SHARE
 1

	)

538 
	#PORT_SHARE
 0

	)

544 #i‡
deföed
(
ENABLE_DEF_AUTH
Ë&& 
P2MP_SERVER
 && deföed(
ENABLE_PLUGIN
)

545 
	#PLUGIN_DEF_AUTH


	)

547 #i‡
deföed
(
ENABLE_DEF_AUTH
Ë&& 
P2MP_SERVER
 && deföed(
ENABLE_MANAGEMENT
)

548 
	#MANAGEMENT_DEF_AUTH


	)

550 #i‡!
deföed
(
PLUGIN_DEF_AUTH
Ë&& !deföed(
MANAGEMENT_DEF_AUTH
)

551 #unde‡
ENABLE_DEF_AUTH


557 #i‡
deföed
(
ENABLE_MANAGEMENT
Ë&& deföed(
ENABLE_SSL
)

558 
	#MANAGMENT_EXTERNAL_KEY


	)

562 #ifde‡
ENABLE_CRYPTO_POLARSSL


563 
	#ENABLE_PREDICTION_RESISTANCE


	)

570 #i‡
deföed
(
MANAGEMENT_DEF_AUTH
Ë|| deföed(
MANAGMENT_EXTERNAL_KEY
)

571 
	#MANAGEMENT_IN_EXTRA


	)

577 #i‡
deföed
(
ENABLE_PF
Ë&& 
P2MP_SERVER
 && deföed(
ENABLE_PLUGIN
Ë&& deföed(
HAVE_STAT
)

578 
	#PLUGIN_PF


	)

580 #i‡
deföed
(
ENABLE_PF
Ë&& 
P2MP_SERVER
 && deföed(
MANAGEMENT_DEF_AUTH
)

581 
	#MANAGEMENT_PF


	)

583 #i‡!
deföed
(
PLUGIN_PF
Ë&& !deföed(
MANAGEMENT_PF
)

584 #unde‡
ENABLE_PF


590 #i‡
deföed
(
PF_UNIX
Ë&& !deföed(
WIN32
)

591 
	#UNIX_SOCK_SUPPORT
 1

	)

593 
	#UNIX_SOCK_SUPPORT
 0

	)

599 
	#ENABLE_BUFFER_LIST


	)

604 #i‚de‡
ENABLE_SMALL


605 
	#ENABLE_OCC


	)

611 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_HTTP_PROXY
)

612 
	#NTLM
 1

	)

614 
	#NTLM
 0

	)

620 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_HTTP_PROXY
)

621 
	#PROXY_DIGEST_AUTH
 1

	)

623 
	#PROXY_DIGEST_AUTH
 0

	)

629 #i‡
deföed
(
ENABLE_HTTP_PROXY
Ë|| deföed(
ENABLE_SOCKS
)

630 
	#GENERAL_PROXY_SUPPORT


	)

636 #i‡
deföed
(
WIN32
Ë&& deföed(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
Ë&& deföed(
ENABLE_CRYPTO_OPENSSL
)

637 
	#ENABLE_CRYPTOAPI


	)

643 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
Ë&& deföed (
ENABLE_CRYPTO_OPENSSL
)

644 
	#ENABLE_X509_TRACK


	)

650 #i‡
deföed
(
HAVE_POLL
Ë&& deföed(
HAVE_SYS_POLL_H
)

651 
	#POLL
 1

	)

653 
	#POLL
 0

	)

659 #i‡
deföed
(
HAVE_EPOLL_CREATE
Ë&& deföed(
HAVE_SYS_EPOLL_H
)

660 
	#EPOLL
 1

	)

662 
	#EPOLL
 0

	)

667 #unde‡
EPOLL


668 
	#EPOLL
 0

	)

674 #i‡
deföed
(
ENABLE_MANAGEMENT
Ë&& deföed(
ENABLE_HTTP_PROXY
)

675 
	#HTTP_PROXY_OVERRIDE
 1

	)

677 
	#HTTP_PROXY_OVERRIDE
 0

	)

684 #i‡
deföed
(
HAVE_GETTIMEOFDAY_NANOSECONDS
)

685 
	#TIME_BACKTRACK_PROTECTION
 1

	)

691 #i‡
deföed
(
HAVE_GETTIMEOFDAY_NANOSECONDS
)

692 
	#ENABLE_FEATURE_SHAPER
 1

	)

698 #i‡
deföed
(
HAVE_GETSOCKOPT
Ë&& deföed(
SOL_SOCKET
Ë&& deföed(
SO_ERROR
Ë&& deföed(
EINPROGRESS
Ë&& deföed(
ETIMEDOUT
)

699 
	#CONNECT_NONBLOCK


	)

705 #i‡
deföed
(
ENABLE_AUTO_USERID
)

706 
	#AUTO_USERID
 1

	)

708 
	#AUTO_USERID
 0

	)

714 #i‡
deföed
(
ENABLE_MANAGEMENT
)

715 
	#ENABLE_CLIENT_CR


	)

721 #i‡
deföed
(
ENABLE_CRYPTO
Ë&& deföed(
ENABLE_SSL
)

722 
	#ENABLE_PUSH_PEER_INFO


	)

728 
	#ENABLE_CLIENT_NAT


	)

733 #ifde‡
TARGET_LINUX


734 
	#ENABLE_MEMSTATS


	)

	@src/openvpn/tun.c

33 #ifde‡
HAVE_CONFIG_H


34 
	~"c⁄fig.h
"

35 #ñi‡
deföed
(
_MSC_VER
)

36 
	~"c⁄fig-msvc.h
"

39 
	~"syshód.h
"

41 
	~"tun.h
"

42 
	~"fdmisc.h
"

43 
	~"comm⁄.h
"

44 
	~"misc.h
"

45 
	~"sockë.h
"

46 
	~"m™age.h
"

47 
	~"rouã.h
"

48 
	~"wö32.h
"

50 
	~"memdbg.h
"

52 #ifde‡
WIN32


56 
	#NI_TEST_FIRST
 (1<<0)

	)

57 
	#NI_IP_NETMASK
 (1<<1)

	)

58 
	#NI_OPTIONS
 (1<<2)

	)

60 
√tsh_ifc⁄fig
 (c⁄° 
tu¡≠_›ti⁄s
 *
to
,

61 c⁄° *
Êex_«me
,

62 c⁄° 
ö_addr_t
 
ù
,

63 c⁄° 
ö_addr_t
 
√tmask
,

64 c⁄° 
Êags
);

65 
√tsh_comm™d
 (c⁄° 
¨gv
 *
a
, 
n
);

67 c⁄° *
√tsh_gë_id
 (c⁄° *
dev_node
, 
gc_¨ía
 *
gc
);

71 #ifde‡
TARGET_SOLARIS


72 
sﬁ¨is_îr‹_˛o£
 (
tu¡≠
 *
â
, c⁄° 
ív_£t
 *
es
, c⁄° *
a˘uÆ
, 
boﬁ
 
u≈lumb_öë6
);

73 
	~<°r›ts.h
>

76 #i‡
deföed
(
TARGET_DARWIN
Ë&& 
HAVE_NET_IF_UTUN_H


77 
	~<sys/kîn_c⁄åﬁ.h
>

78 
	~<√t/if_utun.h
>

79 
	~<sys/sys_domaö.h
>

82 
˛ór_tu¡≠
 (
tu¡≠
 *tuntap);

84 
boﬁ


85 
	$is_dev_ty≥
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
m©ch_ty≥
)

87 
	`ASSERT
 (
m©ch_ty≥
);

88 i‡(!
dev
)

89  
Ál£
;

90 i‡(
dev_ty≥
)

91  !
	`°rcmp
 (
dev_ty≥
, 
m©ch_ty≥
);

93  !
	`°∫cmp
 (
dev
, 
m©ch_ty≥
, 
	`°æí
 (match_type));

94 
	}
}

97 
	$dev_ty≥_íum
 (c⁄° *
dev
, c⁄° *
dev_ty≥
)

99 i‡(
	`is_dev_ty≥
 (
dev
, 
dev_ty≥
, "tun"))

100  
DEV_TYPE_TUN
;

101 i‡(
	`is_dev_ty≥
 (
dev
, 
dev_ty≥
, "tap"))

102  
DEV_TYPE_TAP
;

103 i‡(
	`is_dev_ty≥
 (
dev
, 
dev_ty≥
, "null"))

104  
DEV_TYPE_NULL
;

106  
DEV_TYPE_UNDEF
;

107 
	}
}

110 
	$dev_ty≥_°rög
 (c⁄° *
dev
, c⁄° *
dev_ty≥
)

112 
	`dev_ty≥_íum
 (
dev
, 
dev_ty≥
))

114 
DEV_TYPE_TUN
:

116 
DEV_TYPE_TAP
:

118 
DEV_TYPE_NULL
:

123 
	}
}

130 
	$guess_tu¡≠_dev
 (c⁄° *
dev
,

131 c⁄° *
dev_ty≥
,

132 c⁄° *
dev_node
,

133 
gc_¨ía
 *
gc
)

135 #ifde‡
WIN32


136 c⁄° 
dt
 = 
	`dev_ty≥_íum
 (
dev
, 
dev_ty≥
);

137 i‡(
dt
 =
DEV_TYPE_TUN
 || dà=
DEV_TYPE_TAP
)

139  
	`√tsh_gë_id
 (
dev_node
, 
gc
);

144  
dev
;

145 
	}
}

149 c⁄° 
	gifc⁄fig_w¨n_how_to_sûí˚
[] = "(silenceÅhis warning with --ifconfig-nowarn)";

159 
	$ifc⁄fig_ßnôy_check
 (
boﬁ
 
tun
, 
ö_addr_t
 
addr
, 
t›ﬁogy
)

161 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

162 c⁄° 
boﬁ
 
looks_like_√tmask
 = ((
addr
 & 0xFF000000) == 0xFF000000);

163 i‡(
tun
)

165 i‡(
looks_like_√tmask
 && (
t›ﬁogy
 =
TOP_NET30
 ||Å›ﬁogy =
TOP_P2P
))

166 
	`msg
 (
M_WARN
, "WARNING: Since youáre using --devÅun witháÖoint-to-pointÅopology,Åhe secondárgumentÅo --ifconfig must beán IPáddress. Youáre using something (%s)ÅhatÜooks moreÜikeáÇetmask. %s",

167 
	`¥öt_ö_addr_t
 (
addr
, 0, &
gc
),

168 
ifc⁄fig_w¨n_how_to_sûí˚
);

172 i‡(!
looks_like_√tmask
)

173 
	`msg
 (
M_WARN
, "WARNING: Since youáre using --devÅap,Åhe secondárgumentÅo --ifconfig must beáÇetmask, forÉxample somethingÜike 255.255.255.0. %s",

174 
ifc⁄fig_w¨n_how_to_sûí˚
);

176 
	`gc_‰ì
 (&
gc
);

177 
	}
}

182 
ö_addr_t


183 
	$gíî©e_ifc⁄fig_brﬂdˇ°_addr
 (
ö_addr_t
 
loˇl
,

184 
ö_addr_t
 
√tmask
)

186  
loˇl
 | ~
√tmask
;

187 
	}
}

194 
	$check_addr_˛ash
 (c⁄° *
«me
,

195 
ty≥
,

196 
ö_addr_t
 
public
,

197 
ö_addr_t
 
loˇl
,

198 
ö_addr_t
 
ªmŸe_√tmask
)

200 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

202 
	`msg
 (
M_INFO
, "CHECK_ADDR_CLASHÅype=%dÖublic=%sÜocal=%s,Ñemote_netmask=%s",

203 
ty≥
,

204 
	`¥öt_ö_addr_t
 (
public
, 0, &
gc
),

205 
	`¥öt_ö_addr_t
 (
loˇl
, 0, &
gc
),

206 
	`¥öt_ö_addr_t
 (
ªmŸe_√tmask
, 0, &
gc
));

209 i‡(
public
)

211 i‡(
ty≥
 =
DEV_TYPE_TUN
)

213 c⁄° 
ö_addr_t
 
ã°_√tmask
 = 0xFFFFFF00;

214 c⁄° 
ö_addr_t
 
public_√t
 = 
public
 & 
ã°_√tmask
;

215 c⁄° 
ö_addr_t
 
loˇl_√t
 = 
loˇl
 & 
ã°_√tmask
;

216 c⁄° 
ö_addr_t
 
ªmŸe_√t
 = 
ªmŸe_√tmask
 & 
ã°_√tmask
;

218 i‡(
public
 =
loˇl
 ||Öubli¯=
ªmŸe_√tmask
)

219 
	`msg
 (
M_WARN
,

221 
«me
,

222 
	`¥öt_ö_addr_t
 (
public
, 0, &
gc
),

223 
	`¥öt_ö_addr_t
 (
loˇl
, 0, &
gc
),

224 
	`¥öt_ö_addr_t
 (
ªmŸe_√tmask
, 0, &
gc
),

225 
ifc⁄fig_w¨n_how_to_sûí˚
);

227 i‡(
public_√t
 =
loˇl_√t
 ||Öublic_√à=
ªmŸe_√t
)

228 
	`msg
 (
M_WARN
,

230 
«me
,

231 
	`¥öt_ö_addr_t
 (
public
, 0, &
gc
),

232 
	`¥öt_ö_addr_t
 (
loˇl
, 0, &
gc
),

233 
	`¥öt_ö_addr_t
 (
ªmŸe_√tmask
, 0, &
gc
),

234 
ifc⁄fig_w¨n_how_to_sûí˚
);

236 i‡(
ty≥
 =
DEV_TYPE_TAP
)

238 c⁄° 
ö_addr_t
 
public_√tw‹k
 = 
public
 & 
ªmŸe_√tmask
;

239 c⁄° 
ö_addr_t
 
vútuÆ_√tw‹k
 = 
loˇl
 & 
ªmŸe_√tmask
;

240 i‡(
public_√tw‹k
 =
vútuÆ_√tw‹k
)

241 
	`msg
 (
M_WARN
,

243 
«me
,

244 
	`¥öt_ö_addr_t
 (
public
, 0, &
gc
),

245 
	`¥öt_ö_addr_t
 (
loˇl
, 0, &
gc
),

246 
	`¥öt_ö_addr_t
 (
ªmŸe_√tmask
, 0, &
gc
),

247 
ifc⁄fig_w¨n_how_to_sûí˚
);

250 
	`gc_‰ì
 (&
gc
);

251 
	}
}

261 
	$check_sub√t_c⁄Êi˘
 (c⁄° 
ö_addr_t
 
ù
,

262 c⁄° 
ö_addr_t
 
√tmask
,

263 c⁄° *
¥efix
)

266 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

267 
ö_addr_t
 
œn_gw
 = 0;

268 
ö_addr_t
 
œn_√tmask
 = 0;

270 i‡(
	`gë_deÁu…_g©eway
 (&
œn_gw
, &
œn_√tmask
) &&Üan_netmask)

272 c⁄° 
ö_addr_t
 
œn_√tw‹k
 = 
œn_gw
 & 
œn_√tmask
;

273 c⁄° 
ö_addr_t
 
√tw‹k
 = 
ù
 & 
√tmask
;

276 i‡((
√tw‹k
 & 
œn_√tmask
Ë=
œn_√tw‹k


277 || (
œn_√tw‹k
 & 
√tmask
Ë=
√tw‹k
)

279 
	`msg
 (
M_WARN
, "WARNING:Öotential %s subnet conflict betweenÜocal LAN [%s/%s]ándÑemote VPN [%s/%s]",

280 
¥efix
,

281 
	`¥öt_ö_addr_t
 (
œn_√tw‹k
, 0, &
gc
),

282 
	`¥öt_ö_addr_t
 (
œn_√tmask
, 0, &
gc
),

283 
	`¥öt_ö_addr_t
 (
√tw‹k
, 0, &
gc
),

284 
	`¥öt_ö_addr_t
 (
√tmask
, 0, &
gc
));

287 
	`gc_‰ì
 (&
gc
);

289 
	}
}

292 
	$w¨n_⁄_u£_of_comm⁄_sub√ts
 ()

294 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

295 
rouã_g©eway_öfo
 
rgi
;

296 c⁄° 
√eded
 = (
RGI_ADDR_DEFINED
|
RGI_NETMASK_DEFINED
);

298 
	`gë_deÁu…_g©eway
 (&
rgi
);

299 i‡((
rgi
.
Êags
 & 
√eded
) ==Çeeded)

301 c⁄° 
ö_addr_t
 
œn_√tw‹k
 = 
rgi
.
g©eway
.
addr
 &Ñgi.g©eway.
√tmask
;

302 i‡(
œn_√tw‹k
 == 0xC0A80000 ||Üan_network == 0xC0A80100)

303 
	`msg
 (
M_WARN
, "NOTE: yourÜocal LAN usesÅheÉxtremely common subnetáddress 192.168.0.x or 192.168.1.x. BeáwareÅhatÅhis might createÑouting conflicts if you connectÅoÅhe VPN server fromÖublicÜocations suchás internet cafesÅhat useÅhe same subnet.");

305 
	`gc_‰ì
 (&
gc
);

306 
	}
}

313 
	$ifc⁄fig_›ti⁄s_°rög
 (c⁄° 
tu¡≠
* 
â
, 
boﬁ
 
ªmŸe
, boﬁ 
dißbÀ
, 
gc_¨ía
 *
gc
)

315 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

316 i‡(
â
->
did_ifc⁄fig_£tup
 && !
dißbÀ
)

318 i‡(
â
->
ty≥
 =
DEV_TYPE_TAP
 || (â->ty≥ =
DEV_TYPE_TUN
 &&Åt->
t›ﬁogy
 =
TOP_SUBNET
))

320 
	`buf_¥ötf
 (&
out
, "%s %s",

321 
	`¥öt_ö_addr_t
 (
â
->
loˇl
 &Åt->
ªmŸe_√tmask
, 0, 
gc
),

322 
	`¥öt_ö_addr_t
 (
â
->
ªmŸe_√tmask
, 0, 
gc
));

324 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

326 c⁄° *
l
, *
r
;

327 i‡(
ªmŸe
)

329 
r
 = 
	`¥öt_ö_addr_t
 (
â
->
loˇl
, 0, 
gc
);

330 
l
 = 
	`¥öt_ö_addr_t
 (
â
->
ªmŸe_√tmask
, 0, 
gc
);

334 
l
 = 
	`¥öt_ö_addr_t
 (
â
->
loˇl
, 0, 
gc
);

335 
r
 = 
	`¥öt_ö_addr_t
 (
â
->
ªmŸe_√tmask
, 0, 
gc
);

337 
	`buf_¥ötf
 (&
out
, "%†%s", 
r
, 
l
);

340 
	`buf_¥ötf
 (&
out
, "[undef]");

342  
	`BSTR
 (&
out
);

343 
	}
}

349 
	$tun_°©
 (c⁄° 
tu¡≠
 *
â
, 
rwÊags
, 
gc_¨ía
 *
gc
)

351 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (64, 
gc
);

352 i‡(
â
)

354 i‡(
rwÊags
 & 
EVENT_READ
)

356 
	`buf_¥ötf
 (&
out
, "T%s",

357 (
â
->
rwÊags_debug
 & 
EVENT_READ
) ? "R" : "r");

358 #ifde‡
WIN32


359 
	`buf_¥ötf
 (&
out
, "%s",

360 
	`ovîœµed_io_°©e_ascii
 (&
â
->
ªads
));

363 i‡(
rwÊags
 & 
EVENT_WRITE
)

365 
	`buf_¥ötf
 (&
out
, "T%s",

366 (
â
->
rwÊags_debug
 & 
EVENT_WRITE
) ? "W" : "w");

367 #ifde‡
WIN32


368 
	`buf_¥ötf
 (&
out
, "%s",

369 
	`ovîœµed_io_°©e_ascii
 (&
â
->
wrôes
));

375 
	`buf_¥ötf
 (&
out
, "T?");

377  
	`BSTR
 (&
out
);

378 
	}
}

383 
boﬁ


384 
	$is_tun_p2p
 (c⁄° 
tu¡≠
 *
â
)

386 
boﬁ
 
tun
 = 
Ál£
;

388 i‡(
â
->
ty≥
 =
DEV_TYPE_TAP
 || (â->ty≥ =
DEV_TYPE_TUN
 &&Åt->
t›ﬁogy
 =
TOP_SUBNET
))

389 
tun
 = 
Ál£
;

390 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

391 
tun
 = 
åue
;

393 
	`msg
 (
M_FATAL
, "Error:Öroblem withÅun vs.Åap setting");

395  
tun
;

396 
	}
}

404 
tu¡≠
 *

405 
	$öô_tun
 (c⁄° *
dev
,

406 c⁄° *
dev_ty≥
,

407 
t›ﬁogy
,

408 c⁄° *
ifc⁄fig_loˇl_∑rm
,

409 c⁄° *
ifc⁄fig_ªmŸe_√tmask_∑rm
,

410 c⁄° *
ifc⁄fig_ùv6_loˇl_∑rm
,

411 
ifc⁄fig_ùv6_√tbôs_∑rm
,

412 c⁄° *
ifc⁄fig_ùv6_ªmŸe_∑rm
,

413 
ö_addr_t
 
loˇl_public
,

414 
ö_addr_t
 
ªmŸe_public
,

415 c⁄° 
boﬁ
 
°ri˘_w¨n
,

416 
ív_£t
 *
es
)

418 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

419 
tu¡≠
 *
â
;

421 
	`ALLOC_OBJ
 (
â
, 
tu¡≠
);

422 
	`˛ór_tu¡≠
 (
â
);

424 
â
->
ty≥
 = 
	`dev_ty≥_íum
 (
dev
, 
dev_ty≥
);

425 
â
->
t›ﬁogy
 =Åopology;

427 i‡(
ifc⁄fig_loˇl_∑rm
 && 
ifc⁄fig_ªmŸe_√tmask_∑rm
)

429 
boﬁ
 
tun
 = 
Ál£
;

430 c⁄° *
ifc⁄fig_loˇl
 = 
NULL
;

431 c⁄° *
ifc⁄fig_ªmŸe_√tmask
 = 
NULL
;

432 c⁄° *
ifc⁄fig_brﬂdˇ°
 = 
NULL
;

437 
tun
 = 
	`is_tun_p2p
 (
â
);

443 
â
->
loˇl
 = 
	`gëaddr
 (

444 
GETADDR_RESOLVE


445 | 
GETADDR_HOST_ORDER


446 | 
GETADDR_FATAL_ON_SIGNAL


447 | 
GETADDR_FATAL
,

448 
ifc⁄fig_loˇl_∑rm
,

450 
NULL
,

451 
NULL
);

453 
â
->
ªmŸe_√tmask
 = 
	`gëaddr
 (

454 (
tun
 ? 
GETADDR_RESOLVE
 : 0)

455 | 
GETADDR_HOST_ORDER


456 | 
GETADDR_FATAL_ON_SIGNAL


457 | 
GETADDR_FATAL
,

458 
ifc⁄fig_ªmŸe_√tmask_∑rm
,

460 
NULL
,

461 
NULL
);

466 i‡(
°ri˘_w¨n
)

468 
	`ifc⁄fig_ßnôy_check
 (
â
->
ty≥
 =
DEV_TYPE_TUN
,Åt->
ªmŸe_√tmask
,Åt->
t›ﬁogy
);

475 
	`check_addr_˛ash
 ("local",

476 
â
->
ty≥
,

477 
loˇl_public
,

478 
â
->
loˇl
,

479 
â
->
ªmŸe_√tmask
);

481 
	`check_addr_˛ash
 ("remote",

482 
â
->
ty≥
,

483 
ªmŸe_public
,

484 
â
->
loˇl
,

485 
â
->
ªmŸe_√tmask
);

487 i‡(
â
->
ty≥
 =
DEV_TYPE_TAP
 || (â->ty≥ =
DEV_TYPE_TUN
 &&Åt->
t›ﬁogy
 =
TOP_SUBNET
))

488 
	`check_sub√t_c⁄Êi˘
 (
â
->
loˇl
,Åt->
ªmŸe_√tmask
, "TUN/TAPádapter");

489 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

490 
	`check_sub√t_c⁄Êi˘
 (
â
->
loˇl
, 
IPV4_NETMASK_HOST
, "TUN/TAPádapter");

496 
ifc⁄fig_loˇl
 = 
	`¥öt_ö_addr_t
 (
â
->
loˇl
, 0, &
gc
);

497 
ifc⁄fig_ªmŸe_√tmask
 = 
	`¥öt_ö_addr_t
 (
â
->
ªmŸe_√tmask
, 0, &
gc
);

502 i‡(!
tun
)

504 
â
->
brﬂdˇ°
 = 
	`gíî©e_ifc⁄fig_brﬂdˇ°_addr
 (â->
loˇl
,Åt->
ªmŸe_√tmask
);

505 
ifc⁄fig_brﬂdˇ°
 = 
	`¥öt_ö_addr_t
 (
â
->
brﬂdˇ°
, 0, &
gc
);

511 i‡(
es
)

513 
	`£ãnv_°r
 (
es
, "ifc⁄fig_loˇl", 
ifc⁄fig_loˇl
);

514 i‡(
tun
)

516 
	`£ãnv_°r
 (
es
, "ifc⁄fig_ªmŸe", 
ifc⁄fig_ªmŸe_√tmask
);

520 
	`£ãnv_°r
 (
es
, "ifc⁄fig_√tmask", 
ifc⁄fig_ªmŸe_√tmask
);

521 
	`£ãnv_°r
 (
es
, "ifc⁄fig_brﬂdˇ°", 
ifc⁄fig_brﬂdˇ°
);

525 
â
->
did_ifc⁄fig_£tup
 = 
åue
;

528 i‡(
ifc⁄fig_ùv6_loˇl_∑rm
 && 
ifc⁄fig_ùv6_ªmŸe_∑rm
)

530 c⁄° *
ifc⁄fig_ùv6_loˇl
 = 
NULL
;

531 c⁄° *
ifc⁄fig_ùv6_ªmŸe
 = 
NULL
;

537 i‡–
	`öë_±⁄
–
AF_INET6
, 
ifc⁄fig_ùv6_loˇl_∑rm
, &
â
->
loˇl_ùv6
 ) != 1 ||

538 
	`öë_±⁄
–
AF_INET6
, 
ifc⁄fig_ùv6_ªmŸe_∑rm
, &
â
->
ªmŸe_ùv6
 ) != 1 )

540 
	`msg
–
M_FATAL
, "öô_tun:ÖrobÀm c⁄vîtög IPv6 ifc⁄figáddªs£†%†™d %†tÿbö¨y", 
ifc⁄fig_ùv6_loˇl_∑rm
, 
ifc⁄fig_ùv6_ªmŸe_∑rm
 );

542 
â
->
√tbôs_ùv6
 = 
ifc⁄fig_ùv6_√tbôs_∑rm
;

547 
ifc⁄fig_ùv6_loˇl
 = 
	`¥öt_ö6_addr
 (
â
->
loˇl_ùv6
, 0, &
gc
);

548 
ifc⁄fig_ùv6_ªmŸe
 = 
	`¥öt_ö6_addr
 (
â
->
ªmŸe_ùv6
, 0, &
gc
);

553 i‡(
es
)

555 
	`£ãnv_°r
 (
es
, "ifc⁄fig_ùv6_loˇl", 
ifc⁄fig_ùv6_loˇl
);

556 
	`£ãnv_öt
 (
es
, "ifc⁄fig_ùv6_√tbôs", 
â
->
√tbôs_ùv6
);

557 
	`£ãnv_°r
 (
es
, "ifc⁄fig_ùv6_ªmŸe", 
ifc⁄fig_ùv6_ªmŸe
);

559 
â
->
did_ifc⁄fig_ùv6_£tup
 = 
åue
;

562 
	`gc_‰ì
 (&
gc
);

563  
â
;

564 
	}
}

570 
	$öô_tun_po°
 (
tu¡≠
 *
â
,

571 c⁄° 
‰ame
 *frame,

572 c⁄° 
tu¡≠_›ti⁄s
 *
›ti⁄s
)

574 
â
->
›ti⁄s
 = *options;

575 #ifde‡
WIN32


576 
	`ovîœµed_io_öô
 (&
â
->
ªads
, 
‰ame
, 
FALSE
, 
åue
);

577 
	`ovîœµed_io_öô
 (&
â
->
wrôes
, 
‰ame
, 
TRUE
, 
åue
);

578 
â
->
rw_h™dÀ
.
ªad
 =Åt->
ªads
.
ovîœµed
.
hEvít
;

579 
â
->
rw_h™dÀ
.
wrôe
 =Åt->
wrôes
.
ovîœµed
.
hEvít
;

580 
â
->
ad≠ãr_ödex
 = 
TUN_ADAPTER_INDEX_INVALID
;

582 
	}
}

584 #i‡
deföed
(
WIN32
) || \

585 
deföed
(
TARGET_DARWIN
Ë|| deföed(
TARGET_NETBSD
Ë|| 
	$deföed
(
TARGET_OPENBSD
)

592 
	$add_rouã_c⁄√˘ed_v6_√t
(
tu¡≠
 * 
â
,

593 c⁄° 
ív_£t
 *
es
)

595 
rouã_ùv6
 
r6
;

597 
r6
.
deföed
 = 
åue
;

598 
r6
.
√tw‹k
 = 
â
->
loˇl_ùv6
;

599 
r6
.
√tbôs
 = 
â
->
√tbôs_ùv6
;

600 
r6
.
g©eway
 = 
â
->
loˇl_ùv6
;

601 
r6
.
mëric
 = 0;

602 
r6
.
mëric_deföed
 = 
åue
;

603 
	`add_rouã_ùv6
 (&
r6
, 
â
, 0, 
es
);

604 
	}
}

606 
	$dñëe_rouã_c⁄√˘ed_v6_√t
(
tu¡≠
 * 
â
,

607 c⁄° 
ív_£t
 *
es
)

609 
rouã_ùv6
 
r6
;

611 
r6
.
deföed
 = 
åue
;

612 
r6
.
√tw‹k
 = 
â
->
loˇl_ùv6
;

613 
r6
.
√tbôs
 = 
â
->
√tbôs_ùv6
;

614 
r6
.
g©eway
 = 
â
->
loˇl_ùv6
;

615 
r6
.
mëric
 = 0;

616 
r6
.
mëric_deföed
 = 
åue
;

617 
	`dñëe_rouã_ùv6
 (&
r6
, 
â
, 0, 
es
);

618 
	}
}

624 
	$do_ifc⁄fig
 (
tu¡≠
 *
â
,

625 c⁄° *
a˘uÆ
,

626 
tun_mtu
,

627 c⁄° 
ív_£t
 *
es
)

629 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

631 i‡(
â
->
did_ifc⁄fig_£tup
)

633 
boﬁ
 
tun
 = 
Ál£
;

634 c⁄° *
ifc⁄fig_loˇl
 = 
NULL
;

635 c⁄° *
ifc⁄fig_ªmŸe_√tmask
 = 
NULL
;

636 c⁄° *
ifc⁄fig_brﬂdˇ°
 = 
NULL
;

637 c⁄° *
ifc⁄fig_ùv6_loˇl
 = 
NULL
;

638 c⁄° *
ifc⁄fig_ùv6_ªmŸe
 = 
NULL
;

639 
boﬁ
 
do_ùv6
 = 
Ál£
;

640 
¨gv
árgv;

642 
	`¨gv_öô
 (&
¨gv
);

644 
	`msg
–
M_INFO
, "do_ifconfig,Åt->ipv6=%d,Åt->did_ifconfig_ipv6_setup=%d",

645 
â
->
ùv6
,Åt->
did_ifc⁄fig_ùv6_£tup
 );

650 
tun
 = 
	`is_tun_p2p
 (
â
);

655 
ifc⁄fig_loˇl
 = 
	`¥öt_ö_addr_t
 (
â
->
loˇl
, 0, &
gc
);

656 
ifc⁄fig_ªmŸe_√tmask
 = 
	`¥öt_ö_addr_t
 (
â
->
ªmŸe_√tmask
, 0, &
gc
);

658 i‡–
â
->
ùv6
 &&Åt->
did_ifc⁄fig_ùv6_£tup
 )

660 
ifc⁄fig_ùv6_loˇl
 = 
	`¥öt_ö6_addr
 (
â
->
loˇl_ùv6
, 0, &
gc
);

661 
ifc⁄fig_ùv6_ªmŸe
 = 
	`¥öt_ö6_addr
 (
â
->
ªmŸe_ùv6
, 0, &
gc
);

662 
do_ùv6
 = 
åue
;

668 i‡(!
tun
)

669 
ifc⁄fig_brﬂdˇ°
 = 
	`¥öt_ö_addr_t
 (
â
->
brﬂdˇ°
, 0, &
gc
);

671 #ifde‡
ENABLE_MANAGEMENT


672 i‡(
m™agemít
)

674 
	`m™agemít_£t_°©e
 (
m™agemít
,

675 
OPENVPN_STATE_ASSIGN_IP
,

676 
NULL
,

677 
â
->
loˇl
,

683 #i‡
	`deföed
(
TARGET_LINUX
)

684 #ifde‡
ENABLE_IPROUTE


688 
	`¨gv_¥ötf
 (&
¨gv
,

690 
ùrouã_∑th
,

691 
a˘uÆ
,

692 
tun_mtu


694 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

695 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "Linux ipÜink set failed");

697 i‡(
tun
) {

702 
	`¨gv_¥ötf
 (&
¨gv
,

704 
ùrouã_∑th
,

705 
a˘uÆ
,

706 
ifc⁄fig_loˇl
,

707 
ifc⁄fig_ªmŸe_√tmask


709 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

710 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "Linux ipáddrádd failed");

712 
	`¨gv_¥ötf
 (&
¨gv
,

714 
ùrouã_∑th
,

715 
a˘uÆ
,

716 
ifc⁄fig_loˇl
,

717 
	`cou¡_√tmask_bôs
(
ifc⁄fig_ªmŸe_√tmask
),

718 
ifc⁄fig_brﬂdˇ°


720 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

721 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "Linux ipáddrádd failed");

723 i‡–
do_ùv6
 )

725 
	`¨gv_¥ötf
–&
¨gv
,

727 
ùrouã_∑th
,

728 
ifc⁄fig_ùv6_loˇl
,

729 
â
->
√tbôs_ùv6
,

730 
a˘uÆ


732 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

733 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "Linux ip -6áddrádd failed");

735 
â
->
did_ifc⁄fig
 = 
åue
;

737 i‡(
tun
)

738 
	`¨gv_¥ötf
 (&
¨gv
,

740 
IFCONFIG_PATH
,

741 
a˘uÆ
,

742 
ifc⁄fig_loˇl
,

743 
ifc⁄fig_ªmŸe_√tmask
,

744 
tun_mtu


747 
	`¨gv_¥ötf
 (&
¨gv
,

749 
IFCONFIG_PATH
,

750 
a˘uÆ
,

751 
ifc⁄fig_loˇl
,

752 
ifc⁄fig_ªmŸe_√tmask
,

753 
tun_mtu
,

754 
ifc⁄fig_brﬂdˇ°


756 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

757 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "Linux ifconfig failed");

758 i‡–
do_ùv6
 )

760 
	`¨gv_¥ötf
 (&
¨gv
,

762 
IFCONFIG_PATH
,

763 
a˘uÆ
,

764 
ifc⁄fig_ùv6_loˇl
,

765 
â
->
√tbôs_ùv6


767 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

768 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "Linux ifconfig inet6 failed");

770 
â
->
did_ifc⁄fig
 = 
åue
;

773 #ñi‡
	`deföed
(
TARGET_SOLARIS
)

780 i‡(
tun
)

782 
	`¨gv_¥ötf
 (&
¨gv
,

784 
IFCONFIG_PATH
,

785 
a˘uÆ
,

786 
ifc⁄fig_loˇl
,

787 
ifc⁄fig_ªmŸe_√tmask
,

788 
tun_mtu


791 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

792 i‡(!
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "Solaris ifconfigÖhase-1 failed"))

793 
	`sﬁ¨is_îr‹_˛o£
 (
â
, 
es
, 
a˘uÆ
, 
Ál£
);

795 
	`¨gv_¥ötf
 (&
¨gv
,

797 
IFCONFIG_PATH
,

798 
a˘uÆ


802 i‡(
â
->
t›ﬁogy
 =
TOP_SUBNET
)

804 
	`¨gv_¥ötf
 (&
¨gv
,

806 
IFCONFIG_PATH
,

807 
a˘uÆ
,

808 
ifc⁄fig_loˇl
,

809 
ifc⁄fig_loˇl
,

810 
ifc⁄fig_ªmŸe_√tmask
,

811 
tun_mtu


815 
	`¨gv_¥ötf
 (&
¨gv
,

817 
IFCONFIG_PATH
,

818 
a˘uÆ
,

819 
ifc⁄fig_loˇl
,

820 
ifc⁄fig_ªmŸe_√tmask


823 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

824 i‡(!
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "Solaris ifconfigÖhase-2 failed"))

825 
	`sﬁ¨is_îr‹_˛o£
 (
â
, 
es
, 
a˘uÆ
, 
Ál£
);

827 i‡–
do_ùv6
 )

829 
	`¨gv_¥ötf
 (&
¨gv
, "%s %s inet6 unplumb",

830 
IFCONFIG_PATH
, 
a˘uÆ
 );

831 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

832 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, 
NULL
);

834 i‡–
â
->
ty≥
 =
DEV_TYPE_TUN
 )

836 
	`¨gv_¥ötf
 (&
¨gv
,

838 
IFCONFIG_PATH
,

839 
a˘uÆ
,

840 
ifc⁄fig_ùv6_loˇl
,

841 
â
->
√tbôs_ùv6
,

842 
ifc⁄fig_ùv6_ªmŸe


849 
	`¨gv_¥ötf
 (&
¨gv
, "%s %s inet6Ölumb up",

850 
IFCONFIG_PATH
, 
a˘uÆ
 );

851 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

852 i‡(!
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "Solaris ifconfig IPv6 (prepare) failed"))

853 
	`sﬁ¨is_îr‹_˛o£
 (
â
, 
es
, 
a˘uÆ
, 
åue
);

863 
	`¨gv_¥ötf
 (&
¨gv
,

865 
IFCONFIG_PATH
, 
a˘uÆ
,

866 
ifc⁄fig_ùv6_loˇl
, 
â
->
√tbôs_ùv6
 );

868 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

869 i‡(!
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "Solaris ifconfig IPv6 failed"))

870 
	`sﬁ¨is_îr‹_˛o£
 (
â
, 
es
, 
a˘uÆ
, 
åue
);

873 i‡(!
tun
 && 
â
->
t›ﬁogy
 =
TOP_SUBNET
)

876 
rouã_ùv4
 
r
;

877 
	`CLEAR
 (
r
);

878 
r
.
Êags
 = 
RT_DEFINED
 | 
RT_METRIC_DEFINED
;

879 
r
.
√tw‹k
 = 
â
->
loˇl
 &Åt->
ªmŸe_√tmask
;

880 
r
.
√tmask
 = 
â
->
ªmŸe_√tmask
;

881 
r
.
g©eway
 = 
â
->
loˇl
;

882 
r
.
mëric
 = 0;

883 
	`add_rouã
 (&
r
, 
â
, 0, 
NULL
, 
es
);

886 
â
->
did_ifc⁄fig
 = 
åue
;

888 #ñi‡
	`deföed
(
TARGET_OPENBSD
)

897 i‡(
tun
)

898 
	`¨gv_¥ötf
 (&
¨gv
,

900 
IFCONFIG_PATH
,

901 
a˘uÆ
,

902 
ifc⁄fig_loˇl
,

903 
ifc⁄fig_ªmŸe_√tmask
,

904 
tun_mtu


907 i‡–
â
->
t›ﬁogy
 =
TOP_SUBNET
 )

909 
	`¨gv_¥ötf
 (&
¨gv
,

911 
IFCONFIG_PATH
,

912 
a˘uÆ
,

913 
ifc⁄fig_loˇl
,

914 
ifc⁄fig_loˇl
,

915 
tun_mtu
,

916 
ifc⁄fig_ªmŸe_√tmask


920 
	`¨gv_¥ötf
 (&
¨gv
,

922 
IFCONFIG_PATH
,

923 
a˘uÆ
,

924 
ifc⁄fig_loˇl
,

925 
ifc⁄fig_ªmŸe_√tmask
,

926 
tun_mtu
,

927 
ifc⁄fig_brﬂdˇ°


929 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

930 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "OpenBSD ifconfig failed");

931 i‡–
do_ùv6
 )

933 
	`¨gv_¥ötf
 (&
¨gv
,

935 
IFCONFIG_PATH
,

936 
a˘uÆ
,

937 
ifc⁄fig_ùv6_loˇl
,

938 
â
->
√tbôs_ùv6


940 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

941 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "OpenBSD ifconfig inet6 failed");

944 
	`add_rouã_c⁄√˘ed_v6_√t
(
â
, 
es
);

946 
â
->
did_ifc⁄fig
 = 
åue
;

948 #ñi‡
	`deföed
(
TARGET_NETBSD
)

953 #ifde‡
TUNSIFHEAD


954 
	#NETBSD_MULTI_AF


	)

957 i‡(
tun
)

958 
	`¨gv_¥ötf
 (&
¨gv
,

960 
IFCONFIG_PATH
,

961 
a˘uÆ
,

962 
ifc⁄fig_loˇl
,

963 
ifc⁄fig_ªmŸe_√tmask
,

964 
tun_mtu


967 i‡–
â
->
t›ﬁogy
 =
TOP_SUBNET
 )

969 
	`¨gv_¥ötf
 (&
¨gv
,

971 
IFCONFIG_PATH
,

972 
a˘uÆ
,

973 
ifc⁄fig_loˇl
,

974 
ifc⁄fig_loˇl
,

975 
tun_mtu
,

976 
ifc⁄fig_ªmŸe_√tmask


985 
	`¨gv_¥ötf
 (&
¨gv
,

987 
IFCONFIG_PATH
,

988 
a˘uÆ
,

989 
ifc⁄fig_loˇl
,

990 
ifc⁄fig_ªmŸe_√tmask
,

991 
tun_mtu
,

992 
ifc⁄fig_brﬂdˇ°


994 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

995 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "NetBSD ifconfig failed");

997 i‡–
do_ùv6
 )

999 #ifde‡
NETBSD_MULTI_AF


1000 
	`¨gv_¥ötf
 (&
¨gv
,

1002 
IFCONFIG_PATH
,

1003 
a˘uÆ
,

1004 
ifc⁄fig_ùv6_loˇl
,

1005 
â
->
√tbôs_ùv6


1007 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

1008 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "NetBSD ifconfig inet6 failed");

1011 
	`add_rouã_c⁄√˘ed_v6_√t
(
â
, 
es
);

1013 
	`msg
–
M_INFO
, "no IPv6 support forÅun interfaces on NetBSD before 4.0 (if your system isÇewer,Ñecompile openvpn)" );

1014 
â
->
ùv6
 = 
Ál£
;

1017 
â
->
did_ifc⁄fig
 = 
åue
;

1019 #ñi‡
	`deföed
(
TARGET_DARWIN
)

1024 
	`¨gv_¥ötf
 (&
¨gv
,

1026 
IFCONFIG_PATH
,

1027 
a˘uÆ
);

1028 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

1029 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, 
NULL
);

1030 
	`msg
 (
M_INFO
, "NOTE: TriedÅo deleteÖre-existingÅun/tap instance -- No Problem if failure");

1034 i‡(
tun
)

1035 
	`¨gv_¥ötf
 (&
¨gv
,

1037 
IFCONFIG_PATH
,

1038 
a˘uÆ
,

1039 
ifc⁄fig_loˇl
,

1040 
ifc⁄fig_ªmŸe_√tmask
,

1041 
tun_mtu


1045 i‡(
â
->
t›ﬁogy
 =
TOP_SUBNET
)

1046 
	`¨gv_¥ötf
 (&
¨gv
,

1048 
IFCONFIG_PATH
,

1049 
a˘uÆ
,

1050 
ifc⁄fig_loˇl
,

1051 
ifc⁄fig_loˇl
,

1052 
ifc⁄fig_ªmŸe_√tmask
,

1053 
tun_mtu


1056 
	`¨gv_¥ötf
 (&
¨gv
,

1058 
IFCONFIG_PATH
,

1059 
a˘uÆ
,

1060 
ifc⁄fig_loˇl
,

1061 
ifc⁄fig_ªmŸe_√tmask
,

1062 
tun_mtu


1066 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

1067 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "Mac OS X ifconfig failed");

1068 
â
->
did_ifc⁄fig
 = 
åue
;

1071 i‡(!
tun
 && 
â
->
t›ﬁogy
 =
TOP_SUBNET
)

1073 
rouã_ùv4
 
r
;

1074 
	`CLEAR
 (
r
);

1075 
r
.
Êags
 = 
RT_DEFINED
;

1076 
r
.
√tw‹k
 = 
â
->
loˇl
 &Åt->
ªmŸe_√tmask
;

1077 
r
.
√tmask
 = 
â
->
ªmŸe_√tmask
;

1078 
r
.
g©eway
 = 
â
->
loˇl
;

1079 
	`add_rouã
 (&
r
, 
â
, 0, 
NULL
, 
es
);

1082 i‡–
do_ùv6
 )

1084 
	`¨gv_¥ötf
 (&
¨gv
,

1086 
IFCONFIG_PATH
,

1087 
a˘uÆ
,

1088 
ifc⁄fig_ùv6_loˇl
,

1089 
â
->
√tbôs_ùv6


1091 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

1092 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "MacOS X ifconfig inet6 failed");

1095 
	`add_rouã_c⁄√˘ed_v6_√t
(
â
, 
es
);

1098 #ñi‡
	`deföed
(
TARGET_FREEBSD
)||deföed(
TARGET_DRAGONFLY
)

1101 i‡(
tun
)

1102 
	`¨gv_¥ötf
 (&
¨gv
,

1104 
IFCONFIG_PATH
,

1105 
a˘uÆ
,

1106 
ifc⁄fig_loˇl
,

1107 
ifc⁄fig_ªmŸe_√tmask
,

1108 
tun_mtu


1110 i‡–
â
->
t›ﬁogy
 =
TOP_SUBNET
 )

1112 
	`¨gv_¥ötf
 (&
¨gv
,

1114 
IFCONFIG_PATH
,

1115 
a˘uÆ
,

1116 
ifc⁄fig_loˇl
,

1117 
ifc⁄fig_loˇl
,

1118 
tun_mtu
,

1119 
ifc⁄fig_ªmŸe_√tmask


1123 
	`¨gv_¥ötf
 (&
¨gv
,

1125 
IFCONFIG_PATH
,

1126 
a˘uÆ
,

1127 
ifc⁄fig_loˇl
,

1128 
ifc⁄fig_ªmŸe_√tmask
,

1129 
tun_mtu


1132 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

1133 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "FreeBSD ifconfig failed");

1134 
â
->
did_ifc⁄fig
 = 
åue
;

1137 i‡(!
tun
 && 
â
->
t›ﬁogy
 =
TOP_SUBNET
)

1139 
rouã_ùv4
 
r
;

1140 
	`CLEAR
 (
r
);

1141 
r
.
Êags
 = 
RT_DEFINED
;

1142 
r
.
√tw‹k
 = 
â
->
loˇl
 &Åt->
ªmŸe_√tmask
;

1143 
r
.
√tmask
 = 
â
->
ªmŸe_√tmask
;

1144 
r
.
g©eway
 = 
â
->
loˇl
;

1145 
	`add_rouã
 (&
r
, 
â
, 0, 
NULL
, 
es
);

1148 i‡–
do_ùv6
 )

1150 
	`¨gv_¥ötf
 (&
¨gv
,

1152 
IFCONFIG_PATH
,

1153 
a˘uÆ
,

1154 
ifc⁄fig_ùv6_loˇl
,

1155 
â
->
√tbôs_ùv6


1157 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

1158 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 
S_FATAL
, "FreeBSD ifconfig inet6 failed");

1161 #ñi‡
	`deföed
 (
WIN32
)

1167 i‡(
tun
)

1169 
	`vîify_255_255_255_252
 (
â
->
loˇl
,Åt->
ªmŸe_√tmask
);

1170 
â
->
ad≠ãr_√tmask
 = ~3;

1174 
â
->
ad≠ãr_√tmask
 =Åt->
ªmŸe_√tmask
;

1177 
â
->
›ti⁄s
.
ù_wö32_ty≥
)

1179 
IPW32_SET_MANUAL
:

1180 
	`msg
 (
M_INFO
, "******** NOTE: Please manually setÅhe IP/netmask of '%s'Åo %s/%s (if it isÇotálready set)",

1181 
a˘uÆ
,

1182 
ifc⁄fig_loˇl
,

1183 
	`¥öt_ö_addr_t
 (
â
->
ad≠ãr_√tmask
, 0, &
gc
));

1185 
IPW32_SET_NETSH
:

1186 i‡(!
	`°rcmp
 (
a˘uÆ
, "NULL"))

1187 
	`msg
 (
M_FATAL
, "Error: When using --ip-win32Çetsh, if you have moreÅhan one TAP-Windowsádapter, you mustálso specify --dev-node");

1189 
	`√tsh_ifc⁄fig
 (&
â
->
›ti⁄s
,

1190 
a˘uÆ
,

1191 
â
->
loˇl
,

1192 
â
->
ad≠ãr_√tmask
,

1193 
NI_IP_NETMASK
|
NI_OPTIONS
);

1197 
â
->
did_ifc⁄fig
 = 
åue
;

1201 i‡–
do_ùv6
 )

1203 * 
ßved_a˘uÆ
;

1205 i‡(!
	`°rcmp
 (
a˘uÆ
, "NULL"))

1206 
	`msg
 (
M_FATAL
, "Error: When using --tun-ipv6, if you have moreÅhan one TAP-Windowsádapter, you mustálso specify --dev-node");

1209 
	`¨gv_¥ötf
 (&
¨gv
,

1211 
	`gë_wö_sys_∑th
(),

1212 
NETSH_PATH_SUFFIX
,

1213 
a˘uÆ
,

1214 
ifc⁄fig_ùv6_loˇl
 );

1216 
	`√tsh_comm™d
 (&
¨gv
, 4);

1223 
ßved_a˘uÆ
 = 
â
->
a˘uÆ_«me
;

1224 
â
->
a˘uÆ_«me
 = (*Ë
a˘uÆ
;

1225 
	`add_rouã_c⁄√˘ed_v6_√t
(
â
, 
es
);

1226 
â
->
a˘uÆ_«me
 = 
ßved_a˘uÆ
;

1229 
	`msg
 (
M_FATAL
, "Sorry, but I don't know howÅo do 'ifconfig' commands onÅhis operating system. You should ifconfig your TUN/TAP device manually or useán --up script.");

1231 
	`¨gv_ª£t
 (&
¨gv
);

1233 
	`gc_‰ì
 (&
gc
);

1234 
	}
}

1237 
	$˛ór_tu¡≠
 (
tu¡≠
 *tuntap)

1239 
	`CLEAR
 (*
tu¡≠
);

1240 #ifde‡
WIN32


1241 
tu¡≠
->
h™d
 = 
NULL
;

1243 
tu¡≠
->
fd
 = -1;

1245 #ifde‡
TARGET_SOLARIS


1246 
tu¡≠
->
ù_fd
 = -1;

1248 
tu¡≠
->
ùv6
 = 
Ál£
;

1249 
	}
}

1252 
	$›í_nuŒ
 (
tu¡≠
 *
â
)

1254 
â
->
a˘uÆ_«me
 = 
	`°rög_Æloc
 ("nuŒ", 
NULL
);

1255 
	}
}

1258 #i‡
deföed
 (
TARGET_OPENBSD
Ë|| (deföed(
TARGET_DARWIN
Ë&& 
HAVE_NET_IF_UTUN_H
)

1278 
	~<√töë/ù.h
>

1279 
	~<sys/uio.h
>

1281 
ölöe
 

1282 
	$hódî_modify_ªad_wrôe_ªtu∫
 (
Àn
)

1284 i‡(
Àn
 > 0)

1285  
Àn
 >  (
u_öt32_t
) ?Üen -  (u_int32_t) : 0;

1287  
Àn
;

1288 
	}
}

1291 
	$wrôe_tun_hódî
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

1293 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

1295 
u_öt32_t
 
ty≥
;

1296 
iovec
 
iv
[2];

1297 
ù
 *
ùh
;

1299 
ùh
 = (
ù
 *Ë
buf
;

1301 i‡(
â
->
ùv6
 && 
ùh
->
ù_v
 == 6)

1302 
ty≥
 = 
	`ht⁄l
 (
AF_INET6
);

1304 
ty≥
 = 
	`ht⁄l
 (
AF_INET
);

1306 
iv
[0].
iov_ba£
 = &
ty≥
;

1307 
iv
[0].
iov_Àn
 =  (
ty≥
);

1308 
iv
[1].
iov_ba£
 = 
buf
;

1309 
iv
[1].
iov_Àn
 = 
Àn
;

1311  
	`hódî_modify_ªad_wrôe_ªtu∫
 (
	`wrôev
 (
â
->
fd
, 
iv
, 2));

1314  
	`wrôe
 (
â
->
fd
, 
buf
, 
Àn
);

1315 
	}
}

1318 
	$ªad_tun_hódî
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

1320 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

1322 
u_öt32_t
 
ty≥
;

1323 
iovec
 
iv
[2];

1325 
iv
[0].
iov_ba£
 = &
ty≥
;

1326 
iv
[0].
iov_Àn
 =  (
ty≥
);

1327 
iv
[1].
iov_ba£
 = 
buf
;

1328 
iv
[1].
iov_Àn
 = 
Àn
;

1330  
	`hódî_modify_ªad_wrôe_ªtu∫
 (
	`ªadv
 (
â
->
fd
, 
iv
, 2));

1333  
	`ªad
 (
â
->
fd
, 
buf
, 
Àn
);

1334 
	}
}

1338 #i‚de‡
WIN32


1340 
	$›í_tun_gíîic
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
,

1341 
boﬁ
 
ùv6_ex∂icôly_suµ‹ãd
, boﬁ 
dy«mic
,

1342 
tu¡≠
 *
â
)

1344 
tu¬ame
[256];

1345 
dy«mic_«me
[256];

1346 
boﬁ
 
dy«mic_›íed
 = 
Ál£
;

1349 i‡–
â
->
ùv6
 && ! 
ùv6_ex∂icôly_suµ‹ãd
 )

1350 
	`msg
 (
M_WARN
, "NOTE:Éxplicit support for IPv6Åun devices isÇotÖrovided forÅhis OS");

1352 i‡(
â
->
ty≥
 =
DEV_TYPE_NULL
)

1354 
	`›í_nuŒ
 (
â
);

1361 i‡(
dev_node
)

1363 
	`›ív≤_¢¥ötf
 (
tu¬ame
,  (tu¬ame), "%s", 
dev_node
);

1372 #ifde‡
TARGET_NETBSD


1377 i‡–
dy«mic
 && 
	`°rcmp
–
dev
, "tap" ) == 0 )

1379 
i‰eq
 
i‰
;

1380 i‡((
â
->
fd
 = 
	`›í
 ( "/dev/èp", 
O_RDWR
)) < 0)

1382 
	`msg
 (
M_FATAL
, "Cannotállocate NetBSD TAP dev dynamically");

1384 i‡–
	`io˘l
–
â
->
fd
, 
TAPGIFNAME
, (*)&
i‰
 ) < 0 )

1386 
	`msg
 (
M_FATAL
, "Cannot query NetBSD TAP deviceÇame");

1388 
	`CLEAR
(
dy«mic_«me
);

1389 
	`°∫˝y
–
dy«mic_«me
, 
i‰
.
i‰_«me
, (dynamic_name)-1 );

1390 
dy«mic_›íed
 = 
åue
;

1391 
	`›ív≤_¢¥ötf
 (
tu¬ame
,  (tu¬ame), "/dev/%s", 
dy«mic_«me
 );

1396 i‡(
dy«mic
 && !
	`has_digô
((*)
dev
))

1398 
i
;

1399 
i
 = 0; i < 256; ++i)

1401 
	`›ív≤_¢¥ötf
 (
tu¬ame
,  (tunname),

1402 "/dev/%s%d", 
dev
, 
i
);

1403 
	`›ív≤_¢¥ötf
 (
dy«mic_«me
,  (dynamic_name),

1404 "%s%d", 
dev
, 
i
);

1405 i‡((
â
->
fd
 = 
	`›í
 (
tu¬ame
, 
O_RDWR
)) > 0)

1407 
dy«mic_›íed
 = 
åue
;

1410 
	`msg
 (
D_READ_WRITE
 | 
M_ERRNO
, "Trõd o≥nög %†(Áûed)", 
tu¬ame
);

1412 i‡(!
dy«mic_›íed
)

1413 
	`msg
 (
M_FATAL
, "Cannotállocate TUN/TAP dev dynamically");

1420 
	`›ív≤_¢¥ötf
 (
tu¬ame
,  (tu¬ame), "/dev/%s", 
dev
);

1424 i‡(!
dy«mic_›íed
)

1427 i‡–
	`if_«mëoödex
–
dev
 ) > 0 )

1429 
	`msg
 (
M_INFO
, "TUN/TAP devi˚ %†exi°†¥eviou¶y, kì∞©ÖrogømÉnd", 
dev
 );

1430 
â
->
≥rsi°ít_if
 = 
åue
;

1433 i‡((
â
->
fd
 = 
	`›í
 (
tu¬ame
, 
O_RDWR
)) < 0)

1434 
	`msg
 (
M_ERR
, "C™nŸ o≥¿TUN/TAP dev %s", 
tu¬ame
);

1437 
	`£t_n⁄block
 (
â
->
fd
);

1438 
	`£t_˛€xec
 (
â
->
fd
);

1439 
	`msg
 (
M_INFO
, "TUN/TAP devi˚ %†›íed", 
tu¬ame
);

1442 
â
->
a˘uÆ_«me
 = 
	`°rög_Æloc
 (
dy«mic_›íed
 ? 
dy«mic_«me
 : 
dev
, 
NULL
);

1444 
	}
}

1447 
	$˛o£_tun_gíîic
 (
tu¡≠
 *
â
)

1449 i‡(
â
->
fd
 >= 0)

1450 
	`˛o£
 (
â
->
fd
);

1451 i‡(
â
->
a˘uÆ_«me
)

1452 
	`‰ì
 (
â
->
a˘uÆ_«me
);

1453 
	`˛ór_tu¡≠
 (
â
);

1454 
	}
}

1458 #i‡
deföed
(
TARGET_LINUX
)

1460 #ifde‡
HAVE_LINUX_IF_TUN_H


1462 #i‚de‡
HAVE_LINUX_SOCKIOS_H


1463 #îr‹ 
hódî
 
fûe
 
löux
/
sockios
.
h
 
ªquúed


1466 #i‡!
PEDANTIC


1469 
	$›í_tun
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
, 
tu¡≠
 *
â
)

1471 
i‰eq
 
i‰
;

1476 i‡(
â
->
ty≥
 =
DEV_TYPE_NULL
)

1478 
	`›í_nuŒ
 (
â
);

1485 c⁄° *
node
 = 
dev_node
;

1486 i‡(!
node
)

1487 
node
 = "/dev/net/tun";

1492 i‡((
â
->
fd
 = 
	`›í
 (
node
, 
O_RDWR
)) < 0)

1494 
	`msg
 (
M_ERR
, "ERROR: C™nŸ o≥¿TUN/TAP dev %s", 
node
);

1500 
	`CLEAR
 (
i‰
);

1501 i‡(!
â
->
ùv6
)

1502 
i‰
.
i‰_Êags
 = 
IFF_NO_PI
;

1504 #i‡
	`deföed
(
IFF_ONE_QUEUE
Ë&& deföed(
SIOCSIFTXQLEN
)

1505 
i‰
.
i‰_Êags
 |
IFF_ONE_QUEUE
;

1511 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

1513 
i‰
.
i‰_Êags
 |
IFF_TUN
;

1515 i‡(
â
->
ty≥
 =
DEV_TYPE_TAP
)

1517 
i‰
.
i‰_Êags
 |
IFF_TAP
;

1521 
	`msg
 (
M_FATAL
, "I don'tÑecognize device %sásáÅun orÅap device",

1522 
dev
);

1528 i‡(
	`°rcmp
(
dev
, "tun") && strcmp(dev, "tap"))

1529 
	`°∫˝y¡
 (
i‰
.
i‰_«me
, 
dev
, 
IFNAMSIZ
);

1535 i‡(
	`io˘l
 (
â
->
fd
, 
TUNSETIFF
, (*Ë&
i‰
) < 0)

1537 
	`msg
 (
M_ERR
, "ERROR: C™nŸ io˘»TUNSETIFF %s", 
dev
);

1540 
	`msg
 (
M_INFO
, "TUN/TAP devi˚ %†›íed", 
i‰
.
i‰_«me
);

1545 #i‡
	`deföed
(
IFF_ONE_QUEUE
Ë&& deföed(
SIOCSIFTXQLEN
)

1546 i‡(
â
->
›ti⁄s
.
txqueuñí
) {

1547 
i‰eq
 
√ti‰
;

1548 
˘l_fd
;

1550 i‡((
˘l_fd
 = 
	`sockë
 (
AF_INET
, 
SOCK_DGRAM
, 0)) >= 0)

1552 
	`CLEAR
 (
√ti‰
);

1553 
	`°∫˝y¡
 (
√ti‰
.
i‰_«me
, 
i‰
.i‰_«me, 
IFNAMSIZ
);

1554 
√ti‰
.
i‰_qÀn
 = 
â
->
›ti⁄s
.
txqueuñí
;

1555 i‡(
	`io˘l
 (
˘l_fd
, 
SIOCSIFTXQLEN
, (*Ë&
√ti‰
) >= 0)

1556 
	`msg
 (
D_OSBUF
, "TUN/TAP TX queuêÀngth sëÅÿ%d", 
â
->
›ti⁄s
.
txqueuñí
);

1558 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "NŸe: C™nŸ sëÅx queuêÀngth o¿%s", 
i‰
.
i‰_«me
);

1559 
	`˛o£
 (
˘l_fd
);

1563 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "NŸe: C™nŸ o≥¿c⁄åﬁ sockë o¿%s", 
i‰
.
i‰_«me
);

1568 
	`£t_n⁄block
 (
â
->
fd
);

1569 
	`£t_˛€xec
 (
â
->
fd
);

1570 
â
->
a˘uÆ_«me
 = 
	`°rög_Æloc
 (
i‰
.
i‰_«me
, 
NULL
);

1573 
	}
}

1578 
	$›í_tun
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
, 
tu¡≠
 *
â
)

1580 
	`ASSERT
 (0);

1581 
	}
}

1588 
	$›í_tun
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
, 
tu¡≠
 *
â
)

1590 
	`›í_tun_gíîic
 (
dev
, 
dev_ty≥
, 
dev_node
, 
Ál£
, 
åue
, 
â
);

1591 
	}
}

1595 #ifde‡
ENABLE_FEATURE_TUN_PERSIST


1602 #i‚de‡
TUNSETOWNER


1603 
	#TUNSETOWNER
 
	`_IOW
('T', 204, )

	)

1605 #i‚de‡
TUNSETGROUP


1606 
	#TUNSETGROUP
 
	`_IOW
('T', 206, )

	)

1610 
	$tuncfg
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
, 
≥rsi°_mode
, c⁄° *
u£∫ame
, c⁄° *
grou≤ame
, c⁄° 
tu¡≠_›ti⁄s
 *
›ti⁄s
)

1612 
tu¡≠
 *
â
;

1614 
	`ALLOC_OBJ
 (
â
, 
tu¡≠
);

1615 
	`˛ór_tu¡≠
 (
â
);

1616 
â
->
ty≥
 = 
	`dev_ty≥_íum
 (
dev
, 
dev_ty≥
);

1617 
â
->
›ti⁄s
 = *options;

1618 
	`›í_tun
 (
dev
, 
dev_ty≥
, 
dev_node
, 
â
);

1619 i‡(
	`io˘l
 (
â
->
fd
, 
TUNSETPERSIST
, 
≥rsi°_mode
) < 0)

1620 
	`msg
 (
M_ERR
, "C™nŸ io˘»TUNSETPERSIST(%dË%s", 
≥rsi°_mode
, 
dev
);

1621 i‡(
u£∫ame
 !
NULL
)

1623 
∂©f‹m_°©e_u£r
Ölatform_state_user;

1625 i‡(!
	`∂©f‹m_u£r_gë
 (
u£∫ame
, &
∂©f‹m_°©e_u£r
))

1626 
	`msg
 (
M_ERR
, "C™nŸ gë u£∏íåy f‹ %s", 
u£∫ame
);

1628 i‡(
	`io˘l
 (
â
->
fd
, 
TUNSETOWNER
, 
∂©f‹m_°©e_u£r
.
pw
->
pw_uid
) < 0)

1629 
	`msg
 (
M_ERR
, "C™nŸ io˘»TUNSETOWNER(%sË%s", 
u£∫ame
, 
dev
);

1631 i‡(
grou≤ame
 !
NULL
)

1633 
∂©f‹m_°©e_group
Ölatform_state_group;

1635 i‡(!
	`∂©f‹m_group_gë
 (
grou≤ame
, &
∂©f‹m_°©e_group
))

1636 
	`msg
 (
M_ERR
, "C™nŸ gë grou∞íåy f‹ %s", 
grou≤ame
);

1638 i‡(
	`io˘l
 (
â
->
fd
, 
TUNSETGROUP
, 
∂©f‹m_°©e_group
.
gr
->
gr_gid
) < 0)

1639 
	`msg
 (
M_ERR
, "C™nŸ io˘»TUNSETOWNER(%sË%s", 
grou≤ame
, 
dev
);

1641 
	`˛o£_tun
 (
â
);

1642 
	`msg
 (
M_INFO
, "Pîsi° sèã sëÅo: %s", (
≥rsi°_mode
 ? "ON" : "OFF"));

1643 
	}
}

1648 
	$˛o£_tun
 (
tu¡≠
 *
â
)

1650 i‡(
â
)

1652 i‡(
â
->
ty≥
 !
DEV_TYPE_NULL
 &&Åt->
did_ifc⁄fig
)

1654 
¨gv
árgv;

1655 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

1656 
	`¨gv_öô
 (&
¨gv
);

1658 #ifde‡
ENABLE_IPROUTE


1659 i‡(
	`is_tun_p2p
 (
â
))

1661 
	`¨gv_¥ötf
 (&
¨gv
,

1663 
ùrouã_∑th
,

1664 
â
->
a˘uÆ_«me
,

1665 
	`¥öt_ö_addr_t
 (
â
->
loˇl
, 0, &
gc
),

1666 
	`¥öt_ö_addr_t
 (
â
->
ªmŸe_√tmask
, 0, &
gc
)

1671 
	`¨gv_¥ötf
 (&
¨gv
,

1673 
ùrouã_∑th
,

1674 
â
->
a˘uÆ_«me
,

1675 
	`¥öt_ö_addr_t
 (
â
->
loˇl
, 0, &
gc
),

1676 
	`cou¡_√tmask_bôs
(
	`¥öt_ö_addr_t
 (
â
->
ªmŸe_√tmask
, 0, &
gc
))

1680 
	`¨gv_¥ötf
 (&
¨gv
,

1682 
IFCONFIG_PATH
,

1683 
â
->
a˘uÆ_«me


1687 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

1688 
	`›ív≤_execve_check
 (&
¨gv
, 
NULL
, 0, "Linux ipáddr del failed");

1690 
	`¨gv_ª£t
 (&
¨gv
);

1691 
	`gc_‰ì
 (&
gc
);

1693 
	`˛o£_tun_gíîic
 (
â
);

1694 
	`‰ì
 (
â
);

1696 
	}
}

1699 
	$wrôe_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

1701 i‡(
â
->
ùv6
)

1703 
tun_pi
 
pi
;

1704 
ùhdr
 *
ùh
;

1705 
iovec
 
ve˘
[2];

1706 
ªt
;

1708 
ùh
 = (
ùhdr
 *)
buf
;

1710 
pi
.
Êags
 = 0;

1712 if(
ùh
->
vîsi⁄
 == 6)

1713 
pi
.
¥Ÿo
 = 
	`ht⁄s
(
ETH_P_IPV6
);

1715 
pi
.
¥Ÿo
 = 
	`ht⁄s
(
ETH_P_IP
);

1717 
ve˘
[0].
iov_Àn
 = (
pi
);

1718 
ve˘
[0].
iov_ba£
 = &
pi
;

1719 
ve˘
[1].
iov_Àn
 = 
Àn
;

1720 
ve˘
[1].
iov_ba£
 = 
buf
;

1722 
ªt
 = 
	`wrôev
(
â
->
fd
, 
ve˘
, 2);

1723 (
ªt
 - (
pi
));

1726  
	`wrôe
 (
â
->
fd
, 
buf
, 
Àn
);

1727 
	}
}

1730 
	$ªad_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

1732 i‡(
â
->
ùv6
)

1734 
iovec
 
ve˘
[2];

1735 
tun_pi
 
pi
;

1736 
ªt
;

1738 
ve˘
[0].
iov_Àn
 = (
pi
);

1739 
ve˘
[0].
iov_ba£
 = &
pi
;

1740 
ve˘
[1].
iov_Àn
 = 
Àn
;

1741 
ve˘
[1].
iov_ba£
 = 
buf
;

1743 
ªt
 = 
	`ªadv
(
â
->
fd
, 
ve˘
, 2);

1744 (
ªt
 - (
pi
));

1747  
	`ªad
 (
â
->
fd
, 
buf
, 
Àn
);

1748 
	}
}

1750 #ñi‡
deföed
(
TARGET_SOLARIS
)

1752 #i‚de‡
TUNNEWPPA


1753 #îr‹ 
I
 
√ed
 
the
 
symbﬁ
 
TUNNEWPPA
 
‰om
 
√t
/
if_tun
.
h


1757 
	$›í_tun
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
, 
tu¡≠
 *
â
)

1759 
if_fd
, 
ù_muxid
, 
¨p_muxid
, 
¨p_fd
, 
µa
 = -1;

1760 
li‰eq
 
i‰
;

1761 c⁄° *
±r
;

1762 c⁄° *
ù_node
, *
¨p_node
;

1763 c⁄° *
dev_tu¡≠_ty≥
;

1764 
lök_ty≥
;

1765 
boﬁ
 
is_tun
;

1766 
°rio˘l
 
°rioc_if
, 
°rioc_µa
;

1772 
	`CLEAR
(
i‰
);

1774 i‡(
â
->
ty≥
 =
DEV_TYPE_NULL
)

1776 
	`›í_nuŒ
 (
â
);

1780 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

1782 
ù_node
 = "/dev/udp";

1783 i‡(!
dev_node
)

1784 
dev_node
 = "/dev/tun";

1785 
dev_tu¡≠_ty≥
 = "tun";

1786 
lök_ty≥
 = 
I_PLINK
;

1787 
is_tun
 = 
åue
;

1789 i‡(
â
->
ty≥
 =
DEV_TYPE_TAP
)

1791 
ù_node
 = "/dev/udp";

1792 i‡(!
dev_node
)

1793 
dev_node
 = "/dev/tap";

1794 
¨p_node
 = 
dev_node
;

1795 
dev_tu¡≠_ty≥
 = "tap";

1796 
lök_ty≥
 = 
I_PLINK
;

1797 
is_tun
 = 
Ál£
;

1801 
	`msg
 (
M_FATAL
, "I don'tÑecognize device %sásáÅun orÅap device",

1802 
dev
);

1805 i‡((
â
->
ù_fd
 = 
	`›í
 (
ù_node
, 
O_RDWR
, 0)) < 0)

1806 
	`msg
 (
M_ERR
, "C™'à›í %s", 
ù_node
);

1808 i‡((
â
->
fd
 = 
	`›í
 (
dev_node
, 
O_RDWR
, 0)) < 0)

1809 
	`msg
 (
M_ERR
, "C™'à›í %s", 
dev_node
);

1812 i‡(*
dev
)

1814 
±r
 = 
dev
;

1815 *
±r
 && !
	`isdigô
 (() *ptr))

1816 
±r
++;

1817 
µa
 = 
	`©oi
 (
±r
);

1821 
°rioc_µa
.
ic_cmd
 = 
TUNNEWPPA
;

1822 
°rioc_µa
.
ic_timout
 = 0;

1823 
°rioc_µa
.
ic_Àn
 = (
µa
);

1824 
°rioc_µa
.
ic_dp
 = (*)&
µa
;

1826 i‡–*
±r
 == '\0' )

1828 
boﬁ
 
found_⁄e
 = 
Ál£
;

1829  ! 
found_⁄e
 && 
µa
 < 64 )

1831 
√w_µa
 = 
	`io˘l
 (
â
->
fd
, 
I_STR
, &
°rioc_µa
);

1832 i‡–
√w_µa
 >= 0 )

1834 
	`msg
–
M_INFO
, "›í_tun: gŸ dy«mi¯öãrÁ˚ '%s%d'", 
dev_tu¡≠_ty≥
, 
√w_µa
 );

1835 
µa
 = 
√w_µa
;

1836 
found_⁄e
 = 
åue
;

1839 i‡–
î∫o
 !
EEXIST
 )

1840 
	`msg
 (
M_ERR
, "›í_tun: u√x≥˘edÉº‹ÅryögÅÿföd fªê%†öãrÁ˚", 
dev_tu¡≠_ty≥
 );

1841 
µa
++;

1843 i‡–!
found_⁄e
 )

1844 
	`msg
 (
M_ERR
, "›í_tun: couldÇŸ föd fªê%†öãrÁ˚, givêup.", 
dev_tu¡≠_ty≥
 );

1848 i‡((
µa
 = 
	`io˘l
 (
â
->
fd
, 
I_STR
, &
°rioc_µa
)) < 0)

1849 
	`msg
 (
M_ERR
, "C™'àassig¿PPA f‹Çew i¡îÁ˚ (%s%d)", 
dev_tu¡≠_ty≥
, 
µa
 );

1852 i‡((
if_fd
 = 
	`›í
 (
dev_node
, 
O_RDWR
, 0)) < 0)

1853 
	`msg
 (
M_ERR
, "C™'à›í %†(2)", 
dev_node
);

1855 i‡(
	`io˘l
 (
if_fd
, 
I_PUSH
, "ip") < 0)

1856 
	`msg
 (
M_ERR
, "Can'tÖush IP module");

1858 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

1861 i‡(
	`io˘l
 (
if_fd
, 
IF_UNITSEL
, (*Ë&
µa
) < 0)

1862 
	`msg
 (
M_ERR
, "C™'à£àPPA %d", 
µa
);

1865 
â
->
a˘uÆ_«me
 = (*Ë
	`mÆloc
 (32);

1866 
	`check_mÆloc_ªtu∫
 (
â
->
a˘uÆ_«me
);

1868 
	`›ív≤_¢¥ötf
 (
â
->
a˘uÆ_«me
, 32, "%s%d", 
dev_tu¡≠_ty≥
, 
µa
);

1870 i‡(
â
->
ty≥
 =
DEV_TYPE_TAP
)

1872 i‡(
	`io˘l
(
if_fd
, 
SIOCGLIFFLAGS
, &
i‰
) < 0)

1873 
	`msg
 (
M_ERR
, "Can't get flags\n");

1874 
	`°∫˝y¡
 (
i‰
.
li‰_«me
, 
â
->
a˘uÆ_«me
,  (ifr.lifr_name));

1875 
i‰
.
li‰_µa
 = 
µa
;

1877 i‡(
	`io˘l
 (
if_fd
, 
SIOCSLIFNAME
, &
i‰
) < 0)

1878 
	`msg
 (
M_ERR
, "C™'à£àPPA %d", 
µa
);

1879 i‡(
	`io˘l
(
if_fd
, 
SIOCGLIFFLAGS
, &
i‰
) <0)

1880 
	`msg
 (
M_ERR
, "Can't get flags\n");

1882 i‡(
	`io˘l
 (
if_fd
, 
I_PUSH
, "arp") < 0)

1883 
	`msg
 (
M_ERR
, "Can'tÖush ARP module");

1886 
åue
)

1888 i‡(
	`io˘l
 (
â
->
ù_fd
, 
I_POP
, 
NULL
) < 0)

1892 i‡(
	`io˘l
 (
â
->
ù_fd
, 
I_PUSH
, "arp") < 0)

1893 
	`msg
 (
M_ERR
, "Can'tÖush ARP module\n");

1896 i‡((
¨p_fd
 = 
	`›í
 (
¨p_node
, 
O_RDWR
, 0)) < 0)

1897 
	`msg
 (
M_ERR
, "C™'à›í %s\n", 
¨p_node
);

1899 i‡(
	`io˘l
 (
¨p_fd
, 
I_PUSH
, "arp") < 0)

1900 
	`msg
 (
M_ERR
, "Can'tÖush ARP module\n");

1903 
°rioc_if
.
ic_cmd
 = 
SIOCSLIFNAME
;

1904 
°rioc_if
.
ic_timout
 = 0;

1905 
°rioc_if
.
ic_Àn
 = (
i‰
);

1906 
°rioc_if
.
ic_dp
 = (*)&
i‰
;

1907 i‡(
	`io˘l
(
¨p_fd
, 
I_STR
, &
°rioc_if
) < 0){

1908 
	`msg
 (
M_ERR
, "Can't set ifnameÅoárp\n");

1912 i‡((
ù_muxid
 = 
	`io˘l
 (
â
->
ù_fd
, 
lök_ty≥
, 
if_fd
)) < 0)

1913 
	`msg
 (
M_ERR
, "C™'àlök %†devi˚ÅÿIP", 
dev_tu¡≠_ty≥
);

1915 i‡(
â
->
ty≥
 =
DEV_TYPE_TAP
) {

1916 i‡((
¨p_muxid
 = 
	`io˘l
 (
â
->
ù_fd
, 
lök_ty≥
, 
¨p_fd
)) < 0)

1917 
	`msg
 (
M_ERR
, "C™'àlök %†devi˚ÅÿARP", 
dev_tu¡≠_ty≥
);

1918 
	`˛o£
 (
¨p_fd
);

1921 
	`CLEAR
 (
i‰
);

1922 
	`°∫˝y¡
 (
i‰
.
li‰_«me
, 
â
->
a˘uÆ_«me
,  (ifr.lifr_name));

1923 
i‰
.
li‰_ù_muxid
 = 
ù_muxid
;

1924 i‡(
â
->
ty≥
 =
DEV_TYPE_TAP
) {

1925 
i‰
.
li‰_¨p_muxid
 = 
¨p_muxid
;

1928 i‡(
	`io˘l
 (
â
->
ù_fd
, 
SIOCSLIFMUXID
, &
i‰
) < 0)

1930 i‡(
â
->
ty≥
 =
DEV_TYPE_TAP
)

1932 
	`io˘l
 (
â
->
ù_fd
, 
I_PUNLINK
 , 
¨p_muxid
);

1934 
	`io˘l
 (
â
->
ù_fd
, 
I_PUNLINK
, 
ù_muxid
);

1935 
	`msg
 (
M_ERR
, "Can't set multiplexor id");

1938 
	`£t_n⁄block
 (
â
->
fd
);

1939 
	`£t_˛€xec
 (
â
->
fd
);

1940 
	`£t_˛€xec
 (
â
->
ù_fd
);

1942 
	`msg
 (
M_INFO
, "TUN/TAP devi˚ %†›íed", 
â
->
a˘uÆ_«me
);

1943 
	}
}

1946 
	$sﬁ¨is_˛o£_tun
 (
tu¡≠
 *
â
)

1948 i‡(
â
)

1951 i‡–
â
->
ùv6
 &&Åt->
did_ifc⁄fig_ùv6_£tup
 )

1953 
¨gv
árgv;

1954 
	`¨gv_öô
 (&
¨gv
);

1955 
	`¨gv_¥ötf
–&
¨gv
, "%s %s inet6 unplumb",

1956 
IFCONFIG_PATH
, 
â
->
a˘uÆ_«me
 );

1957 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

1958 
	`›ív≤_execve_check
 (&
¨gv
, 
NULL
, 0, "Solaris ifconfig inet6 unplumb failed");

1959 
	`¨gv_ª£t
 (&
¨gv
);

1962 i‡(
â
->
ù_fd
 >= 0)

1964 
li‰eq
 
i‰
;

1965 
	`CLEAR
 (
i‰
);

1966 
	`°∫˝y¡
 (
i‰
.
li‰_«me
, 
â
->
a˘uÆ_«me
,  (ifr.lifr_name));

1968 i‡(
	`io˘l
 (
â
->
ù_fd
, 
SIOCGLIFFLAGS
, &
i‰
) < 0)

1969 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Can't get iface flags");

1971 i‡(
	`io˘l
 (
â
->
ù_fd
, 
SIOCGLIFMUXID
, &
i‰
) < 0)

1972 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Can't get multiplexor id");

1974 i‡(
â
->
ty≥
 =
DEV_TYPE_TAP
)

1976 i‡(
	`io˘l
 (
â
->
ù_fd
, 
I_PUNLINK
, 
i‰
.
li‰_¨p_muxid
) < 0)

1977 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Can't unlink interface(arp)");

1980 i‡(
	`io˘l
 (
â
->
ù_fd
, 
I_PUNLINK
, 
i‰
.
li‰_ù_muxid
) < 0)

1981 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Can't unlink interface(ip)");

1983 
	`˛o£
 (
â
->
ù_fd
);

1984 
â
->
ù_fd
 = -1;

1987 i‡(
â
->
fd
 >= 0)

1989 
	`˛o£
 (
â
->
fd
);

1990 
â
->
fd
 = -1;

1993 
	}
}

1999 
	$˛o£_tun
 (
tu¡≠
 *
â
)

2001 i‡(
â
)

2003 
	`sﬁ¨is_˛o£_tun
 (
â
);

2005 i‡(
â
->
a˘uÆ_«me
)

2006 
	`‰ì
 (
â
->
a˘uÆ_«me
);

2008 
	`˛ór_tu¡≠
 (
â
);

2009 
	`‰ì
 (
â
);

2011 
	}
}

2014 
	$sﬁ¨is_îr‹_˛o£
 (
tu¡≠
 *
â
, c⁄° 
ív_£t
 *
es
,

2015 c⁄° *
a˘uÆ
, 
boﬁ
 
u≈lumb_öë6
 )

2017 
¨gv
árgv;

2018 
	`¨gv_öô
 (&
¨gv
);

2020 i‡(
u≈lumb_öë6
)

2022 
	`¨gv_¥ötf
–&
¨gv
, "%s %s inet6 unplumb",

2023 
IFCONFIG_PATH
, 
a˘uÆ
 );

2024 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

2025 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "Solaris ifconfig inet6 unplumb failed");

2028 
	`¨gv_¥ötf
 (&
¨gv
,

2030 
IFCONFIG_PATH
,

2031 
a˘uÆ
);

2033 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

2034 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, "Solaris ifconfig unplumb failed");

2035 
	`˛o£_tun
 (
â
);

2036 
	`msg
 (
M_FATAL
, "Solaris ifconfig failed");

2037 
	`¨gv_ª£t
 (&
¨gv
);

2038 
	}
}

2041 
	$wrôe_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

2043 
°rbuf
 
sbuf
;

2044 
sbuf
.
Àn
 =Üen;

2045 
sbuf
.
buf
 = (*)buf;

2046  
	`putmsg
 (
â
->
fd
, 
NULL
, &
sbuf
, 0Ë>0 ? sbuf.
Àn
 : -1;

2047 
	}
}

2050 
	$ªad_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

2052 
°rbuf
 
sbuf
;

2053 
f
 = 0;

2055 
sbuf
.
maxÀn
 = 
Àn
;

2056 
sbuf
.
buf
 = (*)buf;

2057  
	`gëmsg
 (
â
->
fd
, 
NULL
, &
sbuf
, &
f
Ë>0 ? sbuf.
Àn
 : -1;

2058 
	}
}

2060 #ñi‡
deföed
(
TARGET_OPENBSD
)

2063 
	$›í_tun
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
, 
tu¡≠
 *
â
)

2065 
	`›í_tun_gíîic
 (
dev
, 
dev_ty≥
, 
dev_node
, 
åue
,Årue, 
â
);

2068 i‡(
â
->
fd
 >= 0)

2070 
tunöfo
 
öfo
;

2072 i‡(
	`io˘l
 (
â
->
fd
, 
TUNGIFINFO
, &
öfo
) < 0) {

2073 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Can't get interface info: %s",

2074 
	`°ªº‹
(
î∫o
));

2077 #ifde‡
IFF_MULTICAST


2078 
öfo
.
Êags
 |
IFF_MULTICAST
;

2081 i‡(
	`io˘l
 (
â
->
fd
, 
TUNSIFINFO
, &
öfo
) < 0) {

2082 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Can't set interface info: %s",

2083 
	`°ªº‹
(
î∫o
));

2086 
	}
}

2098 
	$˛o£_tun
 (
tu¡≠
* 
â
)

2102 i‡(
â
 && (â->
ty≥
 =
DEV_TYPE_TUN
 ||Åt->
≥rsi°ít_if
 ) )

2104 
	`˛o£_tun_gíîic
 (
â
);

2105 
	`‰ì
(
â
);

2107 i‡(
â
)

2109 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2110 
¨gv
árgv;

2115 
	`¨gv_öô
 (&
¨gv
);

2116 
	`¨gv_¥ötf
 (&
¨gv
, "%s %s destroy",

2117 
IFCONFIG_PATH
, 
â
->
a˘uÆ_«me
);

2119 
	`˛o£_tun_gíîic
 (
â
);

2121 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

2122 
	`›ív≤_execve_check
 (&
¨gv
, 
NULL
, 0, "OpenBSD 'destroyÅun interface' failed (non-critical)");

2124 
	`‰ì
 (
â
);

2126 
	}
}

2129 
	$wrôe_tun
(
tu¡≠
 *
â
, 
uöt8_t
 *
buf
, 
Àn
)

2131  
	`wrôe_tun_hódî
 (
â
, 
buf
, 
Àn
);

2132 
	}
}

2135 
	$ªad_tun
 (
tu¡≠
 *
â
, 
uöt8_t
 *
buf
, 
Àn
)

2137  
	`ªad_tun_hódî
 (
â
, 
buf
, 
Àn
);

2138 
	}
}

2140 #ñi‡
deföed
(
TARGET_NETBSD
)

2157 
	$›í_tun
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
, 
tu¡≠
 *
â
)

2159 #ifde‡
NETBSD_MULTI_AF


2160 
	`›í_tun_gíîic
 (
dev
, 
dev_ty≥
, 
dev_node
, 
åue
,Årue, 
â
);

2162 
	`›í_tun_gíîic
 (
dev
, 
dev_ty≥
, 
dev_node
, 
Ál£
, 
åue
, 
â
);

2165 i‡(
â
->
fd
 >= 0)

2167 
i
 = 
IFF_POINTOPOINT
|
IFF_MULTICAST
;

2168 
	`io˘l
 (
â
->
fd
, 
TUNSIFMODE
, &
i
);

2169 
i
 = 0;

2170 
	`io˘l
 (
â
->
fd
, 
TUNSLMODE
, &
i
);

2172 #ifde‡
NETBSD_MULTI_AF


2173 i‡–
â
->
ty≥
 =
DEV_TYPE_TUN
 )

2175 
i
 = 1;

2176 i‡(
	`io˘l
 (
â
->
fd
, 
TUNSIFHEAD
, &
i
) < 0)

2178 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "io˘l(TUNSIFHEAD): %s", 
	`°ªº‹
(
î∫o
));

2183 
	}
}

2190 
	$˛o£_tun
 (
tu¡≠
 *
â
)

2194 i‡(
â
 && (Åt->
ty≥
 !
DEV_TYPE_TUN
 ||Åt->
≥rsi°ít_if
 ) )

2196 
	`˛o£_tun_gíîic
 (
â
);

2197 
	`‰ì
(
â
);

2199 i‡(
â
)

2201 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2202 
¨gv
árgv;

2207 
	`¨gv_öô
 (&
¨gv
);

2208 
	`¨gv_¥ötf
 (&
¨gv
, "%s %s destroy",

2209 
IFCONFIG_PATH
, 
â
->
a˘uÆ_«me
);

2211 
	`˛o£_tun_gíîic
 (
â
);

2213 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

2214 
	`›ív≤_execve_check
 (&
¨gv
, 
NULL
, 0, "NetBSD 'destroyÅun interface' failed (non-critical)");

2216 
	`‰ì
 (
â
);

2218 
	}
}

2220 #ifde‡
NETBSD_MULTI_AF


2222 
ölöe
 

2223 
	$√tbsd_modify_ªad_wrôe_ªtu∫
 (
Àn
)

2225 i‡(
Àn
 > 0)

2226  
Àn
 >  (
u_öt32_t
) ?Üen -  (u_int32_t) : 0;

2228  
Àn
;

2229 
	}
}

2232 
	$wrôe_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

2234 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

2236 
u_öt32_t
 
ty≥
;

2237 
iovec
 
iv
[2];

2238 
›ív≤_ùhdr
 *
ùh
;

2240 
ùh
 = (
›ív≤_ùhdr
 *Ë
buf
;

2242 i‡(
â
->
ùv6
 && 
	`OPENVPN_IPH_GET_VER
(
ùh
->
vîsi⁄_Àn
) == 6)

2243 
ty≥
 = 
	`ht⁄l
 (
AF_INET6
);

2245 
ty≥
 = 
	`ht⁄l
 (
AF_INET
);

2247 
iv
[0].
iov_ba£
 = (*)&
ty≥
;

2248 
iv
[0].
iov_Àn
 =  (
ty≥
);

2249 
iv
[1].
iov_ba£
 = 
buf
;

2250 
iv
[1].
iov_Àn
 = 
Àn
;

2252  
	`√tbsd_modify_ªad_wrôe_ªtu∫
 (
	`wrôev
 (
â
->
fd
, 
iv
, 2));

2255  
	`wrôe
 (
â
->
fd
, 
buf
, 
Àn
);

2256 
	}
}

2259 
	$ªad_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

2261 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

2263 
u_öt32_t
 
ty≥
;

2264 
iovec
 
iv
[2];

2266 
iv
[0].
iov_ba£
 = (*)&
ty≥
;

2267 
iv
[0].
iov_Àn
 =  (
ty≥
);

2268 
iv
[1].
iov_ba£
 = 
buf
;

2269 
iv
[1].
iov_Àn
 = 
Àn
;

2271  
	`√tbsd_modify_ªad_wrôe_ªtu∫
 (
	`ªadv
 (
â
->
fd
, 
iv
, 2));

2274  
	`ªad
 (
â
->
fd
, 
buf
, 
Àn
);

2275 
	}
}

2280 
	$wrôe_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

2282  
	`wrôe
 (
â
->
fd
, 
buf
, 
Àn
);

2283 
	}
}

2286 
	$ªad_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

2288  
	`ªad
 (
â
->
fd
, 
buf
, 
Àn
);

2289 
	}
}

2292 #ñi‡
deföed
(
TARGET_FREEBSD
)

2294 
ölöe
 

2295 
	$‰ìbsd_modify_ªad_wrôe_ªtu∫
 (
Àn
)

2297 i‡(
Àn
 > 0)

2298  
Àn
 >  (
u_öt32_t
) ?Üen -  (u_int32_t) : 0;

2300  
Àn
;

2301 
	}
}

2304 
	$›í_tun
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
, 
tu¡≠
 *
â
)

2306 
	`›í_tun_gíîic
 (
dev
, 
dev_ty≥
, 
dev_node
, 
åue
,Årue, 
â
);

2308 i‡(
â
->
fd
 >0 &&Åt->
ty≥
 =
DEV_TYPE_TUN
)

2310 
i
 = 
IFF_POINTOPOINT
 | 
IFF_MULTICAST
;

2312 i‡(
	`io˘l
 (
â
->
fd
, 
TUNSIFMODE
, &
i
) < 0) {

2313 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "io˘l(TUNSIFMODE): %s", 
	`°ªº‹
(
î∫o
));

2315 
i
 = 1;

2316 i‡(
	`io˘l
 (
â
->
fd
, 
TUNSIFHEAD
, &
i
) < 0) {

2317 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "io˘l(TUNSIFHEAD): %s", 
	`°ªº‹
(
î∫o
));

2320 
	}
}

2330 
	$˛o£_tun
 (
tu¡≠
 *
â
)

2332 i‡(
â
 &&Åt->
≥rsi°ít_if
 )

2334 
	`˛o£_tun_gíîic
 (
â
);

2335 
	`‰ì
 (
â
);

2337 i‡(
â
)

2339 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2340 
¨gv
árgv;

2345 
	`¨gv_öô
 (&
¨gv
);

2346 
	`¨gv_¥ötf
 (&
¨gv
, "%s %s destroy",

2347 
IFCONFIG_PATH
, 
â
->
a˘uÆ_«me
);

2349 
	`˛o£_tun_gíîic
 (
â
);

2351 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

2352 
	`›ív≤_execve_check
 (&
¨gv
, 
NULL
, 0, "FreeBSD 'destroyÅun interface' failed (non-critical)");

2354 
	`‰ì
 (
â
);

2356 
	}
}

2359 
	$wrôe_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

2361 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

2363 
u_öt32_t
 
ty≥
;

2364 
iovec
 
iv
[2];

2365 
ù
 *
ùh
;

2367 
ùh
 = (
ù
 *Ë
buf
;

2369 i‡(
â
->
ùv6
 && 
ùh
->
ù_v
 == 6)

2370 
ty≥
 = 
	`ht⁄l
 (
AF_INET6
);

2372 
ty≥
 = 
	`ht⁄l
 (
AF_INET
);

2374 
iv
[0].
iov_ba£
 = (*)&
ty≥
;

2375 
iv
[0].
iov_Àn
 =  (
ty≥
);

2376 
iv
[1].
iov_ba£
 = 
buf
;

2377 
iv
[1].
iov_Àn
 = 
Àn
;

2379  
	`‰ìbsd_modify_ªad_wrôe_ªtu∫
 (
	`wrôev
 (
â
->
fd
, 
iv
, 2));

2382  
	`wrôe
 (
â
->
fd
, 
buf
, 
Àn
);

2383 
	}
}

2386 
	$ªad_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

2388 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

2390 
u_öt32_t
 
ty≥
;

2391 
iovec
 
iv
[2];

2393 
iv
[0].
iov_ba£
 = (*)&
ty≥
;

2394 
iv
[0].
iov_Àn
 =  (
ty≥
);

2395 
iv
[1].
iov_ba£
 = 
buf
;

2396 
iv
[1].
iov_Àn
 = 
Àn
;

2398  
	`‰ìbsd_modify_ªad_wrôe_ªtu∫
 (
	`ªadv
 (
â
->
fd
, 
iv
, 2));

2401  
	`ªad
 (
â
->
fd
, 
buf
, 
Àn
);

2402 
	}
}

2404 #ñi‡
deföed
(
TARGET_DRAGONFLY
)

2406 
ölöe
 

2407 
	$døg⁄Êy_modify_ªad_wrôe_ªtu∫
 (
Àn
)

2409 i‡(
Àn
 > 0)

2410  
Àn
 >  (
u_öt32_t
) ?Üen -  (u_int32_t) : 0;

2412  
Àn
;

2413 
	}
}

2416 
	$›í_tun
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
, 
tu¡≠
 *
â
)

2418 
	`›í_tun_gíîic
 (
dev
, 
dev_ty≥
, 
dev_node
, 
åue
,Årue, 
â
);

2420 i‡(
â
->
fd
 >= 0)

2422 
i
 = 0;

2425 
	`io˘l
 (
â
->
fd
, 
TUNSLMODE
, &
i
);

2426 
i
 = 1;

2427 
	`io˘l
 (
â
->
fd
, 
TUNSIFHEAD
, &
i
);

2429 
	}
}

2432 
	$˛o£_tun
 (
tu¡≠
 *
â
)

2434 i‡(
â
)

2436 
	`˛o£_tun_gíîic
 (
â
);

2437 
	`‰ì
 (
â
);

2439 
	}
}

2442 
	$wrôe_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

2444 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

2446 
u_öt32_t
 
ty≥
;

2447 
iovec
 
iv
[2];

2448 
ù
 *
ùh
;

2450 
ùh
 = (
ù
 *Ë
buf
;

2452 i‡(
â
->
ùv6
 && 
ùh
->
ù_v
 == 6)

2453 
ty≥
 = 
	`ht⁄l
 (
AF_INET6
);

2455 
ty≥
 = 
	`ht⁄l
 (
AF_INET
);

2457 
iv
[0].
iov_ba£
 = (*)&
ty≥
;

2458 
iv
[0].
iov_Àn
 =  (
ty≥
);

2459 
iv
[1].
iov_ba£
 = 
buf
;

2460 
iv
[1].
iov_Àn
 = 
Àn
;

2462  
	`døg⁄Êy_modify_ªad_wrôe_ªtu∫
 (
	`wrôev
 (
â
->
fd
, 
iv
, 2));

2465  
	`wrôe
 (
â
->
fd
, 
buf
, 
Àn
);

2466 
	}
}

2469 
	$ªad_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

2471 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

2473 
u_öt32_t
 
ty≥
;

2474 
iovec
 
iv
[2];

2476 
iv
[0].
iov_ba£
 = (*)&
ty≥
;

2477 
iv
[0].
iov_Àn
 =  (
ty≥
);

2478 
iv
[1].
iov_ba£
 = 
buf
;

2479 
iv
[1].
iov_Àn
 = 
Àn
;

2481  
	`døg⁄Êy_modify_ªad_wrôe_ªtu∫
 (
	`ªadv
 (
â
->
fd
, 
iv
, 2));

2484  
	`ªad
 (
â
->
fd
, 
buf
, 
Àn
);

2485 
	}
}

2487 #ñi‡
deföed
(
TARGET_DARWIN
)

2503 #ifde‡
HAVE_NET_IF_UTUN_H


2510 
	$utun_›í_hñ≥r
 (
˘l_öfo
 
˘lInfo
, 
utu¬um
)

2512 
sockaddr_˘l
 
sc
;

2513 
fd
;

2515 
fd
 = 
	`sockë
(
PF_SYSTEM
, 
SOCK_DGRAM
, 
SYSPROTO_CONTROL
);

2517 i‡(
fd
 < 0)

2519 
	`msg
 (
M_INFO
, "Opening utun (%s): %s", "socket(SYSPROTO_CONTROL)",

2520 
	`°ªº‹
 (
î∫o
));

2524 i‡(
	`io˘l
(
fd
, 
CTLIOCGINFO
, &
˘lInfo
) == -1)

2526 
	`˛o£
 (
fd
);

2527 
	`msg
 (
M_INFO
, "Opening utun (%s): %s", "ioctl(CTLIOCGINFO)",

2528 
	`°ªº‹
 (
î∫o
));

2533 
sc
.
sc_id
 = 
˘lInfo
.
˘l_id
;

2534 
sc
.
sc_Àn
 = (sc);

2535 
sc
.
sc_Ámûy
 = 
AF_SYSTEM
;

2536 
sc
.
ss_syßddr
 = 
AF_SYS_CONTROL
;

2538 
sc
.
sc_unô
 = 
utu¬um
+1;

2544 i‡(
	`c⁄√˘
 (
fd
, (
sockaddr
 *)&
sc
, (sc)) < 0)

2546 
	`msg
 (
M_INFO
, "Opening utun (%s): %s", "connect(AF_SYS_CONTROL)",

2547 
	`°ªº‹
 (
î∫o
));

2548 
	`˛o£
(
fd
);

2552 
	`£t_n⁄block
 (
fd
);

2553 
	`£t_˛€xec
 (
fd
);

2555  
fd
;

2556 
	}
}

2559 
	$›í_d¨wö_utun
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
, 
tu¡≠
 *
â
)

2561 
˘l_öfo
 
˘lInfo
;

2562 
fd
;

2563 
utu¬ame
[20];

2564 
utu¬um
 =-1;

2565 
sockÀn_t
 
utu¬ame_Àn
 = (
utu¬ame
);

2569 i‡(
dev_node
 && !
	`°rcmp
 ("utun", dev_node)==0)

2571 i‡(!
	`ssˇnf
 (
dev_node
, "utun%d", &
utu¬um
)==1)

2572 
	`msg
 (
M_FATAL
, "CannotÖarse 'dev-node %s'Ölease use 'dev-node utunX'"

2573 "tÿu£á utu¿devi˚Çumbî X", 
dev_node
);

2578 
	`CLEAR
 (
˘lInfo
);

2579 i‡(
	`°æ˝y
(
˘lInfo
.
˘l_«me
, 
UTUN_CONTROL_NAME
, (ctlInfo.ctl_name)) >=

2580 (
˘lInfo
.
˘l_«me
))

2582 
	`msg
 (
M_ERR
, "Opening utun: UTUN_CONTROL_NAMEÅooÜong");

2586 i‡(
utu¬um
 == -1)

2588 
utu¬um
=0; utunnum<255; utunnum++)

2590 
fd
 = 
	`utun_›í_hñ≥r
 (
˘lInfo
, 
utu¬um
);

2593 i‡(
fd
 !=-1)

2599 
fd
 = 
	`utun_›í_hñ≥r
 (
˘lInfo
, 
utu¬um
);

2603 
â
->
fd
 = fd;

2605 i‡(
fd
 < 0)

2609 i‡(
	`gësock›t
 (
fd
, 
SYSPROTO_CONTROL
, 
UTUN_OPT_IFNAME
, 
utu¬ame
, &
utu¬ame_Àn
))

2610 
	`msg
 (
M_ERR
 | 
M_ERRNO
, "ErrorÑetrieving utun interfaceÇame");

2612 
â
->
a˘uÆ_«me
 = 
	`°rög_Æloc
 (
utu¬ame
, 
NULL
);

2614 
	`msg
 (
M_INFO
, "O≥√d utu¿devi˚ %s", 
utu¬ame
);

2615 
â
->
is_utun
 = 
åue
;

2616 
	}
}

2621 
	$›í_tun
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
, 
tu¡≠
 *
â
)

2623 #ifde‡
HAVE_NET_IF_UTUN_H


2625 i‡((!
dev_node
 && 
â
->
ty≥
==
DEV_TYPE_TUN
) ||

2626 (
dev_node
 && !
	`°∫cmp
 (dev_node, "utun", 4)))

2631 i‡(
â
->
ty≥
!=
DEV_TYPE_TUN
)

2632 
	`msg
 (
M_FATAL
, "Cannot use utun devices with --dev-type %s",

2633 
	`dev_ty≥_°rög
 (
dev
, 
dev_ty≥
));

2637 
	`›í_d¨wö_utun
(
dev
, 
dev_ty≥
, 
dev_node
, 
â
);

2639 i‡(!
â
->
is_utun
)

2641 i‡(!
dev_node
)

2644 
	`msg
 (
M_INFO
, "FailedÅo open utun device. Falling backÅo /dev/tun device");

2645 
	`›í_tun_gíîic
 (
dev
, 
dev_ty≥
, 
NULL
, 
åue
,Årue, 
â
);

2651 
	`msg
 (
M_FATAL
, "Cannot open utun device");

2663 i‡(
dev_node
 && 
	`°rcmp
 (dev_node, "tun")==0)

2664 
dev_node
=
NULL
;

2666 
	`›í_tun_gíîic
 (
dev
, 
dev_ty≥
, 
dev_node
, 
åue
,Årue, 
â
);

2668 
	}
}

2671 
	$˛o£_tun
 (
tu¡≠
* 
â
)

2673 i‡(
â
)

2675 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2676 
¨gv
árgv;

2677 
	`¨gv_öô
 (&
¨gv
);

2679 i‡–
â
->
ùv6
 &&Åt->
did_ifc⁄fig_ùv6_£tup
 )

2681 c⁄° * 
ifc⁄fig_ùv6_loˇl
 =

2682 
	`¥öt_ö6_addr
 (
â
->
loˇl_ùv6
, 0, &
gc
);

2684 
	`¨gv_¥ötf
 (&
¨gv
, "%s delete -inet6 %s",

2685 
ROUTE_PATH
, 
ifc⁄fig_ùv6_loˇl
 );

2686 
	`¨gv_msg
 (
M_INFO
, &
¨gv
);

2687 
	`›ív≤_execve_check
 (&
¨gv
, 
NULL
, 0, "MacOS X 'remove inet6Ñoute' failed (non-critical)");

2690 
	`˛o£_tun_gíîic
 (
â
);

2691 
	`‰ì
 (
â
);

2692 
	`¨gv_ª£t
 (&
¨gv
);

2693 
	`gc_‰ì
 (&
gc
);

2695 
	}
}

2698 
	$wrôe_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

2700 #ifde‡
HAVE_NET_IF_UTUN_H


2701 i‡(
â
->
is_utun
)

2702  
	`wrôe_tun_hódî
 (
â
, 
buf
, 
Àn
);

2705  
	`wrôe
 (
â
->
fd
, 
buf
, 
Àn
);

2706 
	}
}

2709 
	$ªad_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

2711 #ifde‡
HAVE_NET_IF_UTUN_H


2712 i‡(
â
->
is_utun
)

2713  
	`ªad_tun_hódî
 (
â
, 
buf
, 
Àn
);

2716  
	`ªad
 (
â
->
fd
, 
buf
, 
Àn
);

2717 
	}
}

2719 #ñi‡
deföed
(
WIN32
)

2722 
	$tun_ªad_queue
 (
tu¡≠
 *
â
, 
maxsize
)

2724 i‡(
â
->
ªads
.
io°©e
 =
IOSTATE_INITIAL
)

2726 
DWORD
 
Àn
;

2727 
BOOL
 
°©us
;

2728 
îr
;

2731 
â
->
ªads
.
buf
 =Åt->ªads.
buf_öô
;

2733 
Àn
 = 
maxsize
 ? maxsizê: 
	`BLEN
 (&
â
->
ªads
.
buf
);

2734 
	`ASSERT
 (
Àn
 <
	`BLEN
 (&
â
->
ªads
.
buf
));

2737 
	`ASSERT
 (
	`Re£tEvít
 (
â
->
ªads
.
ovîœµed
.
hEvít
));

2739 
°©us
 = 
	`RódFûe
(

2740 
â
->
h™d
,

2741 
	`BPTR
 (&
â
->
ªads
.
buf
),

2742 
Àn
,

2743 &
â
->
ªads
.
size
,

2744 &
â
->
ªads
.
ovîœµed


2747 i‡(
°©us
)

2750 
	`ASSERT
 (
	`SëEvít
 (
â
->
ªads
.
ovîœµed
.
hEvít
));

2752 
â
->
ªads
.
io°©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

2753 
â
->
ªads
.
°©us
 = 0;

2755 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: TAP Read immediateÑeturn [%d,%d]",

2756 (Ë
Àn
,

2757 (Ë
â
->
ªads
.
size
);

2761 
îr
 = 
	`GëLa°Eº‹
 ();

2762 i‡(
îr
 =
ERROR_IO_PENDING
)

2764 
â
->
ªads
.
io°©e
 = 
IOSTATE_QUEUED
;

2765 
â
->
ªads
.
°©us
 = 
îr
;

2766 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: TAP Read queued [%d]",

2767 (Ë
Àn
);

2771 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2772 
	`ASSERT
 (
	`SëEvít
 (
â
->
ªads
.
ovîœµed
.
hEvít
));

2773 
â
->
ªads
.
io°©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

2774 
â
->
ªads
.
°©us
 = 
îr
;

2775 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: TAP ReadÉrror [%d] : %s",

2776 (Ë
Àn
,

2777 
	`°ªº‹_wö32
 (
°©us
, &
gc
));

2778 
	`gc_‰ì
 (&
gc
);

2782  
â
->
ªads
.
io°©e
;

2783 
	}
}

2786 
	$tun_wrôe_queue
 (
tu¡≠
 *
â
, 
buf„r
 *
buf
)

2788 i‡(
â
->
wrôes
.
io°©e
 =
IOSTATE_INITIAL
)

2790 
BOOL
 
°©us
;

2791 
îr
;

2794 
â
->
wrôes
.
buf
 =Åt->wrôes.
buf_öô
;

2795 
â
->
wrôes
.
buf
.
Àn
 = 0;

2796 
	`ASSERT
 (
	`buf_c›y
 (&
â
->
wrôes
.
buf
, buf));

2799 
	`ASSERT
 (
	`Re£tEvít
 (
â
->
wrôes
.
ovîœµed
.
hEvít
));

2801 
°©us
 = 
	`WrôeFûe
(

2802 
â
->
h™d
,

2803 
	`BPTR
 (&
â
->
wrôes
.
buf
),

2804 
	`BLEN
 (&
â
->
wrôes
.
buf
),

2805 &
â
->
wrôes
.
size
,

2806 &
â
->
wrôes
.
ovîœµed


2809 i‡(
°©us
)

2811 
â
->
wrôes
.
io°©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

2814 
	`ASSERT
 (
	`SëEvít
 (
â
->
wrôes
.
ovîœµed
.
hEvít
));

2816 
â
->
wrôes
.
°©us
 = 0;

2818 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: TAP Write immediateÑeturn [%d,%d]",

2819 
	`BLEN
 (&
â
->
wrôes
.
buf
),

2820 (Ë
â
->
wrôes
.
size
);

2824 
îr
 = 
	`GëLa°Eº‹
 ();

2825 i‡(
îr
 =
ERROR_IO_PENDING
)

2827 
â
->
wrôes
.
io°©e
 = 
IOSTATE_QUEUED
;

2828 
â
->
wrôes
.
°©us
 = 
îr
;

2829 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: TAP Write queued [%d]",

2830 
	`BLEN
 (&
â
->
wrôes
.
buf
));

2834 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

2835 
	`ASSERT
 (
	`SëEvít
 (
â
->
wrôes
.
ovîœµed
.
hEvít
));

2836 
â
->
wrôes
.
io°©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

2837 
â
->
wrôes
.
°©us
 = 
îr
;

2838 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: TAP WriteÉrror [%d] : %s",

2839 
	`BLEN
 (&
â
->
wrôes
.
buf
),

2840 
	`°ªº‹_wö32
 (
îr
, &
gc
));

2841 
	`gc_‰ì
 (&
gc
);

2845  
â
->
wrôes
.
io°©e
;

2846 
	}
}

2849 
	$tun_föÆize
 (

2850 
HANDLE
 
h
,

2851 
ovîœµed_io
 *
io
,

2852 
buf„r
 *
buf
)

2854 
ªt
 = -1;

2855 
BOOL
 
°©us
;

2857 
io
->
io°©e
)

2859 
IOSTATE_QUEUED
:

2860 
°©us
 = 
	`GëOvîœµedResu…
(

2861 
h
,

2862 &
io
->
ovîœµed
,

2863 &
io
->
size
,

2864 
FALSE


2866 i‡(
°©us
)

2869 i‡(
buf
)

2870 *
buf
 = 
io
->buf;

2871 
ªt
 = 
io
->
size
;

2872 
io
->
io°©e
 = 
IOSTATE_INITIAL
;

2873 
	`ASSERT
 (
	`Re£tEvít
 (
io
->
ovîœµed
.
hEvít
));

2874 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: TAP Com∂ëi⁄ suc˚s†[%d]", 
ªt
);

2879 
ªt
 = -1;

2880 i‡(
	`GëLa°Eº‹
(Ë!
ERROR_IO_INCOMPLETE
)

2884 
io
->
io°©e
 = 
IOSTATE_INITIAL
;

2885 
	`ASSERT
 (
	`Re£tEvít
 (
io
->
ovîœµed
.
hEvít
));

2886 
	`msg
 (
D_WIN32_IO
 | 
M_ERRNO
, "WIN32 I/O: TAP CompletionÉrror");

2891 
IOSTATE_IMMEDIATE_RETURN
:

2892 
io
->
io°©e
 = 
IOSTATE_INITIAL
;

2893 
	`ASSERT
 (
	`Re£tEvít
 (
io
->
ovîœµed
.
hEvít
));

2894 i‡(
io
->
°©us
)

2897 
	`SëLa°Eº‹
 (
io
->
°©us
);

2898 
ªt
 = -1;

2899 
	`msg
 (
D_WIN32_IO
 | 
M_ERRNO
, "WIN32 I/O: TAP CompletionÇon-queuedÉrror");

2904 i‡(
buf
)

2905 *
buf
 = 
io
->buf;

2906 
ªt
 = 
io
->
size
;

2907 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: TAP Com∂ëi⁄Ç⁄-queued suc˚s†[%d]", 
ªt
);

2911 
IOSTATE_INITIAL
:

2912 
	`SëLa°Eº‹
 (
ERROR_INVALID_FUNCTION
);

2913 
ªt
 = -1;

2914 
	`dmsg
 (
D_WIN32_IO
, "WIN32 I/O: TAP Completion BAD STATE");

2918 
	`ASSERT
 (0);

2921 i‡(
buf
)

2922 
buf
->
Àn
 = 
ªt
;

2923  
ªt
;

2924 
	}
}

2926 c⁄° 
èp_ªg
 *

2927 
	$gë_èp_ªg
 (
gc_¨ía
 *
gc
)

2929 
HKEY
 
ad≠ãr_key
;

2930 
LONG
 
°©us
;

2931 
DWORD
 
Àn
;

2932 
èp_ªg
 *
fú°
 = 
NULL
;

2933 
èp_ªg
 *
œ°
 = 
NULL
;

2934 
i
 = 0;

2936 
°©us
 = 
	`RegO≥nKeyEx
(

2937 
HKEY_LOCAL_MACHINE
,

2938 
ADAPTER_KEY
,

2940 
KEY_READ
,

2941 &
ad≠ãr_key
);

2943 i‡(
°©us
 !
ERROR_SUCCESS
)

2944 
	`msg
 (
M_FATAL
, "Eº‹ o≥nögÑegi°ry key: %s", 
ADAPTER_KEY
);

2946 
åue
)

2948 
íum_«me
[256];

2949 
unô_°rög
[256];

2950 
HKEY
 
unô_key
;

2951 
comp⁄ít_id_°rög
[] = "ComponentId";

2952 
comp⁄ít_id
[256];

2953 
√t_cfg_ö°™˚_id_°rög
[] = "NetCfgInstanceId";

2954 
√t_cfg_ö°™˚_id
[256];

2955 
DWORD
 
d©a_ty≥
;

2957 
Àn
 =  (
íum_«me
);

2958 
°©us
 = 
	`RegEnumKeyEx
(

2959 
ad≠ãr_key
,

2960 
i
,

2961 
íum_«me
,

2962 &
Àn
,

2963 
NULL
,

2964 
NULL
,

2965 
NULL
,

2966 
NULL
);

2967 i‡(
°©us
 =
ERROR_NO_MORE_ITEMS
)

2969 i‡(
°©us
 !
ERROR_SUCCESS
)

2970 
	`msg
 (
M_FATAL
, "ErrorÉnumeratingÑegistry subkeys of key: %s",

2971 
ADAPTER_KEY
);

2973 
	`›ív≤_¢¥ötf
 (
unô_°rög
, (unit_string), "%s\\%s",

2974 
ADAPTER_KEY
, 
íum_«me
);

2976 
°©us
 = 
	`RegO≥nKeyEx
(

2977 
HKEY_LOCAL_MACHINE
,

2978 
unô_°rög
,

2980 
KEY_READ
,

2981 &
unô_key
);

2983 i‡(
°©us
 !
ERROR_SUCCESS
)

2984 
	`dmsg
 (
D_REGISTRY
, "Eº‹ o≥nögÑegi°ry key: %s", 
unô_°rög
);

2987 
Àn
 =  (
comp⁄ít_id
);

2988 
°©us
 = 
	`RegQuîyVÆueEx
(

2989 
unô_key
,

2990 
comp⁄ít_id_°rög
,

2991 
NULL
,

2992 &
d©a_ty≥
,

2993 
comp⁄ít_id
,

2994 &
Àn
);

2996 i‡(
°©us
 !
ERROR_SUCCESS
 || 
d©a_ty≥
 !
REG_SZ
)

2997 
	`dmsg
 (
D_REGISTRY
, "Error openingÑegistry key: %s\\%s",

2998 
unô_°rög
, 
comp⁄ít_id_°rög
);

3001 
Àn
 =  (
√t_cfg_ö°™˚_id
);

3002 
°©us
 = 
	`RegQuîyVÆueEx
(

3003 
unô_key
,

3004 
√t_cfg_ö°™˚_id_°rög
,

3005 
NULL
,

3006 &
d©a_ty≥
,

3007 
√t_cfg_ö°™˚_id
,

3008 &
Àn
);

3010 i‡(
°©us
 =
ERROR_SUCCESS
 && 
d©a_ty≥
 =
REG_SZ
)

3012 i‡(!
	`°rcmp
 (
comp⁄ít_id
, 
TAP_WIN_COMPONENT_ID
))

3014 
èp_ªg
 *
ªg
;

3015 
	`ALLOC_OBJ_CLEAR_GC
 (
ªg
, 
èp_ªg
, 
gc
);

3016 
ªg
->
guid
 = 
	`°rög_Æloc
 (
√t_cfg_ö°™˚_id
, 
gc
);

3019 i‡(!
fú°
)

3020 
fú°
 = 
ªg
;

3021 i‡(
œ°
)

3022 
œ°
->
√xt
 = 
ªg
;

3023 
œ°
 = 
ªg
;

3027 
	`RegClo£Key
 (
unô_key
);

3029 ++
i
;

3032 
	`RegClo£Key
 (
ad≠ãr_key
);

3033  
fú°
;

3034 
	}
}

3036 c⁄° 
∑√l_ªg
 *

3037 
	$gë_∑√l_ªg
 (
gc_¨ía
 *
gc
)

3039 
LONG
 
°©us
;

3040 
HKEY
 
√tw‹k_c⁄√˘i⁄s_key
;

3041 
DWORD
 
Àn
;

3042 
∑√l_ªg
 *
fú°
 = 
NULL
;

3043 
∑√l_ªg
 *
œ°
 = 
NULL
;

3044 
i
 = 0;

3046 
°©us
 = 
	`RegO≥nKeyEx
(

3047 
HKEY_LOCAL_MACHINE
,

3048 
NETWORK_CONNECTIONS_KEY
,

3050 
KEY_READ
,

3051 &
√tw‹k_c⁄√˘i⁄s_key
);

3053 i‡(
°©us
 !
ERROR_SUCCESS
)

3054 
	`msg
 (
M_FATAL
, "Eº‹ o≥nögÑegi°ry key: %s", 
NETWORK_CONNECTIONS_KEY
);

3056 
åue
)

3058 
íum_«me
[256];

3059 
c⁄√˘i⁄_°rög
[256];

3060 
HKEY
 
c⁄√˘i⁄_key
;

3061 
WCHAR
 
«me_d©a
[256];

3062 
DWORD
 
«me_ty≥
;

3063 c⁄° 
WCHAR
 
«me_°rög
[] = 
L
"Name";

3065 
Àn
 =  (
íum_«me
);

3066 
°©us
 = 
	`RegEnumKeyEx
(

3067 
√tw‹k_c⁄√˘i⁄s_key
,

3068 
i
,

3069 
íum_«me
,

3070 &
Àn
,

3071 
NULL
,

3072 
NULL
,

3073 
NULL
,

3074 
NULL
);

3075 i‡(
°©us
 =
ERROR_NO_MORE_ITEMS
)

3077 i‡(
°©us
 !
ERROR_SUCCESS
)

3078 
	`msg
 (
M_FATAL
, "ErrorÉnumeratingÑegistry subkeys of key: %s",

3079 
NETWORK_CONNECTIONS_KEY
);

3081 
	`›ív≤_¢¥ötf
 (
c⁄√˘i⁄_°rög
, (connection_string),

3083 
NETWORK_CONNECTIONS_KEY
, 
íum_«me
);

3085 
°©us
 = 
	`RegO≥nKeyEx
(

3086 
HKEY_LOCAL_MACHINE
,

3087 
c⁄√˘i⁄_°rög
,

3089 
KEY_READ
,

3090 &
c⁄√˘i⁄_key
);

3092 i‡(
°©us
 !
ERROR_SUCCESS
)

3093 
	`dmsg
 (
D_REGISTRY
, "Eº‹ o≥nögÑegi°ry key: %s", 
c⁄√˘i⁄_°rög
);

3096 
Àn
 =  (
«me_d©a
);

3097 
°©us
 = 
	`RegQuîyVÆueExW
(

3098 
c⁄√˘i⁄_key
,

3099 
«me_°rög
,

3100 
NULL
,

3101 &
«me_ty≥
,

3102 (
LPBYTE
Ë
«me_d©a
,

3103 &
Àn
);

3105 i‡(
°©us
 !
ERROR_SUCCESS
 || 
«me_ty≥
 !
REG_SZ
)

3106 
	`dmsg
 (
D_REGISTRY
, "Error openingÑegistry key: %s\\%s\\%s",

3107 
NETWORK_CONNECTIONS_KEY
, 
c⁄√˘i⁄_°rög
, 
«me_°rög
);

3110 
n
;

3111 
LPSTR
 
«me
;

3112 
∑√l_ªg
 *
ªg
;

3114 
	`ALLOC_OBJ_CLEAR_GC
 (
ªg
, 
∑√l_ªg
, 
gc
);

3115 
n
 = 
	`WideCh¨ToMu…iByã
 (
CP_UTF8
, 0, 
«me_d©a
, -1, 
NULL
, 0, NULL, NULL);

3116 
«me
 = 
	`gc_mÆloc
 (
n
, 
Ál£
, 
gc
);

3117 
	`WideCh¨ToMu…iByã
 (
CP_UTF8
, 0, 
«me_d©a
, -1, 
«me
, 
n
, 
NULL
, NULL);

3118 
ªg
->
«me
 =Çame;

3119 
ªg
->
guid
 = 
	`°rög_Æloc
 (
íum_«me
, 
gc
);

3122 i‡(!
fú°
)

3123 
fú°
 = 
ªg
;

3124 i‡(
œ°
)

3125 
œ°
->
√xt
 = 
ªg
;

3126 
œ°
 = 
ªg
;

3128 
	`RegClo£Key
 (
c⁄√˘i⁄_key
);

3130 ++
i
;

3133 
	`RegClo£Key
 (
√tw‹k_c⁄√˘i⁄s_key
);

3135  
fú°
;

3136 
	}
}

3142 
	$vîify_255_255_255_252
 (
ö_addr_t
 
loˇl
, in_addr_à
ªmŸe
)

3144 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3145 c⁄° 
mask
 = 3;

3146 c⁄° *
îr
 = 
NULL
;

3148 i‡(
loˇl
 =
ªmŸe
)

3150 
îr
 = "must be different";

3151 
îr‹
;

3153 i‡((
loˇl
 & (~
mask
)Ë!(
ªmŸe
 & (~mask)))

3155 
îr
 = "mustÉxist withinÅhe same 255.255.255.252 subnet. This isáÜimitation of --devÅun when used withÅhe TAP-WIN32 driver";

3156 
îr‹
;

3158 i‡((
loˇl
 & 
mask
) == 0

3159 || (
loˇl
 & 
mask
) == 3

3160 || (
ªmŸe
 & 
mask
) == 0

3161 || (
ªmŸe
 & 
mask
) == 3)

3163 
îr
 = "cannot useÅhe first orÜastáddress withiná given 255.255.255.252 subnet. This isáÜimitation of --devÅun when used withÅhe TAP-WIN32 driver";

3164 
îr‹
;

3167 
	`gc_‰ì
 (&
gc
);

3170 
îr‹
:

3171 
	`msg
 (
M_FATAL
, "Thîêi†®¥obÀm i¿you∏£À˘i⁄ o‡--ifc⁄figÉndpoöt†[loˇl=%s,ÑemŸe=%s]. Thêloˇ»™dÑemŸêVPNÉndpoöt†%s. Try '" 
PACKAGE
 " --show-valid-subnets' option for more info.",

3172 
	`¥öt_ö_addr_t
 (
loˇl
, 0, &
gc
),

3173 
	`¥öt_ö_addr_t
 (
ªmŸe
, 0, &
gc
),

3174 
îr
);

3175 
	`gc_‰ì
 (&
gc
);

3176 
	}
}

3178 
	$show_vÆid_wö32_tun_sub√ts
 ()

3180 
i
;

3181 
cﬁ
 = 0;

3183 
	`¥ötf
 ("On Windows,Öoint-to-point IP support (i.e. --devÅun)\n");

3184 
	`¥ötf
 ("isÉmulated byÅhe TAP-Windows driver. The majorÜimitation\n");

3185 
	`¥ötf
 ("imposed byÅhisápproach isÅhatÅhe --ifconfigÜocalánd\n");

3186 
	`¥ötf
 ("remoteÉndpoints must beÖart ofÅhe same 255.255.255.252\n");

3187 
	`¥ötf
 ("subnet. The followingÜist showsÉxamples ofÉndpoint\n");

3188 
	`¥ötf
 ("pairs which satisfyÅhisÑequirement. OnlyÅhe final\n");

3189 
	`¥ötf
 ("component ofÅhe IPáddressÖairs isát issue.\n\n");

3190 
	`¥ötf
 ("AsánÉxample,Åhe following option would be correct:\n");

3191 
	`¥ötf
 (" --ifconfig 10.7.0.5 10.7.0.6 (on host A)\n");

3192 
	`¥ötf
 (" --ifconfig 10.7.0.6 10.7.0.5 (on host B)\n");

3193 
	`¥ötf
 ("because [5,6] isÖart ofÅhe belowÜist.\n\n");

3195 
i
 = 0; i < 256; i += 4)

3197 
	`¥ötf
("[%3d,%3d] ", 
i
+1, i+2);

3198 i‡(++
cﬁ
 > 4)

3200 
cﬁ
 = 0;

3201 
	`¥ötf
 ("\n");

3204 i‡(
cﬁ
)

3205 
	`¥ötf
 ("\n");

3206 
	}
}

3209 
	$show_èp_wö_ad≠ãrs
 (
msgÀv
, 
w¨∆ev
)

3211 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3213 
boﬁ
 
w¨n_∑√l_nuŒ
 = 
Ál£
;

3214 
boﬁ
 
w¨n_∑√l_dup
 = 
Ál£
;

3215 
boﬁ
 
w¨n_èp_dup
 = 
Ál£
;

3217 
löks
;

3219 c⁄° 
èp_ªg
 *
å
;

3220 c⁄° 
èp_ªg
 *
å1
;

3221 c⁄° 
∑√l_ªg
 *
¥
;

3223 c⁄° 
èp_ªg
 *èp_ªg = 
	`gë_èp_ªg
 (&
gc
);

3224 c⁄° 
∑√l_ªg
 *∑√l_ªg = 
	`gë_∑√l_ªg
 (&
gc
);

3226 
	`msg
 (
msgÀv
, "Available TAP-WIN32ádapters [name, GUID]:");

3229 
å
 = 
èp_ªg
;Å∏!
NULL
;Å∏å->
√xt
)

3231 
löks
 = 0;

3234 
¥
 = 
∑√l_ªg
;Ö∏!
NULL
;Ö∏¥->
√xt
)

3236 i‡(!
	`°rcmp
 (
å
->
guid
, 
¥
->guid))

3238 
	`msg
 (
msgÀv
, "'%s' %s", 
¥
->
«me
, 
å
->
guid
);

3239 ++
löks
;

3243 i‡(
löks
 > 1)

3245 
w¨n_∑√l_dup
 = 
åue
;

3247 i‡(
löks
 == 0)

3251 
w¨n_∑√l_nuŒ
 = 
åue
;

3252 
	`msg
 (
msgÀv
, "[NULL] %s", 
å
->
guid
);

3257 
å
 = 
èp_ªg
;Å∏!
NULL
;Å∏å->
√xt
)

3259 
å1
 = 
èp_ªg
;År1 !
NULL
;År1 =År1->
√xt
)

3261 i‡(
å
 !
å1
 && !
	`°rcmp
 (å->
guid
,År1->guid))

3262 
w¨n_èp_dup
 = 
åue
;

3267 i‡(
w¨n_èp_dup
)

3268 
	`msg
 (
w¨∆ev
, "WARNING: Some TAP-Windowsádapters have duplicate GUIDs");

3270 i‡(
w¨n_∑√l_dup
)

3271 
	`msg
 (
w¨∆ev
, "WARNING: Some TAP-Windowsádapters have duplicateÜinks fromÅhe Network Connections controlÖanel");

3273 i‡(
w¨n_∑√l_nuŒ
)

3274 
	`msg
 (
w¨∆ev
, "WARNING: Some TAP-Windowsádapters haveÇoÜink fromÅhe Network Connections controlÖanel");

3276 
	`gc_‰ì
 (&
gc
);

3277 
	}
}

3282 
boﬁ


3283 
	$is_èp_wö
 (c⁄° *
guid
, c⁄° 
èp_ªg
 *tap_reg)

3285 c⁄° 
èp_ªg
 *
å
;

3287 
å
 = 
èp_ªg
;Å∏!
NULL
;Å∏å->
√xt
)

3289 i‡(
guid
 && !
	`°rcmp
 (
å
->guid, guid))

3290  
åue
;

3293  
Ál£
;

3294 
	}
}

3297 
	$guid_to_«me
 (c⁄° *
guid
, c⁄° 
∑√l_ªg
 *panel_reg)

3299 c⁄° 
∑√l_ªg
 *
¥
;

3301 
¥
 = 
∑√l_ªg
;Ö∏!
NULL
;Ö∏¥->
√xt
)

3303 i‡(
guid
 && !
	`°rcmp
 (
¥
->guid, guid))

3304  
¥
->
«me
;

3307  
NULL
;

3308 
	}
}

3311 
	$«me_to_guid
 (c⁄° *
«me
, c⁄° 
èp_ªg
 *èp_ªg, c⁄° 
∑√l_ªg
 *panel_reg)

3313 c⁄° 
∑√l_ªg
 *
¥
;

3315 
¥
 = 
∑√l_ªg
;Ö∏!
NULL
;Ö∏¥->
√xt
)

3317 i‡(
«me
 && !
	`°rcmp
 (
¥
->«me,ÇameË&& 
	`is_èp_wö
 (¥->
guid
, 
èp_ªg
))

3318  
¥
->
guid
;

3321  
NULL
;

3322 
	}
}

3325 
	$©_Àa°_⁄e_èp_wö
 (c⁄° 
èp_ªg
 *tap_reg)

3327 i‡(!
èp_ªg
)

3328 
	`msg
 (
M_FATAL
, "ThereáreÇo TAP-Windowsádapters onÅhis system. You should beábleÅo createá TAP-Windowsádapter by goingÅo Start -> All Programs -> TAP-Windows -> Utilities -> AddáÇew TAP-Windows virtualÉthernetádapter.");

3329 
	}
}

3336 
	$gë_un•ecifõd_devi˚_guid
 (c⁄° 
devi˚_numbî
,

3337 *
a˘uÆ_«me
,

3338 
a˘uÆ_«me_size
,

3339 c⁄° 
èp_ªg
 *
èp_ªg_§c
,

3340 c⁄° 
∑√l_ªg
 *
∑√l_ªg_§c
,

3341 
gc_¨ía
 *
gc
)

3343 c⁄° 
èp_ªg
 *èp_ªg = 
èp_ªg_§c
;

3344 
buf„r
 
ªt
 = 
	`˛ór_buf
 ();

3345 
buf„r
 
a˘uÆ
 = 
	`˛ór_buf
 ();

3346 
i
;

3348 
	`ASSERT
 (
devi˚_numbî
 >= 0);

3351 i‡(!
èp_ªg
)

3352  
NULL
;

3355 i‡(
a˘uÆ_«me
)

3357 
	`ASSERT
 (
a˘uÆ_«me_size
 > 0);

3358 
	`buf_£t_wrôe
 (&
a˘uÆ
, 
a˘uÆ_«me
, 
a˘uÆ_«me_size
);

3362 
i
 = 0; i < 
devi˚_numbî
; i++)

3364 
èp_ªg
 =Å≠_ªg->
√xt
;

3365 i‡(!
èp_ªg
)

3366  
NULL
;

3370 i‡(
a˘uÆ_«me
)

3372 c⁄° *
a˘
 = 
	`guid_to_«me
 (
èp_ªg
->
guid
, 
∑√l_ªg_§c
);

3373 i‡(
a˘
)

3374 
	`buf_¥ötf
 (&
a˘uÆ
, "%s", 
a˘
);

3376 
	`buf_¥ötf
 (&
a˘uÆ
, "%s", 
èp_ªg
->
guid
);

3380 
ªt
 = 
	`Æloc_buf_gc
 (256, 
gc
);

3381 
	`buf_¥ötf
 (&
ªt
, "%s", 
èp_ªg
->
guid
);

3382  
	`BSTR
 (&
ªt
);

3383 
	}
}

3390 
	$gë_devi˚_guid
 (c⁄° *
«me
,

3391 *
a˘uÆ_«me
,

3392 
a˘uÆ_«me_size
,

3393 c⁄° 
èp_ªg
 *tap_reg,

3394 c⁄° 
∑√l_ªg
 *panel_reg,

3395 
gc_¨ía
 *
gc
)

3397 
buf„r
 
ªt
 = 
	`Æloc_buf_gc
 (256, 
gc
);

3398 
buf„r
 
a˘uÆ
 = 
	`˛ór_buf
 ();

3401 i‡(!
èp_ªg
)

3402  
NULL
;

3405 i‡(
a˘uÆ_«me
)

3407 
	`ASSERT
 (
a˘uÆ_«me_size
 > 0);

3408 
	`buf_£t_wrôe
 (&
a˘uÆ
, 
a˘uÆ_«me
, 
a˘uÆ_«me_size
);

3412 i‡(
	`is_èp_wö
 (
«me
, 
èp_ªg
))

3414 c⁄° *
a˘
 = 
	`guid_to_«me
 (
«me
, 
∑√l_ªg
);

3415 
	`buf_¥ötf
 (&
ªt
, "%s", 
«me
);

3416 i‡(
a˘
)

3417 
	`buf_¥ötf
 (&
a˘uÆ
, "%s", 
a˘
);

3419 
	`buf_¥ötf
 (&
a˘uÆ
, "%s", 
«me
);

3420  
	`BSTR
 (&
ªt
);

3425 c⁄° *
guid
 = 
	`«me_to_guid
 (
«me
, 
èp_ªg
, 
∑√l_ªg
);

3426 i‡(
guid
)

3428 
	`buf_¥ötf
 (&
a˘uÆ
, "%s", 
«me
);

3429 
	`buf_¥ötf
 (&
ªt
, "%s", 
guid
);

3430  
	`BSTR
 (&
ªt
);

3434  
NULL
;

3435 
	}
}

3440 c⁄° 
IP_ADAPTER_INFO
 *

3441 
	$gë_ad≠ãr_öfo_li°
 (
gc_¨ía
 *
gc
)

3443 
ULONG
 
size
 = 0;

3444 
IP_ADAPTER_INFO
 *
pi
 = 
NULL
;

3445 
DWORD
 
°©us
;

3447 i‡((
°©us
 = 
	`GëAd≠ãrsInfo
 (
NULL
, &
size
)Ë!
ERROR_BUFFER_OVERFLOW
)

3449 
	`msg
 (
M_INFO
, "GetAdaptersInfo #1 failed (status=%u) : %s",

3450 ()
°©us
,

3451 
	`°ªº‹_wö32
 (
°©us
, 
gc
));

3455 
pi
 = (
PIP_ADAPTER_INFO
Ë
	`gc_mÆloc
 (
size
, 
Ál£
, 
gc
);

3456 i‡((
°©us
 = 
	`GëAd≠ãrsInfo
 (
pi
, &
size
)Ë=
NO_ERROR
)

3457  
pi
;

3460 
	`msg
 (
M_INFO
, "GetAdaptersInfo #2 failed (status=%u) : %s",

3461 ()
°©us
,

3462 
	`°ªº‹_wö32
 (
°©us
, 
gc
));

3465  
pi
;

3466 
	}
}

3468 c⁄° 
IP_PER_ADAPTER_INFO
 *

3469 
	$gë_≥r_ad≠ãr_öfo
 (c⁄° 
DWORD
 
ödex
, 
gc_¨ía
 *
gc
)

3471 
ULONG
 
size
 = 0;

3472 
IP_PER_ADAPTER_INFO
 *
pi
 = 
NULL
;

3473 
DWORD
 
°©us
;

3475 i‡(
ödex
 !
TUN_ADAPTER_INDEX_INVALID
)

3477 i‡((
°©us
 = 
	`GëPîAd≠ãrInfo
 (
ödex
, 
NULL
, &
size
)Ë!
ERROR_BUFFER_OVERFLOW
)

3479 
	`msg
 (
M_INFO
, "GetPerAdapterInfo #1 failed (status=%u) : %s",

3480 ()
°©us
,

3481 
	`°ªº‹_wö32
 (
°©us
, 
gc
));

3485 
pi
 = (
PIP_PER_ADAPTER_INFO
Ë
	`gc_mÆloc
 (
size
, 
Ál£
, 
gc
);

3486 i‡((
°©us
 = 
	`GëPîAd≠ãrInfo
 ((
ULONG
)
ödex
, 
pi
, &
size
)Ë=
ERROR_SUCCESS
)

3487  
pi
;

3490 
	`msg
 (
M_INFO
, "GetPerAdapterInfo #2 failed (status=%u) : %s",

3491 ()
°©us
,

3492 
	`°ªº‹_wö32
 (
°©us
, 
gc
));

3496  
pi
;

3497 
	}
}

3499 c⁄° 
IP_INTERFACE_INFO
 *

3500 
	$gë_öãrÁ˚_öfo_li°
 (
gc_¨ía
 *
gc
)

3502 
ULONG
 
size
 = 0;

3503 
IP_INTERFACE_INFO
 *
ii
 = 
NULL
;

3504 
DWORD
 
°©us
;

3506 i‡((
°©us
 = 
	`GëI¡îÁ˚Info
 (
NULL
, &
size
)Ë!
ERROR_INSUFFICIENT_BUFFER
)

3508 
	`msg
 (
M_INFO
, "GetInterfaceInfo #1 failed (status=%u) : %s",

3509 ()
°©us
,

3510 
	`°ªº‹_wö32
 (
°©us
, 
gc
));

3514 
ii
 = (
PIP_INTERFACE_INFO
Ë
	`gc_mÆloc
 (
size
, 
Ál£
, 
gc
);

3515 i‡((
°©us
 = 
	`GëI¡îÁ˚Info
 (
ii
, &
size
)Ë=
NO_ERROR
)

3516  
ii
;

3519 
	`msg
 (
M_INFO
, "GetInterfaceInfo #2 failed (status=%u) : %s",

3520 ()
°©us
,

3521 
	`°ªº‹_wö32
 (
°©us
, 
gc
));

3524  
ii
;

3525 
	}
}

3527 c⁄° 
IP_ADAPTER_INDEX_MAP
 *

3528 
	$gë_öãrÁ˚_öfo
 (
DWORD
 
ödex
, 
gc_¨ía
 *
gc
)

3530 c⁄° 
IP_INTERFACE_INFO
 *
li°
 = 
	`gë_öãrÁ˚_öfo_li°
 (
gc
);

3531 i‡(
li°
)

3533 
i
;

3534 
i
 = 0; i < 
li°
->
NumAd≠ãrs
; ++i)

3536 c⁄° 
IP_ADAPTER_INDEX_MAP
 *
öãr
 = &
li°
->
Ad≠ãr
[
i
];

3537 i‡(
ödex
 =
öãr
->
Index
)

3538  
öãr
;

3541  
NULL
;

3542 
	}
}

3549 c⁄° 
IP_ADAPTER_INFO
 *

3550 
	$gë_ad≠ãr
 (c⁄° 
IP_ADAPTER_INFO
 *
ai
, 
DWORD
 
ödex
)

3552 i‡(
ai
 && 
ödex
 !
TUN_ADAPTER_INDEX_INVALID
)

3554 c⁄° 
IP_ADAPTER_INFO
 *
a
;

3557 
a
 = 
ai
;á !
NULL
;á =á->
Next
)

3559 i‡(
a
->
Index
 =
ödex
)

3560  
a
;

3563  
NULL
;

3564 
	}
}

3566 c⁄° 
IP_ADAPTER_INFO
 *

3567 
	$gë_ad≠ãr_öfo
 (
DWORD
 
ödex
, 
gc_¨ía
 *
gc
)

3569  
	`gë_ad≠ãr
 (
	`gë_ad≠ãr_öfo_li°
 (
gc
), 
ödex
);

3570 
	}
}

3573 
	$gë_ad≠ãr_n_ù_√tmask
 (c⁄° 
IP_ADAPTER_INFO
 *
ai
)

3575 i‡(
ai
)

3577 
n
 = 0;

3578 c⁄° 
IP_ADDR_STRING
 *
ù
 = &
ai
->
IpAddªssLi°
;

3580 
ù
)

3582 ++
n
;

3583 
ù
 = ip->
Next
;

3585  
n
;

3589 
	}
}

3591 
boﬁ


3592 
	$gë_ad≠ãr_ù_√tmask
 (c⁄° 
IP_ADAPTER_INFO
 *
ai
, c⁄° 
n
, 
ö_addr_t
 *
ù
, in_addr_à*
√tmask
)

3594 
boﬁ
 
ªt
 = 
Ál£
;

3595 *
ù
 = 0;

3596 *
√tmask
 = 0;

3598 i‡(
ai
)

3600 c⁄° 
IP_ADDR_STRING
 *
ùli°
 = &
ai
->
IpAddªssLi°
;

3601 
i
 = 0;

3603 
ùli°
)

3605 i‡(
i
 =
n
)

3607 ++
i
;

3608 
ùli°
 = i∂i°->
Next
;

3611 i‡(
ùli°
)

3613 c⁄° 
gëaddr_Êags
 = 
GETADDR_HOST_ORDER
;

3614 c⁄° *
ù_°r
 = 
ùli°
->
IpAddªss
.
Såög
;

3615 c⁄° *
√tmask_°r
 = 
ùli°
->
IpMask
.
Såög
;

3616 
boﬁ
 
suc˚ed1
 = 
Ál£
;

3617 
boﬁ
 
suc˚ed2
 = 
Ál£
;

3619 i‡(
ù_°r
 && 
√tmask_°r
 && 
	`°æí
 (ip_str) && strlen (netmask_str))

3621 *
ù
 = 
	`gëaddr
 (
gëaddr_Êags
, 
ù_°r
, 0, &
suc˚ed1
, 
NULL
);

3622 *
√tmask
 = 
	`gëaddr
 (
gëaddr_Êags
, 
√tmask_°r
, 0, &
suc˚ed2
, 
NULL
);

3623 
ªt
 = (
suc˚ed1
 =
åue
 && 
suc˚ed2
 ==Årue);

3628  
ªt
;

3629 
	}
}

3631 
boﬁ


3632 
	$ã°_ad≠ãr_ù_√tmask
 (c⁄° 
IP_ADAPTER_INFO
 *
ai
, c⁄° 
ö_addr_t
 
ù
, c⁄° in_addr_à
√tmask
)

3634 i‡(
ai
)

3636 
ö_addr_t
 
ù_ad≠ãr
 = 0;

3637 
ö_addr_t
 
√tmask_ad≠ãr
 = 0;

3638 c⁄° 
boﬁ
 
°©us
 = 
	`gë_ad≠ãr_ù_√tmask
 (
ai
, 0, &
ù_ad≠ãr
, &
√tmask_ad≠ãr
);

3639  (
°©us
 && 
ù_ad≠ãr
 =
ù
 && 
√tmask_ad≠ãr
 =
√tmask
);

3642  
Ál£
;

3643 
	}
}

3645 c⁄° 
IP_ADAPTER_INFO
 *

3646 
	$gë_tun_ad≠ãr
 (c⁄° 
tu¡≠
 *
â
, c⁄° 
IP_ADAPTER_INFO
 *
li°
)

3648 i‡(
li°
 && 
â
)

3649  
	`gë_ad≠ãr
 (
li°
, 
â
->
ad≠ãr_ödex
);

3651  
NULL
;

3652 
	}
}

3654 
boﬁ


3655 
	$is_ad≠ãr_up
 (c⁄° 
tu¡≠
 *
â
, c⁄° 
IP_ADAPTER_INFO
 *
li°
)

3657 
i
;

3658 
boﬁ
 
ªt
 = 
Ál£
;

3660 c⁄° 
IP_ADAPTER_INFO
 *
ai
 = 
	`gë_tun_ad≠ãr
 (
â
, 
li°
);

3662 i‡(
ai
)

3664 c⁄° 
n
 = 
	`gë_ad≠ãr_n_ù_√tmask
 (
ai
);

3667 
i
 = 0; i < 
n
; ++i)

3669 
ö_addr_t
 
ù
, 
√tmask
;

3670 i‡(
	`gë_ad≠ãr_ù_√tmask
 (
ai
, 
i
, &
ù
, &
√tmask
))

3672 i‡(
â
->
loˇl
 &&Åt->
ad≠ãr_√tmask
)

3675 i‡(
â
->
loˇl
 =
ù
 &&Åt->
ad≠ãr_√tmask
 =
√tmask
)

3676 
ªt
 = 
åue
;

3681 i‡(
ù
 && 
√tmask
)

3682 
ªt
 = 
åue
;

3688 
ªt
 = 
åue
;

3690  
ªt
;

3691 
	}
}

3693 
boﬁ


3694 
	$is_ù_ö_ad≠ãr_sub√t
 (c⁄° 
IP_ADAPTER_INFO
 *
ai
, c⁄° 
ö_addr_t
 
ù
, in_addr_à*
highe°_√tmask
)

3696 
i
;

3697 
boﬁ
 
ªt
 = 
Ál£
;

3699 i‡(
highe°_√tmask
)

3700 *
highe°_√tmask
 = 0;

3702 i‡(
ai
)

3704 c⁄° 
n
 = 
	`gë_ad≠ãr_n_ù_√tmask
 (
ai
);

3705 
i
 = 0; i < 
n
; ++i)

3707 
ö_addr_t
 
ad≠ãr_ù
, 
ad≠ãr_√tmask
;

3708 i‡(
	`gë_ad≠ãr_ù_√tmask
 (
ai
, 
i
, &
ad≠ãr_ù
, &
ad≠ãr_√tmask
))

3710 i‡(
ad≠ãr_ù
 && 
ad≠ãr_√tmask
 && (
ù
 &ádapter_netmask) == (adapter_ip &ádapter_netmask))

3712 i‡(
highe°_√tmask
 && 
ad≠ãr_√tmask
 > *highest_netmask)

3713 *
highe°_√tmask
 = 
ad≠ãr_√tmask
;

3714 
ªt
 = 
åue
;

3719  
ªt
;

3720 
	}
}

3722 
DWORD


3723 
	$ad≠ãr_ödex_of_ù
 (c⁄° 
IP_ADAPTER_INFO
 *
li°
,

3724 c⁄° 
ö_addr_t
 
ù
,

3725 *
cou¡
,

3726 
ö_addr_t
 *
√tmask
)

3728 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3729 
DWORD
 
ªt
 = 
TUN_ADAPTER_INDEX_INVALID
;

3730 
ö_addr_t
 
highe°_√tmask
 = 0;

3731 
boﬁ
 
fú°
 = 
åue
;

3733 i‡(
cou¡
)

3734 *
cou¡
 = 0;

3736 
li°
)

3738 
ö_addr_t
 
hn
;

3740 i‡(
	`is_ù_ö_ad≠ãr_sub√t
 (
li°
, 
ù
, &
hn
))

3742 i‡(
fú°
 || 
hn
 > 
highe°_√tmask
)

3744 
highe°_√tmask
 = 
hn
;

3745 i‡(
cou¡
)

3746 *
cou¡
 = 1;

3747 
ªt
 = 
li°
->
Index
;

3748 
fú°
 = 
Ál£
;

3750 i‡(
hn
 =
highe°_√tmask
)

3752 i‡(
cou¡
)

3753 ++*
cou¡
;

3756 
li°
 =Üi°->
Next
;

3759 
	`dmsg
 (
D_ROUTE_DEBUG
, "DEBUG: IP Locate: ip=%sÇm=%s index=%d count=%d",

3760 
	`¥öt_ö_addr_t
 (
ù
, 0, &
gc
),

3761 
	`¥öt_ö_addr_t
 (
highe°_√tmask
, 0, &
gc
),

3762 ()
ªt
,

3763 
cou¡
 ? *count : -1);

3765 i‡(
ªt
 =
TUN_ADAPTER_INDEX_INVALID
 && 
cou¡
)

3766 *
cou¡
 = 0;

3768 i‡(
√tmask
)

3769 *
√tmask
 = 
highe°_√tmask
;

3771 
	`gc_‰ì
 (&
gc
);

3772  
ªt
;

3773 
	}
}

3780 
	#DHCP_STATUS_UNDEF
 0

	)

3781 
	#DHCP_STATUS_ENABLED
 1

	)

3782 
	#DHCP_STATUS_DISABLED
 2

	)

3785 
	$dh˝_°©us
 (
DWORD
 
ödex
)

3787 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3788 
ªt
 = 
DHCP_STATUS_UNDEF
;

3789 i‡(
ödex
 !
TUN_ADAPTER_INDEX_INVALID
)

3791 c⁄° 
IP_ADAPTER_INFO
 *
ai
 = 
	`gë_ad≠ãr_öfo
 (
ödex
, &
gc
);

3793 i‡(
ai
)

3795 i‡(
ai
->
Dh˝E«bÀd
)

3796 
ªt
 = 
DHCP_STATUS_ENABLED
;

3798 
ªt
 = 
DHCP_STATUS_DISABLED
;

3801 
	`gc_‰ì
 (&
gc
);

3802  
ªt
;

3803 
	}
}

3810 
	$dñëe_ãmp_addªs£s
 (
DWORD
 
ödex
)

3812 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3813 c⁄° 
IP_ADAPTER_INFO
 *
a
 = 
	`gë_ad≠ãr_öfo
 (
ödex
, &
gc
);

3815 i‡(
a
)

3817 c⁄° 
IP_ADDR_STRING
 *
ù
 = &
a
->
IpAddªssLi°
;

3818 
ù
)

3820 
DWORD
 
°©us
;

3821 c⁄° 
DWORD
 
c⁄ãxt
 = 
ù
->
C⁄ãxt
;

3823 i‡((
°©us
 = 
	`DñëeIPAddªss
 ((
ULONG
Ë
c⁄ãxt
)Ë=
NO_ERROR
)

3825 
	`msg
 (
M_INFO
, "Successfully deletedÖreviously set dynamic IP/netmask: %s/%s",

3826 
ù
->
IpAddªss
.
Såög
,

3827 
ù
->
IpMask
.
Såög
);

3831 c⁄° *
em±y
 = "0.0.0.0";

3832 i‡(
	`°rcmp
 (
ù
->
IpAddªss
.
Såög
, 
em±y
)

3833 || 
	`°rcmp
 (
ù
->
IpMask
.
Såög
, 
em±y
))

3834 
	`msg
 (
M_INFO
, "NOTE: couldÇot deleteÖreviously set dynamic IP/netmask: %s/%s (status=%u)",

3835 
ù
->
IpAddªss
.
Såög
,

3836 
ù
->
IpMask
.
Såög
,

3837 ()
°©us
);

3839 
ù
 = ip->
Next
;

3842 
	`gc_‰ì
 (&
gc
);

3843 
	}
}

3848 
DWORD


3849 
	$gë_ad≠ãr_ödex_mëhod_1
 (c⁄° *
guid
)

3851 
DWORD
 
ödex
;

3852 
ULONG
 
aödex
;

3853 
wch¨_t
 
wbuf
[256];

3854 
	`_¢w¥ötf
 (
wbuf
, 
	`SIZE
 (wbuf), 
L
"\\DEVICE\\TCPIP_%S", 
guid
);

3855 
wbuf
 [
	`SIZE
(wbuf) - 1] = 0;

3856 i‡(
	`GëAd≠ãrIndex
 (
wbuf
, &
aödex
Ë!
NO_ERROR
)

3857 
ödex
 = 
TUN_ADAPTER_INDEX_INVALID
;

3859 
ödex
 = (
DWORD
)
aödex
;

3860  
ödex
;

3861 
	}
}

3863 
DWORD


3864 
	$gë_ad≠ãr_ödex_mëhod_2
 (c⁄° *
guid
)

3866 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3867 
DWORD
 
ödex
 = 
TUN_ADAPTER_INDEX_INVALID
;

3869 c⁄° 
IP_ADAPTER_INFO
 *
li°
 = 
	`gë_ad≠ãr_öfo_li°
 (&
gc
);

3871 
li°
)

3873 i‡(!
	`°rcmp
 (
guid
, 
li°
->
Ad≠ãrName
))

3875 
ödex
 = 
li°
->
Index
;

3878 
li°
 =Üi°->
Next
;

3881 
	`gc_‰ì
 (&
gc
);

3882  
ödex
;

3883 
	}
}

3885 
DWORD


3886 
	$gë_ad≠ãr_ödex
 (c⁄° *
guid
)

3888 
DWORD
 
ödex
;

3889 
ödex
 = 
	`gë_ad≠ãr_ödex_mëhod_1
 (
guid
);

3890 i‡(
ödex
 =
TUN_ADAPTER_INDEX_INVALID
)

3891 
ödex
 = 
	`gë_ad≠ãr_ödex_mëhod_2
 (
guid
);

3892 i‡(
ödex
 =
TUN_ADAPTER_INDEX_INVALID
)

3893 
	`msg
 (
M_INFO
, "NOTE: couldÇŸ gëád≠ã∏ödex f‹ %s", 
guid
);

3894  
ödex
;

3895 
	}
}

3897 
DWORD


3898 
	$gë_ad≠ãr_ödex_ÊexibÀ
 (c⁄° *
«me
)

3900 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3901 
DWORD
 
ödex
;

3902 
ödex
 = 
	`gë_ad≠ãr_ödex_mëhod_1
 (
«me
);

3903 i‡(
ödex
 =
TUN_ADAPTER_INDEX_INVALID
)

3904 
ödex
 = 
	`gë_ad≠ãr_ödex_mëhod_2
 (
«me
);

3905 i‡(
ödex
 =
TUN_ADAPTER_INDEX_INVALID
)

3907 c⁄° 
èp_ªg
 *èp_ªg = 
	`gë_èp_ªg
 (&
gc
);

3908 c⁄° 
∑√l_ªg
 *∑√l_ªg = 
	`gë_∑√l_ªg
 (&
gc
);

3909 c⁄° *
guid
 = 
	`«me_to_guid
 (
«me
, 
èp_ªg
, 
∑√l_ªg
);

3910 
ödex
 = 
	`gë_ad≠ãr_ödex_mëhod_1
 (
guid
);

3911 i‡(
ödex
 =
TUN_ADAPTER_INDEX_INVALID
)

3912 
ödex
 = 
	`gë_ad≠ãr_ödex_mëhod_2
 (
guid
);

3914 i‡(
ödex
 =
TUN_ADAPTER_INDEX_INVALID
)

3915 
	`msg
 (
M_INFO
, "NOTE: couldÇŸ gëád≠ã∏ödex f‹Çame/GUID '%s'", 
«me
);

3916 
	`gc_‰ì
 (&
gc
);

3917  
ödex
;

3918 
	}
}

3924 
	$f‹m©_ù_addr_°rög
 (c⁄° 
IP_ADDR_STRING
 *
ù
, 
gc_¨ía
 *
gc
)

3926 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

3927 
ù
)

3929 
	`buf_¥ötf
 (&
out
, "%s", 
ù
->
IpAddªss
.
Såög
);

3930 i‡(
	`°æí
 (
ù
->
IpMask
.
Såög
))

3932 
	`buf_¥ötf
 (&
out
, "/");

3933 
	`buf_¥ötf
 (&
out
, "%s", 
ù
->
IpMask
.
Såög
);

3935 
	`buf_¥ötf
 (&
out
, " ");

3936 
ù
 = ip->
Next
;

3938  
	`BSTR
 (&
out
);

3939 
	}
}

3945 
	$show_ad≠ãr
 (
msgÀv
, c⁄° 
IP_ADAPTER_INFO
 *
a
, 
gc_¨ía
 *
gc
)

3947 
	`msg
 (
msgÀv
, "%s", 
a
->
Des¸ùti⁄
);

3948 
	`msg
 (
msgÀv
, " Index = %d", ()
a
->
Index
);

3949 
	`msg
 (
msgÀv
, " GUID = %s", 
a
->
Ad≠ãrName
);

3950 
	`msg
 (
msgÀv
, " IP = %s", 
	`f‹m©_ù_addr_°rög
 (&
a
->
IpAddªssLi°
, 
gc
));

3951 
	`msg
 (
msgÀv
, " MAC = %s", 
	`f‹m©_hex_ex
 (
a
->
Addªss
,á->
AddªssLígth
, 0, 1, ":", 
gc
));

3952 
	`msg
 (
msgÀv
, " GATEWAY = %s", 
	`f‹m©_ù_addr_°rög
 (&
a
->
G©ewayLi°
, 
gc
));

3953 i‡(
a
->
Dh˝E«bÀd
)

3955 
	`msg
 (
msgÀv
, " DHCP SERV = %s", 
	`f‹m©_ù_addr_°rög
 (&
a
->
Dh˝Sîvî
, 
gc
));

3956 
	`msg
 (
msgÀv
, " DHCP LEASE OBTAINED = %s", 
	`time_°rög
 (
a
->
Ló£Obèöed
, 0, 
Ál£
, 
gc
));

3957 
	`msg
 (
msgÀv
, " DHCP LEASE EXPIRES = %s", 
	`time_°rög
 (
a
->
Ló£Expúes
, 0, 
Ál£
, 
gc
));

3959 i‡(
a
->
HaveWös
)

3961 
	`msg
 (
msgÀv
, " PRI WINS = %s", 
	`f‹m©_ù_addr_°rög
 (&
a
->
Prim¨yWösSîvî
, 
gc
));

3962 
	`msg
 (
msgÀv
, " SEC WINS = %s", 
	`f‹m©_ù_addr_°rög
 (&
a
->
Sec⁄d¨yWösSîvî
, 
gc
));

3966 c⁄° 
IP_PER_ADAPTER_INFO
 *
∑i
 = 
	`gë_≥r_ad≠ãr_öfo
 (
a
->
Index
, 
gc
);

3967 i‡(
∑i
)

3969 
	`msg
 (
msgÀv
, " DNS SERV = %s", 
	`f‹m©_ù_addr_°rög
 (&
∑i
->
DnsSîvîLi°
, 
gc
));

3972 
	}
}

3978 
	$show_ad≠ãrs
 (
msgÀv
)

3980 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

3981 c⁄° 
IP_ADAPTER_INFO
 *
ai
 = 
	`gë_ad≠ãr_öfo_li°
 (&
gc
);

3983 
	`msg
 (
msgÀv
, "SYSTEM ADAPTER LIST");

3984 i‡(
ai
)

3986 c⁄° 
IP_ADAPTER_INFO
 *
a
;

3989 
a
 = 
ai
;á !
NULL
;á =á->
Next
)

3991 
	`show_ad≠ãr
 (
msgÀv
, 
a
, &
gc
);

3994 
	`gc_‰ì
 (&
gc
);

3995 
	}
}

4005 
	$èp_Ælow_n⁄admö_ac˚ss_h™dÀ
 (c⁄° *
devi˚_∑th
, 
HANDLE
 
h™d
)

4007 
£curôy_©åibuãs
 
ß
;

4008 
BOOL
 
°©us
;

4010 i‡(!
	`öô_£curôy_©åibuãs_Ælow_Æl
 (&
ß
))

4011 
	`msg
 (
M_ERR
, "Error: init SA failed");

4013 
°©us
 = 
	`SëKî√lObje˘Securôy
 (
h™d
, 
DACL_SECURITY_INFORMATION
, &
ß
.
sd
);

4014 i‡(!
°©us
)

4016 
	`msg
 (
M_ERRNO
, "Eº‹: SëKî√lObje˘Securôy faûed o¿%s", 
devi˚_∑th
);

4020 
	`msg
 (
M_INFO
|
M_NOPREFIX
, "TAP-Wödow†devi˚: %†[N⁄-admöác˚s†Ælowed]", 
devi˚_∑th
);

4022 
	}
}

4025 
	$èp_Ælow_n⁄admö_ac˚ss
 (c⁄° *
dev_node
)

4027 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

4028 c⁄° 
èp_ªg
 *èp_ªg = 
	`gë_èp_ªg
 (&
gc
);

4029 c⁄° 
∑√l_ªg
 *∑√l_ªg = 
	`gë_∑√l_ªg
 (&
gc
);

4030 c⁄° *
devi˚_guid
 = 
NULL
;

4031 
HANDLE
 
h™d
;

4032 
a˘uÆ_buf„r
[256];

4033 
devi˚_∑th
[256];

4035 
	`©_Àa°_⁄e_èp_wö
 (
èp_ªg
);

4037 i‡(
dev_node
)

4040 
devi˚_guid
 = 
	`gë_devi˚_guid
 (
dev_node
, 
a˘uÆ_buf„r
,  (a˘uÆ_buf„r), 
èp_ªg
, 
∑√l_ªg
, &
gc
);

4042 i‡(!
devi˚_guid
)

4043 
	`msg
 (
M_FATAL
, "TAP-Wödow†ad≠ã∏'%s'ÇŸ found", 
dev_node
);

4046 
	`›ív≤_¢¥ötf
 (
devi˚_∑th
, (device_path), "%s%s%s",

4047 
USERMODEDEVICEDIR
,

4048 
devi˚_guid
,

4049 
TAP_WIN_SUFFIX
);

4051 
h™d
 = 
	`Cª©eFûe
 (

4052 
devi˚_∑th
,

4053 
MAXIMUM_ALLOWED
,

4056 
OPEN_EXISTING
,

4057 
FILE_ATTRIBUTE_SYSTEM
 | 
FILE_FLAG_OVERLAPPED
,

4061 i‡(
h™d
 =
INVALID_HANDLE_VALUE
)

4062 
	`msg
 (
M_ERR
, "Cª©eFûêÁûed o¿TAP devi˚: %s", 
devi˚_∑th
);

4064 
	`èp_Ælow_n⁄admö_ac˚ss_h™dÀ
 (
devi˚_∑th
, 
h™d
);

4065 
	`Clo£H™dÀ
 (
h™d
);

4069 
devi˚_numbî
 = 0;

4072 
åue
)

4074 
devi˚_guid
 = 
	`gë_un•ecifõd_devi˚_guid
 (
devi˚_numbî
,

4075 
a˘uÆ_buf„r
,

4076  (
a˘uÆ_buf„r
),

4077 
èp_ªg
,

4078 
∑√l_ªg
,

4079 &
gc
);

4081 i‡(!
devi˚_guid
)

4085 
	`›ív≤_¢¥ötf
 (
devi˚_∑th
, (device_path), "%s%s%s",

4086 
USERMODEDEVICEDIR
,

4087 
devi˚_guid
,

4088 
TAP_WIN_SUFFIX
);

4090 
h™d
 = 
	`Cª©eFûe
 (

4091 
devi˚_∑th
,

4092 
MAXIMUM_ALLOWED
,

4095 
OPEN_EXISTING
,

4096 
FILE_ATTRIBUTE_SYSTEM
 | 
FILE_FLAG_OVERLAPPED
,

4100 i‡(
h™d
 =
INVALID_HANDLE_VALUE
)

4101 
	`msg
 (
M_WARN
, "Cª©eFûêÁûed o¿TAP devi˚: %s", 
devi˚_∑th
);

4104 
	`èp_Ælow_n⁄admö_ac˚ss_h™dÀ
 (
devi˚_∑th
, 
h™d
);

4105 
	`Clo£H™dÀ
 (
h™d
);

4108 
devi˚_numbî
++;

4111 
	`gc_‰ì
 (&
gc
);

4112 
	}
}

4117 
boﬁ


4118 
	$dh˝_ªÀa£_by_ad≠ãr_ödex
(c⁄° 
DWORD
 
ad≠ãr_ödex
)

4120 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

4121 
boﬁ
 
ªt
 = 
Ál£
;

4122 c⁄° 
IP_ADAPTER_INDEX_MAP
 *
öãr
 = 
	`gë_öãrÁ˚_öfo
 (
ad≠ãr_ödex
, &
gc
);

4124 i‡(
öãr
)

4126 
DWORD
 
°©us
 = 
	`IpRñó£Addªss
 ((
IP_ADAPTER_INDEX_MAP
 *)
öãr
);

4127 i‡(
°©us
 =
NO_ERROR
)

4129 
	`msg
 (
D_TUNTAP_INFO
, "TAP: DHCPáddressÑeleased");

4130 
ªt
 = 
åue
;

4133 
	`msg
 (
M_WARN
, "NOTE: Release of DHCP-assigned IPáddressÜease on TAP-Windowsádapter failed: %s (code=%u)",

4134 
	`°ªº‹_wö32
 (
°©us
, &
gc
),

4135 ()
°©us
);

4138 
	`gc_‰ì
 (&
gc
);

4139  
ªt
;

4140 
	}
}

4142 
boﬁ


4143 
	$dh˝_ªÀa£
 (c⁄° 
tu¡≠
 *
â
)

4145 i‡(
â
 &&Åt->
›ti⁄s
.
ù_wö32_ty≥
 =
IPW32_SET_DHCP_MASQ
 &&Åt->
ad≠ãr_ödex
 !
TUN_ADAPTER_INDEX_INVALID
)

4146  
	`dh˝_ªÀa£_by_ad≠ãr_ödex
 (
â
->
ad≠ãr_ödex
);

4148  
Ál£
;

4149 
	}
}

4151 
boﬁ


4152 
	$dh˝_ª√w_by_ad≠ãr_ödex
 (c⁄° 
DWORD
 
ad≠ãr_ödex
)

4154 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

4155 
boﬁ
 
ªt
 = 
Ál£
;

4156 c⁄° 
IP_ADAPTER_INDEX_MAP
 *
öãr
 = 
	`gë_öãrÁ˚_öfo
 (
ad≠ãr_ödex
, &
gc
);

4158 i‡(
öãr
)

4160 
DWORD
 
°©us
 = 
	`IpRíewAddªss
 ((
IP_ADAPTER_INDEX_MAP
 *)
öãr
);

4161 i‡(
°©us
 =
NO_ERROR
)

4163 
	`msg
 (
D_TUNTAP_INFO
, "TAP: DHCPáddressÑenewal succeeded");

4164 
ªt
 = 
åue
;

4167 
	`msg
 (
M_WARN
, "WARNING: FailedÅoÑenew DHCP IPáddressÜease on TAP-Windowsádapter: %s (code=%u)",

4168 
	`°ªº‹_wö32
 (
°©us
, &
gc
),

4169 ()
°©us
);

4171 
	`gc_‰ì
 (&
gc
);

4172  
ªt
;

4173 
	}
}

4175 
boﬁ


4176 
	$dh˝_ª√w
 (c⁄° 
tu¡≠
 *
â
)

4178 i‡(
â
 &&Åt->
›ti⁄s
.
ù_wö32_ty≥
 =
IPW32_SET_DHCP_MASQ
 &&Åt->
ad≠ãr_ödex
 !
TUN_ADAPTER_INDEX_INVALID
)

4179  
	`dh˝_ª√w_by_ad≠ãr_ödex
 (
â
->
ad≠ãr_ödex
);

4181  
Ál£
;

4182 
	}
}

4189 
	$√tsh_comm™d
 (c⁄° 
¨gv
 *
a
, 
n
)

4191 
i
;

4192 
i
 = 0; i < 
n
; ++i)

4194 
boﬁ
 
°©us
;

4195 
	`›ív≤_¶ìp
 (1);

4196 
	`√tcmd_£m≠h‹e_lock
 ();

4197 
	`¨gv_msg_¥efix
 (
M_INFO
, 
a
, "NETSH");

4198 
°©us
 = 
	`›ív≤_execve_check
 (
a
, 
NULL
, 0, "ERROR:Çetsh command failed");

4199 
	`√tcmd_£m≠h‹e_ªÀa£
 ();

4200 i‡(
°©us
)

4202 
	`›ív≤_¶ìp
 (4);

4204 
	`msg
 (
M_FATAL
, "NETSH: command failed");

4205 
	}
}

4208 
	$ùc⁄fig_ªgi°î_dns
 (c⁄° 
ív_£t
 *
es
)

4210 
¨gv
árgv;

4211 
boﬁ
 
°©us
;

4212 c⁄° 
îr
[] = "ERROR: Windows ipconfig command failed";

4214 
	`msg
 (
D_TUNTAP_INFO
, "StartÇet commands...");

4215 
	`√tcmd_£m≠h‹e_lock
 ();

4217 
	`¨gv_öô
 (&
¨gv
);

4219 
	`¨gv_¥ötf
 (&
¨gv
, "%s%sc stop dnscache",

4220 
	`gë_wö_sys_∑th
(),

4221 
WIN_NET_PATH_SUFFIX
);

4222 
	`¨gv_msg
 (
D_TUNTAP_INFO
, &
¨gv
);

4223 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, 
îr
);

4224 
	`¨gv_ª£t
(&
¨gv
);

4226 
	`¨gv_¥ötf
 (&
¨gv
, "%s%sc start dnscache",

4227 
	`gë_wö_sys_∑th
(),

4228 
WIN_NET_PATH_SUFFIX
);

4229 
	`¨gv_msg
 (
D_TUNTAP_INFO
, &
¨gv
);

4230 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, 
îr
);

4231 
	`¨gv_ª£t
(&
¨gv
);

4233 
	`¨gv_¥ötf
 (&
¨gv
, "%s%sc /flushdns",

4234 
	`gë_wö_sys_∑th
(),

4235 
WIN_IPCONFIG_PATH_SUFFIX
);

4236 
	`¨gv_msg
 (
D_TUNTAP_INFO
, &
¨gv
);

4237 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, 
îr
);

4238 
	`¨gv_ª£t
(&
¨gv
);

4240 
	`¨gv_¥ötf
 (&
¨gv
, "%s%sc /registerdns",

4241 
	`gë_wö_sys_∑th
(),

4242 
WIN_IPCONFIG_PATH_SUFFIX
);

4243 
	`¨gv_msg
 (
D_TUNTAP_INFO
, &
¨gv
);

4244 
°©us
 = 
	`›ív≤_execve_check
 (&
¨gv
, 
es
, 0, 
îr
);

4245 
	`¨gv_ª£t
(&
¨gv
);

4247 
	`√tcmd_£m≠h‹e_ªÀa£
 ();

4248 
	`msg
 (
D_TUNTAP_INFO
, "EndÇet commands...");

4249 
	}
}

4252 
	$ù_addr_°rög_to_¨øy
 (
ö_addr_t
 *
de°
, *
de°_Àn
, c⁄° 
IP_ADDR_STRING
 *
§c
)

4254 
i
 = 0;

4255 
§c
)

4257 c⁄° 
gëaddr_Êags
 = 
GETADDR_HOST_ORDER
;

4258 c⁄° *
ù_°r
 = 
§c
->
IpAddªss
.
Såög
;

4259 
ö_addr_t
 
ù
 = 0;

4260 
boﬁ
 
suc˚ed
 = 
Ál£
;

4262 i‡(
i
 >*
de°_Àn
)

4264 i‡(!
ù_°r
 || !
	`°æí
 (ip_str))

4267 
ù
 = 
	`gëaddr
 (
gëaddr_Êags
, 
ù_°r
, 0, &
suc˚ed
, 
NULL
);

4268 i‡(!
suc˚ed
)

4270 
de°
[
i
++] = 
ù
;

4272 
§c
 = src->
Next
;

4274 *
de°_Àn
 = 
i
;

4278 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

4279 
	`msg
 (
M_INFO
, "ù_addr_°rög_to_¨øy [%d]", *
de°_Àn
);

4280 
i
 = 0; i < *
de°_Àn
; ++i)

4282 
	`msg
 (
M_INFO
, "%s", 
	`¥öt_ö_addr_t
 (
de°
[
i
], 0, &
gc
));

4284 
	`gc_‰ì
 (&
gc
);

4287 
	}
}

4289 
boﬁ


4290 
	$ù_addr_⁄e_to_⁄e
 (c⁄° 
ö_addr_t
 *
a1
, c⁄° 
a1Àn
, c⁄° 
IP_ADDR_STRING
 *
üs
)

4292 
ö_addr_t
 
a2
[8];

4293 
a2Àn
 = 
	`SIZE
(
a2
);

4294 
i
;

4296 
	`ù_addr_°rög_to_¨øy
 (
a2
, &
a2Àn
, 
üs
);

4298 i‡(
a1Àn
 !
a2Àn
)

4299  
Ál£
;

4301 
i
 = 0; i < 
a1Àn
; ++i)

4303 i‡(
a1
[
i
] !
a2
[i])

4304  
Ál£
;

4306  
åue
;

4307 
	}
}

4309 
boﬁ


4310 
	$ù_addr_membî_of
 (c⁄° 
ö_addr_t
 
addr
, c⁄° 
IP_ADDR_STRING
 *
üs
)

4312 
ö_addr_t
 
Ø
[8];

4313 
Àn
 = 
	`SIZE
(
Ø
);

4314 
i
;

4316 
	`ù_addr_°rög_to_¨øy
 (
Ø
, &
Àn
, 
üs
);

4317 
i
 = 0; i < 
Àn
; ++i)

4319 i‡(
addr
 =
Ø
[
i
])

4320  
åue
;

4322  
Ál£
;

4323 
	}
}

4326 
	$√tsh_ifc⁄fig_›ti⁄s
 (c⁄° *
ty≥
,

4327 c⁄° 
ö_addr_t
 *
addr_li°
,

4328 c⁄° 
addr_Àn
,

4329 c⁄° 
IP_ADDR_STRING
 *
cuºít
,

4330 c⁄° *
Êex_«me
,

4331 c⁄° 
boﬁ
 
ã°_fú°
)

4333 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

4334 
¨gv
árgv = 
	`¨gv_√w
 ();

4335 
boﬁ
 
dñëe_fú°
 = 
Ál£
;

4338 i‡(
ã°_fú°
)

4340 i‡(!
	`ù_addr_⁄e_to_⁄e
 (
addr_li°
, 
addr_Àn
, 
cuºít
))

4341 
dñëe_fú°
 = 
åue
;

4344 
dñëe_fú°
 = 
åue
;

4347 i‡(
dñëe_fú°
)

4349 
	`¨gv_¥ötf
 (&
¨gv
, "%s%sc interface ip delete %s %sáll",

4350 
	`gë_wö_sys_∑th
(),

4351 
NETSH_PATH_SUFFIX
,

4352 
ty≥
,

4353 
Êex_«me
);

4354 
	`√tsh_comm™d
 (&
¨gv
, 2);

4359 
cou¡
 = 0;

4360 
i
;

4361 
i
 = 0; i < 
addr_Àn
; ++i)

4363 i‡(
dñëe_fú°
 || !
ã°_fú°
 || !
	`ù_addr_membî_of
 (
addr_li°
[
i
], 
cuºít
))

4365 c⁄° *
fmt
 = 
cou¡
 ?

4369 
	`¨gv_¥ötf
 (&
¨gv
, 
fmt
,

4370 
	`gë_wö_sys_∑th
(),

4371 
NETSH_PATH_SUFFIX
,

4372 
ty≥
,

4373 
Êex_«me
,

4374 
	`¥öt_ö_addr_t
 (
addr_li°
[
i
], 0, &
gc
));

4375 
	`√tsh_comm™d
 (&
¨gv
, 2);

4377 ++
cou¡
;

4381 
	`msg
 (
M_INFO
, "NETSH: \"%s\" %s %s [already set]",

4382 
Êex_«me
,

4383 
ty≥
,

4384 
	`¥öt_ö_addr_t
 (
addr_li°
[
i
], 0, &
gc
));

4389 
	`¨gv_ª£t
 (&
¨gv
);

4390 
	`gc_‰ì
 (&
gc
);

4391 
	}
}

4394 
	$öô_ù_addr_°rög2
 (
IP_ADDR_STRING
 *
de°
, c⁄° IP_ADDR_STRING *
§c1
, c⁄° IP_ADDR_STRING *
§c2
)

4396 
	`CLEAR
 (
de°
[0]);

4397 
	`CLEAR
 (
de°
[1]);

4398 i‡(
§c1
)

4400 
de°
[0] = *
§c1
;

4401 
de°
[0].
Next
 = 
NULL
;

4403 i‡(
§c2
)

4405 
de°
[1] = *
§c2
;

4406 
de°
[0].
Next
 = &dest[1];

4407 
de°
[1].
Next
 = 
NULL
;

4409 
	}
}

4412 
	$√tsh_ifc⁄fig
 (c⁄° 
tu¡≠_›ti⁄s
 *
to
,

4413 c⁄° *
Êex_«me
,

4414 c⁄° 
ö_addr_t
 
ù
,

4415 c⁄° 
ö_addr_t
 
√tmask
,

4416 c⁄° 
Êags
)

4418 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

4419 
¨gv
árgv = 
	`¨gv_√w
 ();

4420 c⁄° 
IP_ADAPTER_INFO
 *
ai
 = 
NULL
;

4421 c⁄° 
IP_PER_ADAPTER_INFO
 *
∑i
 = 
NULL
;

4423 i‡(
Êags
 & 
NI_TEST_FIRST
)

4425 c⁄° 
IP_ADAPTER_INFO
 *
li°
 = 
	`gë_ad≠ãr_öfo_li°
 (&
gc
);

4426 c⁄° 
ödex
 = 
	`gë_ad≠ãr_ödex_ÊexibÀ
 (
Êex_«me
);

4427 
ai
 = 
	`gë_ad≠ãr
 (
li°
, 
ödex
);

4428 
∑i
 = 
	`gë_≥r_ad≠ãr_öfo
 (
ödex
, &
gc
);

4431 i‡(
Êags
 & 
NI_IP_NETMASK
)

4433 i‡(
	`ã°_ad≠ãr_ù_√tmask
 (
ai
, 
ù
, 
√tmask
))

4435 
	`msg
 (
M_INFO
, "NETSH: \"%s\" %s/%s [already set]",

4436 
Êex_«me
,

4437 
	`¥öt_ö_addr_t
 (
ù
, 0, &
gc
),

4438 
	`¥öt_ö_addr_t
 (
√tmask
, 0, &
gc
));

4443 
	`¨gv_¥ötf
 (&
¨gv
, "%s%sc interface ip setáddress %s static %s %s",

4444 
	`gë_wö_sys_∑th
(),

4445 
NETSH_PATH_SUFFIX
,

4446 
Êex_«me
,

4447 
	`¥öt_ö_addr_t
 (
ù
, 0, &
gc
),

4448 
	`¥öt_ö_addr_t
 (
√tmask
, 0, &
gc
));

4450 
	`√tsh_comm™d
 (&
¨gv
, 4);

4455 i‡(
Êags
 & 
NI_OPTIONS
)

4457 
IP_ADDR_STRING
 
wös
[2];

4458 
	`CLEAR
 (
wös
[0]);

4459 
	`CLEAR
 (
wös
[1]);

4461 
	`√tsh_ifc⁄fig_›ti⁄s
 ("dns",

4462 
to
->
dns
,

4463 
to
->
dns_Àn
,

4464 
∑i
 ? &∑i->
DnsSîvîLi°
 : 
NULL
,

4465 
Êex_«me
,

4466 
	`BOOL_CAST
 (
Êags
 & 
NI_TEST_FIRST
));

4467 i‡(
ai
 &&ái->
HaveWös
)

4468 
	`öô_ù_addr_°rög2
 (
wös
, &
ai
->
Prim¨yWösSîvî
, &ai->
Sec⁄d¨yWösSîvî
);

4470 
	`√tsh_ifc⁄fig_›ti⁄s
 ("wins",

4471 
to
->
wös
,

4472 
to
->
wös_Àn
,

4473 
ai
 ? 
wös
 : 
NULL
,

4474 
Êex_«me
,

4475 
	`BOOL_CAST
 (
Êags
 & 
NI_TEST_FIRST
));

4478 
	`¨gv_ª£t
 (&
¨gv
);

4479 
	`gc_‰ì
 (&
gc
);

4480 
	}
}

4483 
	$√tsh_íabÀ_dh˝
 (c⁄° 
tu¡≠_›ti⁄s
 *
to
,

4484 c⁄° *
a˘uÆ_«me
)

4486 
¨gv
árgv;

4487 
	`¨gv_öô
 (&
¨gv
);

4490 
	`¨gv_¥ötf
 (&
¨gv
,

4492 
	`gë_wö_sys_∑th
(),

4493 
NETSH_PATH_SUFFIX
,

4494 
a˘uÆ_«me
);

4496 
	`√tsh_comm™d
 (&
¨gv
, 4);

4498 
	`¨gv_ª£t
 (&
¨gv
);

4499 
	}
}

4505 
	$√tsh_gë_id
 (c⁄° *
dev_node
, 
gc_¨ía
 *
gc
)

4507 c⁄° 
èp_ªg
 *èp_ªg = 
	`gë_èp_ªg
 (
gc
);

4508 c⁄° 
∑√l_ªg
 *∑√l_ªg = 
	`gë_∑√l_ªg
 (
gc
);

4509 
buf„r
 
a˘uÆ
 = 
	`Æloc_buf_gc
 (256, 
gc
);

4510 c⁄° *
guid
;

4512 
	`©_Àa°_⁄e_èp_wö
 (
èp_ªg
);

4514 i‡(
dev_node
)

4516 
guid
 = 
	`gë_devi˚_guid
 (
dev_node
, 
	`BPTR
 (&
a˘uÆ
), 
	`BCAP
 (&a˘uÆ), 
èp_ªg
, 
∑√l_ªg
, 
gc
);

4520 
guid
 = 
	`gë_un•ecifõd_devi˚_guid
 (0, 
	`BPTR
 (&
a˘uÆ
), 
	`BCAP
 (&a˘uÆ), 
èp_ªg
, 
∑√l_ªg
, 
gc
);

4522 i‡(
	`gë_un•ecifõd_devi˚_guid
 (1, 
NULL
, 0, 
èp_ªg
, 
∑√l_ªg
, 
gc
))

4523 
guid
 = 
NULL
;

4526 i‡(!
guid
)

4528 i‡(
	`°rcmp
 (
	`BPTR
 (&
a˘uÆ
), "NULL"))

4529  
	`BPTR
 (&
a˘uÆ
);

4531  
guid
;

4532 
	}
}

4538 
	$tun_°™dby_öô
 (
tu¡≠
 *
â
)

4540 
â
->
°™dby_ôî
 = 0;

4541 
	}
}

4543 
boﬁ


4544 
	$tun_°™dby
 (
tu¡≠
 *
â
)

4546 
boﬁ
 
ªt
 = 
åue
;

4547 ++
â
->
°™dby_ôî
;

4548 i‡(
â
->
›ti⁄s
.
ù_wö32_ty≥
 =
IPW32_SET_ADAPTIVE
)

4550 i‡(
â
->
°™dby_ôî
 =
IPW32_SET_ADAPTIVE_TRY_NETSH
)

4552 
	`msg
 (
M_INFO
, "NOTE:ÇowÅryingÇetsh (this mayÅake someÅime)");

4553 
	`√tsh_ifc⁄fig
 (&
â
->
›ti⁄s
,

4554 
â
->
a˘uÆ_«me
,

4555 
â
->
loˇl
,

4556 
â
->
ad≠ãr_√tmask
,

4557 
NI_TEST_FIRST
|
NI_IP_NETMASK
|
NI_OPTIONS
);

4559 i‡(
â
->
°™dby_ôî
 >
IPW32_SET_ADAPTIVE_TRY_NETSH
*2)

4561 
ªt
 = 
Ál£
;

4564  
ªt
;

4565 
	}
}

4573 
	$wrôe_dh˝_u8
 (
buf„r
 *
buf
, c⁄° 
ty≥
, c⁄° 
d©a
, 
boﬁ
 *
îr‹
)

4575 i‡(!
	`buf_ß„
 (
buf
, 3))

4577 *
îr‹
 = 
åue
;

4578 
	`msg
 (
M_WARN
, "write_dhcp_u8: buffer overflow building DHCP options");

4581 
	`buf_wrôe_u8
 (
buf
, 
ty≥
);

4582 
	`buf_wrôe_u8
 (
buf
, 1);

4583 
	`buf_wrôe_u8
 (
buf
, 
d©a
);

4584 
	}
}

4587 
	$wrôe_dh˝_u32_¨øy
 (
buf„r
 *
buf
, c⁄° 
ty≥
, c⁄° 
uöt32_t
 *
d©a
, c⁄° 
Àn
, 
boﬁ
 *
îr‹
)

4589 i‡(
Àn
 > 0)

4591 
i
;

4592 c⁄° 
size
 = 
Àn
 *  (
uöt32_t
);

4594 i‡(!
	`buf_ß„
 (
buf
, 2 + 
size
))

4596 *
îr‹
 = 
åue
;

4597 
	`msg
 (
M_WARN
, "write_dhcp_u32_array: buffer overflow building DHCP options");

4600 i‡(
size
 < 1 || size > 255)

4602 *
îr‹
 = 
åue
;

4603 
	`msg
 (
M_WARN
, "wrôe_dh˝_u32_¨øy: sizê(%dËmu° bê> 0ánd <255", 
size
);

4606 
	`buf_wrôe_u8
 (
buf
, 
ty≥
);

4607 
	`buf_wrôe_u8
 (
buf
, 
size
);

4608 
i
 = 0; i < 
Àn
; ++i)

4609 
	`buf_wrôe_u32
 (
buf
, 
d©a
[
i
]);

4611 
	}
}

4614 
	$wrôe_dh˝_°r
 (
buf„r
 *
buf
, c⁄° 
ty≥
, c⁄° *
°r
, 
boﬁ
 *
îr‹
)

4616 c⁄° 
Àn
 = 
	`°æí
 (
°r
);

4617 i‡(!
	`buf_ß„
 (
buf
, 2 + 
Àn
))

4619 *
îr‹
 = 
åue
;

4620 
	`msg
 (
M_WARN
, "write_dhcp_str: buffer overflow building DHCP options");

4623 i‡(
Àn
 < 1 ||Üen > 255)

4625 *
îr‹
 = 
åue
;

4626 
	`msg
 (
M_WARN
, "wrôe_dh˝_°r: såög '%s' mu° bê> 0 byã†™d <255 byãs", 
°r
);

4629 
	`buf_wrôe_u8
 (
buf
, 
ty≥
);

4630 
	`buf_wrôe_u8
 (
buf
, 
Àn
);

4631 
	`buf_wrôe
 (
buf
, 
°r
, 
Àn
);

4632 
	}
}

4634 
boﬁ


4635 
	$buûd_dh˝_›ti⁄s_°rög
 (
buf„r
 *
buf
, c⁄° 
tu¡≠_›ti⁄s
 *
o
)

4637 
boﬁ
 
îr‹
 = 
Ál£
;

4638 i‡(
o
->
domaö
)

4639 
	`wrôe_dh˝_°r
 (
buf
, 15, 
o
->
domaö
, &
îr‹
);

4641 i‡(
o
->
√tbios_sc›e
)

4642 
	`wrôe_dh˝_°r
 (
buf
, 47, 
o
->
√tbios_sc›e
, &
îr‹
);

4644 i‡(
o
->
√tbios_node_ty≥
)

4645 
	`wrôe_dh˝_u8
 (
buf
, 46, 
o
->
√tbios_node_ty≥
, &
îr‹
);

4647 
	`wrôe_dh˝_u32_¨øy
 (
buf
, 6, (
uöt32_t
*)
o
->
dns
, o->
dns_Àn
, &
îr‹
);

4648 
	`wrôe_dh˝_u32_¨øy
 (
buf
, 44, (
uöt32_t
*)
o
->
wös
, o->
wös_Àn
, &
îr‹
);

4649 
	`wrôe_dh˝_u32_¨øy
 (
buf
, 42, (
uöt32_t
*)
o
->
¡p
, o->
¡p_Àn
, &
îr‹
);

4650 
	`wrôe_dh˝_u32_¨øy
 (
buf
, 45, (
uöt32_t
*)
o
->
nbdd
, o->
nbdd_Àn
, &
îr‹
);

4655 i‡(
o
->
dißbÀ_nbt
)

4657 i‡(!
	`buf_ß„
 (
buf
, 8))

4659 
	`msg
 (
M_WARN
, "build_dhcp_options_string: buffer overflow building DHCP options");

4660  
Ál£
;

4662 
	`buf_wrôe_u8
 (
buf
, 43);

4663 
	`buf_wrôe_u8
 (
buf
, 6);

4664 
	`buf_wrôe_u8
 (
buf
, 0x001);

4665 
	`buf_wrôe_u8
 (
buf
, 4);

4666 
	`buf_wrôe_u32
 (
buf
, 0x002);

4668  !
îr‹
;

4669 
	}
}

4672 
	$f‹k_dh˝_a˘i⁄
 (
tu¡≠
 *
â
)

4674 i‡(
â
->
›ti⁄s
.
dh˝_¥e_ªÀa£
 ||Åt->›ti⁄s.
dh˝_ª√w
)

4676 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

4677 
buf„r
 
cmd
 = 
	`Æloc_buf_gc
 (256, &
gc
);

4678 c⁄° 
vîb
 = 3;

4679 c⁄° 
¥e_¶ìp
 = 1;

4681 
	`buf_¥ötf
 (&
cmd
, "›ív≤ --vîb %d --èp-¶ì∞%d", 
vîb
, 
¥e_¶ìp
);

4682 i‡(
â
->
›ti⁄s
.
dh˝_¥e_ªÀa£
)

4683 
	`buf_¥ötf
 (&
cmd
, " --dhcp-pre-release");

4684 i‡(
â
->
›ti⁄s
.
dh˝_ª√w
)

4685 
	`buf_¥ötf
 (&
cmd
, " --dhcp-renew");

4686 
	`buf_¥ötf
 (&
cmd
, " --dh˝-öã∫Æ %u", ()
â
->
ad≠ãr_ödex
);

4688 
	`f‹k_to_£lf
 (
	`BSTR
 (&
cmd
));

4689 
	`gc_‰ì
 (&
gc
);

4691 
	}
}

4694 
	$f‹k_ªgi°î_dns_a˘i⁄
 (
tu¡≠
 *
â
)

4696 i‡(
â
 &&Åt->
›ti⁄s
.
ªgi°î_dns
)

4698 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

4699 
buf„r
 
cmd
 = 
	`Æloc_buf_gc
 (256, &
gc
);

4700 c⁄° 
vîb
 = 3;

4702 
	`buf_¥ötf
 (&
cmd
, "›ív≤ --vîb %d --ªgi°î-dn†--rdns-öã∫Æ", 
vîb
);

4703 
	`f‹k_to_£lf
 (
	`BSTR
 (&
cmd
));

4704 
	`gc_‰ì
 (&
gc
);

4706 
	}
}

4708 
uöt32_t


4709 
	$dh˝_masq_addr
 (c⁄° 
ö_addr_t
 
loˇl
, c⁄° in_addr_à
√tmask
, c⁄° 
off£t
)

4711 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

4712 
ö_addr_t
 
dß
;

4714 i‡(
off£t
 < 0)

4715 
dß
 = (
loˇl
 | (~
√tmask
)Ë+ 
off£t
;

4717 
dß
 = (
loˇl
 & 
√tmask
Ë+ 
off£t
;

4719 i‡(
dß
 =
loˇl
)

4720 
	`msg
 (
M_FATAL
, "ERROR: Thîêi†®˛ash bëwì¿thê--ifc⁄figÜoˇ»addªs†™dÅhêöã∫Æ DHCP sîvîáddªs†-- bŸháª sëÅÿ%†--ÖÀa£ u£Åhê--ù-wö32 dy«mi¯›ti⁄Åÿchoo£á dif„ª¡ fªêaddªs†‰omÅhê--ifc⁄fig sub√àf‹Åhêöã∫Æ DHCP sîvî", 
	`¥öt_ö_addr_t
 (
dß
, 0, &
gc
));

4722 i‡((
loˇl
 & 
√tmask
Ë!(
dß
 &Çetmask))

4723 
	`msg
 (
M_FATAL
, "ERROR: --ip-win32 dynamic [offset] : offset is outside of --ifconfig subnet");

4725 
	`gc_‰ì
 (&
gc
);

4726  
	`ht⁄l
(
dß
);

4727 
	}
}

4730 
	$›í_tun
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
, 
tu¡≠
 *
â
)

4732 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

4733 
devi˚_∑th
[256];

4734 c⁄° *
devi˚_guid
 = 
NULL
;

4735 
DWORD
 
Àn
;

4736 
boﬁ
 
dh˝_masq
 = 
Ál£
;

4737 
boﬁ
 
dh˝_masq_po°
 = 
Ál£
;

4741 
	`msg
–
M_INFO
, "›í_tun,Åt->ùv6=%d", 
â
->
ùv6
 );

4743 i‡(
â
->
ty≥
 =
DEV_TYPE_NULL
)

4745 
	`›í_nuŒ
 (
â
);

4746 
	`gc_‰ì
 (&
gc
);

4749 i‡(
â
->
ty≥
 =
DEV_TYPE_TAP
 ||Åt->ty≥ =
DEV_TYPE_TUN
)

4755 
	`msg
 (
M_FATAL
|
M_NOPREFIX
, "Unknow¿vútuÆ devi˚Åy≥: '%s'", 
dev
);

4762 c⁄° 
èp_ªg
 *èp_ªg = 
	`gë_èp_ªg
 (&
gc
);

4763 c⁄° 
∑√l_ªg
 *∑√l_ªg = 
	`gë_∑√l_ªg
 (&
gc
);

4764 
a˘uÆ_buf„r
[256];

4766 
	`©_Àa°_⁄e_èp_wö
 (
èp_ªg
);

4768 i‡(
dev_node
)

4771 
devi˚_guid
 = 
	`gë_devi˚_guid
 (
dev_node
, 
a˘uÆ_buf„r
,  (a˘uÆ_buf„r), 
èp_ªg
, 
∑√l_ªg
, &
gc
);

4773 i‡(!
devi˚_guid
)

4774 
	`msg
 (
M_FATAL
, "TAP-Wödow†ad≠ã∏'%s'ÇŸ found", 
dev_node
);

4777 
	`›ív≤_¢¥ötf
 (
devi˚_∑th
, (device_path), "%s%s%s",

4778 
USERMODEDEVICEDIR
,

4779 
devi˚_guid
,

4780 
TAP_WIN_SUFFIX
);

4782 
â
->
h™d
 = 
	`Cª©eFûe
 (

4783 
devi˚_∑th
,

4784 
GENERIC_READ
 | 
GENERIC_WRITE
,

4787 
OPEN_EXISTING
,

4788 
FILE_ATTRIBUTE_SYSTEM
 | 
FILE_FLAG_OVERLAPPED
,

4792 i‡(
â
->
h™d
 =
INVALID_HANDLE_VALUE
)

4793 
	`msg
 (
M_ERR
, "Cª©eFûêÁûed o¿TAP devi˚: %s", 
devi˚_∑th
);

4797 
devi˚_numbî
 = 0;

4800 
åue
)

4802 
devi˚_guid
 = 
	`gë_un•ecifõd_devi˚_guid
 (
devi˚_numbî
,

4803 
a˘uÆ_buf„r
,

4804  (
a˘uÆ_buf„r
),

4805 
èp_ªg
,

4806 
∑√l_ªg
,

4807 &
gc
);

4809 i‡(!
devi˚_guid
)

4810 
	`msg
 (
M_FATAL
, "All TAP-Windowsádapters onÅhis systemáre currently in use.");

4813 
	`›ív≤_¢¥ötf
 (
devi˚_∑th
, (device_path), "%s%s%s",

4814 
USERMODEDEVICEDIR
,

4815 
devi˚_guid
,

4816 
TAP_WIN_SUFFIX
);

4818 
â
->
h™d
 = 
	`Cª©eFûe
 (

4819 
devi˚_∑th
,

4820 
GENERIC_READ
 | 
GENERIC_WRITE
,

4823 
OPEN_EXISTING
,

4824 
FILE_ATTRIBUTE_SYSTEM
 | 
FILE_FLAG_OVERLAPPED
,

4828 i‡(
â
->
h™d
 =
INVALID_HANDLE_VALUE
)

4829 
	`msg
 (
D_TUNTAP_INFO
, "Cª©eFûêÁûed o¿TAP devi˚: %s", 
devi˚_∑th
);

4833 
devi˚_numbî
++;

4839 
â
->
a˘uÆ_«me
 = 
	`°rög_Æloc
 (
a˘uÆ_buf„r
, 
NULL
);

4842 
	`msg
 (
M_INFO
, "TAP-WIN32 devi˚ [%s] o≥√d: %s", 
â
->
a˘uÆ_«me
, 
devi˚_∑th
);

4843 
â
->
ad≠ãr_ödex
 = 
	`gë_ad≠ãr_ödex
 (
devi˚_guid
);

4847 
ULONG
 
öfo
[3];

4848 
	`CLEAR
 (
öfo
);

4849 i‡(
	`Devi˚IoC⁄åﬁ
 (
â
->
h™d
, 
TAP_WIN_IOCTL_GET_VERSION
,

4850 &
öfo
,  (info),

4851 &
öfo
,  (öfo), &
Àn
, 
NULL
))

4853 
	`msg
 (
D_TUNTAP_INFO
, "TAP-Windows Driver Version %d.%d %s",

4854 (Ë
öfo
[0],

4855 (Ë
öfo
[1],

4856 (
öfo
[2] ? "(DEBUG)" : ""));

4859 i‡(!(
öfo
[0] =
TAP_WIN_MIN_MAJOR
 && info[1] >
TAP_WIN_MIN_MINOR
))

4860 
	`msg
 (
M_FATAL
, "ERROR: Thi†vîsi⁄ o‡" 
PACKAGE_NAME
 "Ñequiresá TAP-Windows driverÅhat isátÜeast version %d.%d -- If youÑecently upgraded your " PACKAGE_NAME " distribution,áÑeboot isÖrobablyÑequiredátÅhisÖointÅo get WindowsÅo seeÅheÇew driver.",

4861 
TAP_WIN_MIN_MAJOR
,

4862 
TAP_WIN_MIN_MINOR
);

4867 i‡–
â
->
ùv6
 &&Åt->
ty≥
 =
DEV_TYPE_TUN
 &&

4868 
öfo
[0] == 9 && info[1] < 8)

4870 
	`msg
–
M_INFO
, "WARNING: T≠-Wö32 drivî vîsi⁄ %d.%d d€†nŸ suµ‹àIPv6 i¿TUN mode. IPv6 wû»bêdißbÀd. UpgødêtÿT≠-Wö32 9.8 (2.2-bëa3Ññó£ o∏œãrË‹ u£ TAP modêtÿgë IPv6", (Ë
öfo
[0], () info[1] );

4871 
â
->
ùv6
 = 
Ál£
;

4876 i‡–
â
->
ty≥
 =
DEV_TYPE_TUN
 &&

4877 
öfo
[0] == 9 && info[1] == 8)

4879 
	`msg
–
M_FATAL
, "ERROR: T≠-Wö32 drivî vîsi⁄ %d.%d i†buggyÑeg¨dög smÆ»IPv4Öackë†ö TUN mode. UpgødêtÿT≠-Wö32 9.9 (2.2.2Ññó£ o∏œãrË‹ u£ TAP mode", (Ë
öfo
[0], () info[1] );

4885 
ULONG
 
mtu
;

4886 i‡(
	`Devi˚IoC⁄åﬁ
 (
â
->
h™d
, 
TAP_WIN_IOCTL_GET_MTU
,

4887 &
mtu
,  (mtu),

4888 &
mtu
,  (mtu), &
Àn
, 
NULL
))

4890 
â
->
po°_›í_mtu
 = (Ë
mtu
;

4891 
	`msg
 (
D_MTU_INFO
, "TAP-Wödow†MTU=%d", (Ë
mtu
);

4899 i‡(
â
->
did_ifc⁄fig_£tup
)

4901 i‡(
â
->
›ti⁄s
.
ù_wö32_ty≥
 =
IPW32_SET_DHCP_MASQ
)

4906 i‡(
	`dh˝_°©us
 (
â
->
ad≠ãr_ödex
Ë=
DHCP_STATUS_DISABLED
)

4907 
	`√tsh_íabÀ_dh˝
 (&
â
->
›ti⁄s
,Åt->
a˘uÆ_«me
);

4908 
dh˝_masq
 = 
åue
;

4909 
dh˝_masq_po°
 = 
åue
;

4911 i‡(
â
->
›ti⁄s
.
ù_wö32_ty≥
 =
IPW32_SET_ADAPTIVE
)

4916 i‡(
	`dh˝_°©us
 (
â
->
ad≠ãr_ödex
Ë!
DHCP_STATUS_ENABLED
)

4918 
	`√tsh_ifc⁄fig
 (&
â
->
›ti⁄s
,

4919 
â
->
a˘uÆ_«me
,

4920 
â
->
loˇl
,

4921 
â
->
ad≠ãr_√tmask
,

4922 
NI_TEST_FIRST
|
NI_IP_NETMASK
|
NI_OPTIONS
);

4926 
dh˝_masq
 = 
åue
;

4933 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

4935 i‡(!
â
->
did_ifc⁄fig_£tup
)

4937 
	`msg
 (
M_FATAL
, "ERROR: --devÅunálsoÑequires --ifconfig");

4940 i‡(
â
->
t›ﬁogy
 =
TOP_SUBNET
)

4942 
ö_addr_t
 
ï
[3];

4943 
BOOL
 
°©us
;

4945 
ï
[0] = 
	`ht⁄l
 (
â
->
loˇl
);

4946 
ï
[1] = 
	`ht⁄l
 (
â
->
loˇl
 &Åt->
ªmŸe_√tmask
);

4947 
ï
[2] = 
	`ht⁄l
 (
â
->
ªmŸe_√tmask
);

4949 
°©us
 = 
	`Devi˚IoC⁄åﬁ
 (
â
->
h™d
, 
TAP_WIN_IOCTL_CONFIG_TUN
,

4950 
ï
,  (ep),

4951 
ï
,  (ï), &
Àn
, 
NULL
);

4953 
	`msg
 (
°©us
 ? 
M_INFO
 : 
M_FATAL
, "Set TAP-Windows TUN subnet modeÇetwork/local/netmask = %s/%s/%s [%s]",

4954 
	`¥öt_ö_addr_t
 (
ï
[1], 
IA_NET_ORDER
, &
gc
),

4955 
	`¥öt_ö_addr_t
 (
ï
[0], 
IA_NET_ORDER
, &
gc
),

4956 
	`¥öt_ö_addr_t
 (
ï
[2], 
IA_NET_ORDER
, &
gc
),

4957 
°©us
 ? "SUCCEEDED" : "FAILED");

4961 
ö_addr_t
 
ï
[2];

4962 
ï
[0] = 
	`ht⁄l
 (
â
->
loˇl
);

4963 
ï
[1] = 
	`ht⁄l
 (
â
->
ªmŸe_√tmask
);

4965 i‡(!
	`Devi˚IoC⁄åﬁ
 (
â
->
h™d
, 
TAP_WIN_IOCTL_CONFIG_POINT_TO_POINT
,

4966 
ï
,  (ep),

4967 
ï
,  (ï), &
Àn
, 
NULL
))

4968 
	`msg
 (
M_FATAL
, "ERROR: The TAP-Windows driverÑejectedá DeviceIoControl callÅo set Point-to-Point mode, which isÑequired for --devÅun");

4974 i‡(
dh˝_masq
)

4976 
uöt32_t
 
ï
[4];

4979 
ï
[0] = 
	`ht⁄l
 (
â
->
loˇl
);

4980 
ï
[1] = 
	`ht⁄l
 (
â
->
ad≠ãr_√tmask
);

4983 i‡(
â
->
ty≥
 =
DEV_TYPE_TUN
)

4985 i‡(
â
->
t›ﬁogy
 =
TOP_SUBNET
)

4987 i‡(
â
->
›ti⁄s
.
dh˝_masq_cu°om_off£t
)

4988 
ï
[2] = 
	`dh˝_masq_addr
 (
â
->
loˇl
,Åt->
ªmŸe_√tmask
,Åt->
›ti⁄s
.
dh˝_masq_off£t
);

4990 
ï
[2] = 
	`dh˝_masq_addr
 (
â
->
loˇl
,Åt->
ªmŸe_√tmask
, -1);

4993 
ï
[2] = 
	`ht⁄l
 (
â
->
ªmŸe_√tmask
);

4997 
	`ASSERT
 (
â
->
ty≥
 =
DEV_TYPE_TAP
);

4998 
ï
[2] = 
	`dh˝_masq_addr
 (
â
->
loˇl
,Åt->
ad≠ãr_√tmask
,Åt->
›ti⁄s
.
dh˝_masq_cu°om_off£t
 ?Åt->›ti⁄s.
dh˝_masq_off£t
 : 0);

5002 
ï
[3] = (
uöt32_t
Ë
â
->
›ti⁄s
.
dh˝_Àa£_time
;

5004 
	`ASSERT
 (
ï
[3] > 0);

5006 #i‚de‡
SIMULATE_DHCP_FAILED


5007 i‡(!
	`Devi˚IoC⁄åﬁ
 (
â
->
h™d
, 
TAP_WIN_IOCTL_CONFIG_DHCP_MASQ
,

5008 
ï
,  (ep),

5009 
ï
,  (ï), &
Àn
, 
NULL
))

5010 
	`msg
 (
M_FATAL
, "ERROR: The TAP-Windows driverÑejectedá DeviceIoControl callÅo set TAP_WIN_IOCTL_CONFIG_DHCP_MASQ mode");

5012 
	`msg
 (
M_INFO
, "Notified TAP-Windows driverÅo setá DHCP IP/netmask of %s/%s on interface %s [DHCP-serv: %s,Üease-time: %d]",

5013 
	`¥öt_ö_addr_t
 (
â
->
loˇl
, 0, &
gc
),

5014 
	`¥öt_ö_addr_t
 (
â
->
ad≠ãr_√tmask
, 0, &
gc
),

5015 
devi˚_guid
,

5016 
	`¥öt_ö_addr_t
 (
ï
[2], 
IA_NET_ORDER
, &
gc
),

5017 
ï
[3]

5021 i‡(
â
->
›ti⁄s
.
dh˝_›ti⁄s
)

5023 
buf„r
 
buf
 = 
	`Æloc_buf
 (256);

5024 i‡(
	`buûd_dh˝_›ti⁄s_°rög
 (&
buf
, &
â
->
›ti⁄s
))

5026 
	`msg
 (
D_DHCP_OPT
, "DHCP o±i⁄ såög: %s", 
	`f‹m©_hex
 (
	`BPTR
 (&
buf
), 
	`BLEN
 (&buf), 0, &
gc
));

5027 i‡(!
	`Devi˚IoC⁄åﬁ
 (
â
->
h™d
, 
TAP_WIN_IOCTL_CONFIG_DHCP_SET_OPT
,

5028 
	`BPTR
 (&
buf
), 
	`BLEN
 (&buf),

5029 
	`BPTR
 (&
buf
), 
	`BLEN
 (&buf), &
Àn
, 
NULL
))

5030 
	`msg
 (
M_FATAL
, "ERROR: The TAP-Windows driverÑejectedá TAP_WIN_IOCTL_CONFIG_DHCP_SET_OPT DeviceIoControl call");

5033 
	`msg
 (
M_WARN
, "DHCP option stringÇot set dueÅoÉrror");

5034 
	`‰ì_buf
 (&
buf
);

5041 
ULONG
 
°©us
 = 
TRUE
;

5042 i‡(!
	`Devi˚IoC⁄åﬁ
 (
â
->
h™d
, 
TAP_WIN_IOCTL_SET_MEDIA_STATUS
,

5043 &
°©us
,  (status),

5044 &
°©us
,  (°©us), &
Àn
, 
NULL
))

5045 
	`msg
 (
M_WARN
, "WARNING: The TAP-Windows driverÑejectedá TAP_WIN_IOCTL_SET_MEDIA_STATUS DeviceIoControl call.");

5050 
s
 = 
â
->
›ti⁄s
.
èp_¶ìp
;

5051 i‡(
s
 > 0)

5053 
	`msg
 (
M_INFO
, "SÀïög f‹ %d sec⁄ds...", 
s
);

5054 
	`›ív≤_¶ìp
 (
s
);

5060 c⁄° 
DWORD
 
ödex
 = 
â
->
ad≠ãr_ödex
;

5063 i‡(
ödex
 !
TUN_ADAPTER_INDEX_INVALID
)

5065 
DWORD
 
°©us
;

5067 i‡((
°©us
 = 
	`FlushIpNëTabÀ
 (
ödex
)Ë=
NO_ERROR
)

5068 
	`msg
 (
M_INFO
, "Successful ARP Flush on interface [%u] %s",

5069 ()
ödex
,

5070 
devi˚_guid
);

5072 
	`msg
 (
D_TUNTAP_INFO
, "NOTE: FlushIpNetTable failed on interface [%u] %s (status=%u) : %s",

5073 ()
ödex
,

5074 
devi˚_guid
,

5075 ()
°©us
,

5076 
	`°ªº‹_wö32
 (
°©us
, &
gc
));

5084 i‡(
dh˝_masq_po°
)

5087 i‡(
	`dh˝_°©us
 (
ödex
Ë=
DHCP_STATUS_DISABLED
)

5088 
	`msg
 (
M_WARN
, "WARNING: You have selected '--ip-win32 dynamic', which willÇot work unlessÅhe TAP-Windows TCP/IPÖropertiesáre setÅo 'Obtainán IPáddressáutomatically'");

5091 i‡(
â
->
›ti⁄s
.
dh˝_¥e_ªÀa£
)

5092 
	`dh˝_ªÀa£
 (
â
);

5093 i‡(
â
->
›ti⁄s
.
dh˝_ª√w
)

5094 
	`dh˝_ª√w
 (
â
);

5097 
	`f‹k_dh˝_a˘i⁄
 (
â
);

5099 i‡(
â
->
did_ifc⁄fig_£tup
 &&Åt->
›ti⁄s
.
ù_wö32_ty≥
 =
IPW32_SET_IPAPI
)

5101 
DWORD
 
°©us
;

5102 c⁄° *
îr‹_suffix
 = "Iám havingÅrouble usingÅhe Windows 'IP helper API'Åoáutomatically setÅhe IPáddress -- consider using other --ip-win32 methods (not 'ipapi')";

5105 i‡(
ödex
 =
TUN_ADAPTER_INDEX_INVALID
)

5107 
	`msg
 (
M_FATAL
, "ERROR: unableÅo getádapter index for interface %s -- %s",

5108 
devi˚_guid
,

5109 
îr‹_suffix
);

5113 i‡(
	`dh˝_°©us
 (
ödex
Ë=
DHCP_STATUS_DISABLED
)

5114 
	`msg
 (
M_WARN
, "NOTE: You have selected (explicitly or by default) '--ip-win32 ipapi', which hasá better chance of working correctly ifÅhe TAP-Windows TCP/IPÖropertiesáre setÅo 'Obtainán IPáddressáutomatically'");

5118 
	`dñëe_ãmp_addªs£s
 (
ödex
);

5121 i‡((
°©us
 = 
	`AddIPAddªss
 (
	`ht⁄l
(
â
->
loˇl
),

5122 
	`ht⁄l
(
â
->
ad≠ãr_√tmask
),

5123 
ödex
,

5124 &
â
->
ù≠i_c⁄ãxt
,

5125 &
â
->
ù≠i_ö°™˚
)Ë=
NO_ERROR
)

5126 
	`msg
 (
M_INFO
, "Succeeded ináddingáÅemporary IP/netmask of %s/%sÅo interface %s usingÅhe Win32 IP Helper API",

5127 
	`¥öt_ö_addr_t
 (
â
->
loˇl
, 0, &
gc
),

5128 
	`¥öt_ö_addr_t
 (
â
->
ad≠ãr_√tmask
, 0, &
gc
),

5129 
devi˚_guid


5132 
	`msg
 (
M_FATAL
, "ERROR: AddIPAddress %s/%s failed on interface %s, index=%d, status=%u (windowsÉrror: '%s') -- %s",

5133 
	`¥öt_ö_addr_t
 (
â
->
loˇl
, 0, &
gc
),

5134 
	`¥öt_ö_addr_t
 (
â
->
ad≠ãr_√tmask
, 0, &
gc
),

5135 
devi˚_guid
,

5136 ()
ödex
,

5137 ()
°©us
,

5138 
	`°ªº‹_wö32
 (
°©us
, &
gc
),

5139 
îr‹_suffix
);

5140 
â
->
ù≠i_c⁄ãxt_deföed
 = 
åue
;

5144 
	`gc_‰ì
 (&
gc
);

5145 
	}
}

5148 
	$èp_wö_gëöfo
 (c⁄° 
tu¡≠
 *
â
, 
gc_¨ía
 *
gc
)

5150 i‡(
â
 &&Åt->
h™d
 !
NULL
)

5152 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

5153 
DWORD
 
Àn
;

5154 i‡(
	`Devi˚IoC⁄åﬁ
 (
â
->
h™d
, 
TAP_WIN_IOCTL_GET_INFO
,

5155 
	`BSTR
 (&
out
), 
	`BCAP
 (&out),

5156 
	`BSTR
 (&
out
), 
	`BCAP
 (&out),

5157 &
Àn
, 
NULL
))

5159  
	`BSTR
 (&
out
);

5162  
NULL
;

5163 
	}
}

5166 
	$tun_show_debug
 (
tu¡≠
 *
â
)

5168 i‡(
â
 &&Åt->
h™d
 !
NULL
)

5170 
buf„r
 
out
 = 
	`Æloc_buf
 (1024);

5171 
DWORD
 
Àn
;

5172 
	`Devi˚IoC⁄åﬁ
 (
â
->
h™d
, 
TAP_WIN_IOCTL_GET_LOG_LINE
,

5173 
	`BSTR
 (&
out
), 
	`BCAP
 (&out),

5174 
	`BSTR
 (&
out
), 
	`BCAP
 (&out),

5175 &
Àn
, 
NULL
))

5177 
	`msg
 (
D_TAP_WIN_DEBUG
, "TAP-Wödows: %s", 
	`BSTR
 (&
out
));

5179 
	`‰ì_buf
 (&
out
);

5181 
	}
}

5184 
	$˛o£_tun
 (
tu¡≠
 *
â
)

5186 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

5188 i‡(
â
)

5190 i‡–
â
->
ùv6
 &&Åt->
did_ifc⁄fig_ùv6_£tup
 )

5192 c⁄° *
ifc⁄fig_ùv6_loˇl
;

5193 
¨gv
árgv;

5194 
	`¨gv_öô
 (&
¨gv
);

5197 
	`dñëe_rouã_c⁄√˘ed_v6_√t
(
â
, 
NULL
);

5204 
ifc⁄fig_ùv6_loˇl
 = 
	`¥öt_ö6_addr
 (
â
->
loˇl_ùv6
, 0, &
gc
);

5205 
	`¨gv_¥ötf
 (&
¨gv
,

5207 
	`gë_wö_sys_∑th
(),

5208 
NETSH_PATH_SUFFIX
,

5209 
â
->
a˘uÆ_«me
,

5210 
ifc⁄fig_ùv6_loˇl
 );

5212 
	`√tsh_comm™d
 (&
¨gv
, 1);

5213 
	`¨gv_ª£t
 (&
¨gv
);

5216 i‡(
â
->
ù≠i_c⁄ãxt_deföed
)

5218 
DWORD
 
°©us
;

5219 i‡((
°©us
 = 
	`DñëeIPAddªss
 (
â
->
ù≠i_c⁄ãxt
)Ë!
NO_ERROR
)

5221 
	`msg
 (
M_WARN
, "Warning: DeleteIPAddress[%u] failed on TAP-Windowsádapter, status=%u : %s",

5222 ()
â
->
ù≠i_c⁄ãxt
,

5223 ()
°©us
,

5224 
	`°ªº‹_wö32
 (
°©us
, &
gc
));

5229 i‡(
â
->
›ti⁄s
.
dh˝_ªÀa£
)

5230 
	`dh˝_ªÀa£
 (
â
);

5232 i‡(
â
->
h™d
 !
NULL
)

5234 
	`dmsg
 (
D_WIN32_IO_LOW
, "Attempting CancelIO on TAP-Windowsádapter");

5235 i‡(!
	`C™˚lIo
 (
â
->
h™d
))

5236 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Warning: CancelIO failed on TAP-Windowsádapter");

5239 
	`dmsg
 (
D_WIN32_IO_LOW
, "Attempting close of overlappedÑeadÉvent on TAP-Windowsádapter");

5240 
	`ovîœµed_io_˛o£
 (&
â
->
ªads
);

5242 
	`dmsg
 (
D_WIN32_IO_LOW
, "Attempting close of overlapped writeÉvent on TAP-Windowsádapter");

5243 
	`ovîœµed_io_˛o£
 (&
â
->
wrôes
);

5245 i‡(
â
->
h™d
 !
NULL
)

5247 
	`dmsg
 (
D_WIN32_IO_LOW
, "Attempting CloseHandle on TAP-Windowsádapter");

5248 i‡(!
	`Clo£H™dÀ
 (
â
->
h™d
))

5249 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Warning: CloseHandle failed on TAP-Windowsádapter");

5252 i‡(
â
->
a˘uÆ_«me
)

5253 
	`‰ì
 (
â
->
a˘uÆ_«me
);

5255 
	`˛ór_tu¡≠
 (
â
);

5256 
	`‰ì
 (
â
);

5258 
	`gc_‰ì
 (&
gc
);

5259 
	}
}

5265 
	sù£t_«mes
 {

5266 c⁄° *
	msh‹t_f‹m
;

5270 c⁄° 
ù£t_«mes
 
	gù£t_«mes
[] = {

5279 
	$ascii2ù£t
 (c⁄° * 
«me
)

5281 
i
;

5282 
	`ASSERT
 (
IPW32_SET_N
 =
	`SIZE
 (
ù£t_«mes
));

5283 
i
 = 0; i < 
IPW32_SET_N
; ++i)

5284 i‡(!
	`°rcmp
 (
«me
, 
ù£t_«mes
[
i
].
sh‹t_f‹m
))

5285  
i
;

5287 
	}
}

5290 
	$ù£t2ascii
 (
ödex
)

5292 
	`ASSERT
 (
IPW32_SET_N
 =
	`SIZE
 (
ù£t_«mes
));

5293 i‡(
ödex
 < 0 || index >
IPW32_SET_N
)

5296  
ù£t_«mes
[
ödex
].
sh‹t_f‹m
;

5297 
	}
}

5300 
	$ù£t2ascii_Æl
 (
gc_¨ía
 *
gc
)

5302 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, 
gc
);

5303 
i
;

5305 
	`ASSERT
 (
IPW32_SET_N
 =
	`SIZE
 (
ù£t_«mes
));

5306 
i
 = 0; i < 
IPW32_SET_N
; ++i)

5308 i‡(
i
)

5309 
	`buf_¥ötf
(&
out
, " ");

5310 
	`buf_¥ötf
(&
out
, "[%s]", 
	`ù£t2ascii
(
i
));

5312  
	`BSTR
 (&
out
);

5313 
	}
}

5318 
	$›í_tun
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
, 
tu¡≠
 *
â
)

5320 
	`›í_tun_gíîic
 (
dev
, 
dev_ty≥
, 
dev_node
, 
Ál£
, 
åue
, 
â
);

5321 
	}
}

5324 
	$˛o£_tun
 (
tu¡≠
* 
â
)

5326 i‡(
â
)

5328 
	`˛o£_tun_gíîic
 (
â
);

5329 
	`‰ì
 (
â
);

5331 
	}
}

5334 
	$wrôe_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

5336  
	`wrôe
 (
â
->
fd
, 
buf
, 
Àn
);

5337 
	}
}

5340 
	$ªad_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
)

5342  
	`ªad
 (
â
->
fd
, 
buf
, 
Àn
);

5343 
	}
}

	@src/openvpn/tun.h

25 #i‚de‡
TUN_H


26 
	#TUN_H


	)

28 #ifde‡
WIN32


29 
	~<wöio˘l.h
>

30 
	~<èp-wödows.h
>

33 
	~"buf„r.h
"

34 
	~"îr‹.h
"

35 
	~"mtu.h
"

36 
	~"wö32.h
"

37 
	~"evít.h
"

38 
	~"¥Ÿo.h
"

39 
	~"misc.h
"

41 #ifde‡
WIN32


43 
	#TUN_ADAPTER_INDEX_INVALID
 ((
DWORD
)-1)

	)

46 
	#IPW32_SET_ADAPTIVE_DELAY_WINDOW
 300

	)

47 
	#IPW32_SET_ADAPTIVE_TRY_NETSH
 20

	)

49 
	stu¡≠_›ti⁄s
 {

51 
boﬁ
 
	mù_wö32_deföed
;

53 
	#IPW32_SET_MANUAL
 0

	)

54 
	#IPW32_SET_NETSH
 1

	)

55 
	#IPW32_SET_IPAPI
 2

	)

56 
	#IPW32_SET_DHCP_MASQ
 3

	)

57 
	#IPW32_SET_ADAPTIVE
 4

	)

58 
	#IPW32_SET_N
 5

	)

59 
	mù_wö32_ty≥
;

62 
boﬁ
 
	mdh˝_masq_cu°om_off£t
;

63 
	mdh˝_masq_off£t
;

64 
	mdh˝_Àa£_time
;

67 
	mèp_¶ìp
;

71 
boﬁ
 
	mdh˝_›ti⁄s
;

73 c⁄° *
	mdomaö
;

75 c⁄° *
	m√tbios_sc›e
;

77 
	m√tbios_node_ty≥
;

79 
	#N_DHCP_ADDR
 4

	)

83 
ö_addr_t
 
	mdns
[
N_DHCP_ADDR
];

84 
	mdns_Àn
;

87 
ö_addr_t
 
	mwös
[
N_DHCP_ADDR
];

88 
	mwös_Àn
;

91 
ö_addr_t
 
	m¡p
[
N_DHCP_ADDR
];

92 
	m¡p_Àn
;

95 
ö_addr_t
 
	mnbdd
[
N_DHCP_ADDR
];

96 
	mnbdd_Àn
;

99 
boﬁ
 
	mdißbÀ_nbt
;

101 
boﬁ
 
	mdh˝_ª√w
;

102 
boﬁ
 
	mdh˝_¥e_ªÀa£
;

103 
boﬁ
 
	mdh˝_ªÀa£
;

105 
boﬁ
 
	mªgi°î_dns
;

108 #ñi‡
TARGET_LINUX


110 
	stu¡≠_›ti⁄s
 {

111 
	mtxqueuñí
;

116 
	stu¡≠_›ti⁄s
 {

117 
	mdummy
;

126 
	stu¡≠


128 
	#TUNNEL_TYPE
(
â
Ë(—tË? (—t)->
ty≥
Ë: 
DEV_TYPE_UNDEF
)

	)

129 
	mty≥
;

131 
	#TUNNEL_TOPOLOGY
(
â
Ë(—tË? (—t)->
t›ﬁogy
Ë: 
TOP_UNDEF
)

	)

132 
	mt›ﬁogy
;

134 
boﬁ
 
	mdid_ifc⁄fig_£tup
;

135 
boﬁ
 
	mdid_ifc⁄fig_ùv6_£tup
;

136 
boﬁ
 
	mdid_ifc⁄fig
;

138 
boﬁ
 
	mùv6
;

140 
boﬁ
 
	m≥rsi°ít_if
;

142 
tu¡≠_›ti⁄s
 
	m›ti⁄s
;

144 *
	ma˘uÆ_«me
;

147 
	mtxqueuñí
;

150 
ö_addr_t
 
	mloˇl
;

151 
ö_addr_t
 
	mªmŸe_√tmask
;

152 
ö_addr_t
 
	mbrﬂdˇ°
;

154 
ö6_addr
 
	mloˇl_ùv6
;

155 
ö6_addr
 
	mªmŸe_ùv6
;

156 
	m√tbôs_ùv6
;

158 #ifde‡
WIN32


159 
HANDLE
 
	mh™d
;

160 
ovîœµed_io
 
	mªads
;

161 
ovîœµed_io
 
	mwrôes
;

162 
rw_h™dÀ
 
	mrw_h™dÀ
;

166 
boﬁ
 
	mù≠i_c⁄ãxt_deföed
;

167 
ULONG
 
	mù≠i_c⁄ãxt
;

168 
ULONG
 
	mù≠i_ö°™˚
;

169 
ö_addr_t
 
	mad≠ãr_√tmask
;

173 
DWORD
 
	mad≠ãr_ödex
;

175 
	m°™dby_ôî
;

177 
	mfd
;

180 #ifde‡
TARGET_SOLARIS


181 
	mù_fd
;

184 #ifde‡
HAVE_NET_IF_UTUN_H


185 
boﬁ
 
	mis_utun
;

188 
	mrwÊags_debug
;

192 
	mpo°_›í_mtu
;

195 
ölöe
 
boﬁ


196 
	$tu¡≠_deföed
 (c⁄° 
tu¡≠
 *
â
)

198 #ifde‡
WIN32


199  
â
 &&Åt->
h™d
 !
NULL
;

201  
â
 &&Åt->
fd
 >= 0;

203 
	}
}

209 
›í_tun
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
,

210 
tu¡≠
 *
â
);

212 
˛o£_tun
 (
tu¡≠
 *
â
);

214 
wrôe_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
);

216 
ªad_tun
 (
tu¡≠
* 
â
, 
uöt8_t
 *
buf
, 
Àn
);

218 
tuncfg
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
dev_node
,

219 
≥rsi°_mode
, c⁄° *
u£∫ame
,

220 c⁄° *
grou≤ame
, c⁄° 
tu¡≠_›ti⁄s
 *
›ti⁄s
);

222 c⁄° *
guess_tu¡≠_dev
 (c⁄° *
dev
,

223 c⁄° *
dev_ty≥
,

224 c⁄° *
dev_node
,

225 
gc_¨ía
 *
gc
);

227 
tu¡≠
 *
öô_tun
 (c⁄° *
dev
,

228 c⁄° *
dev_ty≥
,

229 
t›ﬁogy
,

230 c⁄° *
ifc⁄fig_loˇl_∑rm
,

231 c⁄° *
ifc⁄fig_ªmŸe_√tmask_∑rm
,

232 c⁄° *
ifc⁄fig_ùv6_loˇl_∑rm
,

233 
ifc⁄fig_ùv6_√tbôs_∑rm
,

234 c⁄° *
ifc⁄fig_ùv6_ªmŸe_∑rm
,

235 
ö_addr_t
 
loˇl_public
,

236 
ö_addr_t
 
ªmŸe_public
,

237 c⁄° 
boﬁ
 
°ri˘_w¨n
,

238 
ív_£t
 *
es
);

240 
öô_tun_po°
 (
tu¡≠
 *
â
,

241 c⁄° 
‰ame
 *frame,

242 c⁄° 
tu¡≠_›ti⁄s
 *
›ti⁄s
);

244 
do_ifc⁄fig
 (
tu¡≠
 *
â
,

245 c⁄° *
a˘uÆ
,

246 
tun_mtu
,

247 c⁄° 
ív_£t
 *
es
);

249 
boﬁ
 
is_dev_ty≥
 (c⁄° *
dev
, c⁄° *
dev_ty≥
, c⁄° *
m©ch_ty≥
);

250 
dev_ty≥_íum
 (c⁄° *
dev
, c⁄° *
dev_ty≥
);

251 c⁄° *
dev_ty≥_°rög
 (c⁄° *
dev
, c⁄° *
dev_ty≥
);

253 c⁄° *
ifc⁄fig_›ti⁄s_°rög
 (c⁄° 
tu¡≠
* 
â
, 
boﬁ
 
ªmŸe
, boﬁ 
dißbÀ
, 
gc_¨ía
 *
gc
);

255 
boﬁ
 
is_tun_p2p
 (c⁄° 
tu¡≠
 *
â
);

257 
check_sub√t_c⁄Êi˘
 (c⁄° 
ö_addr_t
 
ù
,

258 c⁄° 
ö_addr_t
 
√tmask
,

259 c⁄° *
¥efix
);

261 
w¨n_⁄_u£_of_comm⁄_sub√ts
 ();

267 
ölöe
 

268 
	$tun_adju°_‰ame_∑ømëîs
 (
‰ame
* føme, 
size
)

270 
	`‰ame_add_to_exåa_tun
 (
‰ame
, 
size
);

271 
	}
}

278 
	#IFCONFIG_BEFORE_TUN_OPEN
 0

	)

279 
	#IFCONFIG_AFTER_TUN_OPEN
 1

	)

281 
	#IFCONFIG_DEFAULT
 
IFCONFIG_AFTER_TUN_OPEN


	)

283 
ölöe
 

284 
	$ifc⁄fig_‹dî
()

286 #i‡
	`deföed
(
TARGET_LINUX
)

287  
IFCONFIG_AFTER_TUN_OPEN
;

288 #ñi‡
	`deföed
(
TARGET_SOLARIS
)

289  
IFCONFIG_AFTER_TUN_OPEN
;

290 #ñi‡
	`deföed
(
TARGET_OPENBSD
)

291  
IFCONFIG_AFTER_TUN_OPEN
;

292 #ñi‡
	`deföed
(
TARGET_DARWIN
)

293  
IFCONFIG_AFTER_TUN_OPEN
;

294 #ñi‡
	`deföed
(
TARGET_NETBSD
)

295  
IFCONFIG_AFTER_TUN_OPEN
;

296 #ñi‡
	`deföed
(
WIN32
)

297  
IFCONFIG_BEFORE_TUN_OPEN
;

299  
IFCONFIG_DEFAULT
;

301 
	}
}

303 #ifde‡
WIN32


305 
	#TUN_PASS_BUFFER


	)

307 
	sèp_ªg


309 c⁄° *
	mguid
;

310 
èp_ªg
 *
	m√xt
;

313 
	s∑√l_ªg


315 c⁄° *
	m«me
;

316 c⁄° *
	mguid
;

317 
∑√l_ªg
 *
	m√xt
;

320 
ascii2ù£t
 (c⁄° * 
«me
);

321 c⁄° *
ù£t2ascii
 (
ödex
);

322 c⁄° *
ù£t2ascii_Æl
 (
gc_¨ía
 *
gc
);

324 
vîify_255_255_255_252
 (
ö_addr_t
 
loˇl
, in_addr_à
ªmŸe
);

326 c⁄° 
IP_ADAPTER_INFO
 *
gë_ad≠ãr_öfo_li°
 (
gc_¨ía
 *
gc
);

327 c⁄° 
IP_ADAPTER_INFO
 *
gë_tun_ad≠ãr
 (c⁄° 
tu¡≠
 *
â
, c⁄° IP_ADAPTER_INFO *
li°
);

329 c⁄° 
IP_ADAPTER_INFO
 *
gë_ad≠ãr_öfo
 (
DWORD
 
ödex
, 
gc_¨ía
 *
gc
);

330 c⁄° 
IP_PER_ADAPTER_INFO
 *
gë_≥r_ad≠ãr_öfo
 (c⁄° 
DWORD
 
ödex
, 
gc_¨ía
 *
gc
);

331 c⁄° 
IP_ADAPTER_INFO
 *
gë_ad≠ãr
 (c⁄° IP_ADAPTER_INFO *
ai
, 
DWORD
 
ödex
);

333 
boﬁ
 
is_ad≠ãr_up
 (c⁄° 
tu¡≠
 *
â
, c⁄° 
IP_ADAPTER_INFO
 *
li°
);

334 
boﬁ
 
is_ù_ö_ad≠ãr_sub√t
 (c⁄° 
IP_ADAPTER_INFO
 *
ai
, c⁄° 
ö_addr_t
 
ù
, in_addr_à*
highe°_√tmask
);

336 
DWORD
 
ad≠ãr_ödex_of_ù
 (c⁄° 
IP_ADAPTER_INFO
 *
li°
,

337 c⁄° 
ö_addr_t
 
ù
,

338 *
cou¡
,

339 
ö_addr_t
 *
√tmask
);

341 
show_èp_wö_ad≠ãrs
 (
msgÀv
, 
w¨∆ev
);

342 
show_ad≠ãrs
 (
msgÀv
);

344 
èp_Ælow_n⁄admö_ac˚ss
 (c⁄° *
dev_node
);

346 
show_vÆid_wö32_tun_sub√ts
 ();

347 c⁄° *
èp_wö_gëöfo
 (c⁄° 
tu¡≠
 *
â
, 
gc_¨ía
 *
gc
);

348 
tun_show_debug
 (
tu¡≠
 *
â
);

350 
boﬁ
 
dh˝_ªÀa£_by_ad≠ãr_ödex
(c⁄° 
DWORD
 
ad≠ãr_ödex
);

351 
boﬁ
 
dh˝_ª√w_by_ad≠ãr_ödex
 (c⁄° 
DWORD
 
ad≠ãr_ödex
);

353 
f‹k_ªgi°î_dns_a˘i⁄
 (
tu¡≠
 *
â
);

354 
ùc⁄fig_ªgi°î_dns
 (c⁄° 
ív_£t
 *
es
);

356 
tun_°™dby_öô
 (
tu¡≠
 *
â
);

357 
boﬁ
 
tun_°™dby
 (
tu¡≠
 *
â
);

359 
tun_ªad_queue
 (
tu¡≠
 *
â
, 
maxsize
);

360 
tun_wrôe_queue
 (
tu¡≠
 *
â
, 
buf„r
 *
buf
);

361 
tun_föÆize
 (
HANDLE
 
h
, 
ovîœµed_io
 *
io
, 
buf„r
 *
buf
);

363 
ölöe
 
boﬁ


364 
	$tu¡≠_°›
 (
°©us
)

370 i‡(
°©us
 < 0)

372  
	`›ív≤_î∫o
 (Ë=
ERROR_FILE_NOT_FOUND
;

374  
Ál£
;

375 
	}
}

377 
ölöe
 
boﬁ


378 
	$tu¡≠_ab‹t
(
°©us
)

383 i‡(
°©us
 < 0)

385  
	`›ív≤_î∫o
(Ë=
ERROR_OPERATION_ABORTED
;

387  
Ál£
;

388 
	}
}

390 
ölöe
 

391 
	$tun_wrôe_wö32
 (
tu¡≠
 *
â
, 
buf„r
 *
buf
)

393 
îr
 = 0;

394 
°©us
 = 0;

395 i‡(
	`ovîœµed_io_a˘ive
 (&
â
->
wrôes
))

397 
°©us
 = 
	`tun_föÆize
 (
â
->
h™d
, &â->
wrôes
, 
NULL
);

398 i‡(
°©us
 < 0)

399 
îr
 = 
	`GëLa°Eº‹
 ();

401 
	`tun_wrôe_queue
 (
â
, 
buf
);

402 i‡(
°©us
 < 0)

404 
	`SëLa°Eº‹
 (
îr
);

405  
°©us
;

408  
	`BLEN
 (
buf
);

409 
	}
}

411 
ölöe
 

412 
	$ªad_tun_buf„ªd
 (
tu¡≠
 *
â
, 
buf„r
 *
buf
, 
maxsize
)

414  
	`tun_föÆize
 (
â
->
h™d
, &â->
ªads
, 
buf
);

415 
	}
}

417 
ölöe
 

418 
	$wrôe_tun_buf„ªd
 (
tu¡≠
 *
â
, 
buf„r
 *
buf
)

420  
	`tun_wrôe_wö32
 (
â
, 
buf
);

421 
	}
}

425 
ölöe
 
boﬁ


426 
	$tu¡≠_°›
 (
°©us
)

428  
Ál£
;

429 
	}
}

431 
ölöe
 
boﬁ


432 
	$tu¡≠_ab‹t
(
°©us
)

434  
Ál£
;

435 
	}
}

437 
ölöe
 

438 
	$tun_°™dby_öô
 (
tu¡≠
 *
â
)

440 
	}
}

442 
ölöe
 
boﬁ


443 
	$tun_°™dby
 (
tu¡≠
 *
â
)

445  
åue
;

446 
	}
}

454 
ölöe
 
evít_t


455 
	$tun_evít_h™dÀ
 (c⁄° 
tu¡≠
 *
â
)

457 #ifde‡
WIN32


458  &
â
->
rw_h™dÀ
;

460  
â
->
fd
;

462 
	}
}

464 
ölöe
 

465 
	$tun_£t
 (
tu¡≠
 *
â
,

466 
evít_£t
 *
es
,

467 
rwÊags
,

468 *
¨g
,

469 *
≥rsi°ít
)

471 i‡(
	`tu¡≠_deföed
 (
â
))

474 i‡(!
≥rsi°ít
 || *≥rsi°íà!
rwÊags
)

476 
	`evít_˘l
 (
es
, 
	`tun_evít_h™dÀ
 (
â
), 
rwÊags
, 
¨g
);

477 i‡(
≥rsi°ít
)

478 *
≥rsi°ít
 = 
rwÊags
;

480 #ifde‡
WIN32


481 i‡(
rwÊags
 & 
EVENT_READ
)

482 
	`tun_ªad_queue
 (
â
, 0);

484 
â
->
rwÊags_debug
 = 
rwÊags
;

486  
rwÊags
;

487 
	}
}

489 c⁄° *
tun_°©
 (c⁄° 
tu¡≠
 *
â
, 
rwÊags
, 
gc_¨ía
 *
gc
);

	@src/openvpn/win32.c

30 #ifde‡
HAVE_CONFIG_H


31 
	~"c⁄fig.h
"

32 #ñi‡
deföed
(
_MSC_VER
)

33 
	~"c⁄fig-msvc.h
"

36 
	~"syshód.h
"

38 #ifde‡
WIN32


40 
	~"buf„r.h
"

41 
	~"îr‹.h
"

42 
	~"mtu.h
"

43 
	~"sig.h
"

44 
	~"wö32.h
"

45 
	~"misc.h
"

47 
	~"memdbg.h
"

52 
WSAD©a
 
	gwß_°©e
;

57 
boﬁ
 
	g∑u£_exô_íabÀd
 = 
Ál£
;

65 
wö32_sig«l
 
	gwö32_sig«l
;

71 
wödow_tôÀ
 
	gwödow_tôÀ
;

78 
£m≠h‹e
 
	g√tcmd_£m≠h‹e
;

83 *
	gwö_sys_∑th
 = 
NULL
;

86 
	$öô_wö32
 ()

88 i‡(
	`WSASèπup
(0x0101, &
wß_°©e
))

90 
	`msg
 (
M_ERR
, "WSAStartup failed");

92 
	`wödow_tôÀ_˛ór
 (&
wödow_tôÀ
);

93 
	`wö32_sig«l_˛ór
 (&
wö32_sig«l
);

94 
	`√tcmd_£m≠h‹e_öô
 ();

95 
	}
}

98 
	$unöô_wö32
 ()

100 
	`√tcmd_£m≠h‹e_˛o£
 ();

101 i‡(
∑u£_exô_íabÀd
)

103 i‡(
wö32_sig«l
.
mode
 =
WSO_MODE_UNDEF
)

105 
wö32_sig«l
 
w
;

106 
	`wö32_sig«l_›í
 (&
w
, 
WSO_FORCE_CONSOLE
, 
NULL
, 
Ál£
);

107 
	`wö32_∑u£
 (&
w
);

108 
	`wö32_sig«l_˛o£
 (&
w
);

111 
	`wö32_∑u£
 (&
wö32_sig«l
);

113 
	`wödow_tôÀ_ª°‹e
 (&
wödow_tôÀ
);

114 
	`wö32_sig«l_˛o£
 (&
wö32_sig«l
);

115 
	`WSACÀ™up
 ();

116 
	`‰ì
 (
wö_sys_∑th
);

117 
	}
}

120 
	$£t_∑u£_exô_wö32
 ()

122 
∑u£_exô_íabÀd
 = 
åue
;

123 
	}
}

125 
boﬁ


126 
	$öô_£curôy_©åibuãs_Ælow_Æl
 (
£curôy_©åibuãs
 *
obj
)

128 
	`CLEAR
 (*
obj
);

130 
obj
->
ß
.
nLígth
 =  (
SECURITY_ATTRIBUTES
);

131 
obj
->
ß
.
ÕSecurôyDes¸ùt‹
 = &obj->
sd
;

132 
obj
->
ß
.
bInhîôH™dÀ
 = 
FALSE
;

133 i‡(!
	`InôülizeSecurôyDes¸ùt‹
 (&
obj
->
sd
, 
SECURITY_DESCRIPTOR_REVISION
))

134  
Ál£
;

135 i‡(!
	`SëSecurôyDes¸ùt‹Da˛
 (&
obj
->
sd
, 
TRUE
, 
NULL
, 
FALSE
))

136  
Ál£
;

137  
åue
;

138 
	}
}

141 
	$ovîœµed_io_öô
 (
ovîœµed_io
 *
o
,

142 c⁄° 
‰ame
 *frame,

143 
BOOL
 
evít_°©e
,

144 
boﬁ
 
tu¡≠_buf„r
)

146 
	`CLEAR
 (*
o
);

149 
o
->
ovîœµed
.
hEvít
 = 
	`Cª©eEvít
 (
NULL
, 
TRUE
, 
evít_°©e
, NULL);

150 i‡(
o
->
ovîœµed
.
hEvít
 =
NULL
)

151 
	`msg
 (
M_ERR
, "Error: overlapped_io_init: CreateEvent failed");

154 
	`Æloc_buf_sock_tun
 (&
o
->
buf_öô
, 
‰ame
, 
tu¡≠_buf„r
, 0);

155 
	}
}

158 
	$ovîœµed_io_˛o£
 (
ovîœµed_io
 *
o
)

160 i‡(
o
->
ovîœµed
.
hEvít
)

162 i‡(!
	`Clo£H™dÀ
 (
o
->
ovîœµed
.
hEvít
))

163 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Warning: CloseHandle failed on overlapped I/OÉvent object");

165 
	`‰ì_buf
 (&
o
->
buf_öô
);

166 
	}
}

169 
	$ovîœµed_io_°©e_ascii
 (c⁄° 
ovîœµed_io
 *
o
)

171 
o
->
io°©e
)

173 
IOSTATE_INITIAL
:

175 
IOSTATE_QUEUED
:

177 
IOSTATE_IMMEDIATE_RETURN
:

181 
	}
}

188 
	$öô_√t_evít_wö32
 (
rw_h™dÀ
 *
evít
, 
√tw‹k_evíts
, 
sockë_des¸ùt‹_t
 
sd
, 
Êags
)

193 i‡(!(
Êags
 & 
NE32_PERSIST_EVENT
Ë|| !
evít
->
wrôe
)

195 i‡(
Êags
 & 
NE32_WRITE_EVENT
)

197 
evít
->
wrôe
 = 
	`Cª©eEvít
 (
NULL
, 
TRUE
, 
FALSE
, NULL);

198 i‡(
evít
->
wrôe
 =
NULL
)

199 
	`msg
 (
M_ERR
, "Error: init_net_event_win32: CreateEvent (write) failed");

202 
evít
->
wrôe
 = 
NULL
;

206 i‡(!(
Êags
 & 
NE32_PERSIST_EVENT
Ë|| !
evít
->
ªad
)

208 
evít
->
ªad
 = 
	`Cª©eEvít
 (
NULL
, 
TRUE
, 
FALSE
, NULL);

209 i‡(
evít
->
ªad
 =
NULL
)

210 
	`msg
 (
M_ERR
, "Error: init_net_event_win32: CreateEvent (read) failed");

214 i‡(
	`WSAEvítSñe˘
 (
sd
, 
evít
->
ªad
, 
√tw‹k_evíts
) != 0)

215 
	`msg
 (
M_FATAL
 | 
M_ERRNO
, "Error: init_net_event_win32: WSAEventSelect call failed");

216 
	}
}

219 
	$ª£t_√t_evít_wö32
 (
rw_h™dÀ
 *
evít
, 
sockë_des¸ùt‹_t
 
sd
)

221 
WSANETWORKEVENTS
 
w√
;

222 i‡(
	`WSAEnumNëw‹kEvíts
 (
sd
, 
evít
->
ªad
, &
w√
) != 0)

224 
	`msg
 (
M_FATAL
 | 
M_ERRNO
, "Error:Ñeset_net_event_win32: WSAEnumNetworkEvents call failed");

228  
w√
.
lNëw‹kEvíts
;

229 
	}
}

232 
	$˛o£_√t_evít_wö32
 (
rw_h™dÀ
 *
evít
, 
sockë_des¸ùt‹_t
 
sd
, 
Êags
)

234 i‡(
evít
->
ªad
)

236 i‡(
	`sockë_deföed
 (
sd
))

238 i‡(
	`WSAEvítSñe˘
 (
sd
, 
evít
->
ªad
, 0) != 0)

239 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Warning: close_net_event_win32: WSAEventSelect call failed");

241 i‡(!
	`Re£tEvít
 (
evít
->
ªad
))

242 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Warning: ResetEvent (read) failed in close_net_event_win32");

243 i‡(!(
Êags
 & 
NE32_PERSIST_EVENT
))

245 i‡(!
	`Clo£H™dÀ
 (
evít
->
ªad
))

246 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Warning: CloseHandle (read) failed in close_net_event_win32");

247 
evít
->
ªad
 = 
NULL
;

251 i‡(
evít
->
wrôe
)

253 i‡(!
	`Re£tEvít
 (
evít
->
wrôe
))

254 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Warning: ResetEvent (write) failed in close_net_event_win32");

255 i‡(!(
Êags
 & 
NE32_PERSIST_EVENT
))

257 i‡(!
	`Clo£H™dÀ
 (
evít
->
wrôe
))

258 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Warning: CloseHandle (write) failed in close_net_event_win32");

259 
evít
->
wrôe
 = 
NULL
;

262 
	}
}

269 
	$√t_evít_wö32_öô
 (
√t_evít_wö32
 *
√
)

271 
	`CLEAR
 (*
√
);

272 
√
->
sd
 = 
SOCKET_UNDEFINED
;

273 
	}
}

276 
	$√t_evít_wö32_°¨t
 (
√t_evít_wö32
 *
√
, 
√tw‹k_evíts
, 
sockë_des¸ùt‹_t
 
sd
)

278 
	`ASSERT
 (!
	`sockë_deföed
 (
√
->
sd
));

279 
√
->
sd
 = sd;

280 
√
->
evít_mask
 = 0;

281 
	`öô_√t_evít_wö32
 (&
√
->
h™dÀ
, 
√tw‹k_evíts
, 
sd
, 
NE32_PERSIST_EVENT
|
NE32_WRITE_EVENT
);

282 
	}
}

285 
	$√t_evít_wö32_ª£t_wrôe
 (
√t_evít_wö32
 *
√
)

287 
BOOL
 
°©us
;

288 i‡(
√
->
evít_mask
 & 
FD_WRITE
)

289 
°©us
 = 
	`SëEvít
 (
√
->
h™dÀ
.
wrôe
);

291 
°©us
 = 
	`Re£tEvít
 (
√
->
h™dÀ
.
wrôe
);

292 i‡(!
°©us
)

293 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "Warning: SetEvent/ResetEvent failed inÇet_event_win32_reset_write");

294 
	}
}

297 
	$√t_evít_wö32_ª£t
 (
√t_evít_wö32
 *
√
)

299 
√
->
evít_mask
 |
	`ª£t_√t_evít_wö32
 (&√->
h™dÀ
,Çe->
sd
);

300 
	}
}

303 
	$√t_evít_wö32_°›
 (
√t_evít_wö32
 *
√
)

305 i‡(
	`√t_evít_wö32_deföed
 (
√
))

306 
	`˛o£_√t_evít_wö32
 (&
√
->
h™dÀ
,Çe->
sd
, 
NE32_PERSIST_EVENT
);

307 
√
->
sd
 = 
SOCKET_UNDEFINED
;

308 
√
->
evít_mask
 = 0;

309 
	}
}

312 
	$√t_evít_wö32_˛o£
 (
√t_evít_wö32
 *
√
)

314 i‡(
	`√t_evít_wö32_deföed
 (
√
))

315 
	`˛o£_√t_evít_wö32
 (&
√
->
h™dÀ
,Çe->
sd
, 0);

316 
	`√t_evít_wö32_öô
 (
√
);

317 
	}
}

328 
	$wö32_sig«l_˛ór
 (
wö32_sig«l
 *
ws
)

330 
	`CLEAR
 (*
ws
);

331 
	}
}

334 
	$wö32_sig«l_›í
 (
wö32_sig«l
 *
ws
,

335 
f‹˚
,

336 c⁄° *
exô_evít_«me
,

337 
boﬁ
 
exô_evít_öôül_°©e
)

339 
	`CLEAR
 (*
ws
);

341 
ws
->
mode
 = 
WSO_MODE_UNDEF
;

342 
ws
->
ö
.
ªad
 = 
INVALID_HANDLE_VALUE
;

343 
ws
->
ö
.
wrôe
 = 
INVALID_HANDLE_VALUE
;

344 
ws
->
c⁄sﬁe_mode_ßve
 = 0;

345 
ws
->
c⁄sﬁe_mode_ßve_deföed
 = 
Ál£
;

347 i‡(
f‹˚
 =
WSO_NOFORCE
 || f‹˚ =
WSO_FORCE_CONSOLE
)

352 
ws
->
ö
.
ªad
 = 
	`GëStdH™dÀ
 (
STD_INPUT_HANDLE
);

353 i‡(
ws
->
ö
.
ªad
 !
INVALID_HANDLE_VALUE
)

355 i‡(
	`GëC⁄sﬁeMode
 (
ws
->
ö
.
ªad
, &ws->
c⁄sﬁe_mode_ßve
))

358 c⁄° 
DWORD
 
√w_c⁄sﬁe_mode
 = 
ws
->
c⁄sﬁe_mode_ßve


359 & ~(
ENABLE_WINDOW_INPUT


360 | 
ENABLE_PROCESSED_INPUT


361 | 
ENABLE_LINE_INPUT


362 | 
ENABLE_ECHO_INPUT


363 | 
ENABLE_MOUSE_INPUT
);

365 i‡(
√w_c⁄sﬁe_mode
 !
ws
->
c⁄sﬁe_mode_ßve
)

367 i‡(!
	`SëC⁄sﬁeMode
 (
ws
->
ö
.
ªad
, 
√w_c⁄sﬁe_mode
))

368 
	`msg
 (
M_ERR
, "Error: win32_signal_open: SetConsoleMode failed");

369 
ws
->
c⁄sﬁe_mode_ßve_deföed
 = 
åue
;

371 
ws
->
mode
 = 
WSO_MODE_CONSOLE
;

374 
ws
->
ö
.
ªad
 = 
INVALID_HANDLE_VALUE
;

382 i‡((
f‹˚
 =
WSO_NOFORCE
 || f‹˚ =
WSO_FORCE_SERVICE
)

383 && !
	`HANDLE_DEFINED
 (
ws
->
ö
.
ªad
Ë&& 
exô_evít_«me
)

385 
£curôy_©åibuãs
 
ß
;

387 i‡(!
	`öô_£curôy_©åibuãs_Ælow_Æl
 (&
ß
))

388 
	`msg
 (
M_ERR
, "Error: win32_signal_open: init SA failed");

390 
ws
->
ö
.
ªad
 = 
	`Cª©eEvít
 (&
ß
.sa,

391 
TRUE
,

392 
exô_evít_öôül_°©e
 ? 
TRUE
 : 
FALSE
,

393 
exô_evít_«me
);

394 i‡(
ws
->
ö
.
ªad
 =
NULL
)

396 
	`msg
 (
M_WARN
|
M_ERRNO
, "NOTE: Cª©eEvíà'%s' faûed", 
exô_evít_«me
);

400 i‡(
	`WaôF‹SögÀObje˘
 (
ws
->
ö
.
ªad
, 0Ë!
WAIT_TIMEOUT
)

401 
	`msg
 (
M_FATAL
, "ERROR: Exô Evíà('%s'Ëi†sig«Àd", 
exô_evít_«me
);

403 
ws
->
mode
 = 
WSO_MODE_SERVICE
;

406 
	}
}

408 
boﬁ


409 
	$keybﬂrd_öput_avaûabÀ
 (
wö32_sig«l
 *
ws
)

411 
	`ASSERT
 (
ws
->
mode
 =
WSO_MODE_CONSOLE
);

412 i‡(
	`HANDLE_DEFINED
 (
ws
->
ö
.
ªad
))

414 
DWORD
 
n
;

415 i‡(
	`GëNumbîOfC⁄sﬁeI≈utEvíts
 (
ws
->
ö
.
ªad
, &
n
))

416  
n
 > 0;

418  
Ál£
;

419 
	}
}

422 
	$keybﬂrd_ú_to_key
 (
INPUT_RECORD
 *
ú
)

424 i‡(
ú
->
Evít
.
KeyEvít
.
uCh¨
.
AsciiCh¨
 == 0)

425  
ú
->
Evít
.
KeyEvít
.
wVútuÆSˇnCode
;

427 i‡((
ú
->
Evít
.
KeyEvít
.
dwC⁄åﬁKeySèã


428 & (
LEFT_ALT_PRESSED
 | 
RIGHT_ALT_PRESSED
))

429 && (
ú
->
Evít
.
KeyEvít
.
wVútuÆKeyCode
 != 18))

430  
ú
->
Evít
.
KeyEvít
.
wVútuÆSˇnCode
 * 256;

432  
ú
->
Evít
.
KeyEvít
.
uCh¨
.
AsciiCh¨
;

433 
	}
}

436 
	$wö32_keybﬂrd_gë
 (
wö32_sig«l
 *
ws
)

438 
	`ASSERT
 (
ws
->
mode
 =
WSO_MODE_CONSOLE
);

439 i‡(
	`HANDLE_DEFINED
 (
ws
->
ö
.
ªad
))

441 
INPUT_RECORD
 
ú
;

443 
DWORD
 
n
;

444 i‡(!
	`keybﬂrd_öput_avaûabÀ
 (
ws
))

446 i‡(!
	`RódC⁄sﬁeI≈ut
 (
ws
->
ö
.
ªad
, &
ú
, 1, &
n
))

448 } 
ú
.
EvítTy≥
 !
KEY_EVENT
 || ir.
Evít
.
KeyEvít
.
bKeyDown
 !
TRUE
);

450  
	`keybﬂrd_ú_to_key
 (&
ú
);

454 
	}
}

457 
	$wö32_sig«l_˛o£
 (
wö32_sig«l
 *
ws
)

459 i‡(
ws
->
mode
 =
WSO_MODE_SERVICE
 && 
	`HANDLE_DEFINED
 (ws->
ö
.
ªad
))

460 
	`Clo£H™dÀ
 (
ws
->
ö
.
ªad
);

461 i‡(
ws
->
c⁄sﬁe_mode_ßve_deföed
)

463 i‡(!
	`SëC⁄sﬁeMode
 (
ws
->
ö
.
ªad
, ws->
c⁄sﬁe_mode_ßve
))

464 
	`msg
 (
M_ERR
, "Error: win32_signal_close: SetConsoleMode failed");

466 
	`CLEAR
 (*
ws
);

467 
	}
}

472 
boﬁ


473 
	$wö32_£rvi˚_öãºu±
 (
wö32_sig«l
 *
ws
)

475 i‡(
ws
->
mode
 =
WSO_MODE_SERVICE
)

477 i‡(
	`HANDLE_DEFINED
 (
ws
->
ö
.
ªad
)

478 && 
	`WaôF‹SögÀObje˘
 (
ws
->
ö
.
ªad
, 0Ë=
WAIT_OBJECT_0
)

479  
åue
;

481  
Ál£
;

482 
	}
}

485 
	$wö32_sig«l_gë
 (
wö32_sig«l
 *
ws
)

487 
ªt
 = 0;

488 i‡(
sigöfo_°©ic
.
sig«l_ª˚ived
)

490 
ªt
 = 
sigöfo_°©ic
.
sig«l_ª˚ived
;

494 i‡(
ws
->
mode
 =
WSO_MODE_SERVICE
)

496 i‡(
	`wö32_£rvi˚_öãºu±
 (
ws
))

497 
ªt
 = 
SIGTERM
;

499 i‡(
ws
->
mode
 =
WSO_MODE_CONSOLE
)

501 
	`wö32_keybﬂrd_gë
 (
ws
))

504 
ªt
 = 
SIGUSR1
;

507 
ªt
 = 
SIGUSR2
;

510 
ªt
 = 
SIGHUP
;

513 
ªt
 = 
SIGTERM
;

517 i‡(
ªt
)

519 
sigöfo_°©ic
.
sig«l_ª˚ived
 = 
ªt
;

520 
sigöfo_°©ic
.
h¨d
 = 
åue
;

523  
ªt
;

524 
	}
}

527 
	$wö32_∑u£
 (
wö32_sig«l
 *
ws
)

529 i‡(
ws
->
mode
 =
WSO_MODE_CONSOLE
 && 
	`HANDLE_DEFINED
 (ws->
ö
.
ªad
))

531 
°©us
;

532 
	`msg
 (
M_INFO
|
M_NOPREFIX
, "Pressány keyÅo continue...");

534 
°©us
 = 
	`WaôF‹SögÀObje˘
 (
ws
->
ö
.
ªad
, 
INFINITE
);

535 } !
	`wö32_keybﬂrd_gë
 (
ws
));

537 
	}
}

542 
	$wödow_tôÀ_˛ór
 (
wödow_tôÀ
 *
wt
)

544 
	`CLEAR
 (*
wt
);

545 
	}
}

548 
	$wödow_tôÀ_ßve
 (
wödow_tôÀ
 *
wt
)

550 i‡(!
wt
->
ßved
)

552 i‡(!
	`GëC⁄sﬁeTôÀ
 (
wt
->
ﬁd_wödow_tôÀ
,  (wt->old_window_title)))

554 
wt
->
ﬁd_wödow_tôÀ
[0] = 0;

555 
wt
->
ßved
 = 
Ál£
;

558 
wt
->
ßved
 = 
åue
;

560 
	}
}

563 
	$wödow_tôÀ_ª°‹e
 (c⁄° 
wödow_tôÀ
 *
wt
)

565 i‡(
wt
->
ßved
)

566 
	`SëC⁄sﬁeTôÀ
 (
wt
->
ﬁd_wödow_tôÀ
);

567 
	}
}

570 
	$wödow_tôÀ_gíî©e
 (c⁄° *
tôÀ
)

572 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

573 
buf„r
 
out
 = 
	`Æloc_buf_gc
 (256, &
gc
);

574 i‡(!
tôÀ
)

575 
tôÀ
 = "";

576 
	`buf_¥ötf
 (&
out
, "[%s] " 
PACKAGE_NAME
 " " 
PACKAGE_VERSION
 " F4:EXIT F1:USR1 F2:USR2 F3:HUP", 
tôÀ
);

577 
	`SëC⁄sﬁeTôÀ
 (
	`BSTR
 (&
out
));

578 
	`gc_‰ì
 (&
gc
);

579 
	}
}

584 
	$£m≠h‹e_˛ór
 (
£m≠h‹e
 *
s
)

586 
	`CLEAR
 (*
s
);

587 
	}
}

590 
	$£m≠h‹e_›í
 (
£m≠h‹e
 *
s
, c⁄° *
«me
)

592 
£curôy_©åibuãs
 
ß
;

594 
s
->
locked
 = 
Ál£
;

595 
s
->
«me
 =Çame;

596 
s
->
h™d
 = 
NULL
;

598 i‡(
	`öô_£curôy_©åibuãs_Ælow_Æl
 (&
ß
))

599 
s
->
h™d
 = 
	`Cª©eSem≠h‹e
(&
ß
.ß, 1, 1, 
«me
);

601 i‡(
s
->
h™d
 =
NULL
)

602 
	`msg
 (
M_WARN
|
M_ERRNO
, "WARNING: C™nŸ cª©êWö32 sem≠h‹ê'%s'", 
«me
);

604 
	`dmsg
 (
D_SEMAPHORE
, "Cª©ed Wö32 sem≠h‹ê'%s'", 
s
->
«me
);

605 
	}
}

607 
boﬁ


608 
	$£m≠h‹e_lock
 (
£m≠h‹e
 *
s
, 
timeout_mûli£c⁄ds
)

610 
boﬁ
 
ªt
 = 
åue
;

612 i‡(
s
->
h™d
)

614 
DWORD
 
°©us
;

615 
	`ASSERT
 (!
s
->
locked
);

617 
	`dmsg
 (
D_SEMAPHORE_LOW
, "AttemptingÅoÜock Win32 semaphore '%s'ÖriorÅoÇet shell command (timeout = %d sec)",

618 
s
->
«me
,

619 
timeout_mûli£c⁄ds
 / 1000);

620 
°©us
 = 
	`WaôF‹SögÀObje˘
 (
s
->
h™d
, 
timeout_mûli£c⁄ds
);

621 i‡(
°©us
 =
WAIT_FAILED
)

622 
	`msg
 (
M_ERR
, "Waô faûed o¿Wö32 sem≠h‹ê'%s'", 
s
->
«me
);

623 
ªt
 = (
°©us
 =
WAIT_TIMEOUT
Ë? 
Ál£
 : 
åue
;

624 i‡(
ªt
)

626 
	`dmsg
 (
D_SEMAPHORE
, "Locked Wö32 sem≠h‹ê'%s'", 
s
->
«me
);

627 
s
->
locked
 = 
åue
;

631 
	`dmsg
 (
D_SEMAPHORE
, "Wait on Win32 semaphore '%s'Åimed outáfter %d milliseconds",

632 
s
->
«me
,

633 
timeout_mûli£c⁄ds
);

636  
ªt
;

637 
	}
}

640 
	$£m≠h‹e_ªÀa£
 (
£m≠h‹e
 *
s
)

642 i‡(
s
->
h™d
)

644 
	`ASSERT
 (
s
->
locked
);

645 
	`dmsg
 (
D_SEMAPHORE
, "Rñósög Wö32 sem≠h‹ê'%s'", 
s
->
«me
);

646 i‡(!
	`Rñó£Sem≠h‹e
(
s
->
h™d
, 1, 
NULL
))

647 
	`msg
 (
M_WARN
 | 
M_ERRNO
, "ReleaseSemaphore failed on Win32 semaphore '%s'",

648 
s
->
«me
);

649 
s
->
locked
 = 
Ál£
;

651 
	}
}

654 
	$£m≠h‹e_˛o£
 (
£m≠h‹e
 *
s
)

656 i‡(
s
->
h™d
)

658 i‡(
s
->
locked
)

659 
	`£m≠h‹e_ªÀa£
 (
s
);

660 
	`dmsg
 (
D_SEMAPHORE
, "Closög Wö32 sem≠h‹ê'%s'", 
s
->
«me
);

661 
	`Clo£H™dÀ
 (
s
->
h™d
);

662 
s
->
h™d
 = 
NULL
;

664 
	}
}

672 
	$√tcmd_£m≠h‹e_öô
 ()

674 
	`£m≠h‹e_›í
 (&
√tcmd_£m≠h‹e
, 
PACKAGE
 "_netcmd");

675 
	}
}

678 
	$√tcmd_£m≠h‹e_˛o£
 ()

680 
	`£m≠h‹e_˛o£
 (&
√tcmd_£m≠h‹e
);

681 
	}
}

684 
	$√tcmd_£m≠h‹e_lock
 ()

686 c⁄° 
timeout_£c⁄ds
 = 600;

687 i‡(!
	`£m≠h‹e_lock
 (&
√tcmd_£m≠h‹e
, 
timeout_£c⁄ds
 * 1000))

688 
	`msg
 (
M_FATAL
, "CannotÜockÇet command semaphore");

689 
	}
}

692 
	$√tcmd_£m≠h‹e_ªÀa£
 ()

694 
	`£m≠h‹e_ªÀa£
 (&
√tcmd_£m≠h‹e
);

695 
	}
}

708 
boﬁ


709 
	$cmp_¥efix
 (c⁄° *
°r
, c⁄° 
boﬁ
 
n
, c⁄° *
¥e
)

711 
size_t
 
i
 = 0;

713 i‡(!
°r
)

714  
Ál£
;

716 
åue
)

718 c⁄° 
c1
 = 
¥e
[
i
];

719 
c2
 = 
°r
[
i
];

720 ++
i
;

721 i‡(
c1
 == '\0')

723 i‡(
n
)

725 i‡(
	`isdigô
 (
c2
))

726 
c2
 = 
°r
[
i
];

728  
Ál£
;

730  
c2
 == '\0' || c2 == '.';

732 i‡(
c2
 == '\0')

733  
Ál£
;

734 i‡(
c1
 !
	`tﬁowî
(
c2
))

735  
Ál£
;

737 
	}
}

739 
boﬁ


740 
	$wö_ß„_fûíame
 (c⁄° *
‚
)

742 i‡(
	`cmp_¥efix
 (
‚
, 
Ál£
, "con"))

743  
Ál£
;

744 i‡(
	`cmp_¥efix
 (
‚
, 
Ál£
, "prn"))

745  
Ál£
;

746 i‡(
	`cmp_¥efix
 (
‚
, 
Ál£
, "aux"))

747  
Ál£
;

748 i‡(
	`cmp_¥efix
 (
‚
, 
Ál£
, "nul"))

749  
Ál£
;

750 i‡(
	`cmp_¥efix
 (
‚
, 
åue
, "com"))

751  
Ál£
;

752 i‡(
	`cmp_¥efix
 (
‚
, 
åue
, "lpt"))

753  
Ál£
;

754 i‡(
	`cmp_¥efix
 (
‚
, 
Ál£
, "clock$"))

755  
Ál£
;

756  
åue
;

757 
	}
}

764 
	$ív_block
 (c⁄° 
ív_£t
 *
es
)

766 * 
f‹˚_∑th
 = "PATH=C:\\Windows\\System32;C:\\WINDOWS;C:\\WINDOWS\\System32\\Wbem";

768 i‡(
es
)

770 
ív_ôem
 *
e
;

771 *
ªt
;

772 *
p
;

773 
size_t
 
nch¨s
 = 1;

774 
boﬁ
 
∑th_£í
 = 
Ál£
;

776 
e
 = 
es
->
li°
;É !
NULL
;É =É->
√xt
)

777 
nch¨s
 +
	`°æí
 (
e
->
°rög
) + 1;

779 
nch¨s
 +
	`°æí
(
f‹˚_∑th
)+1;

781 
ªt
 = (*Ë
	`mÆloc
 (
nch¨s
);

782 
	`check_mÆloc_ªtu∫
 (
ªt
);

784 
p
 = 
ªt
;

785 
e
 = 
es
->
li°
;É !
NULL
;É =É->
√xt
)

787 i‡(
	`ív_Ælowed
 (
e
->
°rög
))

789 
	`°r˝y
 (
p
, 
e
->
°rög
);

790 
p
 +
	`°æí
 (
e
->
°rög
) + 1;

792 i‡–
	`°∫cmp
(
e
->
°rög
, "PATH=", 5 ) == 0 )

793 
∑th_£í
 = 
åue
;

797 i‡–!
∑th_£í
 )

799 
	`msg
–
M_INFO
, "ív_block:ádd %s", 
f‹˚_∑th
 );

800 
	`°r˝y
–
p
, 
f‹˚_∑th
 );

801 
p
 +
	`°æí
(
f‹˚_∑th
) + 1;

804 *
p
 = '\0';

805  
ªt
;

808  
NULL
;

809 
	}
}

811 
WCHAR
 *

812 
	$wide_cmd_löe
 (c⁄° 
¨gv
 *
a
, 
gc_¨ía
 *
gc
)

814 
size_t
 
nch¨s
 = 1;

815 
size_t
 
maxÀn
 = 0;

816 
size_t
 
i
;

817 
buf„r
 
buf
;

818 *
w‹k
 = 
NULL
;

820 i‡(!
a
)

821  
NULL
;

823 
i
 = 0; i < 
a
->
¨gc
; ++i)

825 c⁄° *
¨g
 = 
a
->
¨gv
[
i
];

826 c⁄° 
size_t
 
Àn
 = 
	`°æí
 (
¨g
);

827 
nch¨s
 +
Àn
 + 3;

828 i‡(
Àn
 > 
maxÀn
)

829 
maxÀn
 = 
Àn
;

832 
w‹k
 = 
	`gc_mÆloc
 (
maxÀn
 + 1, 
Ál£
, 
gc
);

833 
	`check_mÆloc_ªtu∫
 (
w‹k
);

834 
buf
 = 
	`Æloc_buf_gc
 (
nch¨s
, 
gc
);

836 
i
 = 0; i < 
a
->
¨gc
; ++i)

838 c⁄° *
¨g
 = 
a
->
¨gv
[
i
];

839 
	`°r˝y
 (
w‹k
, 
¨g
);

840 
	`°rög_mod
 (
w‹k
, 
CC_PRINT
, 
CC_DOUBLE_QUOTE
|
CC_CRLF
, '_');

841 i‡(
i
)

842 
	`buf_¥ötf
 (&
buf
, " ");

843 i‡(
	`°rög_˛ass
 (
w‹k
, 
CC_ANY
, 
CC_SPACE
))

844 
	`buf_¥ötf
 (&
buf
, "%s", 
w‹k
);

846 
	`buf_¥ötf
 (&
buf
, "\"%s\"", 
w‹k
);

849  
	`wide_°rög
 (
	`BSTR
 (&
buf
), 
gc
);

850 
	}
}

856 
	$›ív≤_execve
 (c⁄° 
¨gv
 *
a
, c⁄° 
ív_£t
 *
es
, c⁄° 
Êags
)

858 
ªt
 = -1;

859 
boﬁ
 
exec_w¨n
 = 
Ál£
;

861 i‡(
a
 &&á->
¨gv
[0])

863 i‡(
	`›ív≤_execve_Ælowed
 (
Êags
))

865 
gc_¨ía
 
gc
 = 
	`gc_√w
 ();

866 
STARTUPINFOW
 
°¨t_öfo
;

867 
PROCESS_INFORMATION
 
¥oc_öfo
;

869 *
ív
 = 
	`ív_block
 (
es
);

870 
WCHAR
 *
˛
 = 
	`wide_cmd_löe
 (
a
, &
gc
);

871 
WCHAR
 *
cmd
 = 
	`wide_°rög
 (
a
->
¨gv
[0], &
gc
);

874 
DWORD
 
¥oc_Êags
 = 
CREATE_NO_WINDOW
;

876 
	`CLEAR
 (
°¨t_öfo
);

877 
	`CLEAR
 (
¥oc_öfo
);

880 
	`GëSèπupInfoW
(&
°¨t_öfo
);

881 
°¨t_öfo
.
cb
 = (start_info);

882 
°¨t_öfo
.
dwFœgs
 = 
STARTF_USESHOWWINDOW
;

883 
°¨t_öfo
.
wShowWödow
 = 
SW_HIDE
;

885 i‡(
	`Cª©ePro˚ssW
 (
cmd
, 
˛
, 
NULL
, NULL, 
FALSE
, 
¥oc_Êags
, 
ív
, NULL, &
°¨t_öfo
, &
¥oc_öfo
))

887 
DWORD
 
exô_°©us
 = 0;

888 
	`Clo£H™dÀ
 (
¥oc_öfo
.
hThªad
);

889 
	`WaôF‹SögÀObje˘
 (
¥oc_öfo
.
hPro˚ss
, 
INFINITE
);

890 i‡(
	`GëExôCodePro˚ss
 (
¥oc_öfo
.
hPro˚ss
, &
exô_°©us
))

891 
ªt
 = ()
exô_°©us
;

893 
	`msg
 (
M_WARN
|
M_ERRNO
, "›ív≤_execve: GëExôCodePro˚s†%S faûed", 
cmd
);

894 
	`Clo£H™dÀ
 (
¥oc_öfo
.
hPro˚ss
);

898 
	`msg
 (
M_WARN
|
M_ERRNO
, "›ív≤_execve: Cª©ePro˚s†%S faûed", 
cmd
);

900 
	`‰ì
 (
ív
);

901 
	`gc_‰ì
 (&
gc
);

903 i‡(!
exec_w¨n
 && (
s¸ùt_£curôy
 < 
SSEC_SCRIPTS
))

905 
	`msg
 (
M_WARN
, 
SCRIPT_SECURITY_WARNING
);

906 
exec_w¨n
 = 
åue
;

911 
	`msg
 (
M_WARN
, "openvpn_execve: called withÉmptyárgv");

913  
ªt
;

914 
	}
}

916 
WCHAR
 *

917 
	$wide_°rög
 (c⁄° * 
utf8
, 
gc_¨ía
 *
gc
)

919 
n
 = 
	`Mu…iByãToWideCh¨
 (
CP_UTF8
, 0, 
utf8
, -1, 
NULL
, 0);

920 
WCHAR
 *
ucs16
 = 
	`gc_mÆloc
 (
n
 *  (WCHAR), 
Ál£
, 
gc
);

921 
	`Mu…iByãToWideCh¨
 (
CP_UTF8
, 0, 
utf8
, -1, 
ucs16
, 
n
);

922  
ucs16
;

923 
	}
}

929 
	$f‹k_to_£lf
 (c⁄° *
cmdlöe
)

931 
STARTUPINFO
 
°¨t_öfo
;

932 
PROCESS_INFORMATION
 
¥oc_öfo
;

933 
£lf_exe
[256];

934 *
˛
 = 
	`°rög_Æloc
 (
cmdlöe
, 
NULL
);

935 
DWORD
 
°©us
;

937 
	`CLEAR
 (
°¨t_öfo
);

938 
	`CLEAR
 (
¥oc_öfo
);

939 
	`CLEAR
 (
£lf_exe
);

941 
°©us
 = 
	`GëModuÀFûeName
 (
NULL
, 
£lf_exe
, (self_exe));

942 i‡(
°©us
 =0 || sètu†=(
£lf_exe
))

944 
	`msg
 (
M_WARN
|
M_ERRNO
, "fork_to_self: CreateProcess failed: cannot get moduleÇame via GetModuleFileName");

945 
d⁄e
;

949 
	`GëSèπupInfo
(&
°¨t_öfo
);

950 
°¨t_öfo
.
cb
 = (start_info);

951 
°¨t_öfo
.
dwFœgs
 = 
STARTF_USESHOWWINDOW
;

952 
°¨t_öfo
.
wShowWödow
 = 
SW_HIDE
;

954 i‡(
	`Cª©ePro˚ss
 (
£lf_exe
, 
˛
, 
NULL
, NULL, 
FALSE
, 0, NULL, NULL, &
°¨t_öfo
, &
¥oc_öfo
))

956 
	`Clo£H™dÀ
 (
¥oc_öfo
.
hThªad
);

957 
	`Clo£H™dÀ
 (
¥oc_öfo
.
hPro˚ss
);

961 
	`msg
 (
M_WARN
|
M_ERRNO
, "f‹k_to_£lf: Cª©ePro˚s†Áûed: %s", 
cmdlöe
);

964 
d⁄e
:

965 
	`‰ì
 (
˛
);

966 
	}
}

969 
	$gë_wö_sys_∑th
 ()

971 
	`ASSERT
 (
wö_sys_∑th
);

972  
wö_sys_∑th
;

973 
	}
}

976 
	$£t_wö_sys_∑th
 (c⁄° *
√w∑th
, 
ív_£t
 *
es
)

978 
	`‰ì
 (
wö_sys_∑th
);

979 
wö_sys_∑th
 = 
	`°rög_Æloc
 (
√w∑th
, 
NULL
);

980 
	`£ãnv_°r
 (
es
, 
SYS_PATH_ENV_VAR_NAME
, 
wö_sys_∑th
);

981 
	}
}

984 
	$£t_wö_sys_∑th_vü_ív
 (
ív_£t
 *
es
)

986 
buf
[256];

987 
DWORD
 
°©us
 = 
	`GëEnvú⁄mítV¨übÀ
 (
SYS_PATH_ENV_VAR_NAME
, 
buf
, (buf));

988 i‡(!
°©us
)

989 
	`msg
 (
M_ERR
, "C™nŸ födÉnvú⁄míè»v¨übÀ %s", 
SYS_PATH_ENV_VAR_NAME
);

990 i‡(
°©us
 >  (
buf
) - 1)

991 
	`msg
 (
M_FATAL
, "Såög ovîÊowáâem±ögÅÿªadÉnvú⁄míè»v¨übÀ %s", 
SYS_PATH_ENV_VAR_NAME
);

992 
	`£t_wö_sys_∑th
 (
buf
, 
es
);

993 
	}
}

997 
	$wö_gë_ãmpdú
()

999 
tmpdú
[
MAX_PATH
];

1000 
WCHAR
 
wtmpdú
[
MAX_PATH
];

1002 i‡(!
	`GëTempP©hW
(
	`_cou¡of
(
wtmpdú
), wtmpdir))

1007 
	`msg
 (
M_WARN
, "CouldÇot findá suitableÅemporary directory."

1009  
NULL
;

1012 i‡(
	`WideCh¨ToMu…iByã
 (
CP_UTF8
, 0, 
wtmpdú
, -1, 
NULL
, 0, NULL, NULLË>  (
tmpdú
))

1014 
	`msg
 (
M_WARN
, "CouldÇot getÅemporary directory. Path isÅooÜong."

1016  
NULL
;

1019 
	`WideCh¨ToMu…iByã
 (
CP_UTF8
, 0, 
wtmpdú
, -1, 
tmpdú
,  (tmpdú), 
NULL
, NULL);

1020  
tmpdú
;

1021 
	}
}

	@src/openvpn/win32.h

25 #ifde‡
WIN32


26 #i‚de‡
OPENVPN_WIN32_H


27 
	#OPENVPN_WIN32_H


	)

29 
	~"mtu.h
"

32 
	#SYS_PATH_ENV_VAR_NAME
 "Sy°emRoŸ"

	)

33 
	#NETSH_PATH_SUFFIX
 "\\sy°em32\\√tsh.exe"

	)

34 
	#WIN_ROUTE_PATH_SUFFIX
 "\\sy°em32\\rouã.exe"

	)

35 
	#WIN_IPCONFIG_PATH_SUFFIX
 "\\sy°em32\\ùc⁄fig.exe"

	)

36 
	#WIN_NET_PATH_SUFFIX
 "\\sy°em32\\√t.exe"

	)

44 #i‚de‡
IN6_ARE_ADDR_EQUAL


45 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

46 (
	`memcmp
 ((c⁄° *)(
a
), (c⁄° *)(
b
),  (
ö6_addr
)Ë=0)

	)

49 
öô_wö32
 ();

50 
unöô_wö32
 ();

52 
£t_∑u£_exô_wö32
 ();

54 
	s£curôy_©åibuãs


56 
SECURITY_ATTRIBUTES
 
	mß
;

57 
SECURITY_DESCRIPTOR
 
	msd
;

60 
	#HANDLE_DEFINED
(
h
Ë((hË!
NULL
 && (hË!
INVALID_HANDLE_VALUE
)

	)

65 
	swödow_tôÀ


67 
boﬁ
 
	mßved
;

68 
	mﬁd_wödow_tôÀ
 [256];

71 
	srw_h™dÀ
 {

72 
HANDLE
 
	mªad
;

73 
HANDLE
 
	mwrôe
;

80 
	#NE32_PERSIST_EVENT
 (1<<0)

	)

81 
	#NE32_WRITE_EVENT
 (1<<1)

	)

83 
ölöe
 
boﬁ


84 
	$deföed_√t_evít_wö32
 (c⁄° 
rw_h™dÀ
 *
evít
)

86  
evít
->
ªad
 !
NULL
;

87 
	}
}

89 
öô_√t_evít_wö32
 (
rw_h™dÀ
 *
evít
, 
√tw‹k_evíts
, 
sockë_des¸ùt‹_t
 
sd
, 
Êags
);

90 
ª£t_√t_evít_wö32
 (
rw_h™dÀ
 *
evít
, 
sockë_des¸ùt‹_t
 
sd
);

91 
˛o£_√t_evít_wö32
 (
rw_h™dÀ
 *
evít
, 
sockë_des¸ùt‹_t
 
sd
, 
Êags
);

97 
	s√t_evít_wö32


99 
rw_h™dÀ
 
	mh™dÀ
;

100 
sockë_des¸ùt‹_t
 
	msd
;

101 
	mevít_mask
;

104 
√t_evít_wö32_öô
 (
√t_evít_wö32
 *
√
);

105 
√t_evít_wö32_°¨t
 (
√t_evít_wö32
 *
√
, 
√tw‹k_evíts
, 
sockë_des¸ùt‹_t
 
sd
);

106 
√t_evít_wö32_ª£t
 (
√t_evít_wö32
 *
√
);

107 
√t_evít_wö32_ª£t_wrôe
 (
√t_evít_wö32
 *
√
);

108 
√t_evít_wö32_°›
 (
√t_evít_wö32
 *
√
);

109 
√t_evít_wö32_˛o£
 (
√t_evít_wö32
 *
√
);

111 
ölöe
 
boﬁ


112 
	$√t_evít_wö32_deföed
 (c⁄° 
√t_evít_wö32
 *
√
)

114  
	`deföed_√t_evít_wö32
 (&
√
->
h™dÀ
);

115 
	}
}

117 
ölöe
 
rw_h™dÀ
 *

118 
	$√t_evít_wö32_gë_evít
 (
√t_evít_wö32
 *
√
)

120  &
√
->
h™dÀ
;

121 
	}
}

123 
ölöe
 

124 
	$√t_evít_wö32_gë_evít_mask
 (c⁄° 
√t_evít_wö32
 *
√
)

126  
√
->
evít_mask
;

127 
	}
}

129 
ölöe
 

130 
	$√t_evít_wö32_˛ór_£À˘ed_evíts
 (
√t_evít_wö32
 *
√
, 
£À˘ed_evíts
)

132 
√
->
evít_mask
 &~
£À˘ed_evíts
;

133 
	}
}

138 
	swö32_sig«l
 {

139 
	#WSO_MODE_UNDEF
 0

	)

140 
	#WSO_MODE_SERVICE
 1

	)

141 
	#WSO_MODE_CONSOLE
 2

	)

142 
	mmode
;

143 
rw_h™dÀ
 
	mö
;

144 
DWORD
 
	mc⁄sﬁe_mode_ßve
;

145 
boﬁ
 
	mc⁄sﬁe_mode_ßve_deföed
;

148 
wö32_sig«l
 win32_signal;

149 
wödow_tôÀ
 window_title;

151 
wö32_sig«l_˛ór
 (
wö32_sig«l
 *
ws
);

154 
	#WSO_NOFORCE
 0

	)

155 
	#WSO_FORCE_SERVICE
 1

	)

156 
	#WSO_FORCE_CONSOLE
 2

	)

158 
wö32_sig«l_›í
 (
wö32_sig«l
 *
ws
,

159 
f‹˚
,

160 c⁄° *
exô_evít_«me
,

161 
boﬁ
 
exô_evít_öôül_°©e
);

163 
wö32_sig«l_˛o£
 (
wö32_sig«l
 *
ws
);

165 
wö32_sig«l_gë
 (
wö32_sig«l
 *
ws
);

167 
wö32_∑u£
 (
wö32_sig«l
 *
ws
);

169 
boﬁ
 
wö32_£rvi˚_öãºu±
 (
wö32_sig«l
 *
ws
);

175 
wödow_tôÀ_˛ór
 (
wödow_tôÀ
 *
wt
);

176 
wödow_tôÀ_ßve
 (
wödow_tôÀ
 *
wt
);

177 
wödow_tôÀ_ª°‹e
 (c⁄° 
wödow_tôÀ
 *
wt
);

178 
wödow_tôÀ_gíî©e
 (c⁄° *
tôÀ
);

184 
	sovîœµed_io
 {

185 
	#IOSTATE_INITIAL
 0

	)

186 
	#IOSTATE_QUEUED
 1

	)

187 
	#IOSTATE_IMMEDIATE_RETURN
 2

	)

188 
	mio°©e
;

189 
OVERLAPPED
 
	movîœµed
;

190 
DWORD
 
	msize
;

191 
DWORD
 
	mÊags
;

192 
	m°©us
;

193 
boﬁ
 
	maddr_deföed
;

195 
sockaddr_ö
 
	maddr
;

196 
sockaddr_ö6
 
	maddr6
;

198 
	maddæí
;

199 
buf„r
 
	mbuf_öô
;

200 
buf„r
 
	mbuf
;

203 
ovîœµed_io_öô
 (
ovîœµed_io
 *
o
,

204 c⁄° 
‰ame
 *frame,

205 
BOOL
 
evít_°©e
,

206 
boﬁ
 
tu¡≠_buf„r
);

208 
ovîœµed_io_˛o£
 (
ovîœµed_io
 *
o
);

210 
ölöe
 
boﬁ


211 
	$ovîœµed_io_a˘ive
 (
ovîœµed_io
 *
o
)

213  
o
->
io°©e
 =
IOSTATE_QUEUED
 || o->io°©ê=
IOSTATE_IMMEDIATE_RETURN
;

214 
	}
}

216 *
ovîœµed_io_°©e_ascii
 (c⁄° 
ovîœµed_io
 *
o
);

224 
	s£m≠h‹e


226 c⁄° *
	m«me
;

227 
boﬁ
 
	mlocked
;

228 
HANDLE
 
	mh™d
;

231 
£m≠h‹e_˛ór
 (
£m≠h‹e
 *
s
);

232 
£m≠h‹e_›í
 (
£m≠h‹e
 *
s
, c⁄° *
«me
);

233 
boﬁ
 
£m≠h‹e_lock
 (
£m≠h‹e
 *
s
, 
timeout_mûli£c⁄ds
);

234 
£m≠h‹e_ªÀa£
 (
£m≠h‹e
 *
s
);

235 
£m≠h‹e_˛o£
 (
£m≠h‹e
 *
s
);

245 
£m≠h‹e
 
√tcmd_£m≠h‹e
;

246 
√tcmd_£m≠h‹e_öô
 ();

247 
√tcmd_£m≠h‹e_˛o£
 ();

248 
√tcmd_£m≠h‹e_lock
 ();

249 
√tcmd_£m≠h‹e_ªÀa£
 ();

252 
boﬁ
 
öô_£curôy_©åibuãs_Ælow_Æl
 (
£curôy_©åibuãs
 *
obj
);

255 
boﬁ
 
wö_ß„_fûíame
 (c⁄° *
‚
);

258 
	gív_£t
;

261 
£t_wö_sys_∑th
 (c⁄° *
√w∑th
, 
ív_£t
 *
es
);

262 
£t_wö_sys_∑th_vü_ív
 (
ív_£t
 *
es
);

263 *
gë_wö_sys_∑th
 ();

266 
f‹k_to_£lf
 (c⁄° *
cmdlöe
);

269 c⁄° *
wö_gë_ãmpdú
();

272 
WCHAR
 *
wide_°rög
 (c⁄° * 
utf8
, 
gc_¨ía
 *
gc
);

	@src/openvpnserv/openvpnserv.c

36 #ifde‡
HAVE_CONFIG_H


37 
	~"c⁄fig.h
"

38 #ñi‡
deföed
(
_MSC_VER
)

39 
	~"c⁄fig-msvc.h
"

41 
	~<wödows.h
>

42 
	~<°dlib.h
>

43 
	~<°dio.h
>

44 
	~<°d¨g.h
>

45 
	~<¥o˚ss.h
>

46 
	~"£rvi˚.h
"

49 
	#boﬁ
 

	)

50 
	#åue
 1

	)

51 
	#Ál£
 0

	)

54 #i‚de‡
BELOW_NORMAL_PRIORITY_CLASS


55 
	#BELOW_NORMAL_PRIORITY_CLASS
 0x00004000

	)

57 #i‚de‡
ABOVE_NORMAL_PRIORITY_CLASS


58 
	#ABOVE_NORMAL_PRIORITY_CLASS
 0x00008000

	)

61 
	s£curôy_©åibuãs


63 
SECURITY_ATTRIBUTES
 
	mß
;

64 
SECURITY_DESCRIPTOR
 
	msd
;

74 
	#EXIT_EVENT_NAME
 
PACKAGE
 "_exô_1"

	)

80 
	#REG_KEY
 "SOFTWARE\\" 
PACKAGE_NAME


	)

82 
HANDLE
 
	gexô_evít
 = 
NULL
;

85 
	#CLEAR
(
x
Ë
	`mem£t
(&(x), 0, (x))

	)

90 
	#M_INFO
 (0Ë

	)

91 
	#M_SYSERR
 (
MSG_FLAGS_ERROR
|
MSG_FLAGS_SYS_CODE
Ë

	)

92 
	#M_ERR
 (
MSG_FLAGS_ERROR
Ë

	)

95 
	#MSG
(
Êags
, ...) \

97 
x_msg
[256]; \

98 
	`›ív≤_¢¥ötf
 (
x_msg
, (x_msg), 
__VA_ARGS__
); \

99 
	`AddToMesßgeLog
 ((
Êags
), 
x_msg
); \

100 }

	)

103 
	#QUERY_REG_STRING
(
«me
, 
d©a
) \

105 
Àn
 =  (
d©a
); \

106 
°©us
 = 
	`RegQuîyVÆueEx
(
›ív≤_key
, 
«me
, 
NULL
, &
ty≥
, 
d©a
, &
Àn
); \

107 i‡(
°©us
 !
ERROR_SUCCESS
 || 
ty≥
 !
REG_SZ
) \

109 
	`SëLa°Eº‹
 (
°©us
); \

110 
	`MSG
 (
M_SYSERR
, 
îr‹_f‹m©_°r
, 
«me
); \

111 
	`RegClo£Key
 (
›ív≤_key
); \

112 
föish
; \

114 }

	)

117 
	#QUERY_REG_DWORD
(
«me
, 
d©a
) \

119 
Àn
 =  (
DWORD
); \

120 
°©us
 = 
	`RegQuîyVÆueEx
(
›ív≤_key
, 
«me
, 
NULL
, &
ty≥
, (
LPBYTE
)&
d©a
, &
Àn
); \

121 i‡(
°©us
 !
ERROR_SUCCESS
 || 
ty≥
 !
REG_DWORD
 || 
Àn
 ! (
DWORD
)) \

123 
	`SëLa°Eº‹
 (
°©us
); \

124 
	`MSG
 (
M_SYSERR
, 
îr‹_f‹m©_dw‹d
, 
«me
); \

125 
	`RegClo£Key
 (
›ív≤_key
); \

126 
föish
; \

128 }

	)

137 
	$›ív≤_¢¥ötf
(*
°r
, 
size_t
 
size
, c⁄° *
f‹m©
, ...)

139 
va_li°
 
¨gli°
;

140 
Àn
 = -1;

141 i‡(
size
 > 0)

143 
	`va_°¨t
 (
¨gli°
, 
f‹m©
);

144 
Àn
 = 
	`v¢¥ötf
 (
°r
, 
size
, 
f‹m©
, 
¨gli°
);

145 
	`va_íd
 (
¨gli°
);

146 
°r
[
size
 - 1] = 0;

148  (
Àn
 >0 &&Üí < 
size
);

149 
	}
}

152 
boﬁ


153 
	$öô_£curôy_©åibuãs_Ælow_Æl
 (
£curôy_©åibuãs
 *
obj
)

155 
	`CLEAR
 (*
obj
);

157 
obj
->
ß
.
nLígth
 =  (
SECURITY_ATTRIBUTES
);

158 
obj
->
ß
.
ÕSecurôyDes¸ùt‹
 = &obj->
sd
;

159 
obj
->
ß
.
bInhîôH™dÀ
 = 
TRUE
;

160 i‡(!
	`InôülizeSecurôyDes¸ùt‹
 (&
obj
->
sd
, 
SECURITY_DESCRIPTOR_REVISION
))

161  
Ál£
;

162 i‡(!
	`SëSecurôyDes¸ùt‹Da˛
 (&
obj
->
sd
, 
TRUE
, 
NULL
, 
FALSE
))

163  
Ál£
;

164  
åue
;

165 
	}
}

167 
HANDLE


168 
	$¸óã_evít
 (c⁄° *
«me
, 
boﬁ
 
Ælow_Æl
, boﬁ 
öôül_°©e
, boﬁ 
m™uÆ_ª£t
)

170 i‡(
Ælow_Æl
)

172 
£curôy_©åibuãs
 
ß
;

173 i‡(!
	`öô_£curôy_©åibuãs_Ælow_Æl
 (&
ß
))

174  
NULL
;

175  
	`Cª©eEvít
 (&
ß
.ß, (
BOOL
)
m™uÆ_ª£t
, (BOOL)
öôül_°©e
, 
«me
);

178  
	`Cª©eEvít
 (
NULL
, (
BOOL
)
m™uÆ_ª£t
, (BOOL)
öôül_°©e
, 
«me
);

179 
	}
}

182 
	$˛o£_if_›í
 (
HANDLE
 
h
)

184 i‡(
h
 !
NULL
)

185 
	`Clo£H™dÀ
 (
h
);

186 
	}
}

188 
boﬁ


189 
	$m©ch
 (c⁄° 
WIN32_FIND_DATA
 *
föd
, c⁄° *
ext
)

191 
i
;

193 i‡(
föd
->
dwFûeAâribuãs
 & 
FILE_ATTRIBUTE_DIRECTORY
)

194  
Ál£
;

196 i‡(!
	`°æí
 (
ext
))

197  
åue
;

199 
i
 = 
	`°æí
 (
föd
->
cFûeName
Ë- såÀ¿(
ext
) - 1;

200 i‡(
i
 < 1)

201  
Ál£
;

203  
föd
->
cFûeName
[
i
] ='.' && !
	`_°ricmp
 (föd->cFûeNamê+ i + 1, 
ext
);

204 
	}
}

209 
boﬁ


210 
	$modext
 (*
de°
, 
size
, c⁄° *
§c
, c⁄° *
√wext
)

212 
i
;

214 i‡(
size
 > 0 && (
	`°æí
 (
§c
) + 1) <= size)

216 
	`°r˝y
 (
de°
, 
§c
);

217 
de°
 [
size
 - 1] = '\0';

218 
i
 = 
	`°æí
 (
de°
);

219 --
i
 >= 0)

221 i‡(
de°
[
i
] == '\\')

223 i‡(
de°
[
i
] == '.')

225 
de°
[
i
] = '\0';

229 i‡(
	`°æí
 (
de°
Ë+ såÀn(
√wext
Ë+ 2 <
size
)

231 
	`°rˇt
 (
de°
, ".");

232 
	`°rˇt
 (
de°
, 
√wext
);

233  
åue
;

235 
de°
 [0] = '\0';

237  
Ál£
;

238 
	}
}

240 
VOID
 
	$Sîvi˚Sèπ
 (
DWORD
 
dwArgc
, 
LPTSTR
 *
ÕszArgv
)

242 
exe_∑th
[
MAX_PATH
];

243 
c⁄fig_dú
[
MAX_PATH
];

244 
ext_°rög
[16];

245 
log_dú
[
MAX_PATH
];

246 
¥i‹ôy_°rög
[64];

247 
≠≥nd_°rög
[2];

249 
DWORD
 
¥i‹ôy
;

250 
boﬁ
 
≠≥nd
;

252 
	`Re£tEº‹
 ();

254 i‡(!
	`Rï‹tSètusToSCMgr
(
SERVICE_START_PENDING
, 
NO_ERROR
, 3000))

256 
	`MSG
 (
M_ERR
, "ReportStatusToSCMgr #1 failed");

257 
föish
;

263 
exô_evít
 = 
	`¸óã_evít
 (
EXIT_EVENT_NAME
, 
Ál£
, fÆ£, 
åue
);

264 i‡(!
exô_evít
)

266 
	`MSG
 (
M_ERR
, "CreateEvent failed");

267 
föish
;

274 i‡(
	`WaôF‹SögÀObje˘
 (
exô_evít
, 0Ë!
WAIT_TIMEOUT
)

276 
	`MSG
 (
M_ERR
, "ExitÉvent isálready signaled -- we wereÇot shut downÖroperly");

277 
föish
;

280 i‡(!
	`Rï‹tSètusToSCMgr
(
SERVICE_START_PENDING
, 
NO_ERROR
, 3000))

282 
	`MSG
 (
M_ERR
, "ReportStatusToSCMgr #2 failed");

283 
föish
;

290 
HKEY
 
›ív≤_key
;

291 
LONG
 
°©us
;

292 
DWORD
 
Àn
;

293 
DWORD
 
ty≥
;

295 c⁄° 
îr‹_f‹m©_°r
[] =

296 "Eº‹ quîyögÑegi°ry key o‡ty≥ REG_SZ: HKLM\\" 
REG_KEY
 "\\%s";

298 c⁄° 
îr‹_f‹m©_dw‹d
[] =

299 "Eº‹ quîyögÑegi°ry key o‡ty≥ REG_DWORD: HKLM\\" 
REG_KEY
 "\\%s";

301 
°©us
 = 
	`RegO≥nKeyEx
(

302 
HKEY_LOCAL_MACHINE
,

303 
REG_KEY
,

305 
KEY_READ
,

306 &
›ív≤_key
);

308 i‡(
°©us
 !
ERROR_SUCCESS
)

310 
	`SëLa°Eº‹
 (
°©us
);

311 
	`MSG
 (
M_SYSERR
, "Regi°ry key HKLM\\" 
REG_KEY
 "Çot found");

312 
föish
;

316 
	`QUERY_REG_STRING
 ("exe_∑th", 
exe_∑th
);

319 
	`QUERY_REG_STRING
 ("c⁄fig_dú", 
c⁄fig_dú
);

322 
	`QUERY_REG_STRING
 ("c⁄fig_ext", 
ext_°rög
);

325 
	`QUERY_REG_STRING
 ("log_dú", 
log_dú
);

328 
	`QUERY_REG_STRING
 ("¥i‹ôy", 
¥i‹ôy_°rög
);

331 
	`QUERY_REG_STRING
 ("log_≠≥nd", 
≠≥nd_°rög
);

333 
	`RegClo£Key
 (
›ív≤_key
);

337 
¥i‹ôy
 = 
NORMAL_PRIORITY_CLASS
;

338 i‡(!
	`_°ricmp
 (
¥i‹ôy_°rög
, "IDLE_PRIORITY_CLASS"))

339 
¥i‹ôy
 = 
IDLE_PRIORITY_CLASS
;

340 i‡(!
	`_°ricmp
 (
¥i‹ôy_°rög
, "BELOW_NORMAL_PRIORITY_CLASS"))

341 
¥i‹ôy
 = 
BELOW_NORMAL_PRIORITY_CLASS
;

342 i‡(!
	`_°ricmp
 (
¥i‹ôy_°rög
, "NORMAL_PRIORITY_CLASS"))

343 
¥i‹ôy
 = 
NORMAL_PRIORITY_CLASS
;

344 i‡(!
	`_°ricmp
 (
¥i‹ôy_°rög
, "ABOVE_NORMAL_PRIORITY_CLASS"))

345 
¥i‹ôy
 = 
ABOVE_NORMAL_PRIORITY_CLASS
;

346 i‡(!
	`_°ricmp
 (
¥i‹ôy_°rög
, "HIGH_PRIORITY_CLASS"))

347 
¥i‹ôy
 = 
HIGH_PRIORITY_CLASS
;

350 
	`MSG
 (
M_ERR
, "Unknow¿¥i‹ôyÇame: %s", 
¥i‹ôy_°rög
);

351 
föish
;

355 
≠≥nd
 = 
Ál£
;

356 i‡(
≠≥nd_°rög
[0] == '0')

357 
≠≥nd
 = 
Ál£
;

358 i‡(
≠≥nd_°rög
[0] == '1')

359 
≠≥nd
 = 
åue
;

362 
	`MSG
 (
M_ERR
, "Log fûê≠≥nd fœg (givíá†'%s'Ëmu° bê'0' o∏'1'", 
≠≥nd_°rög
);

363 
föish
;

371 
WIN32_FIND_DATA
 
föd_obj
;

372 
HANDLE
 
föd_h™dÀ
;

373 
BOOL
 
m‹e_fûes
;

374 
föd_°rög
[
MAX_PATH
];

376 
	`›ív≤_¢¥ötf
 (
föd_°rög
, 
MAX_PATH
, "%s\\*", 
c⁄fig_dú
);

378 
föd_h™dÀ
 = 
	`FödFú°Fûe
 (
föd_°rög
, &
föd_obj
);

379 i‡(
föd_h™dÀ
 =
INVALID_HANDLE_VALUE
)

381 
	`MSG
 (
M_ERR
, "C™nŸ gë c⁄figuøti⁄ fûêli° usög: %s", 
föd_°rög
);

382 
föish
;

389 
HANDLE
 
log_h™dÀ
 = 
NULL
;

390 
STARTUPINFO
 
°¨t_öfo
;

391 
PROCESS_INFORMATION
 
¥oc_öfo
;

392 
£curôy_©åibuãs
 
ß
;

393 
log_fûe
[
MAX_PATH
];

394 
log_∑th
[
MAX_PATH
];

395 
comm™d_löe
[256];

397 
	`CLEAR
 (
°¨t_öfo
);

398 
	`CLEAR
 (
¥oc_öfo
);

399 
	`CLEAR
 (
ß
);

401 i‡(!
	`Rï‹tSètusToSCMgr
(
SERVICE_START_PENDING
, 
NO_ERROR
, 3000))

403 
	`MSG
 (
M_ERR
, "ReportStatusToSCMgr #3 failed");

404 
	`FödClo£
 (
föd_h™dÀ
);

405 
föish
;

409 i‡(
	`m©ch
 (&
föd_obj
, 
ext_°rög
))

412 i‡(!
	`modext
 (
log_fûe
,  (log_fûe), 
föd_obj
.
cFûeName
, "log"))

414 
	`MSG
 (
M_ERR
, "C™nŸ c⁄°ru˘Üogfûê«mêba£d on: %s", 
föd_obj
.
cFûeName
);

415 
	`FödClo£
 (
föd_h™dÀ
);

416 
föish
;

418 
	`›ív≤_¢¥ötf
 (
log_∑th
, (log_path),

419 "%s\\%s", 
log_dú
, 
log_fûe
);

422 
	`›ív≤_¢¥ötf
 (
comm™d_löe
, (comm™d_löe), 
PACKAGE
 " --service %s 1 --config \"%s\"",

423 
EXIT_EVENT_NAME
,

424 
föd_obj
.
cFûeName
);

428 i‡(!
	`öô_£curôy_©åibuãs_Ælow_Æl
 (&
ß
))

430 
	`MSG
 (
M_SYSERR
, "InôülizeSecurôyDes¸ùt‹ sèπ_" 
PACKAGE
 " failed");

431 
föish
;

435 
log_h™dÀ
 = 
	`Cª©eFûe
 (
log_∑th
,

436 
GENERIC_WRITE
,

437 
FILE_SHARE_READ
,

438 &
ß
.sa,

439 
≠≥nd
 ? 
OPEN_ALWAYS
 : 
CREATE_ALWAYS
,

440 
FILE_ATTRIBUTE_NORMAL
,

441 
NULL
);

443 i‡(
log_h™dÀ
 =
INVALID_HANDLE_VALUE
)

445 
	`MSG
 (
M_SYSERR
, "C™nŸ o≥¿logfûe: %s", 
log_∑th
);

446 
	`FödClo£
 (
föd_h™dÀ
);

447 
föish
;

451 i‡(
≠≥nd
)

453 i‡(
	`SëFûePoöãr
 (
log_h™dÀ
, 0, 
NULL
, 
FILE_END
Ë=
INVALID_SET_FILE_POINTER
)

455 
	`MSG
 (
M_SYSERR
, "C™nŸ sìkÅÿíd o‡logfûe: %s", 
log_∑th
);

456 
	`FödClo£
 (
föd_h™dÀ
);

457 
föish
;

462 
	`GëSèπupInfo
(&
°¨t_öfo
);

463 
°¨t_öfo
.
cb
 = (start_info);

464 
°¨t_öfo
.
dwFœgs
 = 
STARTF_USESTDHANDLES
|
STARTF_USESHOWWINDOW
;

465 
°¨t_öfo
.
wShowWödow
 = 
SW_HIDE
;

466 
°¨t_öfo
.
hStdI≈ut
 = 
	`GëStdH™dÀ
(
STD_INPUT_HANDLE
);

467 
°¨t_öfo
.
hStdOuçut
 = sèπ_öfo.
hStdEº‹
 = 
log_h™dÀ
;

470 i‡(!
	`Cª©ePro˚ss
(
exe_∑th
,

471 
comm™d_löe
,

472 
NULL
,

473 
NULL
,

474 
TRUE
,

475 
¥i‹ôy
 | 
CREATE_NEW_CONSOLE
,

476 
NULL
,

477 
c⁄fig_dú
,

478 &
°¨t_öfo
,

479 &
¥oc_öfo
))

481 
	`MSG
 (
M_SYSERR
, "CreateProcess failed,Éxe='%s' cmdline='%s' dir='%s'",

482 
exe_∑th
,

483 
comm™d_löe
,

484 
c⁄fig_dú
);

486 
	`FödClo£
 (
föd_h™dÀ
);

487 
	`Clo£H™dÀ
 (
log_h™dÀ
);

488 
föish
;

492 
	`SÀï
 (1000);

494 i‡(!
	`Clo£H™dÀ
 (
¥oc_öfo
.
hPro˚ss
)

495 || !
	`Clo£H™dÀ
 (
¥oc_öfo
.
hThªad
)

496 || !
	`Clo£H™dÀ
 (
log_h™dÀ
))

498 
	`MSG
 (
M_SYSERR
, "CloseHandle failed");

499 
föish
;

504 
m‹e_fûes
 = 
	`FödNextFûe
 (
föd_h™dÀ
, &
föd_obj
);

506 } 
m‹e_fûes
);

508 
	`FödClo£
 (
föd_h™dÀ
);

512 i‡(!
	`Rï‹tSètusToSCMgr
(
SERVICE_RUNNING
, 
NO_ERROR
, 0))

514 
	`MSG
 (
M_ERR
, "ReportStatusToSCMgr SERVICE_RUNNING failed");

515 
föish
;

519 i‡(
	`WaôF‹SögÀObje˘
 (
exô_evít
, 
INFINITE
Ë!
WAIT_OBJECT_0
)

521 
	`MSG
 (
M_ERR
, "wait for shutdown signal failed");

524 
föish
:

525 
	`Sîvi˚St›
 ();

526 i‡(
exô_evít
)

527 
	`Clo£H™dÀ
 (
exô_evít
);

528 
	}
}

530 
VOID
 
	$Sîvi˚St›
()

532 i‡(
exô_evít
)

533 
	`SëEvít
(
exô_evít
);

534 
	}
}

	@src/openvpnserv/service.c

26 #ifde‡
HAVE_CONFIG_H


27 
	~"c⁄fig.h
"

28 #ñi‡
deföed
(
_MSC_VER
)

29 
	~"c⁄fig-msvc.h
"

31 
	~<wödows.h
>

32 
	~<°dio.h
>

33 
	~<°dlib.h
>

34 
	~<¥o˚ss.h
>

35 
	~<tch¨.h
>

37 
	~"£rvi˚.h
"

40 
SERVICE_STATUS
 
	gssSètus
;

41 
SERVICE_STATUS_HANDLE
 
	gsshSètusH™dÀ
;

42 
DWORD
 
	gdwEº
 = 0;

43 
BOOL
 
	gbDebug
 = 
FALSE
;

44 
TCHAR
 
	gszEº
[256];

47 
VOID
 
WINAPI
 
£rvi˚_˘æ
(
DWORD
 
dwCålCode
);

48 
VOID
 
WINAPI
 
£rvi˚_maö
(
DWORD
 
dwArgc
, 
LPTSTR
 *
ÕszArgv
);

49 
CmdIn°ÆlSîvi˚
();

50 
CmdRemoveSîvi˚
();

51 
CmdSèπSîvi˚
();

52 
VOID
 
CmdDebugSîvi˚
(
¨gc
, **
¨gv
);

53 
BOOL
 
WINAPI
 
C⁄åﬁH™dÀr
 ( 
DWORD
 
dwCålTy≥
 );

54 
LPTSTR
 
GëLa°Eº‹Text
–LPTSTR 
ÕszBuf
, 
DWORD
 
dwSize
 );

74 
__cde˛
 
	$maö
(
¨gc
, **
¨gv
)

76 
SERVICE_TABLE_ENTRY
 
di•©chTabÀ
[] =

78 { 
	`TEXT
(
SZSERVICENAME
), (
LPSERVICE_MAIN_FUNCTION
)
£rvi˚_maö
},

79 { 
NULL
, NULL}

82 i‡–(
¨gc
 > 1) &&

83 ((*
¨gv
[1] == '-') || (*argv[1] == '/')) )

85 i‡–
	`_°ricmp
–"ö°Æl", 
¨gv
[1]+1 ) == 0 )

87  
	`CmdIn°ÆlSîvi˚
();

89 i‡–
	`_°ricmp
–"ªmove", 
¨gv
[1]+1 ) == 0 )

91  
	`CmdRemoveSîvi˚
();

93 i‡–
	`_°ricmp
–"°¨t", 
¨gv
[1]+1 ) == 0)

95  
	`CmdSèπSîvi˚
();

97 i‡–
	`_°ricmp
–"debug", 
¨gv
[1]+1 ) == 0 )

99 
bDebug
 = 
TRUE
;

100 
	`CmdDebugSîvi˚
(
¨gc
, 
¨gv
);

104 
di•©ch
;

112 
di•©ch
:

114 
	`¥ötf
–"%†-ö°Æ»Åÿö°Æ»thê£rvi˚\n", 
SZAPPNAME
 );

115 
	`¥ötf
–"%†-°¨tÅÿ°¨àthê£rvi˚\n", 
SZAPPNAME
 );

116 
	`¥ötf
–"%†-ªmovêÅÿªmovêthê£rvi˚\n", 
SZAPPNAME
 );

117 
	`¥ötf
–"%†-debug <∑øms>Åÿru¿a†®c⁄sﬁê≠∞f‹ debuggög\n", 
SZAPPNAME
 );

118 
	`¥ötf
( "\nStartServiceCtrlDispatcher being called.\n" );

119 
	`¥ötf
( "This mayÅake several seconds. Please wait.\n" );

121 i‡(!
	`SèπSîvi˚CålDi•©chî
(
di•©chTabÀ
))

122 
	`AddToMesßgeLog
(
MSG_FLAGS_ERROR
, 
	`TEXT
("StartServiceCtrlDispatcher failed."));

125 
	}
}

146 
WINAPI
 
	$£rvi˚_maö
(
DWORD
 
dwArgc
, 
LPTSTR
 *
ÕszArgv
)

151 
sshSètusH™dÀ
 = 
	`Regi°îSîvi˚CålH™dÀr
–
	`TEXT
(
SZSERVICENAME
), 
£rvi˚_˘æ
);

153 i‡(!
sshSètusH™dÀ
)

154 
˛ónup
;

158 
ssSètus
.
dwSîvi˚Ty≥
 = 
SERVICE_WIN32_OWN_PROCESS
;

159 
ssSètus
.
dwSîvi˚S≥cificExôCode
 = 0;

164 i‡(!
	`Rï‹tSètusToSCMgr
(

165 
SERVICE_START_PENDING
,

166 
NO_ERROR
,

168 
˛ónup
;

171 
	`Sîvi˚Sèπ
–
dwArgc
, 
ÕszArgv
 );

173 
˛ónup
:

177 i‡(
sshSètusH™dÀ
)

178 (
VOID
)
	`Rï‹tSètusToSCMgr
(

179 
SERVICE_STOPPED
,

180 
dwEº
,

184 
	}
}

202 
VOID
 
WINAPI
 
	$£rvi˚_˘æ
(
DWORD
 
dwCålCode
)

206 
dwCålCode
)

215 
SERVICE_CONTROL_STOP
:

216 
	`Rï‹tSètusToSCMgr
(
SERVICE_STOP_PENDING
, 
NO_ERROR
, 0);

217 
	`Sîvi˚St›
();

222 
SERVICE_CONTROL_INTERROGATE
:

232 
	`Rï‹tSètusToSCMgr
(
ssSètus
.
dwCuºítSèã
, 
NO_ERROR
, 0);

233 
	}
}

254 
BOOL
 
	$Rï‹tSètusToSCMgr
(
DWORD
 
dwCuºítSèã
,

255 
DWORD
 
dwWö32ExôCode
,

256 
DWORD
 
dwWaôHöt
)

258 
DWORD
 
dwCheckPoöt
 = 1;

259 
BOOL
 
fResu…
 = 
TRUE
;

262 i‡–!
bDebug
 )

264 i‡(
dwCuºítSèã
 =
SERVICE_START_PENDING
)

265 
ssSètus
.
dwC⁄åﬁsAc˚±ed
 = 0;

267 
ssSètus
.
dwC⁄åﬁsAc˚±ed
 = 
SERVICE_ACCEPT_STOP
;

269 
ssSètus
.
dwCuºítSèã
 = dwCurrentState;

270 
ssSètus
.
dwWö32ExôCode
 = dwWin32ExitCode;

271 
ssSètus
.
dwWaôHöt
 = dwWaitHint;

273 i‡––
dwCuºítSèã
 =
SERVICE_RUNNING
 ) ||

274 –
dwCuºítSèã
 =
SERVICE_STOPPED
 ) )

275 
ssSètus
.
dwCheckPoöt
 = 0;

277 
ssSètus
.
dwCheckPoöt
 = dwCheckPoint++;

282 i‡(!(
fResu…
 = 
	`SëSîvi˚Sètus
–
sshSètusH™dÀ
, &
ssSètus
)))

284 
	`AddToMesßgeLog
(
MSG_FLAGS_ERROR
, 
	`TEXT
("SetServiceStatus"));

287  
fResu…
;

288 
	}
}

305 
	$AddToMesßgeLog
(
DWORD
 
Êags
, 
LPTSTR
 
ÕszMsg
)

307 
TCHAR
 
szMsg
 [((
SZSERVICENAME
) / (TCHAR)) + 100 ];

308 
HANDLE
 
hEvítSour˚
;

309 
LPCSTR
 
ÕszSåögs
[2];

311 i‡–!
bDebug
 )

313 i‡(
Êags
 & 
MSG_FLAGS_SYS_CODE
)

314 
dwEº
 = 
	`GëLa°Eº‹
();

316 
dwEº
 = 0;

320 
hEvítSour˚
 = 
	`Regi°îEvítSour˚
(
NULL
, 
	`TEXT
(
SZSERVICENAME
));

322 
	`_°¥ötf
(
szMsg
, 
	`TEXT
("%†îr‹: %d"), TEXT(
SZSERVICENAME
), ()
dwEº
);

323 
ÕszSåögs
[0] = 
szMsg
;

324 
ÕszSåögs
[1] = 
ÕszMsg
;

326 i‡(
hEvítSour˚
 !
NULL
)

328 
	`Rï‹tEvít
(
hEvítSour˚
,

330 (
Êags
 & 
MSG_FLAGS_ERROR
)

331 ? 
EVENTLOG_ERROR_TYPE
 : 
EVENTLOG_INFORMATION_TYPE
,

334 
NULL
,

337 
ÕszSåögs
,

338 
NULL
);

340 (
VOID
Ë
	`Dîegi°îEvítSour˚
(
hEvítSour˚
);

343 
	}
}

345 
	$Re£tEº‹
 ()

347 
dwEº
 = 0;

348 
	}
}

369 
	$CmdIn°ÆlSîvi˚
()

371 
SC_HANDLE
 
schSîvi˚
;

372 
SC_HANDLE
 
schSCM™agî
;

374 
TCHAR
 
szP©h
[512];

376 
ªt
 = 0;

378 i‡–
	`GëModuÀFûeName
–
NULL
, 
szP©h
+1, 510 ) == 0 )

380 
	`_çrötf
(
	`TEXT
("U«bÀÅÿö°Æ»%†- %s\n"), TEXT(
SZSERVICEDISPLAYNAME
), 
	`GëLa°Eº‹Text
(
szEº
, 256));

383 
szP©h
[0] = '\"';

384 
	`°rˇt
(
szP©h
, "\"");

386 
schSCM™agî
 = 
	`O≥nSCM™agî
(

387 
NULL
,

388 
NULL
,

389 
SC_MANAGER_CONNECT
 | 
SC_MANAGER_CREATE_SERVICE


391 i‡–
schSCM™agî
 )

393 
schSîvi˚
 = 
	`Cª©eSîvi˚
(

394 
schSCM™agî
,

395 
	`TEXT
(
SZSERVICENAME
),

396 
	`TEXT
(
SZSERVICEDISPLAYNAME
),

397 
SERVICE_QUERY_STATUS
,

398 
SERVICE_WIN32_OWN_PROCESS
,

399 
SERVICE_DEMAND_START
,

400 
SERVICE_ERROR_NORMAL
,

401 
szP©h
,

402 
NULL
,

403 
NULL
,

404 
	`TEXT
(
SZDEPENDENCIES
),

405 
NULL
,

406 
NULL
);

408 i‡–
schSîvi˚
 )

410 
	`_çrötf
(
	`TEXT
("%†ö°ÆÀd.\n"), TEXT(
SZSERVICEDISPLAYNAME
) );

411 
	`Clo£Sîvi˚H™dÀ
(
schSîvi˚
);

415 
	`_çrötf
(
	`TEXT
("Cª©eSîvi˚ faûed - %s\n"), 
	`GëLa°Eº‹Text
(
szEº
, 256));

416 
ªt
 = 1;

419 
	`Clo£Sîvi˚H™dÀ
(
schSCM™agî
);

423 
	`_çrötf
(
	`TEXT
("O≥nSCM™agî faûed - %s\n"), 
	`GëLa°Eº‹Text
(
szEº
,256));

424 
ªt
 = 1;

426  
ªt
;

427 
	}
}

442 
	$CmdSèπSîvi˚
()

444 
ªt
 = 0;

446 
SC_HANDLE
 
schSCM™agî
;

447 
SC_HANDLE
 
schSîvi˚
;

451 
schSCM™agî
 = 
	`O≥nSCM™agî
(

452 
NULL
,

453 
NULL
,

454 
SC_MANAGER_ALL_ACCESS
);

456 i‡(
NULL
 =
schSCM™agî
) {

457 
	`_çrötf
(
	`TEXT
("O≥nSCM™agî faûed - %s\n"), 
	`GëLa°Eº‹Text
(
szEº
,256));

458 
ªt
 = 1;

461 
schSîvi˚
 = 
	`O≥nSîvi˚
(

462 
schSCM™agî
,

463 
SZSERVICENAME
,

464 
SERVICE_ALL_ACCESS
);

466 i‡(
schSîvi˚
 =
NULL
) {

467 
	`_çrötf
(
	`TEXT
("O≥nSîvi˚ faûed - %s\n"), 
	`GëLa°Eº‹Text
(
szEº
,256));

468 
ªt
 = 1;

471 i‡(!
	`SèπSîvi˚
(

472 
schSîvi˚
,

474 
NULL
) )

476 
	`_çrötf
(
	`TEXT
("SèπSîvi˚ faûed - %s\n"), 
	`GëLa°Eº‹Text
(
szEº
,256));

477 
ªt
 = 1;

481 
	`_çrötf
(
	`TEXT
("Service Started\n"));

482 
ªt
 = 0;

484 
	`Clo£Sîvi˚H™dÀ
(
schSîvi˚
);

485 
	`Clo£Sîvi˚H™dÀ
(
schSCM™agî
);

486  
ªt
;

487 
	}
}

502 
	$CmdRemoveSîvi˚
()

504 
SC_HANDLE
 
schSîvi˚
;

505 
SC_HANDLE
 
schSCM™agî
;

507 
ªt
 = 0;

509 
schSCM™agî
 = 
	`O≥nSCM™agî
(

510 
NULL
,

511 
NULL
,

512 
SC_MANAGER_CONNECT


514 i‡–
schSCM™agî
 )

516 
schSîvi˚
 = 
	`O≥nSîvi˚
(
schSCM™agî
, 
	`TEXT
(
SZSERVICENAME
), 
DELETE
 | 
SERVICE_STOP
 | 
SERVICE_QUERY_STATUS
);

518 i‡(
schSîvi˚
)

521 i‡–
	`C⁄åﬁSîvi˚
–
schSîvi˚
, 
SERVICE_CONTROL_STOP
, &
ssSètus
 ) )

523 
	`_çrötf
(
	`TEXT
("St›pög %s."), TEXT(
SZSERVICEDISPLAYNAME
));

524 
	`SÀï
( 1000 );

526  
	`QuîySîvi˚Sètus
–
schSîvi˚
, &
ssSètus
 ) )

528 i‡–
ssSètus
.
dwCuºítSèã
 =
SERVICE_STOP_PENDING
 )

530 
	`_çrötf
(
	`TEXT
("."));

531 
	`SÀï
( 1000 );

537 i‡–
ssSètus
.
dwCuºítSèã
 =
SERVICE_STOPPED
 )

538 
	`_çrötf
(
	`TEXT
("\n%†°›≥d.\n"), TEXT(
SZSERVICEDISPLAYNAME
) );

541 
	`_çrötf
(
	`TEXT
("\n%†ÁûedÅÿ°›.\n"), TEXT(
SZSERVICEDISPLAYNAME
) );

542 
ªt
 = 1;

548 i‡–
	`DñëeSîvi˚
(
schSîvi˚
) )

549 
	`_çrötf
(
	`TEXT
("%†ªmoved.\n"), TEXT(
SZSERVICEDISPLAYNAME
) );

552 
	`_çrötf
(
	`TEXT
("DñëeSîvi˚ faûed - %s\n"), 
	`GëLa°Eº‹Text
(
szEº
,256));

553 
ªt
 = 1;

557 
	`Clo£Sîvi˚H™dÀ
(
schSîvi˚
);

561 
	`_çrötf
(
	`TEXT
("O≥nSîvi˚ faûed - %s\n"), 
	`GëLa°Eº‹Text
(
szEº
,256));

562 
ªt
 = 1;

565 
	`Clo£Sîvi˚H™dÀ
(
schSCM™agî
);

569 
	`_çrötf
(
	`TEXT
("O≥nSCM™agî faûed - %s\n"), 
	`GëLa°Eº‹Text
(
szEº
,256));

570 
ªt
 = 1;

572  
ªt
;

573 
	}
}

598 
	$CmdDebugSîvi˚
(
¨gc
, ** 
¨gv
)

600 
DWORD
 
dwArgc
;

601 
LPTSTR
 *
ÕszArgv
;

603 #ifde‡
UNICODE


604 
ÕszArgv
 = 
	`Comm™dLöeToArgvW
(
	`GëComm™dLöeW
(), &(
dwArgc
) );

605 i‡(
NULL
 =
ÕszArgv
)

608 
	`_çrötf
(
	`TEXT
("CmdDebugService CommandLineToArgvWÑeturned NULL\n"));

612 
dwArgc
 = (
DWORD
Ë
¨gc
;

613 
ÕszArgv
 = 
¨gv
;

616 
	`_çrötf
(
	`TEXT
("Debuggög %s.\n"), TEXT(
SZSERVICEDISPLAYNAME
));

618 
	`SëC⁄sﬁeCålH™dÀr
–
C⁄åﬁH™dÀr
, 
TRUE
 );

620 
	`Sîvi˚Sèπ
–
dwArgc
, 
ÕszArgv
 );

622 #ifde‡
UNICODE


625 
	`GlobÆFªe
(
ÕszArgv
);

628 
	}
}

645 
BOOL
 
WINAPI
 
	$C⁄åﬁH™dÀr
 ( 
DWORD
 
dwCålTy≥
 )

647  
dwCålTy≥
 )

649 
CTRL_BREAK_EVENT
:

650 
CTRL_C_EVENT
:

651 
	`_çrötf
(
	`TEXT
("St›pög %s.\n"), TEXT(
SZSERVICEDISPLAYNAME
));

652 
	`Sîvi˚St›
();

653  
TRUE
;

657  
FALSE
;

658 
	}
}

674 
LPTSTR
 
	$GëLa°Eº‹Text
–
LPTSTR
 
ÕszBuf
, 
DWORD
 
dwSize
 )

676 
DWORD
 
dwRë
;

677 
LPTSTR
 
ÕszTemp
 = 
NULL
;

679 
dwRë
 = 
	`F‹m©Mesßge
–
FORMAT_MESSAGE_ALLOCATE_BUFFER
 | 
FORMAT_MESSAGE_FROM_SYSTEM
 |
FORMAT_MESSAGE_ARGUMENT_ARRAY
,

680 
NULL
,

681 
	`GëLa°Eº‹
(),

682 
LANG_NEUTRAL
,

683 (
LPTSTR
)&
ÕszTemp
,

685 
NULL
 );

688 i‡–!
dwRë
 || ( ()
dwSize
 < ()dwRet+14 ) )

689 
ÕszBuf
[0] = 
	`TEXT
('\0');

692 
ÕszTemp
[
	`l°æí
÷pszTemp)-2] = 
	`TEXT
('\0');

693 
	`_°¥ötf
–
ÕszBuf
, 
	`TEXT
("%†(0x%x)"), 
ÕszTemp
, ()
	`GëLa°Eº‹
() );

696 i‡–
ÕszTemp
 )

697 
	`LoˇlFªe
((
HLOCAL
Ë
ÕszTemp
 );

699  
ÕszBuf
;

700 
	}
}

	@src/openvpnserv/service.h

52 #i‚de‡
_SERVICE_H


53 
	#_SERVICE_H


	)

56 #ifde‡
__˝lu•lus


64 
	#SZAPPNAME
 
PACKAGE
 "£rv"

	)

66 
	#SZSERVICENAME
 
PACKAGE_NAME
 "Sîvi˚"

	)

68 
	#SZSERVICEDISPLAYNAME
 
PACKAGE_NAME
 " Sîvi˚"

	)

70 
	#SZDEPENDENCIES
 
TAP_WIN_COMPONENT_ID
 "\0Dh˝\0\0"

	)

87 
VOID
 
Sîvi˚Sèπ
(
DWORD
 
dwArgc
, 
LPTSTR
 *
ÕszArgv
);

88 
VOID
 
Sîvi˚St›
();

114 
BOOL
 
Rï‹tSètusToSCMgr
(
DWORD
 
dwCuºítSèã
, DWORD 
dwWö32ExôCode
, DWORD 
dwWaôHöt
);

128 
	#MSG_FLAGS_ERROR
 (1<<0)

	)

129 
	#MSG_FLAGS_SYS_CODE
 (1<<1)

	)

130 
AddToMesßgeLog
(
DWORD
 
Êags
, 
LPTSTR
 
ÕszMsg
);

131 
Re£tEº‹
 ();

135 #ifde‡
__˝lu•lus


	@src/plugins/auth-pam/auth-pam.c

29 #ifde‡
HAVE_CONFIG_H


30 
	~<c⁄fig.h
>

33 
	~<£curôy/∑m_≠∂.h
>

35 #ifde‡
USE_PAM_DLOPEN


36 
	~"∑mdl.h
"

39 
	~<°dio.h
>

40 
	~<°rög.h
>

41 
	~<˘y≥.h
>

42 
	~<uni°d.h
>

43 
	~<°dlib.h
>

44 
	~<sys/ty≥s.h
>

45 
	~<sys/sockë.h
>

46 
	~<sys/waô.h
>

47 
	~<f˙é.h
>

48 
	~<sig«l.h
>

49 
	~<sy¶og.h
>

51 
	~<›ív≤-∂ugö.h
>

53 
	#DEBUG
(
vîb
Ë((vîbË>4)

	)

56 
	#COMMAND_VERIFY
 0

	)

57 
	#COMMAND_EXIT
 1

	)

60 
	#RESPONSE_INIT_SUCCEEDED
 10

	)

61 
	#RESPONSE_INIT_FAILED
 11

	)

62 
	#RESPONSE_VERIFY_SUCCEEDED
 12

	)

63 
	#RESPONSE_VERIFY_FAILED
 13

	)

68 
	sauth_∑m_c⁄ãxt


71 
	mf‹eground_fd
;

74 
pid_t
 
	mbackground_pid
;

77 
	mvîb
;

89 
	#N_NAME_VALUE
 16

	)

91 
	s«me_vÆue
 {

92 c⁄° *
	m«me
;

93 c⁄° *
	mvÆue
;

96 
	s«me_vÆue_li°
 {

97 
	mÀn
;

98 
«me_vÆue
 
	md©a
[
N_NAME_VALUE
];

105 
	su£r_∑ss
 {

106 
	mvîb
;

108 
	mu£∫ame
[128];

109 
	m∑ssw‹d
[128];

110 
	mcomm⁄_«me
[128];

112 c⁄° 
«me_vÆue_li°
 *
	m«me_vÆue_li°
;

116 
∑m_£rvî
 (
fd
, c⁄° *
£rvi˚
, 
vîb
, c⁄° 
«me_vÆue_li°
 *name_value_list);

124 
	$£¨ch™dª∂a˚
(c⁄° *
to£¨ch
, c⁄° *
£¨chf‹
, c⁄° *
ª∂a˚wôh
)

126 c⁄° *
£¨chög
=
to£¨ch
;

127 *
s¸©ch
;

128 
ãmp
[
	`°æí
(
to£¨ch
)*10];

129 
ãmp
[0]=0;

131 i‡(!
to£¨ch
 || !
£¨chf‹
 || !
ª∂a˚wôh
)  0;

132 i‡(!
	`°æí
(
to£¨ch
Ë|| !°æí(
£¨chf‹
Ë|| !°æí(
ª∂a˚wôh
))  0;

134 
s¸©ch
 = 
	`°r°r
(
£¨chög
,
£¨chf‹
);

135 i‡(!
s¸©ch
Ë 
	`°rdup
(
to£¨ch
);

137 
s¸©ch
) {

138 
	`°∫ˇt
(
ãmp
,
£¨chög
,
s¸©ch
-searching);

139 
	`°rˇt
(
ãmp
,
ª∂a˚wôh
);

141 
£¨chög
=
s¸©ch
+
	`°æí
(
£¨chf‹
);

142 
s¸©ch
 = 
	`°r°r
(
£¨chög
,
£¨chf‹
);

144  
	`°rdup
(
ãmp
);

145 
	}
}

153 
	$gë_ív
 (c⁄° *
«me
, c⁄° *
ívp
[])

155 i‡(
ívp
)

157 
i
;

158 c⁄° 
«mñí
 = 
	`°æí
 (
«me
);

159 
i
 = 0; 
ívp
[i]; ++i)

161 i‡(!
	`°∫cmp
 (
ívp
[
i
], 
«me
, 
«mñí
))

163 c⁄° *
˝
 = 
ívp
[
i
] + 
«mñí
;

164 i‡(*
˝
 == '=')

165  
˝
 + 1;

169  
NULL
;

170 
	}
}

176 
	$°rög_¨øy_Àn
 (c⁄° *
¨øy
[])

178 
i
 = 0;

179 i‡(
¨øy
)

181 
¨øy
[
i
])

182 ++
i
;

184  
i
;

185 
	}
}

192 
	$ªcv_c⁄åﬁ
 (
fd
)

194 
c
;

195 c⁄° 
ssize_t
 
size
 = 
	`ªad
 (
fd
, &
c
,  (c));

196 i‡(
size
 = (
c
))

197  
c
;

203 
	}
}

206 
	$£nd_c⁄åﬁ
 (
fd
, 
code
)

208 
c
 = (Ë
code
;

209 c⁄° 
ssize_t
 
size
 = 
	`wrôe
 (
fd
, &
c
,  (c));

210 i‡(
size
 = (
c
))

211  (Ë
size
;

214 
	}
}

217 
	$ªcv_°rög
 (
fd
, *
buf„r
, 
Àn
)

219 i‡(
Àn
 > 0)

221 
ssize_t
 
size
;

222 
	`mem£t
 (
buf„r
, 0, 
Àn
);

223 
size
 = 
	`ªad
 (
fd
, 
buf„r
, 
Àn
);

224 
buf„r
[
Àn
-1] = 0;

225 i‡(
size
 >= 1)

226  ()
size
;

229 
	}
}

232 
	$£nd_°rög
 (
fd
, c⁄° *
°rög
)

234 c⁄° 
Àn
 = 
	`°æí
 (
°rög
) + 1;

235 c⁄° 
ssize_t
 
size
 = 
	`wrôe
 (
fd
, 
°rög
, 
Àn
);

236 i‡(
size
 =
Àn
)

237  (Ë
size
;

240 
	}
}

242 #ifde‡
DO_DAEMONIZE


250 
	$d´m⁄ize
 (c⁄° *
ívp
[])

252 c⁄° *
d´m⁄_°rög
 = 
	`gë_ív
 ("d´m⁄", 
ívp
);

253 i‡(
d´m⁄_°rög
 && daemon_string[0] == '1')

255 c⁄° *
log_ªdúe˘
 = 
	`gë_ív
 ("d´m⁄_log_ªdúe˘", 
ívp
);

256 
fd
 = -1;

257 i‡(
log_ªdúe˘
 &&Üog_redirect[0] == '1')

258 
fd
 = 
	`dup
 (2);

259 i‡(
	`d´m⁄
 (0, 0) < 0)

261 
	`Ârötf
 (
°dîr
, "AUTH-PAM: daemonization failed\n");

263 i‡(
fd
 >= 3)

265 
	`dup2
 (
fd
, 2);

266 
	`˛o£
 (
fd
);

269 
	}
}

284 
	$˛o£_fds_ex˚±
 (
kìp
)

286 
i
;

287 
	`˛o£log
 ();

288 
i
 = 3; i <= 100; ++i)

290 i‡(
i
 !
kìp
)

291 
	`˛o£
 (
i
);

293 
	}
}

300 
	$£t_sig«ls
 ()

302 
	`sig«l
 (
SIGTERM
, 
SIG_DFL
);

304 
	`sig«l
 (
SIGINT
, 
SIG_IGN
);

305 
	`sig«l
 (
SIGHUP
, 
SIG_IGN
);

306 
	`sig«l
 (
SIGUSR1
, 
SIG_IGN
);

307 
	`sig«l
 (
SIGUSR2
, 
SIG_IGN
);

308 
	`sig«l
 (
SIGPIPE
, 
SIG_IGN
);

309 
	}
}

315 
	$«me_vÆue_m©ch
 (c⁄° *
quîy
, c⁄° *
m©ch
)

317 !
	`iß um
 (*
quîy
))

319 i‡(*
quîy
 == '\0')

321 ++
quîy
;

323  
	`°∫ˇ£cmp
 (
m©ch
, 
quîy
, 
	`°æí
 (match)) == 0;

324 
	}
}

326 
OPENVPN_EXPORT
 
›ív≤_∂ugö_h™dÀ_t


327 
	$›ív≤_∂ugö_›í_v1
 (*
ty≥_mask
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

329 
pid_t
 
pid
;

330 
fd
[2];

332 
auth_∑m_c⁄ãxt
 *
c⁄ãxt
;

333 
«me_vÆue_li°
Çame_value_list;

335 c⁄° 
ba£_∑rms
 = 2;

340 
c⁄ãxt
 = (
auth_∑m_c⁄ãxt
 *Ë
	`ˇŒoc
 (1,  (auth_pam_context));

341 i‡(!
c⁄ãxt
)

342 
îr‹
;

343 
c⁄ãxt
->
f‹eground_fd
 = -1;

348 *
ty≥_mask
 = 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
);

354 i‡(
	`°rög_¨øy_Àn
 (
¨gv
Ë< 
ba£_∑rms
)

356 
	`Ârötf
 (
°dîr
, "AUTH-PAM:Çeed PAM serviceÖarameter\n");

357 
îr‹
;

364 
«me_vÆue_li°
.
Àn
 = 0;

365 i‡(
	`°rög_¨øy_Àn
 (
¨gv
Ë> 
ba£_∑rms
)

367 c⁄° 
nv_Àn
 = 
	`°rög_¨øy_Àn
 (
¨gv
Ë- 
ba£_∑rms
;

368 
i
;

370 i‡((
nv_Àn
 & 1Ë=1 || (nv_À¿/ 2Ë> 
N_NAME_VALUE
)

372 
	`Ârötf
 (
°dîr
, "AUTH-PAM: badÇame/valueÜistÜength\n");

373 
îr‹
;

376 
«me_vÆue_li°
.
Àn
 = 
nv_Àn
 / 2;

377 
i
 = 0; i < 
«me_vÆue_li°
.
Àn
; ++i)

379 c⁄° 
ba£
 = 
ba£_∑rms
 + 
i
 * 2;

380 
«me_vÆue_li°
.
d©a
[
i
].
«me
 = 
¨gv
[
ba£
];

381 
«me_vÆue_li°
.
d©a
[
i
].
vÆue
 = 
¨gv
[
ba£
+1];

389 c⁄° *
vîb_°rög
 = 
	`gë_ív
 ("vîb", 
ívp
);

390 i‡(
vîb_°rög
)

391 
c⁄ãxt
->
vîb
 = 
	`©oi
 (
vîb_°rög
);

398 i‡(
	`sockë∑ú
 (
PF_UNIX
, 
SOCK_DGRAM
, 0, 
fd
) == -1)

400 
	`Ârötf
 (
°dîr
, "AUTH-PAM: socketpair call failed\n");

401 
îr‹
;

408 
pid
 = 
	`f‹k
 ();

410 i‡(
pid
)

412 
°©us
;

418 
c⁄ãxt
->
background_pid
 = 
pid
;

421 
	`˛o£
 (
fd
[1]);

424 i‡(
	`f˙é
 (
fd
[0], 
F_SETFD
, 
FD_CLOEXEC
) < 0)

425 
	`Ârötf
 (
°dîr
, "AUTH-PAM: Set FD_CLOEXEC flag on socket file descriptor failed\n");

428 
°©us
 = 
	`ªcv_c⁄åﬁ
 (
fd
[0]);

429 i‡(
°©us
 =
RESPONSE_INIT_SUCCEEDED
)

431 
c⁄ãxt
->
f‹eground_fd
 = 
fd
[0];

432  (
›ív≤_∂ugö_h™dÀ_t
Ë
c⁄ãxt
;

442 
	`˛o£_fds_ex˚±
 (
fd
[1]);

445 
	`£t_sig«ls
 ();

447 #ifde‡
DO_DAEMONIZE


449 
	`d´m⁄ize
 (
ívp
);

453 
	`∑m_£rvî
 (
fd
[1], 
¨gv
[1], 
c⁄ãxt
->
vîb
, &
«me_vÆue_li°
);

455 
	`˛o£
 (
fd
[1]);

457 
	`exô
 (0);

461 
îr‹
:

462 i‡(
c⁄ãxt
)

463 
	`‰ì
 (
c⁄ãxt
);

464  
NULL
;

465 
	}
}

467 
OPENVPN_EXPORT
 

468 
	$›ív≤_∂ugö_func_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
, c⁄° 
ty≥
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

470 
auth_∑m_c⁄ãxt
 *
c⁄ãxt
 = (auth_∑m_c⁄ãxà*Ë
h™dÀ
;

472 i‡(
ty≥
 =
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
 && 
c⁄ãxt
->
f‹eground_fd
 >= 0)

475 c⁄° *
u£∫ame
 = 
	`gë_ív
 ("u£∫ame", 
ívp
);

476 c⁄° *
∑ssw‹d
 = 
	`gë_ív
 ("∑ssw‹d", 
ívp
);

477 c⁄° *
comm⁄_«me
 = 
	`gë_ív
 ("comm⁄_«me", 
ívp
) ? get_env ("common_name",Énvp) : "";

479 i‡(
u£∫ame
 && 
	`°æí
 (u£∫ameË> 0 && 
∑ssw‹d
)

481 i‡(
	`£nd_c⁄åﬁ
 (
c⁄ãxt
->
f‹eground_fd
, 
COMMAND_VERIFY
) == -1

482 || 
	`£nd_°rög
 (
c⁄ãxt
->
f‹eground_fd
, 
u£∫ame
) == -1

483 || 
	`£nd_°rög
 (
c⁄ãxt
->
f‹eground_fd
, 
∑ssw‹d
) == -1

484 || 
	`£nd_°rög
 (
c⁄ãxt
->
f‹eground_fd
, 
comm⁄_«me
) == -1)

486 
	`Ârötf
 (
°dîr
, "AUTH-PAM: Error sendingáuth infoÅo backgroundÖrocess\n");

490 c⁄° 
°©us
 = 
	`ªcv_c⁄åﬁ
 (
c⁄ãxt
->
f‹eground_fd
);

491 i‡(
°©us
 =
RESPONSE_VERIFY_SUCCEEDED
)

492  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

493 i‡(
°©us
 == -1)

494 
	`Ârötf
 (
°dîr
, "AUTH-PAM: ErrorÑeceivingáuth confirmation from backgroundÖrocess\n");

498  
OPENVPN_PLUGIN_FUNC_ERROR
;

499 
	}
}

501 
OPENVPN_EXPORT
 

502 
	$›ív≤_∂ugö_˛o£_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
)

504 
auth_∑m_c⁄ãxt
 *
c⁄ãxt
 = (auth_∑m_c⁄ãxà*Ë
h™dÀ
;

506 i‡(
	`DEBUG
 (
c⁄ãxt
->
vîb
))

507 
	`Ârötf
 (
°dîr
, "AUTH-PAM: close\n");

509 i‡(
c⁄ãxt
->
f‹eground_fd
 >= 0)

512 i‡(
	`£nd_c⁄åﬁ
 (
c⁄ãxt
->
f‹eground_fd
, 
COMMAND_EXIT
) == -1)

513 
	`Ârötf
 (
°dîr
, "AUTH-PAM: Error signaling backgroundÖrocessÅoÉxit\n");

516 i‡(
c⁄ãxt
->
background_pid
 > 0)

517 
	`waôpid
 (
c⁄ãxt
->
background_pid
, 
NULL
, 0);

519 
	`˛o£
 (
c⁄ãxt
->
f‹eground_fd
);

520 
c⁄ãxt
->
f‹eground_fd
 = -1;

523 
	`‰ì
 (
c⁄ãxt
);

524 
	}
}

526 
OPENVPN_EXPORT
 

527 
	$›ív≤_∂ugö_ab‹t_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
)

529 
auth_∑m_c⁄ãxt
 *
c⁄ãxt
 = (auth_∑m_c⁄ãxà*Ë
h™dÀ
;

532 i‡(
c⁄ãxt
 && c⁄ãxt->
f‹eground_fd
 >= 0)

534 
	`£nd_c⁄åﬁ
 (
c⁄ãxt
->
f‹eground_fd
, 
COMMAND_EXIT
);

535 
	`˛o£
 (
c⁄ãxt
->
f‹eground_fd
);

536 
c⁄ãxt
->
f‹eground_fd
 = -1;

538 
	}
}

544 
	$my_c⁄v
 (
n
, c⁄° 
∑m_mesßge
 **
msg_¨øy
,

545 
∑m_ª•⁄£
 **
ª•⁄£_¨øy
, *
≠pd©a_±r
)

547 c⁄° 
u£r_∑ss
 *
up
 = ( c⁄° u£r_∑s†*Ë
≠pd©a_±r
;

548 
∑m_ª•⁄£
 *
¨e•
;

549 
i
;

550 
ªt
 = 
PAM_SUCCESS
;

552 *
ª•⁄£_¨øy
 = 
NULL
;

554 i‡(
n
 <0 ||Ç > 
PAM_MAX_NUM_MSG
)

555  (
PAM_CONV_ERR
);

556 i‡((
¨e•
 = 
	`ˇŒoc
 (
n
,  *¨e•)Ë=
NULL
)

557  (
PAM_BUF_ERR
);

560 
i
 = 0; i < 
n
; ++i)

562 c⁄° 
∑m_mesßge
 *
msg
 = 
msg_¨øy
[
i
];

563 
¨e•
[
i
].
ª•_ªtcode
 = 0;

564 
¨e•
[
i
].
ª•
 = 
NULL
;

566 i‡(
	`DEBUG
 (
up
->
vîb
))

568 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND: my_conv[%d] query='%s' style=%d\n",

569 
i
,

570 
msg
->msg ? msg->msg : "NULL",

571 
msg
->
msg_°yÀ
);

574 i‡(
up
->
«me_vÆue_li°
 && up->«me_vÆue_li°->
Àn
 > 0)

577 c⁄° 
«me_vÆue_li°
 *
li°
 = 
up
->name_value_list;

578 
j
;

581 
j
 = 0; j < 
li°
->
Àn
; ++j)

583 c⁄° *
m©ch_«me
 = 
li°
->
d©a
[
j
].
«me
;

584 c⁄° *
m©ch_vÆue
 = 
li°
->
d©a
[
j
].
vÆue
;

586 i‡(
	`«me_vÆue_m©ch
 (
msg
->msg, 
m©ch_«me
))

589 
¨e•
[
i
].
ª•
 = 
NULL
;

591 i‡(
	`DEBUG
 (
up
->
vîb
))

592 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND:Çame match found, query/match-string ['%s', '%s'] = '%s'\n",

593 
msg
->msg,

594 
m©ch_«me
,

595 
m©ch_vÆue
);

597 i‡(
	`°r°r
(
m©ch_vÆue
, "USERNAME"))

598 
¨e•
[
i
].
ª•
 = 
	`£¨ch™dª∂a˚
(
m©ch_vÆue
, "USERNAME", 
up
->
u£∫ame
);

599 i‡(
	`°r°r
(
m©ch_vÆue
, "PASSWORD"))

600 
¨e•
[
i
].
ª•
 = 
	`£¨ch™dª∂a˚
(
m©ch_vÆue
, "PASSWORD", 
up
->
∑ssw‹d
);

601 i‡(
	`°r°r
(
m©ch_vÆue
, "COMMONNAME"))

602 
¨e•
[
i
].
ª•
 = 
	`£¨ch™dª∂a˚
(
m©ch_vÆue
, "COMMONNAME", 
up
->
comm⁄_«me
);

604 
¨e•
[
i
].
ª•
 = 
	`°rdup
 (
m©ch_vÆue
);

606 i‡(
¨e•
[
i
].
ª•
 =
NULL
)

607 
ªt
 = 
PAM_CONV_ERR
;

612 i‡(
j
 =
li°
->
Àn
)

613 
ªt
 = 
PAM_CONV_ERR
;

618 
msg
->
msg_°yÀ
)

620 
PAM_PROMPT_ECHO_OFF
:

621 
¨e•
[
i
].
ª•
 = 
	`°rdup
 (
up
->
∑ssw‹d
);

622 i‡(
¨e•
[
i
].
ª•
 =
NULL
)

623 
ªt
 = 
PAM_CONV_ERR
;

626 
PAM_PROMPT_ECHO_ON
:

627 
¨e•
[
i
].
ª•
 = 
	`°rdup
 (
up
->
u£∫ame
);

628 i‡(
¨e•
[
i
].
ª•
 =
NULL
)

629 
ªt
 = 
PAM_CONV_ERR
;

632 
PAM_ERROR_MSG
:

633 
PAM_TEXT_INFO
:

637 
ªt
 = 
PAM_CONV_ERR
;

643 i‡(
ªt
 =
PAM_SUCCESS
)

644 *
ª•⁄£_¨øy
 = 
¨e•
;

645  
ªt
;

646 
	}
}

654 
	$∑m_auth
 (c⁄° *
£rvi˚
, c⁄° 
u£r_∑ss
 *
up
)

656 
∑m_c⁄v
 
c⁄v
;

657 
∑m_h™dÀ_t
 *
∑mh
 = 
NULL
;

658 
°©us
 = 
PAM_SUCCESS
;

659 
ªt
 = 0;

660 c⁄° 
«me_vÆue_li°_¥ovided
 = (
up
->
«me_vÆue_li°
 && up->«me_vÆue_li°->
Àn
 > 0);

663 
c⁄v
.c⁄v = 
my_c⁄v
;

664 
c⁄v
.
≠pd©a_±r
 = (*)
up
;

665 
°©us
 = 
	`∑m_°¨t
 (
£rvi˚
, 
«me_vÆue_li°_¥ovided
 ? 
NULL
 : 
up
->
u£∫ame
, &
c⁄v
, &
∑mh
);

666 i‡(
°©us
 =
PAM_SUCCESS
)

669 
°©us
 = 
	`∑m_authítiˇã
(
∑mh
, 0);

670 i‡(
°©us
 =
PAM_SUCCESS
)

671 
°©us
 = 
	`∑m_ac˘_mgmt
 (
∑mh
, 0);

672 i‡(
°©us
 =
PAM_SUCCESS
)

673 
ªt
 = 1;

676 i‡(!
ªt
)

678 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND: user '%s' failedÅoáuthenticate: %s\n",

679 
up
->
u£∫ame
,

680 
	`∑m_°ªº‹
 (
∑mh
, 
°©us
));

684 
	`∑m_íd
 (
∑mh
, 
°©us
);

687  
ªt
;

688 
	}
}

694 
	$∑m_£rvî
 (
fd
, c⁄° *
£rvi˚
, 
vîb
, c⁄° 
«me_vÆue_li°
 *name_value_list)

696 
u£r_∑ss
 
up
;

697 
comm™d
;

698 #ifde‡
USE_PAM_DLOPEN


699 c⁄° 
∑m_so
[] = "libpam.so";

705 i‡(
	`DEBUG
 (
vîb
))

706 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND: INIT sîvi˚='%s'\n", 
£rvi˚
);

708 #ifde‡
USE_PAM_DLOPEN


712 i‡(!
	`dl›í_∑m
 (
∑m_so
))

714 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND: couldÇŸÜﬂd PAMÜib %s: %s\n", 
∑m_so
, 
	`dÀº‹
());

715 
	`£nd_c⁄åﬁ
 (
fd
, 
RESPONSE_INIT_FAILED
);

716 
d⁄e
;

723 i‡(
	`£nd_c⁄åﬁ
 (
fd
, 
RESPONSE_INIT_SUCCEEDED
) == -1)

725 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND: writeÉrror onÑesponse socket [1]\n");

726 
d⁄e
;

734 
	`mem£t
 (&
up
, 0,  (up));

735 
up
.
vîb
 = verb;

736 
up
.
«me_vÆue_li°
 =Çame_value_list;

739 
comm™d
 = 
	`ªcv_c⁄åﬁ
 (
fd
);

741 i‡(
	`DEBUG
 (
vîb
))

742 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND:Ñe˚ived comm™d code: %d\n", 
comm™d
);

744 
comm™d
)

746 
COMMAND_VERIFY
:

747 i‡(
	`ªcv_°rög
 (
fd
, 
up
.
u£∫ame
,  (up.username)) == -1

748 || 
	`ªcv_°rög
 (
fd
, 
up
.
∑ssw‹d
,  (up.password)) == -1

749 || 
	`ªcv_°rög
 (
fd
, 
up
.
comm⁄_«me
,  (up.common_name)) == -1)

751 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND:ÑeadÉrror on command channel: code=%d,Éxiting\n",

752 
comm™d
);

753 
d⁄e
;

756 i‡(
	`DEBUG
 (
vîb
))

759 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND: USER/PASS: %s/%s\n",

760 
up
.
u£∫ame
, up.
∑ssw‹d
);

762 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND: USER: %s\n", 
up
.
u£∫ame
);

766 i‡(
	`∑m_auth
 (
£rvi˚
, &
up
))

768 i‡(
	`£nd_c⁄åﬁ
 (
fd
, 
RESPONSE_VERIFY_SUCCEEDED
) == -1)

770 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND: writeÉrror onÑesponse socket [2]\n");

771 
d⁄e
;

776 i‡(
	`£nd_c⁄åﬁ
 (
fd
, 
RESPONSE_VERIFY_FAILED
) == -1)

778 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND: writeÉrror onÑesponse socket [3]\n");

779 
d⁄e
;

784 
COMMAND_EXIT
:

785 
d⁄e
;

788 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND:ÑeadÉrror on command channel\n");

789 
d⁄e
;

792 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND: unknown command code: code=%d,Éxiting\n",

793 
comm™d
);

794 
d⁄e
;

797 
d⁄e
:

799 #ifde‡
USE_PAM_DLOPEN


800 
	`dl˛o£_∑m
 ();

802 i‡(
	`DEBUG
 (
vîb
))

803 
	`Ârötf
 (
°dîr
, "AUTH-PAM: BACKGROUND: EXIT\n");

806 
	}
}

	@src/plugins/auth-pam/pamdl.c

1 #ifde‡
HAVE_CONFIG_H


2 
	~<c⁄fig.h
>

5 #ifde‡
USE_PAM_DLOPEN


14 
	~<°dio.h
>

15 
	~<dlf˙.h
>

16 
	~<£curôy/∑m_≠∂.h
>

18 
	~"∑mdl.h
"

20 *
	glib∑m_h
 = 
NULL
;

22 
	#RESOLVE_PAM_FUNCTION
(
x
, 
y
, 
z
, 
îr
) \

24 uni⁄ { c⁄° *
çoöãr
; 
	`y
 (*
‚
Ë
z
 ; } 
Âå
; \

25 
Âå
.
çoöãr
 = 
	`dlsym
(
lib∑m_h
, #x); 
ªÆ_
##
x
 = f±r.
‚
; \

26 i‡(
ªÆ_
##
x
 =
NULL
) { \

27 
	`Ârötf
 (
°dîr
, "PAMDL: u«bÀÅÿªsﬁvê'%s': %s\n", #x, 
	`dÀº‹
()); \

28  
îr
; \

30 }

	)

33 
	$dl›í_∑m
 (c⁄° *
so
)

35 i‡(
lib∑m_h
 =
NULL
)

37 
lib∑m_h
 = 
	`dl›í
(
so
, 
RTLD_GLOBAL
|
RTLD_NOW
);

39  
lib∑m_h
 !
NULL
;

40 
	}
}

43 
	$dl˛o£_∑m
 ()

45 i‡(
lib∑m_h
 !
NULL
)

47 
	`dl˛o£
(
lib∑m_h
);

48 
lib∑m_h
 = 
NULL
;

50 
	}
}

52 
	$∑m_°¨t
(c⁄° *
£rvi˚_«me
, c⁄° *
u£r
,

53 c⁄° 
∑m_c⁄v
 *
∑m_c⁄vîßti⁄
,

54 
∑m_h™dÀ_t
 **
∑mh
)

56 (*
ªÆ_∑m_°¨t
)(const *, const *,

57 c⁄° 
∑m_c⁄v
 *,

58 
∑m_h™dÀ_t
 **);

59 
	`RESOLVE_PAM_FUNCTION
(
∑m_°¨t
, , (const *, const *,

60 c⁄° 
∑m_c⁄v
 *,

61 
∑m_h™dÀ_t
 **), 
PAM_ABORT
);

62  
	`ªÆ_∑m_°¨t
(
£rvi˚_«me
, 
u£r
, 
∑m_c⁄vîßti⁄
, 
∑mh
);

63 
	}
}

65 
	$∑m_íd
(
∑m_h™dÀ_t
 *
∑mh
, 
∑m_°©us
)

67 (*
ªÆ_∑m_íd
)(
∑m_h™dÀ_t
 *, );

68 
	`RESOLVE_PAM_FUNCTION
(
∑m_íd
, , (
∑m_h™dÀ_t
 *, ), 
PAM_ABORT
);

69  
	`ªÆ_∑m_íd
(
∑mh
, 
∑m_°©us
);

70 
	}
}

72 
	$∑m_£t_ôem
(
∑m_h™dÀ_t
 *
∑mh
, 
ôem_ty≥
, c⁄° *
ôem
)

74 (*
ªÆ_∑m_£t_ôem
)(
∑m_h™dÀ_t
 *, , const *);

75 
	`RESOLVE_PAM_FUNCTION
(
∑m_£t_ôem
, ,

76 (
∑m_h™dÀ_t
 *, , c⁄° *), 
PAM_ABORT
);

77  
	`ªÆ_∑m_£t_ôem
(
∑mh
, 
ôem_ty≥
, 
ôem
);

78 
	}
}

80 
	$∑m_gë_ôem
(c⁄° 
∑m_h™dÀ_t
 *
∑mh
, 
ôem_ty≥
, c⁄° **
ôem
)

82 (*
ªÆ_∑m_gë_ôem
)(c⁄° 
∑m_h™dÀ_t
 *, , const **);

83 
	`RESOLVE_PAM_FUNCTION
(
∑m_gë_ôem
, ,

84 (c⁄° 
∑m_h™dÀ_t
 *, , const **),

85 
PAM_ABORT
);

86  
	`ªÆ_∑m_gë_ôem
(
∑mh
, 
ôem_ty≥
, 
ôem
);

87 
	}
}

89 
	$∑m_Áû_dñay
(
∑m_h™dÀ_t
 *
∑mh
, 
mu£c_dñay
)

91 (*
ªÆ_∑m_Áû_dñay
)(
∑m_h™dÀ_t
 *, );

92 
	`RESOLVE_PAM_FUNCTION
(
∑m_Áû_dñay
, , (
∑m_h™dÀ_t
 *, ),

93 
PAM_ABORT
);

94  
	`ªÆ_∑m_Áû_dñay
(
∑mh
, 
mu£c_dñay
);

95 
	}
}

97 c⁄° * 
	tc⁄°_ch¨_poöãr
;

99 
c⁄°_ch¨_poöãr
 
	$∑m_°ªº‹
(
∑m_h™dÀ_t
 *
∑mh
, 
î∫um
)

101 
	`c⁄°_ch¨_poöãr
 (*
ªÆ_∑m_°ªº‹
)(
∑m_h™dÀ_t
 *, );

102 
	`RESOLVE_PAM_FUNCTION
(
∑m_°ªº‹
, 
c⁄°_ch¨_poöãr
,

103 (
∑m_h™dÀ_t
 *, ), 
NULL
);

104  
	`ªÆ_∑m_°ªº‹
(
∑mh
, 
î∫um
);

105 
	}
}

107 
	$∑m_puãnv
(
∑m_h™dÀ_t
 *
∑mh
, c⁄° *
«me_vÆue
)

109 (*
ªÆ_∑m_puãnv
)(
∑m_h™dÀ_t
 *, const *);

110 
	`RESOLVE_PAM_FUNCTION
(
∑m_puãnv
, , (
∑m_h™dÀ_t
 *, const *),

111 
PAM_ABORT
);

112  
	`ªÆ_∑m_puãnv
(
∑mh
, 
«me_vÆue
);

113 
	}
}

115 
c⁄°_ch¨_poöãr
 
	$∑m_gëív
(
∑m_h™dÀ_t
 *
∑mh
, c⁄° *
«me
)

117 
	`c⁄°_ch¨_poöãr
 (*
ªÆ_∑m_gëív
)(
∑m_h™dÀ_t
 *, const *);

118 
	`RESOLVE_PAM_FUNCTION
(
∑m_gëív
, 
c⁄°_ch¨_poöãr
,

119 (
∑m_h™dÀ_t
 *, c⁄° *), 
NULL
);

120  
	`ªÆ_∑m_gëív
(
∑mh
, 
«me
);

121 
	}
}

123 ** 
	tch¨_µoöãr
;

124 
ch¨_µoöãr
 
	$∑m_gëívli°
(
∑m_h™dÀ_t
 *
∑mh
)

126 
	`ch¨_µoöãr
 (*
ªÆ_∑m_gëívli°
)(
∑m_h™dÀ_t
 *);

127 
	`RESOLVE_PAM_FUNCTION
(
∑m_gëívli°
, 
ch¨_µoöãr
, (
∑m_h™dÀ_t
 *),

128 
NULL
);

129  
	`ªÆ_∑m_gëívli°
(
∑mh
);

130 
	}
}

134 
	$∑m_authítiˇã
(
∑m_h™dÀ_t
 *
∑mh
, 
Êags
)

136 (*
ªÆ_∑m_authítiˇã
)(
∑m_h™dÀ_t
 *, );

137 
	`RESOLVE_PAM_FUNCTION
(
∑m_authítiˇã
, , (
∑m_h™dÀ_t
 *, ),

138 
PAM_ABORT
);

139  
	`ªÆ_∑m_authítiˇã
(
∑mh
, 
Êags
);

140 
	}
}

142 
	$∑m_£t¸ed
(
∑m_h™dÀ_t
 *
∑mh
, 
Êags
)

144 (*
ªÆ_∑m_£t¸ed
)(
∑m_h™dÀ_t
 *, );

145 
	`RESOLVE_PAM_FUNCTION
(
∑m_£t¸ed
, , (
∑m_h™dÀ_t
 *, ), 
PAM_ABORT
);

146  
	`ªÆ_∑m_£t¸ed
(
∑mh
, 
Êags
);

147 
	}
}

151 
	$∑m_ac˘_mgmt
(
∑m_h™dÀ_t
 *
∑mh
, 
Êags
)

153 (*
ªÆ_∑m_ac˘_mgmt
)(
∑m_h™dÀ_t
 *, );

154 
	`RESOLVE_PAM_FUNCTION
(
∑m_ac˘_mgmt
, , (
∑m_h™dÀ_t
 *, ), 
PAM_ABORT
);

155  
	`ªÆ_∑m_ac˘_mgmt
(
∑mh
, 
Êags
);

156 
	}
}

160 
	$∑m_›í_£ssi⁄
(
∑m_h™dÀ_t
 *
∑mh
, 
Êags
)

162 (*
ªÆ_∑m_›í_£ssi⁄
)(
∑m_h™dÀ_t
 *, );

163 
	`RESOLVE_PAM_FUNCTION
(
∑m_›í_£ssi⁄
, , (
∑m_h™dÀ_t
 *, ),

164 
PAM_ABORT
);

165  
	`ªÆ_∑m_›í_£ssi⁄
(
∑mh
, 
Êags
);

166 
	}
}

168 
	$∑m_˛o£_£ssi⁄
(
∑m_h™dÀ_t
 *
∑mh
, 
Êags
)

170 (*
ªÆ_∑m_˛o£_£ssi⁄
)(
∑m_h™dÀ_t
 *, );

171 
	`RESOLVE_PAM_FUNCTION
(
∑m_˛o£_£ssi⁄
, , (
∑m_h™dÀ_t
 *, ),

172 
PAM_ABORT
);

173  
	`ªÆ_∑m_˛o£_£ssi⁄
(
∑mh
, 
Êags
);

174 
	}
}

178 
	$∑m_chauthtok
(
∑m_h™dÀ_t
 *
∑mh
, 
Êags
)

180 (*
ªÆ_∑m_chauthtok
)(
∑m_h™dÀ_t
 *, );

181 
	`RESOLVE_PAM_FUNCTION
(
∑m_chauthtok
, , (
∑m_h™dÀ_t
 *, ), 
PAM_ABORT
);

182  
	`ªÆ_∑m_chauthtok
(
∑mh
, 
Êags
);

183 
	}
}

	@src/plugins/auth-pam/pamdl.h

1 #ifde‡
USE_PAM_DLOPEN


3 
dl›í_∑m
 (c⁄° *
so
);

4 
dl˛o£_∑m
 ();

	@src/plugins/down-root/down-root.c

29 #ifde‡
HAVE_CONFIG_H


30 
	~<c⁄fig.h
>

33 
	~<°dio.h
>

34 
	~<°rög.h
>

35 
	~<uni°d.h
>

36 
	~<°dlib.h
>

37 
	~<sys/ty≥s.h
>

38 
	~<sys/sockë.h
>

39 
	~<sys/waô.h
>

40 
	~<f˙é.h
>

41 
	~<sig«l.h
>

42 
	~<sy¶og.h
>

44 
	~<›ív≤-∂ugö.h
>

46 
	#DEBUG
(
vîb
Ë((vîbË>7)

	)

49 
	#COMMAND_RUN_SCRIPT
 0

	)

50 
	#COMMAND_EXIT
 1

	)

53 
	#RESPONSE_INIT_SUCCEEDED
 10

	)

54 
	#RESPONSE_INIT_FAILED
 11

	)

55 
	#RESPONSE_SCRIPT_SUCCEEDED
 12

	)

56 
	#RESPONSE_SCRIPT_FAILED
 13

	)

59 
down_roŸ_£rvî
 (c⁄° 
fd
, *
comm™d
, c⁄° *
¨gv
[], c⁄° *
ívp
[], c⁄° 
vîb
);

64 
	sdown_roŸ_c⁄ãxt


67 
	mf‹eground_fd
;

70 
pid_t
 
	mbackground_pid
;

73 
	mvîb
;

76 *
	mcomm™d
;

85 
	$gë_ív
 (c⁄° *
«me
, c⁄° *
ívp
[])

87 i‡(
ívp
)

89 
i
;

90 c⁄° 
«mñí
 = 
	`°æí
 (
«me
);

91 
i
 = 0; 
ívp
[i]; ++i)

93 i‡(!
	`°∫cmp
 (
ívp
[
i
], 
«me
, 
«mñí
))

95 c⁄° *
˝
 = 
ívp
[
i
] + 
«mñí
;

96 i‡(*
˝
 == '=')

97  
˝
 + 1;

101  
NULL
;

102 
	}
}

108 
	$°rög_¨øy_Àn
 (c⁄° *
¨øy
[])

110 
i
 = 0;

111 i‡(
¨øy
)

113 
¨øy
[
i
])

114 ++
i
;

116  
i
;

117 
	}
}

124 
	$ªcv_c⁄åﬁ
 (
fd
)

126 
c
;

127 c⁄° 
ssize_t
 
size
 = 
	`ªad
 (
fd
, &
c
,  (c));

128 i‡(
size
 = (
c
))

129  
c
;

132 
	}
}

135 
	$£nd_c⁄åﬁ
 (
fd
, 
code
)

137 
c
 = (Ë
code
;

138 c⁄° 
ssize_t
 
size
 = 
	`wrôe
 (
fd
, &
c
,  (c));

139 i‡(
size
 = (
c
))

140  (Ë
size
;

143 
	}
}

151 
	$d´m⁄ize
 (c⁄° *
ívp
[])

153 c⁄° *
d´m⁄_°rög
 = 
	`gë_ív
 ("d´m⁄", 
ívp
);

154 i‡(
d´m⁄_°rög
 && daemon_string[0] == '1')

156 c⁄° *
log_ªdúe˘
 = 
	`gë_ív
 ("d´m⁄_log_ªdúe˘", 
ívp
);

157 
fd
 = -1;

158 i‡(
log_ªdúe˘
 &&Üog_redirect[0] == '1')

159 
fd
 = 
	`dup
 (2);

160 i‡(
	`d´m⁄
 (0, 0) < 0)

162 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: daemonization failed\n");

164 i‡(
fd
 >= 3)

166 
	`dup2
 (
fd
, 2);

167 
	`˛o£
 (
fd
);

170 
	}
}

183 
	$˛o£_fds_ex˚±
 (
kìp
)

185 
i
;

186 
	`˛o£log
 ();

187 
i
 = 3; i <= 100; ++i)

189 i‡(
i
 !
kìp
)

190 
	`˛o£
 (
i
);

192 
	}
}

199 
	$£t_sig«ls
 ()

201 
	`sig«l
 (
SIGTERM
, 
SIG_DFL
);

203 
	`sig«l
 (
SIGINT
, 
SIG_IGN
);

204 
	`sig«l
 (
SIGHUP
, 
SIG_IGN
);

205 
	`sig«l
 (
SIGUSR1
, 
SIG_IGN
);

206 
	`sig«l
 (
SIGUSR2
, 
SIG_IGN
);

207 
	`sig«l
 (
SIGPIPE
, 
SIG_IGN
);

208 
	}
}

214 
	$sy°em_ok
 (
°©
)

216 #ifde‡
WIN32


217  
°©
 == 0;

219  
°©
 !-1 && 
	`WIFEXITED
 (°©Ë&& 
	`WEXITSTATUS
 (stat) == 0;

221 
	}
}

224 
	$buûd_comm™d_löe
 (c⁄° *
¨gv
[])

226 
size
 = 0;

227 
n
 = 0;

228 
i
;

229 *
°rög
;

232 i‡(
¨gv
)

234 
i
 = 0; 
¨gv
[i]; ++i)

236 
size
 +(
	`°æí
 (
¨gv
[
i
]) + 1);

237 ++
n
;

240 ++
size
;

243 
°rög
 = (*Ë
	`mÆloc
 (
size
);

244 i‡(!
°rög
)

246 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: out of memory\n");

247 
	`exô
 (1);

249 
°rög
[0] = '\0';

252 
i
 = 0; i < 
n
; ++i)

254 
	`°rˇt
 (
°rög
, 
¨gv
[
i
]);

255 i‡(
i
 + 1 < 
n
)

256 
	`°rˇt
 (
°rög
, " ");

258  
°rög
;

259 
	}
}

262 
	$‰ì_c⁄ãxt
 (
down_roŸ_c⁄ãxt
 *
c⁄ãxt
)

264 i‡(
c⁄ãxt
)

266 i‡(
c⁄ãxt
->
comm™d
)

267 
	`‰ì
 (
c⁄ãxt
->
comm™d
);

268 
	`‰ì
 (
c⁄ãxt
);

270 
	}
}

272 
OPENVPN_EXPORT
 
›ív≤_∂ugö_h™dÀ_t


273 
	$›ív≤_∂ugö_›í_v1
 (*
ty≥_mask
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

275 
down_roŸ_c⁄ãxt
 *
c⁄ãxt
;

280 
c⁄ãxt
 = (
down_roŸ_c⁄ãxt
 *Ë
	`ˇŒoc
 (1,  (down_root_context));

281 i‡(!
c⁄ãxt
)

282 
îr‹
;

283 
c⁄ãxt
->
f‹eground_fd
 = -1;

288 *
ty≥_mask
 = 
	`OPENVPN_PLUGIN_MASK
 (
OPENVPN_PLUGIN_UP
Ë| OPENVPN_PLUGIN_MASK (
OPENVPN_PLUGIN_DOWN
);

294 i‡(
	`°rög_¨øy_Àn
 (
¨gv
) < 2)

296 
	`Ârötf
 (
°dîr
, "DOWN-ROOT:Çeed down script command\n");

297 
îr‹
;

303 
c⁄ãxt
->
comm™d
 = 
	`buûd_comm™d_löe
 (&
¨gv
[1]);

309 c⁄° *
vîb_°rög
 = 
	`gë_ív
 ("vîb", 
ívp
);

310 i‡(
vîb_°rög
)

311 
c⁄ãxt
->
vîb
 = 
	`©oi
 (
vîb_°rög
);

314  (
›ív≤_∂ugö_h™dÀ_t
Ë
c⁄ãxt
;

316 
îr‹
:

317 
	`‰ì_c⁄ãxt
 (
c⁄ãxt
);

318  
NULL
;

319 
	}
}

321 
OPENVPN_EXPORT
 

322 
	$›ív≤_∂ugö_func_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
, c⁄° 
ty≥
, c⁄° *
¨gv
[], c⁄° *
ívp
[])

324 
down_roŸ_c⁄ãxt
 *
c⁄ãxt
 = (down_roŸ_c⁄ãxà*Ë
h™dÀ
;

326 i‡(
ty≥
 =
OPENVPN_PLUGIN_UP
 && 
c⁄ãxt
->
f‹eground_fd
 == -1)

328 
pid_t
 
pid
;

329 
fd
[2];

335 i‡(
	`sockë∑ú
 (
PF_UNIX
, 
SOCK_DGRAM
, 0, 
fd
) == -1)

337 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: socketpair call failed\n");

338  
OPENVPN_PLUGIN_FUNC_ERROR
;

345 
pid
 = 
	`f‹k
 ();

347 i‡(
pid
)

349 
°©us
;

355 
c⁄ãxt
->
background_pid
 = 
pid
;

358 
	`˛o£
 (
fd
[1]);

361 i‡(
	`f˙é
 (
fd
[0], 
F_SETFD
, 
FD_CLOEXEC
) < 0)

362 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: Set FD_CLOEXEC flag on socket file descriptor failed\n");

365 
°©us
 = 
	`ªcv_c⁄åﬁ
 (
fd
[0]);

366 i‡(
°©us
 =
RESPONSE_INIT_SUCCEEDED
)

368 
c⁄ãxt
->
f‹eground_fd
 = 
fd
[0];

369  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

379 
	`˛o£_fds_ex˚±
 (
fd
[1]);

382 
	`£t_sig«ls
 ();

385 
	`d´m⁄ize
 (
ívp
);

388 
	`down_roŸ_£rvî
 (
fd
[1], 
c⁄ãxt
->
comm™d
, 
¨gv
, 
ívp
, c⁄ãxt->
vîb
);

390 
	`˛o£
 (
fd
[1]);

391 
	`exô
 (0);

395 i‡(
ty≥
 =
OPENVPN_PLUGIN_DOWN
 && 
c⁄ãxt
->
f‹eground_fd
 >= 0)

397 i‡(
	`£nd_c⁄åﬁ
 (
c⁄ãxt
->
f‹eground_fd
, 
COMMAND_RUN_SCRIPT
) == -1)

399 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: Error sending scriptÉxecution signalÅo backgroundÖrocess\n");

403 c⁄° 
°©us
 = 
	`ªcv_c⁄åﬁ
 (
c⁄ãxt
->
f‹eground_fd
);

404 i‡(
°©us
 =
RESPONSE_SCRIPT_SUCCEEDED
)

405  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

406 i‡(
°©us
 == -1)

407 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: ErrorÑeceiving scriptÉxecution confirmation from backgroundÖrocess\n");

410  
OPENVPN_PLUGIN_FUNC_ERROR
;

411 
	}
}

413 
OPENVPN_EXPORT
 

414 
	$›ív≤_∂ugö_˛o£_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
)

416 
down_roŸ_c⁄ãxt
 *
c⁄ãxt
 = (down_roŸ_c⁄ãxà*Ë
h™dÀ
;

418 i‡(
	`DEBUG
 (
c⁄ãxt
->
vîb
))

419 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: close\n");

421 i‡(
c⁄ãxt
->
f‹eground_fd
 >= 0)

424 i‡(
	`£nd_c⁄åﬁ
 (
c⁄ãxt
->
f‹eground_fd
, 
COMMAND_EXIT
) == -1)

425 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: Error signaling backgroundÖrocessÅoÉxit\n");

428 i‡(
c⁄ãxt
->
background_pid
 > 0)

429 
	`waôpid
 (
c⁄ãxt
->
background_pid
, 
NULL
, 0);

431 
	`˛o£
 (
c⁄ãxt
->
f‹eground_fd
);

432 
c⁄ãxt
->
f‹eground_fd
 = -1;

435 
	`‰ì_c⁄ãxt
 (
c⁄ãxt
);

436 
	}
}

438 
OPENVPN_EXPORT
 

439 
	$›ív≤_∂ugö_ab‹t_v1
 (
›ív≤_∂ugö_h™dÀ_t
 
h™dÀ
)

441 
down_roŸ_c⁄ãxt
 *
c⁄ãxt
 = (down_roŸ_c⁄ãxà*Ë
h™dÀ
;

443 i‡(
c⁄ãxt
 && c⁄ãxt->
f‹eground_fd
 >= 0)

446 
	`£nd_c⁄åﬁ
 (
c⁄ãxt
->
f‹eground_fd
, 
COMMAND_EXIT
);

447 
	`˛o£
 (
c⁄ãxt
->
f‹eground_fd
);

448 
c⁄ãxt
->
f‹eground_fd
 = -1;

450 
	}
}

456 
	$down_roŸ_£rvî
 (c⁄° 
fd
, *
comm™d
, c⁄° *
¨gv
[], c⁄° *
ívp
[], c⁄° 
vîb
)

458 c⁄° *
p
[3];

459 *
comm™d_löe
 = 
NULL
;

460 *
¨gv_ˇt
 = 
NULL
;

461 
i
;

466 i‡(
	`DEBUG
 (
vîb
))

467 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: BACKGROUND: INIT comm™d='%s'\n", 
comm™d
);

472 i‡(
	`£nd_c⁄åﬁ
 (
fd
, 
RESPONSE_INIT_SUCCEEDED
) == -1)

474 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: BACKGROUND: writeÉrror onÑesponse socket [1]\n");

475 
d⁄e
;

481 i‡(
	`°rög_¨øy_Àn
 (
¨gv
) >= 2)

482 
¨gv_ˇt
 = 
	`buûd_comm™d_löe
 (&
¨gv
[1]);

484 
¨gv_ˇt
 = 
	`buûd_comm™d_löe
 (
NULL
);

485 
p
[0] = 
comm™d
;

486 
p
[1] = 
¨gv_ˇt
;

487 
p
[2] = 
NULL
;

488 
comm™d_löe
 = 
	`buûd_comm™d_löe
 (
p
);

493 
i
 = 0; 
ívp
[i]; ++i)

495 
	`puãnv
 ((*)
ívp
[
i
]);

503 
comm™d_code
;

504 
°©us
;

507 
comm™d_code
 = 
	`ªcv_c⁄åﬁ
 (
fd
);

509 i‡(
	`DEBUG
 (
vîb
))

510 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: BACKGROUND:Ñe˚ived comm™d code: %d\n", 
comm™d_code
);

512 
comm™d_code
)

514 
COMMAND_RUN_SCRIPT
:

515 
°©us
 = 
	`sy°em
 (
comm™d_löe
);

516 i‡(
	`sy°em_ok
 (
°©us
))

518 i‡(
	`£nd_c⁄åﬁ
 (
fd
, 
RESPONSE_SCRIPT_SUCCEEDED
) == -1)

520 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: BACKGROUND: writeÉrror onÑesponse socket [2]\n");

521 
d⁄e
;

526 i‡(
	`£nd_c⁄åﬁ
 (
fd
, 
RESPONSE_SCRIPT_FAILED
) == -1)

528 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: BACKGROUND: writeÉrror onÑesponse socket [3]\n");

529 
d⁄e
;

534 
COMMAND_EXIT
:

535 
d⁄e
;

538 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: BACKGROUND:ÑeadÉrror on command channel\n");

539 
d⁄e
;

542 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: BACKGROUND: unknown command code: code=%d,Éxiting\n",

543 
comm™d_code
);

544 
d⁄e
;

548 
d⁄e
:

549 i‡(
¨gv_ˇt
)

550 
	`‰ì
 (
¨gv_ˇt
);

551 i‡(
comm™d_löe
)

552 
	`‰ì
 (
comm™d_löe
);

553 i‡(
	`DEBUG
 (
vîb
))

554 
	`Ârötf
 (
°dîr
, "DOWN-ROOT: BACKGROUND: EXIT\n");

557 
	}
}

	@
1
.
0
172
3913
config-msvc.h
include/openvpn-plugin.h
sample/sample-plugins/defer/simple.c
sample/sample-plugins/log/log.c
sample/sample-plugins/log/log_v3.c
sample/sample-plugins/simple/simple.c
src/compat/compat-basename.c
src/compat/compat-daemon.c
src/compat/compat-dirname.c
src/compat/compat-gettimeofday.c
src/compat/compat-inet_ntop.c
src/compat/compat-inet_pton.c
src/compat/compat-stdbool.h
src/compat/compat.h
src/openvpn/base64.c
src/openvpn/base64.h
src/openvpn/basic.h
src/openvpn/buffer.c
src/openvpn/buffer.h
src/openvpn/circ_list.h
src/openvpn/clinat.c
src/openvpn/clinat.h
src/openvpn/common.h
src/openvpn/console.c
src/openvpn/console.h
src/openvpn/crypto.c
src/openvpn/crypto.h
src/openvpn/crypto_backend.h
src/openvpn/crypto_openssl.c
src/openvpn/crypto_openssl.h
src/openvpn/crypto_polarssl.c
src/openvpn/crypto_polarssl.h
src/openvpn/cryptoapi.c
src/openvpn/cryptoapi.h
src/openvpn/dhcp.c
src/openvpn/dhcp.h
src/openvpn/errlevel.h
src/openvpn/error.c
src/openvpn/error.h
src/openvpn/event.c
src/openvpn/event.h
src/openvpn/fdmisc.c
src/openvpn/fdmisc.h
src/openvpn/forward-inline.h
src/openvpn/forward.c
src/openvpn/forward.h
src/openvpn/fragment.c
src/openvpn/fragment.h
src/openvpn/gremlin.c
src/openvpn/gremlin.h
src/openvpn/helper.c
src/openvpn/helper.h
src/openvpn/httpdigest.c
src/openvpn/httpdigest.h
src/openvpn/init.c
src/openvpn/init.h
src/openvpn/integer.h
src/openvpn/interval.c
src/openvpn/interval.h
src/openvpn/list.c
src/openvpn/list.h
src/openvpn/lladdr.c
src/openvpn/lladdr.h
src/openvpn/lzo.c
src/openvpn/lzo.h
src/openvpn/manage.c
src/openvpn/manage.h
src/openvpn/mbuf.c
src/openvpn/mbuf.h
src/openvpn/memdbg.h
src/openvpn/misc.c
src/openvpn/misc.h
src/openvpn/mroute.c
src/openvpn/mroute.h
src/openvpn/mss.c
src/openvpn/mss.h
src/openvpn/mstats.c
src/openvpn/mstats.h
src/openvpn/mtcp.c
src/openvpn/mtcp.h
src/openvpn/mtu.c
src/openvpn/mtu.h
src/openvpn/mudp.c
src/openvpn/mudp.h
src/openvpn/multi.c
src/openvpn/multi.h
src/openvpn/ntlm.c
src/openvpn/ntlm.h
src/openvpn/occ-inline.h
src/openvpn/occ.c
src/openvpn/occ.h
src/openvpn/openvpn.c
src/openvpn/openvpn.h
src/openvpn/options.c
src/openvpn/options.h
src/openvpn/otime.c
src/openvpn/otime.h
src/openvpn/packet_id.c
src/openvpn/packet_id.h
src/openvpn/perf.c
src/openvpn/perf.h
src/openvpn/pf-inline.h
src/openvpn/pf.c
src/openvpn/pf.h
src/openvpn/ping-inline.h
src/openvpn/ping.c
src/openvpn/ping.h
src/openvpn/pkcs11.c
src/openvpn/pkcs11.h
src/openvpn/pkcs11_backend.h
src/openvpn/pkcs11_openssl.c
src/openvpn/pkcs11_polarssl.c
src/openvpn/platform.c
src/openvpn/platform.h
src/openvpn/plugin.c
src/openvpn/plugin.h
src/openvpn/pool.c
src/openvpn/pool.h
src/openvpn/proto.c
src/openvpn/proto.h
src/openvpn/proxy.c
src/openvpn/proxy.h
src/openvpn/ps.c
src/openvpn/ps.h
src/openvpn/push.c
src/openvpn/push.h
src/openvpn/pushlist.h
src/openvpn/reliable.c
src/openvpn/reliable.h
src/openvpn/route.c
src/openvpn/route.h
src/openvpn/schedule.c
src/openvpn/schedule.h
src/openvpn/session_id.c
src/openvpn/session_id.h
src/openvpn/shaper.c
src/openvpn/shaper.h
src/openvpn/sig.c
src/openvpn/sig.h
src/openvpn/socket.c
src/openvpn/socket.h
src/openvpn/socks.c
src/openvpn/socks.h
src/openvpn/ssl.c
src/openvpn/ssl.h
src/openvpn/ssl_backend.h
src/openvpn/ssl_common.h
src/openvpn/ssl_openssl.c
src/openvpn/ssl_openssl.h
src/openvpn/ssl_polarssl.c
src/openvpn/ssl_polarssl.h
src/openvpn/ssl_verify.c
src/openvpn/ssl_verify.h
src/openvpn/ssl_verify_backend.h
src/openvpn/ssl_verify_openssl.c
src/openvpn/ssl_verify_openssl.h
src/openvpn/ssl_verify_polarssl.c
src/openvpn/ssl_verify_polarssl.h
src/openvpn/status.c
src/openvpn/status.h
src/openvpn/syshead.h
src/openvpn/tun.c
src/openvpn/tun.h
src/openvpn/win32.c
src/openvpn/win32.h
src/openvpnserv/openvpnserv.c
src/openvpnserv/service.c
src/openvpnserv/service.h
src/plugins/auth-pam/auth-pam.c
src/plugins/auth-pam/pamdl.c
src/plugins/auth-pam/pamdl.h
src/plugins/down-root/down-root.c
